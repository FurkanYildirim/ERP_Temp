// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/deepExtend"],function(e,s){"use strict";var n=true,r={},t={},i={},a={};r[window.location.origin]=true;var c=function(){this.setEnabled=function(e){n=e};this.processPostMessage=function(s){if(!n){return Promise.reject()}var r=s.oMessageData,t=r.body,i=s.oMessage,a=i.origin,c=i.source;t.requestId=r.request_id;if(!c){var l="Missing iframe object in PostMessage request";e.error(l,null,"sap.ushell.services.MessageBroker");return Promise.reject(l)}return this._handlePostMessageRequest(t,c,a)};this.connect=function(s){var r;if(!n){return Promise.reject()}if(typeof s!=="string"||!s.length){r="Missing required parameter client id"}else if(i[s]){r="Client is already connected"}else{i[s]=true;return Promise.resolve()}e.error(r,null,"sap.ushell.services.MessageBroker");return Promise.reject(r)};this.disconnect=function(s){var r;if(!n){return Promise.reject()}if(typeof s!=="string"||!s.length){r="Missing required parameter client id"}else if(!i[s]){r="Client is already disconnected"}else{for(var c in t){var l=t[c];for(var o in l){var u=l[o];if(u.clientId===s){l.splice(o,1);break}}}if(a[s]&&a[s].channels.length){this._emitEvent("clientUnsubscribed",s,a[s].channels);delete a[s]}delete i[s];return Promise.resolve()}e.error(r,null,"sap.ushell.services.MessageBroker");return Promise.reject(r)};this.subscribe=function(s,r,c,l,o,u){var d,f="clientSubscribed",h=[],g=false;if(!n){return Promise.reject()}if(typeof s!=="string"||!s.length||!r.length||typeof o!=="object"&&(typeof c!=="function"||typeof l!=="function")){d="Missing required parameter(s)"}else if(!i[s]){d="Client is not connected"}else{for(var v in r){var p=r[v];var b={clientId:s,subscribedChannels:r,messageCallback:c,clientConnectionCallback:l,iframe:o||{},origin:u||"",isUI5:!o};if(!t[p.channelId]){t[p.channelId]=[]}var m=t[p.channelId].find(function(e){return e.clientId===s});if(!m){t[p.channelId].push(b)}if(a[s]){var I=a[s].channels.find(function(e){return e.channelId===p.channelId});if(!I){a[s].channels.push(p)}}}if(!a[s]){g=true;var M={clientId:s,channels:r};a[s]=M;h=Object.values(a).filter(function(e){return e.clientId!==s})}if(Object.keys(a).length>1){this._emitEvent(f,s,r)}if(g){setTimeout(function(){if(h.length){h.forEach(function(e){if(!o){l(f,e.clientId,e.channels)}else{var s={clientId:e.clientId,channels:e.channels,channelId:"sap.ushell.MessageBroker",messageName:f};var n=this._buildPostMessageObject("event",s);this._sendPostMessageToClient(n,o,u,false)}}.bind(this))}}.bind(this),1e3)}return Promise.resolve()}e.error(d,null,"sap.ushell.services.MessageBroker");return Promise.reject(d)};this.unsubscribe=function(s,r){var c;if(!n){return Promise.reject()}if(typeof s!=="string"||!s.length||!Array.isArray(r)||!r.length){c="Missing required parameter(s)";e.error(c,null,"sap.ushell.services.MessageBroker");return Promise.reject(c)}if(!i[s]){c="Client is not connected";e.error(c,null,"sap.ushell.services.MessageBroker");return Promise.reject(c)}for(var l in r){var o=r[l];if(t[o.channelId]){var u=t[o.channelId];for(var d in u){var f=u[d];if(f.clientId===s){var h=a[s].channels;a[s].channels=h.filter(function(e){return e.channelId!==o.channelId});u.splice(d,1);break}}}else{var g="Unknown channel Id: "+o.channelId;e.warning(g,null,"sap.ushell.services.MessageBroker")}}this._emitEvent("clientUnsubscribed",s,r);return Promise.resolve()};this.publish=function(s,r,a,c,l,o){var u,d=[];if(!n){return Promise.reject()}if(!i[r]){u="Client is not connected";e.error(u,null,"sap.ushell.services.MessageBroker");return Promise.reject(u)}if(!t[s]){u="Unknown channel Id: "+s;e.error(u,null,"sap.ushell.services.MessageBroker");return Promise.reject(u)}var f=t[s].find(function(e){return e.clientId===r});if(!f){u="Client is not subscribed to the provided channel";e.error(u,null,"sap.ushell.services.MessageBroker");return Promise.reject(u)}for(var h in l){var g=l[h];if(g==="*"){d=t[s].concat();break}else{var v=t[s].find(function(e){return e.clientId===g});if(v){d.push(this._deepCopy(v))}}}if(d.length){this._sendMessage(d,s,a,c,r,o);return Promise.resolve()}u="Target client(s) not found in the provided channel";e.error(u,null,"sap.ushell.services.MessageBroker");return Promise.reject(u)};this.addAcceptedOrigin=function(s){if(!n){return}if(typeof s==="string"&&s.length>0){r[s]=true}else{e.warning("Missing required parameter sOrigin",null,"sap.ushell.services.MessageBroker")}};this.removeAcceptedOrigin=function(e){if(!n){return}delete r[e]};this.getAcceptedOrigins=function(){if(!n){return}return Object.keys(r)};this.getSubscribedClients=function(){if(!n){return}return this._deepCopy(t)};this._emitEvent=function(e,s,n){var r={};for(var i in t){var a=t[i];for(var c in a){var l=a[c];if(l.clientId!==s&&!r[l.clientId]){var o={clientId:s,channels:n};if(l.isUI5!==false){l.clientConnectionCallback(e,s,n)}else{o.channelId="sap.ushell.MessageBroker";o.messageName=e;var u=this._buildPostMessageObject("event",o);this._sendPostMessageToClient(u,l.iframe,l.origin,false)}r[l.clientId]=true}}}};this._sendMessage=function(e,s,n,r,t,i){for(var a in e){var c=e[a];if(c.clientId!==t){if(c.isUI5!==false){c.messageCallback(t,s,r,i)}else{var l={clientId:t,channelId:s,messageName:r,data:i};var o=this._buildPostMessageObject("request",l);this._sendPostMessageToClient(o,c.iframe,c.origin,false)}}}};this._callApi=function(e,s){return this[e].apply(this,s)};this._handlePostMessageRequest=function(e,s,n){return new Promise(function(r,t){var i,a=false,c=e.clientId,l=e.channelId,o=e.requestId,u=e.messageName,d=e.subscribedChannels,f=e.targetClientIds,h=e.data;var g={connect:[c],disconnect:[c],subscribe:[c,d,null,null,s,n],unsubscribe:[c,d],publish:[l,c,o,u,f,h]};var v={channelId:l,clientId:c,messageName:u,requestId:o};switch(u){case"connect":case"disconnect":case"subscribe":case"unsubscribe":i=u;a=true;break;default:i="publish";break}var p=this._buildPostMessageObject("response",v);this._callApi(i,g[i]).then(function(e){return r({_noresponse_:true})}).catch(function(e){a=false;return t(e)}).finally(function(){if(a){p.body.status="accepted";this._sendPostMessageToClient(p,s,n,false)}}.bind(this))}.bind(this))};this._sendPostMessageToClient=function(e,s,n,r){return new Promise(function(t,i){sap.ui.require(["sap/ushell/components/applicationIntegration/application/Application"],function(a){a.postMessageToIframeObject(e,s,n,r).then(t,i)})})};this._buildPostMessageObject=function(e,s){function n(e,s){var n=Date.now().toString();return{type:"request",request_id:n,service:e,body:s}}function r(e,s,n,r){return{type:"response",request_id:s,service:e,status:r?"success":"error",body:n}}var t="sap.ushell.services.MessageBroker",i={request:{channelId:s.channelId,clientId:s.clientId,messageName:s.messageName},response:{channelId:s.channelId,clientId:s.clientId,correlationMessageId:s.requestId,messageName:s.messageName},event:{channelId:s.channelId,clientId:s.clientId,messageName:s.messageName}};switch(e){case"event":i.event.channels=s.channels;break;case"request":if(s.data){i[e].data=s.data}break}var a={request:[t,i.request],response:[t,s.requestId,i.response,true],event:[t,i.event]};var c=e==="response"?r:n;return c.apply(this,a[e])};this._buildFunctionName=function(e,s){s=s.charAt(0).toUpperCase()+s.substring(1);return e+s};this._deepCopy=function(e){return s(e)}};return new c},false);
//# sourceMappingURL=MessageBrokerEngine.js.map