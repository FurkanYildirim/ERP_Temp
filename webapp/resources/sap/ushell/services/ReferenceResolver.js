// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/deepExtend","sap/base/util/isEmptyObject","sap/ui/core/CalendarType","sap/ui/core/Configuration","sap/ui/core/format/DateFormat","sap/ui/model/odata/ODataUtils","sap/ui/model/odata/v4/ODataUtils","sap/ui/thirdparty/jquery","sap/ushell/User"],function(e,t,r,a,n,s,i,l,jQuery,u){"use strict";var o="sap.ushell.services.ReferenceResolver";function f(){this.getValue=function(e){var t=new jQuery.Deferred;var r;if(e==="User.env.sap-ui-legacy-date-format"){r=n.getFormatSettings().getLegacyDateFormat()}if(e==="User.env.sap-ui-legacy-number-format"){r=n.getFormatSettings().getLegacyNumberFormat()}if(e==="User.env.sap-ui-legacy-time-format"){r=n.getFormatSettings().getLegacyTimeFormat()}if(e==="User.env.sap-language"){r=sap.ushell.Container.getUser().getLanguage()}if(e==="User.env.sap-languagebcp47"){r=sap.ushell.Container.getUser().getLanguageBcp47()}if(e==="User.env.sap-accessibility"){r=sap.ushell.Container.getUser().getAccessibilityMode()?"X":undefined}if(e==="User.env.sap-statistics"){r=n.getStatistics()?"true":undefined}if(e==="User.env.sap-theme"){r=sap.ushell.Container.getUser().getTheme(u.prototype.constants.themeFormat.THEME_NAME_PLUS_URL)}if(e==="User.env.sap-theme-name"){r=sap.ushell.Container.getUser().getTheme()}if(e==="User.env.sap-theme-NWBC"){r=sap.ushell.Container.getUser().getTheme(u.prototype.constants.themeFormat.NWBC)}t.resolve({value:r});return t.promise()}}function c(n,u,c){this._getUserEnvReferenceResolver=function(){if(!this.oUserEnvReferenceResolver){this.oUserEnvReferenceResolver=new f}return this.oUserEnvReferenceResolver};this.resolveReferences=function(t,a){var n=this;var s=new jQuery.Deferred;var i=[];var l=true;var u={};var f={};var c=sap.ushell.Container.getServiceAsync("UserDefaultParameters");var d,v;if(!a){v=sap.ushell.Container.getServiceAsync("ClientSideTargetResolution").then(function(e){return e.getSystemContext()})}else{v=Promise.resolve(a)}var m=t.map(function(t){var r;if(t.indexOf("User.env.")===0){r=t;f[r]=1}if(t.indexOf("UserDefault.")===0){r=n._extractAnyUserDefaultReferenceName(t);u[r]=1}if(typeof r!=="string"){l=false;e.error("'"+t+"' is not a legal reference name",null,o)}return{full:t,name:r}});if(!l){return s.reject("One or more references could not be resolved").promise()}Promise.all([v,c]).then(function(e){var t=e[0];var a=e[1];Object.keys(u).forEach(function(e){i.push(a.getValue(e,t))});Object.keys(f).forEach(function(e){d=d||n._getUserEnvReferenceResolver();i.push(d.getValue(e))});jQuery.when.apply(jQuery,i).done(function(){var e={};var t=0,a=arguments;Object.keys(u).forEach(function(e){u[e]=a[t];t=t+1});Object.keys(f).forEach(function(e){f[e]=a[t];t=t+1});m.forEach(function(t){var a;if(t.full.indexOf("UserDefault.extended.")===0){a=n.mergeSimpleAndExtended(u[t.name]);if(!r(a)){e[t.full]=a}else{e[t.full]=undefined}}else if(t.full.indexOf("UserDefault.")===0){e[t.full]=u[t.name].value}else if(t.full.indexOf("User.env.")===0){e[t.full]=f[t.name].value}});s.resolve(e)})});return s.promise()};this._extractAnyUserDefaultReferenceName=function(e){var t=this.extractExtendedUserDefaultReferenceName(e);if(typeof t==="string"){return t}return this.extractUserDefaultReferenceName(e)};this.extractExtendedUserDefaultReferenceName=function(e){if(typeof e!=="string"||e.indexOf("UserDefault.extended.")!==0){return undefined}return e.replace(/^UserDefault[.]extended[.]/,"")};this.extractUserDefaultReferenceName=function(e){if(typeof e!=="string"||e.indexOf("UserDefault.")!==0||e.indexOf("UserDefault.extended.")===0){return undefined}return e.replace(/^UserDefault[.]/,"")};this.mergeSimpleAndExtended=function(e){var r=t({},e.extendedValue);if(typeof e.value==="string"){if(!Array.isArray(r.Ranges)){r.Ranges=[]}r.Ranges.push({Sign:"I",Option:"EQ",Low:e.value,High:null})}return r};function d(e){var t=/{([^}%]*%%[^%]+%%)}?/g,r=/([^%]*)%%/,a=/%%([^%]+)%%/,n,s,i,l=[];n=t.exec(e);while(n){s=r.exec(n[1]);i=a.exec(n[1]);l.push({edmType:s[1],name:i[1]});n=t.exec(e)}return l}this._extractUrlPlaceholders=function(e,t){var r;var a;var n=[];r=/[^(?]*/.exec(e);a=r===null?[]:d(r[0]);a.forEach(function(e){n.push(e.name)});r=/[(?][^]*/.exec(e);a=r===null?[]:d(r[0]);var s=a.filter(function(e){var r=e.name;if(t.test(r)){return true}n.push(r);return false});return{extractedReferences:s,ignoredReferences:n}};this._replaceUrlPlaceholders=function(e,t,r){var a=e;var n=[];var s=r?l.formatLiteral.bind(l):i.formatValue.bind(i);t.forEach(function(e){var t=e.name;var r=null;var i=false;while(r!==a){r=a;if(e.value!==undefined){var l=s(e.value,e.edmType);a=a.replace("{"+e.edmType+"%%"+t+"%%}",window.encodeURIComponent(l))}else{i=true;a=a.replace("{"+e.edmType+"%%"+t+"%%}","")}}if(i){n.push(t)}});return{resolvedUrl:a,placeholdersWithoutValue:n}};this.resolveUserDefaultParameters=function(e,t){var r=new jQuery.Deferred;var a=this._extractUrlPlaceholders(e,/^UserDefault\.(?!extended\.).+/);var n=a.extractedReferences;var s=a.ignoredReferences;if(n.length===0){r.resolve({url:e,defaultsWithoutValue:[],ignoredReferences:s});return r.promise()}var i=n.map(function(e){return e.name});this.resolveReferences(i,t).done(function(t){n.forEach(function(e){e.value=t[e.name]});var a=this._replaceUrlPlaceholders(e,n);r.resolve({url:a.resolvedUrl,defaultsWithoutValue:a.placeholdersWithoutValue,ignoredReferences:s})}.bind(this));return r.promise()};this._loadDynamicDateRange=function(){return sap.ui.getCore().loadLibrary("sap.ui.unified",{async:true}).then(function(){return new Promise(function(e){sap.ui.require(["sap/m/DynamicDateRange"],function(t){e(t)})})})};this._rSemanticDateRangeRegex=/^DynamicDate\..+/;this.resolveSemanticDateRanges=function(t,r){var a=this._extractUrlPlaceholders(t,this._rSemanticDateRangeRegex);var n=a.extractedReferences;var s=a.ignoredReferences;if(n.length===0){return Promise.resolve({url:t,hasSemanticDateRanges:false,invalidSemanticDates:[],ignoredReferences:s})}var i=["2.0","4.0"];if(!r||!i.includes(r)){return Promise.reject("Invalid OData version: "+r)}var l=r==="4.0";return this._resolveSemanticDateRanges(n,l).then(function(a){var i=this._replaceUrlPlaceholders(t,a,l);if(e.getLevel()>=e.Level.DEBUG){var u=a.filter(function(e){return"value"in e});e.debug("Resolving semantic date ranges \n"+"- OData Version: "+r+"\n"+"- URL: "+t+"\n"+"- ignoring references: "+JSON.stringify(s,null,4)+"\n"+"- resolved semantic date ranges: "+JSON.stringify(u,null,4)+"\n"+"- invalid semantic date ranges:"+JSON.stringify(i.placeholdersWithoutValue,null,4)+"\n"+"- final URL: "+i.resolvedUrl,null,o)}return{url:i.resolvedUrl,hasSemanticDateRanges:n.length>0,invalidSemanticDates:i.placeholdersWithoutValue,ignoredReferences:s}}.bind(this))};this._resolveSemanticDateRanges=function(e,t){var r=this._getDateTimeFormatters();return this._loadDynamicDateRange().then(function(a){return e.map(function e(n){var s={name:n.name,edmType:n.edmType};var i=n.name.split(".");var l={operator:i[1],values:[]};var u;if(i.length===3){u=i[2]}else if(i.length===4){l.values.push(i[2]);u=i[3]}else if(i.length===5){l.values=i.slice(2,4);u=i[4]}var o;try{o=a.toDates(l)}catch(e){return s}if(i.length>=3&&u!=="start"&&u!=="end"){return s}var f;if(u==="end"){f=o[1]}else{f=o[0]}if(!f){return s}switch(n.edmType){case"Edm.String":s.value=r.string.format(f);break;case"Edm.Date":s.value=r.date.format(f);break;case"Edm.DateTime":f.setUTCFullYear(f.getFullYear(),f.getMonth(),f.getDate());f.setUTCHours(0,0,0,0);s.value=f;break;case"Edm.DateTimeOffset":if(t){s.value=r.dateTimeOffsetV4.format(f,true)}else{s.value=f}break;default:break}return s})})};this._getDateTimeFormatters=function(){if(!this._oDateTimeFormatters){this._oDateTimeFormatters={string:s.getDateInstance({pattern:"yyyyMMdd",calendarType:a.Gregorian}),date:s.getDateInstance({pattern:"yyyy-MM-dd",calendarType:a.Gregorian}),dateTimeOffsetV4:s.getDateInstance({pattern:"yyyy-MM-dd'T'HH:mm:ss'Z'",calendarType:a.Gregorian})}}return this._oDateTimeFormatters};this.hasSemanticDateRanges=function(e){var t=this._extractUrlPlaceholders(e,this._rSemanticDateRangeRegex);return t.extractedReferences.length>0}}c.hasNoAdapter=true;return c},true);
//# sourceMappingURL=ReferenceResolver.js.map