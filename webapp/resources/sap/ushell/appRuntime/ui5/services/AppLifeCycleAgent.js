// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/appRuntime/ui5/AppRuntimePostMessageAPI","sap/ushell/appRuntime/ui5/AppRuntimeService","sap/base/util/extend","sap/base/util/UriParameters","sap/ui/thirdparty/URI","sap/ui/Device","sap/ui/core/BusyIndicator","sap/ushell/appRuntime/ui5/performance/FesrEnhancer","sap/ushell/EventHub","sap/base/Log","sap/ui/thirdparty/hasher","sap/ui/core/Core","sap/ushell/utils/UrlParsing","sap/ushell/appRuntime/ui5/AppRuntimeContext","sap/base/assert","sap/ushell/resources"],function(e,t,s,n,a,r,i,p,o,u,l,f,c,h,d,g){"use strict";function m(){var m=this,A,v,C=true,y={},I,S={},b={},P={},R={},w,N,O,F,H;this.init=function(s,n,a,r,i,p){this.resetCurrentApp();A=s;I=n;N=a;if(r!==undefined){C=r}this.addAppInfoToCache(i,p);e.registerCommHandlers({"sap.ushell.services.appLifeCycle":{oServiceCalls:{create:{executeServiceCallFn:function(e){var t=JSON.parse(e.oMessage.data);return m.create(t)}},destroy:{executeServiceCallFn:function(e){var t=JSON.parse(e.oMessage.data);return m.destroy(t)}},store:{executeServiceCallFn:function(e){var t=JSON.parse(e.oMessage.data);return m.store(t)}},restore:{executeServiceCallFn:function(e){var t=JSON.parse(e.oMessage.data);return m.restore(t)}}}}});o.on("disableKeepAliveRestoreRouterRetrigger").do(function(e){if(e.componentId&&b[e.componentId]){b[e.componentId]=e.disable}});t.sendMessageToOuterShell("sap.ushell.services.appLifeCycle.setup",{isStateful:true,isKeepAlive:true,isIframeValid:true,isIframeBusy:true});if(!g.browserI18n){g.browserI18n=g.getTranslationModel(window.navigator.language).getResourceBundle()}F=g.browserI18n.getText("dataLossExternalMessage");window.onbeforeunload=function(){if(sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getDirtyFlag()){return F}return undefined}};this.create=function(e){return new Promise(function(s,o){var u,g,A,v,C="",y;t.sendMessageToOuterShell("sap.ushell.appRuntime.iframeIsBusy",{bValue:true});p.startInteraction();u=e.body.sUrl;if(h.getIsScube()){A=n.fromURL(u).get("sap-remote-intent");d(typeof A==="string","AppLifeCycleAgent::create - sAppIntent must be string");if(e.body.sHash.indexOf("Shell-startIntent")===0){v=c.parseShellHash(e.body.sHash);C=v.params["sap-shell-so"]+"-"+v.params["sap-shell-action"]}}else{g=n.fromURL(u).get("sap-ui-app-id");d(typeof g==="string","AppLifeCycleAgent::create - sAppId must be string")}l.disableCFLPUpdate=true;l.replaceHash(e.body.sHash);l.disableCFLPUpdate=false;if(r.browser.chrome){i.show(0)}if(O){O._resetBackNavigationCallback()}f.getEventBus().publish("launchpad","appOpening",{});m.getAppInfo(g,u,A).then(function(e){if(h.getIsScube()&&C.length>0){y=Object.keys(S).find(function(t){return S[t].sAppIntent===C&&S[t].ui5ComponentName===e.oResolvedHashFragment.ui5ComponentName});if(y){m.destroy({body:{sCacheId:y}})}}m.expandSapIntentParams(new a(u).query(true)).then(function(n){I(g,n,e.oResolvedHashFragment,A,e.oParsedHash).then(function(e){N(e);t.sendMessageToOuterShell("sap.ushell.appRuntime.iframeIsBusy",{bValue:false});f.getEventBus().publish("sap.ushell","appOpened",{});s({deletedKeepAliveId:y})})})})})};this.destroy=function(e){function s(e){var t=e.sId||"<unkown>";try{e.destroy()}catch(e){u.error("exception when trying to close sapui5 application with id '"+t+"' when running inside the appruntim iframe '"+document.URL+"'. This error must be fixed in order for the iframe to operate properly.\n",e.stack,"sap.ushell.appRuntime.ui5.services.AppLifeCycleAgent::destroy")}}if(w.oApp===undefined){t.sendMessageToOuterShell("sap.ushell.appRuntime.isInvalidIframe",{bValue:true});return Promise.resolve()}var n=e.body.sCacheId;if(n&&S[n]){if(S[n].oApp===w.oApp){this.resetCurrentApp()}delete b[S[n].oApp.sId];s(S[n].oApp);delete S[n]}else if(w.oApp){delete b[w.oApp.sId];s(w.oApp);this.resetCurrentApp()}sap.ushell.Container.cleanDirtyStateProviderArray();if(O){O._resetBackNavigationCallback()}p.setAppShortId();f.getEventBus().publish("sap.ushell","appClosed",{});return Promise.resolve()};this.store=function(e){var s=e.body.sCacheId,n=this.cloneCurrentAppEntry(w),a;if(w.oApp===undefined){t.sendMessageToOuterShell("sap.ushell.appRuntime.isInvalidIframe",{bValue:true});return Promise.resolve()}S[s]=n;if(O){R[s]=O._getBackNavigationCallback()}a=n.oApp.getComponentInstance();n.oApp.setVisible(false);if(sap.ushell.Container){P[s]=sap.ushell.Container.getAsyncDirtyStateProviders();sap.ushell.Container.cleanDirtyStateProviderArray()}if(a){if(a.isKeepAliveSupported&&a.isKeepAliveSupported()===true){a.deactivate()}else{if(a.suspend){a.suspend()}if(a.getRouter&&a.getRouter()){a.getRouter().stop()}}}f.getEventBus().publish("sap.ushell","appClosed",{});return Promise.resolve()};this.restore=function(e){var s=e.body.sCacheId,n=S[s],a=n.oApp.getComponentInstance(),r=b[n.oApp.sId];l.disableCFLPUpdate=true;l.replaceHash(e.body.sHash);l.disableCFLPUpdate=false;f.getEventBus().publish("launchpad","appOpening",{});n.oApp.setVisible(true);if(P[s]&&sap.ushell.Container){sap.ushell.Container.setAsyncDirtyStateProviders(P[s])}if(O){O.setBackNavigation(R[s])}if(a){if(a.isKeepAliveSupported&&a.isKeepAliveSupported()===true){a.activate()}else{if(a.restore){a.restore()}if(a.getRouter&&a.getRouter()&&a.getRouter().initialize){if(r===false){a.getRouter().initialize()}else{a.getRouter().initialize(true)}}}w=this.cloneCurrentAppEntry(n)}f.getEventBus().publish("sap.ushell","appOpened",{});setTimeout(function(){t.sendMessageToOuterShell("sap.ushell.services.AppLifeCycle.setNewAppInfo",{info:n.oAppAttributes})},500);return Promise.resolve()};this.expandSapIntentParams=function(e){return new Promise(function(n,r){if(e.hasOwnProperty("sap-intent-param")){var i=e["sap-intent-param"];t.sendMessageToOuterShell("sap.ushell.services.CrossApplicationNavigation.getAppStateData",{sAppStateKey:i}).then(function(t){delete e["sap-intent-param"];var r=s({},e,new a("?"+t).query(true),true);n(r)},function(t){n(e)})}else{n(e)}})};this.addAppParamsToIntent=function(e,t){return m.expandSapIntentParams(new a(e).query(true)).then(function(e){return m.getApplicationParameters(e)})};this.getApplicationParameters=function(e){return new Promise(function(s){var n,r,i;function p(e,t){var s="";if(e&&e.length>0){s=(e.startsWith("?")?"":"?")+e}if(t&&t.length>0){s+=(s.length>0?"&":"?")+t}return s}if(e.hasOwnProperty("sap-startup-params")){n=new a("?"+e["sap-startup-params"]).query(true);if(n.hasOwnProperty("sap-intent-param")){r=n["sap-intent-param"];delete n["sap-intent-param"]}i=new a("?").query(n).toString();if(r){t.sendMessageToOuterShell("sap.ushell.services.CrossApplicationNavigation.getAppStateData",{sAppStateKey:r}).then(function(e){s(p(i,e))},function(e){s(p(i))})}else{s(p(i))}}else{s("")}})};this.getAppInfo=function(e,t,s){return new Promise(function(n){if(s){m.addAppParamsToIntent(t,s).then(function(e){if(e.length>0){e=new a(e).removeSearch("sap-remote-system").removeSearch("sap-ushell-defaultedParameterNames").toString()}sap.ushell.Container.getServiceAsync("NavTargetResolution").then(function(t){t.resolveHashFragmentLocal("#"+s+e).done(function(t){var a=c.parseShellHash("#"+s+e);n({oResolvedHashFragment:t,oParsedHash:a})}).fail(function(e){})})})}else{var r=function(){v.getAppInfo(e,t).then(function(t){m.addAppInfoToCache(e,t);n({oResolvedHashFragment:t})})};if(C===true&&y[e]){n({oResolvedHashFragment:JSON.parse(JSON.stringify(y[e]))})}else if(v){r()}else{sap.ui.require([A.replace(/\./g,"/")],function(e){v=e;r()})}}})};this.addAppInfoToCache=function(e,t){if(e&&t&&C===true&&y[e]===undefined){y[e]=JSON.parse(JSON.stringify(t))}};this.setCurrentApp=function(e,t,s){this.resetCurrentApp();w.oApp=e;w.sAppIntent=t;w.ui5ComponentName=s;if(w.oApp){b[w.oApp.sId]=true}};this.setCurrentAppAttributes=function(e){w.oAppAttributes=e};this.resetCurrentApp=function(){w={oApp:undefined,sAppIntent:undefined,ui5ComponentName:undefined,oAppAttributes:{}}};this.cloneCurrentAppEntry=function(e){return{oApp:e.oApp,sAppIntent:e.sAppIntent,ui5ComponentName:e.ui5ComponentName,oAppAttributes:e.oAppAttributes}};this.setShellUIService=function(e){O=e};this.setShellNavigationService=function(e){H=e};this.checkDataLossAndContinue=function(){if(sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getDirtyFlag(H.getNavigationContext())){if(window.confirm(F)){sap.ushell.Container.setDirtyFlag(false);return true}else{return false}}return true}}return new m},true);
//# sourceMappingURL=AppLifeCycleAgent.js.map