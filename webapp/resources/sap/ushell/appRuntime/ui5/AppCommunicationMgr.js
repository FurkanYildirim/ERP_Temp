// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/appRuntime/ui5/AppRuntimePostMessage","sap/ui/thirdparty/jquery","sap/base/util/ObjectPath","sap/base/Log"],function(e,jQuery,s,t){"use strict";var n="sap.ushell.appRuntime.ui5.AppCommunicationMgr";var i,r=[],a=0;function o(){this.init=function(s){var t=this;i=e.getHandlers();t.handleMessageEvent=o.prototype._handleMessageEvent.bind(t,t);addEventListener("message",t.handleMessageEvent);if(s===true){t.sendMessageToOuterShell("sap.ushell.appRuntime.iframeIsValid");setInterval(function(){t.sendMessageToOuterShell("sap.ushell.appRuntime.iframeIsValid")},2500)}};this.destroy=function(){removeEventListener("message",this.handleMessageEvent)};this._handleMessageResponse=function(e){if(e.request_id&&r[e.request_id]){var s=r[e.request_id];delete r[e.request_id];if(e.status==="success"){s.resolve(e.body.result)}else{s.reject()}}};this._handleMessageRequest=function(e,r,a){var o=this,u=s.create("sap-ushell-config.services.PostMessage.config"),g=a&&a.service,d,c,l,p,f;t.debug("App Runtime received post message request from origin '"+r.origin+"': "+JSON.stringify(a),null,n);if(!g){return}if(u&&u.enabled===false){t.warning("App Runtime received message for "+c+", but this "+"feature is disabled. It can be enabled via launchpad configuration "+"property 'services.PostMessage.config.enabled: true'",undefined,n);return}if(!this._isTrustedPostMessageSource(e,r)){t.warning("App Runtime received message from untrusted origin '"+r.origin+"': "+JSON.stringify(r.data),null,n);return}if(g==="sap.ushell.services.MessageBroker"){g=g.concat("._execute")}if(g.indexOf(".")>0){d=g.split(".");l=d[d.length-1];c=g.substr(0,g.length-l.length-1)}else{t.warning("App Runtime received message with invalid service name ("+g+") :"+JSON.stringify(r.data),null,n);return}var h={oMessage:r,oMessageData:a,oContainer:e};try{p=i[c];f=p&&p.oServiceCalls[l];if(f&&f.executeServiceCallFn){f.executeServiceCallFn(h).then(function(e){var s=e&&e.hasOwnProperty("_noresponse_")?true:false;if(!s){o.sendResponseMessage(r,a,"success",{result:e})}},function(e){o.sendResponseMessage(r,a,"error",{message:e})})}else{t.warning("App Runtime received message with unknown service name ("+a.service+") :"+JSON.stringify(r.data),null,n)}}catch(e){t.warning("Error in processing message: "+e.message+") :"+JSON.stringify(r.data),null,n)}};this._getCFLPWindow=function(){return window.parent};this._isTrustedPostMessageSource=function(e,s){var t=false,n=e._getCFLPWindow();if(n){t=s.source===n}return t};this.sendResponseMessage=function(e,s,i,r){var a=JSON.stringify({type:"response",service:s.service,request_id:s.request_id,status:i,body:r});t.debug("Sending post message response to origin ' "+e.origin+"': "+a,null,n);if(typeof e.source!=="object"||e.source===null){t.debug("Cannot send response message to origin ' "+e.origin,"`source` member of request message is not an object",n);return}e.source.postMessage(a,e.origin)};this._getTargetWindow=function(){return window.parent};this.postMessage=function(e){var s,n=this._getTargetWindow();if(e){try{if(e.type==="request"&&!e.request_id){e.request_id=this.getId()}s=JSON.stringify(e);n.postMessage(s,"*")}catch(s){t.error("Message '"+e+"' cannot be posted: "+s,"sap.ui5Isolation.AppCommunicationMgr")}}};this.sendMessageToOuterShell=function(e,s,t,n,i){var a=new jQuery.Deferred,o={type:"request",service:e,body:s||{},request_id:t};this.postMessage(o);r[o.request_id]=a;if(n){setTimeout(function(){a.resolve(i)},n)}return a.promise()};this.getId=function(){return"SAPUI5_APPRUNTIME_MSGID_"+ ++a}}o.prototype._handleMessageEvent=function(e,s){if(s===undefined){return}var i=s.data;if(typeof i==="string"){try{i=JSON.parse(s.data,this)}catch(e){t.debug("Message received from origin '"+s.origin+"' cannot be parsed: "+e,i,n);return}}if(i.type==="request"){return e._handleMessageRequest(e,s,i)}else if(i.type==="response"){return e._handleMessageResponse(i)}};return new o});
//# sourceMappingURL=AppCommunicationMgr.js.map