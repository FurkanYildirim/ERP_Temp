// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/adapters/cdm/v3/_LaunchPage/readHome","sap/ushell/adapters/cdm/v3/_LaunchPage/readVisualizations","sap/ushell/adapters/cdm/v3/_LaunchPage/readUtils","sap/m/GenericTile","sap/ui/core/ComponentContainer","sap/ushell/adapters/cdm/_LaunchPage/uri.transform","sap/ushell/Config","sap/ushell/EventHub","sap/ushell/navigationMode","sap/ushell/resources","sap/ushell/utils","sap/ushell/adapters/cdm/v3/utilsCdm","sap/base/util/Version","sap/ui/thirdparty/jquery","sap/base/util/isPlainObject","sap/base/util/isEmptyObject","sap/base/util/ObjectPath","sap/base/util/deepExtend","sap/base/util/deepClone","sap/base/Log","sap/ushell/UI5ComponentType"],function(e,t,i,r,o,n,a,s,l,u,p,d,c,jQuery,f,v,g,h,m,T,y){"use strict";var R=T.getLogger("sap/ushell/adapters/cdm/LaunchPageAdapter");var _=T.Level;var C="sap.ushell.components.tiles.cdm.applauncher";var b="sap.ushell.components.tiles.cdm.applauncherdynamic";function I(e,t,i){this.oAdapterConfiguration=i;this._mResolvedTiles={};this._mCatalogTilePromises={};this._mFailedResolvedCatalogTiles={};this._mFailedResolvedTiles={};this.TileType={Tile:"tile",Link:"link",Card:"card"}}I.prototype.getGroups=function(){var e=new jQuery.Deferred;this._ensureLoaded().then(function(t){p.setPerformanceMark("FLP - homepage groups processed");e.resolve(t)}).catch(function(){e.resolve([])});return e.promise()};I.prototype._ensureLoaded=function(){var t=this;if(this._loaded){return this._loaded}var i=new jQuery.Deferred;this._ensureLoadedDeferred=i;this._loaded=new Promise(function(i,r){this._getSiteData().then(function(r){if(!t.isSiteSupported(r)){throw new Error("Invalid CDM site version: Check the configuration of the launchpage adapter and the version of the FLP site")}var o=[];var n=e.getGroupsArrayFromSite(r);n=t._addDefaultGroup(n,r);n.forEach(function(e){o=t._ensureGroupItemsResolved(e,r).concat(o)});t._allPromisesDone(o).done(function(){i(n);delete t._loaded;t._logTileResolutionFailures(t._mFailedResolvedTiles)})}).catch(function(e){R.error("Delivering homepage groups failed - "+e);i([]);delete t._loaded})}.bind(this));return this._loaded};I.prototype._ensureGroupItemsResolved=function(e,t){var i=[];var r;var o;if(e.payload&&e.payload.tiles){r=this._ensureGroupTilesResolved(e.payload.tiles,t);Array.prototype.push.apply(i,r)}if(e.payload&&e.payload.links){o=this._ensureGroupLinksResolved(e.payload.links,t);Array.prototype.push.apply(i,o)}return i};I.prototype._ensureGroupTilesResolved=function(e,t){return(e||[]).map(function(e,i){return this._resolveGroupTile(e,t).then(function(e){e.isLink=false;return e})},this)};I.prototype._ensureGroupLinksResolved=function(e,t){return(e||[]).map(function(e){return this._resolveGroupTile(e,t).then(function(e){e.isLink=true;return e})},this)};I.prototype._resolveGroupTile=function(e,t){var i=this._mResolvedTiles;var r=this._mFailedResolvedTiles;var o;function n(t){i[e.id]=t;if(r[e.id]){delete r[e.id]}return t}function a(e){var t=e.target;return t&&t.semanticObject==="Shell"&&t.action==="launchURL"}if(i[e.id]){return(new jQuery.Deferred).resolve(i[e.id]).promise()}if(e.target&&e.target.url){o=jQuery.when(this._getTileForUrl(e))}else if(e.isBookmark&&e.vizType===undefined){o=this._resolveTileByIntent(e,t)}else if(a(e)){o=this._resolveTileByIntent(e,t)}else{o=this._resolveTileByVizId(e,t)}var s=new jQuery.Deferred;o.done(function(e){s.resolve(n(e))}).fail(function(t){r[e.id]=t;s.reject(t)});return s.promise()};I.prototype._resolveTileByVizId=function(r,o){var n;var s;var u;var c;var v;var g;var T;var y;var R;var C;var b;var I;var S;function D(e,t){return(new jQuery.Deferred).reject({logLevel:e,message:t}).promise()}var L=new jQuery.Deferred;if(!f(o)){return D(_.ERROR,"Cannot resolve tile: oSite must be an object")}if(!f(r)){return D(_.ERROR,"Cannot resolve tile: oTile must be an object")}s=r.vizId;n=m(t.get(o,s||"")||{});c=r.vizType||t.getTypeId(n);u=t.getType(o,c);if(!u){return D(_.ERROR,"Cannot resolve tile '"+r.id+"': no visualization type found for vizTypeId '"+c+"'")}v=t.getAppId(n);if(v){g=t.getAppDescriptor(o,v);if(!g){return D(_.INFO,"Tile '"+r.id+"' filtered from result: no app descriptor found for appId '"+v+"' (dangling app reference)")}T=e.getInbound(g,t.getTarget(n).inboundId);if(!T){return D(_.ERROR,"Cannot resolve tile '"+r.id+"': app '"+v+"' has no navigation inbound")}y=d.mapOne(T.key,T.inbound,g,n,u,o);var w=y.resolutionResult.applicationType;var P=y.resolutionResult.additionalInformation;var G=a.last("/core/navigation/enableInPlaceForClassicUIs");var F=G?G[w]:false;R=l.computeNavigationModeForHomepageTiles(w,P,F);I=t.getOutbound(n,T.inbound);b=this._toHashFromOutbound(I)}else{n.vizConfig=h({},n.vizConfig,r.vizConfig);y=d.mapOne(undefined,undefined,undefined,n,u,o);if(t.startsExternalUrl(n)){S=p.getMember(n.vizConfig,"sap|flp.target.url")}}C=y.tileResolutionResult;C.navigationMode=R;C.isLink=false;if(!this._isFormFactorSupported(C)){return D(_.INFO,"Tile '"+r.id+"' filtered from result: form factor not supported")}if(S||b){L.resolve({tileResolutionResult:C,tileIntent:S||b})}else{if(r.target){var k=m(r.target);b=d.toHashFromTarget(i.harmonizeTarget(k))}L.resolve({tileResolutionResult:C,tileIntent:b})}return L.promise()};I.prototype._isFormFactorSupported=function(t){var i=p.getFormFactor();return e.supportsFormFactor(t,i)};I.prototype._getFirstInbound=function(e){var t=Object.keys(e["sap.app"].crossNavigation.inbounds).shift();var i=e["sap.app"].crossNavigation.inbounds[t];return{key:t,inbound:i}};I.prototype._resolveTileByIntent=function(e){var t=this._prepareTileHash(e);return this._getTileFromHash(t)};I.prototype._allPromisesDone=function(e){var t=new jQuery.Deferred;if(e.length===0){t.resolve([])}else{var i=e.map(function(e){var t=new jQuery.Deferred;e.always(t.resolve.bind(t));return t.promise()});jQuery.when.apply(this,i).done(function(){var e=Array.prototype.slice.call(arguments);t.resolve(e)})}return t.promise()};I.prototype._logTileResolutionFailures=function(e){var t={};if(!e){return}Object.keys(_).filter(function(e){var t=_[e];return t>=_.FATAL&&t<=_.ALL}).forEach(function(e){t[_[e]]=""});Object.keys(e).forEach(function(i){var r=e[i];if(r.logLevel){t[r.logLevel]=t[r.logLevel].concat(r.message).concat("\n")}});if(t[_.FATAL]){R.fatal(t[_.FATAL])}if(t[_.ERROR]){R.error(t[_.ERROR])}if(t[_.WARNING]){R.warning(t[_.WARNING])}if(t[_.INFO]){R.info(t[_.INFO])}if(t[_.DEBUG]){R.debug(t[_.DEBUG])}if(t[_.TRACE]){R.trace(t[_.TRACE])}};I.prototype._isValidTitle=function(e){return typeof e==="string"&&e};I.prototype._isGroupPreset=function(t){return e.isGroupPreset(t)};I.prototype._isGroupLocked=function(t){return e.isGroupLocked(t)};I.prototype.getGroupTitle=function(t){return e.getGroupTitle(t)};I.prototype.getGroupId=function(t){return e.getGroupId(t)};I.prototype.isGroupVisible=function(t){return e.isGroupVisible(t)};I.prototype.getTileTitle=function(t){return e.getTileTitle(this._mResolvedTiles,t)};I.prototype.getTileContentProviderId=function(t){return e.getContentProviderId(t)};I.prototype.getTileSubtitle=function(t){return e.getTileSubtitle(this._mResolvedTiles,t)};I.prototype.getTileIcon=function(t){return e.getTileIcon(this._mResolvedTiles,t)};I.prototype.getTileInfo=function(t){return e.getTileInfo(this._mResolvedTiles,t)};I.prototype.getTileIndicatorDataSource=function(e){var t=this._mResolvedTiles[e.id];var i={};if(e.indicatorDataSource){i.indicatorDataSource=h({},e.indicatorDataSource);if(e.dataSource){i.dataSource=h({},e.dataSource)}return i}if(!t){return i}var r=t.tileResolutionResult;if(r.indicatorDataSource){i.indicatorDataSource=h({},r.indicatorDataSource);if(r.indicatorDataSource.hasOwnProperty("dataSource")){var o=r.indicatorDataSource.dataSource;var a=r.dataSources;if(a&&a.hasOwnProperty(o)){i.dataSource=h({},a[o])}else{T.warning("datasource referenced but not found for tile: "+t.tileIntent)}}if(p.getMember(r,"runtimeInformation.componentProperties.url")){var s=p.getMember(i,"indicatorDataSource.path");var l=p.getMember(i,"dataSource.uri");var u=p.getMember(r,"runtimeInformation.componentProperties.url");var d=n(s,l,u,this.getWindowLocationHref());if(!d.error){if(s){i.indicatorDataSource.path=d.uri}if(l){i.dataSource.uri=d.uriParent}}}}return i};I.prototype.getWindowLocationHref=function(){return window.location.href};I.prototype.isGroupRemovable=function(e){return!this._isGroupPreset(e)};I.prototype.isGroupLocked=function(e){return this._isGroupLocked(e)};I.prototype.getGroupTiles=function(t){return e.getGroupTiles(t).concat(e.getGroupLinks(t))};I.prototype.getTileType=function(t){if(e.isLink(this._mResolvedTiles,t)){return this.TileType.Link}if(e.isCard(this._mResolvedTiles,t)){return this.TileType.Card}return this.TileType.Tile};I.prototype.getTileId=function(t){return e.getTileId(t)};I.prototype.getTileSize=function(t){return e.getTileSize(this._mResolvedTiles,t)||"1x1"};I.prototype.getTileTarget=function(t){var i=e.getTileId(t);var r=this._mResolvedTiles[i];if(t.target&&t.target.url){return t.target.url}if(r){return r.tileIntent}T.warning("Could not find a target for Tile with id '"+i+"'","sap.ushell.adapters.cdm.LaunchPageAdapter");return""};I.prototype.isTileIntentSupported=function(e){return this._mFailedResolvedTiles[e.id]===undefined};I.prototype.setTileVisible=function(e,t){var i=this._mResolvedTiles[e.id];if(i){if(i.tileComponent){this._notifyTileAboutVisibility(i.tileComponent,t,i.visibility)}i.visibility=t}};I.prototype.getCardManifest=function(e){var t=this._mResolvedTiles[e.id];var i=t.tileResolutionResult;return i.tileComponentLoadInfo};I.prototype._getTileUiComponentContainer=function(e,t,i){var n=this;var a;var l;var p;var d;var c;var f;var v=new jQuery.Deferred;sap.ushell.Container.getServiceAsync("Ui5ComponentLoader").then(function(r){l=r;var o=this._createTileComponentData(e,i,t);return o}.bind(this)).then(function(t){return this._enhanceTileComponentData(e,t)}.bind(this)).then(function(g){a=t.tileResolutionResult;if(t.isLink){p=a.navigationMode;v.resolve(n._createLinkInstance(e,i,p,r,u));return}var h=this._createTileComponentProperties(g,a.tileComponentLoadInfo);if(!h.name){return Promise.reject("Cannot find name of tile component for tile with id: '"+e.id+"'")}if(h.manifest){g.properties=g.properties||{};g.properties.manifest=h.manifest}f=this._isCustomTileComponent(h.name);var m=function(t){var r;d=t.componentHandle.getInstance();c=new o({component:d,height:"100%"});if(!i){r=n._mResolvedTiles[e.id];r.tileComponent=d;if(typeof r.visibility==="boolean"){n._notifyTileAboutVisibility(d,r.visibility)}}return c};var T=function(){return l.createComponent({loadCoreExt:f,loadDefaultDependencies:false,componentData:g,url:h.url,applicationConfiguration:{},reservedParameters:{},applicationDependencies:h,ui5ComponentName:h.name},{},[],y.Visualization).then(m)};if(f){s.once("CoreResourcesComplementLoaded").do(function(){T().then(function(e){v.resolve(e)}).fail(function(e){v.reject(e)})})}else{T().then(function(e){v.resolve(e)}).fail(function(e){v.reject(e)})}}.bind(this)).catch(function(e){v.reject(e)});return v.promise()};I.prototype._createTileComponentProperties=function(e,t){var i={};if(!t||v(t)){if(e.properties.indicatorDataSource&&e.properties.indicatorDataSource.path){i.name=b}else{i.name=C}}else{i=t.componentProperties||{};i.name=t.componentName}return i};I.prototype.getTileView=function(e){var t=this;return new jQuery.Deferred(function(i){return t._getTileView(e,false).then(function(e){i.resolve(e)},function(t){var r="Tile with ID '"+e.id+"' could not be initialized"+(t?":\n"+t:".");T.error(r,null,e.tileType);i.reject(r)})}).promise()};I.prototype._getTileView=function(e){var t;var i=new jQuery.Deferred;if(typeof e!=="object"||!e.id){t="Invalid input parameter passed to _getTileView: "+e;T.error(t);return i.reject(t).promise()}var r=this._mResolvedTiles[e.id];if(!r){t="No resolved tile found for tile ID: "+e.id;T.error(t);return i.reject(t).promise()}return this._getTileUiComponentContainer(e,r,false)};I.prototype._createTileComponentData=function(e,t,i){var r=t?this.getCatalogTileTitle(e):this.getTileTitle(e);var o=t?this.getCatalogTilePreviewSubtitle(e):this.getTileSubtitle(e);var n=t?this.getCatalogTilePreviewIcon(e):this.getTileIcon(e);var a=t?this.getCatalogTilePreviewInfo(e):this.getTileInfo(e);var s=t?this.getCatalogTileTargetURL(e):this.getTileTarget(e);var l=this.getTileIndicatorDataSource(e);var u=e.numberUnit||i.tileResolutionResult&&i.tileResolutionResult.numberUnit;var p={properties:{},startupParameters:{}};if(i.tileResolutionResult&&i.tileResolutionResult.isCustomTile===true&&i.tileResolutionResult.startupParameters){p.startupParameters=i.tileResolutionResult.startupParameters}if(r){p.properties.title=r}if(a){p.properties.info=a}if(o){p.properties.subtitle=o}if(n){p.properties.icon=n}if(s){p.properties.targetURL=s}if(u){p.properties.numberUnit=u}if(l.indicatorDataSource){p.properties.indicatorDataSource=l.indicatorDataSource;if(l.dataSource){p.properties.dataSource=l.dataSource}}if(i.tileResolutionResult){p.properties.navigationMode=i.tileResolutionResult.navigationMode;p.properties.contentProviderId=i.tileResolutionResult.contentProviderId||""}return p};I.prototype._enhanceTileComponentData=function(e,t){var i=Promise.resolve();var r=this.getTileContentProviderId(e);if(r){i=sap.ushell.Container.getServiceAsync("ClientSideTargetResolution").then(function(e){return e.getSystemContext(r)}).then(function(e){t.properties.indicatorDataSource.path=e.getFullyQualifiedXhrUrl(t.properties.indicatorDataSource.path)}).catch(function(){T.error("System Context not available")})}return i.then(function(){return t})};I.prototype._isGroupTile=function(t){return e.isGroupTile(t)};I.prototype._isCatalogTile=function(e){return!!(e&&e.isCatalogTile)};I.prototype._isFailedGroupTile=function(t){return!!(t&&this._mFailedResolvedTiles&&this._mFailedResolvedTiles[e.getTileId(t)])};I.prototype.getCatalogTileId=function(e){if(this._isGroupTile(e)){if(this._isFailedGroupTile(e)){return undefined}if(e.isBookmark&&g.get("target.url",e)){return e.target.url}return e.vizId||e.target&&e.target.url}if(this._isCatalogTile(e)){return e.id}return undefined};I.prototype.getCatalogTilePreviewTitle=function(e){if(this._isGroupTile(e)){return this.getTileTitle(e)}return e.tileResolutionResult&&e.tileResolutionResult.title||""};I.prototype.getCatalogTileTargetURL=function(e){if(!e){throw new Error("The given tile is falsy")}if(this._isCatalogTile(e)){if(e.tileResolutionResult&&e.tileResolutionResult.isCustomTile){if(!e.tileResolutionResult.targetOutbound){return""}return this._toHashFromOutbound(e.tileResolutionResult.targetOutbound)}return e.tileIntent||""}return this.getTileTarget(e)};I.prototype.isGroupFeatured=function(e){return!!e.isFeatured};I.prototype._getMember=function(e,t){return p.getMember(e,t)};I.prototype.getCdmVersionsSupported=function(){return{min:new c("3.0.0"),max:new c("3.1.0")}};I.prototype.isSiteSupported=function(e){if(!e._version||new c(e._version).compareTo(this.getCdmVersionsSupported().min)<0||new c(e._version).compareTo(this.getCdmVersionsSupported().max)>0){T.fatal("Invalid CDM site version: Only version 3.0.0 is supported");return false}return true};I.prototype._isCustomTileComponent=function(e){return!(e===C||e===b)};return I});
//# sourceMappingURL=AdapterBase.js.map