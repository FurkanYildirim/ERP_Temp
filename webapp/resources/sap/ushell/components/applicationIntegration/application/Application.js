// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/components/container/ApplicationContainer","sap/ushell/components/applicationIntegration/application/PostMessageAPI","sap/ushell/utils","sap/ui/thirdparty/jquery","sap/ui/thirdparty/URI","sap/ushell/UI5ComponentType","sap/base/Log","sap/base/util/ObjectPath","sap/ui/core/Core"],function(e,t,r,jQuery,i,s,n,a,o){"use strict";var p,l,u=e.getMetadata().getJSONKeys();function c(){var i=this;this.handleMessageEvent=function(t,s,a,o){var p=s.data;if(o===undefined){o=false}if(typeof p==="string"){try{p=JSON.parse(s.data)}catch(e){n.debug("Message received from origin '"+s.origin+"' cannot be parsed: "+e,p,"sap.ushell.components.container.ApplicationContainer");return}}if(p.action==="pro54_setGlobalDirty"&&localStorage.getItem(t.globalDirtyStorageKey)===sap.ushell.Container.DirtyState.PENDING){if(!e.prototype._isTrustedPostMessageSource(t,s)){n.warning("Received message from untrusted origin: "+s.origin,p,"sap.ushell.components.container.ApplicationContainer");return}n.debug("getGlobalDirty() pro54_setGlobalDirty SetItem key:"+t.globalDirtyStorageKey+" value: "+p.parameters.globalDirty,null,"sap.ushell.components.container.ApplicationContainer");r.localStorageSetItem(t.globalDirtyStorageKey,p.parameters.globalDirty,true)}else{i.handleServiceMessageEvent(t,s,p,a,o)}};this.handleServiceMessageEvent=function(i,s,o,p,l){var u=a.get("sap-ushell-config.services.PostMessage.config")||a.create("sap-ushell-config.services.PostMessage.config"),c=o&&o.service,f,g,d,h,v=false,y=t.getAPIs(),m;n.debug("Received post message request from origin '"+s.origin+"': "+JSON.stringify(o),null,"sap.ushell.components.container.ApplicationContainer");if(l===undefined){l=false}if(o.type!=="request"||!c){return}if(c==="sap.ushell.services.MessageBroker"){if(l===true){c=c.concat("._execute")}else{return}}for(var b in y){if(y.hasOwnProperty(b)){if(c.indexOf(b)!==-1){g=y[b];d=b;v=true;break}}}if(v===false){if(p.bPluginsStatusChecked===false||p.bKeepMessagesForPlugins===true){p.bApiRegistered=false}else{A("error",{code:-1,message:"Unknown service name: '"+c+"'"})}return}m=c.indexOf("user.postapi.")===0;f=c.split(".")[3];if(u&&u.enabled===false){n.warning("Received message for "+f+", but this "+"feature is disabled. It can be enabled via launchpad configuration "+"property 'services.PostMessage.config.enabled: true'",undefined,"sap.ushell.components.container.ApplicationContainer");return}if(l===false&&!e.prototype._isTrustedPostMessageSource(i,s)){n.warning("Received message from untrusted origin '"+s.origin+"': "+JSON.stringify(s.data),null,"sap.ushell.components.container.ApplicationContainer");return}function S(e,t){var r;if(t===true){r={oMessage:s,oMessageData:o}}else{r={matchesLocalSid:I,getLocalSystemInSidForma:R,storeSapSystemData:M,executeSetBackNavigationService:C,sendResponseMessage:A,oMessage:s,oMessageData:o,oContainer:i}}try{e(r).done(function(e){var t=e&&e.hasOwnProperty("_noresponse_")?true:false;if(!t){A("success",{result:e})}}).fail(function(e){A("error",{message:e})})}catch(e){A("error",{message:e.message})}}function A(e,t){var r=JSON.stringify({type:"response",service:o.service,request_id:o.request_id,status:e,body:t});n.debug("Sending post message response to origin ' "+s.origin+"': "+r,null,"sap.ushell.components.container.ApplicationContainer");if(typeof s.source!=="object"||s.source===null){n.debug("Cannot send response message to origin ' "+s.origin,"`source` member of request message is not an object","sap.ushell.components.container.ApplicationContainer");return}s.source.postMessage(r,s.origin)}function C(t,r){var s=new jQuery.Deferred,n;if(r.body&&r.body.callbackMessage&&r.body.callbackMessage.service){n=e.prototype._backButtonPressedCallback.bind(null,t.source,r.body.callbackMessage.service,t.origin)}s.resolve(i.getShellUIService().setBackNavigation(n));return s.promise()}function M(e,t){var i,s,a,o=[e.id];if(arguments.length>1){o.unshift(t)}try{a=JSON.stringify(e)}catch(e){n.error("Cannot stringify and store expanded system data: "+e)}if(a){s=r.getLocalStorage();i=r.generateLocalStorageKey("sap-system-data",o);s.setItem(i,a)}}function R(){var e=sap.ushell.Container.getLogonSystem();var t=e.getName();var r=e.getClient();return"sid("+t+"."+r+")"}function I(e){return R().toLowerCase()===e.toLowerCase()}h=g.oServiceCalls[c.replace(d+".","")];if(h&&h.executeServiceCallFn){S(h.executeServiceCallFn,m)}else{A("error",{code:-1,message:"Unknown service name: '"+c+"'"})}};this.init=function(e){l=e};this.restoreArray=function(e){var t=[],r=0;while(e[r]){t.push(e[r]);r++}return t};this._createWaitForRendererCreatedPromise=function(){var e,t;t=sap.ushell.Container.getRenderer();if(t){n.debug("Shell controller._createWaitForRendererCreatedPromise: shell renderer already created, return empty array.");return[]}e=new Promise(function(e,r){var i;i=function(){n.info("Shell controller: resolving component waitFor promise after shell renderer created event fired.");e();sap.ushell.Container.detachRendererCreatedEvent(i)};t=sap.ushell.Container.getRenderer();if(t){n.debug("Shell controller: resolving component waitFor promise immediately (shell renderer already created");e()}else{sap.ushell.Container.attachRendererCreatedEvent(i)}});return[e]};this.createComponent=function(e,t){var r=this,i=new jQuery.Deferred;sap.ushell.Container.getServiceAsync("Ui5ComponentLoader").then(function(n){n.createComponent(e,t,r._createWaitForRendererCreatedPromise(),s.Application).then(i.resolve,i.reject)});return i.promise()};this.stripURL=function(e){var t=e.indexOf("?"),r=e.indexOf("#"),i;if(t>=0){i=e.substr(0,t)}else if(r>=0){i=e.substr(0,r)}else{i=e}return i};this.createApplicationContainer=function(t,r){var i={};this._cleanTargetResolution(r,i);p=new e("application"+t,r);this._restoreTargetResolution(r,i);if(r.appCapabilities){p.setProperty("frameworkId",r.appCapabilities.appFrameworkId,true)}p.setHandleMessageEvent(this.handleMessageEvent);l.setAppCapabilities(p,r);return p};this.active=function(e){if(e){if(e.active){e.active()}}};this.restore=function(e){var t;if(e.container&&e.container._getIFrame&&e.container._getIFrame()!=undefined){this.postMessageToIframeApp(e.container,"sap.ushell.appRuntime","keepAliveAppShow",{},false)}if(e.app){o.getEventBus().publish("sap.ushell","appKeepAliveActivate",e.appTarget);if(e.app.getUrl){t=e.app.getUrl();p=l.get(this.stripURL(t));if(p){l.restoreApp(p.sApplication)}}if(e.app.isKeepAliveSupported&&e.app.isKeepAliveSupported()===true){e.app.activate()}else{if(e.app.restore){e.app.restore()}if(e.app.getRouter&&e.app.getRouter()&&e.app.getRouter().initialize){if(e.enableRouterRetrigger===false){e.app.getRouter().initialize()}else{e.app.getRouter().initialize(true)}}if(e.app.setInitialConfiguration){e.app.setInitialConfiguration()}}p=e.app}};this.store=function(e){var t;if(e.container&&e.container._getIFrame&&e.container._getIFrame()!=undefined){this.postMessageToIframeApp(e.container,"sap.ushell.appRuntime","keepAliveAppHide",{},false)}if(e.app){o.getEventBus().publish("sap.ushell","appKeepAliveDeactivate",e.appTarget);if(e.app.getUrl){t=e.app.getUrl();p=l.get(this.stripURL(t));if(p){l.storeApp(p.sApplication)}}if(e.app.isKeepAliveSupported&&e.app.isKeepAliveSupported()===true){e.app.deactivate()}else{if(e.app.suspend){e.app.suspend()}if(e.app.getRouter&&e.app.getRouter()){e.app.getRouter().stop()}}}};this.destroy=function(e){var t,r,i=false;if(e){if(e.getUrl){t=e.getUrl();r=l.get(this.stripURL(t));if(l.isStatefulContainerSupported(r)){i=true;l.destroyApp(r.sApplication)}}if(e.destroy&&i===false){try{e.destroy()}catch(t){n.error("exception when trying to close sapui5 application with id '"+(e.sId||"<unknown>")+"'. This error must be fixed in order for FLP to operate properly.\n",t.stack,"sap.ushell.components.applicationIntegration.application.Application::destroy")}}}};this.setActiveAppContainer=function(e){p=e};this.getActiveAppContainer=function(){return p};function u(e){try{var t=e.data;if(typeof t==="string"&&t.indexOf("sap.ushell.services.MessageBroker")>0){try{t=JSON.parse(e.data);if(typeof t==="object"&&t.type==="request"&&t.service==="sap.ushell.services.MessageBroker"){sap.ushell.Container.getServiceAsync("MessageBroker").then(function(t){var r=t.getAcceptedOrigins().find(function(t){return t===e.origin});if(r===undefined){return}i.handleMessageEvent(undefined,e,{},true)})}}catch(e){return}}}catch(e){n.error(e.message,e.stack)}}if(sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getServiceAsync){sap.ushell.Container.getServiceAsync("MessageBroker").then(function(e){if(e.isEnabled()){addEventListener("message",u.bind(i))}})}}c.prototype._cleanTargetResolution=function(e,t){var r;if(e){for(r in e){if(u[r]===undefined){t[r]=e[r];delete e[r]}}}};c.prototype._restoreTargetResolution=function(e,t){var r;if(e){for(r in t){e[r]=t[r]}}};c.prototype.getResponseHandler=function(e,r){return t.getResponseHandler(e,r)};c.prototype.isActiveOnly=function(e,r){return t.isActiveOnly(e,r)};c.prototype.isAppTypeSupported=function(e,r,i){var s=t._getPostMesageInterface(r,i);return this.isAppTypeSupportedByPolicy(e,s)};c.prototype.isAppTypeSupportedByPolicy=function(e,t){if(e&&e.getAdditionalInformation&&e.getAdditionalInformation().startsWith("SAPUI5.Component=")){return false}var r=t;if(!r||!r.distributionType){return false}if(r.distributionType.indexOf("all")>=0){return true}if(r.distributionType.indexOf("URL")>=0){return false}if(e.getApplicationType&&r.distributionType.indexOf(e.getApplicationType())>=0){return true}return false};c.prototype.postMessageToIframeApp=function(e,t,r,i,s){var n=t+"."+r,a=this.createPostMessageRequest(n,i);return this.postMessageToIframe(a,e,s)};c.prototype.createPostMessageRequest=function(e,t){var r=Date.now().toString();return{type:"request",request_id:r,service:e,body:t}};c.prototype.createPostMessageResponse=function(e,t,r,i){return{type:"response",request_id:t,service:e,status:i?"success":"error",body:r}};c.prototype.postMessageToIframe=function(e,t,r){var s=t._getIFrame(),n,a;if(!s||!t._getIFrameUrl){return Promise.resolve()}n=new i(t._getIFrameUrl(s));a=n.protocol()+"://"+n.host();return this.postMessageToIframeObject(e,s,a,r,true)};c.prototype.postMessageToIframeObject=function(e,t,r,i,s){var a=e.request_id;return new Promise(function(o,p){function l(r){var i;try{if((s===true?t.contentWindow:t)!==r.source){return}if(typeof r.data==="string"&&r.data.indexOf("{")===0){try{i=JSON.parse(r.data)}catch(e){i={}}}else{return}if(!i.request_id||a!==i.request_id){return}if(i.status==="success"){o(i)}else{p(i)}window.removeEventListener("message",l)}catch(t){o();n.warning("Obtained bad response from framework in response to message "+e.request_id);n.debug("Underlying framework returned invalid response data: '"+r.data+"'")}}if(!t){o()}else{var u=JSON.stringify(e);n.debug("Sending postMessage "+u+" to iframe with domain '"+r+"'");if(i){window.addEventListener("message",l,false);if(s===true){t.contentWindow.postMessage(u,r)}else{t.postMessage(u,r)}}else{if(s===true){t.contentWindow.postMessage(u,r)}else{t.postMessage(u,r)}o()}}})};c.prototype.registerShellCommunicationHandler=function(e){t.registerShellCommunicationHandler(e)};c.prototype._getPostMesageInterface=function(e,r){return t._getPostMesageInterface(e,r)};return new c},true);
//# sourceMappingURL=Application.js.map