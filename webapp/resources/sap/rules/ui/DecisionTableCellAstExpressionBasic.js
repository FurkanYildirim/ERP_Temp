/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2016 SAP SE. All rights reserved
	
 */
sap.ui.define(["jquery.sap.global","./library","sap/rules/ui/Utils","sap/rules/ui/AstExpressionBasic","sap/rules/ui/Constants","./DecisionTableCellAstExpressionBasicRenderer"],function(jQuery,e,t,i,s,a){"use strict";var o=i.extend("sap.rules.ui.DecisionTableCellAstExpressionBasic",{metadata:{library:"sap.rules.ui",properties:{headerValue:{type:"string",defaultValue:"",bindable:"bindable"},fixedOperator:{type:"string",defaultValue:"",bindable:"bindable"},type:{type:"sap.rules.ui.ExpressionType",defaultValue:sap.rules.ui.ExpressionType.BooleanEnhanced,bindable:"bindable"}}},renderer:a});o.prototype.validateExpression=function(){var e=this.getValue();if(e){var t=this.getHeaderValue()+" "+this.getFixedOperator()+" "+e}else{this.setValueStateText("")}};o.prototype.init=function(){sap.rules.ui.AstExpressionBasic.prototype.init.apply(this,arguments);this.bFlagForChangeBeforeBlur=false;this.oBundle=sap.ui.getCore().getLibraryResourceBundle("sap.rules.ui.i18n")};o.prototype.onAfterRendering=function(){var e=this;this._oAstExpressionLanguage=sap.ui.getCore().byId(this.getAstExpressionLanguage());sap.rules.ui.AstExpressionBasic.prototype.onAfterRendering.apply(this,arguments);this.oDecisionTableCell=this.getParent()&&this.getParent().getParent()?this.getParent().getParent():null;this._handleValidation();if(jQuery.sap.byId(this.getId()).closest("td").next().width()){this._showPopUp()}if(this.oDecisionTableCell){this.markerString=this.oDecisionTableCell._getMarkerString().trim();var t=this.oDecisionTableCell.getValueStatePath();var i=this.oDecisionTableCell.getModel("dtModel");var s=this.oDecisionTableCell.getAggregation("_displayedControl");if(s){i.setProperty(t.slice(8),sap.ui.core.ValueState.None)}}};o.prototype._handleValidation=function(){this.validateExpression()};o.prototype.exit=function(){this._handleValidation();if(this.bFocusCellAfterEscape&&this.oDecisionTableCell){var e=this.oDecisionTableCell.getDomRef().parentElement.parentElement;if(e){jQuery(e).focus()}}};o.prototype.createEventListeners=function(){};o.prototype._updateModelAstNodes=function(e,t,i){if(this.oDecisionTableCell){var s=t.ASTNodes;for(var a in s){var o={};if(s[a].Root){o.Sequence=1;o.Root=true}else{o.Sequence=s[a].SequenceNumber;o.ParentId=s[a].ParentId}if(s[a].Function){o.Function=s[a].Function?s[a].Function:""}if(s[a].Type==="I"){o.IncompleteExpression=s[a].Value}if(s[a].Type!=="P"&&s[a].Type!=="O"&&!s[a].Function){o.BusinessDataType=s[a].Output?s[a].Output.BusinessDataType:s[a].BusinessDataType;o.DataObjectType=s[a].Output?s[a].Output.DataObjectType:s[a].DataObjectType;o.Value=s[a].Value?s[a].Value:""}else if(s[a].Type==="O"){o.Reference=s[a].Reference}o.NodeId=s[a].Id;o.Type=s[a].Type;o.RuleId=t.RuleId;o.Version=t.Version;o.ColId=t.ColId;o.RowId=t.RowId;var r={};r.properties=o;r.groupId=i;e.createEntry("/DecisionTableRowCellASTs",r)}}};o.prototype._removeExistingAstNodes=function(e,t,i,s,a){if(this.oDecisionTableCell){var o={};o.ColId=t.ColId;o.RowId=t.RowId;o.RuleId=t.RuleId;o.Version=t.Version;var r;var l=[];var n;if(s&&s.length>0){for(var u=0;u<s.length;u++){r={};r.ColId=t.ColId;r.RowId=t.RowId;r.RuleId=t.RuleId;r.Version=t.Version;r.NodeId=s[u].Id;n=e.createKey("DecisionTableRowCellASTs",r);l.push(n)}}if(i&&e.getProperty(i)&&"DecisionTableRowCellASTs"in e.getProperty(i)&&e.getProperty(i).DecisionTableRowCellASTs&&"__list"in e.getProperty(i).DecisionTableRowCellASTs){e.getProperty(i).DecisionTableRowCellASTs.__list=l}e.callFunction("/DeleteDTRowCellASTDraft",{method:"POST",groupId:a,urlParameters:o})}};o.prototype._checkEmptyMarkerNode=function(e){if(e&&e.length===1&&(e[0].Type==="I"&&(e[0].Value===""||e[0].Value===this.markerString)||e[0].Type==="M")){return false}return true};o.prototype._removeAndUpdateExisitingNodes=function(e,t,i,s,a){var o=t.RowId+","+t.ColId;e.setDeferredGroups([o]);var r=sap.ui.getCore().getEventBus();e.update(i,{Content:e.getProperty(a)},{groupId:o,success:function(e){r.publish("sap.ui.rules","astCreated")}});this._removeExistingAstNodes(e,t,i,s,o);if(this._checkEmptyMarkerNode(s)){this._updateModelAstNodes(e,t,o)}e.submitChanges({groupId:o})};o.prototype._changeValue=function(e){var t={};if(this.oDecisionTableCell){var i=e.getSource();var s=sap.ui.getCore().getEventBus();var a=e.getParameter("newValue");i.setValue(a);var o=this.oDecisionTableCell.getAggregation("_displayedControl");o.setValue(e.getParameter("displayText"));o.JSON=this.getJsonData();o.relString=this.relString;var r=sap.ui.getCore().byId(this.getAstExpressionLanguage());var l=this.getBindingContext().getModel();t=this.oDecisionTableCell.getKeyProperties();var n=e.getParameter("astNodes");if(n&&n.length===1&&n[0].Type==="I"&&n[0].Value!==""&&n[0].Value!==this.markerString){o.setValueState("Error");o.setTooltip(this.oBundle.getText("invalidExpression"))}else{o.setValueState("None")}t.ASTNodes=n;var u=this.oDecisionTableCell.getValuePath();var p="/"+u.split("/")[1];s.publish("sap.ui.rules","astCreating");this._removeAndUpdateExisitingNodes(l,t,p,n,u)}};return o},true);
//# sourceMappingURL=DecisionTableCellAstExpressionBasic.js.map