// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/datajs","sap/ushell_abap/pbServices/ui2/Utils","sap/ushell_abap/pbServices/ui2/ODataService","sap/ushell_abap/pbServices/ui2/Error","sap/base/Log","sap/ui/thirdparty/jquery","sap/ui/core/Core"],function(e,t,a,r,n,jQuery,s){"use strict";function i(){}function o(e,a){if(t.isArray(e)){e.forEach(function(e){e.reject(a)})}else{e.reject(a)}}var u;u=function(e,a){var c="saplb",p,l,d,h=this,g,b;function O(e){var t={};t.baseUrl=e[0];if(typeof e[2]==="boolean"){t.supportsChangeSets=e[2]}return t}this.getBatchQueue=function(){return p};u.headerValue=function(e,t){e=e.toLowerCase();for(var a in t){if(Object.prototype.hasOwnProperty.call(t,a)&&a.toLowerCase()===e){return t[a]}}return undefined};function S(t){var a=e["sap-language"]||u["sap-language"],r=e["sap-statistics"]||u["sap-statistics"],n=e["sap-client"]||u["sap-client"];t=t||{};if(a){t["sap-language"]=a}if(r||r==="false"){t["sap-statistics"]=""+r}if(n){t["sap-client"]=n}return t}function y(e){e=e||{};var t=u.oStickySessionConfiguration[g];if(typeof t==="undefined"){return e}if(t&&t.enabled&&typeof t.value!=="undefined"){e[c]=t.value}return e}this.detectStickySession=function(e){var t,a=u.oStickySessionConfiguration[g];if(!a||!a.enabled){return}t=u.headerValue(c,e);if(typeof t==="undefined"){return}if(a.value!==t){a.value=t}};u.csrfTokenValue=function(e){var t=u.headerValue("x-csrf-token",e);if(t==="Required"){return t}var a=u.headerValue("cache-control",e);if(a===undefined||a.indexOf("max-age=0")>-1||a.indexOf("no-cache")>-1){return t||""}return""};this.doRequest=function(e,r,o,c,f,p,l){n.debug("[000] do request, sMethod",r,"ODataWrapper");var d;c=c||i;f=f||a.getDefaultErrorHandler();h.check(c,f);d={Accept:"application/json","Accept-Language":s.getConfiguration().getLanguage()||"","X-CSRF-Token":a.getCsrfToken()};S(d);y(d);OData.request({requestUri:e,method:r,data:o,headers:d},function(a,s){this.detectStickySession((s||{}).headers);n.debug("Received OData response for "+r+' "'+e+'"',null,"ODataWrapper");t.callHandler(c.bind(null,a),f)}.bind(this),function(t){function s(){f.apply(null,arguments)}function i(){c.apply(null,arguments)}if(!l&&t.response.statusCode===403&&u.csrfTokenValue(t.response.headers).toLowerCase()==="required"){n.debug("CSRF token required for "+r+' "'+e+'", refreshing it',JSON.stringify(t.response),"ODataWrapper");a.refreshCsrfToken(this.doRequest.bind(h,e,r,o,i,s,p,true),s)}else{h.onError(r,e,f,null,t)}}.bind(this),p);n.debug("Sent OData request for "+r+' "'+e+'"',null,"ODataWrapper")};this.toRelativeUrl=function(e){var t=e.indexOf(g);if(t<0){throw new r('Not relative to base URL "'+g+'": '+e,"ODataWrapper")}return e.slice(t+g.length)};this.toRequestUrl=function(e){if(/^\//.test(e)){throw new r("Not a relative URL: "+e,"ODataWrapper")}return g+e};this.readOrBatch=function(e,t,a){var r,i=this.toRequestUrl(e),o=y(S());if(p){n.debug('Queued OData request for GET "'+e+'"',null,"ODataWrapper");p.push({method:"GET",requestUri:e,headers:o});r=(new jQuery.Deferred).done(t).fail(a);d.push(r);l=false;return}o.Accept="application/json";o["Accept-Language"]=s.getConfiguration().getLanguage()||"";o["X-CSRF-Token"]="Fetch";OData.read({requestUri:i,headers:o},t,a);n.debug('Sent OData request for GET "'+i+'"',null,"ODataWrapper")};this.requestOrBatch=function(e,r,s,o,u){var c,f={data:s,method:r,requestUri:e,headers:y(S())},g=this.toRequestUrl(e);if(p){o=o||i;u=u||a.getDefaultErrorHandler();h.check(o,u);n.debug("Queued OData request for "+r+' "'+e+'"',null,"ODataWrapper");if(!l){p.push({__changeRequests:[]});d.push([]);l=b}p[p.length-1].__changeRequests.push(f);c=(new jQuery.Deferred).done(function(e,a){n.debug("Received OData response for "+r+' "'+g+'"',null,"ODataWrapper");t.callHandler(o.bind(null,e),u)}).fail(h.onError.bind(h,r,g,u,null));d[d.length-1].push(c);return}this.doRequest(g,r,s,o,u)};this.isStickySessionEnabled=function(){return(u.oStickySessionConfiguration[g]||{}).enabled||false};this.enableStickySession=function(){u.oStickySessionConfiguration[g].enabled=true};this.check=function(e,t){if(!e){throw new r("Missing success callback","ODataWrapper")}if(typeof e!=="function"){throw new r("Success callback is not a function","ODataWrapper")}if(!t){throw new r("Missing error callback","ODataWrapper")}if(typeof t!=="function"){throw new r("Error callback is not a function","ODataWrapper")}};this.create=function(e,t,a,r){n.debug("[000] create: url",e,"ODataWrapper");this.requestOrBatch(e,"POST",t,a,r)};this.del=function(e,t,a){var r=e;if(typeof r!=="string"){r=this.toRelativeUrl(e.__metadata.uri)}this.requestOrBatch(r,"DELETE",null,function(e){if(t){t()}},a)};this.getBaseUrl=function(){return g};this.getODataService=function(){return a};this.onError=function(e,t,a,r,s){var i,o="Error ";if(s.response&&s.response.statusCode){o+="("+s.response.statusCode+", "+s.response.statusText+") "}o+="in OData response for "+e+' "'+t+'": '+s.message;if(s.response&&s.response.body){try{i=JSON.parse(s.response.body).error;if(i){if(i.hasOwnProperty("message")&&i.message.hasOwnProperty("value")){o+="\nDetails: "+i.message.value}if(s.response.statusCode&&!i.httpStatus){i.httpStatus=s.response.statusCode}}}catch(e){}}n.error(o,JSON.stringify(s.response),"ODataWrapper");if(r){r.reject(o,i)}a(o,i)};this.openBatchQueue=function(){if(p){throw new r("Batch queue already open","ODataWrapper")}p=[];d=[];l=false};this.isBatchQueueOpen=function(){return!!p};this.read=function(e,r,s,i){var o,c=this.toRequestUrl(e),f;function p(e,i){this.detectStickySession(i.headers);a.setCsrfToken(u.csrfTokenValue(i.headers)||a.getCsrfToken());n.debug('Received OData response for GET "'+c+'"',null,"ODataWrapper");f=u.headerValue("sap-message",i.headers);if(f){n.warning("SAP message for GET "+c,f,"ODataWrapper")}if(o){o.resolve(JSON.parse(JSON.stringify(e)),a.getCsrfToken())}t.callHandler(r.bind(null,e),s)}s=s||a.getDefaultErrorHandler();this.check(r,s);if(i){OData.read.$cache=OData.read.$cache||new t.Map;o=OData.read.$cache.get(c);if(o){n.debug('Using cached response for GET "'+c+'"',null,"ODataWrapper");o.done(function(e,n){a.setCsrfToken(a.getCsrfToken()||n);t.callHandler(r.bind(null,JSON.parse(JSON.stringify(e))),s)}).fail(s);return}o=new jQuery.Deferred;OData.read.$cache.put(c,o.promise())}this.readOrBatch(e,p.bind(this),this.onError.bind(this,"GET",c,s,o))};this.batch=function(e,t,a){var r=this.toRequestUrl("$batch");this.doRequest(r,"POST",e,t,a,OData.batchHandler)};this.submitBatchQueue=function(e,s){var i=d;function u(r){var n=r.__batchResponses.length,u=i.length;if(u!==n){h.onError("POST",this.toRequestUrl("$batch"),s,null,{message:"Protocol error! Expected "+u+" responses, but received "+n});return}r.__batchResponses.forEach(function(e,t){var a=i[t];if(e.response){o(a,e)}else if(e.__changeResponses){e.__changeResponses.forEach(function(e,t){a[t].resolve(e.data,e)})}else{a.resolve(e.data,e)}});if(e){t.callHandler(e,a.getDefaultErrorHandler())}}if(!p){throw new r("No open batch queue to submit","ODataWrapper")}if(p.length>0){n.debug("[000] submit batch queue: batch","ODataWrpper");this.batch({__batchRequests:p},u.bind(this),s)}else if(e){t.callHandler(e,a.getDefaultErrorHandler(),true)}n.debug("[000] submit batch queue","ODataWrapper");p=undefined;d=undefined};this.toString=function(e){var t=['ODataWrapper({sBaseUrl:"',g,'"'];t.push("})");return t.join("")};this.put=function(e,t,a,r){n.debug("[000] put: request or batch, payload.id",t.id,"ODataWrapper");this.requestOrBatch(e,"PUT",t,function(e){if(a){a()}},r)};this.update=function(e,t,a){var r={__metadata:{type:e.__metadata&&e.__metadata.type}},n,s=this.toRelativeUrl(e.__metadata.uri);for(n in e){if(Object.prototype.hasOwnProperty.call(e,n)&&n.indexOf("$")!==0&&typeof e[n]!=="object"){r[n]=e[n]}}this.put(s,r,t,a)};if(typeof e==="string"){e=O(arguments)}else if(typeof e==="object"){e=f(e)}if(!e||!e.baseUrl||typeof e.baseUrl!=="string"){throw new r("Missing base URL","ODataWrapper")}if(!a||typeof a!=="object"){throw new r("Missing OData service facade","ODataWrapper")}e.baseUrl=e.baseUrl.replace(/\/$/,"")+"/";g=e.baseUrl;b=e.supportsChangeSets;if(typeof u.oStickySessionConfiguration==="undefined"){n.error("ODataWrapper.oStickySessionConfiguration is not defined!","the ODataWrapper constructor was called before the static property was defined","ODataWrapper")}else if(typeof u.oStickySessionConfiguration[g]==="undefined"){u.oStickySessionConfiguration[g]={enabled:false,value:undefined}}};function c(e){var t={};var a={};t.baseUrl=e[0];if(typeof e[1]==="boolean"){t.supportsChangeSets=e[1]}if(typeof e[2]==="function"){a.defaultFailure=e[2]}a.settings=t;return a}function f(e){if(e===undefined){return undefined}try{return JSON.parse(JSON.stringify(e))}catch(e){return undefined}}if(typeof u.oStickySessionConfiguration==="undefined"){u.oStickySessionConfiguration={}}u.checkSapStatisticsSetting=function(e){try{u["sap-statistics"]=s.getConfiguration().getStatistics()}catch(t){u["sap-statistics"]=/sap-statistics=(true|x|X)/.test(e)}};u.checkSapStatisticsSetting(window.location.search);u._Service=function e(t,r){var n=new u(t,this);a.call(this,n,r);return n};u.createODataWrapper=function(e,t){n.debug("[000] createOdataWrapper","ODataWrapper");if(typeof arguments[0]==="string"){var a=c(arguments);e=a.settings;if(a.defaultFailure){t=a.defaultFailure}}else if(typeof arguments[0]==="object"){e=f(e)}return new u._Service(e,t)};return u});
//# sourceMappingURL=ODataWrapper.js.map