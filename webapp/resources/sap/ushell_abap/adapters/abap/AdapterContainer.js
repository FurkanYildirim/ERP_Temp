// Copyright (c) 2009-2023 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/util/ObjectPath","sap/base/Log","sap/ui/thirdparty/jquery","sap/ui/core/format/DateFormat","sap/ushell_abap/pbServices/ui2/ODataService","sap/ushell/services/_Personalization/constants"],function(e,t,jQuery,n,r,i){"use strict";var o="PersContainers",a="yyyyMMddHHmmss",s=new Date(9999,1,1,0,0,0),c=new Date(9999,1,1,0,0,0,0),u="ADMIN#sap-ushell-container-expireUTCTimestamp",p="ADMIN#sap-ushell-container-storageUTCTimestamp",f="ADMIN#sap-ushell-container-scope";function y(e){var n="sap.ushell.personalization#";if(e.substring(0,n.length)!==n){t.error("Unexpected ContainerKey "+e);return e}return e.substring(n.length,n.length+40)}var l=function(t,n,r,i){this._oService=n;this._oScope=r;this["sap-cache-id"]=e.get("_oService._oConfig.services.personalization.cacheId",this);this._sContainerKey=y(t);this._sAppName=i||"";this._category=this._determineCategory(r);this._oJSONContainer={category:this._category,clientExpirationTime:c,appName:this._sAppName,component:"",id:this._sContainerKey,PersContainerItems:[]};this._oPropertyBag={};this._aOperationQueue=[]};l.prototype._reset=function(){this._oJSONContainer.PersContainerItems=[]};l.prototype._obtainODataWrapper=function(){return this._oService._oWrapper};l.prototype.load=function(){var e=new jQuery.Deferred,n=this,i=this._obtainODataWrapper(),a=o+"(category='"+this._category+"',id='"+encodeURIComponent(this._sContainerKey)+"')?$expand=PersContainerItems";if(this._category&&this._category==="P"&&this["sap-cache-id"]){a=a+"&sap-cache-id="+this["sap-cache-id"]}r.call(this,i,function(){return false});i.read(a,function(t){n._oJSONContainer=t;n._oJSONContainer.category=n._category;n._oJSONContainer.id=n._sContainerKey;n._oJSONContainer.appName=n._sAppName;n._oJSONContainer.PersContainerItems=n._oJSONContainer.PersContainerItems&&n._oJSONContainer.PersContainerItems.results||[];e.resolve(n)},function(r){t.warning(r);n._reset();e.resolve(n)});return e.promise()};l.prototype.save=function(){t.debug("[000] save","AdapterContainer");var e=new jQuery.Deferred,n=this,i=this._obtainODataWrapper(),a=o;r.call(this,i,function(){return false});i.create(a,this._oJSONContainer,function(){e.resolve(n)},function(t){e.reject(t)});return e.promise()};l.prototype.del=function(){var e=new jQuery.Deferred,t=this,n=this._obtainODataWrapper(),i=o+"(category='"+this._category+"',id='"+encodeURIComponent(this._sContainerKey)+"')";r.call(this,n,function(){return false});n.del(i,function(n){e.resolve(t)},function(t){e.reject(t)});this._reset();return e.promise()};l.prototype.getItemKeys=function(){var e=[];this._oJSONContainer.PersContainerItems.forEach(function(t){if(t.category==="V"){e.push("VARIANTSET#"+t.id)}else if(t.category==="I"){e.push("ITEM#"+t.id)}});if(this._oJSONContainer.validity>=0){e.push(p);e.push(u);e.push(f)}return e};l.prototype.containsItem=function(e){return this.getItemKeys().indexOf(e)>=0};function h(e){if(e===undefined||e===null){return null}var t=n.getDateInstance({pattern:a});return t.parse(JSON.parse(e),true)}function d(e){var r=n.getDateInstance({pattern:a});if(e===null){e=c}if(typeof e==="string"){if(/\/Date\(([0-9]+)\)\//.exec(e)){e=new Date(parseInt(/\/Date\(([0-9]+)\)\//.exec(e)[1],10))}else{t.error("Expected Date format "+e)}}if(+e===+c){return undefined}return r.format(e,true)}l.prototype._findItemIndex=function(e,t){var n;for(n=0;n<this._oJSONContainer.PersContainerItems.length;n=n+1){if(this._oJSONContainer.PersContainerItems[n].id===e&&this._oJSONContainer.PersContainerItems[n].category===t){return n}}return undefined};l.prototype._locateItem=function(e){var n={index:-1};if(e===u){return{containerProperty:"clientExpirationTime",initialValue:c,convToABAP:h,convFromABAP:d}}if(e===f){return{containerProperty:"validity",initialValue:0,convToABAP:function(e){if(!e){return null}return JSON.parse(e).validity},convFromABAP:function(e,t){if(e<=0){return undefined}t=t||{};t.validity=e;return t}}}if(e===p){return{containerProperty:" ignore",initialValue:s,convToABAP:h,convFromABAP:d}}if(e.indexOf("ITEM#")===0){n.trueItemKey=e.substring("ITEM#".length,"ITEM#".length+40);n.category="I"}else if(e.indexOf("VARIANTSET#")===0){n.trueItemKey=e.substring("VARIANTSET#".length,"VARIANTSET#".length+40);n.category="V"}else if(e.indexOf("ADMIN#")!==0){t.error("Unknown itemkey prefix"+e)}n.index=this._findItemIndex(n.trueItemKey,n.category);return n};l.prototype.getItemValue=function(e){var t="",n,r=this._locateItem(e);if(r.containerProperty===" ignore"){return undefined}if(r.index>=0){t=this._oJSONContainer.PersContainerItems[r.index].value;try{n=JSON.parse(t)}catch(e){if(t==="X"){n=true}else{n=undefined}}}if(r.containerProperty){if(typeof r.convFromABAP==="function"){return r.convFromABAP(this._oJSONContainer[r.containerProperty],n)}return this._oJSONContainer[r.containerProperty]}return n};l.prototype.setItemValue=function(e,t){var n=JSON.stringify(t),r=this._locateItem(e);if(r.containerProperty===" ignore"){return}if(r.containerProperty){if(typeof r.convToABAP==="function"){this._oJSONContainer[r.containerProperty]=r.convToABAP(n)}else{this._oJSONContainer[r.containerProperty]=n}if(!r.trueItemKey){return}}if(r.index>=0){this._oJSONContainer.PersContainerItems[r.index].value=n;return}this._oJSONContainer.PersContainerItems.push({value:n,id:r.trueItemKey,category:r.category,containerId:this._sContainerKey,containerCategory:this._category})};l.prototype.delItem=function(e){var t=this._locateItem(e);if(t.containerProperty===" ignore"){return}if(t.containerProperty){this._oJSONContainer[t.containerProperty]=t.initialValue;return}if(t.index>=0){this._oJSONContainer.PersContainerItems.splice(t.index,1);return}};l.prototype._determineCategory=function(e){if(!e){return"U"}var t=i;if(e.keyCategory&&e.keyCategory===t.keyCategory.FIXED_KEY&&e.writeFrequency&&e.writeFrequency===t.writeFrequency.LOW&&e.clientStorageAllowed&&e.clientStorageAllowed===true){return"P"}return"U"};return l});
//# sourceMappingURL=AdapterContainer.js.map