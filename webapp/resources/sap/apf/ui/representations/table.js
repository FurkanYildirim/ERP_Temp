/* SAP APF Analysis Path Framework
* 
* (c) Copyright 2012-2014 SAP SE. All rights reserved
*/
sap.ui.define(["sap/apf/core/constants","sap/apf/ui/utils/formatter","sap/apf/ui/representations/utils/paginationHandler","sap/apf/ui/representations/BaseUI5ChartRepresentation","sap/apf/ui/representations/utils/paginationDisplayOptionHandler","sap/ui/Device","sap/ui/model/BindingMode","sap/ui/model/Sorter","sap/ui/table/Table","sap/ui/table/Column","sap/ui/table/library","sap/ui/core/CustomData","sap/ui/model/json/JSONModel","sap/ui/core/Icon","sap/ui/core/library","sap/ui/core/mvc/ViewType","sap/ui/layout/VerticalLayout","sap/m/Text","sap/m/Title","sap/m/Label","sap/m/library","sap/m/Link","sap/m/Button","sap/m/FlexItemData","sap/m/HBox","sap/m/VBox","sap/m/ScrollContainer","sap/ui/export/Spreadsheet","sap/apf/ui/utils/determineColumnSettingsForSpreadSheetExport","sap/m/Dialog","sap/ui/thirdparty/jquery"],function(e,t,a,i,n,o,r,s,l,p,d,u,h,c,g,f,m,v,b,y,A,T,S,F,D,x,w,P,C,R,jQuery){"use strict";var E=A.DialogType;var I=g.HorizontalAlign;var O=g.TitleLevel;var H=d.VisibleRowCountMode;function N(e,t){t.forEach(function(t){e.addSelectionInterval(t,t)})}function B(e){e.loadAllButton.attachEvent("setFocusOnLoadAllButtonEvent",e.loadAllButton.setFocusOnLoadAllButton)}function V(e,t){if(e.bIsAlternateRepresentation&&e.oApi.getActiveStep()){e.oApi.getActiveStep().getSelectedRepresentation().oRepresentationFilterHandler.getFilterValues().forEach(function(t){if(e.aFiltersInTable.indexOf(t)===-1){e.aFiltersInTable.push(t)}})}if(t&&e.oParameter.top||e.oParameter.isAlternateRepresentation){e.aFiltersInTable=M(e,t)}}function M(e,t){var a=[];e.aFiltersInTable.forEach(function(i){e.aDataResponse.forEach(function(e){var n=e[t];if(n==i&&a.indexOf(i)===-1){a.push(i)}})});return a}function L(e,t,a){var i=e.tableControl.getContextByIndex(a[0]).getProperty(t);if(e.tableControl.isIndexSelected(a[0])&&e.aFiltersInTable.indexOf(i)===-1){e.aFiltersInTable.push(i)}else{var n=e.aFiltersInTable.indexOf(i);if(n!==-1){e.aFiltersInTable.splice(n,1)}}}function k(e,t){U(e);e.aFiltersInTable=t;e.oApi.getActiveStep().getSelectedRepresentation().oRepresentationFilterHandler.updateFilterFromSelection(t);e.oApi.selectionChanged()}function U(e){e.oRepresentationFilterHandler.clearFilters();e.oApi.getActiveStep().getSelectedRepresentation().oRepresentationFilterHandler.clearFilters();e.aValidatedFilter=[];e.aFiltersInTable=[]}function q(e,t,a,i,n){var o=e.nDataResponseCount||0;var r,s;var l=e.oApi.getTextNotHtmlEncoded("buttonTextExport");var p=new S({text:l,press:function(){if(e.aDataResponse.length>1e4){var a=e;a.newOpenDialog=new R({type:E.Message,title:e.oApi.getTextNotHtmlEncoded("warningTitle"),state:"Warning",content:new v({text:e.oApi.getTextNotHtmlEncoded("exportWarning")}),beginButton:new S({text:e.oApi.getTextNotHtmlEncoded("warningExport"),press:function(){e.exportExcel(t);a.newOpenDialog.close()}}),endButton:new S({text:e.oApi.getTextNotHtmlEncoded("warningCancel"),press:function(){a.newOpenDialog.close()}}),afterClose:function(){a.oUiApi.getLayoutView().setBusy(false);a.newOpenDialog.destroy()}});a.newOpenDialog.open()}else{e.exportExcel(t)}}}).addStyleClass("sapUiTinyMarginBeginEnd");e.titleControl=new b({level:O.H1}).addStyleClass("sapUiTinyMarginBegin").addStyleClass("sapUiTinyMarginTop");if(e.aDataResponse.length===0){p.setEnabled(false)}if(n){s=e.title}else if(e.oParameter.top){r=new D({items:[p]});s=e.title}else if(i){r=new D({items:[p]});s=e.oApi.getTextNotHtmlEncoded("stepTitleWithNumberOfRecords",[e.title,a,a])}else{l=e.oApi.getTextNotHtmlEncoded("buttonTextLoadAll");if(e.loadAllButton===undefined){e.loadAllButton=new S({text:l,press:e.loadAll.bind(e)});e.loadAllButton.setFocusOnLoadAllButton=function(){this.focus();this.detachEvent("setFocusOnLoadAllButtonEvent",this.setFocusOnLoadAllButton)}}r=new D({items:[e.loadAllButton,p]});s=e.oApi.getTextNotHtmlEncoded("stepTitleWithNumberOfRecords",[e.title,a,o]);e.loadAllButton.addAriaLabelledBy(e.titleControl)}p.addAriaLabelledBy(e.titleControl);e.titleControl.setText(s);var d=new D({alignItems:"Start",wrap:"Wrap",justifyContent:"SpaceBetween",items:[e.titleControl,r]});return d}function W(e,t,a,i){var n=function(t){return function(i){if(a.metadata!==undefined){var n;if(e.value[t]&&i){n=a.oFormatter.getFormattedValueAsString(e.value[t],i);if(n!==undefined){return n}}}return i}};var s=new l({title:t,showNoData:false,enableSelectAll:false,visibleRowCountMode:H.Auto});if(i){s.setWidth(i+"px")}s.setLayoutData(new F({growFactor:1}));if(o.system.desktop){s.addStyleClass("sapUiSizeCompact")}var d=a.oParameter.requiredFilters;var c=d&&d.length>0?"MultiToggle":"None";s.setSelectionMode(c);var g=[],f,m,b;for(var A=0;A<e.name.length;A++){f=new v({wrapping:false});f.bindText(e.value[A],n(A),r.OneWay);f.bindProperty("tooltip",e.value[A],n(A));m=new p({label:new y({text:e.name[A],tooltip:e.name[A]}),template:f});b=new u({value:{text:e.name[A],key:e.value[A]}});if(i){m.setMinWidth(125)}m.addCustomData(b);g.push(m)}var T;T=g;T.forEach(function(e){s.addColumn(e)});if(g.length>10){s.getColumns().forEach(function(e){e.setWidth("125px")})}var S=new h;S.setSizeLimit(1e4);var D=a.getData();S.setData({tableData:D});s.setModel(S);s.bindRows("/tableData");if(a.metadata!==undefined){for(var x=0;x<e.name.length;x++){var w=a.metadata.getPropertyMetadata(e.value[x]);if(w["aggregation-role"]==="measure"){var P=s.getColumns()[x];P.setHAlign(I.End)}}}return s}function j(e){var t=e.getData();var a=[],i;var n={name:[],value:[]};a=e.oParameter.dimensions.concat(e.oParameter.measures).length?e.oParameter.dimensions.concat(e.oParameter.measures):e.parameter.properties;if(t.length!==0){for(var o=0;o<a.length;o++){n.value[o]=a[o].fieldName;var r=e.metadata.getPropertyMetadata(a[o].fieldName).label||e.metadata.getPropertyMetadata(a[o].fieldName).name;var s="";if(e.metadata!==undefined&&e.metadata.getPropertyMetadata(a[o].fieldName).unit!==undefined){var l=e.metadata.getPropertyMetadata(a[o].fieldName).unit;s=e.getData()[0][l];for(i=0;i<e.getData().length;i++){if(s!==e.getData()[i][l]){s=undefined;break}}n.name[o]=a[o].fieldDesc===undefined||!e.oApi.getTextNotHtmlEncoded(a[o].fieldDesc).length?r:e.oApi.getTextNotHtmlEncoded(a[o].fieldDesc);if(s!==undefined&&s!==""){n.name[o]=e.oApi.getTextNotHtmlEncoded("displayUnit",[n.name[o],s])}}else{n.name[o]=a[o].fieldDesc===undefined||!e.oApi.getTextNotHtmlEncoded(a[o].fieldDesc).length?r:e.oApi.getTextNotHtmlEncoded(a[o].fieldDesc)}}}return n}function _(e){var t;var a=e.getSelectedSortItem();e.getSortItems().forEach(function(e){if(e.getId()===a){t=e.getKey()}});return t}var z=function(e,t){this.oViewSettingDialog=undefined;this.aDataResponse=[];this.aValidatedFilter=[];this.aFiltersInTable=[];this.oParameter=t;this.orderby=t.orderby;this.omitTopAndSkipOptionsForNextPathUpdate=false;sap.apf.ui.representations.BaseUI5ChartRepresentation.apply(this,[e,t]);this.alternateRepresentation=t.alternateRepresentationType;this.type=sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION;this.oPaginationHandler=new sap.apf.ui.representations.utils.PaginationHandler(this);this.oPaginationDisplayOptionHandler=new sap.apf.ui.representations.utils.PaginationDisplayOptionHandler;this._drawSelection=function(e){var t=this.oParameter.requiredFilters;var a=t&&t.length>0?t[0]:undefined;var i=e.getParameter("userInteraction");var n=e.getParameter("rowIndices");if(!i||n.length===0){return}if(e.getSource().getFocusDomRef()&&e.getSource().getFocusDomRef().offsetTop!==0){this.nFirstVisibleRow=this.tableControl.getFirstVisibleRow()}L(this,a,n);var o=jQuery.unique(this.aFiltersInTable);k(this,o)};this._handleSelectionEvent=function(e){this._drawSelection(e)};this._getSelectedIndicesInTable=function(e){var t=this;var a=[];t.aDataResponse.forEach(function(i,n){var o=i[e];if(t.aFiltersInTable.indexOf(o)!==-1){a.push(n)}});return a}};z.prototype=Object.create(sap.apf.ui.representations.BaseUI5ChartRepresentation.prototype);z.prototype.constructor=z;z.prototype.setData=function(e,t,a,i){var n=this;var o,r;if(!t){var s=this.oApi.createMessageObject({code:"6004",aParameters:[this.oApi.getTextNotHtmlEncoded("step")]});this.oApi.putMessage(s)}this.metadata=t;this.oFormatter=new sap.apf.ui.utils.formatter({getEventCallback:this.oApi.getEventCallback.bind(this.oApi),getTextNotHtmlEncoded:this.oApi.getTextNotHtmlEncoded,getExits:this.oApi.getExits()},this.metadata,this.aDataResponse);if(this.oParameter.requiredFilters.length>0){o=this.oParameter.requiredFilters[0];r=t.getPropertyMetadata(o).text}if(!this.oParameter.isAlternateRepresentation){if(o){this.aValidatedFilter=[];if(i&&i.length>0){i.forEach(function(e){n.aValidatedFilter.push(e[o]);n.oPaginationDisplayOptionHandler.createDisplayValueLookupForPaginatedFilter(e[o],e[r])});n.aFiltersInTable=n.aValidatedFilter}else{n.aFiltersInTable=[]}}var l=this.getRequestOptions();var p=l.paging&&l.paging.skip;this.nDataResponseCount=a;if(p===undefined||p===0){this.aDataResponse=e}else{e.map(function(e){n.aDataResponse.push(e)})}if(!this.oParameter.top&&this.titleControl){var d=this.aDataResponse&&this.aDataResponse.length||0;var u=this.oApi.getTextNotHtmlEncoded("stepTitleWithNumberOfRecords",[this.title,d,a]);this.titleControl.setText(u)}}else{this.aDataResponse=e}if(r){this.aDataResponse.forEach(function(e){n.oPaginationDisplayOptionHandler.createDisplayValueLookupForPaginatedFilter(e[o],e[r])})}};z.prototype.getFilter=function(){this.filter=this.oRepresentationFilterHandler.createFilterFromSelectedValues(this.aFiltersInTable);return this.filter};z.prototype.getSelections=function(){var e=this,t=[],a;var i=e.parameter.requiredFilters[0];V(e,i);e.aFiltersInTable.forEach(function(n){a=e.oPaginationDisplayOptionHandler.getDisplayNameForPaginatedFilter(n,e.parameter.requiredFilterOptions,i,e.oFormatter,e.metadata);t.push({id:n,text:a})});return t};z.prototype.markSelectionInTable=function(e){var t=this.oParameter.requiredFilters?this.oParameter.requiredFilters[0]:undefined;if(t){var a=this._getSelectedIndicesInTable(t);if(this.oParameter.isAlternateRepresentation){var i=[];var n=this.tableControl.getBinding().aIndices;a.forEach(function(e){i.push(n.indexOf(e))});a=i}this.tableControl.clearSelection();if(a.length>0){N(this.tableControl,a)}}};z.prototype.getRequestOptions=function(e,t){this.bIsAlternateRepresentation=t;if(e){this.oPaginationHandler.resetPaginationOption()}var a={paging:{},orderby:[]};if(e){this.omitTopAndSkipOptionsForNextPathUpdate=false}if(this.omitTopAndSkipOptionsForNextPathUpdate){a.paging={inlineCount:true}}else if(!this.bIsAlternateRepresentation){a.paging=this.oPaginationHandler.getPagingOption(this.oParameter.top)}if(this.orderby){a.orderby=this.orderby}if(this.oViewSettingDialog){var i=_(this.oViewSettingDialog);if(i){var n={property:_(this.oViewSettingDialog),ascending:!this.oViewSettingDialog.getSortDescending()};this.orderby=[n];a.orderby=[n]}}return a};z.prototype.resetPaginationForTable=function(){this.omitTopAndSkipOptionsForNextPathUpdate=false;this.oPaginationHandler.resetPaginationOption()};z.prototype.getMainContent=function(e,t,a){var i=this;var n=this.getData();this.title=e;var o=this.oParameter.dimensions.concat(this.oParameter.measures).length?this.oParameter.dimensions.concat(this.oParameter.measures):this.oParameter.properties;var r=j(this);var s;if(!e){s=this.oApi.createMessageObject({code:"6002",aParameters:["title",this.oApi.getTextNotHtmlEncoded("step")]});this.oApi.putMessage(s)}if(o.length===0){s=this.oApi.createMessageObject({code:"6002",aParameters:["dimensions",e]});this.oApi.putMessage(s)}if(!n||n.length===0){s=this.oApi.createMessageObject({code:"6000",aParameters:[e]});this.oApi.putMessage(s)}var l;if(this.oParameter.isAlternateRepresentation){l=q(this,e,n.length,true,t)}else{l=q(this,e,n.length,false,t)}this.tableControl=W(r,l,this,t);this.tableControl.addAriaLabelledBy(l.getItems()[0]);this.tableControl.addEventDelegate({onAfterRendering:function(){if(i.oParameter){i.markSelectionInTable(true);if(i.loadAllButton){i.loadAllButton.fireEvent("setFocusOnLoadAllButtonEvent")}if(!i.oParameter.top&&!i.oParameter.isAlternateRepresentation&&i.nDataResponseCount>100){i.oPaginationHandler.attachPaginationOnTable(i)}}}});this.tableControl.attachRowSelectionChange(this._handleSelectionEvent.bind(this));this.oLoadMoreLink=new T({text:this.oApi.getTextNotHtmlEncoded("moreIcon"),visible:false});var p=new x({fitContainer:true,items:[this.tableControl,this.oLoadMoreLink]}).addStyleClass("tableRepresentation");if(a){p.setHeight(a+"px")}return p};z.prototype.getThumbnailContent=function(){var e;var t=this.getData();var a=this.oParameter.isAlternateRepresentation?"sap-icon://table-view":"sap-icon://table-chart";if(t!==undefined&&t.length!==0){var i=new c({src:a,size:"70px"}).addStyleClass("thumbnailTableImage");e=i}else{var n=new v({text:this.oApi.getTextNotHtmlEncoded("noDataText")}).addStyleClass("noDataText");e=new m({content:n})}return e};z.prototype.removeAllSelection=function(){U(this);this.tableControl.clearSelection();this.oApi.selectionChanged()};z.prototype.getPrintContent=function(e){var t=this.tableControl.clone();t.getColumns().forEach(function(e){e.setWidth("auto");e.getTemplate().setWrapping(true)});var a=this.tableControl.getSelectedIndices();t.setVisibleRowCountMode(H.Fixed);t.setVisibleRowCount(t.getModel().getData().tableData.length);t.onAfterRendering=function(){a.forEach(function(e){t.getRows()[e].getDomRef().classList.add("sapTableSelectionForPrint")})};var i={oRepresentation:t};return i};z.prototype.getViewSettingDialog=function(){if(!this.oViewSettingDialog){var e={oTableInstance:this};var t=new sap.ui.view({type:f.JS,viewName:"sap.apf.ui.reuse.view.viewSetting",viewData:e});this.oViewSettingDialog=t.getContent()[0];this.oViewSettingDialog.addStyleClass("sapUiSizeCompact")}return this.oViewSettingDialog};z.prototype.loadAll=function(){this.omitTopAndSkipOptionsForNextPathUpdate=true;if(this.loadAllButton){B(this)}this.oApi.selectionChanged()};z.prototype.exportExcel=function(e){var t=this;function a(){var e=j(t);var a=[];var i,n;for(i=0;i<e.value.length;i++){n=sap.apf.ui.utils.determineColumnSettingsForSpreadSheetExport(e.value[i],t.metadata);n.property=e.value[i];n.label=e.name[i];a.push(n)}return a}var i=this.getData();var n=a();var o={workbook:{columns:n},dataSource:i,fileName:e+".xlsx"};var r=new sap.ui.export.Spreadsheet(o);r.build()};z.prototype.onChartSwitch=function(){this.resetPaginationForTable()};z.prototype.destroy=function(){if(this.orderby){this.orderby=null}if(this.oParameter){this.oParameter=null}if(this.oViewSettingDialog){this.oViewSettingDialog.destroy()}if(this.aDataResponse){this.aDataResponse=null}if(this.aValidatedFilter){this.aValidatedFilter=[]}if(this.aFiltersInTable){this.aFiltersInTable=[]}sap.apf.ui.representations.BaseUI5ChartRepresentation.prototype.destroy.call(this)};return z},true);
//# sourceMappingURL=table.js.map