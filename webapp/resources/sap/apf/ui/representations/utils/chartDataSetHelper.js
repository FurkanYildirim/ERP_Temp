/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP SE. All rights reserved
 */
sap.ui.define(["sap/apf/ui/representations/utils/displayOptionHandler","sap/apf/utils/exportToGlobal","sap/apf/utils/utils","sap/ui/model/json/JSONModel","sap/ui/thirdparty/jquery","sap/viz/ui5/data/FlattenedDataset"],function(t,e,a,i,jQuery,n){"use strict";function r(t,e){this.oFormatter=t;this.aDataResponseWithDisplayValue=[];this.oDisplayOptionHandler=new sap.apf.ui.representations.utils.DisplayOptionHandler;this.oTimeAxisDateConverter=e;this.oChartDataSet={}}r.getFieldNameForOriginalContentOfProperty=function(t){return"original_"+t};function o(t,e){var a=t.map(function(t){return t.fieldName});return a.indexOf(e)===-1?true:false}function s(t){var e=t.dimensions.concat(t.measures),a;e.forEach(function(t){for(a in t){if(a!=="name"&&a!=="value"&&a!=="dataType"&&a!=="displayValue"&&a!=="identity"){delete t[a]}}})}function p(t,e,i,n){var r=jQuery.extend(true,[],n);var o,s={};t.oTimeAxisDateConverter.createPropertyInfo(e.dimensions);var p=e.dimensions.concat(e.requiredFilters);p.forEach(function(n,p){var l=e.requiredFilterOptions?e.requiredFilterOptions.labelDisplayOption:undefined;var u=n.labelDisplayOption?n.labelDisplayOption:l;var d=n.fieldName?n.fieldName:n;if(u===undefined||u===sap.apf.core.constants.representationMetadata.labelDisplayOptions.TEXT){return r}r.forEach(function(e,p){e[d]=e[d]===null||e[d]===undefined?e[d]:e[d].toString();if(u===sap.apf.core.constants.representationMetadata.labelDisplayOptions.KEY){o="formatted_"+d;if(!r[p][o]){r[p][o]=t.oFormatter.getFormattedValue(d,r[p][d])}}if(u===sap.apf.core.constants.representationMetadata.labelDisplayOptions.KEY_AND_TEXT){var l=i.getPropertyMetadata(d).text;o=d+"_"+l;var f={text:r[p][l],key:r[p][d]};r[p][o]=t.oFormatter.getFormattedValueForTextProperty(d,f)}if(t.oTimeAxisDateConverter.bIsConversionToDateRequired(n.fieldName,i)){var h=e[d];var m=sap.apf.ui.representations.utils.ChartDataSetHelper.getFieldNameForOriginalContentOfProperty(d);if(e[m]){s[h]=e[m]}else{var c=a.convertFiscalYearMonthDayToDateString(h)+"";s[c]=h;e[d]=c;e[m]=h}}})});t.oTimeAxisDateConverter.setConvertedDateLookUp(s);return r}r.prototype.constructor=r;r.prototype.createFlattenDataSet=function(t,e,a,i){var n=this;this.aDataResponseWithDisplayValue=p(this,t,e,a);t.dimensions.forEach(function(t,a){t.name=n.oDisplayOptionHandler.getDisplayNameForDimension(t,e,i);t.value="{"+t.fieldName+"}";t.identity=t.fieldName;t.displayValue="{"+n.oDisplayOptionHandler.getColumnNameBasedOnDisplayOption(t.fieldName,t.labelDisplayOption,e)+"}"});t.measures.forEach(function(t){t.name=n.oDisplayOptionHandler.getDisplayNameForMeasure(t,e,a,i);t.value="{"+t.fieldName+"}";t.identity=t.fieldName});var r={dimensions:t.dimensions,measures:t.measures};var l=t.requiredFilters[0];this.oChartDataSet=jQuery.extend(true,{},r);this.oChartDataSet.context=[];s(this.oChartDataSet);if(l&&o(t.dimensions,l)){this.oChartDataSet.context.push(l);this.oChartDataSet.dimensions.push({name:l,value:"{"+l+"}",identity:l})}this.oChartDataSet.data={path:"/data"}};r.prototype.addUnusedDimensionsToChartContext=function(t,e){if(e.length===0){return}var a=[];this.oChartDataSet.dimensions.forEach(function(e){var i=e.identity;a.push(i);var n=t.getPropertyMetadata(i).text;if(n){a.push(n)}});this.oChartDataSet.measures.forEach(function(t){a.push(t.identity)});var i=Object.keys(e[0]);i.forEach(function(e){if(a.indexOf(e)>=0||e==="__metadata"){return}var i=t.getPropertyMetadata(e);if(i&&i["aggregation-role"]==="measure"){return}this.addPropertyToContext(e,i)}.bind(this))};r.prototype.addPropertyToContext=function(t,e){var a=e&&e.label?e.label:t;this.oChartDataSet.context.push(t);this.oChartDataSet.dimensions.push({name:a,value:"{"+t+"}",identity:t})};r.prototype.getFlattenDataSet=function(){return new n(this.oChartDataSet)};r.prototype.getModel=function(){var t=new i({data:this.aDataResponseWithDisplayValue});return t};e("sap.apf.ui.representations.utils.ChartDataSetHelper",r);return r});
//# sourceMappingURL=chartDataSetHelper.js.map