/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2018 SAP SE. All rights reserved
 */
sap.ui.define(["sap/apf/ui/utils/helper","sap/apf/core/constants","sap/ui/core/mvc/Controller","sap/apf/ui/utils/constants","sap/suite/ui/commons/ChartContainerContent","sap/suite/ui/commons/ChartContainerToolbarPlaceholder","sap/ui/core/Icon","sap/ui/core/CustomData","sap/ui/core/mvc/XMLView","sap/m/Link","sap/m/ToggleButton","sap/m/Label","sap/m/Button","sap/m/ToolbarSpacer","sap/m/List","sap/m/ListMode","sap/m/ListSeparators","sap/m/StandardListItem","sap/m/Popover","sap/m/PlacementType","sap/apf/utils/trace"],function(e,t,n,r,a,i,o,s,l,d,p,c,u,g,f,v,h,C,y,m,S){"use strict";var I,T,b,w=false;function R(){var e=b.getSelectedRepresentation();return e.type===r.representationTypes.TABLE_REPRESENTATION}function A(){var e=b.getSelectedRepresentation();return e.type===r.representationTypes.TREE_TABLE_REPRESENTATION}function P(){if(b.getSelectedRepresentation().bIsAlternateView===undefined||b.getSelectedRepresentation().bIsAlternateView===false){return false}return true}function x(e){var t=e.getCurrentRepresentation();var n=t.getParameter().requiredFilters;if(n===undefined||n.length===0){return undefined}return n[0]}function D(e){S.logCall("StepContainer._setChartContainerContent");var t=e.byId("idChartContainer");var n=e.getCurrentRepresentation();var r=b.longTitle&&!I.isInitialTextKey(b.longTitle.key)?b.longTitle:b.title;var i=I.getTextNotHtmlEncoded(r);S.log("_setChartContainerContent"," title=",i);var o=n.getMainContent(i);var s={onBeforeRendering:function(){E(e,o)}};o.addEventDelegate(s);t.removeAllContent();var l=new a({content:o});t.addContent(l);S.logReturn("_setChartContainerContent")}function E(e,t){var n=e.byId("idChartContainer");var r="0";var a=jQuery(window).width();var i=n.getId();if(jQuery("#"+i).length!==0){r=jQuery("#"+i+" > div:first-child > div:nth-child(2)").offset().top;a=jQuery("#"+i+" > div:first-child > div:nth-child(2)").width()}var o=jQuery(window).height()-r-jQuery(".applicationFooter").height();var s=a;t.setHeight(o+"px");t.setWidth(s+"px")}function V(e,t){var n=e.byId("idSelectedText");var r=e.getCurrentRepresentation();var a=z(e);var i=r.getSelectionFilterLabel();var o=i+" ("+a+") ";var s=e.byId("idSelPropertyAndCount");if(!s){s=new d({id:e.createId("idSelPropertyAndCount"),press:e.handlePressSelectedPropertyCountLink.bind(e)});s.addAriaLabelledBy(n.getId())}else{if(s&&r.chart!==undefined&&(r.chart!==null&&r.chart.setFocusOnSelectLink)){r.chart.detachEvent("setFocusOnSelectedLinkEvent",r.chart.setFocusOnSelectLink)}}if(s&&r.chart!==undefined&&r.chart!==null){r.chart.setFocusOnSelectLink=function(){s.focus()}}s.setVisible(true);s.setText(o);t.addContent(s);t.onAfterRendering=function(){if(s&&r.chart!==undefined&&r.chart!==null){r.chart.fireEvent("setFocusOnSelectedLinkEvent");r.chart.detachEvent("setFocusOnSelectedLinkEvent",r.chart.setFocusOnSelectLink)}}}function N(e){var t=e.byId("idChartContainer");t.removeAllCustomIcons();L(e);B(e);F(e)}function L(t){var n=t.byId("idChartContainer");var r=b.getSelectedRepresentationInfo();var a;if(r.parameter&&r.parameter.orderby){var i=r.parameter.orderby;new e(I).getRepresentationSortInfo(r).done(function(e){for(var s=0;s<e.length;s++){a=i[0].property}var l=i[0].ascending==true?"Sort Order: Ascending":"Sort Order: Descending";var d=I.getTextNotHtmlEncoded(r.label)+"\n"+(a!==undefined?I.getTextNotHtmlEncoded("sortBy")+": "+a:"")+"\n"+l;var p=new o({src:r.picture,tooltip:d,press:function(e){t.handlePressChartIcon(e)}});n.addCustomIcon(p)})}else{var s=I.getTextNotHtmlEncoded(r.label)+"\n"+(a!==undefined?I.getTextNotHtmlEncoded("sortBy")+": "+a:"");var l=new o({src:r.picture,tooltip:s,press:function(e){t.handlePressChartIcon(e)}});n.addCustomIcon(l)}}function B(e){var t=e.byId("idChartContainer");var n=I.getTextNotHtmlEncoded("listView");var r=new o({src:"sap-icon://table-view",tooltip:n,press:e.handlePressAlternateRepIcon.bind(e)});var a=e.getCurrentRepresentation();var i=a.type;if(R()||A()||i=="TableRepresentation"){t.removeCustomIcon(r);return}t.addCustomIcon(r)}function F(e){if(e.getCurrentRepresentation().topN!==undefined||!P()&&!R()||A()){return}var t=e.byId("idChartContainer");var n=I.getTextNotHtmlEncoded("view-Settings-Button");var r=new o({src:"sap-icon://drop-down-list",tooltip:n,press:function(){e.getView().addDependent(e.getCurrentRepresentation().getViewSettingDialog());e.getCurrentRepresentation().getViewSettingDialog().open()}});t.addCustomIcon(r)}function H(e,t){var n=e.byId("idSelectedText");if(!n){n=new c({id:e.createId("idSelectedText"),text:I.getTextNotHtmlEncoded("selectedValue")})}n.setVisible(true);t.addContent(n)}function O(e,t){var n=e.byId("idReset");if(!n){n=new u({text:I.getTextNotHtmlEncoded("reset"),id:e.createId("idReset"),type:"Transparent",press:e.handlePressResetButton.bind(e)}).addStyleClass("chartContainerResetStyle")}n.setVisible(true);t.addContent(n)}function j(e,t){var n=z(e);if(n>0&&x(e)!==undefined){H(e,t);V(e,t);O(e,t)}}function k(e,t){var n=e.byId("idPathFilterDisplayButton");if(!n){n=new u({text:I.getTextNotHtmlEncoded("pathFilterDisplayButton"),id:e.createId("idPathFilterDisplayButton"),icon:"sap-icon://message-information",type:"Transparent",press:function(){if(e.byId("idStepLayout").getBusy()===false){I.getPathFilterInformation().then(function(t){var n=new l({viewName:"sap.apf.ui.reuse.view.pathFilterDisplay",viewData:{pathFilterInformation:t,oCoreApi:I,oUiApi:T},id:e.createId("pathFilterDisplay")});n.setParent(e.getView(),"content",true);n.getContent()[0].open()})}}})}t.addContent(n)}function M(e,t){var n=e.getCurrentRepresentation();var r=n.type;var a=undefined;var i=false;if(r!=="TableRepresentation"&&r!=="listView"&&r!=="TreeTableRepresentation"){if(n.chart!==undefined){if(Object.getOwnPropertyNames(n.chart).length!==0){a=n.chart.vizSelection();i=n.chart.getVizProperties().plotArea.dataLabel.visible}}if(n!==undefined){if(n.aDataResponse!==0){var o=e.byId("idToggleDisplayButton");if(!o){o=new p({id:e.createId("idToggleDisplayButton"),pressed:false,text:I.getTextNotHtmlEncoded("values"),tooltip:I.getTextNotHtmlEncoded("displayValues"),press:e.handleToggleDisplay.bind(e)})}else{n=e.getCurrentRepresentation();o.setPressed(i)}if(a!==undefined){e.getCurrentRepresentation().chart.vizSelection(a,{clearSelection:false})}t.addContent(o)}}}}function Q(e){var t=e.byId("idChartContainer");var n=t.getToolbar();n.removeAllContent();var r=new c({text:I.getTextNotHtmlEncoded("currentStep")});n.addContent(r);var a=new g;n.addContent(a);M(e,n);j(e,n);k(e,n);n.addContent(new i);t.setToolbar(n)}function _(e,t,n){S.logCall("StepContainer._drawChartContainer",", isActiveStep=",n,", oActiveStep=",t);if(t!==undefined){D(e);N(e);Q(e)}S.logReturn("_drawChartContainer")}function z(e){var t=e.getCurrentRepresentation();var n=t.getSelections().length;return n}function U(t,n){var r=new f({mode:v.SingleSelectMaster,showSeparators:h.None,includeItemInSelection:true,selectionChange:t.handleSelectionChartSwitchIcon.bind(t)});var a;var i;for(var o=0;o<b.getRepresentationInfo().length;o++){i=b.getRepresentationInfo()[o];a=undefined;if(i.parameter&&i.parameter.orderby){new e(I).getRepresentationSortInfo(i).done(function(e){var t=[];for(var n=0;n<e.length;n++){e[n].done(function(e){t.push(e)})}a=t.join(", ");var o=a!==undefined?I.getTextNotHtmlEncoded("sortBy")+": "+a:"";var l=new C({description:o,icon:i.picture,title:I.getTextNotHtmlEncoded(i.label),customData:[new s({key:"data",value:{oRepresentationType:i,icon:i.picture}})]});r.addItem(l)})}else{var l=a!==undefined?I.getTextNotHtmlEncoded("sortBy")+": "+a:"";var d=new C({description:l,icon:i.picture,title:I.getTextNotHtmlEncoded(i.label),customData:[new s({key:"data",value:{oRepresentationType:i,icon:i.picture}})]});r.addItem(d)}}if(!t.byId("idAllChartPopover")){var p=new y({id:t.createId("idAllChartPopover"),placement:m.Bottom,showHeader:false,content:[r],afterClose:function(){p.destroy()}})}t.byId("idAllChartPopover").openBy(n)}function X(e,t){e.byId("idReset").setVisible(t);e.byId("idSelPropertyAndCount").setVisible(t);e.byId("idSelectedText").setVisible(t)}return n.extend("sap.apf.ui.reuse.controller.stepContainer",{onInit:function(){var e=this;I=e.getView().getViewData().oCoreApi;T=e.getView().getViewData().uiApi;b=I.getActiveStep();this.initialText=new c({id:this.createId("idInitialText")}).addStyleClass("initialText");this.initialText.setText(I.getTextNotHtmlEncoded("initialText"))},onAfterRendering:function(){jQuery(T.getStepContainer().getDomRef()).hide();if(jQuery("#"+this.initialText.getId()).length===0&&I.getSteps().length===0){jQuery("#"+T.getStepContainer().getId()).parent().append(sap.ui.getCore().getRenderManager().getHTML(this.initialText))}else if(I.getSteps().length>0){jQuery(T.getStepContainer().getDomRef()).show()}if(T.getAnalysisPath().getController().isOpenPath){jQuery(".initialText").remove()}},getCurrentRepresentation:function(){var e=b.getSelectedRepresentation();if(P()){e=b.getSelectedRepresentation().toggleInstance}return e},handlePressSelectedPropertyCountLink:function(){var e=this;e.oCoreApi=I;var t=new sap.ui.jsfragment("idSelectionDisplayFragment","sap.apf.ui.reuse.fragment.selectionDisplay",e);t.open()},handleToggleDisplay:function(){var e=this;e.oCoreApi=I;var t=e.getCurrentRepresentation();var n=e.byId("idToggleDisplayButton");if(t.measures!==undefined){var r=t.getFormatStringForMeasure(t.measures[0]);if(t.type==="PieChart"){t.chart.setVizProperties({plotArea:{dataLabel:{visible:n.getPressed(),type:"percentage"}}})}else{t.chart.setVizProperties({plotArea:{dataLabel:{visible:n.getPressed(),formatString:r}}})}return t.chart.getVizProperties().plotArea.dataLabel.visible}var a=t.chartPlotArea.plotArea.dataLabel.visible;a=n.getPressed();return a},handlePressResetButton:function(){var e=this;if(P()){e.getCurrentRepresentation().removeAllSelection()}e.getCurrentRepresentation().removeAllSelection();X(e,false)},createToggleRepresentationInstance:function(e,n){var r={};function a(n){var r=n.dimensions;var a=e.getMetaData();n.isAlternateRepresentation=true;if(a===undefined){return n}var i,o;for(i=0;i<r.length;i++){var s=a.getPropertyMetadata(r[i].fieldName).hasOwnProperty("text");if(s&&r[i].labelDisplayOption===t.representationMetadata.labelDisplayOptions.KEY_AND_TEXT){o={};o.fieldName=a.getPropertyMetadata(r[i].fieldName).text;n.dimensions.splice(i+1,0,o)}else if(s&&r[i].labelDisplayOption===t.representationMetadata.labelDisplayOptions.TEXT){o={};o.fieldName=a.getPropertyMetadata(r[i].fieldName).text;n.dimensions.splice(i,1,o)}}return n}var i=jQuery.extend(true,{},e.getParameter());delete i.alternateRepresentationTypeId;delete i.alternateRepresentationType;i=a(i);if(n){i.orderby=n}r=I.createRepresentation(e.getParameter().alternateRepresentationType.constructor,i);var o=e.getData(),s=e.getMetaData();if(o!==undefined&&s!==undefined){r.setData(o,s)}return r},handlePressAlternateRepIcon:function(){var e=this;var t=b.getSelectedRepresentation();t.bIsAlternateView=true;if(P()){t.toggleInstance=e.createToggleRepresentationInstance(t)}w=true;e.getView().getViewData().uiApi.selectionChanged(true)},handlePressChartIcon:function(e){var t=this;var n=b.getSelectedRepresentation();var r=I.getSteps().indexOf(b);var a=null;if(b.getRepresentationInfo().length>1){a=e.getParameter("controlReference");U(t,a)}else{n.bIsAlternateView=false;w=true;t.getView().getViewData().uiApi.selectionChanged(true);n.createDataset();t.drawStepContent();T.getAnalysisPath().getController().updateCustomListView(b,r,false)}},handleSelectionChartSwitchIcon:function(e){this.byId("idAllChartPopover").close();var t=b.getSelectedRepresentation();var n=e.getParameter("listItem").getCustomData()[0].getValue();var r=b.getSelectedRepresentationInfo().representationId;var a=n.oRepresentationType.representationId;if(r===a&&t.bIsAlternateView===false){return}w=true;t.bIsAlternateView=false;b.setSelectedRepresentation(n.oRepresentationType.representationId);T.getAnalysisPath().getController().refresh(n.nActiveStepIndex);I.updatePath(T.getAnalysisPath().getController().callBackForUpdatePath.bind(T.getAnalysisPath().getController()));t.createDataset()},drawStepContent:function(e,t){S.logCall("StepContainer.drawStepContent"," bStepUpdated="+e);var n=this;var r=false;var a=b;b=I.getActiveStep();if(b===undefined){S.logReturn("drawStepContent",", the active step === undefined");return}if(a!==b){r=true}if(e||w||r){_(n,b,t)}else{Q(n)}w=false;n.initialText.destroy();n.byId("idStepLayout").setBusy(false);S.logReturn("drawStepContent",", bIsActiveStepChanged",r)}})},true);
//# sourceMappingURL=stepContainer.controller.js.map