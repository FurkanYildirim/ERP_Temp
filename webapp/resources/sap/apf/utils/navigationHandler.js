/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
sap.ui.define(["sap/apf/core/utils/filterSimplify","sap/apf/utils/utils","sap/apf/utils/executeFilterMapping","sap/base/util/uid","sap/ui/core/routing/HashChanger","sap/ui/thirdparty/jquery"],function(e,t,i,a,n,jQuery){"use strict";var r=function(r){var s;var o;var c;var p=r.instances.messageHandler;var u=this;var l=r.constructors&&r.constructors.FilterReduction||e.FilterReduction;var f;var v=false;this.getNavigationTargets=function(){var e,i;var a=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("CrossApplicationNavigation");if(!a){if(!v){i=p.createMessageObject({code:5074});p.putMessage(i);v=true}o={global:[],stepSpecific:[]};return t.createPromise(o)}e=jQuery.Deferred();r.functions.getCumulativeFilterUpToActiveStep().done(function(t){if(o&&t.isEqual(c)){e.resolve(h(o));return e.promise()}c=t;if(!s){g()}o=jQuery.extend(true,[],s);o.forEach(function(e){e.text=""});n(t).done(function(t){o=t;e.resolve(h(o))})});return e.promise();function n(e){var t=jQuery.Deferred();var i=[];var n=[];var s;o.forEach(function(t){var o;if(t.useDynamicParameters){s=s||S(e);t.parameters=A(t.parameters,s)}o=jQuery.Deferred();n.push(o);a.getLinks({semanticObject:t.semanticObject,action:t.action,params:m(t.parameters),ignoreFormFactor:false,ui5Component:r.instances.component}).then(function(e){e.forEach(function(e){var a=e.intent.split("-");var n=a[1].split("?");n=n[0].split("~");if(e.text!==""&&n[0]===t.action){t.text=e.text;i.push(t)}});o.resolve()},function(){o.resolve()})});jQuery.when.apply(jQuery,n).done(function(){t.resolve(i)});return t.promise()}};this.navigateToApp=function(e){if(!s){g()}var t=d(e);if(!t){return}var a=n&&n.getInstance();r.functions.getCumulativeFilterUpToActiveStep().done(function(e){if(r.functions.isFilterReductionActive&&r.functions.isFilterReductionActive()){f=f||new l;var n=f.reduceFilter(p,e);if(n===null){p.putMessage(p.createMessageObject({code:5235}))}else{e=n}}if(!t.filterMapping||!t.filterMapping.requestForMappedFilter){o(null,null)}else{var s=r.functions.createRequest(t.filterMapping.requestForMappedFilter);i(e,s,t.filterMapping.target,o,p)}function o(i,n){var s;if(n){return}if(i){e=e.addAnd(i)}var o=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("CrossApplicationNavigation");if(o){r.instances.serializationMediator.serialize(true).done(function(i){u.generateSelectionVariant(e).done(function(n){var c;var p={};if(t.useDynamicParameters){c=S(e)}p.sapApfState=i;p.sapApfCumulativeFilter=e.mapToSapUI5FilterExpression();p.selectionVariant=n;s=o.createEmptyAppState(r.instances.component);s.setData(p);s.save();if(a){a.replaceHash("sap-iapp-state="+s.getKey())}var u=t.parameters;if(t.useDynamicParameters){u=A(u,c)}o.toExternal({target:{semanticObject:t.semanticObject,action:t.action},appStateKey:s.getKey(),params:m(u)},r.instances.component)})})}}})};this.checkMode=function(){var e=jQuery.Deferred();var t=n&&n.getInstance&&n.getInstance();var i=/(?:sap-iapp-state=)([^&=]+)/;var a,s,o,c;if(t){o=i.exec(t.getHash());if(o){a=o[1]}}s=r.functions.getXappStateId();if(a){sap.ushell.Container.getService("CrossApplicationNavigation").getAppState(r.instances.component,a).done(function(t){c=t.getData();if(c.sapApfState){r.instances.serializationMediator.deserialize(c.sapApfState).done(function(){e.resolve({navigationMode:"backward"})})}})}else if(s){sap.ushell.Container.getService("CrossApplicationNavigation").getAppState(r.instances.component,s).done(function(t){c=t.getData();if(c&&c.sapApfCumulativeFilter){e.resolve({navigationMode:"forward",sapApfCumulativeFilter:c.sapApfCumulativeFilter})}else{e.resolve({navigationMode:"forward"})}})}else{e.resolve({navigationMode:"forward"})}if(t){t.replaceHash("")}return e.promise()};this.generateSelectionVariant=function(e){var t=jQuery.Deferred();if(!r.functions.isFilterReductionActive||!r.functions.isFilterReductionActive()){f=f||new l;e=f.reduceFilter(p,e)}if(!f||!f.isContradicted()){var i=e.mapToSelectOptions(r.functions.getAllParameterEntitySetKeyProperties);i.done(function(e){e.SelectionVariantID=a();t.resolve(e)})}else{var n={};n={SelectionVariantID:a(),Text:"Filter could not be converted to a selectionVariant"};t.resolve(n)}return t.promise()};function g(){s=r.functions.getNavigationTargets()}function d(e){for(var t=0,i=s.length;t<i;t++){if(s[t].id===e){return s[t]}}}function m(e){var t;if(e&&e.length>0){t={};e.forEach(function(e){t[e.key]=e.value})}return t}function h(e){var t=jQuery.extend(true,[],e);var i={global:[],stepSpecific:[]};t.forEach(function(e){if(e.isStepSpecific&&a(e.id)){delete e.isStepSpecific;i.stepSpecific.push(e)}else if(!e.isStepSpecific){delete e.isStepSpecific;i.global.push(e)}});return i;function a(e){var t=false;var i;var a=r.functions.getActiveStep();if(a&&a.getAssignedNavigationTargets){i=a.getAssignedNavigationTargets();if(i&&Array.isArray(i)){i.forEach(function(i){if(e===i.id){t=true}})}}return t}}function S(e){f=f||new l;var t=f.reduceFilter(p,e)||e;return t.getSingleValueTerms()}function A(e,t){t.forEach(function(t){e=e||[];e.push({key:t.property,value:t.value})});return e}};sap.apf.utils.NavigationHandler=r;return r},true);
//# sourceMappingURL=navigationHandler.js.map