/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP SE. All rights reserved
 */
sap.ui.define(["sap/apf/utils/exportToGlobal","sap/apf/utils/utils","sap/ui/thirdparty/jquery"],function(e,t,jQuery){"use strict";function r(e,r,n,i){var a=this;var o;var s;var f=r.instances.configurationHandler;var l=r.instances.persistenceProxy;var c=r.instances.messageHandler;var u=r.instances.metadataFactory;var g=true;var v,d,m,h,p,y;var E;var C=new r.constructors.ConfigurationObjects(r);var S=new r.constructors.ConfigurationFactory({instances:{messageHandler:c},constructors:{RegistryProbe:r.constructors.RegistryProbe}});if(!i){v=new r.constructors.ElementContainer("Step",r.constructors.Step,r);d=new r.constructors.ElementContainer("Category",undefined,r);m=new r.constructors.ElementContainer("FacetFilter",r.constructors.FacetFilter,r);h=new r.constructors.ElementContainer("NavigationTarget",r.constructors.NavigationTarget,r);p=new r.constructors.ElementContainer("CategoryStepAssignment",r.constructors.ElementContainer,r);y=[];o={smartFilterBar:true}}else{v=i.stepContainer;d=i.categoryContainer;E=i.smartFilterBar;m=i.facetFilterContainer;h=i.navigationTargetContainer;p=i.categoryStepAssignmentContainer;y=i.serviceList;s=i.applicationTitle;o=i.filterOption}this.registerServiceAsPromise=function(e){var t=jQuery.Deferred();var r;if(y.indexOf(e)===-1){r=u.getMetadata(e);r.done(function(){if(y.indexOf(e)===-1){y.push(e)}t.resolve(true)});r.fail(function(){t.resolve(false)})}else{t.resolve(true)}return t.promise()};this.getAllServices=function(){return y};this.getAllEntitySetsOfServiceAsPromise=function(e){return u.getEntitySets(e)};this.getAllHierarchicalEntitySetsOfServiceAsPromise=function(e){var t=jQuery.Deferred();u.getMetadata(e).done(function(e){if(e){t.resolve(e.getHierarchicalEntitySets())}t.resolve([])}).fail(function(){t.resolve([])});return t.promise()};this.checkIfHierarchicalEntitySetIsAvailableAsPromise=function(e){var t=jQuery.Deferred();this.getAllHierarchicalEntitySetsOfServiceAsPromise(e).done(function(e){if(e.length>0){t.resolve(true)}else{t.resolve(false)}});return t};this.getHierarchicalPropertiesOfEntitySetAsPromise=function(e,t){var r=jQuery.Deferred();u.getMetadata(e).done(function(e){if(e){r.resolve(e.getHierarchicalPropertiesOfEntitySet(t))}else{r.resolve([])}}).fail(function(){r.resolve([])});return r};this.getHierarchyNodeIdAsPromise=function(e,t,r){var n;var i=jQuery.Deferred();u.getMetadata(e).done(function(e){if(e){n=e.getHierarchyAnnotationsForProperty(t,r);if(n&&n.hierarchyNodeFor){i.resolve(n.hierarchyNodeFor)}else{i.resolve(null)}}else{i.resolve(null)}}).fail(function(){i.resolve(null)});return i};this.getNonHierarchicalPropertiesOfEntitySet=function(e,t){var r;var n=jQuery.Deferred();u.getMetadata(e).then(function(e){r=e.getNonHierarchicalPropertiesOfEntitySet(t);n.resolve(r)},function(){n.resolve([])});return n};this.getAllEntitySetsExceptParameterEntitySets=function(e){return u.getAllEntitySetsExceptParameterEntitySets(e)};this.getAllEntitySetsOfServiceWithGivenPropertiesAsPromise=function(e,t){var r=[];var n=jQuery.Deferred();this.getAllEntitySetsOfServiceAsPromise(e).done(function(i){if(!t||t.length===0){n.resolve(i);return}u.getMetadata(e).done(function(e){i.forEach(function(n){var i=e.getFilterableProperties(n);var a=true;for(var o=0;o<t.length;o++){if(i.indexOf(t[o])<=-1){a=false;break}}if(a){r.push(n)}});n.resolve(r)})});return n.promise()};this.getAllPropertiesOfEntitySetAsPromise=function(e,t){var r=jQuery.Deferred();u.getMetadata(e).done(function(e){r.resolve(e.getAllPropertiesOfEntitySet(t))}).fail(function(){r.resolve([])});return r.promise()};this.getAllKnownPropertiesAsPromise=function(){var e=jQuery.Deferred();var r=[];var n=y.length;y.forEach(function(i){u.getMetadata(i).done(function(i){r=r.concat(i.getAllProperties());n--;if(n===0){r=t.eliminateDuplicatesInArray(c,r);e.resolve(r)}})});return e.promise()};this.getFilterablePropertiesAndParametersAsPromise=function(){var e=jQuery.Deferred();var r=[];var n=y.length;y.forEach(function(i){u.getMetadata(i).done(function(i){r=r.concat(i.getFilterablePropertiesAndParameters());if(--n===0){e.resolve(t.eliminateDuplicatesInArray(c,r))}})});if(n===0){e.resolve([])}return e.promise()};this.setApplicationTitle=function(e){g=false;s=e};this.getApplicationTitle=function(){return s};this.getConfigurationName=function(){return f.getConfiguration(e.id||e).AnalyticalConfigurationName};this.getCategoryStepAssignments=function(e){var t=[];if(!this.getCategory(e)){return false}var r=p.getElement(e);if(r){r.getElements().forEach(function(e){t.push(e.stepId)})}return t};this.addCategoryStepAssignment=function(e,t){if(!this.getCategory(e)||!this.getStep(t)){return false}var r=p.getElement(e);if(!r){p.createElementWithProposedId({},e);r=p.getElement(e)}if(!r.getElement(t)){r.createElementWithProposedId({stepId:t},t);return true}return false};this.removeCategoryStepAssignment=function(e,t){var r;if(!t){var n=this.getCategoryStepAssignments(e);r=p.removeElement(e);if(r){A(n)}return!!r}var i=p.getElement(e);if(!i){return false}r=i.removeElement(t);if(i.getElements().length===0){p.removeElement(e)}if(r){A([t])}return!!r};function A(e){if(!e){return}e.forEach(function(e){if(a.getCategoriesForStep(e).length===0){v.removeElement(e)}})}this.moveCategoryStepAssignmentBefore=function(e,t,r){var n=p.getElement(e);if(!n){return null}return n.moveBefore(t,r)};this.moveCategoryStepAssignmentToEnd=function(e,t){var r=p.getElement(e);if(!r){return null}return r.moveToEnd(t)};this.moveCategoryStepAssignmentUpOrDown=function(e,t,r){var n=p.getElement(e);if(!n){return null}return n.moveUpOrDown(t,r)};this.getCategory=d.getElement;this.setCategory=function(e,t){g=false;return d.setElement(e,t)};this.createCategoryWithId=function(e,t){g=false;return d.createElementWithProposedId(e,t).getId()};this.removeCategory=function(e){var t=a.getCategoryStepAssignments(e);if(t){t.forEach(function(e){var t=a.getCategoriesForStep(e);if(!t||t.length<2){v.removeElement(e)}})}d.removeElement(e)};this.getCategories=d.getElements;this.copyCategory=function(e){var t=d.copyElement(e);if(!t){return}a.getCategoryStepAssignments(e).forEach(function(e){F(e,t)});return t};this.moveCategoryBefore=function(e,t){return d.moveBefore(e,t)};this.moveCategoryToEnd=function(e){return d.moveToEnd(e)};this.moveCategoryUpOrDown=function(e,t){return d.moveUpOrDown(e,t)};this.serialize=function(){return C.serializeConfiguration(a)};this.isSaved=function(){return g};this.setIsUnsaved=function(){g=false};this.save=function(t){var r;function n(n,i,a){if(!a){g=true;f.replaceConfigurationId(e.id||e,n.AnalyticalConfiguration);f.updateConfigurationName(e.id||e,r);e=n.AnalyticalConfiguration}t(e,i,a)}function i(n,i){if(!i){g=true}f.updateConfigurationName(e.id||e,r);t(e.id||e,n,i)}r=f.getConfiguration(e.id||e).AnalyticalConfigurationName;var a={AnalyticalConfiguration:"",AnalyticalConfigurationName:r,Application:f.getApplicationId(),SerializedAnalyticalConfiguration:JSON.stringify(this.serialize()),CreatedByUser:"",CreationUTCDateTime:null,LastChangeUTCDateTime:null,LastChangedByUser:""};if(typeof e==="string"){if(e.indexOf("apf1972-")===0){l.create("configuration",a,n)}else{a.AnalyticalConfiguration=e;l.update("configuration",a,i,[{name:"AnalyticalConfiguration",value:e}])}}else{if(e.id.indexOf("apf1972-")===0){a.AnalyticalConfiguration="";a.CreationUTCDateTime=null;a.LastChangeUTCDateTime=null}else{a.AnalyticalConfiguration=e.id;a.CreationUTCDateTime=e.creationDate;a.LastChangeUTCDateTime=e.lastChangeDate}if(e.updateExisting){l.update("configuration",a,i,[{name:"AnalyticalConfiguration",value:e.id}])}else{l.create("configuration",a,n)}}};this.getFilterOption=function(){return Object.assign({},o)};this.setFilterOption=function(e){if(e.none===true){E=null;t.call(this);r()}if(e.smartFilterBar===true){t.call(this);n()}if(e.facetFilter===true){E=null;i()}function t(){this.getFacetFilters().forEach(function(e){this.removeFacetFilter(e.getId())}.bind(this))}function r(){delete o.smartFilterBar;delete o.facetFilter;o.none=true}function n(){o.smartFilterBar=true;delete o.facetFilter;delete o.none}function i(){delete o.smartFilterBar;o.facetFilter=true;delete o.none}};this.isDataLostByFilterOptionChange=function(){if(o.smartFilterBar===true){if(E&&(E.getService()||E.getEntitySet())){return true}}if(o.facetFilter===true){if(m.getElements().length>0){return true}}return false};this.getSmartFilterBar=function(){if(o.smartFilterBar===true){if(!E){E=new r.constructors.SmartFilterBar("SmartFilterBar-1")}return E}return null};this.createFacetFilterWithId=function(e){if(o.facetFilter===true){return m.createElementWithProposedId(undefined,e).getId()}return null};this.createFacetFilter=function(){if(o.facetFilter===true){return m.createElement().getId()}return null};this.removeFacetFilter=m.removeElement;this.getFacetFilter=m.getElement;this.getFacetFilters=m.getElements;this.copyFacetFilter=m.copyElement;this.moveFacetFilterBefore=function(e,t){return m.moveBefore(e,t)};this.moveFacetFilterToEnd=function(e){return m.moveToEnd(e)};this.moveFacetFilterUpOrDown=function(e,t){return m.moveUpOrDown(e,t)};this.createNavigationTargetWithId=function(e){return h.createElementWithProposedId(undefined,e).getId()};this.createNavigationTarget=function(){return h.createElement().getId()};this.removeNavigationTarget=function(e){var t=h.getElement(e);if(!t){return}h.removeElement(e);if(t.isStepSpecific()){var r=this.getStepsAssignedToNavigationTarget(e);var n,i;for(n=0;n<r.length;n++){i=this.getStep(r[n]);i.removeNavigationTarget(e)}}};this.getNavigationTarget=h.getElement;this.getNavigationTargets=h.getElements;this.copyNavigationTarget=function(e){var t=h.copyElement(e);var r=h.getElement(t);if(r.isStepSpecific()){var n=this.getStepsAssignedToNavigationTarget(e);var i,a;for(i=0;i<n.length;i++){a=this.getStep(n[i]);a.addNavigationTarget(t)}}return t};this.moveNavigationTargetBefore=function(e,t){return h.moveBefore(e,t)};this.moveNavigationTargetToEnd=function(e){return h.moveToEnd(e)};this.moveNavigationTargetUpOrDown=function(e,t){return h.moveUpOrDown(e,t)};this.createStepWithId=function(e){return v.createElementWithProposedId(undefined,e).getId()};this.createStep=function(e){if(!this.getCategory(e)){return}var t=v.createElement().getId();this.addCategoryStepAssignment(e,t);return t};this.createHierarchicalStepWithId=function(e){return v.createElementWithProposedId(undefined,e,r.constructors.HierarchicalStep).getId()};this.createHierarchicalStep=function(e){if(!this.getCategory(e)){return}var t=v.createElement(undefined,r.constructors.HierarchicalStep).getId();this.addCategoryStepAssignment(e,t);return t};this.getStep=v.getElement;this.getSteps=v.getElements;this.getStepsNotAssignedToCategory=function(e){var t=this.getCategoryStepAssignments(e);var r=[];a.getSteps().forEach(function(e){var n=e.getId();if(t.indexOf(n)===-1){r.push(n)}});return r};this.copyStep=function(e){var t=F(e);var r=this.getCategoriesForStep(e);if(!t){return false}if(r){r.forEach(function(e){a.addCategoryStepAssignment(e,t)})}return t};function F(e,t){if(t&&!a.getCategory(t)){return false}var r=v.copyElement(e);if(!r){return false}if(t){a.addCategoryStepAssignment(t,r)}return r}this.getCategoriesForStep=function e(t){var r=[];var n=a.getCategories();if(n){n.forEach(function(e){var n=e.getId();var i=a.getCategoryStepAssignments(n);if(i&&i.indexOf(t)>-1){r.push(n)}})}return r};this.getAssignableStepsForNavigationTarget=function(e){var t=[];a.getSteps().forEach(function(r){var n=false;r.getNavigationTargets().forEach(function(t){if(e===t){n=true}});if(!n){t.push(r.getId())}});return t};this.getStepsAssignedToNavigationTarget=function(e){var t=[];a.getSteps().forEach(function(r){var n=false;r.getNavigationTargets().forEach(function(t){if(e===t){n=true}});if(n){t.push(r.getId())}});return t};this.copy=function(e){var t={stepContainer:v,categoryContainer:d,facetFilterContainer:m,navigationTargetContainer:h,categoryStepAssignmentContainer:p,applicationTitle:s,serviceList:y,filterOption:o};var n=sap.apf.modeler.core.ConfigurationObjects.deepDataCopy(t);if(o.smartFilterBar===true&&E){n.smartFilterBar=i()}return new sap.apf.modeler.core.ConfigurationEditor(e,r,undefined,n);function i(){var e=new r.constructors.SmartFilterBar(E.getId());e.setService(E.getService());e.setEntitySet(E.getEntitySet(),!E.isEntityTypeConverted());return e}};if(typeof e==="string"){if(e.indexOf("apf1972-")===0){g=false;if(n){n(a,undefined)}}else if(!i){T(e,l,function(e,t){if(!t){var r=JSON.parse(e.SerializedAnalyticalConfiguration);a.setApplicationTitle(r.applicationTitle);S.loadConfig(r,true);C.mapToDesignTimeAsPromise(S.getRegistry(),a).then(function(){g=true;n(a,undefined)})}else{n(undefined,t)}})}}else{S.loadConfig(e.content,true);C.mapToDesignTimeAsPromise(S.getRegistry(),this).then(function(){if(n){n(a,undefined)}})}function T(e,t,r){t.readEntity("configuration",function(e,t,n){r(e,n)},[{name:"AnalyticalConfiguration",value:e}],undefined,f.getApplicationId())}}e("sap.apf.modeler.core.ConfigurationEditor",r);return r});
//# sourceMappingURL=configurationEditor.js.map