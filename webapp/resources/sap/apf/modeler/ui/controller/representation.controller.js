/*!
* SAP APF Analysis Path Framework
*
* (c) Copyright 2012-2014 SAP SE. All rights reserved
*/
sap.ui.define(["sap/apf/modeler/ui/utils/representationHandler","sap/apf/ui/utils/constants","sap/apf/core/constants","sap/apf/modeler/ui/utils/nullObjectChecker","sap/apf/modeler/ui/utils/optionsValueModelBuilder","sap/apf/modeler/ui/utils/sortDataHandler","sap/apf/modeler/ui/utils/representationBasicDataHandler","sap/apf/modeler/ui/utils/stepPropertyMetadataHandler","sap/apf/ui/utils/representationTypesHandler","sap/apf/modeler/ui/utils/viewValidator","sap/m/Button","sap/ui/core/mvc/Controller","sap/ui/core/mvc/ViewType"],function(e,t,r,n,a,i,o,s,p,d,u,l,f){"use strict";var g,T,c,y,v,m,h,C,D,P;var w=r.representationMetadata.labelDisplayOptions;function E(e){e.byId("idVisualization").setText(T.getText("visualization"));e.byId("idChartTypeLabel").setText(T.getText("chartType"));e.byId("idChartTypeLabel").setTooltip(T.getText("chartType"));e.byId("idBasicData").setText(T.getText("basicData"));e.byId("idSorting").setText(T.getText("sorting"));e.byId("idChartType").setValueStateText(T.getText("modeler.ui.representation.invalidChartTypeError"))}function I(e,t){var r;var n=m.getPictureOfRepresentationType(y.getRepresentationType());var a=c.getCategoriesForStep(v.getId());if(a.length===1){r={id:y.getId(),icon:n};if(t){r.name=t}e.getView().getViewData().updateSelectedNode(r)}else{e.getView().getViewData().updateTree()}}function V(e,t){var r=T.getText("representation")+": "+t;e.getView().getViewData().updateTitleAndBreadCrumb(r)}function R(e){y.setRepresentationType(e);var r="TableRepresentation";if(e===t.representationTypes.TABLE_REPRESENTATION||e===t.representationTypes.TREE_TABLE_REPRESENTATION){r=undefined}y.setAlternateRepresentationType(r)}function b(e){var t;var r=jQuery.Deferred();h.getEntityTypeMetadataAsPromise().done(function(n){var a=h.getDimensionsProperties(n);var i=m.getKindsForDimensionPropertyType(e);i.forEach(function(e,r){t=false;var i;var o;var s=a[r];if(y.getDimensions().length!==0){if(y.getDimensions()[r]){if(y.getDimensionKind(y.getDimensions()[r])){t=true}}}if(!t&&s){i=h.hasTextPropertyOfDimension(n,s);o=i?w.KEY_AND_TEXT:w.KEY;y.addDimension(s);y.setLabelDisplayOption(s,o);y.setDimensionKind(s,e)}});r.resolve()});return r.promise()}function x(e){var t;var r=h.oStep.getService();var n=h.oStep.getEntitySet();var a=h.oStep.getHierarchyProperty();c.getHierarchyNodeIdAsPromise(r,n,a).done(function(r){t=h.hasTextPropertyOfDimension(e,r)});return t}function S(e){var t,r;var n=jQuery.Deferred();h.getEntityTypeMetadataAsPromise().done(function(e){var a=h.getHierarchicalProperty();if(a&&y.getHierarchyPropertyLabelDisplayOption()===undefined){t=x(e);r=t?w.TEXT:w.KEY;y.setHierarchyPropertyLabelDisplayOption(r)}n.resolve()});return n.promise()}function M(e){var t=jQuery.Deferred(),r,n;var a;var i=0;h.getEntityTypeMetadataAsPromise().done(function(o){a=m.getKindsForMeasurePropertyType(e);r=h.getMeasures(o);a.forEach(function(t){var a=m.getDefaultCountForRepresentationKind(e,t);for(var o=0;o<a;o++){n=false;var s=r[i];if(y.getMeasures().length!==0){if(y.getMeasures()[i]){if(y.getMeasureKind(y.getMeasures()[i])){n=true}}}if(!n&&s){y.addMeasure(s);y.setMeasureKind(s,t)}i++}});t.resolve()});return t.promise()}function A(e){var t=jQuery.Deferred();var r,n;if(e==="TableRepresentation"){if(y.getProperties().length===0){n=m.getKindsForPropertyType(e);r=h.getProperties()[0];y.addProperty(r);y.setPropertyKind(r,n[0]);t.resolve()}else{t.resolve()}}else if(e==="TreeTableRepresentation"){S(e).done(function(){t.resolve()})}else{b(e).done(function(){M(e).done(function(){t.resolve()})})}return t.promise()}function O(){if(g&&g.arguments&&g.arguments.stepId){v=c.getStep(g.arguments.stepId)}}function N(){var e=T.getRepresentationTypes()[0].id;if(v.getType()==="hierarchicalStep"){e="TreeTableRepresentation"}return e}function K(e){var t;var r=jQuery.Deferred();if(g&&g.arguments&&g.arguments.representationId){y=v.getRepresentation(g.arguments.representationId)}if(!n.checkIsNotUndefined(y)){y=v.createRepresentation();t=N();R(t);I(e,T.getText(t));c.setIsUnsaved();A(t).done(function(){return r.resolve()})}else{t=y.getRepresentationType();U().done(function(){A(t).done(function(){return r.resolve()})})}return r.promise()}function H(e){var t=new u({id:e.createId("idPreviewButton"),text:T.getText("preview"),press:e.handlePreviewButtonPress.bind(e)});var r=e.getView().getViewData().oFooter;r.addContentRight(t)}function L(e){var t=e.getView().getViewData().oConfigurationHandler.getTextPool();var r={oTextReader:T.getText,oConfigurationEditor:c,oTextPool:t,oParentObject:y,oParentStep:v,oRepresentationTypeHandler:m};var n=new sap.ui.controller("sap.apf.modeler.ui.controller.representationCornerTexts");var a=new sap.ui.view({viewName:"sap.apf.modeler.ui.view.cornerTexts",type:f.XML,id:e.createId("representationCornerTexts"),viewData:r,controller:n});e.byId("idCornerTextsVBox").insertItem(a);e.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.representation.SETCHARTICON,a.getController().setChartIcon.bind(a.getController()))}function B(){y.getDimensions().forEach(function(e){y.removeDimension(e)});y.getMeasures().forEach(function(e){y.removeMeasure(e)})}function _(){var e,t;if(y.getRepresentationType()==="TableRepresentation"){e=y.getDimensions();t=y.getMeasures();e.forEach(function(e){y.addProperty(e);y.setPropertyTextLabelKey(e,y.getDimensionTextLabelKey(e));y.setPropertyKind(e,r.representationMetadata.kind.COLUMN);c.setIsUnsaved()});t.forEach(function(e){y.addProperty(e);y.setPropertyTextLabelKey(e,y.getMeasureTextLabelKey(e));y.setPropertyKind(e,r.representationMetadata.kind.COLUMN);c.setIsUnsaved()});B()}}function j(e){var t;h.getEntityTypeMetadataAsPromise().done(function(r){t=h.hasTextPropertyOfDimension(r,e);if(t){y.setLabelDisplayOption(e,w.KEY_AND_TEXT)}else{y.setLabelDisplayOption(e,w.KEY)}c.setIsUnsaved()})}function F(){var e=jQuery.Deferred();h.getEntityTypeMetadataAsPromise().done(function(t){y.getDimensions().forEach(function(e){if(y.getLabelDisplayOption(e)===undefined){j(e)}});e.resolve()});return e.promise()}function U(){_();return F()}function Q(e){P.instantiateRepresentationSortData();L(e);return D.instantiateBasicDataAsPromise()}function k(e){if(!e.getValidationState()){if(e.byId("idChartType").getValueState("None")){setTimeout(function(){e.byId("idChartType").setValueState("Error")},1)}}else{e.byId("idChartType").setValueState("None")}}var X=l.extend("sap.apf.modeler.ui.controller.representation",{onInit:function(){var t=this;t.promiseControllerIsCreated=new Promise(function(r){var n=t.getView().getViewData();T=n.oCoreApi;g=n.oParams;c=n.oConfigurationEditor;m=new p;t.oViewValidator=new d(t.getView());E(t);O();if(v.getType()!=="hierarchicalStep"){H(t)}h=new sap.apf.modeler.ui.utils.StepPropertyMetadataHandler(T,v);K(t).then(function(){C=new e(y,m,T.getText);D=new o(t.getView(),h,C,t.oViewValidator);P=new i(t.getView(),y,h,T.getText);Q(t).then(function(){t.setDetailData();r()})})})},promiseControllerIsCreated:null,setDetailData:function(){var e=this;e._setChartType()},handleChangeForChartType:function(e){var t=this;var r=e.getParameter("selectedItem").getKey();var n=T.getText(r);var a=y.getRepresentationType();R(r);I(t,n);V(t,n);if(!m.isChartTypeSimilar(a,r)){t.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.REMOVEALLPROPERTIESFROMPARENTOBJECT);B();A(r).done(function(){D.instantiateBasicDataAsPromise().then(function(){k(t)});t.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.representation.SETCHARTICON);c.setIsUnsaved()})}else{D.instantiateBasicDataAsPromise().then(function(){k(t)});t.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.representation.SETCHARTICON);c.setIsUnsaved()}},handlePreviewButtonPress:function(){var e=this;var t={oParentStep:v,oRepresentation:y,oConfigurationHandler:e.getView().getViewData().oConfigurationHandler,oCoreApi:T,oRepresentationHandler:C,oStepPropertyMetadataHandler:h,oRepresentationTypeHandler:m};sap.ui.view({id:e.createId("idPreviewContentView"),viewName:"sap.apf.modeler.ui.view.previewContent",type:f.XML,viewData:t})},onExit:function(){var e=this;e.getView().getViewData().oFooter.removeContentRight(e.byId("idPreviewButton"));D.destroyBasicData();P.destroySortData();e.byId("idCornerTextsVBox").destroyItems()},getValidationState:function(){return this.oViewValidator.getValidationState()},_setChartType:function(){var e=this;h.getEntityTypeMetadataAsPromise().done(function(t){var r;var n=h.getDimensionsProperties(t);var i=h.getMeasures(t);var o=e._getAnnotatedChartTypes(m.aRepresentationTypes,h.getRepresentationTypesArray(),n,i,T);r=a.prepareModel(o);e.byId("idChartType").setModel(r);e.byId("idChartType").setSelectedKey(y.getRepresentationType());k(e)})},_getAnnotatedChartTypes:function(e,t,r,n,a){function i(e,t){var r;e.forEach(function(e){if(e["id"]===t){r=e}});return r}var o=jQuery.extend(true,[],t);o.forEach(function(t){var o=0,s=0;var p=i(e,t.key);if(p.metadata&&p.id!=="TableRepresentation"&&p.id!=="TreeTableRepresentation"){p.metadata.dimensions.supportedKinds.forEach(function(e){o+=parseInt(e.min,10)});p.metadata.measures.supportedKinds.forEach(function(e){s+=parseInt(e.min,10)});if(r.length<o||n.length<s){t.name=a.getText("modeler.ui.representation.invalidChartTypes",[t.name])}}});return o}});return X},true);
//# sourceMappingURL=representation.controller.js.map