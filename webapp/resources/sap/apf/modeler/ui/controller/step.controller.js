sap.ui.define(["sap/apf/modeler/ui/utils/sortDataHandler","sap/apf/modeler/ui/utils/nullObjectChecker","sap/apf/modeler/ui/utils/optionsValueModelBuilder","sap/apf/modeler/ui/utils/viewValidator","sap/apf/modeler/ui/utils/stepPropertyMetadataHandler","sap/apf/modeler/ui/utils/textPoolHelper","sap/ui/core/library","sap/ui/core/mvc/ViewType","sap/ui/core/mvc/Controller"],function(e,t,i,a,r,n,o,d){"use strict";var s=o.ValueState;var l,p,u,g,c,f,S,I,T,v,b,y;var m=sap.apf.modeler.ui.utils.TranslationFormatMap.STEP_TITLE;var N=sap.apf.modeler.ui.utils.TranslationFormatMap.STEP_LONG_TITLE;function h(e){e.byId("idStepBasicData").setText(p("stepBasicData"));e.byId("idStepTitleLabel").setText(p("stepTitle"));e.byId("idStepTitle").setPlaceholder(p("newStep"));e.byId("idStepLongTitleLabel").setText(p("stepLongTitle"));e.byId("idStepLongTitle").setPlaceholder(p("stepLongTitle"));e.byId("idCategoryTitleLabel").setText(p("categoryAssignments"));e.byId("idGlobalLabel").setText(p("globalNavigationTarget"));e.byId("idStepSpecificLabel").setText(p("stepSpecificNavTargets"));e.byId("idDataRequest").setText(p("dataRequest"));e.byId("idFilterMapping").setText(p("filterMap"));e.byId("idFilterMapKeepSourceLabel").setText(p("filterMapKeepSource"));e.byId("idNavigationTarget").setText(p("navigationTargetAssignments"));e.byId("idDataReduction").setText(p("dataReduction"));e.byId("idDataReductionLabel").setText(p("dataReductionType"));e.byId("idNoDataReduction").setText(p("noDataReduction"));e.byId("idTopN").setText(p("topN"));e.byId("idNumberOfRecordsLabel").setText(p("recordNumber"));e.byId("idAriaPropertyForDataReduction").setText(p("dataReductionType"))}function V(e,t){var i=p(b?"hierarchicalStepTitle":"step")+": "+t;e.getView().getViewData().updateTitleAndBreadCrumb(i);C(e,t)}function C(e,t){var i=p(b?"hierarchicalStepTitle":"step")+": "+t;e.getView().getViewData().oTitleBreadCrumbController.byId("IdFormTitle").setText(i)}function E(e,t){var i={id:S.getId(),icon:S.getType()==="hierarchicalStep"?"sap-icon://drill-down":"sap-icon://step"};if(t){i.name=t}e.getView().getViewData().updateSelectedNode(i)}function O(e){var i,a;if(l&&l.arguments&&l.arguments.stepId){S=g.getStep(l.arguments.stepId);b=S&&S.getType()==="hierarchicalStep"?true:false}if(!t.checkIsNotUndefined(S)){a=l.arguments.categoryId;b=l.bIsHierarchicalStep;if(b){i=g.createHierarchicalStep(a)}else{i=g.createStep(a)}S=g.getStep(i);E(e)}}function R(e){var t=this;var i=e.getParameter("bShowFilterMappingLayout");t.byId("idStepFilterMappingVBox").setVisible(i);t.byId("idFilterMapKeepSourceLabel").setVisible(i);t.byId("idFilterKeepSourceCheckBox").setVisible(i);if(!i){t.byId("idFilterMapping").setText("");t.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.RESETFILTERMAPPINGFIELDS)}else{t.byId("idFilterMapping").setText(p("filterMap"))}}function w(e){e.byId("idDataReductionForm").setVisible(!b)}function F(e,t,i,a,r){sap.ui.view({viewName:a,type:d.XML,id:e.createId(r),viewData:i,controller:t})}function x(e){var t,i,a,r,n,o,d;t={oTextReader:p,oConfigurationEditor:g,oTextPool:c,oParentObject:S,oStepPropertyMetadataHandler:y,oCoreApi:e.getView().getViewData().oCoreApi};i=new sap.ui.controller("sap.apf.modeler.ui.controller.stepCornerTexts");F(e,i,t,"sap.apf.modeler.ui.view.cornerTexts","idStepCornerTextView");n=e.byId("idStepCornerTextView");e.byId("idStepCornerTextVBox").insertItem(n);t.oConfigurationHandler=u;t.getCalatogServiceUri=e.getView().getViewData().getCalatogServiceUri;if(b){a=new sap.ui.controller("sap.apf.modeler.ui.controller.hierarchicalStepRequest")}else{a=new sap.ui.controller("sap.apf.modeler.ui.controller.stepRequest")}F(e,a,t,"sap.apf.modeler.ui.view.requestOptions","idStepRequestView");o=e.byId("idStepRequestView");e.byId("idStepRequestVBox").insertItem(o);r=new sap.ui.controller("sap.apf.modeler.ui.controller.stepFilterMapping");F(e,r,t,"sap.apf.modeler.ui.view.requestOptions","idStepFilterMappingView");d=e.byId("idStepFilterMappingView");e.byId("idStepFilterMappingVBox").insertItem(d);o.attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.SETDATAREDUCTIONSECTION,e.setDataReductionSection.bind(e));o.attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.SETVISIBILITYOFFILTERMAPPINGFIELDS,R.bind(e));e.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.SETVISIBILITYOFFILTERMAPPINGFIELDS,R.bind(e));o.attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.UPDATEFILTERMAPPINGFIELDS,d.getController().updateFilterMappingFields.bind(d.getController()));e.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.RESETFILTERMAPPINGFIELDS,d.getController().resetFilterMappingFields.bind(d.getController()));e.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.UPDATESUBVIEWINSTANCESONRESET,n.getController().updateSubViewInstancesOnReset.bind(n.getController()));e.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.UPDATESUBVIEWINSTANCESONRESET,o.getController().updateSubViewInstancesOnReset.bind(o.getController()));e.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.UPDATESUBVIEWINSTANCESONRESET,d.getController().updateSubViewInstancesOnReset.bind(d.getController()));o.addStyleClass("formTopPadding");o.addStyleClass("formBottomPadding");d.addStyleClass("formTopPadding");d.addStyleClass("formBottomPadding")}function D(e){if(!t.checkIsNotNullOrUndefinedOrBlank(g.getStep(l.arguments.stepId))){return}e.byId("idStepTitle").setValue(S.getId());if(t.checkIsNotNullOrUndefinedOrBlank(S.getTitleId())&&c.get(S.getTitleId())){e.byId("idStepTitle").setValue(c.get(S.getTitleId()).TextElementDescription)}}function P(e){if(!t.checkIsNotNullOrUndefinedOrBlank(g.getStep(l.arguments.stepId))){return}e.byId("idStepLongTitle").setValue("");if(t.checkIsNotNullOrUndefinedOrBlank(S.getLongTitleId())&&c.get(S.getLongTitleId())){e.byId("idStepLongTitle").setValue(c.get(S.getLongTitleId()).TextElementDescription)}}function L(e){var a=[];var r=g.getCategories();r.forEach(function(e){var t={};t.CategoryId=e.getId();t.CategoryTitle=c.get(e.labelKey)?c.get(e.labelKey).TextElementDescription:e.labelKey;a.push(t)});var n=i.prepareModel(a,a.length);e.byId("idCategorySelect").setModel(n);var o=g.getCategoriesForStep(S.getId());if(t.checkIsNotNullOrUndefinedOrBlank(o)){e.byId("idCategorySelect").setSelectedKeys(o)}}function A(e){e.byId("idNumberOfRecordsValue").setValue("");e.byId("idNumberOfRecordsValue").setValueState("None");if(S.getTopN()){e.byId("idNumberOfRecordsValue").setValue(S.getTopN().top)}B(e)}function M(e){e.byId("idDataReductionRadioGroup").setSelectedButton(e.byId("idNoDataReduction"));k(e);if(S.getTopN()){e.byId("idDataReductionRadioGroup").setSelectedButton(e.byId("idTopN"))}}function B(e){var t=e.byId("idDataReductionRadioGroup").getSelectedButton()===e.byId("idTopN")?true:false;e.byId("idNumberOfRecordsLabel").setVisible(t);e.byId("idNumberOfRecordsValue").setVisible(t);if(t){I.addField("idNumberOfRecordsValue")}else{I.removeField("idNumberOfRecordsValue")}}function U(e){if(S.getTopN()){T.instantiateStepSortData();if(S.getTopN().orderby.length===0){e.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.SETTOPNPROPERTIES);var t=v.createMessageObject({code:"11523"});v.putMessage(t)}}else{T.destroySortData()}}function k(e){var t=S.getSelectProperties().length!==0?true:false;e.byId("idDataReductionRadioGroup").setEnabled(t)}function K(e){var t=S.getFilterProperties().length!==0?true:false;e.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.SETVISIBILITYOFFILTERMAPPINGFIELDS,{bShowFilterMappingLayout:t})}function G(e){if(t.checkIsNotNullOrUndefinedOrBlank(S.getFilterMappingKeepSource())){e.byId("idFilterKeepSourceCheckBox").setSelected(S.getFilterMappingKeepSource())}}function q(e,t,a,r){var n=[];if(t.length!==0){a.setBusy(true)}t.forEach(function(e){var o={};o.navTargetKey=e.getId();f(e.getId()).then(function(e){o.navTargetName=e;n.push(o);if(n.length===t.length){var d=i.prepareModel(n,n.length);a.setModel(d);a.setSelectedKeys(r);a.setBusy(false)}})})}function H(e){var t=g.getNavigationTargets();var i=S.getNavigationTargets();var a=t.filter(function(e){return e.isStepSpecific()});q(e,a,e.byId("idStepSpecificCombo"),i)}function j(e){var t=g.getNavigationTargets();var i=t.filter(function(e){return e.isGlobal()});var a=i.map(function(e){return e.getId()});q(e,i,e.byId("idGlobalCombo"),a)}sap.ui.controller("sap.apf.modeler.ui.controller.step",{onInit:function(){var t=this,i;var r=t.getView().getViewData();v=r.oCoreApi;p=v.getText;l=r.oParams;u=r.oConfigurationHandler;c=u.getTextPool();g=r.oConfigurationEditor;f=r.getNavigationTargetName;I=new a(t.getView());h(t);O(t);y=new sap.apf.modeler.ui.utils.StepPropertyMetadataHandler(v,S);T=new e(t.getView(),S,y,p);x(t);t.setDetailData();i=t.byId("idStepTitle").getValue().trim();if(i===""){i="< "+p("newStep")+" >"}C(t,i);I.addFields(["idStepTitle","idCategorySelect"])},setDetailData:function(){var e=this;D(e);P(e);L(e);e.setDataReductionSection();w(e);K(e);G(e);H(e);j(e)},onAfterRendering:function(){var e=this;if(e.byId("idStepTitle").getValue().length===0){e.byId("idStepTitle").focus()}},updateSubViewInstancesOnReset:function(e){var t=this;g=e;S=g.getStep(S.getId());t.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.UPDATESUBVIEWINSTANCESONRESET,{oConfigurationEditor:g,oParentObject:S})},setDataReductionSection:function(){var e=this;M(e);A(e);U(e)},handleChangeForStepTitle:function(){var e=this;var i=g.getCategoriesForStep(S.getId());var a=e.byId("idStepTitle").getValue().trim();if(t.checkIsNotNullOrUndefinedOrBlank(a)){c.setTextAsPromise(a,m).done(function(t){S.setTitleId(t);if(i.length>1){e.getView().getViewData().updateTree()}else{E(e,a)}V(e,a);g.setIsUnsaved()})}else{g.setIsUnsaved()}},handleSuggestionsForStepTitle:function(e){var t=new sap.apf.modeler.ui.utils.SuggestionTextHandler(c);t.manageSuggestionTexts(e,m)},handleChangeForStepLongTitle:function(){var e=this;var i=e.byId("idStepLongTitle").getValue().trim();if(t.checkIsNotNullOrUndefined(i)){c.setTextAsPromise(i,N).done(function(e){S.setLongTitleId(e);g.setIsUnsaved()})}else{g.setIsUnsaved()}},handleSuggestionsForStepLongTitle:function(e){var t=new sap.apf.modeler.ui.utils.SuggestionTextHandler(c);t.manageSuggestionTexts(e,N)},handleChangeForCategory:function(){var e=this;var t=S.getId();var i=l.arguments.categoryId;var a=g.getCategoriesForStep(S.getId());var r=e.byId("idCategorySelect").getSelectedKeys();var n=r.indexOf(i);var o=[];var d=[];var s,p;for(s=0;s<a.length;s++){var u=false;for(p=0;p<r.length;p++){if(a[s]===r[p]){u=true;break}}if(!u){d.push(a[s])}}if(r.length!==0){r.forEach(function(e){g.addCategoryStepAssignment(e,t);var a={oldContext:{name:l.name,arguments:{configId:l.arguments.configId,categoryId:i,stepId:t}},newContext:{arguments:{configId:l.arguments.configId,categoryId:e}}};if(e!==i){o.push(a)}});a.forEach(function(e){if(r.indexOf(e)===-1){g.removeCategoryStepAssignment(e,S.getId())}});if(d.length!==0){d.forEach(function(e){var a={oldContext:{name:l.name,arguments:{configId:l.arguments.configId,categoryId:i,stepId:t}},newContext:{arguments:{configId:l.arguments.configId,categoryId:e}},removeStep:true};if(n===-1&&e===i){var d={arguments:{appId:l.arguments.appId,configId:l.arguments.configId,categoryId:r[0],stepId:t}};a.categoryChangeContext=d;a.changeCategory=true}o.push(a)})}}if(o.length!==0){e.getView().getViewData().updateTree(o)}g.setIsUnsaved()},handleChangeForDataReductionType:function(){var e=this;if(e.byId("idDataReductionRadioGroup").getSelectedButton()===e.byId("idNoDataReduction")){S.resetTopN();e.setDataReductionSection()}else{T.instantiateStepSortData()}B(e);g.setIsUnsaved()},handleValidationForNumberOfRecords:function(e){var t=e.getSource();var i=t.getValue().trim();var a=i.indexOf("E")!==-1||i.indexOf("e")!==-1||i.indexOf(".")!==-1||i<=0||i>1e4?s.Error:s.None;t.setValueState(a);g.setIsUnsaved()},handleChangeForNoOfRecords:function(e){var i=this;var a=e.getSource().getValue().trim();if(e.getSource().getValueState()===s.Error){return}if(t.checkIsNotNullOrUndefinedOrBlank(a)){if(S.getTopN()===undefined){i.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.SETTOPNPROPERTIES)}S.setTopNValue(a)}g.setIsUnsaved()},handleFilterMapKeepSource:function(){var e=this;var t=e.byId("idFilterKeepSourceCheckBox").getSelected();S.setFilterMappingKeepSource(t);g.setIsUnsaved()},handleChangeForStepSpecificNavTargets:function(){var e=this;var t=e.byId("idStepSpecificCombo").getSelectedKeys();var i=S.getNavigationTargets();i.forEach(function(e){if(t.indexOf(e)===-1){S.removeNavigationTarget(e)}});t.forEach(function(e){if(i.indexOf(e)===-1){S.addNavigationTarget(e)}});g.setIsUnsaved()},getValidationState:function(){var e=this;return I.getValidationState()&&e.byId("idStepRequestView").getController().getValidationState()&&e.byId("idStepFilterMappingView").getController().getValidationState()},onExit:function(){var e=this;e.byId("idStepCornerTextView").destroy();e.byId("idStepRequestView").destroy();e.byId("idStepFilterMappingView").destroy()}})});
//# sourceMappingURL=step.controller.js.map