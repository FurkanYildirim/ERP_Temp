/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
sap.ui.define(["sap/apf/modeler/ui/utils/textPoolHelper","sap/apf/modeler/ui/utils/nullObjectChecker","sap/apf/modeler/ui/utils/optionsValueModelBuilder","sap/apf/modeler/ui/utils/viewValidator","sap/apf/modeler/ui/utils/textManipulator","sap/apf/utils/utils","sap/m/Token","sap/ui/core/library","sap/ui/core/mvc/ViewType","sap/ui/core/mvc/Controller"],function(e,t,i,l,a,n,s,o,d){"use strict";var r=o.ValueState;var u,c,f,I,b,V,g;var t=sap.apf.modeler.ui.utils.nullObjectChecker;var i=sap.apf.modeler.ui.utils.optionsValueModelBuilder;var a=sap.apf.modeler.ui.utils.textManipulator;var p=sap.apf.modeler.ui.utils.TranslationFormatMap.FACETFILTER_LABEL;function S(e){e.byId("idFacetFilterBasicData").setText(c("basicData"));e.byId("idFFLabel").setText(c("ffLabel"));e.byId("idLabel").setPlaceholder(c("newFacetFilter"));e.byId("idFFPropertyLabel").setText(c("ffProperty"));e.byId("idDoNotShowAtRuntimeLabel").setText(c("doNotShowAtRuntime"));e.byId("idSelectionModeLabel").setText(c("ffSelectionMode"));e.byId("idValueHelpLabel").setText(c("valueHelpMode"));e.byId("idVHNone").setText(c("none"));e.byId("idValueHelpRequest").setText(c("valueHelpRequest"));e.byId("idConfigListOfValues").setText(c("configListOfValues"));e.byId("idConfigListOfValuesLabel").setText(c("configListOfValuesLabel"));e.byId("idSingleSelectionMode").setText(c("singleSelection"));e.byId("idMultiSelectionMode").setText(c("multipleSelection"));e.byId("idDefaultValuesTitle").setText(c("vhDefaultValues"));e.byId("idPreselectionModeLabel").setText(c("vhDefaultValueMode"));e.byId("idNoneSelection").setText(c("none"));e.byId("idAutomaticSelection").setText(c("automaticValue"));e.byId("idFixedValue").setText(c("fixedValues"));e.byId("idFunction").setText(c("function"));e.byId("idPreselectionDefaultsLabel").setText(c("vhDefaultValues"));e.byId("idPreselectionFunctionLabel").setText(c("function"));e.byId("idValueHelpTitle").setText(c("valueHelp"));e.byId("idFilterResolutionTitle").setText(c("contextResolution"));e.byId("idUseVHRAsFRRCheckBoxLabel").setText(c("vhCheckBoxLabel"));e.byId("idAriaPropertyForSelection").setText(c("ffSelectionMode"));e.byId("idAriaPropertyForDefaultMode").setText(c("vhDefaultValueMode"));e.byId("idAriaPropertyForVHR").setText(c("valueHelpMode"))}function y(e,t){var i=V.isVisible()?"sap-icon://filter":"sap-icon://hide";var l={id:V.getId(),icon:i};if(t){delete l.icon;l.name=t}e.getView().getViewData().updateSelectedNode(l)}function F(e,t){var i=c("facetFilter")+": "+t;e.getView().getViewData().updateTitleAndBreadCrumb(i)}function v(e){var i;if(u&&u.arguments&&u.arguments.facetFilterId){V=I.getFacetFilter(u.arguments.facetFilterId)}if(!t.checkIsNotUndefined(V)){i=I.createFacetFilter();V=I.getFacetFilter(i);y(e)}}function T(e){var t,i,l,a;var n={oTextReader:c,oConfigurationHandler:f,oConfigurationEditor:I,oParentObject:V,getCalatogServiceUri:e.getView().getViewData().getCalatogServiceUri,oCoreApi:e.getView().getViewData().oCoreApi};t=new sap.ui.controller("sap.apf.modeler.ui.controller.facetFilterVHR");l=new sap.ui.view({viewName:"sap.apf.modeler.ui.view.requestOptions",type:d.XML,id:e.createId("idVHRView"),viewData:n,controller:t});i=new sap.ui.controller("sap.apf.modeler.ui.controller.facetFilterFRR");a=new sap.ui.view({viewName:"sap.apf.modeler.ui.view.requestOptions",type:d.XML,id:e.createId("idFRRView"),viewData:n,controller:i});l.attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.UPDATEPROPERTIES,e.setFFProperty.bind(e));a.attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.UPDATEPROPERTIES,e.setFFProperty.bind(e));e.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.USESAMEASVHR,a.getController().handleCopy.bind(a.getController()));e.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.ENABLEDISABLEFRRFIELDS,a.getController().enableOrDisableView.bind(a.getController()));l.attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.USESAMEASVHR,a.getController().handleCopy.bind(a.getController()));e.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.UPDATESUBVIEWINSTANCESONRESET,l.getController().updateSubViewInstancesOnReset.bind(l.getController()));e.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.UPDATESUBVIEWINSTANCESONRESET,a.getController().updateSubViewInstancesOnReset.bind(a.getController()));e.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.DONOTSHOWATRUNTIME,l.getController().clearVHRFields.bind(l.getController()));e.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.CLEARVHRFIELDSIFVALUELIST,l.getController().clearVHRFields.bind(l.getController()));e.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.DONOTSHOWATRUNTIME,a.getController().clearFRRFields.bind(a.getController()));l.addStyleClass("formTopPadding");l.addStyleClass("formBottomPadding");a.addStyleClass("formTopPadding")}function R(e,t){e.byId("idSelectionMode").setVisible(t);e.byId("idSelectionModeLabel").setVisible(t);e.byId("idSelectionModeRadioGroup").setSelectedButton(e.byId("idMultiSelectionMode"));e.byId("idValueHelp").setVisible(t);e.byId("idValueHelpLabel").setVisible(t);e.byId("idValueHelpRadioGroup").setSelectedButton(e.byId("idVHNone"));e.byId("idFFForm1").setVisible(t);if(t){e.byId("idValueHelpTitle").setText(c("valueHelp"));e.byId("idFRRVBox").insertItem(e.byId("idFRRView"));e.byId("idDoNotShowAtRuntimeCheckBox").setSelected(false)}else{e.byId("idValueHelpTitle").setText("");x(e,t);D(e,t);e.byId("idFRRVBox").removeItem(e.byId("idFRRView"))}}function h(e){if(!V.isVisible()){e.byId("idDoNotShowAtRuntimeCheckBox").setSelected(true)}R(e,V.isVisible())}function m(e){if(!t.checkIsNotNullOrUndefinedOrBlank(I.getFacetFilter(u.arguments.facetFilterId))){return}if(t.checkIsNotNullOrUndefinedOrBlank(V.getLabelKey())&&b.get(V.getLabelKey())){e.byId("idLabel").setValue(b.get(V.getLabelKey()).TextElementDescription)}else{e.byId("idLabel").setValue(V.getId())}}function C(e){if(!t.checkIsNotNullOrUndefinedOrBlank(I.getFacetFilter(u.arguments.facetFilterId))){V.setMultiSelection(true)}if(V.isMultiSelection()){e.byId("idSelectionModeRadioGroup").setSelectedButton(e.byId("idMultiSelectionMode"))}else{e.byId("idSelectionModeRadioGroup").setSelectedButton(e.byId("idSingleSelectionMode"))}}function N(e){e.byId("idPreselectionFunction").setValue("");if(t.checkIsNotNullOrUndefinedOrBlank(V.getPreselectionFunction())){e.byId("idPreselectionFunction").setValue(V.getPreselectionFunction())}}function P(e){var i=false,l=false;if(V.getNoneSelection()){e.byId("idPreselectionModeRadioGroup").setSelectedButton(e.byId("idNoneSelection"))}else if(t.checkIsNotNullOrUndefinedOrBlank(V.getPreselectionFunction())){e.byId("idPreselectionModeRadioGroup").setSelectedButton(e.byId("idFunction"));N(e);i=true}else if(t.checkIsNotNullOrUndefinedOrBlank(V.getPreselectionDefaults())){e.byId("idPreselectionModeRadioGroup").setSelectedButton(e.byId("idFixedValue"));L(e);l=true}else if(V.getAutomaticSelection()){e.byId("idPreselectionModeRadioGroup").setSelectedButton(e.byId("idAutomaticSelection"))}O(e,i);A(e,l)}function O(e,t){e.byId("idPreselectionFunctionLabel").setVisible(t);e.byId("idPreselectionFunction").setVisible(t);if(t){g.addField("idPreselectionFunction")}else{e.byId("idPreselectionFunction").setValue("");g.removeField("idPreselectionFunction")}}function A(e,t){e.byId("idPreselectionDefaultsLabel").setVisible(t);e.byId("idPreselectionDefaults").setVisible(t);if(t){g.addField("idPreselectionDefaults")}else{g.removeField("idPreselectionDefaults")}}function L(e){e.byId("idPreselectionDefaults").setTokens([]);var i=V.getPreselectionDefaults();if(t.checkIsNotNullOrUndefinedOrBlank(i)){i.forEach(function(t){e.byId("idPreselectionDefaults").addToken(new s({text:t}))})}}function E(e){e.byId("idConfigListOfValuesMultiInput").setTokens([]);var i=V.getValueList();if(t.checkIsNotNullOrUndefinedOrBlank(i)){i.forEach(function(t){e.byId("idConfigListOfValuesMultiInput").addToken(new s({text:t}))})}}function D(e,t){e.byId("idConfigListOfValuesLabel").setVisible(t);e.byId("idConfigListOfValuesMultiInput").setVisible(t);if(t){g.addField("idConfigListOfValuesMultiInput")}else{g.removeField("idConfigListOfValuesMultiInput")}}function x(e,t){e.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.ENABLEDISABLEFRRFIELDS);B(e,t);if(t){e.byId("idVHRVBox").insertItem(e.byId("idVHRView"))}else{e.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.CLEARVHRFIELDSIFVALUELIST);e.byId("idVHRVBox").removeItem(e.byId("idVHRView"))}}function w(e){if(V.getUseSameRequestForValueHelpAndFilterResolution()){e.byId("idUseVHRAsFRRCheckBox").setSelected(true);e.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.ENABLEDISABLEFRRFIELDS)}}function k(e){var i=false,l=false;if(t.checkIsNotNullOrUndefinedOrBlank(V.getServiceOfValueHelp())){i=true;e.byId("idValueHelpRadioGroup").setSelectedButton(e.byId("idValueHelpRequest"))}else if(t.checkIsNotNullOrUndefinedOrBlank(V.getValueList())){E(e);l=true;e.byId("idValueHelpRadioGroup").setSelectedButton(e.byId("idConfigListOfValues"))}else{e.byId("idValueHelpRadioGroup").setSelectedButton(e.byId("idVHNone"))}D(e,l);x(e,i)}function B(e,t){if(t===false){e.byId("idUseVHRAsFRRCheckBox").setSelected(false)}e.byId("idUseVHRAsFRRCheckBox").setVisible(t);e.byId("idUseVHRAsFRRCheckBoxLabel").setVisible(t)}function M(e,t){t.byId("idPreselectionDefaults").setValueState(r.Warning);t.byId("idPreselectionDefaults").setValueStateText(c(e));t.byId("idPreselectionDefaults").focus()}function H(e,t){var i=new s({text:e});t.addToken(i);I.setIsUnsaved()}function U(e,t){if(e.mEventRegistry.tokenChange===undefined){e.attachTokenChange(t)}}sap.ui.controller("sap.apf.modeler.ui.controller.facetFilter",{onInit:function(){var e=this;var t=e.getView().getViewData();c=t.getText;u=t.oParams;f=t.oConfigurationHandler;b=f.getTextPool();I=t.oConfigurationEditor;if(!I){f.loadConfiguration(u.arguments.configId,function(e){I=e})}g=new sap.apf.modeler.ui.utils.ViewValidator(e.getView());S(e);v(e);T(e);e.setDetailData();g.addFields(["idFFProperty","idLabel"])},onAfterRendering:function(){var e=this;if(e.byId("idLabel").getValue().length===0){e.byId("idLabel").focus()}U(e.byId("idConfigListOfValuesMultiInput"),e.handleTokenChangeForConfigListOfValues.bind(e));U(e.byId("idPreselectionDefaults"),e.handleTokenChangeForPreselectionDefaults.bind(e))},setDetailData:function(){var e=this;h(e);e.setFFProperty();m(e);C(e);P(e);k(e);w(e)},updateSubViewInstancesOnReset:function(e){var t=this;I=e;V=I.getFacetFilter(V.getId());t.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.UPDATESUBVIEWINSTANCESONRESET,{oConfigurationEditor:I,oParentObject:V})},validateSelectedValues:function(e,t,i){var l={},s=[],o=[],d=[],r=[],u;l=n.validateSelectedValues(t,i);s=l.invalid;o=l.valid;d=a.addPrefixText(s,c);r=d.concat(i).length!==0?d.concat(i):i;u=d.concat(o).length!==0?d.concat(o):t;return{aValues:r,aSelectedValues:u}},setFFProperty:function(){var e=this;var l=[],a,n;I.getFilterablePropertiesAndParametersAsPromise().done(function(s){l=s;n=V.getProperty();if(t.checkIsNotNullOrUndefinedOrBlank(n)){a=e.validateSelectedValues(e,[n],l);l=a.aValues;n=a.aSelectedValues[0]}var o=i.convert(l);e.byId("idFFProperty").setModel(o);e.byId("idFFProperty").setSelectedKey(n)})},handleChangeForVisibilityAtRuntime:function(){var e=this,t=true;if(e.byId("idDoNotShowAtRuntimeCheckBox").getSelected()){t=false;V.setInvisible();V.setUseSameRequestForValueHelpAndFilterResolution(false);e.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.ENABLEDISABLEFRRFIELDS);e.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.DONOTSHOWATRUNTIME);V.setValueList([]);E(e)}else{V.setVisible()}V.setMultiSelection(true);I.setIsUnsaved();y(e);R(e,t)},handleChangeForProperty:function(){var e=this;var i=e.byId("idFFProperty").getSelectedKey().trim();i=a.removePrefixText(i,c(sap.apf.modeler.ui.utils.CONSTANTS.texts.NOTAVAILABLE));if(t.checkIsNotNullOrUndefinedOrBlank(i)){V.setProperty(i)}I.setIsUnsaved()},handleChangeForLabel:function(){var e=this;var i=e.byId("idLabel").getValue().trim();if(t.checkIsNotNullOrUndefinedOrBlank(i)){b.setTextAsPromise(i,p).done(function(t){V.setLabelKey(t);y(e,i);F(e,i);I.setIsUnsaved()})}else{I.setIsUnsaved()}},handleSuggestions:function(e){var t=new sap.apf.modeler.ui.utils.SuggestionTextHandler(b);t.manageSuggestionTexts(e,p)},handleChangeForSelectionMode:function(){var e=this,t,i;var l=e.byId("idSelectionModeRadioGroup").getSelectedButton();if(l===e.byId("idSingleSelectionMode")){V.setMultiSelection(false);if(e.byId("idPreselectionDefaultsLabel").getVisible()){t=V.getPreselectionDefaults();if(t&&t.length>1){V.setPreselectionDefaults([t[0]]);i=new s({text:t[0]});e.byId("idPreselectionDefaults").setTokens([i]);M("singleToMultipleSelectionWarningMessage",e)}}}else{e.byId("idPreselectionDefaults").setValueState(r.None);V.setMultiSelection(true)}I.setIsUnsaved()},handleChangeForPreselectionMode:function(){var e=this,t=false,i=false,l=false,a=false;switch(e.byId("idPreselectionModeRadioGroup").getSelectedButton()){case e.byId("idAutomaticSelection"):t=true;break;case e.byId("idFunction"):i=true;V.removePreselectionDefaults();break;case e.byId("idFixedValue"):l=true;V.removePreselectionFunction();break;default:a=true}V.setAutomaticSelection(t);V.setNoneSelection(a);L(e);N(e);A(e,l);O(e,i);I.setIsUnsaved()},handleChangeForPreselectionDefaults:function(e){var t=this;t.byId("idPreselectionDefaults").setValue("");t.byId("idPreselectionDefaults").setValueState(r.None);if(!V.isMultiSelection()){if(t.byId("idPreselectionDefaults").getTokens().length<1){t.byId("idPreselectionDefaults").setValueState(r.None);H(e.getParameter("value"),t.byId("idPreselectionDefaults"))}else{M("singleSelectionWarningMessage",t)}}else{H(e.getParameter("value"),t.byId("idPreselectionDefaults"))}},handleTokenChangeForPreselectionDefaults:function(e){var t=this;var i,l=[];var a=t.byId("idPreselectionDefaults").getTokens();t.byId("idPreselectionDefaults").setValueState(r.None);if(e.getParameters().type==="removed"||e.getParameters().type==="added"){for(i=0;i<a.length;i++){l[i]=a[i].getText()}if(V.isMultiSelection()){V.setPreselectionDefaults(l)}else{V.setPreselectionDefaults([l[0]])}if(e.getParameters().type==="removed"){I.setIsUnsaved()}}},handleChangeForPreselectionFunction:function(){var e=this;var i=e.byId("idPreselectionFunction").getValue().trim();V.removePreselectionFunction();if(t.checkIsNotNullOrUndefinedOrBlank(i)){V.setPreselectionFunction(i)}I.setIsUnsaved()},handleChangeForUseVHRAsFRRCheckBox:function(){var e=this;if(e.byId("idUseVHRAsFRRCheckBox").getSelected()){V.setUseSameRequestForValueHelpAndFilterResolution(true)}else{V.setUseSameRequestForValueHelpAndFilterResolution(false)}e.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.ENABLEDISABLEFRRFIELDS);e.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.USESAMEASVHR);I.setIsUnsaved()},handleChangeForValueHelpOption:function(){var e=this,t=false,i=false;switch(e.byId("idValueHelpRadioGroup").getSelectedButton()){case e.byId("idValueHelpRequest"):t=true;V.setValueList([]);break;case e.byId("idConfigListOfValues"):i=true;V.setAlias(undefined);break;default:V.setAlias(undefined);V.setValueList([])}if(V.getUseSameRequestForValueHelpAndFilterResolution()===true){V.setUseSameRequestForValueHelpAndFilterResolution(false);e.byId("idUseVHRAsFRRCheckBox").setSelected(false)}E(e);D(e,i);x(e,t);I.setIsUnsaved()},handleChangeForConfigListOfValues:function(e){var t=this;t.byId("idConfigListOfValuesMultiInput").setValue("");H(e.getParameter("value"),t.byId("idConfigListOfValuesMultiInput"))},handleTokenChangeForConfigListOfValues:function(e){var t=this;var i,l=[];var a=t.byId("idConfigListOfValuesMultiInput").getTokens();if(e.getParameters().type==="removed"||e.getParameters().type==="added"){for(i=0;i<a.length;i++){l[i]=a[i].getText()}V.setValueList(l);if(e.getParameters().type==="removed"){I.setIsUnsaved()}}},getValidationState:function(){var e=this;return g.getValidationState()&&e.byId("idVHRView").getController().getValidationState()&&e.byId("idFRRView").getController().getValidationState()},onExit:function(){var e=this;e.byId("idVHRView").destroy();e.byId("idFRRView").destroy()}})});
//# sourceMappingURL=facetFilter.controller.js.map