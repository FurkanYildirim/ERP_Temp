/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
sap.ui.define(["sap/apf/core/step","sap/apf/core/utils/uriGenerator","sap/apf/utils/exportToGlobal","sap/ui/model/odata/ODataUtils","sap/ui/model/odata/OperationMode","sap/ui/model/odata/v2/ODataModel","sap/ui/model/Sorter","sap/ui/thirdparty/jquery"],function(e,t,r,a,i,o,n,jQuery){"use strict";function s(e,t,r,s,p){sap.apf.core.Step.call(this,e,t,r,s,p);var u;var c;var l;this.type="hierarchicalStep";var d=r.getConfigurationById(t.request).service;var g=r.getConfigurationById(t.request).entityType;var f=p.getAnnotationsForService(d);var h=t.hierarchyProperty;var v=jQuery.Deferred();var y=r.getConfigurationById(t.binding).requiredFilters;var m=p.getStartParameterFacade().getSapSystem();if(m){d=a.setOrigin(d,{force:true,alias:m})}jQuery.when(p.getMetadata(d),p.getEntityTypeMetadata(d,g)).then(function(t,a){var i=t.getHierarchyAnnotationsForProperty(g,h);if(i.type==="messageObject"){e.putMessage(i)}else{c=P(h,i)}u=r.createRequest({service:d,entityType:g,selectProperties:S(y[0],t,i),type:"request",id:"SelectionValidationRequest"});v.resolve(t,i,a)});var F=new o(d,{annotationURI:f});function S(e,t,r){var a=[e];var i=t.getPropertyMetadata(g,e)["sap:text"];if(i){a.push(i)}if(r.hierarchyNodeExternalKeyFor){a.push(r.hierarchyNodeExternalKeyFor)}return a}function P(e,a){var i=[e];for(var o in a){i.push(a[o])}i=i.concat(r.getConfigurationById(t.request).selectProperties);return sap.apf.core.utils.uriGenerator.getSelectString(i)}this.update=function(t,r){v.done(function(a,o,n){var s=t.restrictToProperties(a.getFilterablePropertiesAndParameters(g));var p=!s.isEqual(l);l=s.copy();var d="/"+sap.apf.core.utils.uriGenerator.generateOdataPath(e,a,g,t,a.getUriComponents(g).navigationProperty);var f={};f.path=d;var h=t.restrictToProperties(a.getFilterableProperties(g));if(!h.isEmpty()){f.filters=[h.mapToSapUI5FilterExpression()]}f.parameters={select:c,operationMode:i.Server,useServerSideApplicationFilters:true,treeAnnotationProperties:o};f.sorter=this.getSorter();this.getBinding().updateTreetable(f,F,n,p);if(!this.getFilter().isEmpty()&&p){var v=h.removeTermsByProperty(y[0]);u.sendGetInBatch(v.addAnd(this.getFilter()),function(e){var t=e.data;var a=this.getFilter().getFilterTerms();var i=[];a.forEach(function(e){t.forEach(function(t){if(t[y[0]]===e.getValue()){i.push(t)}})});this.getBinding().setFilterValues(i);r({},true)}.bind(this))}else{r({},p)}}.bind(this))};this.getSorter=function(){var e=[];var t=this.getBinding().getRequestOptions();if(t&&t.orderby&&t.orderby.length>0){t.orderby.forEach(function(t){e.push(new n(t.property,!t.ascending))})}if(e.length===0){return}return e};this.setData=function(){};this.adjustCumulativeFilter=function(e){if(y[0]&&!this.getFilter().isEmpty()){return e.removeTermsByProperty(y[0])}return e}}r("sap.apf.core.HierarchicalStep",s);return s});
//# sourceMappingURL=hierarchicalStep.js.map