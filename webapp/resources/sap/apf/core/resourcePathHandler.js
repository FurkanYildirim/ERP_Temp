/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
sap.ui.define(["sap/apf/core/utils/filter","sap/apf/utils/hashtable","sap/apf/core/messageHandler","sap/apf/core/messageDefinition","sap/apf/core/odataProxy","sap/apf/core/layeredRepositoryProxy","sap/apf/cloudFoundry/runtimeProxy","sap/apf/core/constants","sap/apf/utils/exportToGlobal","sap/apf/utils/startParameter","sap/apf/utils/utils","sap/ui/thirdparty/jquery"],function(e,a,t,i,o,s,n,r,c,p,u,jQuery){"use strict";function f(e){var t=this;var i=e.instances.coreApi;var o=e.instances.messageHandler;var s=new a(o);var n;var r;var c=null;var p=jQuery.Deferred();var f=false;var l;this.loadConfigFromFilePath=function(a){if(f){return}f=true;var t=i.getStartParameterFacade().getAnalyticalConfigurationId();var s=a;i.ajax({url:s,dataType:"json",success:n,error:function(e,a,t){var i=o.createMessageObject({code:"5068",aParameters:[s,a,t]});b(i)},async:true,suppressSapSystem:true});function n(i,s,n){var r=e.functions.checkForTimeout(n);var c;if(r){c=o.createMessageObject({code:"5054",aParameters:[a]});c.setPrevious(r);b(c)}if(!i||!i.applicationConfiguration){b(o.createMessageObject({code:"5055",aParameters:[a]}))}if(i.applicationConfiguration.textResourceLocations===undefined){b(o.createMessageObject({code:"5056",aParameters:[a]}));return}T(i,t);y().done(function(){if(t){g(t)}else{m()}})}};function d(){return i.getStartParameterFacade().isLrepActive()}function g(a){var t=a.applicationId;var s=a.configurationId;if(d()&&!t){b(o.createMessageObject({code:"5024"}))}var c=new l({serviceRoot:r&&r.path&&r.path.service,entityTypes:{configuration:sap.apf.core.constants.entitySets.configuration,texts:sap.apf.core.constants.entitySets.texts}},{instances:{coreApi:i,messageHandler:o},manifests:e.manifests});if(d()){var u=[];var f=jQuery.Deferred();u.push(f);u.push(v(t,c))}c.readEntity("configuration",function(e,a,r){if(r){b(o.createMessageObject({code:"5022",aParameters:[s]}));p.resolve()}else{var u=JSON.parse(e.SerializedAnalyticalConfiguration);i.loadAnalyticalConfiguration(u);if(u.applicationTitle){n.appName=u.applicationTitle.key;n.appTitle=u.applicationTitle.key}if(d()){f.resolve()}else{t=t||e.Application;v(t,c).then(function(){p.resolve()})}}},[{name:"AnalyticalConfiguration",value:s}],undefined,t,{layer:"ALL"},{noMetadata:true});if(d()){jQuery.when.apply(jQuery,u).then(function(){p.resolve()})}}function v(e,a){var t=jQuery.Deferred();var s=new sap.apf.core.utils.Filter(o,"Application","eq",e);var n=new sap.apf.core.utils.Filter(o,"Language","eq",sap.apf.core.constants.developmentLanguage);n.addAnd(s);var r=["TextElement","TextElementDescription"];a.readCollection("texts",function(e,a,s){if(s){b(o.createMessageObject({code:"5023",aParameters:[i.getStartParameterFacade().getAnalyticalConfigurationId()]}))}else{i.loadTextElements(e)}t.resolve()},undefined,r,n,{layer:"ALL"});return t.promise()}function m(){var e=t.getResourceLocation(sap.apf.core.constants.resourceLocation.analyticalConfigurationLocation);var a;if(e!==""){i.ajax({url:e,dataType:"json",success:function(t,s,r){if(t){i.loadAnalyticalConfiguration(t);if(t.applicationTitle){n.appName=t.applicationTitle.key;n.appTitle=t.applicationTitle.key}p.resolve()}else{a=o.createMessageObject({code:"5057",aParameters:[e]});b(a)}},error:function(t,i,s,n){a=o.createMessageObject({code:"5057",aParameters:[e]});if(n){a.setPrevious(n)}b(a)},async:true,suppressSapSystem:true})}else{a=o.createMessageObject({code:"5060"});b(a)}}function y(){i.loadMessageConfiguration(sap.apf.core.messageDefinition,true);return L(sap.apf.core.constants.resourceLocation.applicationMessageDefinitionLocation,false)}function L(a,s){var n=jQuery.Deferred();var r=t.getResourceLocation(a);if(r!==""){i.ajax({url:r,dataType:"json",success:c,error:function(e,a,t,i){var s=o.createMessageObject({code:"5058",aParameters:[a,t,r]});if(i){s.setPrevious(i)}b(s)},async:true,suppressSapSystem:true})}else{n.resolve()}return n.promise();function c(a,t,r){var c;var p=e.functions.checkForTimeout(r);if(!p){if(a.messageConfiguration){i.loadMessageConfiguration(a.messageConfiguration.definitions,s)}}else{c=o.createMessageObject({code:"5067"});c.setPrevious(p);b(c)}n.resolve()}}function P(e){var a;if(!e||!e.path){a=o.createMessageObject({code:"5066"});b(a)}if(!e.path.service){a=o.createMessageObject({code:"5067"});b(a)}if(e.analyticalConfiguration){if(!e.analyticalConfiguration.service){a=o.createMessageObject({code:sap.apf.core.constants.message.code.errorInAnalyticalConfig,rawText:"service or entity set are missing in analytical configuration in the application configuration"});b(a)}}}function C(e){var a;if(e.evaluations&&!e.evaluations.service){a=o.createMessageObject({code:"5063"});b(a)}if(e.evaluations&&(!e.evaluations.type||e.evaluations.type!=="smartBusinessRequest")){a=o.createMessageObject({code:"5062",rawText:"type in Smart Business configuration is not smartBusinessRequest"});b(a)}if(e.evaluations&&!e.evaluations.entityType){a=o.createMessageObject({code:"5061"});b(a)}}this.getResourceLocation=function(e){return s.getItem(e)};this.getPersistenceConfiguration=function(){var e=jQuery.Deferred();p.done(function(){e.resolve(r)});return e};this.getConfigurationProperties=function(){var a=jQuery.Deferred();e.corePromise.done(function(){a.resolve(n)});return a};function S(){var a=sap.apf.core.utils.uriGenerator;var t,s,n;var r=e.manifests.manifest;var c=e.manifests.baseManifest;var f;if(p.state()==="resolved"){return}var l=a.getBaseURLOfComponent(u.getComponentNameFromManifest(e.manifests.baseManifest));var d=a.getBaseURLOfComponent(u.getComponentNameFromManifest(e.manifests.manifest));if(r["sap.app"].dataSources&&r["sap.app"].dataSources.PathPersistenceServiceRoot){n=r["sap.app"].dataSources.PathPersistenceServiceRoot.uri}else if(e.functions.isUsingCloudFoundryProxy()){n=""}else{f=o.createMessageObject({code:"5064"});b(f)}var v=c["sap.app"].i18n;if(typeof v==="string"){v=a.addRelativeToAbsoluteURL(l,v)}else if(typeof v==="object"){v=a.addRelativeToAbsoluteURL(l,v.bundleUrl)}var L=r["sap.app"].i18n;if(typeof L==="string"){L=a.addRelativeToAbsoluteURL(d,L)}else if(typeof L==="object"){L=a.addRelativeToAbsoluteURL(d,L.bundleUrl)}var P=r["sap.app"].title;var C=u.createPseudoGuid();i.registerTextWithKey(C,P);var S=i.getStartParameterFacade().getAnalyticalConfigurationId();var x="";if(r["sap.app"].dataSources&&r["sap.app"].dataSources.AnalyticalConfigurationLocation&&r["sap.app"].dataSources.AnalyticalConfigurationLocation.uri){x=r["sap.app"].dataSources.AnalyticalConfigurationLocation.uri;x=a.addRelativeToAbsoluteURL(d,x)}if(!S&&!x){f=o.createMessageObject({code:"5065"});b(f)}var M={appName:C,appTitle:C,analyticalConfigurationLocation:x,textResourceLocations:{apfUiTextBundle:v,applicationUiTextBundle:L},persistence:{path:{service:n}}};if(r["sap.apf"]&&r["sap.apf"].appSpecificParameters){for(t in r["sap.apf"].appSpecificParameters){M[t]=r["sap.apf"].appSpecificParameters[t]}}if(r["sap.app"].dataSources&&r["sap.app"].dataSources.SmartBusiness){s=r["sap.app"].dataSources.SmartBusiness.uri;M.smartBusiness={runtime:{service:s}}}if(r["sap.app"].dataSources&&r["sap.app"].dataSources.LogicalSystem){M.persistence.logicalSystem={service:r["sap.app"].dataSources.LogicalSystem.uri}}T({applicationConfiguration:M},S);y().done(function(){if(S){g(S)}else{m()}})}function x(){var e=i.getUriGenerator().getApfLocation();s.setItem(sap.apf.core.constants.resourceLocation.apfUiTextBundle,e+"resources/i18n/apfUi.properties");s.setItem(sap.apf.core.constants.resourceLocation.applicationMessageDefinitionLocation,"");s.setItem(sap.apf.core.constants.resourceLocation.applicationMessageTextBundle,"");s.setItem(sap.apf.core.constants.resourceLocation.applicationUiTextBundle,"");s.setItem(sap.apf.core.constants.resourceLocation.analyticalConfigurationLocation,"")}function T(a,t){function i(e){n=jQuery.extend(true,{},e);delete n.type;delete n.analyticalConfigurationLocation;delete n.applicationMessageDefinitionLocation;delete n.textResourceLocations;delete n.persistence}var p=a.applicationConfiguration;i(p);var u=a.applicationConfiguration.textResourceLocations;r=a.applicationConfiguration.persistence;if(!e.functions.isUsingCloudFoundryProxy()){P(r);if(!r.path.entitySet){r.path.entitySet=sap.apf.core.constants.entitySets.analysisPath}}if(a.applicationConfiguration.smartBusiness){c=a.applicationConfiguration.smartBusiness;C(c)}var f;var l;var d;for(d in sap.apf.core.constants.resourceLocation){if(!sap.apf.core.constants.resourceLocation.hasOwnProperty(d)){continue}if(d===sap.apf.core.constants.resourceLocation.analyticalConfigurationLocation&&t){continue}if(p[d]!==undefined){l=p[d]}else if(u[d]!==undefined){l=u[d]}else{continue}if(e.manifests){s.setItem(d,l)}else if(d===sap.apf.core.constants.resourceLocation.apfUiTextBundle||e.instances.fileExists.check(l,true)){s.setItem(d,l)}else if(!t){f=o.createMessageObject({code:"5059",aParameters:[l,d]});b(f)}}}function b(e){o.putMessage(e)}function M(){var a;var i;var o;jQuery.when(p).done(function(){a=t.getResourceLocation(sap.apf.core.constants.resourceLocation.apfUiTextBundle);i=t.getResourceLocation(sap.apf.core.constants.resourceLocation.applicationUiTextBundle);o=t.getResourceLocation(sap.apf.core.constants.resourceLocation.applicationMessageTextBundle);e.functions.initTextResourceHandlerAsPromise(a,i,o).done(function(){e.corePromise.resolve()})})}x();if(e.constructors&&e.constructors.ProxyForAnalyticalConfiguration){l=e.constructors.ProxyForAnalyticalConfiguration}else if(e.functions.isUsingCloudFoundryProxy()){l=sap.apf.cloudFoundry.RuntimeProxy}else if(d()){l=sap.apf.core.LayeredRepositoryProxy}else{l=sap.apf.core.OdataProxy}if(e.manifests&&e.manifests.manifest){S()}if(e.corePromise){M()}}c("sap.apf.core.ResourcePathHandler",f);return f});
//# sourceMappingURL=resourcePathHandler.js.map