/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
sap.ui.define(["sap/apf/utils/utils","sap/apf/utils/filter","sap/apf/utils/hashtable","sap/apf/core/utils/checkForTimeout","sap/apf/core/utils/uriGenerator","sap/apf/core/utils/fileExists","sap/apf/core/utils/annotationHandler","sap/apf/core/utils/filter","sap/apf/core/messageHandler","sap/apf/core/path","sap/apf/core/persistence","sap/apf/core/metadataFactory","sap/apf/core/textResourceHandler","sap/apf/core/configurationFactory","sap/apf/core/sessionHandler","sap/apf/core/resourcePathHandler","sap/apf/core/constants","sap/apf/cloudFoundry/analysisPathProxy","sap/apf/cloudFoundry/ajaxHandler","sap/ui/comp/smartfilterbar/ControlConfiguration","sap/apf/core/metadataProperty","sap/apf/core/metadataFacade","sap/apf/core/metadata","sap/apf/core/readRequestByRequiredFilter","sap/apf/core/ajax","sap/apf/core/odataRequest","sap/apf/core/entityTypeMetadata","sap/apf/core/readRequest","sap/ui/model/odata/v2/ODataModel","sap/ui/thirdparty/jquery"],function(t,e,a,n,r,s,i,o,c,u,f,p,l,g,d,h,m,y,v,F,P,S,x,C,A,H,T,M,R,jQuery){"use strict";p=p||sap.apf.core.MetadataFactory;l=l||sap.apf.core.TextResourceHandler;g=g||sap.apf.core.ConfigurationFactory;d=d||sap.apf.core.SessionHandler;h=h||sap.apf.core.ResourcePathHandler;function b(c){var p=this;var l;var g,d,h;var y=c.instances.messageHandler;var v=c.instances.startParameter;c.constructors=c.constructors||{};var F=c.functions&&c.functions.checkForTimeout||n;var A={instances:{messageHandler:y,coreApi:this},constructors:{Request:c.constructors.Request},exits:{binding:{afterGetFilter:c.exits&&c.exits.binding&&c.exits.binding.afterGetFilter},path:{beforeAddingToCumulatedFilter:c.exits&&c.exits.path&&c.exits.path.beforeAddingToCumulatedFilter}},functions:c.functions};var H;var T;var M;var b;var j;var E;var w;var B;var D;var k;var q=c&&c.instances&&c.instances.datajs||OData;this.destroy=function(){j.destroy()};this.ajax=function(t){var e=jQuery.extend(true,{},t);e.functions=e.functions||{};e.functions.getSapSystem=v.getSapSystem;if(c.functions&&c.functions.ajax){e.functions.ajax=c.functions.ajax}e.instances=e.instances||{};e.instances.messageHandler=y;return sap.apf.core.ajax(e)};this.odataRequest=function(t,e,a,n){var r={instances:{datajs:q},functions:{getSapSystem:v.getSapSystem}};var s=c&&c.functions&&c.functions.odataRequest||sap.apf.core.odataRequestWrapper;s(r,t,e,a,n)};this.getStartParameterFacade=function(){return v};this.getMessageHandler=function(){return y};this.putMessage=function(t){return y.putMessage(t)};this.check=function(t,e,a){return y.check(t,e,a)};this.createMessageObject=function(t){return y.createMessageObject(t)};this.activateOnErrorHandling=function(t){y.activateOnErrorHandling(t)};this.setCallbackForMessageHandling=function(t){y.setMessageCallback(t)};this.getLogMessages=function(){return y.getLogMessages()};this.checkForTimeout=function(t){var e=F(t);if(e){y.putMessage(e)}return e};this.getUriGenerator=function(){return r};this.getMetadata=function(t){return T.getMetadata(t)};this.getMetadataFacade=function(){return T.getMetadataFacade()};this.getEntityTypeMetadata=function(t,e){return T.getEntityTypeMetadata(t,e)};this.loadApplicationConfig=function(t){H.loadConfigFromFilePath(t)};this.loadTextElements=function(t){M.loadTextElements(t)};this.registerTextWithKey=function(t,e){M.registerTextWithKey(t,e)};this.getApplicationConfigProperties=function(){return H.getConfigurationProperties()};this.getResourceLocation=function(t){return H.getResourceLocation(t)};this.getPersistenceConfiguration=function(){return H.getPersistenceConfiguration()};this.getCategories=function(){return b.getCategories()};this.existsConfiguration=function(t){return b.existsConfiguration(t)};this.getStepTemplates=function(){return b.getStepTemplates()};this.getConfigurationObjectById=function(t){return b.getConfigurationById(t)};this.registerSmartFilterBarInstance=function(t){if(!k){k=jQuery.Deferred()}k.resolve(t)};this.getSmartFilterBarAsPromise=function(){if(!k){k=jQuery.Deferred()}this.getSmartFilterBarConfigurationAsPromise().done(function(t){if(!t){k.resolve(null)}});return k};this.getSmartFilterBarConfigurationAsPromise=function(){return b.getSmartFilterBarConfiguration()};this.getSmartFilterBarPersistenceKey=function(t){return"APF"+b.getConfigHeader().AnalyticalConfiguration+t};this.getSmartFilterbarDefaultFilterValues=function(){var t=jQuery.Deferred();var e=[];c.functions.getCombinedContext().done(function(n){n.getProperties().forEach(function(t){var r={key:t,visibleInAdvancedArea:true,defaultFilterValues:a(n,t)};e.push(new sap.ui.comp.smartfilterbar.ControlConfiguration(r))});t.resolve(e)});return t;function a(t,e){var a=t.getFilterTermsForProperty(e);var n=[];a.forEach(function(t){var e=new sap.ui.comp.smartfilterbar.SelectOption({low:t.getValue(),operator:t.getOp(),high:t.getHighValue(),sign:"I"});n.push(e)});return n}};this.getReducedCombinedContext=function(){var t=jQuery.Deferred();c.functions.getCombinedContext().done(function(e){var a=p.getSmartFilterBarAsPromise();a.done(function(a){if(!a){t.resolve(e);return}var n=new o(c.instances.messageHandler);var r=a.getFilters();r.forEach(function(t){n.addAnd(o.transformUI5FilterToInternal(c.instances.messageHandler,t))});t.resolve(e.removeTermsByProperty(n.getProperties()))})});return t};this.getFacetFilterConfigurations=function(){return b.getFacetFilterConfigurations()};this.getNavigationTargets=function(){return b.getNavigationTargets()};this.createStep=function(t,e,a){var n;y.check(t!==undefined&&typeof t==="string"&&t.length!==0,"sStepID is  unknown or undefined");n=b.createStep(t,a);j.addStep(n,e);return n};this.getSteps=function(){return j.getSteps()};this.moveStepToPosition=function(t,e,a){j.moveStepToPosition(t,e,a)};this.updatePath=function(t,e){j.update(t,e)};this.removeStep=function(t,e){j.removeStep(t,e)};this.resetPath=function(){if(j){j.destroy()}j=new u.constructor(A)};this.stepIsActive=function(t){return j.stepIsActive(t)};this.isApfStateAvailable=function(){return E.isApfStateAvailable()};this.storeApfState=function(){E.storeApfState()};this.restoreApfState=function(){return E.restoreApfState()};this.serialize=function(){var t=j.serialize();p.getSmartFilterBarAsPromise().done(function(e){if(e){t.smartFilterBar=e.fetchVariant()}});return t};this.deserialize=function(t){if(t.smartFilterBar){if(!k){k=jQuery.Deferred()}k.done(function(e){e._apfOpenPath=true;e.applyVariant(t.smartFilterBar);e.clearVariantSelection();e.fireFilterChange()})}j.deserialize(t)};this.getTextNotHtmlEncoded=function(t,e){return M.getTextNotHtmlEncoded(t,e)};this.getTextHtmlEncoded=function(t,e){return M.getTextHtmlEncoded(t,e)};this.isInitialTextKey=function(t){return t===m.textKeyForInitialText};this.getMessageText=function(t,e){return M.getMessageText(t,e)};this.getXsrfToken=function(t){return E.getXsrfToken(t)};this.setDirtyState=function(t){E.setDirtyState(t)};this.isDirty=function(){return E.isDirty()};this.setPathName=function(t){E.setPathName(t)};this.getPathName=function(){return E.getPathName()};this.getCumulativeFilter=function(){return c.functions.getCumulativeFilter()};this.createReadRequest=function(t){var e=b.createRequest(t);var a;if(typeof t==="string"){a=b.getConfigurationById(t)}else{a=t}return new sap.apf.core.ReadRequest(A,e,a.service,a.entityType)};this.createReadRequestByRequiredFilter=function(t){var e=b.createRequest(t);var a;if(typeof t==="string"){a=b.getConfigurationById(t)}else{a=t}return new C(A,e,a.service,a.entityType)};this.loadMessageConfiguration=function(t,e){y.loadConfig(t,e)};this.loadAnalyticalConfiguration=function(t){b.loadConfig(t)};this.savePath=function(t,e,a,n){var r;var s;var i;var o;if(typeof t==="string"&&typeof e==="string"&&typeof a==="function"){r=t;s=e;i=a;o=n;this.setPathName(s);w.modifyPath(r,s,i,o)}else if(typeof t==="string"&&typeof e==="function"){s=t;i=e;o=a;this.setPathName(s);w.createPath(s,i,o)}else{y.putMessage(y.createMessageObject({code:"5027",aParameters:[t,e,a]}))}};this.readPaths=function(t){w.readPaths(t)};this.openPath=function(t,e){function a(t,a,n){if(!n){p.setPathName(t.path.AnalysisPathName)}e(t,a,n)}return w.openPath(t,a)};this.deletePath=function(t,e){w.deletePath(t,e)};this.createFilter=function(t){return new e(y,t)};this.getActiveStep=function(){return j.getActiveSteps()[0]};this.getCumulativeFilterUpToActiveStep=function(){return j.getCumulativeFilterUpToActiveStep()};this.setActiveStep=function(t){j.makeStepActive(t);var e=j.getActiveSteps();var a;for(a=0;a<e.length;++a){j.makeStepInactive(e[a])}return j.makeStepActive(t)};this.createFirstStep=function(t,e,a){var n=false;var r;r=p.getStepTemplates();r.forEach(function(e){n=e.id===t?true:n});if(!n){y.putMessage(y.createMessageObject({code:"5036",aParameters:[t]}))}else{p.createStep(t,a,e)}};this.getFunctionCreateRequest=function(){return b.createRequest};this.getAnnotationsForService=function(t){return B.getAnnotationsForService(t)};this.checkAddStep=function(t){return j.checkAddStep(t)};this.getPathFilterInformation=function(){return j.getFilterInformation()};this.getGenericExit=function(t){if(c&&c.exits&&c.exits[t]&&typeof c.exits[t]==="function"){return c.exits[t]}return undefined};this.getComponent=function(){return c&&c.instances&&c.instances.component};M=new(c.constructors.TextResourceHandler||sap.apf.core.TextResourceHandler)(A);y.setTextResourceHandler(M);if(c.manifests){A.manifests=c.manifests}D=new(c.constructors.FileExists||s)({functions:{ajax:p.ajax,getSapSystem:v.getSapSystem}});var I={manifests:c.manifests,functions:{getSapSystem:v.getSapSystem,getComponentNameFromManifest:t.getComponentNameFromManifest,getODataPath:r.getODataPath,getBaseURLOfComponent:r.getBaseURLOfComponent,addRelativeToAbsoluteURL:r.addRelativeToAbsoluteURL},instances:{fileExists:D}};B=new(c.constructors.AnnotationHandler||i.constructor)(I);b=new(c.constructors.ConfigurationFactory||sap.apf.core.ConfigurationFactory)(A);var O={constructors:{EntityTypeMetadata:sap.apf.core.EntityTypeMetadata,Hashtable:c.constructors.Hashtable||a,Metadata:c.constructors.Metadata||x,MetadataFacade:c.constructors.MetadataFacade||S,MetadataProperty:c.constructors.MetadataProperty||P,ODataModel:c.constructors.ODataModel||R},instances:{messageHandler:A.instances.messageHandler,coreApi:p,annotationHandler:B},functions:{getServiceDocuments:b.getServiceDocuments,getSapSystem:v.getSapSystem}};T=new(c.constructors.MetadataFactory||sap.apf.core.MetadataFactory)(O);j=new(c.constructors.Path||u.constructor)(A);E=new(c.constructors.SessionHandler||sap.apf.core.SessionHandler)(A);if(c.functions&&c.functions.isUsingCloudFoundryProxy){l=c.functions.isUsingCloudFoundryProxy}else{l=function(){return false}}if(l()){g={instances:{messageHandler:y},functions:{coreAjax:this.ajax}};d=c.constructors.AjaxHandler||sap.apf.cloudFoundry.AjaxHandler;h=new d(g)}var N={instances:{messageHandler:y,coreApi:this},functions:{getComponentName:c.functions&&c.functions.getComponentName},manifests:c.manifests};if(c.constructors.Persistence){N.instances.ajaxHandler=h;w=new c.constructors.Persistence(N)}else if(l()){N.instances.ajaxHandler=h;w=new sap.apf.cloudFoundry.AnalysisPathProxy(N)}else{w=new f.constructor(N)}var U={instances:{coreApi:p,messageHandler:A.instances.messageHandler,fileExists:D},functions:{checkForTimeout:F,initTextResourceHandlerAsPromise:M.loadResourceModelAsPromise,isUsingCloudFoundryProxy:l},corePromise:c.corePromise,manifests:c.manifests};if(c.constructors&&c.constructors.ProxyForAnalyticalConfiguration){U.constructors={ProxyForAnalyticalConfiguration:c.constructors.ProxyForAnalyticalConfiguration}}H=new(c.constructors.ResourcePathHandler||sap.apf.core.ResourcePathHandler)(U);if(c&&c.coreProbe){c.coreProbe({coreApi:this,startParameter:v,resourcePathHandler:H,textResourceHandler:M,configurationFactory:b,path:j,sessionHandler:E,persistence:w,fileExists:D,corePromise:c.corePromise})}}sap.apf=sap.apf||{};sap.apf.core=sap.apf.core||{};sap.apf.core.Instance=b;return{constructor:b}});
//# sourceMappingURL=instance.js.map