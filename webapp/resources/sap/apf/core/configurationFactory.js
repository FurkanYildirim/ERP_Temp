/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
sap.ui.define(["sap/apf/core/step","sap/apf/core/hierarchicalStep","sap/apf/core/request","sap/apf/utils/hashtable","sap/apf/core/binding","sap/apf/core/representationTypes","sap/apf/core/constants","sap/apf/utils/exportToGlobal","sap/apf/utils/utils","sap/ui/thirdparty/jquery"],function(e,t,n,s,a,r,i,o,c,jQuery){"use strict";function f(e){var t=this;var n;var a=false;var r=jQuery.Deferred();var i=new s(e.instances.messageHandler);var o=function(t){e.instances.messageHandler.check(t!==undefined&&t.hasOwnProperty("id")!==false,"oItem is undefined or property 'id' is missing",sap.apf.core.constants.message.code.errorCheckConfiguration);if(!i){i=new s(e.instances.messageHandler)}var n=i.setItem(t.id,t);e.instances.messageHandler.check(n===undefined,"Configuration includes duplicated identifiers (IDs): "+t.id+"",sap.apf.core.constants.message.code.errorCheckConfigurationWarning)};var f=function(t){var n=[];if(!a&&r.state()==="pending"){e.instances.messageHandler.putMessage(e.instances.messageHandler.createMessageObject({code:"5020"}))}if(i.getNumberOfItems()!==0){i.each(function(e,s){if(s.type===t){n.push(s)}});return n}return n};function u(t){if(!sap.apf.core.constants.configurationObjectTypes.hasOwnProperty(t.type)){e.instances.messageHandler.putMessage(e.instances.messageHandler.createMessageObject({code:"5033",aParams:[t.type]}))}if(t.type===sap.apf.core.constants.configurationObjectTypes.facetFilter&&!t.property){e.instances.messageHandler.putMessage(e.instances.messageHandler.createMessageObject({code:"5034"}))}i.setItem(t.id,t)}function p(e){if(e.type===undefined){e.type="step"}o(e)}function d(t){e.instances.messageHandler.check(t!==undefined&&t instanceof Array!==false,"aSteps is missing or not an Array",sap.apf.core.constants.message.code.errorCheckConfiguration);t.forEach(function(e){p(e)})}function g(e){if(e.type===undefined){e.type="request"}if(e.entitySet){e.entityType=e.entitySet;delete e.entitySet}o(e)}function l(e){if(e.type===undefined){e.type="navigationTarget"}o(e)}function h(t){e.instances.messageHandler.check(t!==undefined&&t instanceof Array!==false,"aRequests is missing or not an Array",sap.apf.core.constants.message.code.errorCheckConfiguration);t.forEach(function(e){g(e)})}function y(t){function n(){var n=new s(e.instances.messageHandler);t.representations.forEach(function(s){if(!(s.id&&typeof s.id==="string")){e.instances.messageHandler.putMessage(e.instances.messageHandler.createMessageObject({code:"5028",aParameters:[t.id]}))}if(n.setItem(s.id,s.id)){e.instances.messageHandler.putMessage(e.instances.messageHandler.createMessageObject({code:"5029",aParameters:[t.id]}))}})}if(t.type===undefined){t.type="binding"}e.instances.messageHandler.check(t.id!==undefined,"binding has no id");e.instances.messageHandler.check(t.representations!==undefined&&t.representations instanceof Array!==false,"representations for binding "+t.id+" not defined",sap.apf.core.constants.message.code.errorCheckConfiguration);n();o(t)}function m(t){e.instances.messageHandler.check(t!==undefined&&t instanceof Array!==false,"aBindings is missing or not an Array",sap.apf.core.constants.message.code.errorCheckConfiguration);t.forEach(function(e){y(e)})}function v(t){e.instances.messageHandler.check(t!==undefined&&t instanceof Array!==false,"navigationTarget is missing or not an Array",sap.apf.core.constants.message.code.errorCheckConfiguration);t.forEach(function(e){l(e)})}function H(e){i.setItem("configHeader",e)}function C(e){if(e.type===undefined){e.type="category"}o(e)}function b(n){e.instances.messageHandler.check(n!==undefined&&n instanceof Array!==false,"aCategories is missing or not an Array",sap.apf.core.constants.message.code.errorCheckConfiguration);n.forEach(function(n){var s=n.steps;e.instances.messageHandler.check(s!==undefined&&s instanceof Array!==false,"steps for category "+n.id+" are missing or not an Array",sap.apf.core.constants.message.code.errorCheckConfiguration);s.forEach(function(s){e.instances.messageHandler.check(s.type&&(s.type==="step"||s.type==="hierarchicalStep")&&s.id,"step with wrong format assigned to category '"+n.id+"'");e.instances.messageHandler.check(t.existsConfiguration(s.id),"step with id '"+s.id+"' which is assigned to category '"+n.id+"' does not exist")});C(n)})}function k(e){var t=false;var n=sap.apf.core.representationTypes();n.forEach(function(n){if(e===n.id){t=true}});return t}function T(t){var n;if(t.type===undefined){t.type="representationType"}if(!k(t.id)){n=c.extractFunctionFromModulePathString(t.constructor);if(!jQuery.isFunction(n)){e.instances.messageHandler.putMessage(e.instances.messageHandler.createMessageObject({code:"5030",parameters:[t.id]}))}}o(t)}function F(t){e.instances.messageHandler.check(t!==undefined&&t instanceof Array!==false,"aRepresentationInfo is missing or not an Array",sap.apf.core.constants.message.code.errorCheckConfiguration);t.forEach(function(e){T(e)})}function I(e){if(e.type===undefined){e.type="smartFilterBar"}u(e)}function S(e){if(e.type===undefined){e.type="facetFilter"}u(e)}function A(t){e.instances.messageHandler.check(t!==undefined&&t instanceof Array!==false,"Facet filter configuration is missing or not an Array",sap.apf.core.constants.message.code.errorCheckConfiguration);if(t.length===0){i.setItem(sap.apf.core.constants.existsEmptyFacetFilterArray,true);return}t.forEach(S)}function w(t,s,r,o){var f,u,p;function d(e){return e.alias||e.property}function g(e){var t=e.preselectionDefaults&&e.preselectionDefaults.length>0;var n=e.valueList&&e.valueList.length>0;return t||n}function l(e,t,n,s,a){e.metadataProperty=t;S(e);w(n,s,r,a)}function h(e,t){if(c.isPropertyTypeWithDateSemantics(t)){e.preselectionDefaults=c.convertDateListToInternalFormat(e.preselectionDefaults,t);e.valueList=c.convertDateListToInternalFormat(e.valueList,t)}}if(s===t.length){r.resolve();a=false;return}u=t[s];s++;p=d(u);n=n||e.instances.coreApi.getMetadataFacade();var y=o&&Array.prototype.indexOf.call(o,p)>-1;if(y&&g(u)){if(u.valueHelpRequest||u.filterResolutionRequest){if(u.valueHelpRequest){f=i.getItem(u.valueHelpRequest)}else if(u.filterResolutionRequest){f=i.getItem(u.filterResolutionRequest)}n.getPropertyMetadataByEntitySet(f.service,f.entityType,p).done(function(e){h(u,e);l(u,e,t,s,o)})}else{n.getProperty(p).done(function(e){h(u,e);l(u,e,t,s,o)})}}else if(y){if(u.valueHelpRequest||u.filterResolutionRequest){if(u.valueHelpRequest){f=i.getItem(u.valueHelpRequest)}else if(u.filterResolutionRequest){f=i.getItem(u.filterResolutionRequest)}n.getPropertyMetadataByEntitySet(f.service,f.entityType,p).done(function(e){l(u,e,t,s,o)})}else{n.getProperty(p).done(function(e){l(u,e,t,s,o)})}}else{l(u,{},t,s,o)}}function R(t){var s=jQuery.Deferred();n=n||e.instances.coreApi.getMetadataFacade();e.instances.messageHandler.check(t!==undefined&&t instanceof Array!==false,"Facet filter configuration is missing or not an Array",sap.apf.core.constants.message.code.errorCheckConfiguration);if(t.length===0){i.setItem(sap.apf.core.constants.existsEmptyFacetFilterArray,true);s.resolve();return s.promise()}a=true;n.getAllProperties(function(e){w(t,0,s,e)});return s.promise()}function q(e){F(e)}function M(t,n){function s(t,n){var s=n.getConfigurationById(t.binding).representations;if(s){return s}e.instances.messageHandler.check(false,'Binding of step with ID "'+t.id+'" does not contain any representations.',sap.apf.core.constants.message.code.errorCheckConfigurationWarning)}function a(t,n){var a;var r=[];if(t.binding){a=s(t,n);a.forEach(function(e){var t=jQuery.extend(true,{},n.getConfigurationById(e.representationTypeId));t.representationId=e.id;t.representationLabel=e.label;t.parameter=jQuery.extend(true,{},e.parameter);r.push(t)});return r}e.instances.messageHandler.check(false,'Step with ID "'+t.id+'" does not contain any binding references.',sap.apf.core.constants.message.code.errorCheckConfigurationWarning)}var r=jQuery.extend(true,{},t);var i=a(t,n);delete r.request;delete r.binding;delete r.thumbnail;delete r.longTitle;r.type="stepTemplate";r.getRepresentationInfo=function(){var e=jQuery.extend(true,[],i);e.forEach(function(e){delete e.id;delete e.type;delete e.constructor});return e};return r}var E=function(e,t){var n=this;this.type=e.type;this.id=e.id;this.label=e.label;this.stepTemplates=[];e.steps.forEach(function(e){var s=t.getConfigurationById(e.id);n.stepTemplates.push(new M(s,t))});return this};var P=function(e,t){this.type="thumbnail";if(e===undefined){return this}this.leftUpper=t.createLabel(e.leftUpper);this.rightUpper=t.createLabel(e.rightUpper);this.leftLower=t.createLabel(e.leftLower);this.rightLower=t.createLabel(e.rightLower);this.altTitle=t.createLabel(e.altTitle);return this};this.createThumbnail=function(e){return new P(e,this)};function B(e){this.type="label";this.kind=e.kind;if(this.kind==="text"){this.file=e.file;this.key=e.key}else if(this.kind==="property"){this.property=e.property}else if(this.kind==="sapLabel"){this.labelOf=e.labelOf}}this.createLabel=function(e){return new B(e,this)};this.loadConfig=function(t,n){i=new s(e.instances.messageHandler);if(t.applicationTitle){i.setItem("applicationTitle",t.applicationTitle)}var a={constructors:{Hashtable:s},instances:{messageHandler:e.instances.messageHandler}};c.migrateConfigToCategoryStepAssignment(t,a);var o=sap.apf.core.representationTypes();q(o);d(t.steps);b(t.categories);h(t.requests);m(t.bindings);if(t.representationTypes){F(t.representationTypes)}if(t.smartFilterBar){I(t.smartFilterBar)}if(t.facetFilters){if(n){A(t.facetFilters);r.resolve()}else{R(t.facetFilters).done(function(){r.resolve()})}}else{r.resolve()}if(t.navigationTargets){v(t.navigationTargets)}if(t.configHeader){H(t.configHeader)}return r};this.getConfigurationById=function(e){return i.getItem(e)};this.existsConfiguration=function(e){return i.hasItem(e)};this.getServiceDocuments=function(){var t=f("request");var n=[];t.forEach(function(e){n.push(e.service)});return c.eliminateDuplicatesInArray(e.instances.messageHandler,n)};this.getNavigationTargets=function(){var e=f("navigationTarget");return jQuery.extend(true,[],e)};this.getStepTemplates=function(){var e=[];var n=f("step");n=jQuery.merge(n,f("hierarchicalStep"));n.forEach(function(n,s){e[s]=new M(n,t)});return e};this.getSmartFilterBarConfiguration=function(){var e=jQuery.Deferred();var t;r.done(function(){t=f("smartFilterBar")[0];if(typeof t==="object"&&t.service&&(t.entityType||t.entitySet)){e.resolve(jQuery.extend(true,{},t))}else{e.resolve()}});return e.promise()};this.getFacetFilterConfigurations=function(){var t=f("facetFilter");var n,s,a;var r=jQuery.extend(true,[],t);for(a=0;a<r.length;a++){s=r[a];if(t[a].metadataProperty&&t[a].metadataProperty.clone){s.metadataProperty=t[a].metadataProperty.clone()}if(s.preselectionFunction){n=c.extractFunctionFromModulePathString(s.preselectionFunction);if(typeof n!=="function"){e.instances.messageHandler.putMessage(e.instances.messageHandler.createMessageObject({code:"5035",parameters:[s.id]}));s.preselectionFunction=undefined}else{s.preselectionFunction=n}}}return r};this.getCategories=function(){var e=f("category");var n=[];e.forEach(function(e,s){n[s]=new E(e,t)});return n};this.getConfigHeader=function(){return i.getItem("configHeader")};this.createStep=function(t,n){var s=this.getConfigurationById(t);e.instances.messageHandler.check(s!==undefined&&(s.type==="step"||s.type==="hierarchicalStep"),"Error - referenced object is undefined or has not type step",sap.apf.core.constants.message.code.errorCheckConfiguration);e.instances.messageHandler.check(sap.apf.core.Step!==undefined,"Step must be defined ",sap.apf.core.constants.message.code.errorCheckConfiguration);e.instances.messageHandler.check(typeof sap.apf.core.Step==="function","Step must be constructor function");if(s.type==="hierarchicalStep"){e.instances.messageHandler.check(typeof sap.apf.core.HierarchicalStep==="function","HierarchicalStep must be constructor function");return new sap.apf.core.HierarchicalStep(e.instances.messageHandler,s,this,n,e.instances.coreApi)}return new sap.apf.core.Step(e.instances.messageHandler,s,this,n,e.instances.coreApi)};this.createBinding=function(t,n,s,a){var r=this.getConfigurationById(t);e.instances.messageHandler.check(r!==undefined&&r.type==="binding","Error - oBindingConfig is undefined or has not type binding",sap.apf.core.constants.message.code.errorCheckConfiguration);r.oTitle=n;r.oLongTitle=s;return new sap.apf.core.Binding(e,r,this,a)};this.createRequest=function(n){if(n.entitySet){n.entityType=n.entitySet;delete n.entitySet}var s;var a;if(typeof n==="string"){a=t.getConfigurationById(n);if(!(a!==undefined&&a.type==="request")){s=e.instances.messageHandler.createMessageObject({code:"5004",aParameters:[n]});e.instances.messageHandler.putMessage(s);return undefined}}else{a=n;e.instances.messageHandler.check(a.type&&a.type==="request"&&a.service&&a.entityType,"Wrong request configuration when creating a new request");if(!a.id){s=e.instances.messageHandler.createMessageObject({code:"5004",aParameters:[n]});e.instances.messageHandler.putMessage(s);return undefined}}return new(e&&e.constructors&&e.constructors.Request||sap.apf.core.Request)(e,a)};if(e.constructors&&e.constructors.RegistryProbe){this.getRegistry=function(){return new e.constructors.RegistryProbe(i)}}}o("sap.apf.core.ConfigurationFactory",f);return f});
//# sourceMappingURL=configurationFactory.js.map