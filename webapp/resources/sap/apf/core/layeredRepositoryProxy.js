/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2018 SAP SE. All rights reserved
 */
sap.ui.define(["sap/apf/utils/utils","sap/apf/core/constants","sap/apf/utils/exportToGlobal","sap/apf/utils/hashtable","sap/apf/abap/LrepConnector","sap/apf/utils/parseTextPropertyFile","sap/ui/thirdparty/jquery"],function(e,n,a,t,i,r,jQuery){"use strict";function o(n,a){var i=a.instances.coreApi;var o;var s=a.instances.messageHandler;var c="sap/apf/dt";var f="text.properties";var u=new t(a.instances.messageHandler);var l=new t(a.instances.messageHandler);var p;var d=false;this.getConnector=function(){return o};this.readEntity=function(e,n,a,t,i,r,c){var f=a[0].value;var u=O(i);var l=[];var p=false;var d=1;var m=0;var v;var g;var h;var E;var P;var b;var x;var N;var j=T(r);var I;s.check(e==="configuration","layered repository proxy - only read entity of configuration supported");if(c&&c.noMetadata){o.getStaticResource(u,f,"apfconfiguration").then(function(e){h={Application:i};N=e.response;if(typeof N==="string"){h.SerializedAnalyticalConfiguration=N}else{h.SerializedAnalyticalConfiguration=JSON.stringify(N)}h.AnalyticalConfiguration=f;n(h,S())},function(e){n(undefined,S(),A({code:"5221",aParameters:[i,f]},e&&e.messages))});return}if(t===undefined||t.indexOf("SerializedAnalyticalConfiguration")>=0){p=true;if(j==="VENDOR"){var U={contentType:"application/json"};var D=[];D.push({name:"layer",value:j});D.push({name:"dt",value:"true"});var M="/sap/bc/lrep/content/"+u+"/"+f+".apfconfiguration";M+=o._buildParams(D);I=o.send(M,"GET",undefined,U)}else{I=o.getStaticResource(u,f,"apfconfiguration")}l.push(I)}else{d=0}v=y(i,f);if(v===undefined){var R=o.getFileAttributes(u,f,"apfconfiguration",j);l.push(R)}g=Promise.all(l);g.then(function(e){v=y(i,f);if(v===undefined){v=e[d].response}C(i,f,v);h=L(i,v);if(p){N=e[m].response;if(typeof N==="string"){h.SerializedAnalyticalConfiguration=N}else{h.SerializedAnalyticalConfiguration=JSON.stringify(N)}}h.AnalyticalConfiguration=f;if(t&&t.length!==0){P=t.length;b={};for(E=0;E<P;E++){x=t[E];b[x]=h[x]}h=b}n(h,S())},function(e){n(undefined,S(),A({code:"5221",aParameters:[i,f]},e&&e.messages))})};this.doChangeOperationsInBatch=function(n,a,t){function i(e,n){a(n)}var r,o;function s(){}b(t).then(function(){for(r=0;r<n.length;r++){o=n[r];o.application=t;if(o.method==="DELETE"&&o.entitySetName==="texts"){E(o,s)}else if(o.method==="POST"&&e.isValidPseudoGuid(o.data.TextElement)){x(o.data,s)}else{x(o.data,s)}}N(t,i,true)}).fail(function(e){a(e)})};this.readCollectionsInBatch=function(e,n){var a=e.length;var t=[];var i=0;function r(e){function r(r,o,s){if(s){n(undefined,s)}else{i++;t[e]=r;if(i===a){n(t)}}}return r}for(var o=0;o<a;o++){var s=e[o];this.readCollection(s.entitySetName,r(o),s.inputParameters,s.selectList,s.filter)}};this.readCollection=function(e,n,a,i,o,c){var f,l;var p;var d;if(c&&c.layer){d=c.layer}else{d="CUSTOMER"}var m=function(e,a){if(a&&(a==="error"||a==="timeout"||a==="abort"||a==="parsererror")){n(undefined,S(),A({code:"5222",aParameters:[l]},[a]));return}var i=new t(s);var o=[];var c=e&&e.response||e&&e.responseText||"";var f=r(c,{instances:{messageHandler:s}});var p,d;if(f.Messages.length>0){p=s.createMessageObject({code:"5416"});d=p;f.Messages.forEach(function(e){d.setPrevious(e);d=e})}i=new t(s);f.TextElements.forEach(function(e){if(e.TextElement){i.setItem(e.TextElement,e);o.push(e)}});u.setItem(l,i);n(o,S(),p)};if(e==="application"){s.check(!a&&!i&&!o,"unsupported parameters when calling readCollection for application");H(n,d)}else if(e==="texts"){f=o.getFilterTermsForProperty("Application");l=f[0].getValue();p=P(l,c);p.then(function(e){m(e)},function(e){n(undefined,S(),A({code:"5222",aParameters:[l]},e&&e.messages))})}else if(e==="configuration"){f=o.getFilterTermsForProperty("Application");l=f[0].getValue();j(l,n,i)}};this.remove=function(e,n,a,t,i,r){if(!r){r="CUSTOMER"}if(e==="application"){V(n,a,r)}else if(e==="configuration"){R(n,a,i,r)}else{s.check(false,"the remove operation on entity set "+e+" is currently not supported by the lrep proxy")}};this.create=function(e,n,a,t){if(e==="application"){F(n,a,t)}else if(e==="configuration"){M(n,a,t)}else if(e==="texts"){x(n,a)}else{s.check(false,"the create operation on entity set "+e+" is currently not supported by the lrep proxy")}};this.update=function(e,n,a){if(e==="configuration"){D(n,a)}else if(e==="application"){G(n,a)}else{s.check(false,"the update operation on entity set "+e+" is currently not supported by the lrep proxy")}};function m(e,n){var a={async:true,contentType:"application/json"};var t=[];t.push({name:"layer",value:e});t.push({name:"deep-read",value:true});t.push({name:"metadata",value:true});t.push({name:"type",value:n});var i="/sap/bc/lrep/content/"+c+"/";i+=o._buildParams(t);return o.send(i,"GET",undefined,a)}function v(e){var n=e.ns.split("/");return n[n.length-2]}function g(e,n){var a=undefined;e.metadata.forEach(function(e){if(e.name===n){a=e.value}});return a}this.readAllConfigurationsFromVendorLayer=function(){var n=jQuery.Deferred();var a=[];m("VENDOR","apf*").then(function(t){var i={};t.response.forEach(function(e){if(e.fileType&&e.fileType==="apfapplication"){i[v(e)]=g(e,"apfdt-applname")}});t.response.forEach(function(n){var t;var r;var o;if(n.fileType&&n.fileType==="apfconfiguration"){t=v(n);r=n.name;if(!(e.isValidPseudoGuid(t)&&e.isValidPseudoGuid(r))){return}o=g(n,"apfdt-configname");a.push({configurationText:o,applicationText:i[t],value:t+"."+r})}});n.resolve(a)},function(e){n.reject(A({code:"5231"},e&&e.messages))});return n.promise()};h();function h(){if(a.constructors&&a.constructors.LrepConnector){o=a.constructors.LrepConnector.createConnector()}else{o=sap.apf.abap.LrepConnector.createConnector()}if(!o._sClient){o._sClient=i.getStartParameterFacade().getSapClient()}}function y(e,n){var a=l.getItem(e);if(a===undefined){return undefined}n=a.getItem(n);return n}function C(e,n,a){var i=l.getItem(e);if(i===undefined){i=new t(s)}i.setItem(n,a);l.setItem(e,i)}function T(e){var n=e&&e.layer||"CUSTOMER";if(n==="ALL"){return undefined}return n}function A(e,n){var a=s.createMessageObject(e);var t="";if(n){n.forEach(function(e){t=t+e+" "});a.setPrevious(s.createMessageObject({code:5220,aParameters:[t]}))}return a}function S(){return{}}function O(e){return c+"/"+e}function E(e,n){var a=e.application;var t=e.inputParameters[0].value;var i;b(a).done(function(){i=u.getItem(a);i.removeItem(t);n(e,S())}).fail(function(e){n(undefined,S(),e)})}function P(e,n){var a;var t=[];var i="/sap/bc/lrep/content/";var r=T(n);i+=c+"/"+e+"/"+f;if(r){t.push({name:"layer",value:r})}a={contentType:"text/plain"};i+=o._buildParams(t);return o.send(i,"GET",undefined,a)}function b(e){var n=jQuery.Deferred();var a;var i=u.getItem(e);var o=function(a){var o=a&&a.response||a&&a.responseText||"";var c=r(o,{instances:{messageHandler:s}});i=new t(s);c.TextElements.forEach(function(e){if(e.TextElement){i.setItem(e.TextElement,e)}});u.setItem(e,i);n.resolve({})};if(i===undefined){a=P(e);a.then(function(e){o(e)},function(a){n.reject(A({code:"5222",aParameters:[e]},a&&a.messages))})}else{n.resolve({})}return n.promise()}function x(n,a){var t=n.Application;if(n.TextElement===undefined||!e.isValidGuid(n.TextElement)){n.TextElement=e.createPseudoGuid()}b(t).done(function(){var e=u.getItem(t);e.setItem(n.TextElement,n);a(n,S())}).fail(function(e){a(undefined,S(),e)})}function N(n,a,t){var i=O(n);var c;function f(){var t=e.renderHeaderOfTextPropertyFile(n,s);t=t+e.renderTextEntries(c,s);var r=o.upsert(i,"text","properties","CUSTOMER",t,"text/plain");r.then(function(){a(S())},function(e){a(S(),A({code:"5230",aParameters:[n]},e&&e.messages))})}c=u.getItem(n);if(!c){a(S());return}if(t){f()}else{var l=P(n);l.then(function(e){var n=e&&e.response||"";var a=r(n,{instances:{messageHandler:s}});a.TextElements.forEach(function(e){if(e.TextElement){c.setItem(e.TextElement,e)}});f()},function(e){a(S(),A({code:"5222",aParameters:[n]},e&&e.messages))})}}function j(e,n,a){var t=[];var i=O(e);var r=o._buildParams([{name:"layer",value:"CUSTOMER"},{name:"metadata",value:"true"},{name:"type",value:"apfconfiguration"}]);var s=o.send("/sap/bc/lrep/content/"+i+r);s.then(function(r){var s=r.response;s.forEach(function(n){if(n.fileType==="apfconfiguration"){n.metadata.forEach(function(a){if(a.name==="apfdt-configname"){t.push({AnalyticalConfiguration:n.name,Application:e,AnalyticalConfigurationName:a.value})}})}});if(a&&a.indexOf("SerializedAnalyticalConfiguration")>=0){var c=[];t.forEach(function(e){var n=jQuery.Deferred();c.push(n);o.getStaticResource(i,e.AnalyticalConfiguration,"apfconfiguration").then(function(a){if(a.response){e.SerializedAnalyticalConfiguration=JSON.stringify(a.response);n.resolve()}else{n.reject()}},function(e){n.reject(e)})});jQuery.when.apply(jQuery,c).then(function(){n(t,S())},function(a){n([],S(),A({code:"5223",aParameters:[e]},a&&a.messages))})}else{n(t,S())}},function(a){n([],S(),A({code:"5223",aParameters:[e]},a&&a.messages))})}function I(){var e=jQuery.Deferred();var n=[];if(d){e.resolve(p)}else{n.push({name:"dt",value:false});var a="/sap/bc/lrep/content/sap/ui/fl/settings/main.flsettings";a+=o._buildParams(n);var t=o.send(a,"GET",undefined);t.then(function(n){var a=n&&n.response||{};d=true;if(a.isAtoEnabled===true){p="ATO_NOTIFICATION"}e.resolve(p)},function(n){e.reject(n)})}return e.promise()}function U(e,n,a,t){var i=t||"CUSTOMER";var r=O(e);var s=o.getFileAttributes(r,n,"apfconfiguration",i);s.then(function(t){var r=t.response;if(i==="CUSTOMER"){C(e,n,r);N(e,a)}else{a(S())}},function(t){a(S(),A({code:"5232",aParameters:[e,n]},t&&t.messages))})}function D(e,n,a){if(!a){a="CUSTOMER"}var t=e.Application;var i=e.AnalyticalConfiguration;var r=JSON.parse(e.SerializedAnalyticalConfiguration);var s=O(t);var c=I();c.then(function(c){var f=o.getStaticResource(s,"metadata","apfapplication");f.then(function(n){var f={Application:t,ApplicationName:n.response.ApplicationName,SemanticObject:n.response.SemanticObject,AnalyticalConfiguration:i,AnalyticalConfigurationName:e.AnalyticalConfigurationName,CreationUTCDateTime:e.CreationUTCDateTime,LastChangeUTCDateTime:e.LastChangeUTCDateTime};r=jQuery.extend(true,r,{configHeader:f});r=JSON.stringify(r);var u=o.upsert(s,i,"apfconfiguration",a,r,"application/json",c);return u},function(e){n(S(),A({code:"5233",aParameters:[t,i]},e&&e.messages))}).then(function(){U(t,i,n,a)},function(e){n(S(),A({code:"5233",aParameters:[t,i]},e&&e.messages))})},function(e){n(S(),A({code:"5224"},e&&e.messages))})}function M(n,a,t){var i=T(t);var r=n.Application;var s=n.AnalyticalConfiguration;if(s===undefined||!e.isValidGuid(s)){s=e.createPseudoGuid(32)}var c=JSON.parse(n.SerializedAnalyticalConfiguration);var f=O(r);var u=o.getStaticResource(f,"metadata","apfapplication");u.then(function(e){var t={Application:r,ApplicationName:e.response.ApplicationName,SemanticObject:e.response.SemanticObject,AnalyticalConfiguration:s,AnalyticalConfigurationName:c.analyticalConfigurationName,CreationUTCDateTime:n.CreationUTCDateTime,LastChangeUTCDateTime:n.LastChangeUTCDateTime};c=jQuery.extend(true,c,{configHeader:t});c=JSON.stringify(c);l(r,s,n.AnalyticalConfigurationName,c,a)},function(e){a(undefined,S(),A({code:"5223",aParameters:[r]},e&&e.messages))});function l(e,a,t,r,s){var c=O(e);var f=I();f.then(function(t){var f=o.upsert(c,a,"apfconfiguration",i,r,"application/json",t);f.then(function(){U(e,a,function(e,t){if(!t){s({AnalyticalConfiguration:a,AnalyticalConfigurationName:n.AnalyticalConfigurationName},S())}else{s(undefined,S(),t)}},i)},function(n){s(undefined,S(),A({code:"5226",aParameters:[e,a]},n&&n.messages))})},function(e){s(undefined,S(),A({code:"5224"},e&&e.messages))})}}function R(e,n,a,t){var i=e[0].value;s.check(i!==undefined,"configuration may not be undefined");s.check(a!==undefined,"application of configuration not found");var r=O(a);I().then(function(e){var s=o.deleteFile(r,i,"apfconfiguration",t,e);s.then(function(){n(S())},function(e){n(S(),A({code:"5225",aParameters:[a,i]},e&&e.messages))})},function(e){n(S(),A({code:"5224"},e&&e.messages))})}function L(e,n){var a;var t={Application:e};var i,r;for(a=0;a<n.length;a++){i=n[a].name;r=n[a].value;if(i==="apfdt-applname"){i="ApplicationName"}else if(i==="createdAt"){i="CreationUTCDateTime"}else if(i==="createdBy"){i="CreatedByUser"}else if(i==="lastChangedAt"){i="LastChangeUTCDateTime"}else if(i==="lastChangedBy"){i="LastChangedByUser"}else if(i==="apfdt-configname"){i="AnalyticalConfigurationName"}else if(i==="size"||i==="layer"){continue}t[i]=r}return t}function F(n,a,i){s.check(n.ApplicationName!==undefined&&n.ApplicationName!=="","Valid application name is required");var r=n.Application;if(r===undefined||!e.isValidGuid(r)){r=e.createPseudoGuid(32)}var c=JSON.stringify({ApplicationName:n.ApplicationName,SemanticObject:n.SemanticObject,Application:r});var f=e.renderHeaderOfTextPropertyFile(r,s);var l=T(i);function p(e){a(undefined,S(),A({code:"5227"},e&&e.messages))}var d=O(r);var m=o.upsert(d,"metadata","apfapplication",l,c,"application/json");m.then(function(){var e=o.upsert(d,"text","properties",l,f,"text/plain");e.then(function(){u.setItem(r,new t(s));a({Application:r,ApplicationName:n.ApplicationName,SemanticObject:n.SemanticObject},S())},p)},p)}function G(e,n){s.check(e.ApplicationName!==undefined&&e.ApplicationName!=="","Valid application name is required");var a=e.Application;var t=JSON.stringify({ApplicationName:e.ApplicationName,SemanticObject:e.SemanticObject,Application:a});function i(e){n(undefined,A({code:"5228",aParameters:[a]},e&&e.messages))}var r=O(a);var c=o.upsert(r,"metadata","apfapplication","CUSTOMER",t,"application/json");c.then(function(){n({Application:a,ApplicationName:e.ApplicationName,SemanticObject:e.SemanticObject})},i)}function V(e,n,a){var t=e[0].value;function i(e){var a=z(e);n(S(),a)}var r=O(t);var s=o.listContent(r,a);s.then(function(e){var a=e.response;var t=[];a.forEach(function(e){if(e.fileType==="apfconfiguration"){I().then(function(n){t.push(o.deleteFile(r,e.name,e.fileType,e.layer,n))},function(e){n(S(),A({code:"5224"},e&&e.messages))})}else{t.push(o.deleteFile(r,e.name,e.fileType,e.layer))}});var i=Promise.all(t);return i},i).then(function(){n(S())},i)}function z(e){var n;if(e&&e.messageObject&&e.messageObject.getCode){n=e.messageObject}else if(e&&e.response&&e.response.statusCode&&e.response.statusCode>=400){n=s.createMessageObject({code:"11005",aParameters:[e.response.statusCode.toString(),e.response.statusText]})}else{n=s.createMessageObject({code:"5201",aParameters:e&&e.messages||[]})}return n}function H(n,a){var t=[];m(a,"apfapplication").then(function(a){var i=a.response;i.forEach(function(n){var a;var i;if(n.fileType&&n.fileType==="apfapplication"){a=v(n);if(!e.isValidPseudoGuid(a)){return}var r="";i=g(n,"apfdt-applname");t.push({Application:a,ApplicationName:i,SemanticObject:r})}});n(t,S())},i);function i(e){n(undefined,S(),A({code:"5229"},e&&e.messages))}}}a("sap.apf.core.LayeredRepositoryProxy",o);return o});
//# sourceMappingURL=layeredRepositoryProxy.js.map