sap.ui.define(["sap/apf/utils/trace","sap/apf/core/utils/filter","sap/apf/core/utils/areRequestOptionsEqual","sap/apf/utils/utils","sap/apf/utils/filter","sap/apf/utils/executeFilterMapping","sap/apf/core/constants","sap/apf/core/metadataProperty","sap/ui/thirdparty/jquery"],function(e,t,i,r,n,a,o,s,jQuery){"use strict";function l(t,i,n,o,s){t.check(i!==undefined,"Step: step configuration is missing");t.check(i.binding!==undefined,"No binding assigned to step "+i.id+" in analytical configuration",sap.apf.core.constants.message.code.errorCheckConfiguration);var l=sap.apf.core.constants.representationMetadata.labelDisplayOptions;var p=this;var u,f,d,g;var c={responseData:[]};var h=jQuery.extend(true,{},i);this.type="step";this.title=jQuery.extend(true,{},i.title);this.longTitle=undefined;if(i.longTitle){this.longTitle=jQuery.extend(true,{},i.longTitle)}this.thumbnail=jQuery.extend(true,{},i.thumbnail);this.categories=i.categories;this.destroy=function(){if(u){u.destroy()}f=undefined;d=undefined;g=undefined;u=undefined;p=undefined};this.getRequestConfiguration=function(){return n.getConfigurationById(i.request)};this.getAdditionalConfigurationProperties=function(){return h};this.update=function(t,r){var a;var o=this.getFilter();var l=!t.isEqual(d);var p=u.getRequestOptions(l);var c=!sap.apf.core.utils.areRequestOptionsEqual(g,p);var h=n.getConfigurationById(i.request);e.logCall("Step.update",", bFilterChanged",l,", bRequestOptionsChanged",c);s.getMetadata(h.service).then(function(n){e.log("update  -  in oCoreApi.getMetadata().then()");if(!o.isEmpty()&&!i.topNSettings&&u.getSelectedRepresentation().type==="TableRepresentation"){var s=o.getProperties()[0];var d=[s];var g=n.getPropertyMetadata(h.entityType,s)["sap:text"];if(g){d.push(g)}a={selectionFilter:o,requiredFilterProperties:d}}if(f&&(l||c)){e.log("update() - before sendGetInBatch");f.sendGetInBatch(t,r,p,a)}else{e.log("update() - no request, before callbackAfterRequest");r({},false)}},function(){e.log("update - then.reject() - before callbackAfterRequest");r({},false)});e.logReturn("update")};this.determineFilter=function(e,r){var o;var u;if(this.adjustCumulativeFilter){o=this.adjustCumulativeFilter(e)}if(y()&&this.getFilter().toUrlParam()){var f=n.getConfigurationById(i.filterMapping.requestForMappedFilter);f.selectProperties=i.filterMapping.target.slice();if(i.filterMapping.targetPropertyDisplayOption===l.TEXT||i.filterMapping.targetPropertyDisplayOption===l.KEY_AND_TEXT){s.getMetadata(f.service).done(function(e){var t=e.getPropertyMetadata(f.entityType,f.selectProperties[0]);if(t.text){f.selectProperties.push(t.text)}d.call(this,f)}.bind(this))}else{d.call(this,f)}}else{c.responseData=[];r(this.getFilter(),o)}function d(s){var l=n.createRequest(s);u=e.addAnd(this.getFilter());if(o){u=o.copy().addAnd(this.getFilter())}if(u.isEqual(c.mergedFilter)){r(c.mappedFilter,o)}else{a(u,l,i.filterMapping.target,g,t)}}function g(e,t,n){if(!t){if(i.filterMapping.keepSource==="true"){e=p.getFilter().addAnd(e)}c.mergedFilter=u;c.mappedFilter=e;c.responseData=n;r(e,o)}}};this.getBinding=function(){return u};this.getFilter=function(){return u.getFilter(this.getContextInfo())};this.getContextInfo=function(){var e=n.getConfigurationById(i.request);var t={entityType:e.entityType,service:e.service};return t};this.setData=function(e,t){var i=!t.isEqual(d);d=t.copy();g=jQuery.extend({},u.getRequestOptions(i));u.setData(e)};this.getRepresentationInfo=function(){return u.getRepresentationInfo()};this.getSelectedRepresentationInfo=function(){return u.getSelectedRepresentationInfo()};this.getSelectedRepresentation=function(){return u.getSelectedRepresentation()};this.setSelectedRepresentation=function(e){u.setSelectedRepresentation(e)};this.getFilterInformation=function(e,t){var a=jQuery.Deferred();var o;if(i.longTitle&&i.longTitle.key){o=s.getTextNotHtmlEncoded(i.longTitle.key)}else{o=s.getTextNotHtmlEncoded(i.title.key)}if(y()&&i.filterMapping.keepSource==="true"){jQuery.when(d(e,o),p(e,o)).then(function(e,t){a.resolve([e,t])})}else if(y()){jQuery.when(p(e,o)).then(function(e){a.resolve([e])})}else{jQuery.when(d(e,o)).then(function(e){a.resolve([e])})}return a;function p(){var e=jQuery.Deferred();var t;if(i.filterMapping.targetPropertyLabelKey){t=s.getTextNotHtmlEncoded(i.filterMapping.targetPropertyLabelKey)}var r=i.filterMapping.target[0];var a=n.getConfigurationById(i.filterMapping.requestForMappedFilter);f(r,a).done(function(i){g(e,r,i,t,a,true)});return e}function f(e,t){var n=jQuery.Deferred();s.getMetadata(t.service).done(function(a){var o;var p=new sap.apf.core.MetadataProperty(a.getPropertyMetadata(t.entityType,e));if(p.text){o=p.text}var u=[];var f=i.filterMapping.targetPropertyDisplayOption;var d=false;c.responseData.forEach(function(t){if(f===l.TEXT&&o){u.push({text:t[o]})}else if(f===l.KEY_AND_TEXT&&o){u.push({text:s.getTextNotHtmlEncoded("keyAndTextSelection",[t[o],r.convertToExternalFormat(t[e],p)])})}else{u.push({text:t[e]});d=true}});u=r.sortByProperty(u,"text",p);if(d===true){u.forEach(function(e){e.text=r.convertToExternalFormat(e.text,p)})}n.resolve(u)});return n}function d(){var e=jQuery.Deferred();var t;var r;var a=n.getConfigurationById(i.binding);var o=n.getConfigurationById(i.request);if(a.requiredFilters&&a.requiredFilters.length===1){t=a.requiredFilters[0];if(a.requiredFilterOptions&&a.requiredFilterOptions.fieldDesc){r=s.getTextNotHtmlEncoded(a.requiredFilterOptions.fieldDesc.key)}}g(e,t,u.getSortedSelections(),r,o,false);return e}function g(i,r,n,a,l,p){var u;var f;if(!a){u=s.getMetadata(l.service)}if(r){f=s.getMetadata(e.getRequestConfiguration().service)}jQuery.when(u,f).then(function(u,f){var d=false;var g;var c=e.getRequestConfiguration().entityType;var h;if(f){h=f.getFilterableProperties(c).concat(f.getParameterEntitySetKeyProperties(c))}if(!a&&u&&r){a=u.getPropertyMetadata(l.entityType,r)["sap:label"]}if(!r){d=true;g=s.getTextNotHtmlEncoded("noSelectionPossible")}else if(h.indexOf(r)===-1){d=true;g=s.getTextNotHtmlEncoded("filterNotApplicable")}else if(n.length===0){d=true;g=s.getTextNotHtmlEncoded("nothingSelected")}i.resolve({text:o,selectablePropertyLabel:a||r,filterValues:n,infoIcon:p,infoText:p?s.getTextNotHtmlEncoded("infoIconfilterMapping"):undefined,warningIcon:d,warningText:g,stepIndex:t})})}};this.serialize=function(){return{stepId:i.id,binding:u.serialize()}};this.deserialize=function(e){u.deserialize(e.binding);t.check(i.id,e.stepId,"sap.apf.core.step.deserialize inconsistent serialization data - id "+e.stepId);return this};this.getAssignedNavigationTargets=function(){return i.navigationTargets};v();function v(){u=n.createBinding(i.binding,undefined,undefined,o);delete h.binding;if(i.request!==undefined&&i.request!==""){f=n.createRequest(i.request);delete h.request}}function y(){if(i.filterMapping){if(i.filterMapping.requestForMappedFilter&&i.filterMapping.target instanceof Array&&i.filterMapping.keepSource){return true}t.putMessage(t.createMessageObject({code:"5104"}))}return false}}sap.apf.core.Step=l;return{constructor:l}},true);
//# sourceMappingURL=step.js.map