/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
sap.ui.define(["sap/apf/utils/utils","sap/apf/utils/hashtable","sap/ui/model/odata/v2/ODataModel","sap/ui/model/odata/ODataUtils"],function(e,t,r,a){"use strict";var n=function(t,n){this.type="metadata";var i=this;var s=jQuery.Deferred();var o=[];var f=t&&t.constructors&&t.constructors.Hashtable||f;var c=new f(t.instances.messageHandler);var u=new f(t.instances.messageHandler);var y=new f(t.instances.messageHandler);var l=new f(t.instances.messageHandler);var h=new f(t.instances.messageHandler);var p=new f(t.instances.messageHandler);var d=new f(t.instances.messageHandler);var v=new f(t.instances.messageHandler);var g=new f(t.instances.messageHandler);var m=new f(t.instances.messageHandler);var E=new f(t.instances.messageHandler);var P=new f(t.instances.messageHandler);var I=t.constructors.ODataModel||r;var S=false;if(t.deactivateFatalError){S=true}var O;var H;var b;var M;var k=A(n);function A(e){var r=t.functions.getSapSystem();if(r){return a.setOrigin(e,{force:true,alias:r})}return e}function D(e){var t;function r(e){if(!t.dataType){t.dataType={}}t.dataType[e]=t[e]}function a(e,r){if(Array.isArray(t[r])===true){t[r].forEach(function(e){t[e.name]=e.value})}else if(r!=="dataType"&&typeof t[r]==="object"){if(Object.keys(t[r]).length===0){t[e]="true"}if(r!==e){jQuery.each(t[r],function(r,a){t[e]=a})}}else{t[e]=t[r]}}if(e===null){return{}}t=jQuery.extend(true,{},e);jQuery.each(t,function(e){switch(e){case"type":r(e);break;case"maxLength":r(e);break;case"precision":r(e);break;default:var t=e.split(".").pop();if(t.search("ISO")===0){a(t,e)}else{a(t.replace(/^./,t[0].toLowerCase()),e)}break}});return t}function w(e,t){if(l.hasItem(e)!==true){var r;var a={};var n={allParameters:[],keyParameters:[]};if(N(e)){r=L(e);if(r.key&&r.key.propertyRef){r.key.propertyRef.forEach(function(e){a[e.name]=null})}r.property.forEach(function(e){var t=D(e);t.isKey=a.hasOwnProperty(t.name);n.allParameters.push(t);if(t.isKey){n.keyParameters.push(t)}})}l.setItem(e,n)}if(!t){return l.getItem(e).allParameters}return l.getItem(e).keyParameters}function T(e){var t=[];var r;if(N(e)){e=K(e)}r=L(e);r.property.forEach(function(e){t.push(e.name)});return t}function j(e){var t;if(y.hasItem(e)===true){return y.getItem(e)}var r;var a=[];var n=[];var i=K(e);if(i&&q(i)){var s=L(i);s.property.forEach(function(e){a.push(e.name)})}var o=w(e,false);for(t=0;t<o.length;t++){n.push(o[t].name)}r=a.concat(n);y.setItem(e,r);return r}function F(e){return p.getItem(e)}function C(e){var t=F(e);t=t||F(e+"Results");if(!t&&L(e)){t=e}return t}function U(e){if(u.hasItem(e)===false){var t=[];var r=L(e);r.property.forEach(function(e){if(!(e["sap:filterable"]==="false"||e.filterable&&e.filterable==="true")){t.push(e.name)}});u.setItem(e,t)}return u.getItem(e)}function N(e){return x(e)==="parameters"}function q(e){return x(e)==="aggregate"}function x(e){if(!v.hasItem(e)){var t=L(e);var r=t&&t["sap:semantics"]||"undefined";v.setItem(e,r)}return v.getItem(e)}function R(e,t){if(c.hasItem(e+t)===false){var r=N(e);var a=L(e);var n=O.getODataProperty(a,t);if(!n&&r){var i=K(e);a=L(i);n=O.getODataProperty(a,t)}c.setItem(e+t,D(n))}return c.getItem(e+t)}function K(e){var t=m.getItem(e);if(t){return F(t.toAggregateEntitySet)}return e}function L(e){if(!e){return undefined}if(!P.hasItem(e)){var t=O.getODataEntityType(b+e);if(!t){return t}P.setItem(e,t)}return P.getItem(e)}function Q(){var e;H=u();H.attachMetadataLoaded(function(){O=H.getMetaModel();O.loaded().then(function(){if(!H.getServiceMetadata()){e="5018";if(S){e="11013"}t.instances.messageHandler.putMessage(t.instances.messageHandler.createMessageObject({code:e,aParameters:[n],oCallingObject:i}));s.reject();return}r();a();f(H);c();s.resolve(this)}.bind(this))}.bind(this));H.attachMetadataFailed(function(){e="5018";if(S){e="11013"}t.instances.messageHandler.putMessage(t.instances.messageHandler.createMessageObject({code:e,aParameters:[n],oCallingObject:i}));s.reject();return});function r(){var e={};var r=O.getODataEntityContainer()&&O.getODataEntityContainer().entitySet;if(!r){t.instances.messageHandler.putMessage(t.instances.messageHandler.createMessageObject({code:"5041",aParameters:[n],oCallingObject:i}));return}r.forEach(function(t){var r=t.entityType.split(/[. ]+/).pop();p.setItem(t.name,r);d.setItem(r,t.name);if(!e.hasOwnProperty(r)){e[r]=true;o.push(r)}})}function a(){var e=O.getODataEntityContainer()&&O.getODataEntityContainer().entitySet;if(!e){return}var t=e[0].entityType.split(".");t.pop();b=t.join(".")+"."}function f(e){var t=e&&e.getServiceAnnotations();if(t&&t.aliasDefinitions&&t.aliasDefinitions.Capabilities){M=t.aliasDefinitions.Capabilities+"."}}function c(){var e=O.getODataEntityContainer();if(!e||!e.associationSet){return}e.associationSet.forEach(function(e){var t=e.end[0].entitySet,r=e.end[1].entitySet,a,n;if(N(F(t))){a=t}else if(q(F(t))){n=t}if(N(F(r))){a=r}else if(q(F(r))){n=r}if(!a||!n){return}var i;var s=L(F(a));var o;s.navigationProperty.forEach(function(t){if(!o&&t.relationship===e.association){i=t.name;o=true}});if(!i){return}var f={navigationProperty:i,fromParameterEntitySet:a,toAggregateEntitySet:n,fromIsUnique:undefined,toIsUnique:undefined};if(g.hasItem(a)){f.fromIsUnique=false;g.getItem(a).fromIsUnique=false}else{f.fromIsUnique=true;g.setItem(a,f);m.setItem(F(a),f)}if(E.hasItem(n)){E.getItem(n).toIsUnique=false}else{f.toIsUnique=true;E.setItem(n,f)}})}function u(){var e=t.instances.annotationHandler.getAnnotationsForService(n);var r={annotationURI:e,json:true};return new I(k,r)}}this.getEntityTypes=function(){return o};this.getPropertyMetadata=function(e,r){t.instances.messageHandler.check(e!==undefined&&typeof e==="string","sap.apf.core.Metadata:getPropertyMetadata incorrect EntityType name or type");t.instances.messageHandler.check(r!==undefined&&typeof r==="string","sap.apf.core.Metadata:getPropertyMetadata incorrect sPropertyName name or type");var a=C(e);if(!a){return{}}return R(a,r)};this.getUriComponents=function(e){if(!F(e)){if(F(e+"Results")){return{entitySet:e+"Results",navigationProperty:""}}return null}var r;switch(x(F(e))){case"undefined":return{entitySet:e,navigationProperty:""};case"parameters":r=g.getItem(e);if(!r||r.fromIsUnique===false){return{entitySet:e,navigationProperty:undefined}}return{entitySet:e,navigationProperty:r.navigationProperty};case"aggregate":r=E.getItem(e);if(!r){return{entitySet:e,navigationProperty:""}}if(r.toIsUnique===false){return{entitySet:undefined,navigationProperty:undefined}}return{entitySet:r.fromParameterEntitySet,navigationProperty:r.navigationProperty};default:t.instances.messageHandler.check(false,"metadata : getUriComponents - not handled return value for sap semantics")}};this.getFilterableProperties=function(e){t.instances.messageHandler.check(e!==undefined&&typeof e==="string","sap.apf.core.Metadata:getFilterableProperties incorrect EntityType name or type");var r=C(e);if(!r){return[]}r=K(r);return U(r)};this.getAllPropertiesOfEntitySet=function(e){t.instances.messageHandler.check(e!==undefined&&typeof e==="string","sap.apf.core.Metadata:getAllPropertiesOfEntitySet incorrect EntitySet name or type");var r=C(e);if(!r){return[]}return T(r)};this.getAllProperties=function(){var r=[];var a;this.getEntityTypes().forEach(function(e){a=j(e);if(a.length===0){a=T(e)}r=r.concat(a)});r=e.eliminateDuplicatesInArray(t.instances.messageHandler,r);return r};this.getFilterablePropertiesAndParameters=function(){var r=[];var a;var n=this.getEntityTypes();n.forEach(function(e){var t=L(e);t.property.forEach(function(e){if(!(e["sap:filterable"]==="false")&&e["sap:aggregation-role"]==="dimension"){r.push(e.name)}});a=w(e,false);a.forEach(function(e){r.push(e.name)})});return e.eliminateDuplicatesInArray(t.instances.messageHandler,r)};this.getParameterEntitySetKeyPropertiesForService=function(){var r=[];this.getEntityTypes().forEach(function(e){w(e,true).forEach(function(e){r.push(e.name)})});r=e.eliminateDuplicatesInArray(t.instances.messageHandler,r);return r};this.getAllKeys=function(){var r=[];var a=[];this.getEntityTypes().forEach(function(e){var t=L(e);a=[];if(t.key&&t.key.propertyRef){t.key.propertyRef.forEach(function(e){a.push(e.name)})}r=r.concat(a)});r=e.eliminateDuplicatesInArray(t.instances.messageHandler,r);return r};this.getAttributes=function(e){var t=false;var r={};this.getEntityTypes().forEach(function(a){if(!t){r=R(a,e);if(r.name){t=true}}});return r};this.getParameterEntitySetKeyProperties=function(e){t.instances.messageHandler.check(e!==undefined&&typeof e==="string","sap.apf.core.Metadata:getParameterEntitySetKeyProperties incorrect EntityType name or type");var r=C(e);if(!r){return[]}return w(r,true)};this.getEntityTypeAnnotations=function(e){var r=C(e);t.instances.messageHandler.check(e!==undefined&&typeof e==="string","sap.apf.core.Metadata:getEntityTypeAnnotations incorrect EntityType name or type");if(h.hasItem(r)===true){return h.getItem(r)}var a={};i(r,a);var n=K(r);if(n!==r){i(n,a)}h.setItem(r,a);return h.getItem(r);function i(e,t){var r;var a;var n;var i=L(e);for(r in i){if(i.hasOwnProperty(r)){if(r.indexOf(M)!==0){continue}a=r.split(".").pop();a=a.replace(/^./,a[0].toLowerCase());for(n in i[r]){if(i[r].hasOwnProperty(n)){t[a]=i[r][n]}}}}}};this.getEntitySets=function(){var e={};var t=[];var r=O.getODataEntityContainer();if(!r){return[]}if(r.associationSet){r.associationSet.forEach(function(t){var r,a,n;r=C(t.end[0].entitySet);if(!N(r)){return}n=t.end[1].entitySet;a=C(n);if(!N(a)){e[n]=true}})}if(r.entitySet){r.entitySet.forEach(function(r){if(!e[r.name]){t.push(r.name)}})}return t};this.getAllEntitySetsExceptParameterEntitySets=function(){var e=O.getODataEntityContainer();var t=[];if(!e){return[]}if(e.entitySet){e.entitySet.forEach(function(e){var r=F(e.name);if(!N(r)){t.push(e.name)}})}return t};this.getEntitySetByEntityType=function(e){return d.getItem(e)};this.getHierarchyAnnotationsForProperty=function(e,r){var a={};var i=this.getAllPropertiesOfEntitySet(e);if(i.length===0){return t.instances.messageHandler.createMessageObject({code:5072,aParameters:[e,n]})}var s=F(e);var o=K(s);i.forEach(function(e){var t=R(o,e);if(t["hierarchy-node-for"]===r){a.hierarchyNodeFor=e}});if(!a.hierarchyNodeFor){return t.instances.messageHandler.createMessageObject({code:5073,aParameters:[e,n,r]})}i.forEach(function(e){var t=R(o,e);if(t["hierarchy-level-for"]===a.hierarchyNodeFor){a.hierarchyLevelFor=e}else if(t["hierarchy-parent-node-for"]===a.hierarchyNodeFor){a.hierarchyParentNodeFor=e}else if(t["hierarchy-drill-state-for"]===a.hierarchyNodeFor){a.hierarchyDrillStateFor=e}else if(t["hierarchy-node-external-key-for"]===a.hierarchyNodeFor){a.hierarchyNodeExternalKeyFor=e}});return a};this.getHierarchicalEntitySets=function(){var e=[];var t=this.getEntitySets();t.forEach(function(t){var r=z.call(this,t);if(r.entitySet){e.push(r.entitySet)}}.bind(this));return e};this.getHierarchicalPropertiesOfEntitySet=function(e){return z.call(this,e).hierarchyProperties};function z(e){var t={};t.hierarchyProperties=[];var r=F(e);if(!r){return t}var a=K(r);var n=this.getAllPropertiesOfEntitySet(e);n.forEach(function(r){var i=R(a,r);var s=false;var o=false;var f=false;if(i["hierarchy-node-for"]!==undefined){var c=i["hierarchy-node-for"];var u=r;n.forEach(function(e){var t=R(a,e);if(t["hierarchy-level-for"]===u){s=true}else if(t["hierarchy-parent-node-for"]===u){o=true}else if(t["hierarchy-drill-state-for"]===u){f=true}});if(s&&o&&f){t.entitySet=e;t.hierarchyProperties.push(c)}}});return t}this.getNonHierarchicalPropertiesOfEntitySet=function(e){var t=[];var r=F(e);if(!r){return t}var a=K(r);var n=this.getAllPropertiesOfEntitySet(e);var i=z.call(this,e).hierarchyProperties;n.forEach(function(e){var r=R(a,e);if(r["hierarchy-node-for"]===undefined&&r["hierarchy-node-external-key-for"]===undefined&&r["hierarchy-parent-node-for"]===undefined&&r["hierarchy-level-for"]===undefined&&r["hierarchy-drill-state-for"]===undefined&&r["hierarchy-node-descendant-count-for"]===undefined&&i.indexOf(e)===-1){var n=r.name;t.push(n)}});return t};this.getODataModel=function(){return H};this.isInitialized=function(){return s.promise()};Q.call(this)};sap.apf.core.Metadata=n;return n},true);
//# sourceMappingURL=metadata.js.map