sap.ui.define(["sap/ui/base/Object","sap/suite/ui/generic/template/js/StableIdHelper","sap/suite/ui/generic/template/lib/MessageUtils","sap/base/util/extend","sap/suite/ui/generic/template/genericUtilities/controlHelper","sap/suite/ui/generic/template/genericUtilities/testableHelper","sap/suite/ui/generic/template/lib/CRUDHelper","sap/base/util/isEmptyObject","sap/ui/model/Context","sap/ui/model/Filter"],function(e,t,n,o,i,s,r,a,l,g){"use strict";function f(e,t,o){var i,l;function f(e){if(e){return new g({filters:[new g("persistent","EQ",false),new g({filters:[new g("fullTarget","StartsWith",i.getBindingContext().getPath()),new g("target","EQ","/"+t.getOwnerComponent().getEntitySet())],and:false})],and:true})}else{return new g({filters:[new g("fullTarget","StartsWith",i.getBindingContext().getPath()),new g("target","EQ","/"+t.getOwnerComponent().getEntitySet())],and:false})}}function u(){var e=f(false);var t=sap.ui.getCore().getMessageManager().getMessageModel();if(e){var n=t.bindList("/",null,null,[e]);var o=n.getContexts();if(o.length){var i=[];for(var s in o){i.push(o[s].getObject())}sap.ui.getCore().getMessageManager().removeMessages(i)}}}function c(){i.close();i.setVisible(false);if(o.oComponentUtils.isDraftEnabled()){o.oServices.oCRUDManager.discardDraft(i.getBindingContext())}else{u(i);t.getView().getModel().deleteCreatedEntry(i.getBindingContext())}i.setBindingContext(null)}function d(){var s=false;var r;var a=i&&typeof i.getContent==="function"&&i.getContent()&&i.getContent()[0];var g=a?a.check():Promise.resolve();g.then(function(){var a=sap.ui.getCore().getMessageManager().getMessageModel().getData();s=a.some(function(e){return e.type==="Error"&&e.validation});if(!s&&o.oComponentUtils.isDraftEnabled()){var g=o.oComponentUtils.getCRUDActionHandler();r=f(true);g.handleCRUDScenario(1,C.bind(null,r))}else if(!s){o.oCommonEventHandlers.submitChangesForSmartMultiInput();r=f(false);var c=o.oServices.oCRUDManager.saveEntity(r);if(o.oComponentUtils.getViewLevel()===1){o.oServices.oApplicationController.executeSideEffects(l.getBindingContext(),[],[l.getTableBindingPath()])}c.then(function(){i.close();i.setVisible(false);if(e.oPresentationControlHandler){if(e.refreshModel){e.refreshModel()}else{o.oCommonUtils.refreshModel(e.oPresentationControlHandler.getEntitySet())}e.oPresentationControlHandler.refresh();n.showSuccessMessageIfRequired(o.oCommonUtils.getText("OBJECT_CREATED"),o.oServices)}else{o.oCommonUtils.refreshModel(l.getEntitySet());o.oServices.oPresentationControlHandlerFactory.getPresentationControlHandler(l).refresh();n.showSuccessMessageIfRequired(o.oCommonUtils.getContextText("ITEM_CREATED",l.getId()),o.oServices)}var t=o.oServices.oApplication.getBusyHelper();t.getUnbusy().then(function(){u(i);i.setBindingContext(null)})});var d={saveEntityPromise:c};o.oComponentUtils.fire(t,"AfterSave",d)}})}function C(s){var r=o.oServices.oCRUDManager.activateDraftEntity(i.getBindingContext(),s);r.then(function(t){if(t&&t.response&&t.response.statusCode==="200"){i.close();i.setVisible(false);i.setBindingContext(null);n.showSuccessMessageIfRequired(o.oCommonUtils.getText("OBJECT_CREATED"),o.oServices);e.oPresentationControlHandler.refresh()}},Function.prototype);var a={activationPromise:r};o.oComponentUtils.fire(t,"AfterActivate",a)}function p(e,t,n){l=o.oCommonUtils.getOwnerControl(t,true);var i=l.getParent().getBindingContext();n=a(n)?false:n;if(!n){var s=o.oServices.oCRUDManager.getDefaultValues(t,n);if(s instanceof Promise){var r=function(n){v(e,t,n[0],l,i)};s.then(r,r)}else{v(e,t,n,l,i)}}else{v(e,t,n,l,i)}}function v(t,n,s,a,l){var g=e.oSmartFilterbar;var f=l?a.getTableBindingPath():"/"+a.getEntitySet();var u=new sap.ui.model.json.JSONModel;i=t;i.setVisible(true);u.setProperty("/title",o.oCommonUtils.getContextText("CREATE_DIALOG_TITLE",a.getId()));i.setModel(u,"localModel");i.setEscapeHandler(c);if(o.oComponentUtils.isDraftEnabled()){o.oCommonEventHandlers.addEntry(n,false,g,s,false,true).then(function(e){o.oServices.oApplication.registerContext(e);i.setBindingContext(e);i.open()})}else{var d=r.createNonDraft(l,f,i.getModel(),s);i.setBindingContext(d);i.open()}}var C=s.testable(C,"fnActivateImpl");var u=s.testable(u,"fnRemoveOldMessageFromModel");var f=s.testable(f,"fnGetFilterForCurrentState");var v=s.testable(v,"openDialog");return{onCancelPopUpDialog:c,onSavePopUpDialog:d,createWithDialog:p}}return e.extend("sap.suite.ui.generic.template.lib.CreateWithDialogHandler",{constructor:function(e,t,n){o(this,f(e,t,n))}})});
//# sourceMappingURL=CreateWithDialogHandler.js.map