sap.ui.define(["sap/ui/base/Object","sap/ui/model/Context","sap/suite/ui/generic/template/lib/MessageUtils","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageBox","sap/suite/ui/generic/template/genericUtilities/CacheHelper","sap/suite/ui/generic/template/genericUtilities/metadataAnalyser"],function(e,t,n,r,a,i,s,o){"use strict";var l=Promise.reject();l.catch(Function.prototype);var u=20;function c(e,t,n,r,a){var i=n.createEntry(t,{properties:r,context:e,batchGroupId:"Changes",changeSetId:"Changes",canonicalRequest:a});return i}function f(e,t,n,r,a,i,s,o){n=n||"/"+t;var l=a.mustRequireRequestsCanonical();s.oFunctionImportDialogInfo={getTitleText:function(){return o.getText("DIALOG_TITLE_NEW_ACTION_FOR_CREATE")},getActionButtonText:function(){return o.getText("DIALOG_ACTION_BUTTON_NEW_ACTION_FOR_CREATE")}};return e.createNewDraftEntity(t,n,i,l,s).then(function(e){return e.context})}function v(e,t,n){var r=new Promise(function(n,r){e.read(t,{urlParameters:{$expand:"DraftAdministrativeData"},success:function(e){n(e)},error:function(e){r(e)}})});n.setBusy(r,true);return r}function d(e,t,n,i,s,o){var l=new Promise(function(o,l){var u,c,f,v,d=[];if(n&&i&&s){c=n.length;for(u=0;u<c;u++){f=n[u].PropertyPath;v=i[f][0];d.push(new r(f,a.EQ,v))}if(e.getDraftController().getDraftContext().isDraftEnabled(t)){var p=new r({filters:[new r("IsActiveEntity","EQ",false),new r("SiblingEntity/IsActiveEntity","EQ",null)],and:false});d.push(p)}var D=new r(d,true);s.read("/"+t,{urlParameters:{$expand:"DraftAdministrativeData"},filters:[D],success:function(e){var t=g(e,s,i);if(t){o(t)}else{l(e)}},error:function(e){l(e)}})}});o.oBusyHelper.setBusy(l,true);return l}function g(e,t,n){var r,a,i,s;if(e&&e.results){i=e.results.length;if(i==0){s=null}else if(i==1){s=e.results[0]}else if(i>=1){var o=[];var l=[];for(a=0;a<i;a++){r=e.results[a];if(r&&r.IsActiveEntity){l.push(r)}else if(r&&r.IsActiveEntity==false){o.push(r)}}if(l.length==0&&o.length>=2){var u;for(var c=0;c<o.length;c++){u=o[c];if(u.DraftUUID==n.DraftUUID){s=u;break}}if(!s){s=o[0]}}else if(l.length==1&&o.length==1){s=l[0]}else if(l.length==1&&o.length>=2){s=l[0]}}}return s}function p(e){var t=e.oAppComponent;var r=t.getModel();var a=r.getMetaModel();var i=t.getNavigationController();var s=t.getApplicationController();var o=s.getTransactionController().getDraftController().getDraftContext();var l=function(t){e.oApplicationProxy.getResourceBundleForEditPromise().then(function(a){n.handleError(n.operations.modifyEntity,null,null,t,{resourceBundle:a,navigationController:i,model:r});n.handleTransientMessages(e)})};var c=function(t){e.oTemplatePrivateGlobalModel.setProperty("/generic/draftIndicatorState",sap.m.DraftIndicatorState.Clear);var n=t.getParameter("context");if(!o.hasDraft(n)){return}if(!a.getODataEntitySet(n.getPath().split("(")[0].substring(1))){return}var r=t.getParameter("path");s.propertyChanged(r,n,u).catch(l);e.oApplicationProxy.markCurrentDraftAsModified()};r.attachPropertyChange(c)}function D(e,t,n,r,a){var s=e||n;return new Promise(function(e,n){var o=s.getText("DRAFT_LOCK_EXPIRED",[t.LastChangedByUserDescription||t.LastChangedByUser]);var l=s.getText("Edit");var u=s.getText("CANCEL");i.warning(o,{title:s.getText("ST_UNSAVED_CHANGES_TITLE"),actions:[l,u],emphasizedAction:l,onClose:function(t){if(t===l){e()}else if(t===u){if(a){r.navigateUp()}}n()}})})}function m(e,n,r,a,i,o,l,u){var c=new Promise(function(c,f){var g=function(t,n){var r=e.editEntity(t,false,n);c(r);r.then(function(){a.invalidateEntry(t)})};if(r===""&&l&&u){var p=i.mEntityTree[n];var m=i.componentRegistry[p.componentId];var y=s.getInfoForContentIdPromise(n,a,i.oAppComponent.getId(),m.utils.getRootExpand);Promise.all([y,d(e,n,l,u,a,i)]).then(function(e){var s=e[1];var l=e[0].contentIdRequestPossible?e[0].parametersForContentIdRequest.sRootExpand:null;var u="/"+a.createKey(n,s);a.createBindingContext(r,null,null,function(e){var e=new t(a,u);if(!s.DraftAdministrativeData||s.DraftAdministrativeData.DraftIsCreatedByMe){g(e,l)}else if(s.DraftAdministrativeData.InProcessByUser){f({lockedByUser:s.DraftAdministrativeData.InProcessByUserDescription||s.DraftAdministrativeData.InProcessByUser})}else{D(i,s.DraftAdministrativeData,o).then(function(){g(e)},function(){f({lockedByUser:s.DraftAdministrativeData.LastChangedByUserDescription||s.DraftAdministrativeData.LastChangedByUser})})}})},function(e){f({draftAdminReadResponse:e})})}else{var h=e.getDraftController().getDraftContext();a.createBindingContext(r,null,null,function(e){if(h.isDraftEnabled(n)){if(true||!h.hasPreserveChanges(e)){v(a,r,i.oBusyHelper).then(function(t){if(!t.DraftAdministrativeData||t.DraftAdministrativeData.DraftIsCreatedByMe){g(e)}else if(t.DraftAdministrativeData.InProcessByUser){f({lockedByUser:t.DraftAdministrativeData.InProcessByUserDescription||t.DraftAdministrativeData.InProcessByUser})}else{var n=function(){g(e)};var r=function(){f({lockedByUser:t.DraftAdministrativeData.LastChangedByUserDescription||t.DraftAdministrativeData.LastChangedByUser})};var a=D(i,t.DraftAdministrativeData,o);a.then(n,r)}},function(e){f({draftAdminReadResponse:e})})}}else{c({context:e})}})}});i.oBusyHelper.setBusy(c,true);return c}function y(e,t,n,r,a,i,s,o,l){var u=e.getDraftController().getDraftContext();var c=new Promise(function(f,d){r.createBindingContext(n,null,null,function(g){if(u.isDraftEnabled(t)){e.editEntity(g,true).then(function(e){g.getModel().invalidateEntry(g);s.setRootPageToDirty();f({context:e.context})},function(t){if(t&&t.response&&t.response.statusCode==="409"){a.removeTransientMessages();v(r,n,a.getBusyHelper()).then(function(t){if(t.DraftAdministrativeData.InProcessByUser){d({lockedByUser:t.DraftAdministrativeData.InProcessByUserDescription||t.DraftAdministrativeData.InProcessByUser})}else{var n=function(){var t=e.editEntity(g,false).then(function(e){g.getModel().invalidateEntry(g);s.setRootPageToDirty();f({context:e.context})});a.getBusyHelper().setBusy(t,true)};var r=Function.prototype;var u=D(undefined,t.DraftAdministrativeData,i,o,l);u.then(n,r)}},function(e){d({draftAdminReadResponse:e})});a.getBusyHelper().setBusy(c,true)}else{d(t)}})}else{return f({context:g})}})});return c}function h(e,t,n,r,a,i){var s=e.hasActiveEntity(r);var o=s&&!a?n.getDraftSiblingPromise(r):Promise.resolve();return o.then(function(e){var o=t(a,s,r);if(!a){var l=function(){return{context:e}};var u=o.then(l);n.cancellationStarted(r,u,i,e)}return o})}function C(e,t,n,r){var a=function(e,n,r){return t.deleteEntity(r,null,true)};return h(e,a,n,r,false,"discardAction")}function A(e,t,r){var a=t.getMessageModel();var i=a.bindList("/",null,null,[e]);var s=i.getAllCurrentContexts().map(function(e){return e.getObject()});if(r){s=s.filter(function(e){return!n.isMessageETagMessage(e)})}return s}function E(e,t,r,a,i,o){if(r.isBusy()){return l}var u=new Promise(function(l,u){var c=i.getView();var f=e?e:c.getBindingContext();var v=t?t:a.oTemplateCapabilities.oMessageButtonHelper&&a.oTemplateCapabilities.oMessageButtonHelper.getContextFilter(true);var d=sap.ui.getCore().getMessageManager();var g=c.getModel();var p=i.getOwnerComponent();var D=p.getEntitySet();var m=p.getAppComponent();var y=m.getId();var h=s.getInfoForContentIdPromise(D,g,y,o.getRootExpand);var C=h.then(function(e){var t=e.contentIdRequestPossible?e.parametersForContentIdRequest.sRootExpand:undefined;var s;var c=function(e){var g=s||A(v,d);var p=a.oDraftController.activateDraftEntity(f,e,t);a.oApplication.activationStarted(f,p);p.then(function(e){d.removeMessages(g);l(e)});p.catch(function(t){s=A(v,d);if(s.length>0){var r=s[0];var l=g.some(function(e){return e===r});if(l){u();return}}var f=a.oApplication.getTransientMessages();var p=[];var D=[];var m=false;f.forEach(function(t){m=!e&&(m||t.technicalDetails&&t.technicalDetails.statusCode==="412"&&t.technicalDetails.headers&&t.technicalDetails.headers["preference-applied"]==="handling=strict");if(t.type==="Warning"){p.push(t)}else if(t.type==="Error"){D.push(t)}});var y=s.some(function(e){return e.type==="Error"});var h=m&&!y;if(h){a.oApplication.removeTransientMessages();var C={messagesForUserDecison:s.concat(p)};var E=o.getCRUDActionHandler();E.handleCRUDScenario(4,c.bind(null,true),u,"Activate",C);return}u();if(y){a.oApplication.removeTransientMessages();if(a.oTemplateCapabilities&&a.oTemplateCapabilities.oMessageButtonHelper){a.oTemplateCapabilities.oMessageButtonHelper.showMessagePopover();return}}n.handleError(n.operations.activateDraftEntity,i,a,t,null)});r.setBusy(p)};r.setBusy(C);var p=a.oApplication.getDraftSiblingPromise(f).then(function(e){if(e){g.invalidateEntry(e)}});r.setBusy(p);p.then(c.bind(null,false))});r.setBusy(C)});return u}return{createNonDraft:c,create:f,edit:m,directEdit:y,enableAutomaticDraftSaving:p,discardDraft:C,deleteEntity:h,activateDraftEntity:E,fnGetMessagesFromContextFilter:A}});
//# sourceMappingURL=CRUDHelper.js.map