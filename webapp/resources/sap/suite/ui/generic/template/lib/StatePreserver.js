sap.ui.define(["sap/ui/base/Object","sap/suite/ui/generic/template/lib/navigation/routingHelper","sap/suite/ui/generic/template/genericUtilities/testableHelper","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/base/util/extend","sap/base/util/deepExtend","sap/base/util/isEmptyObject"],function(e,t,n,r,a,i,l){"use strict";var u=new r("lib.StatePreserver").getLogger();function s(e,n){var r=t.getCrossAppNavService();var a=e.componentRegistry[n.oComponent.getId()];var s=a.viewLevel===0;var o="";var p=Promise.resolve();var c=null;var f=Promise.resolve();var v=null;var g=null;var y=null;var S,m;var d=Object.create(null);var x={};var b={};function E(){d.permanentEntries=Object.create(null);d.sessionEntries=Object.create(null);d.pageEntries=Object.create(null);d.allEntries=Object.create(null)}E();function h(e){E();for(var t in e){var n=i({},e[t]);d.allEntries[t]=n;var r=n.lifecycle||Object.create(null);if(r.permanent){d.permanentEntries[t]=n}else if(r.session){d.sessionEntries[t]=n}if(r.page||r.pagination){d.pageEntries[t]=n}}return d}function K(e,t){if(t===e){return}var n=t.next.next;t.next.next=e.next;e.next=t.next;t.next=n}function P(e,t,a){if(l(t)){return Promise.resolve({appStateKey:""})}var i=JSON.stringify(t);var u=0;var s;for(s=e;s.next&&u<10;u++){if(s.next.serialize===i){K(e,s);return Promise.resolve({appStateKey:e.next.appStateKey})}s=s.next}s.next=null;var o=r.createEmptyAppStateAsync(n.oComponent.getAppComponent(),a?undefined:true);return o.then(function(n){var r={next:e.next,serialize:i,appStateKey:n.getKey()};n.setData(t);n.save();e.next=r;return{appStateKey:r.appStateKey}})}function A(){var t=P(b,d.sessionEntries,false);return t.then(function(t){var r=Object.create(null);if(t.appStateKey){r.sessionAppStateKey=t.appStateKey}if(!l(d.permanentEntries)){r.permanentEntries=d.permanentEntries}var i=P(x,r,true);return i.then(function(t){g=t;var r=Promise.resolve();if(y===g.appStateKey){g=null}else if(a.utils.isComponentActive()){r=e.oNavigationControllerProxy.navigateByExchangingQueryParam(n.appStateName,g.appStateKey)}else{o=g.appStateKey;g=null}if(v){v(r.then(e.oBusyHelper.getUnbusy));v=null}})})}function O(){if(!v||o!==y){return}var e=n.getCurrentState()||Object.create(null);h(e);return A()}function j(){var t=a.aKeys;var n="";var r=a.route;for(var i=t.length-1;i>0;i--){var l=e.mRoutingTree[r];var u=i===1?l.entitySet:l.navigationProperty;n="/"+u+(t[i]?"("+t[i]+")":"")+n;r=l.parentRoute}return n}function C(e,t){return p.then(function(){var t=Object.create(null);var r=(!e||j()===e)&&S;if(r){t[n.appStateName]=r}return t})}function N(){if(e.bStateHandlingSuspended){return}if(!v){f=new Promise(function(e){v=e;setTimeout(O,0)})}return f}function w(){o=y;g=null;S=y}function H(e,t,n){if(!t){return}for(var r in t){var a=t[r];if(n||a.lifecycle.page){e[r]=a}}}function F(e,t){h(t);var r=Object.create(null);for(var a in t){r[a]=t[a].data}n.applyState(r,e);if(c){c();c=null}w();return A().then(O)}function I(e,t,n){for(var r=e;r.next;r=r.next){if(r.next.appStateKey===n){K(e,r);return}}var a={next:e.next,serialize:JSON.stringify(t),appStateKey:n};e.next=a}function L(t,n,r,i,l,u){if(e.bStateHandlingSuspended){a.utils.hidePlaceholder();return}if(y===null){y=t}else if(t!==y){return}if(u){I(b,u,l);H(r,u,true)}H(r,i,true);return F(n,r)}function R(t,n,r,a){var i=a||Object.create(null);I(x,i,t);if(s&&!i.permanentEntries){i={permanentEntries:{permanentState:{data:i,lifecycle:{permanent:true}}}}}var l=e.oNavigationControllerProxy.getAppStateFromShell(i.sessionAppStateKey).catch(Function.prototype);l.then(L.bind(null,t,n,r,i.permanentEntries,i.sessionAppStateKey))}function U(t){var r=e.componentRegistry[n.oComponent.getId()];var a=r.utils.getHeaderDataAvailablePromise()||Promise.resolve();return a.then(function(){return e.oApplicationProxy.areTwoKnownPathesIdentical(m,t,r.viewLevel===1)})}function z(e,t){if(e===m){t(true);return}if(!e||!m){t(false);return}U(e).then(t)}function T(t,r){z(t,function(i){if(!n.callAlways&&i){if(y===o){a.utils.hidePlaceholder();return}if(!y){A();return}}m=t;var l=Object.create(null);H(l,d[i?"allEntries":"pageEntries"],i||r);if(!y){if(i){H(l,d.sessionEntries,true);H(l,d.permanentEntries,true)}F(i,l);return}if(!c){p=new Promise(function(e){c=e})}var u=e.bStateHandlingSuspended?"":y;var s=e.oNavigationControllerProxy.getAppStateFromShell(u).catch(Function.prototype);s.then(R.bind(null,u,i,l))})}function B(){for(var e in d.pageEntries){var t=d.pageEntries[e].lifecycle;if(!t.permanent&&!t.session){delete d.allEntries[e];delete d.pageEntries[e]}}}function D(e){y=e[n.appStateName]||"";if(Array.isArray(y)){y=y.sort()[0]||""}if(g){if(g.appStateKey!==y){u.error("StatePreserver: Got AppstateKey "+y+" expected "+g.appStateKey);return false}w();return true}return false}function J(){return{isStateChange:D,leaveApp:B}}function G(e){if(e){var t=n.getInitialState();n.applyState(t,true);o="";return}T(m,true)}return{getUrlParameterInfo:C,stateChanged:N,applyAppState:T,getAsStateChanger:J,setState:G}}return e.extend("sap.suite.ui.generic.template.lib.StatePreserver",{constructor:function(e,t){a(this,s(e,t))}})});
//# sourceMappingURL=StatePreserver.js.map