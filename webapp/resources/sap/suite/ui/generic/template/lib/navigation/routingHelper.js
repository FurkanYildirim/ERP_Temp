sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/mvc/XMLView","sap/suite/ui/generic/template/lib/FlexibleColumnLayoutHandler","sap/suite/ui/generic/template/genericUtilities/testableHelper","sap/suite/ui/generic/template/js/StableIdHelper","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/base/util/extend","sap/suite/ui/generic/template/genericUtilities/FeError"],function(e,t,n,o,a,r,i,l){"use strict";var p="lib.navigation.routingHelper";var u=new r(p).getLogger();var s=Object.create(null);var c={getPlaceholderInfo:Function.prototype};var m=sap&&sap.ushell&&sap.ushell.Container?sap.ushell.Container.getService("CrossApplicationNavigation"):function(){var e=0;var t={done:function(e){e({getData:function(){return Object.create(null)}})},fail:function(){}};var n=function(){return{getKey:function(){e++;return""+e},setData:Function.prototype,getData:function(){return{historicalEntries:[""]}},save:function(){return Promise.resolve()}}};return{createEmptyAppState:n,createEmptyAppStateAsync:function(){return Promise.resolve(n())},getAppState:function(){return t},isInitialNavigationAsync:function(){return Promise.resolve(true)}}}();function g(e,t,n,o,a,r){var l=e.oTemplateContract.bEnablePlaceholder?a&&a.getPlaceholderInfo():null;var p=i({controlId:n,controlAggregation:o,placeholder:l},r);var u=e.oRouter.getTargets();u.addTarget(t,p);return u.getTarget(t)}function d(e,t,n,o,a,r){return g(e,o,t,a,r,{viewName:n})}function v(e,t){if(e.oTemplateContract.oFlexibleColumnLayoutHandler){e.oTemplateContract.oFlexibleColumnLayoutHandler.createMessagePageTargets(d.bind(null,e,t,"sap.suite.ui.generic.template.fragments.MessagePage"))}else{d(e,t,"sap.suite.ui.generic.template.fragments.MessagePage","messagePage","pages")}}function f(e,t,n,o){var a=d(e,n,t.sRouteName,t.sRouteName,o,t.behaviour);var r=function(){e.treeNodeFirstDisplay(t);a.detachDisplay(r)};a.attachDisplay(r)}function C(e,t,n){var o=t.page.routingSpec?t.page.routingSpec.draftSpec:"OData";if(o===undefined){o="parent"}switch(o){case"parent":t.isDraft=n.isDraft;return;case"OData":var a=e.oAppComponent.getTransactionController().getDraftController();var r=a.getDraftContext();try{t.isDraft=r.isDraftEnabled(t.entitySet)}catch(e){u.warning("Could not determine draft info for entity set "+t.entitySet);t.isDraft=n&&n.isDraft}return;default:break}t.isDraft=o}function y(e){var t=e.page.component.name;var n=s[t];if(!n){n=new Promise(function(e){var n=t.replace(/\./g,"/")+"/behaviour";sap.ui.require([n],function(t){var n=i({},c);i(n,t);e(n)},function(){e(c)})});s[t]=n}return n.then(function(t){e.behaviour=t})}function b(e){e.children=[];e.willBeDisplayed=new Promise(function(t){e.display=function(){t();e.display=Function.prototype}});return e}function h(e){var o=e.oAppComponent.getFlexibleColumnLayout();if(o){e.oFlexibleColumnLayoutHandler=new n(e.oNavigationHost,e.oNavigationControllerProxy)}var a=t.create({viewName:"sap.suite.ui.generic.template.fragments.TemplateHost"}).then(function(t){e.oNavigationControllerProxy.createHostView=function(){return t.clone()}});var r=e.oAppComponent.getModel();var i=Promise.all([a,r.getMetaModel().loaded()]);return i.then(function(){var t=e.oNavigationHost.getId();var n=e.oAppComponent.getConfig();if(!n.pages||!n.pages.length){throw new l(p,"Route Configuration missing")}if(n.pages.length>1){throw new l(p,"Currently only one Top route supported")}var o=n.pages[0];e.mEntityTree=Object.create(null);e.mRoutingTree=Object.create(null);var a=e.oAppComponent.getManifestEntry("sap.app");var r=e.oAppComponent.getManifestEntry("sap.ui");var i=b({sRouteName:"root",entitySet:o.entitySet,page:o,getPath:function(){return""},level:0,fCLLevel:0,headerTitle:a.title,text:a.description,titleIconUrl:r.icons&&r.icons.icon});C(e.oNavigationControllerProxy,i,null);var u=M([],o,i,null,e.oNavigationControllerProxy,t);return u.then(function(){var n=S("root",o,0,i,e.oNavigationControllerProxy,t,i.children);return n.then(function(){v(e.oNavigationControllerProxy,t)})})})}function S(e,t,n,o,a,r,i,l,p){return t.pages?Promise.all(t.pages.map(function(t){return I(e,t,n+1,o,a,r,i,l,p||0)})):Promise.resolve()}function P(){return"---"}function T(e,t,n,o,a,r,i,l,p,u){e=a.target||e;var s={pages:n.pages};var c={entitySet:a.entitySet,sRouteName:a.sRouteName,isDraft:a.isDraft,embeddedComponent:t,getPath:function(e){return a.getPath(e)+(e===1?"/"+t:"")},patternDelimiter:P()};return S(e,s,o,c,r,i,l,p,u)}function R(e,t,n,o,a,r,i,l,p,u,s,c){var m={};var g={key:i,definition:l,componentName:l.componentName,componentUsage:l.componentUsage,hiddenByDefault:l.hiddenByDefault,containerId:p,sectionId:u,subSectionId:s,componentId:c,pages:l.pages||[],children:[],communicationObject:m};t.embeddedComponents[i]=g;return l.pages?T(e,i,l,n,t,o,a,g.children,m,r):Promise.resolve()}function N(e,t,n,o,r,i,l){t.embeddedComponents=Object.create(null);t.leadingComponents=Object.create(null);t.facetsWithEmbeddedComponents=Object.create(null);if(n.implementingComponent){var p=a.getStableId({type:"Canvas",subType:"ImplementingComponentContainer"});var u=a.getStableId({type:"Canvas",subType:"ImplementingComponentContainerContent"});return R(e,t,o,r,i,l,"implementation",n.implementingComponent,p,null,null,u)}var s=[];if(n.embeddedComponents){var c=Object.create(null);var m=Object.create(null);var g;var d;var v;for(g in n.embeddedComponents){d=n.embeddedComponents[g];if(!d.leadingSectionIdOrPath||d.leadingSectionIdOrPath===g){c[g]=[g]}else if(n.embeddedComponents[d.leadingSectionIdOrPath]){m[g]=d.leadingSectionIdOrPath}else{v=t.facetsWithEmbeddedComponents[d.leadingSectionIdOrPath];if(v){v.push(g)}else{t.facetsWithEmbeddedComponents[d.leadingSectionIdOrPath]=[g]}}}var f=[];for(g in m){var C=m[g];v=c[C];if(v){v.push(g)}else{f.push(g);delete m[g]}}for(var y=0;y<f.length;y++){c[f[y]]=[f[y]]}for(g in n.embeddedComponents){d=n.embeddedComponents[g];var b=c[g]&&a.getStableId({type:"ObjectPageSection",subType:"ReuseComponentSection",sReuseComponentName:d.componentName,sReuseComponentUsage:d.componentUsage,sReuseComponentKey:g});var h=a.getStableId({type:"ObjectPageSection",subType:"ReuseComponentSubSection",sReuseComponentName:d.componentName,sReuseComponentUsage:d.componentUsage,sReuseComponentKey:g});var p=a.getStableId({type:"ObjectPageSection",subType:"ReuseComponentContainer",sReuseComponentName:d.componentName,sReuseComponentUsage:d.componentUsage,sReuseComponentKey:g});var S=a.getStableId({type:"ObjectPageSection",subType:"ReuseComponentContainerContent",sReuseComponentName:d.componentName,sReuseComponentUsage:d.componentUsage,sReuseComponentKey:g});var P=R(e,t,o,r,i,l,g,d,p,b,h,S);s.push(P)}Object.keys(c).forEach(function(e){var n=t.embeddedComponents[e];t.leadingComponents[e]={sectionId:n.sectionId,title:n.definition.groupTitle||n.definition.title,followingComponents:c[e].map(function(e){var o=t.embeddedComponents[e];o.sectionId=n.sectionId;return o})}})}return Promise.all(s)}function I(e,t,n,o,a,r,i,l,p){var u=t.routingSpec&&t.routingSpec.noOData;var s=a.oAppComponent.getModel();var c=s.getMetaModel();var m=c.getODataEntitySet(t.entitySet);if(t.component&&(u||m)){var g=a.oTemplateContract.oFlexibleColumnLayoutHandler?a.oTemplateContract.oFlexibleColumnLayoutHandler.getMaxColumnCountInFCL():1;var d=g===1||t.defaultLayoutType==="OneColumn"?0:p+1;var v=b({parent:o&&o.entitySet,parentRoute:o?o.sRouteName:"root",parentEmbeddedComponent:o&&o.embeddedComponent,entitySet:t.entitySet,navigationProperty:t.navigationProperty,level:n,fCLLevel:d>=g?3:d,communicationObject:l,page:t,text:"",defaultLayoutType:t.defaultLayoutType,noKey:t.routingSpec&&t.routingSpec.noKey,noOData:u});if(m){v.entitySetDefinition=m;v.entityTypeDefinition=c.getODataEntityType(m.entityType)}C(a,v,o);x(v,o,a.oTemplateContract.bCreateRequestsCanonical);E(v,a.oTemplateContract);var f=M(e,t,v,o,a,r);return f.then(function(e){var o=e;var p=a.oAppComponent.getModel();var u=p.getMetaModel().getODataEntitySet(t.entitySet);v.semanticObject=u&&u["com.sap.vocabularies.Common.v1.SemanticObject"]&&u["com.sap.vocabularies.Common.v1.SemanticObject"].String;if(i){i.push(t.entitySet)}var s=a.oTemplateContract.mEntityTree[t.entitySet];if(!s||s.level>v.level){a.oTemplateContract.mEntityTree[t.entitySet]=v}O(a,v,t);var c=S(o.target,t,n,v,a,r,v.children,l,d);return c.then(function(){return N(o.target,v,t,n,a,r,d)})})}return Promise.resolve()}function D(e,t){var n=i({},e);n.name=e.name+"query";n.pattern=e.pattern+"{?query}";t.oRouter.addRoute(n)}function O(e,t,n){if(t.noOData){t.headerTitle=n.routingSpec.headerTitle;t.titleIconUrl=n.routingSpec.titleIconUrl}else{var o=e.oAppComponent.getModel();var a=o.getMetaModel();a.loaded().then(function(){var n=a.getODataEntitySet(t.entitySet);var o=a.getODataEntityType(n.entityType);var r=o["com.sap.vocabularies.UI.v1.HeaderInfo"];var i=r&&r.TypeName&&r.TypeName.String||"";if(i.substr(0,7)==="{@i18n>"){var l=i.substring(1,i.length-1);var p=l.split(">");i=e.oAppComponent.getModel(p[0]).getResourceBundle().getText(p[1])}t.headerTitle=i;var u=r&&r.Title&&r.Title.IconUrl&&r.Title.IconUrl.String||"";t.titleIconUrl=u})}}function x(e,t,n){var o=e.level===1||!e.page.navigationProperty?e.page.entitySet:e.page.navigationProperty;var a=e.noKey?"":"({keys"+e.level+"})";var r=o+a;var i=t&&t.getPath(1);if(i){r=i+(t.patternDelimiter||"/")+r}var l;var p;if(e.noOData){var u=e.page.routingSpec.binding?"/"+e.page.routingSpec.binding:"";l=t.getPath(3)+u;p=t.getPath(2)+u}else{l="/"+e.entitySet+a;p=n||(!e.page.navigationProperty||e.level===1)?l:t.getPath(2)+"/"+e.page.navigationProperty+a}e.getPath=function(t,n){var o;switch(t){case 1:o=r;break;case 2:o=p;break;case 3:o=l;break;default:}if(n){for(var a=1;a<=e.level;a++){o=o.replace("{keys"+a+"}",n[a])}}return o}}function E(e,t){e.specificModelName="_templPrivGlobaleODESM_"+e.entitySet;t.oAppComponent.setModel(t.oAppComponent.getModel(),e.specificModelName);var n=Object.create(null);var o=Object.create(null);e.bindElement=function(a,r,i,l){var p=e.componentId&&t.componentRegistry[e.componentId];var u=p&&!r&&p.nonDraftCreateContext;if(u){a.setBindingContext(u,i?e.specificModelName:undefined);return}var s=i?n:o;var c=a.getId();r=r||e.getPath(2,t.oNavigationControllerProxy.getCurrentKeys(e.level));var m=p&&p.utils.getRootExpand();if(!m&&e.level===1&&e.isDraft){m="DraftAdministrativeData"}var g=s[c];if(g&&g.bindingPath===r&&g.expand===m){if(g.binding.isSuspended()){g.binding.resume()}return}var d={createPreliminaryContext:true,canonicalRequest:!t.bCreateRequestsCanonical};if(m){d.expand=m}g={bindingPath:r,expand:m};var v={path:r,events:l||{},parameters:d,batchGroupId:"Changes",changeSetId:"Changes"};if(i){v.model=e.specificModelName}a.bindElement(v);g.binding=a.getElementBinding(v.model);s[c]=g};e.unbindElement=function(t,a){var r=a?n:o;var i=a?e.specificModelName:undefined;var l=function(e,t){e.unbindElement(i);delete r[t]};if(t){l(t,t.getId())}else{var p=sap.ui.getCore();for(var u in r){l(p.byId(u),u)}}}}function M(e,t,n,o,a,r){n.componentCreated=new Promise(function(e){n.componentCreatedResolve=e});var i=n.level;var l=Array.isArray(e)?e:[e];var p={};switch(i){case 0:n.sRouteName="root";break;case 1:n.sRouteName=t.entitySet;break;default:n.sRouteName=o.sRouteName+"/"+(o.embeddedComponent?o.embeddedComponent+"/":"")+(t.navigationProperty||t.entitySet)}a.oTemplateContract.mRoutingTree[n.sRouteName]=n;p.name=n.sRouteName;var u;if(a.oTemplateContract.oFlexibleColumnLayoutHandler){u=a.oTemplateContract.oFlexibleColumnLayoutHandler.adaptRoutingInfo(p,n.sRouteName,l,n)}else{u="pages";p.target=n.sRouteName}var s=y(n);return s.then(function(){f(a,n,r,u);p.pattern=n.getPath(1);a.oRouter.addRoute(p);D(p,a);return p})}function A(){return m}return{generateRoutingStructure:h,getCrossAppNavService:A,getEmbeddedComponentsPatternDelimiter:P}});
//# sourceMappingURL=routingHelper.js.map