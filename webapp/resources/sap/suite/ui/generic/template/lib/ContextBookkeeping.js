sap.ui.define(["sap/ui/base/Object","sap/base/util/each","sap/base/util/extend","sap/suite/ui/generic/template/genericUtilities/oDataModelHelper"],function(t,e,o,n){"use strict";function r(t){var r=Object.create(null);var a=[];var i=Object.create(null);function f(e){var o=e.getPath();var n=t.oAppComponent.getTransactionController().getDraftController();var a=n.getDraftContext();var i=a.hasDraft(e);var f=i&&e.getObject();var s=i&&!f.IsActiveEntity;var l=s&&!f.HasActiveEntity;var c=i&&f.HasDraftEntity&&e.getObject("DraftAdministrativeData/DraftIsCreatedByMe");var u=false;if(s&&f.DraftEntityCreationDateTime&&f.DraftEntityLastChangeDateTime){var v=f.DraftEntityLastChangeDateTime.getTime();var o=e.getPath();var x=r[o];var C=x&&x.oContext&&x.oContext.getObject();var d=C&&C.DraftEntityLastChangeDateTime&&C.DraftEntityLastChangeDateTime.getTime();if(d===v){return x.oContextInfo}u=f.DraftEntityCreationDateTime.getTime()!==v}return{bIsDraft:s,bIsDraftSupported:i,bIsCreate:l,bIsDraftModified:u,bOwnDraftExists:c}}function s(e,s,l,c){var u=e.getPath();var v=f(e);if(s===1&&!v.bIsCreate){a.push(u)}var x=o(r[u]||{},{oContextInfo:v,oContext:e});r[u]=x;if(v.bIsDraft&&!v.bIsCreate){x.bReplaceByActive=false}else if(v.bOwnDraftExists&&!v.bIsCreate){if(x.oEditingPromise){x.oEditingPromise.then(function(t){var e=t.context.getPath();r[e].bReplaceByActive=true})}else{h(e).then(function(t){var e=t.getPath();var o=r[e];if(o){r[e].bReplaceByActive=true}})}}var C=null;var d;l=l||n.analyseContext(e).entitySet;if(v.bIsDraftSupported&&!v.bIsCreate&&l){var g=t.mEntityTree[l];if(g&&!g.noOData){if(c){if(v.bIsDraft){var I=[];var P=t.oApplicationProxy.fillSiblingKeyPromise(g,c,I);P.then(function(t){var e=t.getPath(3,I);if(!r[e]){r[e]={oContextInfo:{bIsDraft:false,bIsDraftSupported:true,bIsCreate:false,bIsDraftModified:false,bOwnDraftExists:true},aKeysFromIdentity:I}}})}if(g&&!g.noOData){var m=t.oApplicationProxy.getAncestralNode(g,1);var p=i[m.entitySet];if(!p){p={treeNode:m,draftRoots:Object.create(null)};i[m.entitySet]=p}var y=c[1];d=p[y];if(!d){d={treeNode:m,key:y,childContexts:Object.create(null)};p[y]=d}}}var b=e.getModel();var D=b.getMetaModel();var S=D.getODataEntitySet(l);var A=D.getODataEntityType(S.entityType);var E=A["com.sap.vocabularies.Common.v1.SemanticKey"];if(E){C=[];for(var R=0;R<E.length;R++){C.push(e.getProperty(E[R].PropertyPath))}}}}if(C){x.aSemanticKeysValues=C}if(c){x.aKeysFromIdentity=c}if(d){x.oRootContextInfo=d;d.childContexts[u]=x}if(v.bIsDraftSupported&&x.oRootContextInfo){for(var M in x.oRootContextInfo.childContexts){var O=x.oRootContextInfo.childContexts[M];delete O.oRemovalPromise}}return v}function l(){for(var t=a.length-1;t>=0;t--){var e=r[a[t]].oContext;if(e){return a[t]}}}function c(t){var e=t.getPath();var o=r[e];return o}function u(t){var e=c(t);return!!(e&&(e.oContext||e.oRemovalPromise))}function v(t,e,o,n){if(!t.oContextInfo.bIsCreate||!o){if(n){t.oRemovalPromise=e.then(function(t){return t.context})}else{t.oRemovalPromise=t.oSiblingPromise||t.oContext&&h(t.oContext)}}e.then(function(){t.oContext=null},function(){delete t.oRemovalPromise})}function x(e,o,n,a){var i=c(e);var f=[];if(a==="deleteAction"&&!i.oContextInfo.bIsCreate){i.oRemovalPromise=o.then(function(t){i.oContext=null;return t.context},function(){delete i.oRemovalPromise})}else if(i.oRootContextInfo){for(var s in i.oRootContextInfo.childContexts){var l=i.oRootContextInfo.childContexts[s];if(l.oContextInfo.bIsDraftSupported){v(l,o,n,i===l);if(i.oContext){f.push(i.oContext.getPath())}}}}else{v(i,o,n,true)}var u=e.getModel();o.then(function(o){if(!i.oContextInfo.bIsCreate||!n){var a=o.context.getPath();var s=r[a];if(s){delete s.oEditingPromise;g(s,false)}}t.oBusyHelper.getUnbusy().then(function(){u.invalidateEntry(e);if(f.length>0){var t=u.mContexts;var o=function(t,e){return t.startsWith(e)};for(var n in t){var r=t[n];if(r!==e){var a=r.sDeepPath;var s=a&&f.some(o.bind(null,a));if(s){u.invalidateEntry(r)}}}}delete i.oRootContextInfo})})}function C(t,e){x(t,e,false)}function d(t,e,o,n){x(t,e,true,o);if(n){var a=n.getModel();var i="/"+a.getKey(n);var f=r[i];if(f){a.read(i,{urlParameters:{$expand:"DraftAdministrativeData,SiblingEntity"},groupId:"Changes"})}}}function g(t,o){if(t.oRootContextInfo){e(t.oRootContextInfo.childContexts,function(){this.oContextInfo.bOwnDraftExists=o})}else{t.oContextInfo.bOwnDraftExists=o}}function I(t,e){var o=c(t);o.oEditingPromise=new Promise(function(n,a){var i=function(){delete o.oEditingPromise;g(o,false);a()};e.then(function(e){if(e.draftAdministrativeData){i()}else{g(o,true);var a=e.context.getPath();r[a]={sActiveContextPath:t.getPath(),oContext:e.context,oContextInfo:{bIsDraft:true,bIsDraftSupported:true,bIsCreate:false,bIsDraftModified:false,bOwnDraftExists:false}};n(e)}},i)});o.oEditingPromise.catch(Function.prototype)}function P(t){var e=r[t];if(e){e.oContext=null}}function m(t,e,o){return new Promise(function(n,r){t.read(e+"/SiblingEntity",{success:function(e){if(e){var o="/"+t.getKey(e);var a=t.getContext(o);n(a)}else{r()}},error:function(t){r(t)},groupId:o})})}function h(t,e){var o=c(t);if(o.oContextInfo.bIsCreate){return Promise.resolve()}else if(o.sActiveContextPath){var n=r[o.sActiveContextPath];return Promise.resolve(n.oContext)}var a=o.oSiblingPromise;if(!a){if(o.oContextInfo.bIsDraftSupported&&o.oEditingPromise){a=o.oEditingPromise.then(function(e){var o=e.context.getPath();var n=o&&r[o];if(n&&!n.oRemovalPromise){return Promise.resolve(e.context)}else{return m(t.getModel(),t.getPath())}})}else{a=o.oContextInfo.bIsDraftSupported?m(t.getModel(),t.getPath(),e):Promise.resolve(t);if(o.oContextInfo.bIsDraft||!o.oContextInfo.bIsDraftSupported){o.oSiblingPromise=a}}}return a}function p(e,o){var a=r[e];if(a&&a.oSiblingPromise){return a.oSiblingPromise}else if(a&&a.sActiveContextPath){var i=r[a.sActiveContextPath];return Promise.resolve(i.oContext)}else{var s=a&&a.oContext?h(a.oContext,o):m(t.oAppComponent.getModel(),e,o);s.then(function(o){if(o){var i=n.analyseContext(o).canonicalPath;if(!r[i]){r[i]={oContextInfo:f(o),oContext:o}}}var s=a&&a.oContext;if(!s){var l=t.oAppComponent.getModel();s=l.createBindingContext(e);if(s){a=a||{};a.oContext=s;a.oContextInfo=f(s);r[e]=a}}if(s&&o&&a.oContextInfo.bIsDraftSupported){var c=a.oContextInfo.bIsDraft?e:i;var u=a.oContextInfo.bIsDraft?i:e;r[c].sActiveContextPath=u}});return s}}function y(e){if(e.treeNode.level===0){return Promise.resolve()}var o=t.oApplicationProxy.getAncestralNode(e.treeNode,1);if(o.noOData||!o.isDraft){return Promise.resolve()}var r=o.getPath(3,e.keys.slice(0,2));return b(r).then(function(o){if(!o){return null}var r=o.iDisplayMode||1;var a=false;var i=o.context?["",n.analyseContext(o.context).key]:[""];var f=function(o){if(!a&&r===2){r=o.isDraft?6:1}var n={treeNode:o,keys:i};var f={identity:n,displayMode:r};return t.oNavigationControllerProxy.adaptAppStates(e,n).then(function(){return f})};if(!o.context){return f(t.mRoutingTree.root)}var s=function(o){if(o===e.treeNode){return f(o)}var l=t.oApplicationProxy.getAncestralNode(e.treeNode,o.level+1);var c=e.keys.slice(0,l.level+1);var u=l.getPath(3,c);return b(u).then(function(t){if(!t||!t.context){return f(o)}i.push(n.analyseContext(t.context).key);r=t.iDisplayMode;a=true;return s(l)})};return t.oApplicationProxy.fillSiblingKeyPromise(e.treeNode,e.keys,i).then(s)})}function b(t){var e=r[t];if(!e){return Promise.resolve()}if(!e.oContext){return Promise.resolve({})}return new Promise(function(t){var o=null;var n=function(){t(o)};var a=function(t){t.then(function(t){var e=t.context.getPath();var a=r[e];if(a&&a.oContext&&!a.bReplaceByActive){o={context:t.context,iDisplayMode:2}}n()},n)};if(e.oRemovalPromise){e.oRemovalPromise.then(function(t){o={context:t,iDisplayMode:1};var e=t.getPath();var i=r[e];var f=i&&i.oEditingPromise;if(f){a(f)}else{n()}},n)}else if(e.bReplaceByActive){h(e.oContext).then(function(t){o={context:t,iDisplayMode:1};n()})}else if(!e.oContextInfo.bIsDraft&&e.oContextInfo.bOwnDraftExists){if(e.oEditingPromise){a(e.oEditingPromise)}else if(e.oContext){h(e.oContext).then(function(t){var e=t.getPath();var a=r[e];if(!a||!a.bReplaceByActive){o={context:t,iDisplayMode:2}}n()})}else{n()}}else{n()}})}function D(t){var e=c(t);return e&&e.aKeysFromIdentity}function S(e,o,a,i,l){return new Promise(function(c,u){var v=t.oAppComponent.getModel();var x=e&&n.analyseContextPath(e,v).canonicalPath;var C=o&&n.analyseContextPath(o,v).canonicalPath;if(x===C){c(true);return}if(!x||!C){c(false);return}var d=r[x];if(!d||!d.oContextInfo.bIsDraftSupported){c(false);return}var g=r[C];var I,P;if((!d||!d.oContext)&&(g&&!g.oContextInfo.bIsDraft)){var m=function(t){return t};d=m(g,g=d);x=m(C,C=x);i=m(l,l=i)}function p(t,e){if(!t||!e){c(false);return}if(!t.oContextInfo.bIsDraft&&!e.oContextInfo.bIsDraft){c(false);return}if(t.oContextInfo.bIsCreate&&e.oContextInfo.bIsCreate){c(false);return}if(a){b(x).then(function(t){c(!!(t&&t.context)&&t.context.getPath()===C)},u);return}if(t.aSemanticKeysValues){var o=!!e.aSemanticKeysValues;for(var n=0;o&&n<t.aSemanticKeysValues.length;n++){o=t.aSemanticKeysValues[n]===e.aSemanticKeysValues[n]}c(o);return}c(false)}if(d.oContext&&!d.oContextInfo.bIsDraft&&(!g||!g.oContext)){if(g&&g.oRemovalPromise){g.oRemovalPromise.then(function(t){var e=n.analyseContext(t).canonicalPath;c(e===x)});return}if(i&&l&&i.treeNode.entitySet===l.treeNode.entitySet){P=l&&l.keys;var y=v.getContext(C)||v.createBindingContext(C);var D=y&&f(y);if(y&&!D.bIsDraft){c(false)}else{var S=h(d.oContext);S.then(function(t){if(t.sPath&&C===t.sPath){I=t;g=r[C];if(!g||!g.oContext){s(I,l.treeNode.level,l.treeNode.entitySet,P);r[C].sActiveContextPath=d.oContext.getPath()}p(d,r[C])}else{c(false)}},function(){c(false)})}}else{c(false);return}}else{p(d,g)}})}function A(t){return r[t].oContextInfo.bIsDraftModified}function E(t){if(r[t]){r[t].oContextInfo.bIsDraftModified=true}}function R(t){if(r[t]){return r[t].oContextInfo.bIsDraft}}function M(t){if(r[t]){return r[t].oContext}}return{registerContext:s,adaptAfterObjectDeleted:P,activationStarted:C,cancellationStarted:d,editingStarted:I,getDraftSiblingPromise:h,getSiblingPromise:p,getAlternativeIdentityPromise:y,getPathOfLastShownDraftRoot:l,areTwoKnownPathesIdentical:S,markDraftAsModified:E,getIsDraftModified:A,getIdentityKeyForContext:D,checkmPath2ContextData:u,checkIfObjectIsADraftInstance:R,getContextForPath:M}}return t.extend("sap.suite.ui.generic.template.lib.ContextBookkeeping",{constructor:function(t){o(this,r(t))}})});
//# sourceMappingURL=ContextBookkeeping.js.map