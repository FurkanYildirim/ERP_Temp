sap.ui.define(["sap/ui/base/Object","sap/ui/model/base/ManagedObjectModel","sap/suite/ui/generic/template/genericUtilities/controlHelper","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/suite/ui/generic/template/genericUtilities/oDataModelHelper","sap/suite/ui/generic/template/lib/CRUDActionHandler","sap/suite/ui/generic/template/lib/StatePreserver","sap/base/util/extend","sap/base/util/isEmptyObject","sap/suite/ui/generic/template/genericUtilities/FeError","sap/base/util/UriParameters","sap/suite/ui/generic/template/lib/CommandComponentUtils"],function(e,t,n,o,r,a,i,s,l,u,c,d){"use strict";var p="lib.ComponentUtils";var f=new o(p).getLogger();var g={isPreliminary:function(){return false}};function m(e,t,n){var o;for(o=n;o.level>t.level;o=e[o.parentRoute]){f.info("Checked test node with route "+o.sRouteName)}return o===t}function v(e,o){var v=o.oTemplateContract.mRoutingTree[o.route];var C;var h;var b;var P;var y=false;var x;var T;var A=false;var R;var S=[];var F=[];var I=new d(o);function D(){return e.getModel("_templPriv")}function E(e){o.oTemplateContract.oNavigationControllerProxy.preloadComponent(e)}function N(){var t=e.getAppComponent();return t.getModel("_templPrivGlobal")}function B(){return v.level}function O(){var t=o.oTemplateContract.oApplicationProxy.getAncestralNode(v,1);if(t){var n={};var r=t.getPath(2,Ae());n.bindingContext=e.getModel().createBindingContext(r)||e.getModel().getContext(r);n.entitySet=t.entitySet;n.view=t.componentId&&o.oTemplateContract.componentRegistry[t.componentId].oController.getView();n.componentId=t.componentId;return n}return null}function M(){var e=o.oTemplateContract.oApplicationProxy.getAncestralNode(v,1);if(!e.componentId){E(e.sRouteName)}return e.componentCreated.then(function(t){var n=o.oTemplateContract.componentRegistry[t.getId()];return n.viewRegistered.then(function(){return{getText:n.oControllerUtils.oCommonUtils.getText,getRootExpand:n.oControllerUtils.oComponentUtils.getRootExpand,entitySet:e.entitySet}})})}function U(){return o.preprocessorsData}function w(e){var t=o.oTemplateContract.oNavigationControllerProxy.getCurrentIdentity();var n=t.keys;var r=[];for(var a=0;a<e;a++){r[a]=""}var i=o.oTemplateContract.oApplicationProxy.fillSiblingKeyPromise(t.treeNode,n,r,"Changes");return i.then(function(e){return{keys:r,treeNode:e}})}function j(){var e=U();var t=H().getObject("/templateSpecific/streamEnabledAssociatedEntites");var n=[];if(e&&e.rootContextExpand){n=e.rootContextExpand}n=t&&t.length>0?n.concat(t):n;if(n){var o=n.filter(function(e,t){return n.indexOf(e)===t});return o.join(",")}}function H(){return o.oParameterModel}function V(e,t,n){if(typeof n!=="function"){throw new u(p,"Event handler must be a function")}F.push({template:e,event:t,handler:n})}function L(e,t,n){for(var o=F.length;o--;){if(F[o].handler===n&&F[o].event===t&&F[o].template===e){F.splice(o,1)}}}function k(e,t,n){for(var o=0;o<F.length;o++){if(F[o].event===t&&F[o].template===e){F[o].handler(n)}}}function q(e){return e.getMetadata().getName()}function $(){return o.oApplication.isComponentActive(e)}function G(e){var t=o.oTemplateContract.componentRegistry[e];var n=o.oTemplateContract.mRoutingTree[t.route];var r=n.level<v.level;var a=r?m(o.oTemplateContract.mRoutingTree,n,v):m(o.oTemplateContract.mRoutingTree,v,n);return(n.level-v.level)*a}function K(){return o.oNavigationObserver.getProcessFinished(true)}function W(e,t){var n=K();n.then(function(){if($()){if(t){se(true,false)}k(q(o.oController),"PageDataLoaded",{context:e});if(e&&Ee()){var n=e.getObject();if(!n.IsActiveEntity){o.oApplication.getDraftSiblingPromise(e)}}}})}function _(){C.then(function(e){if(e){W(e)}})}function z(){o.oHeaderLoadingObserver.startProcess();if(!x){var e=new Promise(function(e){x=e});o.oApplication.getBusyHelper().setBusy(e,undefined,undefined,true)}}function Q(){if(!h){C=new Promise(function(e){h=e})}}if(v.getPath(3)){Q()}else{C=Promise.resolve()}function J(t){f.info("Request header data",t.getSource().getPath(),"Class sap.suite.ui.generic.template.lib.ComponentUtils");A=true;Q();if(!e.getComponentContainer().getElementBinding().isSuspended()){z()}}function X(){if(x){x();x=null}if(T){T();T=null}o.oHeaderLoadingObserver.stopProcess()}function Y(t){var n=t.getSource().getBoundContext();if(n){return n}if(e.getComponentContainer().getElementBinding().isSuspended()){n=null}else{n=g}ae();return n}function Z(){y=true;var e=o.oTemplateContract.oNavigationControllerProxy.getActiveComponents();var t=e.find(function(e){return o.oTemplateContract.componentRegistry[e].utils.getDataNotExisting()});var n=o.oTemplateContract.componentRegistry[t];var r=o.oTemplateContract.mRoutingTree[n.route];o.oTemplateContract.oNavigationControllerProxy.navigationContextNotFound(r)}function ee(){return y}function te(){A=false;if(!P){return}if(P===g){Z();ae()}else if(!e.getComponentContainer().getElementBinding().isSuspended()){var t=e.getBindingContext();var n=Pe(t);var r=n.bIsDraft||o.oApplication.getObjectInEditMode();var a;if(r){o.oApplication.setObjectInEditMode(false);a=n.bIsCreate?4:2}else{a=1}var i=D();var s=e.getModel("ui");i.setProperty("/objectPage/displayMode",a);s.setProperty("/editable",r);s.setProperty("/enabled",true);s.setProperty("/createMode",n.bIsCreate);(o.methods.updateBindingContext||Function.prototype)(t);if(h){h(P)}}else{return}h=null;P=null}function ne(e){f.info("Received header data",e.getSource().getPath(),"Class sap.suite.ui.generic.template.lib.ComponentUtils");b();X();if(A){P=Y(e)}te()}function oe(e){b();var t=Y(e);if(t&&t.isPreliminary()){return}P=t;te();o.oHeaderLoadingObserver.stopProcess()}function re(t){y=false;o.oHeaderLoadingObserver.startProcess();var n=new Promise(function(e){b=e});Q();if(o.methods.beforeRebind){o.methods.beforeRebind(n)}P=null;v.bindElement(e.getComponentContainer(),t,false,{dataRequested:J,dataReceived:ne,change:oe});R=t;if(o.methods.afterRebind){o.methods.afterRebind()}}function ae(){Q();var t=e.getComponentContainer();t.setBindingContext();v.unbindElement(t);R=null;P=null;A=false;X()}function ie(){var e=Ae();var t=e.length===S.length;for(var n=0;n<e.length&&t;n++){t=e[n]===S[n]}S=e;return!t}function se(e,t){o.reuseComponentsReady.then(function(n){for(var o in n){var r=n[o];if(!t||r.isStarted()){r.pathUnchangedCallBack(e)}}})}function le(e,t){var n=Object.create(null);for(var o in e){var r=e[o];n[o]=t(r,o)}return n}function ue(){var e=D();for(var t in v.embeddedComponents){var n=!!v.embeddedComponents[t].definition.hiddenByDefault;e.setProperty("/generic/embeddedComponents/"+t+"/hidden",n)}}function ce(t,n){var r=ie();if(r&&!n){ue()}if(!t){if(o.routingSpec&&o.routingSpec.noOData){W(null,r)}return}var a=e.getComponentContainer();if(!a){return}var i=e.getModel("ui");var s=!!o.nonDraftCreateContext;if(s){var l=a.getBindingContext();if(l===o.nonDraftCreateContext){return}i.setProperty("/enabled",true);i.setProperty("/editable",true);i.setProperty("/createMode",true);ae();if(h){h(o.nonDraftCreateContext);h=null}else{C=Promise.resolve(o.nonDraftCreateContext)}_();if(o.methods.beforeRebind){o.methods.beforeRebind(C)}a.setBindingContext(o.nonDraftCreateContext);Promise.all([o.oViewRenderedPromise,o.viewRegistered]).then(se.bind(null,true,false));if(o.methods.afterRebind){o.methods.afterRebind()}}else{var u=a.getElementBinding();if(u){if(R===t){if(u.isSuspended()){u.resume();te()}if(A){z()}o.oApplication.getBusyHelper().getUnbusy().then(se.bind(null,r,false));if(!n){_()}if(!n&&!Ee()){var c=o.oApplication.getEditFlowOfRoot();if(c==="direct"){i.setProperty("/editable",true)}else{i.setProperty("/editable",false)}}i.setProperty("/enabled",true);return}else if(!n){ae()}}i.setProperty("/enabled",false);i.setProperty("/editable",false);i.setProperty("/createMode",false);re(t);_()}}function de(t,n){var r={};if(t){r.discardPromise=t}var a=e.getModel();if(a.hasPendingChanges()){var i=o.oController.getView();i.setBindingContext(null);a.resetChanges();i.setBindingContext()}var s=e.getModel("ui");if(n||s.getProperty("/editable")){delete o.nonDraftCreateContext;if(!t){delete o.nonDraftCreateContext;s.setProperty("/editable",false);var l=D();l.setProperty("/objectPage/displayMode",1)}k(q(o.oController),"AfterCancel",r)}}function pe(e,t){return Ee()?null:o.oTemplateContract.oNavigationControllerProxy.navigateForNonDraftCreate(e,t)}function fe(e,t){o.oApplication.setObjectInEditMode(t);o.oTemplateContract.oNavigationControllerProxy.adaptUrlAfterNonDraftCreateSaved(e)}function ge(){return R}function me(t){var n=e.getComponentContainer().getElementBinding();if(n){e.getModel().invalidateEntry(n.getBoundContext());if(n.isSuspended()){ae()}else{if(!T){var r=new Promise(function(e){T=e});o.oTemplateContract.fnAddSideEffectPromise(r)}n.refresh(!t);o.bWithoutAssociationsRefresh=false}}}function ve(t){t=t||e.getIsRefreshRequired();if(t||!l(o.mRefreshInfos)||o.bWithoutAssociationsRefresh){(o.methods.refreshBinding||Function.prototype)(t,o.mRefreshInfos,o.bWithoutAssociationsRefresh);e.setIsRefreshRequired(false);o.mRefreshInfos=Object.create(null)}se(t,true)}function Ce(t){var n=e.getModel();var r={canonicalRequest:!o.oTemplateContract.bCreateRequestsCanonical,batchGroupId:t||"facets",updateAggregatedMessages:true};n.read(R,r)}function he(t){if(Ee()){var n=e.getComponentContainer();var o=n.getElementBinding();if(o&&!o.isSuspended()){o.suspend();t.catch(function(){o.resume()})}}}function be(){var t=e.getComponentContainer();if(o.nonDraftCreateContext){t.setBindingContext();delete o.nonDraftCreateContext;return}var r=t.getElementBinding();if(r&&!r.isSuspended()){var a=o.oTemplateContract.oValidationMessageBinding.getAllCurrentContexts();var i=o.oController.getView();var s=a.some(function(e){var t=e.getObject();var o=t.controlIds;return o.some(function(e){return n.isElementVisibleOnView(e,i)})});if(s){ae()}else{r.suspend()}X()}}function Pe(t){var n=B();return o.oApplication.registerContext(t,n,e.getEntitySet(),Ae())}function ye(e){if(e.level<2){return[e.entitySet]}var t=o.oTemplateContract.mRoutingTree[e.parentRoute];var n=ye(t);if(e!==v){n.push(e.navigationProperty?n[t.level-1]+"/"+e.navigationProperty:e.entitySet)}return n}function xe(){return v.level<2?[]:ye(v)}function Te(e,n,r){var a;for(a=v;a.level>r;){a=o.oTemplateContract.mRoutingTree[a.parentRoute]}var i=new t(e);i.bindProperty("/"+n).attachChange(function(e){var t=e.getSource().getValue();o.oTemplateContract.oNavigationControllerProxy.setTextForTreeNode(a,t)});a.contextTargets=a.contextTargets||[];a.contextTargets.push(e)}function Ae(){return o.oApplication.getCurrentKeys(B())}function Re(t){return o.oApplication.getCommunicationObject(e,t)}function Se(e,t,n,r,a){o.oTemplateContract.oNavigationControllerProxy.navigateToChildInHierarchy(v,e,n,t,r,a)}function Fe(e,t,n){o.oTemplateContract.oNavigationControllerProxy.navigateFromNodeAccordingToContext(v,e,t,n)}function Ie(){return v.headerTitle}function De(e){o.oTemplateContract.oNavigationControllerProxy.setTextForTreeNode(v,e)}function Ee(){return v.isDraft}function Ne(){return!(o.routingSpec&&o.routingSpec.noOData)}function Be(){return!o.oTemplateContract.bCreateRequestsCanonical}function Oe(){return C}function Me(){return o.oTemplateContract.oPaginatorInfo[B()-1]}function Ue(t){var n=B();if(t&&!t.suppressButtons&&t.objectPageNavigationContexts.length>0){var a=t.objectPageNavigationContexts[0];var i=r.analyseContext(a);var s=i.entitySet;t.suppressButtons=o.mRefreshInfos[s]||e.getIsRefreshRequired()}o.oTemplateContract.oPaginatorInfo[n]=t}function we(e,t){o.reuseComponentsReady.then(function(n){var o=t.getComponentInstance();for(var r in n){if(o===n[r].component){var a=D();a.setProperty("/generic/embeddedComponents/"+r+"/isInVisibleArea",e);return}}})}function je(){return o.oStatePreserverPromise.then(function(e){return e.stateChanged()})}o.oStatePreserverPromise=o.reuseComponentsReady.then(function(t){var n=o.methods.getStatePreserverSettings&&o.methods.getStatePreserverSettings();if(!n){return{getUrlParameterInfo:function(){return Promise.resolve({})},applyAppState:Function.prototype,stateChanged:Function.prototype}}var r="sap-iapp-state"+(v.level===0?"":"-"+v.entitySet);var a=function(e){var n=e?"getInitialState":"getCurrentState";var r=e?"stGetInitialState":"stGetCurrentState";return function(){var e=o.methods[n]?o.methods[n]():Object.create(null);var a=function(t,n){if(t.component[r]){var o=t.component[r]();for(var a in o){e["$embeddedComponent$"+n.length+"$"+n+"$"+a]=o[a]}}};le(t,a);return e}};var l=s({appStateName:encodeURI(r),getCurrentState:a(false),getInitialState:a(true),applyState:function(e,n){var r=Object.create(null);var a=Object.create(null);for(var i in e){if(i.indexOf("$embeddedComponent$")===0){var s=i.substring(19);var l=s.indexOf("$");var u=Number(s.substring(0,l));var c=s.substring(l+1,l+u+1);var d=a[c];if(!d){d=Object.create(null);a[c]=d}var p=s.substring(l+u+2);d[p]=e[i]}else{r[i]=e[i]}}(o.methods.applyState||Function.prototype)(r,n);var f=function(e,t){if(e.component.stApplyState){e.component.stApplyState(a[t]||Object.create(null),n)}};Promise.all([o.oViewRenderedPromise,C]).then(le.bind(null,t,f))},oComponent:e},n);var u=new i(o.oTemplateContract,l);o.oApplication.registerStateChanger(u.getAsStateChanger());return u});o.oTemplateContract.oStatePreserversAvailablePromise=Promise.all([o.oTemplateContract.oStatePreserversAvailablePromise,o.oStatePreserverPromise]);function He(){var e=o.oTemplateContract.oFlexibleColumnLayoutHandler;return e?e.getFclProxy(v):{handleDataReceived:v.level?null:Function.prototype,isListAndFirstEntryLoadedOnStartup:v.level?null:Function.prototype,isNextObjectLoadedAfterDelete:Function.prototype}}function Ve(){return v.page.component.settings||{}}function Le(){var t=e.getAppComponent().getManifestEntry("sap.ui5");var n=t.extends&&t.extends.extensions&&t.extends.extensions["sap.ui.controllerExtensions"];var r=o.methods.oComponentData.templateName+"#"+o.oComponent.getAppComponent().getMetadata().getComponentName()+"::"+o.methods.oComponentData.templateName+"::"+o.oComponent.getEntitySet();n=n&&(n[r]||n[o.methods.oComponentData.templateName]);n=n&&n["sap.ui.generic.app"];var a=n&&Object.keys(n).find(function(t){return n[t]&&n[t].EntitySet===e.getEntitySet()});return a&&n[a]}function ke(){var t=e.getAppComponent().getManifestEntry("sap.ui5");var n=t.extends&&t.extends.extensions&&t.extends.extensions["sap.ui.viewExtensions"];return n&&n[o.methods.oComponentData.templateName]}function qe(e){o.aUnsavedDataCheckFunctions=o.aUnsavedDataCheckFunctions||[];o.aUnsavedDataCheckFunctions.push(e)}function $e(){if(o.methods.adaptToChildContext){var e=D().getProperty("/generic/currentActiveChildContext");o.methods.adaptToChildContext(e)}}var Ge;function Ke(){Ge=Ge||new a(o.oTemplateContract,o.oController,o.oControllerUtils.oCommonUtils,o.methods.prepareForMessageHandling||function(){return Promise.resolve()});return Ge}function We(e){if(o.methods.executeAfterInvokeActionFromExtensionAPI){o.methods.executeAfterInvokeActionFromExtensionAPI(e,o.oControllerUtils.oCommonUtils)}}function _e(e){if(o.methods.executeBeforeInvokeActionFromExtensionAPI){o.methods.executeBeforeInvokeActionFromExtensionAPI(e,o.oControllerUtils.oCommonUtils)}}function ze(){var e=o.oController.getView();var t=e.getModel();if(t.hasPendingChanges(true)){return true}if(o.aUnsavedDataCheckFunctions){return o.aUnsavedDataCheckFunctions.some(function(e){return e()})}return false}function Qe(e){if(o.reactivate&&!e){return}if(!o.oController){return}var t=o.oController.onLeaveAppExtension&&o.oController.onLeaveAppExtension.apply(o.oController,[e]);o.reactivate=o.reuseComponentsReady.then(function(n){var o=Object.create(null);le(n,function(t,n){var r=t.leaveApp(e);if(r&&!e){o[n]=r}});return!e&&function(){if(t){t()}for(var e in o){o[e]()}}})}function Je(){if(o.oTemplateContract.oFlexibleColumnLayoutHandler){o.oTemplateContract.oFlexibleColumnLayoutHandler.hidePlaceholder(v)}else{o.oTemplateContract.oNavigationHost.hidePlaceholder()}if(v.level===0){var e=o.oTemplateContract.oNavigationControllerProxy.oRouter.getTargets();var t=e.getTarget("root");delete t._oOptions.placeholder}}function Xe(t){var n=o.oTemplateContract.oNavigationControllerProxy.getActiveComponents();var r=n.indexOf(e.getId());var a=[];for(var i=r;i<n.length;i++){var s=n[i];var l=o.oTemplateContract.componentRegistry[s];if(l.methods.prepareForMessageHandling){a.push(l.methods.prepareForMessageHandling(t))}}return Promise.all(a)}function Ye(){return o.oViewRenderedPromise}function Ze(){return o.viewRegistered}function et(){return v.selectionInfo}function tt(){var e=Ve();var t=c.fromQuery(window.location.search).get("sap-fe-xx-lazyloadingtest");return t!=null?t==="true":e.renderingBehavior&&e.renderingBehavior.waitForViewportEnter}function nt(){return o.lastFocus}function ot(e,t){var n=e["sap.app"].crossNavigation&&e["sap.app"].crossNavigation.outbounds;return n&&n[t]||Object.create(null)}function rt(){return o.oTemplateContract.bStateHandlingSuspended}return{getBusyHelper:function(){return o.oApplication.getBusyHelper()},attach:function(e,t,n){V(q(e),t,n)},detach:function(e,t,n){L(q(e),t,n)},fire:function(e,t,n){k(q(e),t,n)},getPreprocessorsData:U,getRootExpand:j,getParameterModelForTemplating:H,bindComponent:ce,cancelEdit:de,getNonDraftCreatePromise:pe,adaptUrlAfterNonDraftCreateSaved:fe,getBindingPath:ge,refreshBinding:ve,refreshBindingUnconditional:me,suspendBinding:be,messagesRefresh:Ce,getTemplatePrivateModel:D,getTemplatePrivateGlobalModel:N,registerContext:Pe,getViewLevel:B,getMainComponentDetails:O,getMainComponentUtils:M,getBreadCrumbInfo:xe,registerAncestorTitleUpdater:Te,getCurrentKeys:Ae,getCommunicationObject:Re,navigateRoute:Se,navigateAccordingToContext:Fe,getTitle:Ie,setText:De,onBeforeDraftTransfer:he,isDraftEnabled:Ee,isODataBased:Ne,getNoStateMessagesForTables:Be,isComponentActive:$,getHierachicalDistance:G,getDataNotExisting:ee,getHeaderDataAvailablePromise:Oe,getPaginatorInfo:Me,setPaginatorInfo:Ue,onVisibilityChangeOfReuseComponent:we,getNavigationFinishedPromise:K,stateChanged:je,unbind:ae,getFclProxy:He,getSettings:Ve,getControllerExtensions:Le,getViewExtensions:ke,registerUnsavedDataCheckFunction:qe,layoutChanged:$e,getCRUDActionHandler:Ke,executeAfterInvokeActionFromExtensionAPI:We,executeBeforeInvokeActionFromExtensionAPI:_e,preloadComponent:E,isComponentDirty:ze,getTargetKeyFromLevel:w,leaveApp:Qe,hidePlaceholder:Je,prepareForMessageHandling:Xe,getViewRenderedPromise:Ye,getViewInitializedPromise:Ze,getSelectionInfo:et,isRenderingWaitingForViewportEntered:tt,getLastFocus:nt,getOutboundNavigationIntent:ot,getToolbarDataFieldForActionCommandDetails:I.getToolbarDataFieldForActionCommandDetails,getToolbarDataFieldForIBNCommandDetails:I.getToolbarDataFieldForIBNCommandDetails,isStateHandlingSuspended:rt}}return e.extend("sap.suite.ui.generic.template.lib.ComponentUtils",{constructor:function(e,t){s(this,v(e,t))}})});
//# sourceMappingURL=ComponentUtils.js.map