sap.ui.define(["sap/m/p13n/Popup","sap/m/p13n/SelectionPanel","sap/suite/ui/generic/template/genericUtilities/metadataAnalyser","sap/suite/ui/generic/template/lib/filterHelper","sap/fe/navigation/SelectionVariant","sap/base/util/deepExtend"],function(e,a,t,r,n,i){"use strict";var s={};s.createCardForPreview=function(e){return o(e)};var o=function(e){var a=e["component"];var t=a.getAppComponent().getMetadata();var r=t.getManifestEntry("sap.ui");var n=t.getManifestEntry("sap.app");if(n&&n["crossNavigation"]){delete n["crossNavigation"]}var i={};var s="user."+n.id+"."+Date.now();n.type="card";n.id=s;i["sap.app"]=p(n);i["sap.ui"]=r;i["sap.card"]=c(e);i["sap.insights"]=v(e);i["sap.ui5"]=u();return i};var l=function(e){var a=e.oServices.oApplication.getNavigationHandler();return a.getIAppStateKey()};var u=function(){return{_version:"1.1.0",contentDensities:{compact:true,cozy:true},dependencies:{libs:{"sap.insights":{lazy:false}}}}};var p=function(e){var a=i({},e);if(a&&a.dataSources&&a.dataSources.mainService&&a.dataSources.mainService.settings){a.dataSources["filterService"]=a.dataSources.mainService;a.dataSources["filterService"].settings["odataVersion"]="2.0"}return a};var c=function(e){var a={};var t=e["component"].getMetadata().getName();a["type"]=f(t);a["configuration"]=m(e);a["data"]=s.fnCreateManifestSapCardData(e,a);a["header"]=s.fnCreateManifestSapCardHeader(e,a);a["extension"]="module:sap/insights/CardExtension";if(a.type==="Analytical"){a["content"]=s.fnCreateManifestSapAnalyticalCardContent(e,a)}else{a["content"]=s.fnCreateManifestSapTableCardContent(e,a)}s.getCardActions(e,a);return a};var v=function(e){var a=e["component"],t=e["currentControlHandler"],r=a.getAppComponent().getMetadata(),n=r.getManifestEntry("sap.app"),i=n.id,s="RT";return{parentAppId:i,cardType:s,allowedChartTypes:t.getAvailableChartTypes&&t.getAvailableChartTypes(),versions:{ui5:sap.ui.version+"-"+sap.ui.getVersionInfo().buildTimestamp},filterEntitySet:e.entitySet.name}};var f=function(e){switch(e){case"sap.suite.ui.generic.template.ListReport.Component":return"Table";case"sap.suite.ui.generic.template.AnalyticalListPage.Component":return"Analytical";default:return"List"}};var m=function(e){var a={};var t=e["component"];var r=t.getModel().sServiceUrl;a["parameters"]=s.getFilterDetails(e)["filters"];a["parameters"]["_entitySet"]={value:e.entitySet.name};a["parameters"]["_urlSuffix"]={value:"/Results"};a["destinations"]={service:{name:"(default)",defaultUrl:"/"}};a["csrfTokens"]={token1:{data:{request:{url:"{{destinations.service}}"+r,method:"HEAD",headers:{"X-CSRF-Token":"Fetch"}}}}};return a};s.getFilterDetails=function(e){var a={filters:{}},i=a.filters,s=e.oSmartFilterbar,o=s&&s.getModel(),l=e.view.getModel(),u=e.entityType,p=[],c=[],v=[],f=[],m,y=[],b=[],T=[];if(o){var D=t.checkAnalyticalParameterisedEntitySet(o,e.entitySet.name);if(D){var O=t.getParametersByEntitySet(o,e.entitySet.name);if(O.entitySetName){T=O.parameters||[]}}}var P=t.getParametersByEntitySet(l,e.entitySet.name,true).parameters;var V="";P.forEach(function(a){var t=h(a);var n=r.getParameterDefaultValue(o,u,t,e);var c=r.getParameterDefaultValue(l,e.entitySet,t,e);var f=n||c||a.defaultValue||"";var m=r.getParameterActualValue(a,s);V=r.getLabelForConfigParams(a,s,i,e,f);var g=r.IsSemanticDateRangeValid(e,a);if(g){r.setFilterRestrictionToSemanticDateRange(a,true);f=r.getDateRangeDefaultValue(e,a)||f;m=r.getDateRangeValue(m,a,true)||m;if(V&&typeof V==="string"){V=V.substring(0,V.indexOf("(")-1)}else if(f){V=f;r.getLabelForConfigParams(a,s,i,e,f,true)}}if(t){v.push(a)}i[a]={value:m?m:f,type:r.getPropertyType(a),description:a&&a.description,label:V};i[a]["description"]=C(a,"description");p.push(a);y.push(a)});T=T.filter(function(e){return!y.includes(e)});if(u&&u.property){b=d(u.property,T)}for(var M=0;M<b.length;M++){var x=b[M],R="";var A=S(x,u.property);var F=h(A);var I=r.getFilterDefaultValue(x.name,u)||x.defaultValue||"";var N=r.getParameterActualValue(x.name,s);if(y.includes(x.name)){V=r.getLabelForConfigParams(x.name,s,i,e,I);var $=r.IsSemanticDateRangeValid(e,x);if($){r.setFilterRestrictionToSemanticDateRange(x,true);I=r.getDateRangeDefaultValue(e,x.name)||I;N=r.getDateRangeValue(N,x,true)||N;if(V&&typeof V==="string"){V=V.substring(0,V.indexOf("(")-1)}else if(I){V=I;r.getLabelForConfigParams(x.name,s,i,e,I,true)}}i[x.name]={value:N?N:I,type:r.getPropertyType(x),description:x&&x.description,label:V};if(F){v.push(F)}p.push(x.name)}else{m=new n;var E=r.getLabelForConfigParams(x.name,s,i,e,I);var $=r.IsSemanticDateRangeValid(e,x);if($){r.setFilterRestrictionToSemanticDateRange(x,false);r.addDateRangeValueToSV(e,x,I,m,E)}else{if(N){r.addFiltervalues(s,x.name,m,E)}else if(I){var L=r.getRelatedTextToRange({Low:I},E,s,x.name);m.addSelectOption(x.name,"I","EQ",I,null,L)}else{m.addSelectOption(x.name,"I","EQ",R)}}i[x.name]={value:m.toJSONString(),type:r.getPropertyType(x),description:x&&x.description};i[x.name].value=r.enhanceVariant(i[x.name].value);if(F){f.push(F)}c.push(x.name)}i[x.name]["description"]=C(x,"description")}var w=e["oFECustomFilterData"];if(w){m=new n;m.addSelectOption(w.name,"I","EQ",w.value);i[w.name]={value:m.toJSONString(),type:"string",description:""};i[w.name].value=r.enhanceVariant(i[w.name].value);c.push(w.name)}var U=s.getBasicSearchName(),H=s.getBasicSearchValue();if(H){m=new n;m.addSelectOption(U,"I","EQ",H);i[U]={value:m.toJSONString(),type:"string",description:""};i[U].value=r.enhanceVariant(i[U].value);c.push(U)}var _=g(c);var B=g(p);var J=g(v);var k=g(f);r.updateRangeValue(i);i["_relevantODataFilters"]={value:_};i["_relevantODataParameters"]={value:B};i["_mandatoryODataParameters"]={value:J};i["_mandatoryODataFilters"]={value:k};return a};var g=function(e){return e&&e.filter(function(a,t){return e.indexOf(a)===t})};var d=function(e,a){var t=e.filter(function(e){return y(e)})||[];if(a&&a.length>0){e.forEach(function(e){var r="P_"+e.name;if(a.includes(r)){t.push(e)}})}return t};var y=function(e){return e["sap:filterable"]?e["sap:filterable"]!=="false":true};var S=function(e,a){if(a&&a.length){var t=a.filter(function(a){return a.name===e.name});return t&&t[0]}};var h=function(e){var a=[];if(e&&e.extensions){a=e.extensions;for(var t=0;t<a.length;t++){if(a[t].name==="parameter"&&a[t].value==="mandatory"){return e.name}else if(a[t].name==="required-in-filter"&&a[t].value==="true"){return e.name}}}};var C=function(e,a){var t;if(e&&e[a]){return e[a]}else if(e&&e.extensions){t=e.extensions;for(var r=0;r<t.length;r++){if(t[r].name===a){return t[r].value}}}return undefined};var b=function(e,a){if(e&&a){if(e.indexOf("?")===-1){e+="?"+a}else{e+="&"+a}}return e};s.fnCreateManifestSapCardData=function(e,a){var t={};var r=e["component"],n=e["component"].getMetadata().getName();var i=r.getModel().sServiceUrl;var s=i;var o=e["currentControlHandler"];var l="";if(o.getBinding()){l=o.getBinding().getDownloadUrl()}if(n==="sap.suite.ui.generic.template.ListReport.Component"){var u="$top=15";l=b(l,u)}var p="$inlinecount=allpages";l=b(l,p);var c={};c.content={method:"GET",url:l,headers:{Accept:"application/json"}};t["request"]={url:"{{destinations.service}}"+s+"/$batch",method:"POST",headers:{"X-CSRF-Token":"{{csrfTokens.token1}}"},batch:c};return t};s.fnCreateManifestSapCardHeader=function(e,a){var t=e["currentControlHandler"].getToolbar();var r=e["component"].getMetadata().getName(),n=t.getTitleControl()&&t.getTitleControl().getText();if(n&&n.indexOf("(")>-1&&r==="sap.suite.ui.generic.template.ListReport.Component"){var i=n.split("(");n=i[0].trim()}var s="__count";var o={text:"{= ${"+s+"} === '0' ? '' : ${"+s+"} }"};var l={title:n,subTitle:"",actions:{},status:o,data:{path:"/content/d"}};return l};s.fnCreateManifestSapTableCardContent=function(e,a){var t=V(e);var r={data:{path:"/content/d/results"},maxItems:15,row:{columns:t,actions:{}}};return r};s.fnCreateManifestSapAnalyticalCardContent=function(e,a){var t={},r=e["currentControlHandler"],n=r.getInnerChart(),i=r.getBinding().getMeasureDetails(),s=r.getBinding().getDimensionDetails();t["data"]={path:"/content/d/results"};t["chartType"]=n.getChartType();t["measures"]=O(i);t["dimensions"]=P(s);t["feeds"]=n._getVizFrame().getFeeds().map(function(e){if(e.getValues().length){return{type:e.getType(),uid:e.getUid(),values:D(t,e.getType())}}});t["chartProperties"]=T(n);t["actionableArea"]="Chart";t["actions"]={};return t};var T=function(e){var a={categoryAxis:{title:{visible:true}},valueAxis:{title:{visible:true}}};e.setVizProperties(a);return e.getVizProperties()};var D=function(e,a){var t=[],r=[];if(a==="Measure"){for(var n in e["measures"]){t.push(e["measures"][n].name)}return t}else if(a==="Dimension"){for(var n in e["dimensions"]){r.push(e["dimensions"][n].name)}return r}};var O=function(e){var a=[];for(var t in e){var r=e[t];a.push({name:r.analyticalInfo.name,value:"{"+r.analyticalInfo.measurePropertyName+"}"})}return a};var P=function(e){var a=[];for(var t in e){var r=e[t];a.push({name:r.name,value:"{"+r.analyticalInfo.name+"}"})}return a};s.getCardActions=function(e,a){var t=window.hasher.getHash(),r=t.split("&/")[0];if(r.includes("?")){r=r.split("?")[0].split("-")}else{r=r.split("-")}var n={ibnTarget:{semanticObject:r[0],action:r[1]},sensitiveProps:[],ibnParams:{nhHybridIAppStateKey:l(e.oTemplateUtils)}};var i=[{type:"Navigation",parameters:"{= extension.formatters.getNavigationContext(${parameters>/headerState/value})}"}];var s=JSON.parse(JSON.stringify(n));var o=[{type:"Navigation",parameters:"{= extension.formatters.getNavigationContext(${parameters>/contentState/value}, ${})}"}];a.configuration.parameters.headerState={value:JSON.stringify(n)};a.configuration.parameters.contentState={value:JSON.stringify(s)};a.header.actions=i;if(a.type!="Analytical"){var u=e["component"].getModel("_templPriv");if(!u.getProperty("/listReport/bSupressCardRowNavigation")){a.content.row.actions=o}}};var V=function(e){var a=e["entityType"];var t=e["currentControlHandler"].getModel().getMetaModel();var r=[];e["currentControlHandler"].getVisibleProperties().filter(function(e){var n=e.data("p13nData");var i=n&&n.columnKey;var s=n&&n.description||"";var o=t.getODataProperty(a,n.leadingProperty);if(o&&!(o["sap:label"]||o["com.sap.vocabularies.Common.v1.Label"])){return}if(o){if(e.getVisible()&&(i.indexOf("DataFieldForAnnotation")<0&&!n.actionButton&&!!n.leadingProperty)){var l={};s="{"+s+"}";var u="{"+o.name+"}";var p="";if(o["Org.OData.Measures.V1.ISOCurrency"]&&o["Org.OData.Measures.V1.ISOCurrency"].Path){u=u.concat(" "+"{"+p+o["Org.OData.Measures.V1.ISOCurrency"].Path+"}")}if(o["Org.OData.Measures.V1.Unit"]&&o["Org.OData.Measures.V1.Unit"].Path){u=u.concat(" "+"{"+p+o["Org.OData.Measures.V1.Unit"].Path+"}")}if(o["com.sap.vocabularies.Common.v1.Text"]&&o["com.sap.vocabularies.Common.v1.Text"].Path){var c=o["com.sap.vocabularies.Common.v1.Text"]["com.sap.vocabularies.UI.v1.TextArrangement"];var v=c&&c.EnumMember.split("/")[1];if(v==="TextOnly"){u="{= $"+s+" === '' ? '' : $"+s+"}"}else if(v==="TextLast"){u="{= $"+u+" === '' ? '' : $"+u+"}"+"{= $"+s+" === '' ? '' : ' (' + ($"+s+") + ')'}"}else if(v==="TextSeparate"){u="{= $"+u+" === '' ? '' : $"+u+"}"}else{u="{= $"+s+" === '' ? '' : $"+s+"}"+"{= $"+u+" === '' ? '' : ' (' + ($"+u+") + ')'}"}}if(o["com.sap.vocabularies.UI.v1.IsImageURL"]&&o["com.sap.vocabularies.UI.v1.IsImageURL"].Bool==="true"){l["title"]=o["com.sap.vocabularies.Common.v1.Label"].String||o["sap:label"];l["icon"]={src:"{"+o.name+"}"}}else{l["title"]=o["com.sap.vocabularies.Common.v1.Label"].String||o["sap:label"];if(o.type==="Edm.DateTime"||o.type==="Edm.DateTimeOffset"){var f=JSON.stringify(n.typeInstance.oFormat.oFormatOptions).replace(/"/g,"'");l["value"]="{=$"+u+" ? format.dateTime($"+u+", "+f+") : ''}"}else{l["value"]=u}}r.push(l)}}});return r};return s});
//# sourceMappingURL=AddCardsHelper.js.map