sap.ui.define(["sap/ui/base/Object","sap/ui/generic/app/navigation/service/SelectionVariant","sap/ui/Device","sap/ui/comp/state/UIState","sap/suite/ui/generic/template/listTemplates/listUtils","sap/ui/core/mvc/ControllerExtension","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/base/util/deepEqual","sap/base/util/extend","sap/base/util/deepExtend","sap/suite/ui/generic/template/genericUtilities/FeError","sap/suite/ui/generic/template/listTemplates/semanticDateRangeTypeHelper"],function(e,t,a,r,i,n,o,l,s,c,p,u){"use strict";var S="listTemplates.controller.IappStateHandler";var f=new o(S).getLogger();function d(e,o,d){var m=d.oServices.oApplication.getNavigationHandler();var g="sap.suite.ui.generic.template.customData";var v="sap.suite.ui.generic.template.genericData";var y="sap.suite.ui.generic.template.extensionData";var b="visual";var V="compact";var C;var F=false,h=false,D=null,P;var I=null;var O=d.oComponentUtils.getSettings();var w=null;var N={appStateKey:"",urlParams:{}};var M={};var U="sap-iapp-state";if(!e.oSmartFilterbar.isLiveMode()){e.oSmartFilterbar.setSuppressSelection(true)}var A=o.byId("template::Page");var T=d.oCommonUtils.getControlStateWrapper(A);T.attachStateChanged(function(){ne()});var E,_;_=e.oSmartChart&&d.oCommonUtils.getControlStateWrapper(e.oSmartChart);E=e.oSmartTable&&d.oCommonUtils.getControlStateWrapper(e.oSmartTable);function x(){return C.then(function(){if(N.appStateKey){return{"sap-iapp-state":[N.appStateKey]}}return N.urlParams})}function B(t){if(t&&t.editStateFilter!==undefined){var r=o.byId("editStateFilter");if(r){r.setSelectedKey(t.editStateFilter===null?0:t.editStateFilter)}}var i=e.oController.getOwnerComponent().getModel("_templPriv");if(t.chartVariantId&&e.oSmartChart){e.oSmartChart.setCurrentVariantId(t.chartVariantId)}if(t.filterMode){i.setProperty("/alp/filterMode",t.filterMode);e.filterBarController.handleFilterSwitch(t.filterMode)}else{K()}if(t.contentView){var n=i.getProperty("/alp/enableHybridMode");if(n===false&&t.contentView==="charttable"){i.setProperty("/alp/contentView","chart")}else{(a.system.phone||a.system.tablet&&!a.system.desktop)&&t.contentView==="charttable"?i.setProperty("/alp/contentView","chart"):i.setProperty("/alp/contentView",t.contentView)}}if(t.autoHide){i.setProperty("/alp/autoHide",t.autoHide)}}function H(e){if(!e){return}var t=true;var a=function(a){if(!(a instanceof n)){throw new p(S,"State must always be retrieved with respect to a ControllerExtension")}var r=a.getMetadata().getNamespace();if(!t){throw new p(S,"State must always be restored synchronously")}return e[r]};o.templateBaseExtension.restoreExtensionAppStateData(a);t=false}function L(e){e=e||{};if(e.hasOwnProperty(g)&&e.hasOwnProperty(v)){B(e[v]);te(e[g]);H(e[y])}else{if(e._editStateFilter!==undefined){B({editStateFilter:e._editStateFilter});delete e._editStateFilter}K();te(e)}if(e[v]){if(e[v].variantDirty===undefined){e[v].variantDirty=true}o.byId("template::PageVariant")&&o.byId("template::PageVariant").currentVariantSetModified(e[v].variantDirty)}}function J(){var e=d.oComponentUtils.getTemplatePrivateModel();return e.getProperty("/generic/bDataAreShownInTable")}function k(t){if(e.oSmartFilterbar.isPending()){var a=function(r){var i=r.getParameters();if(!i.pendingValue){e.oSmartFilterbar.detachPendingChange(a);L(t)}};e.oSmartFilterbar.attachPendingChange(a)}else{L(t)}}function K(){var t=e.oController.getOwnerComponent().getModel("_templPriv"),a=e.oSmartFilterbar.isCurrentVariantStandard()?e.oController.getOwnerComponent().getDefaultFilterMode():t.getProperty("/alp/filterMode");if(!(a===b||a===V)){f.error("Defaulting to Visual filter due to incorrect value of defaultFilterMode in App descriptor");a=b}if(a===b&&e.hideVisualFilter){f.error("Visual filter is hidden defaulting to compact");a=V}e.filterBarController.setDefaultFilter(a)}function R(t){var a=e.oController.getOwnerComponent().getProperty("smartVariantManagement");if(a){var r=t["sap-ui-fe-variant-id"];if(r&&r[0]){e.oSmartFilterbar.getSmartVariant().setCurrentVariantId(r[0])}}else{var i=t["sap-ui-fe-variant-id"],n=t["sap-ui-fe-filterbar-variant-id"],o=t["sap-ui-fe-chart-variant-id"],l=t["sap-ui-fe-table-variant-id"];j(n&&n[0],o&&o[0],l&&l[0],i&&i[0])}}function j(t,a,r,i){if(t||i){e.oSmartFilterbar.getSmartVariant().setCurrentVariantId(t||i)}if(e.oSmartChart&&(a||i)){e.oSmartChart.attachAfterVariantInitialise(function(t){e.oSmartChart.setCurrentVariantId(a||i)});e.oSmartChart.setCurrentVariantId(a||i)}if(e.oSmartTable&&(r||i)){e.oSmartTable.attachAfterVariantInitialise(function(t){e.oSmartTable.setCurrentVariantId(r||i)});e.oSmartTable.setCurrentVariantId(r||i)}}function W(a,r,n){if(n===sap.ui.generic.app.navigation.service.NavType.hybrid){a=a.iAppState;n=sap.ui.generic.app.navigation.service.NavType.iAppState}e.oSmartFilterbar.setSuppressSelection(false);var s=a.appStateKey||"";if(F){return}if(d.oComponentUtils.isStateHandlingSuspended()){return}w=s;F=true;e.sNavType=n;var c=!s&&r||{};e.oSmartFilterbar.resumeSetFilterData();R(c);if(n!==sap.ui.generic.app.navigation.service.NavType.iAppState&&a.presentationVariant!==undefined){q(a.presentationVariant)}if(n!==sap.ui.generic.app.navigation.service.NavType.initial){var p=a&&a.bNavSelVarHasDefaultsOnly;var S=new t(a.selectionVariant);var f=a.semanticDates;M=JSON.parse(a.selectionVariant);if(S.getSelectOptionsPropertyNames().indexOf("DisplayCurrency")===-1&&S.getSelectOptionsPropertyNames().indexOf("P_DisplayCurrency")===-1&&S.getParameterNames().indexOf("P_DisplayCurrency")===-1){Y(S,a)}if(!p||e.oSmartFilterbar.isCurrentVariantStandard()){var m={selectionVariant:S,semanticDates:f};var g=e.oSmartFilterbar.getUiState();var y=new t(JSON.stringify(g.getSelectionVariant()));if(n!==sap.ui.generic.app.navigation.service.NavType.iAppState){e.oController.modifyStartupExtension(m);if(e.oSmartFilterbar.isCurrentVariantStandard()){m.semanticDates=u.addSemanticDateRangeDefaultValue(O,e.oSmartFilterbar,m.semanticDates,m.urlParameters||{},m.selectionVariant);m.semanticDates.Dates.forEach(function(e){m.selectionVariant.addSelectOption(e.PropertyName,"I","EQ","")})}}var V=e.oSmartFilterbar.getAllFilterItems().map(function(e){return e.getName()});var C=a.oSelectionVariant.toJSONObject().SelectOptions.filter(function(e){return V.includes(e.PropertyName)});if(!Q(y.toJSONObject().SelectOptions,C)){o.byId("template::PageVariant")&&o.byId("template::PageVariant").currentVariantSetModified(true)}if(p){var D=i.getMergedVariants([new t(JSON.stringify(e.oSmartFilterbar.getUiState().getSelectionVariant())),m.selectionVariant]);m.selectionVariant=D}ie(m.selectionVariant);re(m)}else{var P=new t(JSON.stringify(e.oSmartFilterbar.getUiState().getSelectionVariant())),U=P.getSelectOption("sap.suite.ui.generic.template.customData"),A=P.getSelectOption("sap.suite.ui.generic.template.genericData");x=e.oSmartFilterbar.getUiState().getSemanticDates();X(P,U,A,true);var m={selectionVariant:P,semanticDates:x};e.oController.modifyStartupExtension(m);if(e.oSmartFilterbar.isCurrentVariantStandard()){u.addSemanticDateRangeDefaultValue(O,e.oSmartFilterbar,m.semanticDates,m.urlParameters||{},m.selectionVariant)}X(m.selectionVariant,U,A,false);if(!l(m.selectionVariant,new t(JSON.stringify(e.oSmartFilterbar.getUiState().getSelectionVariant())))){ie(m.selectionVariant);re(m)}}if(a.tableVariantId&&e.oSmartTable){e.oSmartTable.setCurrentVariantId(a.tableVariantId)}var T=e.oController.getOwnerComponent().getModel("_templPriv");if(n===sap.ui.generic.app.navigation.service.NavType.xAppState&&T.getProperty("/alp/filterMode")===b){ae()}if(a.customData){var E=a.customData;k(E);if(E.hasOwnProperty(v)){var _=E[v];ve(_.controlStates)}}else{K()}if(!p){e.oSmartFilterbar.checkSearchAllowed(e);if(e.oController.getView().getModel("_templPriv").getProperty("/alp/searchable")){h=true;e.oSmartFilterbar.search()}}N={appStateKey:s,urlParams:c}}else{var S=new t(JSON.stringify(e.oSmartFilterbar.getUiState().getSelectionVariant())),U=S.getSelectOption("sap.suite.ui.generic.template.customData"),A=S.getSelectOption("sap.suite.ui.generic.template.genericData"),x=e.oSmartFilterbar.getUiState().getSemanticDates();X(S,U,A,true);var m={selectionVariant:S,semanticDates:x};e.oController.modifyStartupExtension(m);m.semanticDates=u.addSemanticDateRangeDefaultValue(O,e.oSmartFilterbar,m.semanticDates,m.urlParameters||{},m.selectionVariant);m.semanticDates.Dates.forEach(function(e){m.selectionVariant.addSelectOption(e.PropertyName,"I","EQ","")});X(m.selectionVariant,U,A,false);if(!l(m.selectionVariant,new t(JSON.stringify(e.oSmartFilterbar.getUiState().getSelectionVariant())))){ie(m.selectionVariant);re(m)}if(e.oSmartFilterbar.isLiveMode()||e.oSmartFilterbar.isCurrentVariantExecuteOnSelectEnabled()){e.oSmartFilterbar.checkSearchAllowed(e);if(e.oController.getView().getModel("_templPriv").getProperty("/alp/searchable")){h=true}}K()}se();I=null;if(!e.oSmartFilterbar.isLiveMode()){var B=ge();if(!B||!z()){d.oComponentUtils.hidePlaceholder()}}else{if(!z()){d.oComponentUtils.hidePlaceholder()}}if(!h){Se()}else{F=false}if(a.bNavSelVarHasDefaultsOnly){o.byId("template::PageVariant").currentVariantSetModified(true)}else{o.byId("template::PageVariant").currentVariantSetModified(false)}G()}function G(){var t=e.oController.getView().getModel("_templPriv").getProperty("/alp/contentView");if(t!=="charttable"&&t!=="table"){if(!e.oSmartChart||t==="customview1"||t==="customview2"||t==="crosstable"){d.oComponentUtils.hidePlaceholder()}}}function Q(e,t){return l(e.map(JSON.stringify).sort(),t.map(JSON.stringify).sort())}function q(t){var a=typeof t==="string"?JSON.parse(t):t;var r=a&&a.SortOrder;if(e.oSmartTable){var i=e.oTemplateUtils.oServices.oPresentationControlHandlerFactory.getPresentationControlHandler(e.oSmartTable);i.applyNavigationSortOrder(r)}if(e.oSmartChart){var n=e.oTemplateUtils.oServices.oPresentationControlHandlerFactory.getPresentationControlHandler(e.oSmartChart);n.applyNavigationSortOrder(r)}}function z(){var t=e.oSmartFilterbar.determineMandatoryFilterItems();var a=e.oSmartFilterbar.getFiltersWithValues();return t.every(function(e){return a.includes(e)})}function X(e,t,a,r){if(r){if(t){e.removeSelectOption("sap.suite.ui.generic.template.customData")}if(a){e.removeSelectOption("sap.suite.ui.generic.template.genericData")}}else{if(t){e.massAddSelectOption("sap.suite.ui.generic.template.customData",t)}if(a){e.massAddSelectOption("sap.suite.ui.generic.template.genericData",a)}}}function Y(t,a){var r=e.oSmartFilterbar.determineMandatoryFilterItems(),i;for(var n=0;n<r.length;n++){if(r[n].getName().indexOf("P_DisplayCurrency")!==-1){if(a.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")&&a.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")[0].Low){i=a.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")[0].Low}if(i){t.addParameter("P_DisplayCurrency",i)}if(e.alr_visualFilterBar&&i){e.alr_visualFilterBar.setDisplayCurrency(i)}break}}}function Z(){var t={};t[g]={};var a=e.oController.getOwnerComponent().getModel("_templPriv");var r=e.chartController&&s({},e.chartController._chartInfo);if(r&&r.chartSelection){delete r.chartSelection}var i={};if(_){i[e.oSmartChart.getId()]=_.getState()}if(E){i[e.oSmartTable.getId()]=E.getState()}i[A.getId()]=T.getState();t[v]={chartVariantId:e.oSmartChart&&e.oSmartChart.getCurrentVariantId(),filterMode:a.getProperty("/alp/filterMode"),contentView:a.getProperty("/alp/contentView"),autoHide:a.getProperty("/alp/autoHide"),chartInfo:r,variantDirty:o.byId("template::PageVariant")&&o.byId("template::PageVariant").currentVariantGetModified(),controlStates:i};var l=o.byId("editStateFilter");if(l){t[v].editStateFilter=l.getSelectedKey()}o.getCustomAppStateDataExtension(t[g]);var c;var u=true;var f=function(e,t){if(!(e instanceof n)){throw new p(S,"State must always be set with respect to a ControllerExtension")}if(!u){throw new p(S,"State must always be provided synchronously")}if(t){c=c||Object.create(null);var a=e.getMetadata().getNamespace();c[a]=t}};o.templateBaseExtension.provideExtensionAppStateData(f);u=false;if(c){t[y]=c}return t}function $(){return M}function ee(){var t=e.oSmartFilterbar.getUiState(),a=t.getSelectionVariant(),r=t.getSemanticDates(),i=o.getVisibleSelectionsWithDefaults();for(var n=0;n<i.length;n++){if(!a.getValue(i[n])){a.addSelectOption(i[n],"I","EQ","")}}if(e.oController.byId("template::PageVariant").currentVariantGetModified()&&a.SelectionVariantID){a.SelectionVariantID=""}return{selectionVariant:JSON.stringify(a),semanticDates:r,tableVariantId:e.oSmartTable&&e.oSmartTable.getCurrentVariantId(),customData:Z()}}function te(e){o.restoreCustomAppStateDataExtension(e||{})}function ae(){var t=c({},e.oSmartFilterbar.getFilterData(true)),a=e.oController.getOwnerComponent().getModel("_filter");a.setData(t);e.filterBarController._updateFilterLink()}function re(t){e.oSmartFilterbar.clearVariantSelection();e.oSmartFilterbar.clear();P=t.selectionVariant;ce(t.selectionVariant.toJSONObject(),t.semanticDates,true,false)}function ie(t){var a=t.getParameterNames().concat(t.getSelectOptionsPropertyNames());for(var r=0;r<a.length;r++){e.oSmartFilterbar.addFieldToAdvancedArea(a[r])}if(e.alr_visualFilterBar&&e.bVisualFilterInitialised){e.alr_visualFilterBar.addVisualFiltersToBasicArea(a)}}function ne(){if(e._bIsStartingUp){return}if(F){return}if(d.oComponentUtils.isStateHandlingSuspended()){return}var t=ee();try{I=m.storeInnerAppStateWithImmediateReturn(t,true)}catch(e){f.error("AnalyticalListPage.fnStoreCurrentAppStateAndAdjustURL: "+e)}if(I instanceof sap.ui.generic.app.navigation.service.NavError){I=null;return}if(e.oTemplateUtils.oComponentUtils.isComponentActive()&&I){e.oTemplateUtils.oServices.oApplication.navigateByExchangingQueryParam(U,I.appStateKey)}if(I&&w!==I.appStateKey){N.appStateKey=I.appStateKey;I=null}}function oe(){var t=e.oController.getOwnerComponent().getModel("_templPriv");if(t.getProperty("/alp/filterMode")===b){if(e.alr_visualFilterBar&&e.alr_visualFilterBar.bIsInitialised&&t.getProperty("/alp/searchable")===false){e.oSmartFilterbar.showAdaptFilterDialog("group")}}}function le(){if(e.oSmartFilterbar.isInitialised()){e.oSmartFilterbar.checkSearchAllowed(e)}}function se(){var t=e.oController.getOwnerComponent().getModel("_filter");t.setData(c({},e.oSmartFilterbar.getFilterData(true)));e.filterBarController._updateFilterLink()}function ce(t,a,i,n){var o=new r({selectionVariant:t,semanticDates:a});e.oSmartFilterbar.setUiState(o,{replace:i,strictMode:n})}function pe(e){C=m.parseNavigation()}function ue(){try{var e=new Promise(function(e){D=e;C.done(W);C.fail(function(t,a,r){f.warning(t.getErrorCode()+"app state could not be parsed - continuing with empty state");W({},a,sap.ui.generic.app.navigation.service.NavType.initial);e()})});return e}catch(e){me()}}function Se(){F=false;D()}function fe(){return P}function de(t){if(!t){var a=e.oIappStateHandler.fnGetStartUpSelectionVariant();if(a){var r=a.getParameterNames().concat(a.getSelectOptionsPropertyNames());e.alr_visualFilterBar.addVisualFiltersToBasicArea(r)}}e.alr_visualFilterBar.updateVisualFilterBindings(true);if(e.oSmartFilterbar.isCurrentVariantStandard()){e.oIappStateHandler.fnCheckMandatory();e.oIappStateHandler.fnCheckToLaunchDialog()}}function me(){K();se();if(e.alr_visualFilterBar&&e.alr_visualFilterBar.bIsInitialised){e.oIappStateHandler.fnUpdateVisualFilterBar(true)}}function ge(){var t=false;if(e.oSmartFilterbar.isCurrentVariantStandard()){e.oSmartFilterbar.checkSearchAllowed(e);if(e.oController.getView().getModel("_templPriv").getProperty("/alp/searchable")){var a=e.oController.getOwnerComponent();var r=a.getDataLoadSettings();var i=r?r.loadDataOnAppLaunch:"ifAnyFilterExist";if(i==="ifAnyFilterExist"){var n=e.oSmartFilterbar.getFiltersWithValues();t=n.length?true:false}else if(i==="always"){t=true}else if(i==="never"){t=false}if(t){e.oSmartFilterbar.getSmartVariant().setExecuteOnStandard(true);t=e.oSmartFilterbar.getSmartVariant().getExecuteOnStandard()}}}var o=e.oSmartFilterbar.isCurrentVariantExecuteOnSelectEnabled();if(o||t){e.oSmartFilterbar.search()}return t}function ve(t){if(_){_.setState(t&&t[e.oSmartChart.getId()])}if(E){E.setState(t&&t[e.oSmartTable.getId()])}T.setState(t&&t[A.getId()])}return{areDataShownInTable:J,getFilterState:Z,fnCheckMandatory:le,fnCheckToLaunchDialog:oe,getCurrentAppState:ee,fnUpdateSVFB:se,fnSetDefaultFilter:K,fnRestoreFilterState:k,getUrlParameterInfo:x,onSmartFilterBarInitialise:pe,onSmartFilterBarInitialized:ue,fnStoreCurrentAppStateAndAdjustURL:ne,fnSetFiltersUsingUIState:ce,fnResolveStartUpPromise:Se,fnGetStartUpSelectionVariant:fe,fnUpdateVisualFilterBar:de,fnOnError:me,getInitialNavigationContext:$}}return e.extend("sap.suite.ui.generic.template.listTemplates.controller.IappStateHandler",{constructor:function(e,t,a){s(this,d(e,t,a))}})});
//# sourceMappingURL=IappStateHandler.js.map