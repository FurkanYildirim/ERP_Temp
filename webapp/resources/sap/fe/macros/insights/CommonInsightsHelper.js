/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/fe/core/CommonUtils","sap/fe/core/converters/MetaModelConverter","sap/fe/core/helpers/BindingToolkit","sap/fe/core/helpers/ResourceModelHelper","sap/ui/core/Core","sap/ui/mdc/p13n/StateUtil","./AnalyticalInsightsHelper","./InsightsCardHelper"],function(e,t,r,n,a,o,s,i){"use strict";var l={};var c=i.showErrorMessageForInsightsCard;var d=i.IntegrationCardType;var u=s.getMeasures;var g=s.getFeeds;var p=s.getDimensions;var v=s.getChartProperties;var f=n.getResourceModel;var h=r.pathInModel;var m=r.getExpressionFromAnnotation;var y=r.concat;var C=r.compileExpression;var T=t.getInvolvedDataModelObjects;async function I(e,t){try{const r=a.byId(e.getFilter());const n=await o.retrieveExternalState(e);let s=false;let i=false;if(r!==undefined){s=r.getParent().isSemanticDateFilterApplied()}if(n.filter){const e=Object.keys(n.filter);for(const t of e){const e=n.filter[t];if(Array.isArray(e)&&e.length){i=true;break}}}if(i||s||(t?t.length===0:false)){return false}return true}catch{throw Error("Error retrieving control states")}}function b(e){var t;const r=e.content;const n=r.getColumns();const a=[];const o=(t=r.getModel())===null||t===void 0?void 0:t.getMetaModel();const s=r.data("metaPath");e.getTableDefinition().columns.forEach(function(e){if(e.isInsightsSupported===true){a.push(e.name)}});return n.filter(function(e){return a.includes(e.getDataProperty())}).map(function(e){const t=e.getDataProperty(),r=o===null||o===void 0?void 0:o.getContext(s+"/"+t),n=T(r),a=n.targetObject,i=P(a,t),l=i?i:M(a,t);return{visible:false,name:l,label:e.getProperty("header")}})}l.getInsightsRelevantColumns=b;async function A(t,r,n){let a;const s=t.content;const i=s.getFilter()!==""?s.getFilter():undefined;const l=await I(s,n);if(!l){c(r,f(t));return}try{a=await o.retrieveExternalState(s)}catch{throw Error("Error retrieving control states")}const h=r===d.table?s.data("metaPath"):s.data("targetCollectionPath");const m=e.getAppComponent(s);const y=m.getManifestEntry("sap.app");const C=s.getModel().getServiceUrl();let T="";const b={appComponent:m,type:r,requestParameters:{serviceUrl:"",queryUrl:"",groupBy:undefined},content:{cardTitle:"",insightsRelevantColumns:[]},parentAppId:y.id,parameters:{filterbarID:i},entitySetPath:h};if(r===d.table){b.content={cardTitle:s.getHeader(),insightsRelevantColumns:n??[]};T=s.getRowBinding().getDownloadUrl();b.content.cardTitle=s.getHeader();b.parentAppId=y.id;const e=Array.isArray(a.groupLevels)&&a.groupLevels.length?a.groupLevels[0].name:undefined;if(e!==undefined){const t=e.includes("::")?e.split("::")[1]:e;b.requestParameters.groupBy={property:t}}}else{const e=s;const t=e.getControlDelegate().getInnerChart(e);const r={cardTitle:e.getHeader(),legendVisible:false,chartType:e.getChartType(),measures:u(t),dimensions:p(t),feeds:g(t),allowedChartTypes:t.getAvailableChartTypes().available,chartProperties:v(t)};b.content=r;T=t.getBindingInfo("data").binding.getDownloadUrl()}b.requestParameters.serviceUrl=C;b.requestParameters.queryUrl=T.includes(C)?T.split(C)[1]:T;return b}l.createInsightsParams=A;function M(e,t){var r,n,a,o;const s=t.split("/");let i;if(s.length>1){s.pop();i=s.join()}const l=(r=e.annotations.Common)===null||r===void 0?void 0:r.Text;const c=l===null||l===void 0?void 0:(n=l.annotations)===null||n===void 0?void 0:(a=n.UI)===null||a===void 0?void 0:(o=a.TextArrangement)===null||o===void 0?void 0:o.valueOf();const d=h(t);let u;if(l){const e=m(l,i?[i]:[]);if(c==="UI.TextArrangementType/TextLast"){u=y(d," (",e,")")}else if(c==="UI.TextArrangementType/TextOnly"){u=e}else if(c==="UI.TextArrangementType/TextSeparate"){u=d}else{u=y(e," (",d,")")}}else{u=d}return C(u)}function P(e,t){var r,n;const a=((r=e.annotations.Measures)===null||r===void 0?void 0:r.ISOCurrency)||((n=e.annotations.Measures)===null||n===void 0?void 0:n.Unit);if(!a){return}else{const e=h(t);return C(y(e," ",m(a)))}}return l},false);
//# sourceMappingURL=CommonInsightsHelper.js.map