/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/CommonUtils","sap/fe/core/helpers/ResourceModelHelper","sap/fe/navigation/SelectionVariant","sap/insights/CardHelper","sap/m/MessageBox","sap/ui/core/Core","sap/ui/mdc/p13n/StateUtil","sap/ui/VersionInfo"],function(t,e,a,n,r,s,o,i,c){"use strict";var l={};let p;(function(t){t["table"]="Table";t["analytical"]="Analytical"})(p||(p={}));l.IntegrationCardType=p;const u=15;const d=`$top=${u}`;function g(t){const e=[];t.forEach(function(t){e.push({title:t.label,value:t.name,visible:t.visible})});return e}function f(t){const e=g(t.content.insightsRelevantColumns);const a={data:{path:"/response/value"},maxItems:15,row:{columns:e,actions:[{type:"Navigation",parameters:"{= extension.formatters.getNavigationContext(${parameters>/state/value}, ${})}"}]}};if(t.requestParameters.groupBy){const e=t.requestParameters.groupBy.property;const n=t.requestParameters.groupBy.descending;a.group={title:"{"+e+"}",order:{path:e,dir:n===true?"DESC":"ASC"}}}return a}function m(t){return{chartType:t.content.chartType,chartProperties:t.content.chartProperties,data:{path:"/response/value"},dimensions:t.content.dimensions,measures:t.content.measures,feeds:t.content.feeds,actions:[{type:"Navigation",parameters:"{= extension.formatters.getNavigationContext(${parameters>/state/value}, ${})}"}],actionableArea:"Chart"}}function y(t){let e=t.requestParameters.queryUrl;e=t.type===p.table?`${e}&${d}`:e;return{request:{url:"{{destinations.service}}"+t.requestParameters.serviceUrl+"$batch",method:"POST",headers:{"X-CSRF-Token":"{{csrfTokens.token1}}"},batch:{response:{method:"GET",url:e,headers:{Accept:"application/json"}}}}}}function _(t){const e={title:t.content.cardTitle,actions:[{type:"Navigation",parameters:"{= extension.formatters.getNavigationContext(${parameters>/state/value})}"}]};if(t.type===p.table){e.status={text:"{/response/@odata.count}"}}return e}function v(t){const e=t.getShellServices();const a=e.getHash();const n=e.parseShellHash(a);const r=t.getNavigationService();const s={parameters:{ibnTarget:{semanticObject:n.semanticObject,action:n.action},ibnParams:{sensitiveProps:[],nhHybridIAppStateKey:r.getIAppStateKey()}}};return JSON.stringify(s)}async function E(t,a,r){const s={state:{value:v(a)},_relevantODataFilters:{value:[]},_relevantODataParameters:{value:[]},_mandatoryODataFilters:{value:[]},_mandatoryODataParameters:{value:[]},sensitiveProps:[],_entitySet:{value:r}};const c=t?await i.retrieveExternalState(o.byId(t)):undefined;const l=c===null||c===void 0?void 0:c.filter;if(l!==undefined){for(const a of Object.keys(l)){let r=new n;const i={filterConditions:{[a]:l[a]}};r=e.addExternalStateFiltersToSelectionVariant(r,i,o.byId(t),undefined);if(r.getSelectOptionsPropertyNames().length){const t={id:r.getID(),Parameters:[],SelectOptions:[{PropertyName:a,Ranges:r.getSelectOption(a)}]};s[a]={value:JSON.stringify(t),type:"string"};s._relevantODataFilters.value.push(a)}}}return s}async function S(t){const e={};const a=t.requestParameters.serviceUrl;e.destinations={service:{name:"(default)",defaultUrl:"/"}};e.csrfTokens={token1:{data:{request:{url:a,method:"HEAD",headers:{"X-CSRF-Token":"Fetch"}}}}};const n=t.parameters.filterbarID;const r=await E(n,t.appComponent,t.entitySetPath);e.parameters=r;return e}async function h(t){const e={type:t.type};e.configuration=await S(t);e.header=_(t);e.data=y(t);if(t.type===p.analytical){e.content=m(t)}else{e.content=f(t)}e.extension="module:sap/insights/CardExtension";return e}async function A(t){const e=await c.load();const a={parentAppId:t.parentAppId,cardType:"RT",versions:{ui5:e.version+"-"+e.buildTimestamp},filterEntitySet:t.entitySetPath};if(t.type===p.analytical){a.allowedChartTypes=t.content.allowedChartTypes}return a}async function C(t){const e=t.appComponent,a={...e.getManifestEntry("sap.app")},n={...e.getManifestEntry("sap.ui5")};const r=n.models[""];const s=r.dataSource?r.dataSource:"";const o={};const i=`user.${a.id}.${Date.now()}`;a.id=i;a.type="card";a.dataSources.filterService={...a.dataSources[s]};o["sap.app"]=a;o["sap.card"]=await h(t);o["sap.insights"]=await A(t);return o}l.createCardManifest=C;async function T(e){try{const t=await r.getServiceAsync("UIService");const a=await C(e);t.showCardPreview(a,true)}catch(a){I(e.appComponent);t.error("Card creation failed")}}l.showInsightsCardPreview=T;function R(t,e){const a=`<strong>\n\t\t${e.getText("M_CARD_POSSIBLE_CAUSES")}\n\t\t</strong>`;let n="";const r=`${e.getText("M_CARD_FOOTER_INFO")}`;if(t===p.table){n=`<ul><li>\n\t\t\t${e.getText("M_CARD_FAILURE_REASON_DATE_RANGE_FILTERS")}\n\t\t\t</li><li>\n\t\t\t${e.getText("M_CARD_FAILURE_TABLE_REASON_TABLE_LEVEL_FILTERS")}\n\t\t\t</li><li>\n\t\t\t${e.getText("M_CARD_FAILURE_TABLE_REASON_UNSUPPORTED_COLUMNS")}\n\t\t\t</li></ul>`}else{n=`<ul><li>\n\t\t\t${e.getText("M_CARD_FAILURE_REASON_DATE_RANGE_FILTERS")}\n\t\t\t</li><li>\n\t\t\t${e.getText("M_CARD_FAILURE_CHART_REASON_CHART_LEVEL_FILTERS")}\n\t\t\t</li></ul>`}const o=a+n+r;s.error(e.getText("M_CARD_CREATION_FAILURE"),{onClose:function(){throw new Error("Insights is not supported")},details:o})}l.showErrorMessageForInsightsCard=R;function I(t){const e=a.getResourceModel(t);s.error(e.getText("M_CARD_FAILURE_GENERIC"))}l.genericErrorMessageForInsightsCard=I;return l},false);
//# sourceMappingURL=InsightsCardHelper.js.map