/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/CommonUtils","sap/fe/core/converters/MetaModelConverter","sap/fe/core/helpers/TypeGuards","sap/fe/core/type/TypeUtil","sap/fe/macros/internal/valuehelp/ValueListHelper","sap/m/inputUtils/highlightDOMElements","sap/ui/mdc/condition/Condition","sap/ui/mdc/enum/ConditionValidated","sap/ui/mdc/p13n/StateUtil","sap/ui/mdc/ValueHelpDelegate","sap/ui/model/FilterType","../internal/valuehelp/AdditionalValueHelper"],function(e,t,n,i,o,a,r,l,s,d,u,c,f){"use strict";var g=f.additionalValueHelper;var p=f.AdditionalValueGroupKey;var h=i.isPathAnnotationExpression;var v=n.convertTypes;const m="sap.fe.core.controls.FilterBar";const P="sap.ui.mdc.filterbar.FilterBarBase";return Object.assign({},u,{apiVersion:2,isSearchSupported:function(e,t,n){return t.getFilterFields()==="$search"},updateBindingInfo:function(e,n,i){u.updateBindingInfo(e,n,i);if(n.getFilterFields()==="$search"){const e=n.getFilterValue();const o=t.normalizeSearchTerm(e);if(i.parameters){i.parameters.$search=o||undefined}}},updateBinding:async function(e,t,n,i){const o=e.getPayload();const a=this._getValueListPropertyFromPayloadQualifier(o);if(i.isTypeahead()){const e=i.getBindingContext();const r=[];const l=i.getModel("internal").getProperty("/recommendationsData")||{};const s=g.getRelevantRecommendations(l,e,o.propertyPath)||[];if((s===null||s===void 0?void 0:s.length)>0){r.push({propertyPath:a,values:s,groupKey:p.recommendation});this._updateBindingForRecommendations(o,t,n,r)}else{this._updateBinding(t,n)}}else{this._updateBinding(t,n)}},executeFilter:async function(e,t,n,i){t.getContexts(0,i);await this.checkListBindingPending(e,t,i);return t},checkListBindingPending:async function(e,t,n){const i=e.getPayload();if(i.updateBindingDonePromise){return i.updateBindingDonePromise}else{if(!t||t.isSuspended()){return false}const e=await t.requestContexts(0,n);return e.length===0}},getTypeUtil:function(e){return o},retrieveContent:function(e,t,n){const i=e.getPayload();return a.showValueList(i,t,n)},_getConditionPayloadList:function(e){const t=e.payload||{},n=Object.keys(t),i=n.length?t[n[0]]:[];return i},_getValueListPropertyFromPayloadQualifier:function(e){const t=e.qualifiers[e.valueHelpQualifier].vhParameters||[];const n=e.qualifiers[e.valueHelpQualifier].vhKeys||[];const i=e.valueHelpKeyPath;let o=[...n];const a=[];if(t.length>0){t.forEach(function(e){a.push(e.helpPath)});o=n.filter(e=>!a.includes(e))}return i&&o.includes(i)?i:""},_onConditionPropagationToFilterBar:async function(t,n,i,o){try{const e=await d.retrieveExternalState(o);const a=t.getFilterItems();for(const t of n){const n=this._getConditionPayloadList(t);for(const t of i){const i=t.source.split("/").pop()||"";if(a.find(e=>e.getId().split("::").pop()===i)){for(const o of n){const n=l.createCondition("EQ",[o[t.helpPath]],null,null,s.Validated);e.filter[i]||=[];e.filter[i].push(n)}}}}d.applyExternalState(o,e)}catch(t){const n=t instanceof Error?t.message:String(t);e.error(`ValueHelpDelegate: ${n}`)}},_onConditionPropagationToBindingContext:function(t,n,i){const o=i.getModel().getMetaModel();for(const a of t){const t=this._getConditionPayloadList(a),r=t.length===1?t[0]:undefined;if(t.length>1){e.warning("ValueHelpDelegate: ParameterOut in multi-value-field not supported")}if(r){this._onConditionPropagationUpdateProperty(o,r,n,i)}}},_onConditionPropagationUpdateProperty:function(e,t,n,i){const o=v(e);const a=e.getMetaContext(i.getPath()).getPath();const r=i.isTransient()!==true&&i.isInactive()!==true;for(const e of n){if(i.getProperty(e.source)!==t[e.helpPath]){this._updatePropertyViaOutParameter(o,a,t,e,i,r)}}},_updatePropertyViaOutParameter:function(e,t,n,i,o,a){var r,l,s,d,u,c;const f=`${t}/${i.source}`;const g=e.resolvePath(f).target;const p=g===null||g===void 0?void 0:(r=g.annotations)===null||r===void 0?void 0:(l=r.Common)===null||l===void 0?void 0:l.FieldControl;const v=h(p)?o.getProperty(p.path)===1:false;if(v&&a){const e=i.source.lastIndexOf("/");const t=e>0?i.source.substring(0,e):i.source;o.requestSideEffects([t])}else{o.setProperty(i.source,n[i.helpPath])}const m=h(g===null||g===void 0?void 0:(s=g.annotations)===null||s===void 0?void 0:(d=s.Common)===null||d===void 0?void 0:d.Text)?g===null||g===void 0?void 0:(u=g.annotations)===null||u===void 0?void 0:(c=u.Common)===null||c===void 0?void 0:c.Text.path:undefined;if(m!==undefined&&a){const e=m.lastIndexOf("/");const t=e>0?m.substring(0,e):m;o.requestSideEffects([t])}},getFilterConditions:function(e,t,n){if(this.getInitialFilterConditions){return this.getInitialFilterConditions(e,t,n&&n.control||t&&t.getControl())}return{}},onConditionPropagation:async function(e,t,n){if(t!=="ControlChange"){return}const i=e.getPayload();const o=i.qualifiers[i.valueHelpQualifier];const r=(o===null||o===void 0?void 0:o.vhParameters)!==undefined?a.getOutParameters(o.vhParameters):[],l=e.getControl(),s=l.getParent();let d=l.getConditions();d=d.filter(function(e){const t=e.payload||{};return t[i.valueHelpQualifier]});if(s.isA(P)){const t=e.getParent();if(t.isA(m)){await this._onConditionPropagationToFilterBar(t,d,r,s)}}else{const t=e.getBindingContext();if(t){this._onConditionPropagationToBindingContext(d,r,t)}}},_createInitialFilterCondition:function(t,n){let i;if(t===undefined||t===null){e.error("ValueHelpDelegate: value of the property could not be requested")}else if(t===""){if(n){i=l.createCondition("Empty",[],null,null,s.Validated)}}else{i=l.createCondition("EQ",[t],null,null,s.Validated)}return i},_getInitialFilterConditionsFromBinding:async function(t,n,i){const o=i.map(e=>e.source);const a=n.getBindingContext();if(!a){e.error("ValueHelpDelegate: No BindingContext");return t}const r=await a.requestProperty(o);for(let e=0;e<i.length;e++){const n=i[e];const o=this._createInitialFilterCondition(r[e],n.initialValueFilterEmpty);if(o){t[n.helpPath]=[o]}}return t},_getInitialFilterConditionsFromFilterBar:async function(e,t,n){const i=t.getParent();const o=await d.retrieveExternalState(i);for(const t of n){const n=this._getConditionsFromInParameter(t,o);if(n){e[t.helpPath]=n}}return e},_getConditionsFromInParameter:function(e,t){const n=e.source;const i=Object.keys(t.filter).find(e=>("/"+n).endsWith("/"+e));return i&&t.filter[i]},_partitionInParameters:function(e){const t={constant:[],binding:[],filter:[]};for(const n of e){if(n.constantValue!==undefined){t.constant.push(n)}else if(n.source.indexOf("$filter")===0){t.filter.push(n)}else{t.binding.push(n)}}return t},_tableAfterRenderDelegate:{onAfterRendering:function(e){const t=e.srcControl,n=t.$().find("tbody .sapMText"),i=t.getParent();r(n,i.getFilterValue(),true)}},getInitialFilterConditions:async function(t,n,i){if(n!==null&&n!==void 0&&n.isA("sap.ui.mdc.valuehelp.content.MTable")){const e=n.getTable();e===null||e===void 0?void 0:e.removeEventDelegate(this._tableAfterRenderDelegate);e===null||e===void 0?void 0:e.addEventDelegate(this._tableAfterRenderDelegate,this)}const o={};if(!i){e.error("ValueHelpDelegate: Control undefined");return o}const r=t.getPayload();const l=r.qualifiers[r.valueHelpQualifier];const s=(l===null||l===void 0?void 0:l.vhParameters)!==undefined?a.getInParameters(l.vhParameters):[];const d=this._partitionInParameters(s);const u=i.getBindingContext();for(const e of d.constant){const t=this._createInitialFilterCondition(e.constantValue,u?e.initialValueFilterEmpty:false);if(t){o[e.helpPath]=[t]}}if(d.binding.length){await this._getInitialFilterConditionsFromBinding(o,i,d.binding)}if(d.filter.length){await this._getInitialFilterConditionsFromFilterBar(o,i,d.filter)}return o},createConditionPayload:function(e,t,n,i){const o=e.getPayload();const a=o.qualifiers[o.valueHelpQualifier],r={},l={};const s=t.getControl();const d=s===null||s===void 0?void 0:s.isA("sap.ui.mdc.MultiValueField");if(!a.vhKeys||a.vhKeys.length===1||d){return undefined}a.vhKeys.forEach(function(e){const t=i.getObject(e);if(t!=null){r[e]=(t===null||t===void 0?void 0:t.length)===0?"":t}});if(Object.keys(r).length){l[o.valueHelpQualifier]=[r]}return l},isFilterableListItemSelected:function(e,t,n,i){var o;const a=e.getPayload();if(a.isValueListWithFixedValues!==true&&((o=t.getConfig())===null||o===void 0?void 0:o.maxConditions)===1){return false}const r=n.getBindingContext();i=i.filter(e=>e.validated===s.Validated);const l=i.find(function(e){var n;const i=e.payload,o=a.valueHelpQualifier||"";if(!i&&Object.keys(a.qualifiers)[0]===o){const n=t.getKeyPath();return(r===null||r===void 0?void 0:r.getObject(n))===(e===null||e===void 0?void 0:e.values[0])}const l=(i===null||i===void 0?void 0:(n=i[o])===null||n===void 0?void 0:n[0])||{},s=Object.keys(l);if(s.length){return s.every(function(e){return l[e]===(r===null||r===void 0?void 0:r.getObject(e))})}return false});return l?true:false},_updateBindingForRecommendations:async function(e,t,n,i){let o;e.updateBindingDonePromise=new Promise(function(e){o=e});try{const e=await g.requestForAdditionalValueContextData(i,t,n);const o=g.removeDuplicateAdditionalValues(e,[...i]);g.sortAndFilterOthers(t,n,o);await g.resumeValueListBindingAndResetChanges(t);if(!g.doesTransientContextsAlreadyExist(t,o)){g.createAdditionalValueTransientContexts(e,o.reverse(),t)}}catch(e){}if(o){o(true)}},_updateBinding:async function(e,t){const n=e.getRootBinding()||e;if(!n.isSuspended()){n.suspend()}if(t.parameters){e.changeParameters(t.parameters)}e.filter(t.filters,c.Application);e.sort(t.sorter);if(n.isSuspended()){n.resume();n.resetChanges()}},checkIfAdditionalValuesExists:function(e,t){const n=e.getBindingContext();const i=e.getModel("internal").getProperty("/recommendationsData")||{};const o=g.getRelevantRecommendations(i,n,t.propertyPath)||[];if((o===null||o===void 0?void 0:o.length)>0){return true}return false},showTypeahead:function(e,t){if(!t.getControl().isA("sap.ui.mdc.FilterField")&&!t.getControl().isA("sap.ui.mdc.MultiValueField")){var n;const i=t===null||t===void 0?void 0:t.getFilterValue();const o=t===null||t===void 0?void 0:(n=t.getControl())===null||n===void 0?void 0:n.getValue();if(o){if(i===""){return false}else{return true}}else{if(i){return true}return this.checkIfAdditionalValuesExists(t,e.getPayload())}}return true}})},false);
//# sourceMappingURL=ValueHelpDelegate.js.map