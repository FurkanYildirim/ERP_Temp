/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/fe/core/converters/controls/Common/Table","sap/fe/core/converters/controls/ListReport/VisualFilters","sap/fe/core/converters/helpers/ConfigurableObject","sap/fe/core/converters/helpers/IssueManager","sap/fe/core/converters/helpers/Key","sap/fe/core/helpers/BindingToolkit","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/TypeGuards","sap/fe/core/templating/DataModelPathHelper","sap/fe/core/templating/PropertyHelper","sap/m/library","../Common/DataVisualization"],function(e,t,n,i,o,a,r,l,s,c,u,d){"use strict";var v={};var p=d.getSelectionVariant;var f=u.StandardDynamicDateRangeKeys;var g=c.getAssociatedUnitPropertyPath;var h=c.getAssociatedTimezonePropertyPath;var y=c.getAssociatedTextPropertyPath;var m=c.getAssociatedCurrencyPropertyPath;var P=s.getTargetNavigationPath;var b=s.enhanceDataModelPath;var F=l.isNavigationProperty;var T=l.isMultipleNavigationProperty;var S=l.isEntitySet;var E=l.isComplexType;var D=a.getExpressionFromAnnotation;var O=a.compileExpression;var x=o.KeyHelper;var C=i.IssueType;var A=i.IssueSeverity;var I=i.IssueCategory;var N=n.Placement;var R=n.OverrideType;var U=n.insertCustomElements;var M=t.getVisualFilters;var k=e.isFilteringCaseSensitive;var L=e.getTypeConfig;var j=e.getSelectionVariantConfiguration;var w;(function(e){e["Default"]="Default";e["Slot"]="Slot"})(w||(w={}));const V="Edm.String";const $="sap.ui.model.odata.type.String";function q(e){const t={};e.Data.forEach(n=>{if(n.$Type==="com.sap.vocabularies.UI.v1.DataField"){var i,o;t[n.Value.path]={group:e.fullyQualifiedName,groupLabel:O(D(e.Label||((i=e.annotations)===null||i===void 0?void 0:(o=i.Common)===null||o===void 0?void 0:o.Label)||e.qualifier))||e.qualifier}}});return t}function H(e){return e.reduce((e,t)=>{t.propertyNames.forEach(t=>{e[t]=true});return e},{})}function B(e,t){if(t&&e.length>0){return e.every(e=>e.enableAnalytics&&t===e.annotation.collection)}return false}function W(e,t){const n=[];return e.map(e=>{const i=e.control.filters;const o=[];for(const e in i){if(Array.isArray(i[e].paths)){const a=i[e].paths;a.forEach(e=>{if(e&&e.annotationPath&&n.indexOf(e.annotationPath)===-1){n.push(e.annotationPath);const i=j(e.annotationPath,t);if(i){o.push(i)}}})}}return o}).reduce((e,t)=>e.concat(t),[])}const K=function(e,t){const n=t.split("/");let i;let o="";while(n.length){let t=n.shift();i=i?`${i}/${t}`:t;const a=e.resolvePath(i);if(T(a)){t+="*"}o=o?`${o}/${t}`:t}return o};const G=function(e,t,n,i,o){var a,r,l;if(t&&t.targetType===undefined&&(i||((a=t.annotations)===null||a===void 0?void 0:(r=a.UI)===null||r===void 0?void 0:(l=r.Hidden)===null||l===void 0?void 0:l.valueOf())!==true)){var s,c,u,d,v,p,f,g;const i=o.getAnnotationEntityType(t),a={key:x.getSelectionFieldKeyFromPath(n),annotationPath:o.getAbsoluteAnnotationPath(n),conditionPath:K(e,n),availability:((s=t.annotations)===null||s===void 0?void 0:(c=s.UI)===null||c===void 0?void 0:(u=c.HiddenFilter)===null||u===void 0?void 0:u.valueOf())===true?"Hidden":"Adaptation",label:O(D(((d=t.annotations.Common)===null||d===void 0?void 0:(v=d.Label)===null||v===void 0?void 0:v.valueOf())||t.name)),group:i.name,groupLabel:O(D((i===null||i===void 0?void 0:(p=i.annotations)===null||p===void 0?void 0:(f=p.Common)===null||f===void 0?void 0:(g=f.Label)===null||g===void 0?void 0:g.valueOf())||i.name))};X(a);return a}return undefined};const X=function(e){if(e.key==="DraftAdministrativeData::CreationDateTime"||e.key==="DraftAdministrativeData::LastChangeDateTime"){const t=[f.TO,f.TOMORROW,f.NEXTWEEK,f.NEXTMONTH,f.NEXTQUARTER,f.NEXTYEAR];e.settings={operatorConfiguration:[{path:"key",equals:t.join(","),exclude:true}]}}};const J=function(e,t,n,i,o){const a={};if(n){n.forEach(n=>{const r=n.name;const l=(t?`${t}/`:"")+r;const s=G(e,n,l,i,o);if(s){a[l]=s}})}return a};const z=function(e,t,n,i){let o={};if(t){t.forEach(t=>{let a={};const r=b(i.getDataModelObjectPath(),t);const l=r.targetObject;if(l===undefined||!n&&r.navigationProperties.find(e=>{var t,n,i;return((t=e.annotations)===null||t===void 0?void 0:(n=t.UI)===null||n===void 0?void 0:(i=n.Hidden)===null||i===void 0?void 0:i.valueOf())===true})){return}if(F(l)){a=J(e,t,l.targetType.entityProperties,n,i)}else if(E(l.targetType)){a=J(e,t,l.targetType.properties,n,i)}else{a=J(e,P(r,true),[l],n,i)}o={...o,...a}})}return o};const Q=function(e,t,n,i){let o=e[t];if(o){delete e[t]}else{o=G(i,i.resolvePath(t),t,true,n)}if(!o){var a;(a=n.getDiagnostics())===null||a===void 0?void 0:a.addIssue(I.Annotation,A.High,C.MISSING_SELECTIONFIELD)}if(o){var r,l;o.availability=o.availability==="Hidden"?"Hidden":"Default";o.isParameter=!!((r=i.annotations)!==null&&r!==void 0&&(l=r.Common)!==null&&l!==void 0&&l.ResultContext)}return o};const Y=function(e,t,n,i,o){const a=[];const r={};const l=t.entityProperties;o===null||o===void 0?void 0:o.forEach(e=>{r[e.value]=true});if(e&&e.length>0){e===null||e===void 0?void 0:e.forEach(e=>{const r=e.PropertyName;const l=r===null||r===void 0?void 0:r.value;const s={};o===null||o===void 0?void 0:o.forEach(e=>{s[e.value]=true});if(l&&!(l in i)){if(!(l in s)){const e=te(l,n,t);if(e){a.push(e)}}}})}else if(l){l.forEach(e=>{var o,l;const s=(o=e.annotations)===null||o===void 0?void 0:(l=o.Common)===null||l===void 0?void 0:l.FilterDefaultValue;const c=e.name;if(!(c in i)){if(s&&!(c in r)){const e=te(c,n,t);if(e){a.push(e)}}}})}return a};function _(e){var t,n;const i=e.getDataModelObjectPath();const o=i.startingEntitySet.entityType;const a=!!((t=o.annotations)!==null&&t!==void 0&&(n=t.Common)!==null&&n!==void 0&&n.ResultContext)&&!i.targetEntitySet;const r=a&&e.getConverterContextFor(`/${i.startingEntitySet.name}`);return r?o.entityProperties.map(function(e){return Q({},e.name,r,o)}):[]}const Z=function(e,t,n){const i=t.length===0||t.every(e=>!e.applySupported.enableSearch);const o=e.length===0||e.every(e=>(e.enableAnalytics||e.control.type==="TreeTable")&&!e.enableBasicSearch);const a=n.getContextPath();if(a&&i&&o){return true}else{return false}};v.getFilterBarHideBasicSearch=Z;const ee=function(e,t){const n=t.getManifestWrapper().getFilterConfiguration();const i=(n===null||n===void 0?void 0:n.filterFields)||{};const o=z(e,Object.keys(i).map(e=>x.getPathFromSelectionFieldKey(e)),true,t);const a={};for(const n in i){const r=i[n];const l=x.getPathFromSelectionFieldKey(n);const s=o[l];const c=r.type==="Slot"?w.Slot:w.Default;const u=r&&r!==null&&r!==void 0&&r.visualFilter?M(e,t,n,i):undefined;a[n]={key:n,type:c,slotName:(r===null||r===void 0?void 0:r.slotName)||n,annotationPath:s===null||s===void 0?void 0:s.annotationPath,conditionPath:(s===null||s===void 0?void 0:s.conditionPath)||l,template:r.template,label:r.label,position:r.position||{placement:N.After},availability:r.availability||"Default",settings:r.settings,visualFilter:u,required:r.required}}return a};v.getManifestFilterFields=ee;const te=function(e,t,n){return Q({},e,t,n)};v.getFilterField=te;const ne=function(e,t){let n=[];if(e&&e[t]){n=e[t].map(function(e){return e.value})}return n};v.getFilterRestrictions=ne;const ie=function(e){const t={};if(e&&e.FilterExpressionRestrictions){e.FilterExpressionRestrictions.forEach(function(e){var n;if((n=e.Property)!==null&&n!==void 0&&n.value&&e.AllowedExpressions){var i;if(t[(i=e.Property)===null||i===void 0?void 0:i.value]){var o;t[(o=e.Property)===null||o===void 0?void 0:o.value].push(e.AllowedExpressions.toString())}else{var a;t[(a=e.Property)===null||a===void 0?void 0:a.value]=[e.AllowedExpressions.toString()]}}})}return t};v.getFilterAllowedExpression=ie;const oe=function(){return{name:"$search",path:"$search",dataType:$,maxConditions:1}};const ae=function(){return{name:"$editState",path:"$editState",groupLabel:"",group:"",dataType:$,hiddenFilter:false}};const re=function(e){var t;const n=e.getEntitySet();return S(n)?(t=n.annotations.Capabilities)===null||t===void 0?void 0:t.SearchRestrictions:undefined};const le=function(e,t){var n,i,o;const a=(n=e.getEntitySet())===null||n===void 0?void 0:(i=n.annotations)===null||i===void 0?void 0:(o=i.Capabilities)===null||o===void 0?void 0:o.NavigationRestrictions;const r=a&&a.RestrictedProperties;return r&&r.find(function(e){return e&&e.NavigationProperty&&e.NavigationProperty.value===t})};v.getNavigationRestrictions=le;const se=function(e){return{key:e.key,annotationPath:e.annotationPath,conditionPath:e.conditionPath,name:e.conditionPath,label:e.label,hiddenFilter:e.availability==="Hidden",display:"Value",isParameter:e.isParameter,caseSensitive:e.caseSensitive,availability:e.availability,position:e.position,type:e.type,template:e.template,menu:e.menu,required:e.required}};const ce=function(e){const t=["SingleValue","MultiValue","SingleRange","MultiRange","SearchExpression","MultiRangeOrSearchExpression"];e.sort(function(e,n){return t.indexOf(e)-t.indexOf(n)});return e[0]};v.getSpecificAllowedExpression=ce;const ue=function(e,t){var n,i,o,a,r,l;const s=e===null||e===void 0?void 0:(n=e.Common)===null||n===void 0?void 0:n.Text,c=s&&(e&&(e===null||e===void 0?void 0:(i=e.Common)===null||i===void 0?void 0:(o=i.Text)===null||o===void 0?void 0:(a=o.annotations)===null||a===void 0?void 0:(r=a.UI)===null||r===void 0?void 0:r.TextArrangement)||t&&(t===null||t===void 0?void 0:(l=t.UI)===null||l===void 0?void 0:l.TextArrangement));if(c){if(c.valueOf()==="UI.TextArrangementType/TextOnly"){return"Description"}else if(c.valueOf()==="UI.TextArrangementType/TextLast"){return"ValueDescription"}return"DescriptionValue"}return s?"DescriptionValue":"Value"};v.displayMode=ue;const de=function(e,t,n){var i;let o=se(t);const a=t.annotationPath;if(!a){return o}const r=e.getConverterContextFor(a).getDataModelObjectPath().targetObject;const l=r===null||r===void 0?void 0:r.annotations;const s=e===null||e===void 0?void 0:(i=e.getDataModelObjectPath().targetObject)===null||i===void 0?void 0:i.annotations;const c=n.formatOptions;const u=n.constraints;o=Object.assign(o,{formatOptions:c,constraints:u,display:ue(l,s)});return o};v.fetchPropertyInfo=de;const ve=function(e){let t=true;switch(e.filterExpression){case"SearchExpression":case"SingleRange":case"SingleValue":t=false;break;default:break}if(e.type&&e.type.indexOf("Boolean")>0){t=false}return t};v.isMultiValue=ve;const pe=function(e){return(e.$Type==="com.sap.vocabularies.UI.v1.DataField"||e.$Type==="com.sap.vocabularies.UI.v1.DataFieldWithUrl"||e.$Type==="com.sap.vocabularies.UI.v1.DataFieldWithNavigationPath")&&e.Value.path.includes("/")};const fe=function(e,t,n){var i;const o=(i=e.Value)===null||i===void 0?void 0:i.$target;if(o){const e=y(o)||m(o)||g(o)||h(o);const i=e?b(t.getDataModelObjectPath(),e).navigationProperties:undefined;if(i!==null&&i!==void 0&&i.length){const e=i[0].name;if(!n.includes(e)){n.push(e)}}}};const ge=function(e,t,n){var i,o,a;switch(t.$Type){case"com.sap.vocabularies.UI.v1.DataFieldForAnnotation":switch((i=t.Target)===null||i===void 0?void 0:(o=i.$target)===null||o===void 0?void 0:o.$Type){case"com.sap.vocabularies.UI.v1.FieldGroupType":(a=t.Target.$target.Data)===null||a===void 0?void 0:a.forEach(t=>{ge(e,t,n)});break;default:break}break;case"com.sap.vocabularies.UI.v1.DataField":case"com.sap.vocabularies.UI.v1.DataFieldWithUrl":case"com.sap.vocabularies.UI.v1.DataFieldWithNavigationPath":if(pe(t)){const i=b(n.getDataModelObjectPath(),t.Value.path).navigationProperties[0].name;if(!e.includes(i)){e.push(i)}}fe(t,n,e);break;default:break}return e};const he=function(e){var t,n,i;let o=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];let a=arguments.length>2&&arguments[2]!==undefined?arguments[2]:"";let l=arguments.length>3&&arguments[3]!==undefined?arguments[3]:false;let s=arguments.length>4?arguments[4]:undefined;const c=W(o,e);const u=H(c);const d=e.getEntityType();const v=a&&((t=e.getEntityTypeAnnotation(a))===null||t===void 0?void 0:t.annotation)||((n=d.annotations)===null||n===void 0?void 0:(i=n.UI)===null||i===void 0?void 0:i.SelectionFields)||[];let f=[];if(o.length===0&&!!s){var g;(g=e.getEntityTypeAnnotation(s).annotation)===null||g===void 0?void 0:g.forEach(t=>{f=ge(f,t,e)})}if(r.isDraftRoot(e.getEntitySet())){f.push("DraftAdministrativeData/CreationDateTime","DraftAdministrativeData/CreatedByUser","DraftAdministrativeData/LastChangeDateTime","DraftAdministrativeData/LastChangedByUser")}const h={...J(d,"",d.entityProperties,l,e),...z(d,f,false,e),...z(d,e.getManifestWrapper().getFilterConfiguration().navigationProperties,l,e)};let y=[];const m=p(d,e);if(m){y=m.SelectOptions}const P=(v===null||v===void 0?void 0:v.reduce((t,n)=>{const i=n.value;if(!(i in u)){let n;if(a.startsWith("@com.sap.vocabularies.UI.v1.SelectionFields")){n=""}else{n=a.split("/@com.sap.vocabularies.UI.v1.SelectionFields")[0]}const o=n?n+"/"+i:i;const r=Q(h,o,e,d);if(r){r.group="";r.groupLabel="";t.push(r)}}return t},[]))||[];const b=Y(y,d,e,u,v);return{excludedFilterProperties:u,entityType:d,annotatedSelectionFields:v,filterFields:h,propertyInfoFields:P,defaultFilterFields:b}};const ye=function(e){const t=L(e,e===null||e===void 0?void 0:e.type);if((e===null||e===void 0?void 0:e.type)===V&&(t.constraints.nullable===undefined||t.constraints.nullable===true)){t.formatOptions.parseKeepsEmptyString=false}return t};v.fetchTypeConfig=ye;const me=function(e,t,n,i){let o=de(t,e,i[e.key]),a="";if(e.conditionPath){a=e.conditionPath.replace(/\+|\*/g,"")}if(o){o=Object.assign(o,{maxConditions:!o.isParameter&&ve(o)?-1:1,required:e.required??(o.isParameter||n.indexOf(a)>=0),caseSensitive:k(t),dataType:i[e.key].type})}return o};v.assignDataTypeToPropertyInfo=me;const Pe=function(e,t,n){var i;const o=[];const a={};if(n){e=e.concat(n)}e.forEach(function(e){if(e.annotationPath){const n=t.getConverterContextFor(e.annotationPath);const i=n.getDataModelObjectPath().targetObject;o.push(i===null||i===void 0?void 0:i.type);const r=ye(i);a[e.key]=r}else{o.push(V);a[e.key]={type:$}}});const l=t.getEntitySet();const s=S(l)?(i=l.annotations.Capabilities)===null||i===void 0?void 0:i.FilterRestrictions:undefined;const c={};c.RequiredProperties=ne(s,"RequiredProperties")||[];c.NonFilterableProperties=ne(s,"NonFilterableProperties")||[];c.FilterAllowedExpressions=ie(s);const u=t.getContextPath();const d=u.split("/");if(d.length>2){const e=d[d.length-1];d.splice(-1,1);const n=le(t,e);const i=n&&n.FilterRestrictions;c.RequiredProperties=c.RequiredProperties.concat(ne(i,"RequiredProperties")||[]);c.NonFilterableProperties=c.NonFilterableProperties.concat(ne(i,"NonFilterableProperties")||[]);c.FilterAllowedExpressions={...ie(i)||{},...c.FilterAllowedExpressions}}const v=c.RequiredProperties;const p=c.NonFilterableProperties;const f=[];e.forEach(function(e){const n=e.conditionPath.replace(/\+|\*/g,"");if(p.indexOf(n)===-1){const n=me(e,t,v,a);f.push(n)}});const g=t.getDataModelObjectPath();if(r.isObjectPathDraftSupported(g)){f.push(ae())}const h=re(t);const y=Boolean(h&&!h.Searchable);if(u&&y!==true){if(!h||h!==null&&h!==void 0&&h.Searchable){f.push(oe())}}return f};v.processSelectionFields=Pe;const be=function(e,t,n){return U(e,ee(t,n),{availability:R.overwrite,label:R.overwrite,type:R.overwrite,position:R.overwrite,slotName:R.overwrite,template:R.overwrite,settings:R.overwrite,visualFilter:R.overwrite,required:R.overwrite})};v.insertCustomManifestElements=be;const Fe=function(e){var t,n;let i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];let o=arguments.length>2&&arguments[2]!==undefined?arguments[2]:"";let a=arguments.length>3?arguments[3]:undefined;let r=arguments.length>4?arguments[4]:undefined;const l=he(e,i,o,a,r);const s=_(e);let c=l.propertyInfoFields;const u=l.entityType;c=s.concat(c);c=be(c,u,e);const d=Pe(c,e,l.defaultFilterFields);d.sort(function(e,t){if(e.groupLabel===undefined||e.groupLabel===null){return-1}if(t.groupLabel===undefined||t.groupLabel===null){return 1}return e.groupLabel.localeCompare(t.groupLabel)});let v=JSON.stringify(d);v=v.replace(/\{/g,"\\{");v=v.replace(/\}/g,"\\}");const p=v;let f=JSON.parse(JSON.stringify(l.propertyInfoFields));f=s.concat(f);const g=l.excludedFilterProperties;const h=u===null||u===void 0?void 0:(t=u.annotations)===null||t===void 0?void 0:(n=t.UI)===null||n===void 0?void 0:n.FilterFacets;let y={};const m=e.getAnnotationsByTerm("UI","com.sap.vocabularies.UI.v1.FieldGroup");if(h===undefined||h.length<0){for(const e in m){y={...y,...q(m[e])}}}else{y=h.reduce((e,t)=>{for(let d=0;d<(t===null||t===void 0?void 0:(n=t.Target)===null||n===void 0?void 0:(i=n.$target)===null||i===void 0?void 0:(o=i.Data)===null||o===void 0?void 0:o.length);d++){var n,i,o,a,r,l,s,c,u;e[t===null||t===void 0?void 0:(a=t.Target)===null||a===void 0?void 0:(r=a.$target)===null||r===void 0?void 0:(l=r.Data[d])===null||l===void 0?void 0:(s=l.Value)===null||s===void 0?void 0:s.path]={group:t===null||t===void 0?void 0:(c=t.ID)===null||c===void 0?void 0:c.toString(),groupLabel:t===null||t===void 0?void 0:(u=t.Label)===null||u===void 0?void 0:u.toString()}}return e},{})}const P=l.filterFields;let b=f.concat(Object.keys(P).filter(e=>!(e in g)).map(e=>Object.assign(P[e],y[e])));const F=e.getContextPath();if(B(i,F)){const e=i[0].aggregates;if(e){const t=Object.keys(e).map(t=>e[t].relativePath);b=b.filter(e=>t.indexOf(e.key)===-1)}}const T=be(b,u,e);const S=k(e);T.forEach(e=>{e.caseSensitive=S});return{selectionFields:T,sPropertyInfo:p}};v.getSelectionFields=Fe;const Te=function(e,t,n){const i=ne(t,"RequiredProperties");const o=re(e);const a=Boolean(o&&!o.Searchable);if(i.length>0||a||(n===null||n===void 0?void 0:n.FetchValues)===2){return true}return false};v.getExpandFilterFields=Te;return v},false);
//# sourceMappingURL=FilterBar.js.map