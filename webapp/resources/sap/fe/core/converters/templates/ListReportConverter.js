/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/fe/core/converters/controls/Common/Action","sap/fe/core/converters/controls/ListReport/FilterBar","sap/fe/core/converters/helpers/ConfigurableObject","sap/fe/core/helpers/BindingToolkit","../controls/Common/DataVisualization","../controls/Common/KPI","../helpers/ID","../ManifestSettings"],function(t,e,n,i,a,o,r,s){"use strict";var l={};var c=s.VisualizationType;var u=s.VariantManagementType;var f=s.TemplateType;var d=r.getTableID;var p=r.getIconTabBarID;var v=r.getFilterVariantManagementID;var h=r.getFilterBarID;var y=r.getDynamicListReportID;var g=r.getCustomTabID;var m=r.getChartID;var C=o.getKPIDefinitions;var b=a.isSelectionPresentationCompliant;var P=a.isPresentationCompliant;var T=a.getSelectionVariant;var I=a.getSelectionPresentationVariant;var V=a.getDefaultPresentationVariant;var w=a.getDefaultLineItem;var E=a.getDefaultChart;var z=a.getDataVisualizationConfiguration;var S=i.getExpressionFromAnnotation;var M=i.compileExpression;var k=n.insertCustomElements;var A=e.getSelectionFields;var D=e.getManifestFilterFields;var F=e.getFilterBarHideBasicSearch;var L=t.getActionsFromManifest;function B(t){const e=[];t.forEach(function(t){if(!t.type){const n=t.secondaryVisualization?t.secondaryVisualization.visualizations:t.presentation.visualizations;n.forEach(function(t){if(t.type===c.Table){e.push(t)}})}});return e}function x(t){const e=[];t.forEach(function(t){if(!t.type){const n=t.primaryVisualization?t.primaryVisualization.visualizations:t.presentation.visualizations;n.forEach(function(t){if(t.type===c.Chart){e.push(t)}})}});return e}const R=function(t){const e={};for(const s in t){var n,i,a;if((n=t[s])!==null&&n!==void 0&&(i=n.settings)!==null&&i!==void 0&&(a=i.defaultValues)!==null&&a!==void 0&&a.length){var o,r;e[s]=(o=t[s])===null||o===void 0?void 0:(r=o.settings)===null||r===void 0?void 0:r.defaultValues}}return e};function W(t,e,n){const i=e.getManifestWrapper().getDefaultTemplateAnnotationPath();const a=I(t,i,e);const o="ALP flavor needs both chart and table to load the application";if(a){if(i){const t=a.PresentationVariant;if(!t){throw new Error("Presentation Variant is not configured in the SPV mentioned in the manifest")}if(!P(t,n)){if(n){throw new Error(o)}return undefined}}if(b(a,n)===true){return a}else if(n){throw new Error(o)}}const r=V(t);if(r){if(P(r,n)){return r}else if(n){throw new Error(o)}}if(!n){return w(t)}return undefined}const H=function(t,e){let n=t;if(n.converterContext){var i,a;let t=n.converterContext;n=n;const o=function(t){return t.key!==undefined};let r=z(n.annotation?t.getRelativeAnnotationPath(n.annotation.fullyQualifiedName,t.getEntityType()):"",true,t,n,undefined,undefined,o(n),e);let s="";let l="";let u="";let p="";const v=function(t,e){let n;for(const i of t.visualizations){if(e&&i.type===c.Chart){n=i;break}if(!e&&i.type===c.Table){n=i;break}}const i=Object.assign({},t);if(n){i.visualizations=[n]}else{throw new Error((e?"Primary":"Secondary")+" visualisation needs valid "+(e?"chart":"table"))}return i};const h=function(i,a){const o=t.getEntityTypeAnnotation(i.annotationPath);const s=o.annotation;t=o.converterContext;const l=s;if(l||t.getTemplateType()===f.AnalyticalListPage){r=z(l?t.getRelativeAnnotationPath(l.fullyQualifiedName,t.getEntityType()):"",true,t,n,undefined,undefined,undefined,e);return r}else{const t="Annotation Path for the "+(a?"primary":"secondary")+" visualisation mentioned in the manifest is not found";throw new Error(t)}};const y=function(t,e){var i,a,o;const r=v(t[0],true);l=r===null||r===void 0?void 0:(i=r.visualizations[0])===null||i===void 0?void 0:i.id;const c=v(t[1]?t[1]:t[0],false);s=c===null||c===void 0?void 0:(a=c.visualizations[0])===null||a===void 0?void 0:(o=a.annotation)===null||o===void 0?void 0:o.id;if(r&&c){n=n;const t=n.visible;const i={primaryVisualization:r,secondaryVisualization:c,tableControlId:s,chartControlId:l,defaultPath:e,visible:t};return i}};if(!t.getManifestWrapper().hasMultipleVisualizations(n)&&((i=r)===null||i===void 0?void 0:(a=i.visualizations)===null||a===void 0?void 0:a.length)===2&&t.getTemplateType()===f.AnalyticalListPage){const t=y([r],"both");if(t){return t}}else if(t.getManifestWrapper().hasMultipleVisualizations(n)||t.getTemplateType()===f.AnalyticalListPage){const{primary:t,secondary:e}=n;if(t&&t.length&&e&&e.length){const i=y([h(t[0],true),h(e[0],false)],n.defaultPath);if(i){return i}}else{throw new Error("SecondaryItems in the Views is not present")}}else if(o(n)){const e=t.getEntityTypeAnnotation(n.annotationPath);const i=e.annotation;t=e.converterContext;u=M(S(i.Text));r.visualizations.forEach((t,e)=>{var i;switch(t.type){case c.Table:const t=r.visualizations[e];const o=t.control.filters||{};o.hiddenFilters=o.hiddenFilters||{paths:[]};if(!n.keepPreviousPersonalization){t.annotation.id=d(n.key||"","LineItem")}n=n;if(((i=n.annotation)===null||i===void 0?void 0:i.term)==="com.sap.vocabularies.UI.v1.SelectionPresentationVariant"){var a;if(!n.annotation.SelectionVariant){throw new Error(`The Selection Variant is missing for the Selection Presentation Variant ${n.annotation.fullyQualifiedName}`)}p=`@${(a=n.annotation.SelectionVariant)===null||a===void 0?void 0:a.fullyQualifiedName.split("@")[1]}`}else{p=n.annotationPath}o.hiddenFilters.paths.push({annotationPath:p});t.control.filters=o;break;case c.Chart:const s=r.visualizations[e];s.id=m(n.key||"","Chart");s.multiViews=true;break;default:break}})}r.visualizations.forEach(t=>{if(t.type===c.Table){s=t.annotation.id}else if(t.type===c.Chart){l=t.id}});n=n;const g=n.visible;return{presentation:r,tableControlId:s,chartControlId:l,title:u,selectionVariantPath:p,visible:g}}else{n=n;const t=n.label,e=n.template,i=n.type,a=g(n.key||""),o=n.visible;return{title:t,fragment:e,type:i,customTabId:a,visible:o}}};const j=function(t,e,n){let i=[];if(e){e.paths.forEach(n=>{if(t.getManifestWrapper().hasMultipleVisualizations(n)){if(e.paths.length>1){throw new Error("ALP flavor cannot have multiple views")}else{n=n;i.push({converterContext:t,primary:n.primary,secondary:n.secondary,defaultPath:n.defaultPath})}}else if(n.template){n=n;i.push({key:n.key,label:n.label,template:n.template,type:"Custom",visible:n.visible})}else{n=n;const e=t.getConverterContextFor(n.contextPath||n.entitySet&&`/${n.entitySet}`||t.getContextPath()),a=e.getEntityType();if(a&&e){let t;const o=e.getEntityTypeAnnotation(n.annotationPath);const r=o.annotation;if(r){t=r.term==="com.sap.vocabularies.UI.v1.SelectionVariant"?W(a,e,false):r;i.push({converterContext:e,annotation:t,annotationPath:n.annotationPath,keepPreviousPersonalization:n.keepPreviousPersonalization,key:n.key,visible:n.visible})}}else{}}})}else{const e=t.getEntityType();if(t.getTemplateType()===f.AnalyticalListPage){i=Q(t,i)}else{i.push({annotation:W(e,t,false),converterContext:t})}}return i.map(t=>H(t,n))};const N=function(t,e){const n=t.getManifestWrapper();const i=n.getViewConfiguration();if(e.length>1&&!$(t)){return{showTabCounts:i?(i===null||i===void 0?void 0:i.showCounts)||n.hasMultipleEntitySets():undefined,id:p()}}return undefined};function Q(t,e){const n=t.getEntityType();const i=W(n,t,true);let a,o;if(i){e.push({annotation:i,converterContext:t})}else{a=E(n);o=w(n);if(a&&o){const n=[{annotationPath:"@"+a.term}];const i=[{annotationPath:"@"+o.term}];e.push({converterContext:t,primary:n,secondary:i,defaultPath:"both"})}else{throw new Error("ALP flavor needs both chart and table to load the application")}}return e}function $(t){return t.getManifestWrapper().hasMultipleVisualizations()||t.getTemplateType()===f.AnalyticalListPage}const K=function(t){const e=t.getManifestWrapper();return k([],L(e.getHeaderActions(),t).actions)};l.getHeaderActions=K;const O=function(t,e){t.forEach(t=>{if(!t.type){const n=t.presentation;n.visualizations.forEach(t=>{if(t.type===c.Chart&&t.filterId!==e){t.filterId=e}})}})};l.checkChartFilterBarId=O;const U=function(t,e){const n=t.getEntityType();const i=t.getContextPath();if(!i){throw new Error("An EntitySet is required to be able to display a ListReport, please adjust your `entitySet` property to point to one.")}const a=t.getManifestWrapper();const o=a.getViewConfiguration();const r=a.hasMultipleEntitySets();const s=j(t,o,e);const l=B(s);const c=x(s);const f=l.some(t=>t.control.type==="ResponsiveTable");let d="";let p="";const g=y();const m=h(i);const b=v(m);const P=a.getFilterConfiguration();const I=(P===null||P===void 0?void 0:P.initialLayout)!==undefined?P===null||P===void 0?void 0:P.initialLayout.toLowerCase():"compact";const V=(P===null||P===void 0?void 0:P.layout)!==undefined?P===null||P===void 0?void 0:P.layout.toLowerCase():"compact";const w=P.useSemanticDateRange!==undefined?P.useSemanticDateRange:true;const E=P.showClearButton!==undefined?P.showClearButton:false;const z=q(t,s);if(z){p=z.chartId;d=z.tableId}const S=a.useHiddenFilterBar();const M=(a.isFilterBarHidden()||S)&&p==="";const k=A(t,l);const L=k.selectionFields;const W=k.sPropertyInfo;const H=F(l,c,t);const Q=N(t,s);const U=Q?undefined:T(n,t);const G=w?R(D(n,t)):{};const J=K(t);if(r){O(s,m)}const X=l.map(t=>t.annotation.id).concat(c.map(t=>t.id));const Y=[...M&&!S?[]:[m],...a.getVariantManagement()!==u.Control?X:[],...Q?[Q.id]:[]];const Z=Q&&a.getStickyMultiTabHeaderConfiguration()?Q.id:undefined;return{mainEntitySet:i,mainEntityType:`${i}/`,multiViewsControl:Q,stickySubheaderProvider:Z,singleTableId:d,singleChartId:p,dynamicListReportId:g,headerActions:J,showPinnableToggle:f,filterBar:{propertyInfo:W,selectionFields:L,hideBasicSearch:H,showClearButton:E},views:s,filterBarId:M&&!S?"":m,filterConditions:{selectionVariant:U,defaultSemanticDates:G},variantManagement:{id:b,targetControlIds:Y.join(",")},hasMultiVisualizations:$(t),templateType:a.getTemplateType(),useSemanticDateRange:w,filterInitialLayout:I,filterLayout:V,kpiDefinitions:C(t),hideFilterBar:M,useHiddenFilterBar:S}};l.convertPage=U;function q(t,e){let n="",i="";if(t.getManifestWrapper().hasMultipleVisualizations()||t.getTemplateType()===f.AnalyticalListPage){for(const t of e){const e=t;if(e.chartControlId&&e.tableControlId){i=e.chartControlId;n=e.tableControlId;break}}}else{for(const t of e){const e=t;if(!n&&e.tableControlId){n=e.tableControlId||""}if(!i&&e.chartControlId){i=e.chartControlId||""}if(i&&n){break}}}if(n||i){return{chartId:i,tableId:n}}return undefined}return l},false);
//# sourceMappingURL=ListReportConverter.js.map