/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/merge","sap/fe/core/CommonUtils","sap/fe/core/helpers/ClassSupport","sap/fe/core/helpers/KeepAliveHelper","sap/fe/core/helpers/ModelHelper","sap/fe/navigation/library","sap/ui/core/mvc/ControllerExtension","sap/ui/core/mvc/OverrideExecution","sap/ui/fl/apply/api/ControlVariantApplyAPI","sap/fe/core/controls/filterbar/adapter/SelectionVariantToStateFilters","sap/ui/mdc/p13n/StateUtil"],function(t,e,r,i,n,a,o,p,l,s,c,f){"use strict";var d,u,y,g,S,h,v,b,w,C,O,A,I,m,P,_,B,R,j,V,E,x,D,K,F,H,M,T,k,N,$,z,U,L,q,G,J,Q,W,X,Y,Z,tt,et,rt,it,nt,at,ot;var pt=i.publicExtension;var lt=i.privateExtension;var st=i.finalExtension;var ct=i.extensible;var ft=i.defineUI5Class;function dt(t,e){t.prototype=Object.create(e.prototype);t.prototype.constructor=t;ut(t,e)}function ut(t,e){ut=Object.setPrototypeOf?Object.setPrototypeOf.bind():function t(e,r){e.__proto__=r;return e};return ut(t,e)}function yt(t,e,r,i,n){var a={};Object.keys(i).forEach(function(t){a[t]=i[t]});a.enumerable=!!a.enumerable;a.configurable=!!a.configurable;if("value"in a||a.initializer){a.writable=true}a=r.slice().reverse().reduce(function(r,i){return i(t,e,r)||r},a);if(n&&a.initializer!==void 0){a.value=a.initializer?a.initializer.call(n):void 0;a.initializer=undefined}if(a.initializer===void 0){Object.defineProperty(t,e,a);a=null}return a}const gt="#additionalStates",St=o.NavType;const ht={"sap.ui.fl.variants.VariantManagement":{retrieve:function(t){return{variantId:t.getCurrentVariantKey()}},apply:async function(e,r){try{if(r&&r.variantId!==undefined&&r.variantId!==e.getCurrentVariantKey()){const i=this._checkIfVariantIdIsAvailable(e,r.variantId);let n;if(i){n=r.variantId}else{n=e.getStandardVariantKey();this.controlsVariantIdUnavailable.push(...e.getFor())}try{await s.activateVariant({element:e,variantReference:n});await this._setInitialStatesForDeltaCompute(e)}catch(r){t.error(r);this.invalidateInitialStateForApply.push(...e.getFor());await this._setInitialStatesForDeltaCompute(e)}}else{this._setInitialStatesForDeltaCompute(e)}}catch(e){t.error(e)}}},"sap.m.IconTabBar":{retrieve:function(t){return{selectedKey:t.getSelectedKey()}},apply:function(t,e){if(e&&e.selectedKey){const r=t.getItems().find(function(t){return t.getKey()===e.selectedKey});if(r){t.setSelectedItem(r)}}}},"sap.ui.mdc.FilterBar":{retrieve:async function(t){const e=this.getStateKey(t);const r=await f.retrieveExternalState(t);const i=t.getPropertyInfoSet();const n=r.filter||{};i.filter(function(t){return Object.keys(n).length>0&&t.path&&n[t.path]&&(t.removeFromAppState||n[t.path].length===0)}).forEach(function(t){if(t.path){delete n[t.path]}});return this._getControlState(e,r)},apply:async function(e,r,i){try{if(r){const t=this._isInitialStatesApplicable(r===null||r===void 0?void 0:r.initialState,e);const n=i.navigationType;if(n===St.hybrid&&r.fullState!==undefined){const t=await c.getFilterBarSupportedFields(e),n=c.getFilterBarInfoForConversion(e),a=c.getConditionsFromSV(i.selectionVariant,n,t);const o={...r.fullState,filter:{...r.fullState.filter,...a}};return f.applyExternalState(e,o)}if(t){const t=await f.diffState(e,r.initialState,r.fullState);return f.applyExternalState(e,t)}return f.applyExternalState(e,(r===null||r===void 0?void 0:r.fullState)??r)}}catch(e){t.error(e)}}},"sap.ui.mdc.Table":{retrieve:async function(t){const e=this.getStateKey(t);const r=await f.retrieveExternalState(t);return this._getControlState(e,r)},apply:async function(e,r,i){try{if(r){const t=this._isInitialStatesApplicable(r===null||r===void 0?void 0:r.initialState,e,i.navigationType!==St.hybrid);if(t){var n;if(r.initialState&&!((n=r.initialState)!==null&&n!==void 0&&n.supplementaryConfig)){r.initialState.supplementaryConfig={}}const t=await f.diffState(e,r.initialState,r.fullState);return f.applyExternalState(e,t)}else{if(!r.supplementaryConfig){r.supplementaryConfig={}}return f.applyExternalState(e,(r===null||r===void 0?void 0:r.fullState)??r)}}}catch(e){t.error(e)}},refreshBinding:function(e){const r=e.getRowBinding();if(r){const t=r.getRootBinding();if(t===r){r.refresh()}else{const t=r.getHeaderContext();const e=r.getGroupId();if(t){t.requestSideEffects([{$NavigationPropertyPath:""}],e)}}}else{t.info(`Table: ${e.getId()} was not refreshed. No binding found!`)}}},"sap.ui.mdc.Chart":{retrieve:function(t){return f.retrieveExternalState(t)},apply:function(t,e){if(e){return f.applyExternalState(t,e)}}},"sap.uxap.ObjectPageLayout":{retrieve:function(t){return{selectedSection:t.getSelectedSection()}},apply:function(t,e){if(e){t.setSelectedSection(e.selectedSection)}},refreshBinding:function(e){const i=e.getBindingContext();const o=i&&i.getBinding();if(o){const t=a.getMetaPathForContext(i);const p=n.getControlRefreshStrategyForContextPath(e,t);if(p==="self"){const e=i.getModel(),n=e.getMetaModel(),a=r.getContextPathProperties(n,t,{$kind:"NavigationProperty"})||{},p=Object.keys(a).reduce(function(t,e){if(a[e].$isCollection!==true){t.push({$NavigationPropertyPath:e})}return t},[]),l=[{$PropertyPath:"*"}],s=o.getGroupId();i.requestSideEffects(l.concat(p),s)}else if(p==="includingDependents"){o.refresh()}}else{t.info(`ObjectPage: ${e.getId()} was not refreshed. No binding found!`)}}},"sap.m.SegmentedButton":{retrieve:function(t){return{selectedKey:t.getSelectedKey()}},apply:function(t,e){if(e!==null&&e!==void 0&&e.selectedKey&&e.selectedKey!==t.getSelectedKey()){var r;t.setSelectedKey(e.selectedKey);if((r=t.getParent())!==null&&r!==void 0&&r.isA("sap.ui.mdc.ActionToolbar")){t.fireEvent("selectionChange")}}}},"sap.m.Select":{retrieve:function(t){return{selectedKey:t.getSelectedKey()}},apply:function(t,e){if(e!==null&&e!==void 0&&e.selectedKey&&e.selectedKey!==t.getSelectedKey()){var r;t.setSelectedKey(e.selectedKey);if((r=t.getParent())!==null&&r!==void 0&&r.isA("sap.ui.mdc.ActionToolbar")){t.fireEvent("change")}}}},"sap.f.DynamicPage":{retrieve:function(t){return{headerExpanded:t.getHeaderExpanded()}},apply:function(t,e){if(e){t.setHeaderExpanded(e.headerExpanded)}}},"sap.ui.core.mvc.View":{retrieve:function(t){const e=t.getController();if(e&&e.viewState){return e.viewState.retrieveViewState(e.viewState)}return{}},apply:function(t,e,r){const i=t.getController();if(i&&i.viewState){return i.viewState.applyViewState(e,r)}},refreshBinding:function(t){const e=t.getController();if(e&&e.viewState){return e.viewState.refreshViewBindings()}}},"sap.ui.core.ComponentContainer":{retrieve:function(t){const e=t.getComponentInstance();if(e){return this.retrieveControlState(e.getRootControl())}return{}},apply:function(t,e,r){const i=t.getComponentInstance();if(i){return this.applyControlState(i.getRootControl(),e,r)}}}};let vt=(d=ft("sap.fe.core.controllerextensions.ViewState"),u=pt(),y=st(),g=pt(),S=ct(l.After),h=lt(),v=st(),b=lt(),w=st(),C=pt(),O=ct(l.After),A=pt(),I=ct(l.After),m=pt(),P=ct(l.After),_=lt(),B=st(),R=pt(),j=ct(l.After),V=lt(),E=st(),x=pt(),D=ct(l.After),K=pt(),F=st(),H=pt(),M=st(),T=pt(),k=ct(l.After),N=lt(),$=st(),z=pt(),U=ct(l.Instead),L=pt(),q=st(),G=lt(),J=pt(),Q=ct(l.After),W=pt(),X=ct(l.After),Y=pt(),Z=ct(l.After),tt=lt(),et=pt(),rt=ct(l.After),it=lt(),nt=st(),d(at=(ot=function(r){dt(i,r);function i(){var e;e=r.call(this)||this;e.initialControlStatesMapper={};e.controlsVariantIdUnavailable=[];e.invalidateInitialStateForApply=[];e.viewStateControls=[];e._setInitialStatesForDeltaCompute=async r=>{try{const t=e.viewStateControls;const i=[];const n=[];let a=[];const o=(r===null||r===void 0?void 0:r.getFor())??[];t.filter(function(t){return t&&(!r||o.indexOf(t.getId())>-1)&&(t.isA("sap.ui.mdc.Table")||t.isA("sap.ui.mdc.FilterBar")||t.isA("sap.ui.mdc.Chart"))}).forEach(t=>{if(r){e._addEventListenersToVariantManagement(r,o)}const a=f.retrieveExternalState(t);i.push(a);n.push(e.getStateKey(t))});a=await Promise.all(i);a.forEach((t,r)=>{e.initialControlStatesMapper[n[r]]=t})}catch(e){t.error(e)}};e._iRetrievingStateCounter=0;e._pInitialStateApplied=new Promise(t=>{e._pInitialStateAppliedResolve=t});return e}var n=i.prototype;n.refreshViewBindings=async function t(){const e=await this.collectResults(this.base.viewState.adaptBindingRefreshControls);let r=Promise.resolve();e.filter(t=>t&&t.isA&&t.isA("sap.ui.base.ManagedObject")).forEach(t=>{r=r.then(this.refreshControlBinding.bind(this,t))});return r};n.adaptBindingRefreshControls=function t(e){};n.refreshControlBinding=function e(r){const i=this.getControlRefreshBindingHandler(r);let n=Promise.resolve();if(typeof i.refreshBinding!=="function"){t.info(`refreshBinding handler for control: ${r.getMetadata().getName()} is not provided`)}else{n=n.then(i.refreshBinding.bind(this,r))}return n};n.getControlRefreshBindingHandler=function t(e){const r={};if(e){for(const t in ht){if(e.isA(t)){r["refreshBinding"]=ht[t].refreshBinding||{};break}}}this.base.viewState.adaptBindingRefreshHandler(e,r);return r};n.adaptBindingRefreshHandler=function t(e,r){};n.onSuspend=function t(){};n.onRestore=function t(){};n.destroy=function t(){delete this._pInitialStateAppliedResolve;r.prototype.destroy.call(this)};n.collectResults=function t(e){const r=[];for(var i=arguments.length,n=new Array(i>1?i-1:0),a=1;a<i;a++){n[a-1]=arguments[a]}n.push(r);e.apply(this,n);return Promise.all(r)};n.adaptControlStateHandler=function t(e,r){};n.getControlStateHandler=function t(e){const r=[],i=[];if(e){for(const t in ht){if(e.isA(t)){r.push(Object.assign({},ht[t]));break}}}this.base.viewState.adaptControlStateHandler(e,i);return r.concat(i)};n.adaptStateControls=function t(e){};n.getStateKey=function t(e){return this.getView().getLocalId(e.getId())||e.getId()};n.retrieveViewState=async function t(){++this._iRetrievingStateCounter;let r;try{await this._pInitialStateApplied;const t=await this.collectResults(this.base.viewState.adaptStateControls);const i=await Promise.all(t.filter(function(t){return t&&t.isA&&t.isA("sap.ui.base.ManagedObject")}).map(t=>this.retrieveControlState(t).then(e=>({key:this.getStateKey(t),value:e}))));r=i.reduce(function(t,r){const i={};i[r.key]=r.value;return e(t,i)},{});const n=await Promise.resolve(this._retrieveAdditionalStates());if(n&&Object.keys(n).length){r[gt]=n}}finally{--this._iRetrievingStateCounter}return this._iRetrievingStateCounter===0?r:undefined};n.retrieveAdditionalStates=function t(e){};n._retrieveAdditionalStates=function t(){const e={};this.base.viewState.retrieveAdditionalStates(e);return e};n.retrieveControlState=function t(r){const i=this.getControlStateHandler(r);return Promise.all(i.map(t=>{if(typeof t.retrieve!=="function"){throw new Error(`controlStateHandler.retrieve is not a function for control: ${r.getMetadata().getName()}`)}return t.retrieve.call(this,r)})).then(t=>t.reduce(function(t,r){return e(t,r)},{}))};n.applyInitialStateOnly=function t(){return true};n.applyViewState=async function e(r,i){if(this.base.viewState.applyInitialStateOnly()&&this._getInitialStateApplied()){return}try{await this.collectResults(this.base.viewState.onBeforeStateApplied,[],i.navigationType);const t=await this.collectResults(this.base.viewState.adaptStateControls);this.viewStateControls=t;let e=Promise.resolve();let n=false;const a=t.reduce((t,e)=>{if(!e){return t}const r=e.isA("sap.ui.fl.variants.VariantManagement");if(!n){n=r}t=r?[e,...t]:[...t,e];return t},[]);if(!n){this._setInitialStatesForDeltaCompute()}a.filter(function(t){return t.isA("sap.ui.base.ManagedObject")}).forEach(t=>{const n=this.getStateKey(t);e=e.then(this.applyControlState.bind(this,t,r?r[n]:undefined,i))});await e;if(i.navigationType===St.iAppState||i.navigationType===St.hybrid){await this.collectResults(this.base.viewState.applyAdditionalStates,r?r[gt]:undefined)}else{await this.collectResults(this.base.viewState.applyNavigationParameters,i);await this.collectResults(this.base.viewState._applyNavigationParametersToFilterbar,i)}}finally{try{await this.collectResults(this.base.viewState.onAfterStateApplied);this._setInitialStateApplied()}catch(e){t.error(e)}}};n._checkIfVariantIdIsAvailable=function t(e,r){const i=e.getVariants();let n=false;i.forEach(function(t){if(t.key===r){n=true}});return n};n._setInitialStateApplied=function t(){if(this._pInitialStateAppliedResolve){const t=this._pInitialStateAppliedResolve;delete this._pInitialStateAppliedResolve;t()}};n._getInitialStateApplied=function t(){return!this._pInitialStateAppliedResolve};n.onBeforeStateApplied=function t(e,r){};n.onAfterStateApplied=function t(e){};n.applyAdditionalStates=function t(e,r){};n._applyNavigationParametersToFilterbar=function t(e,r){};n.applyNavigationParameters=function t(e,r){};n.applyControlState=function t(e,r,i){const n=this.getControlStateHandler(e);let a=Promise.resolve();n.forEach(t=>{if(typeof t.apply!=="function"){throw new Error(`controlStateHandler.apply is not a function for control: ${e.getMetadata().getName()}`)}a=a.then(t.apply.bind(this,e,r,i))});return a};n.getInterface=function t(){return this};n._getControlState=function t(e,r){const i=this.initialControlStatesMapper;if(Object.keys(i).length>0&&i[e]){if(Object.keys(i[e]).length===0){i[e]={...r}}return{fullState:r,initialState:i[e]}}return r};n._addEventListenersToVariantManagement=function t(e,r){const i={variantManagedControls:r};const n=()=>{this._updateInitialStatesOnVariantChange(r)};e.attachSave(i,n,{});e.attachSelect(i,n,{})};n._updateInitialStatesOnVariantChange=function t(e){const r=this.initialControlStatesMapper;Object.keys(r).forEach(t=>{for(const i of e){if(i.indexOf(t)>-1){r[t]={}}}})};n._isInitialStatesApplicable=function t(e,r,i){return e&&this.invalidateInitialStateForApply.indexOf(r.getId())===-1&&this.controlsVariantIdUnavailable.indexOf(r.getId())===-1&&(i??true)};return i}(p),yt(ot.prototype,"refreshViewBindings",[u,y],Object.getOwnPropertyDescriptor(ot.prototype,"refreshViewBindings"),ot.prototype),yt(ot.prototype,"adaptBindingRefreshControls",[g,S],Object.getOwnPropertyDescriptor(ot.prototype,"adaptBindingRefreshControls"),ot.prototype),yt(ot.prototype,"refreshControlBinding",[h,v],Object.getOwnPropertyDescriptor(ot.prototype,"refreshControlBinding"),ot.prototype),yt(ot.prototype,"getControlRefreshBindingHandler",[b,w],Object.getOwnPropertyDescriptor(ot.prototype,"getControlRefreshBindingHandler"),ot.prototype),yt(ot.prototype,"adaptBindingRefreshHandler",[C,O],Object.getOwnPropertyDescriptor(ot.prototype,"adaptBindingRefreshHandler"),ot.prototype),yt(ot.prototype,"onSuspend",[A,I],Object.getOwnPropertyDescriptor(ot.prototype,"onSuspend"),ot.prototype),yt(ot.prototype,"onRestore",[m,P],Object.getOwnPropertyDescriptor(ot.prototype,"onRestore"),ot.prototype),yt(ot.prototype,"collectResults",[_,B],Object.getOwnPropertyDescriptor(ot.prototype,"collectResults"),ot.prototype),yt(ot.prototype,"adaptControlStateHandler",[R,j],Object.getOwnPropertyDescriptor(ot.prototype,"adaptControlStateHandler"),ot.prototype),yt(ot.prototype,"getControlStateHandler",[V,E],Object.getOwnPropertyDescriptor(ot.prototype,"getControlStateHandler"),ot.prototype),yt(ot.prototype,"adaptStateControls",[x,D],Object.getOwnPropertyDescriptor(ot.prototype,"adaptStateControls"),ot.prototype),yt(ot.prototype,"getStateKey",[K,F],Object.getOwnPropertyDescriptor(ot.prototype,"getStateKey"),ot.prototype),yt(ot.prototype,"retrieveViewState",[H,M],Object.getOwnPropertyDescriptor(ot.prototype,"retrieveViewState"),ot.prototype),yt(ot.prototype,"retrieveAdditionalStates",[T,k],Object.getOwnPropertyDescriptor(ot.prototype,"retrieveAdditionalStates"),ot.prototype),yt(ot.prototype,"retrieveControlState",[N,$],Object.getOwnPropertyDescriptor(ot.prototype,"retrieveControlState"),ot.prototype),yt(ot.prototype,"applyInitialStateOnly",[z,U],Object.getOwnPropertyDescriptor(ot.prototype,"applyInitialStateOnly"),ot.prototype),yt(ot.prototype,"applyViewState",[L,q],Object.getOwnPropertyDescriptor(ot.prototype,"applyViewState"),ot.prototype),yt(ot.prototype,"_checkIfVariantIdIsAvailable",[G],Object.getOwnPropertyDescriptor(ot.prototype,"_checkIfVariantIdIsAvailable"),ot.prototype),yt(ot.prototype,"onBeforeStateApplied",[J,Q],Object.getOwnPropertyDescriptor(ot.prototype,"onBeforeStateApplied"),ot.prototype),yt(ot.prototype,"onAfterStateApplied",[W,X],Object.getOwnPropertyDescriptor(ot.prototype,"onAfterStateApplied"),ot.prototype),yt(ot.prototype,"applyAdditionalStates",[Y,Z],Object.getOwnPropertyDescriptor(ot.prototype,"applyAdditionalStates"),ot.prototype),yt(ot.prototype,"_applyNavigationParametersToFilterbar",[tt],Object.getOwnPropertyDescriptor(ot.prototype,"_applyNavigationParametersToFilterbar"),ot.prototype),yt(ot.prototype,"applyNavigationParameters",[et,rt],Object.getOwnPropertyDescriptor(ot.prototype,"applyNavigationParameters"),ot.prototype),yt(ot.prototype,"applyControlState",[it,nt],Object.getOwnPropertyDescriptor(ot.prototype,"applyControlState"),ot.prototype),ot))||at);return vt},false);
//# sourceMappingURL=ViewState.js.map