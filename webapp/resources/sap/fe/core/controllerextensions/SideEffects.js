/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/ui/core/mvc/ControllerExtension","../CommonUtils","../helpers/ClassSupport"],function(e,t,i,r){"use strict";var o,s,n,d,f,c,p,a,l,u,g,y,E,h,F,S,v,m,_,O,G,P,b,x,C,w,j,M,D,I,q,T,$,R,A,V,B,k,z,N;var Q=r.publicExtension;var U=r.privateExtension;var L=r.methodOverride;var W=r.finalExtension;var H=r.defineUI5Class;function J(e,t){e.prototype=Object.create(t.prototype);e.prototype.constructor=e;K(e,t)}function K(e,t){K=Object.setPrototypeOf?Object.setPrototypeOf.bind():function e(t,i){t.__proto__=i;return t};return K(e,t)}function X(e,t,i,r,o){var s={};Object.keys(r).forEach(function(e){s[e]=r[e]});s.enumerable=!!s.enumerable;s.configurable=!!s.configurable;if("value"in s||s.initializer){s.writable=true}s=i.slice().reverse().reduce(function(i,r){return r(e,t,i)||i},s);if(o&&s.initializer!==void 0){s.value=s.initializer?s.initializer.call(o):void 0;s.initializer=undefined}if(s.initializer===void 0){Object.defineProperty(e,t,s);s=null}return s}const Y="$$ImmediateRequest";let Z=(o=H("sap.fe.core.controllerextensions.SideEffects"),s=L(),n=Q(),d=W(),f=Q(),c=W(),p=Q(),a=W(),l=Q(),u=W(),g=Q(),y=W(),E=Q(),h=W(),F=Q(),S=W(),v=Q(),m=W(),_=Q(),O=W(),G=Q(),P=W(),b=Q(),x=W(),C=Q(),w=W(),j=U(),M=W(),D=Q(),I=W(),q=U(),T=W(),$=U(),R=W(),A=U(),V=W(),B=Q(),k=W(),o(z=(N=function(t){J(r,t);function r(){return t.apply(this,arguments)||this}var o=r.prototype;o.onInit=function e(){this._view=this.base.getView();this._sideEffectsService=i.getAppComponent(this._view).getSideEffectsService();this._registeredFieldGroupMap={};this._fieldGroupInvalidity={};this._registeredFailedSideEffects={}};o.addControlSideEffects=function e(t,i){this._sideEffectsService.addControlSideEffects(t,i)};o.removeControlSideEffects=function e(t){var i;const r=((i=t.isA)===null||i===void 0?void 0:i.call(t,"sap.ui.base.ManagedObject"))&&t.getId();if(r){this._sideEffectsService.removeControlSideEffects(r)}};o.getContextForSideEffects=function e(t,i){let r=t,o=this._sideEffectsService.getEntityTypeFromContext(t);if(i!==o){r=t.getBinding().getContext();if(r){o=this._sideEffectsService.getEntityTypeFromContext(r);if(i!==o){r=r.getBinding().getContext();if(r){o=this._sideEffectsService.getEntityTypeFromContext(r);if(i!==o){return undefined}}}}}return r||undefined};o.getFieldSideEffectsMap=function e(t){let i={};const r=t.getFieldGroupIds(),o=this._view.getViewData().entitySet,s=this._sideEffectsService.getConvertedMetaModel().entitySets.find(e=>e.name===o);i=this.getSideEffectsMapForFieldGroups(r,t.getBindingContext());if(o&&s){const e=s.entityType.fullyQualifiedName,r=this.getTargetProperty(t),o=this.getContextForSideEffects(t.getBindingContext(),e);if(r&&o){const t=this._sideEffectsService.getControlEntitySideEffects(e);Object.keys(t).forEach(s=>{const n=t[s];if(n.sourceProperties.includes(r)){const t=`${s}::${e}`;i[t]={name:t,immediate:true,sideEffects:n,context:o}}})}}return i};o.getSideEffectsMapForFieldGroups=function e(t,i){const r={};t.forEach(e=>{const{name:t,immediate:o,sideEffects:s,sideEffectEntityType:n}=this._getSideEffectsPropertyForFieldGroup(e);const d=i?this.getContextForSideEffects(i,n):undefined;if(s&&(!i||i&&d)){r[t]={name:t,immediate:o,sideEffects:s};if(i){r[t].context=d}}});return r};o.clearFieldGroupsValidity=function e(){this._fieldGroupInvalidity={}};o.isFieldGroupValid=function e(t,i){const r=this._getFieldGroupIndex(t,i);return Object.keys(this._fieldGroupInvalidity[r]??{}).length===0};o.getTargetProperty=function e(t){var i;const r=t.data("sourcePath");const o=this._view.getModel().getMetaModel();const s=(i=this._view.getBindingContext())===null||i===void 0?void 0:i.getPath();const n=s?`${o.getMetaPath(s)}/`:"";return r===null||r===void 0?void 0:r.replace(n,"")};o.handleFieldChange=async function t(i,r,o){const s=i.getSource();this._saveFieldPropertiesStatus(s,r);if(!r){return}const n=this.getFieldSideEffectsMap(s);Object.keys(n).filter(e=>n[e].immediate!==true).forEach(e=>{const t=n[e];this.registerFieldGroupSideEffects(t,o)});try{await(i.getParameter("promise")??Promise.resolve())}catch(t){e.debug("Prerequisites on Field for the SideEffects have been rejected",t);return}return this._manageSideEffectsFromField(s)};o.handleFieldGroupChange=function t(i){const r=i.getSource(),o=i.getParameter("fieldGroupIds"),s=o.reduce((e,t)=>e.concat(this.getRegisteredSideEffectsForFieldGroup(t)),[]);return Promise.all(s.map(e=>this._requestFieldGroupSideEffects(e))).catch(t=>{var i;const o=(i=r.getBindingContext())===null||i===void 0?void 0:i.getPath();e.debug(`Error while processing FieldGroup SideEffects on context ${o}`,t)})};o.requestSideEffects=async function e(t,i,r,o){let s,n;if(o){const e=await o(t);s=e["aTargets"];n=e["TriggerAction"]}else{s=[...t.targetEntities??[],...t.targetProperties??[]];n=t.triggerAction}if(n){this._sideEffectsService.executeAction(n,i,r)}if(s.length){return this._sideEffectsService.requestSideEffects(s,i,r).catch(e=>{this.registerFailedSideEffects(t,i);throw e})}};o.getRegisteredFailedRequests=function e(){return this._registeredFailedSideEffects};o.registerFailedSideEffects=function e(t,i){const r=i.getPath();this._registeredFailedSideEffects[r]=this._registeredFailedSideEffects[r]??[];const o=this._registeredFailedSideEffects[r].every(e=>t.fullyQualifiedName!==e.fullyQualifiedName);if(o){this._registeredFailedSideEffects[r].push(t)}};o.unregisterFailedSideEffectsForAContext=function e(t){delete this._registeredFailedSideEffects[t]};o.unregisterFailedSideEffects=function e(t,i){var r;const o=i.getPath();if((r=this._registeredFailedSideEffects[o])!==null&&r!==void 0&&r.length){this._registeredFailedSideEffects[o]=this._registeredFailedSideEffects[o].filter(e=>e.fullyQualifiedName!==t)}};o.registerFieldGroupSideEffects=function e(t,i){const r=this._getFieldGroupIndex(t.name,t.context);if(!this._registeredFieldGroupMap[r]){this._registeredFieldGroupMap[r]={promise:i??Promise.resolve(),sideEffectProperty:t}}};o.unregisterFieldGroupSideEffects=function e(t){const{context:i,name:r}=t;const o=this._getFieldGroupIndex(r,i);delete this._registeredFieldGroupMap[o]};o.getRegisteredSideEffectsForFieldGroup=function e(t){const i=[];for(const e of Object.keys(this._registeredFieldGroupMap)){if(e.startsWith(`${t}_`)){i.push(this._registeredFieldGroupMap[e])}}return i};o._getFieldGroupIndex=function e(t,i){return`${t}_${i.getPath()}`};o._getSideEffectsPropertyForFieldGroup=function e(t){var i;const r=t.indexOf(Y)!==-1,o=t.replace(Y,""),s=o.split("#"),n=s[0],d=`${n}@com.sap.vocabularies.Common.v1.SideEffects${s.length===2?`#${s[1]}`:""}`,f=(i=this._sideEffectsService.getODataEntitySideEffects(n))===null||i===void 0?void 0:i[d];return{name:o,immediate:r,sideEffects:f,sideEffectEntityType:n}};o._manageSideEffectsFromField=async function t(i){const r=this.getFieldSideEffectsMap(i);try{const e=[];const t=Object.keys(r).filter(e=>r[e].immediate===true).map(e=>{const t=r[e];this.unregisterFailedSideEffects(t.sideEffects.fullyQualifiedName,t.context);return this.requestSideEffects(t.sideEffects,t.context)});for(const t of[i.getBindingContext(),this._view.getBindingContext()]){if(t){const i=t.getPath();const r=this._registeredFailedSideEffects[i]??[];this.unregisterFailedSideEffectsForAContext(i);for(const i of r){e.push(this.requestSideEffects(i,t))}}}await Promise.all(t.concat(e))}catch(t){e.debug(`Error while managing Field SideEffects`,t)}};o._requestFieldGroupSideEffects=async function t(i){this.unregisterFieldGroupSideEffects(i.sideEffectProperty);try{await i.promise}catch(t){e.debug(`Error while processing FieldGroup SideEffects`,t);return}try{const{sideEffects:e,context:t,name:r}=i.sideEffectProperty;if(this.isFieldGroupValid(r,t)){await this.requestSideEffects(e,t)}}catch(t){e.debug(`Error while executing FieldGroup SideEffects`,t)}};o._saveFieldPropertiesStatus=function e(t,i){const r=this.getFieldSideEffectsMap(t);Object.keys(r).forEach(e=>{const{name:o,immediate:s,context:n}=r[e];if(!s){const e=this._getFieldGroupIndex(o,n);if(i){var d;(d=this._fieldGroupInvalidity[e])===null||d===void 0?true:delete d[t.getId()]}else{this._fieldGroupInvalidity[e]={...this._fieldGroupInvalidity[e],...{[t.getId()]:true}}}}})};return r}(t),X(N.prototype,"onInit",[s],Object.getOwnPropertyDescriptor(N.prototype,"onInit"),N.prototype),X(N.prototype,"addControlSideEffects",[n,d],Object.getOwnPropertyDescriptor(N.prototype,"addControlSideEffects"),N.prototype),X(N.prototype,"removeControlSideEffects",[f,c],Object.getOwnPropertyDescriptor(N.prototype,"removeControlSideEffects"),N.prototype),X(N.prototype,"getContextForSideEffects",[p,a],Object.getOwnPropertyDescriptor(N.prototype,"getContextForSideEffects"),N.prototype),X(N.prototype,"getFieldSideEffectsMap",[l,u],Object.getOwnPropertyDescriptor(N.prototype,"getFieldSideEffectsMap"),N.prototype),X(N.prototype,"getSideEffectsMapForFieldGroups",[g,y],Object.getOwnPropertyDescriptor(N.prototype,"getSideEffectsMapForFieldGroups"),N.prototype),X(N.prototype,"clearFieldGroupsValidity",[E,h],Object.getOwnPropertyDescriptor(N.prototype,"clearFieldGroupsValidity"),N.prototype),X(N.prototype,"isFieldGroupValid",[F,S],Object.getOwnPropertyDescriptor(N.prototype,"isFieldGroupValid"),N.prototype),X(N.prototype,"getTargetProperty",[v,m],Object.getOwnPropertyDescriptor(N.prototype,"getTargetProperty"),N.prototype),X(N.prototype,"handleFieldChange",[_,O],Object.getOwnPropertyDescriptor(N.prototype,"handleFieldChange"),N.prototype),X(N.prototype,"handleFieldGroupChange",[G,P],Object.getOwnPropertyDescriptor(N.prototype,"handleFieldGroupChange"),N.prototype),X(N.prototype,"requestSideEffects",[b,x],Object.getOwnPropertyDescriptor(N.prototype,"requestSideEffects"),N.prototype),X(N.prototype,"getRegisteredFailedRequests",[C,w],Object.getOwnPropertyDescriptor(N.prototype,"getRegisteredFailedRequests"),N.prototype),X(N.prototype,"registerFailedSideEffects",[j,M],Object.getOwnPropertyDescriptor(N.prototype,"registerFailedSideEffects"),N.prototype),X(N.prototype,"unregisterFailedSideEffectsForAContext",[D,I],Object.getOwnPropertyDescriptor(N.prototype,"unregisterFailedSideEffectsForAContext"),N.prototype),X(N.prototype,"unregisterFailedSideEffects",[q,T],Object.getOwnPropertyDescriptor(N.prototype,"unregisterFailedSideEffects"),N.prototype),X(N.prototype,"registerFieldGroupSideEffects",[$,R],Object.getOwnPropertyDescriptor(N.prototype,"registerFieldGroupSideEffects"),N.prototype),X(N.prototype,"unregisterFieldGroupSideEffects",[A,V],Object.getOwnPropertyDescriptor(N.prototype,"unregisterFieldGroupSideEffects"),N.prototype),X(N.prototype,"getRegisteredSideEffectsForFieldGroup",[B,k],Object.getOwnPropertyDescriptor(N.prototype,"getRegisteredSideEffectsForFieldGroup"),N.prototype),N))||z);return Z},false);
//# sourceMappingURL=SideEffects.js.map