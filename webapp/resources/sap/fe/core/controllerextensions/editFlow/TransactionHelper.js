/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/ActionRuntime","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/BusyLocker","sap/fe/core/controllerextensions/editFlow/draft","sap/fe/core/controllerextensions/editFlow/operations","sap/fe/core/controllerextensions/editFlow/sticky","sap/fe/core/controllerextensions/messageHandler/messageHandling","sap/fe/core/helpers/DeleteHelper","sap/fe/core/helpers/FPMHelper","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/ResourceModelHelper","sap/fe/core/helpers/StableIdHelper","sap/fe/core/library","sap/m/Button","sap/m/Dialog","sap/m/MessageBox","sap/m/MessageToast","sap/m/Popover","sap/m/Text","sap/m/VBox","sap/ui/core/Core","sap/ui/core/Fragment","sap/ui/core/library","sap/ui/core/util/XMLPreprocessor","sap/ui/core/XMLTemplateProcessor","sap/ui/model/json/JSONModel","../../helpers/MetaModelFunction","../../helpers/ToES6Promise"],function(e,t,n,o,a,r,s,i,c,l,d,u,g,f,p,C,h,m,b,y,E,w,A,D,x,M,P,T,v){"use strict";var O=T.getRequiredPropertiesFromInsertRestrictions;var _=T.getNonComputedVisibleFields;var I=g.generate;var S=u.getResourceModel;const N=f.CreationMode;const R=f.ProgrammingModel;const B=c.DeleteOptionTypes;const k=c.DeleteDialogContentControl;function L(e){if(e&&e.getMetadata&&e.getMetadata().getName()==="sap.ui.base.Event"){e={}}return e||{}}let F=function(){function u(){}var g=u.prototype;g.busyLock=function e(t,n){o.lock(t.getModel("ui"),n)};g.busyUnlock=function e(t,n){o.unlock(t.getModel("ui"),n)};g.getProgrammingModel=function e(t){let n;if(t.isA("sap.ui.model.odata.v4.Context")){n=t.getPath()}else{n=(t.isRelative()?t.getResolvedPath():t.getPath())??""}const o=t.getModel().getMetaModel();if(d.isDraftSupported(o,n)){return R.Draft}else if(d.isStickySessionSupported(o)){return R.Sticky}else{return R.NonDraft}};g.validateDocument=function e(t,n,o){const a=n&&n.customValidationFunction;if(a){const e=a.substring(0,a.lastIndexOf(".")||-1).replace(/\./gi,"/"),r=a.substring(a.lastIndexOf(".")+1,a.length),s=n.data;delete s["@$ui5.context.isTransient"];return l.validationWrapper(e,r,s,o,t)}return Promise.resolve([])};g.createDocument=async function t(n,o,a,s,i){const c=n.getModel(),l=c.getMetaModel(),u=l.getMetaPath(n.getHeaderContext().getPath()),g=a.getRouterProxy().getHash(),p=a.getComponentData(),C=p&&p.startupParameters||{},h=!n.isRelative()?this._getNewAction(C,g,l,u):undefined;const m={$$patchWithoutSideEffects:true};const b=l.getObject(`${u}/@com.sap.vocabularies.Common.v1.Messages/$Path`);let y="/busy";let E=l.getObject(`${u}@com.sap.vocabularies.Common.v1.DefaultValuesFunction`)||l.getObject(`${d.getTargetEntitySet(l.getContext(u))}@com.sap.vocabularies.Common.v1.DefaultValuesFunction`);let A;let D;if(E){if(l.getObject(`${u}@com.sap.vocabularies.Common.v1.DefaultValuesFunction`)&&d.getTargetEntitySet(l.getContext(u))!==u){A=true}else{A=false}}if(b){m["$select"]=b}const x=L(o);if(!n){throw new Error("Binding required for new document creation")}const M=this.getProgrammingModel(n);if(M!==R.Draft&&M!==R.Sticky){throw new Error("Create document only allowed for draft or sticky session supported services")}if(x.busyMode==="Local"){y=`/busyLocal/${x.busyId}`}x.beforeCreateCallBack=i?null:x.beforeCreateCallBack;this.busyLock(a,y);const P=w.getLibraryResourceBundle("sap.fe.core");let T;try{if(h){T=await this.callAction(h,{contexts:n.getHeaderContext(),showActionParameterDialog:true,label:this._getSpecificCreateActionDialogLabel(l,u,h,P),bindingParameters:m,parentControl:x.parentControl,bIsCreateAction:true,skipParameterDialog:x.skipParameterDialog},null,a,s)}else{const t=x.creationMode!==N.CreationRow&&x.creationMode!==N.Inline;const o=t?_(l,u,a):[];E=i?null:E;let d,g;if(E){if(A){d=n.getContext()&&`${l.getMetaPath(n.getContext().getPath())}/${E}`;g=n.getContext()}else{d=n.getHeaderContext()&&`${l.getMetaPath(n.getHeaderContext().getPath())}/${E}`;g=n.getHeaderContext()}}const f=d&&l.createBindingContext(d);try{let t;try{const e=f&&f.getObject()&&f.getObject()[0].$IsBound?await r.callBoundFunction(E,g,c):await r.callFunctionImport(E,c);if(e){t=e.getObject()}}catch(t){e.error(`Error while executing the function ${E}`,t);throw t}x.data=t?Object.assign({},t,x.data):x.data;if(x.data){delete x.data["@odata.context"]}if(o.length>0){T=await this._launchDialogWithKeyFields(n,o,c,x,a,s);D=T.newContext}else{if(x.beforeCreateCallBack){await v(x.beforeCreateCallBack({contextPath:n&&n.getPath()}))}D=n.create(x.data,true,x.createAtEnd,x.inactive);if(!x.inactive){T=await this.onAfterCreateCompletion(n,D,x)}}}catch(t){e.error("Error while creating the new document",t);throw t}}D=D||T;await s.showMessageDialog({control:x.parentControl});return D}catch(e){var O;await s.showMessageDialog({control:x.parentControl});if((e===f.Constants.ActionExecutionFailed||e===f.Constants.CancelActionDialog)&&(O=D)!==null&&O!==void 0&&O.isTransient()){D.delete("$direct")}throw e}finally{this.busyUnlock(a,y)}};g._isDraftEnabled=function e(t){const n=t[0];const o=this.getProgrammingModel(n);return o===R.Draft};g.deleteDocument=function e(t,n,o,a,r){const s=w.getLibraryResourceBundle("sap.fe.core");let l;this.busyLock(o);const d=Array.isArray(t)?[...t]:[t];return new Promise((e,t)=>{try{const u=this._isDraftEnabled(n.selectedContexts||d);const g=[];let f=[];if(n){if(!n.numberOfSelectedContexts){if(u){const e=d.find(e=>{const t=e.getObject();return t.IsActiveEntity===true&&t.HasDraftEntity===true&&t.DraftAdministrativeData&&t.DraftAdministrativeData.InProcessByUser&&!t.DraftAdministrativeData.DraftIsCreatedByMe});if(e){const n=e.getObject().DraftAdministrativeData.InProcessByUser;h.show(a.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_SINGLE_OBJECT_LOCKED",[n]),{title:a.getText("C_COMMON_DELETE"),onClose:t});return}}n=L(n);let e="";if(n.title){if(n.description){l=[n.title+" ",n.description]}else{l=[n.title,""]}e=a.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTINFO",l,n.entitySetName)}else{e=a.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTTITLE_SINGULAR",undefined,n.entitySetName)}f.push({type:B.deletableContexts,contexts:d,text:e,selected:true,control:k.TEXT})}else{let e=d.length;if(u){e+=n.draftsWithNonDeletableActive.length+n.draftsWithDeletableActive.length+n.unSavedContexts.length;c.updateDraftOptionsForDeletableTexts(n,d,e,a,g,f)}else{const t=c.getNonDeletableText(n,e,a);if(t){g.push(t)}}const t=c.getOptionsForDeletableTexts(n,d,a);f=[...f,...t]}}c.updateContentForDeleteDialog(f,g);const m=new E({items:g});const b=s.getText("C_COMMON_DELETE");const y=async()=>{this.busyLock(o);try{await c.deleteConfirmHandler(f,n,r,a,o,u);e()}catch(e){t()}finally{this.busyUnlock(o)}};let w=false;const A=new C({title:b,state:"Warning",content:[m],ariaLabelledBy:g,beginButton:new p({text:s.getText("C_COMMON_DELETE"),type:"Emphasized",press:function(){i.removeBoundTransitionMessages();w=true;A.close();y()}}),endButton:new p({text:a.getText("C_COMMON_DIALOG_CANCEL"),press:function(){A.close()}}),afterClose:function(){A.destroy();if(!w){t()}}});if(n.noDialog){y()}else{A.addStyleClass("sapUiContentPadding");A.open()}}finally{this.busyUnlock(o)}})};g.editDocument=async function e(t,n,o,r){const i=this.getProgrammingModel(t);if(!t){throw new Error("Binding context to active document is required")}if(i!==R.Draft&&i!==R.Sticky){throw new Error("Edit is only allowed for draft or sticky session supported services")}this.busyLock(o);r.removeTransitionMessages();try{const e=i===R.Draft?await a.createDraftFromActiveDocument(t,o,{bPreserveChanges:true,oView:n}):await s.editDocumentInStickySession(t,o);await r.showMessageDialog();return e}catch(e){await r.showMessages({concurrentEditFlag:true});throw e}finally{this.busyUnlock(o)}};g.cancelDocument=async function e(t,n,o,r,i,c,l){if(!t){throw new Error("No context exists. Pass a meaningful context")}this.busyLock(o);const d=L(n);const u=t.getModel();const g=this.getProgrammingModel(t);if(g!==R.Draft&&g!==R.Sticky){throw new Error("Cancel document only allowed for draft or sticky session supported services")}try{let e=false;if(g===R.Draft&&!l){const e=u.bindContext(`${t.getPath()}/DraftAdministrativeData`).getBoundContext();const n=await e.requestObject();if(n){l=n.CreationDateTime!==n.LastChangeDateTime}}if(!d.skipDiscardPopover){await this._confirmDiscard(d.cancelButton,l,r)}if(t.isKeepAlive()){t.setKeepAlive(true,undefined)}if(d.beforeCancelCallBack){await d.beforeCancelCallBack({context:t})}if(g===R.Draft){if(c){if(t.hasPendingChanges()){t.getBinding().resetChanges()}e=await a.deleteDraft(t,o)}else{const n=u.bindContext(`${t.getPath()}/SiblingEntity`).getBoundContext();try{const o=await n.requestCanonicalPath();if(t.hasPendingChanges()){t.getBinding().resetChanges()}e=u.bindContext(o).getBoundContext()}finally{await a.deleteDraft(t,o)}}}else{const n=await s.discardDocument(t);if(n){if(n.hasPendingChanges()){n.getBinding().resetChanges()}if(!c){n.refresh();e=n}}}i.removeTransitionMessages();await i.showMessages();return e}catch(e){await i.showMessages();throw e}finally{this.busyUnlock(o)}};g.saveDocument=async function e(t,o,r,c,l,d,u){const g=this.getProgrammingModel(t);if(g!==R.Sticky&&g!==R.Draft){throw new Error("Save is only allowed for draft or sticky session supported services")}try{this.busyLock(o);const e=g===R.Draft?await a.activateDocument(t,o,{},d):await s.activateDocument(t,o);const n=i.getMessages().concat(i.getMessages(true,true));if(!(n.length===1&&n[0].type===D.MessageType.Success)){m.show(u?r.getText("C_TRANSACTION_HELPER_OBJECT_CREATED"):r.getText("C_TRANSACTION_HELPER_OBJECT_SAVED"))}return e}catch(e){if(c&&(l===null||l===void 0?void 0:l.length)>0){l.forEach(e=>{if(!n.hasTransientContext(e)){o.getSideEffectsService().requestSideEffectsForNavigationProperty(e.getPath(),t)}})}await d.showMessages();throw e}finally{this.busyUnlock(o)}};g.callAction=async function e(t,n,o,a,s){n=L(n);let i,c;const l=n.bindingParameters;if(!t){throw new Error("Provide name of action to be executed")}const d=t.split("/")[1];t=d||t;i=d?undefined:n.contexts;if(i&&(Array.isArray(i)&&i.length||!Array.isArray(i))){i=Array.isArray(i)?i[0]:i;c=i.getModel()}if(n.model){c=n.model}if(!c){throw new Error("Pass a context for a bound action or pass the model for an unbound action")}const u=a.getSideEffectsService().getODataActionSideEffects(t,i)||{};try{let e;if(i&&c){e=await r.callBoundAction(t,n.contexts,c,a,{parameterValues:n.parameterValues,invocationGrouping:n.invocationGrouping,label:n.label,skipParameterDialog:n.skipParameterDialog,mBindingParameters:l,entitySetName:n.entitySetName,additionalSideEffect:u,onSubmitted:()=>{s.removeTransitionMessages();this.busyLock(a)},onResponse:()=>{this.busyUnlock(a)},parentControl:n.parentControl,controlId:n.controlId,internalModelContext:n.internalModelContext,operationAvailableMap:n.operationAvailableMap,bIsCreateAction:n.bIsCreateAction,bGetBoundContext:n.bGetBoundContext,bObjectPage:n.bObjectPage,messageHandler:s,defaultValuesExtensionFunction:n.defaultValuesExtensionFunction,selectedItems:n.contexts})}else{e=await r.callActionImport(t,c,a,{parameterValues:n.parameterValues,label:n.label,skipParameterDialog:n.skipParameterDialog,bindingParameters:l,entitySetName:n.entitySetName,onSubmitted:()=>{this.busyLock(a)},onResponse:()=>{this.busyUnlock(a)},parentControl:n.parentControl,internalModelContext:n.internalModelContext,operationAvailableMap:n.operationAvailableMap,messageHandler:s,bObjectPage:n.bObjectPage})}await this._handleActionResponse(s,n,t);return e}catch(e){await this._handleActionResponse(s,n,t);throw e}};g._handleActionResponse=function e(t,n,o){const a=i.getMessages(true,true);const r=n.label?n.label:o;if(a.length>0&&n&&n.internalModelContext){n.internalModelContext.setProperty("sActionName",n.label?n.label:o)}let s;if(n.controlId){s=n.parentControl.byId(n.controlId)}else{s=n.parentControl}return t.showMessages({sActionName:r,control:s})};g.handleValidationError=function e(){const t=w.getMessageManager(),n=t.getMessageModel().getData().filter(function(e){if(e.validation){return e}});t.removeMessages(n)};g._createPopover=function e(t){return new b(t)};g._confirmDiscard=function e(t,n,o){if(!n){this.handleValidationError();return Promise.resolve()}t.setEnabled(false);return new Promise((e,n)=>{const a=this._createPopover({showHeader:false,placement:"Top"});a.addStyleClass("sapUiContentPadding");const r=new y({text:o.getText("C_TRANSACTION_HELPER_DRAFT_DISCARD_MESSAGE")});const s=new p({text:o.getText("C_TRANSACTION_HELPER_DRAFT_DISCARD_BUTTON"),width:"100%",press:()=>{this.handleValidationError();a.data("continueDiscard",true);a.close()},ariaLabelledBy:[r]});a.addContent(new E({items:[r,s]}));a.attachBeforeOpen(()=>{a.setInitialFocus(s)});a.attachAfterClose(()=>{t.setEnabled(true);if(a.data("continueDiscard")){e()}else{n()}});a.openBy(t,false)})};g._launchDialogWithKeyFields=function e(a,r,s,i,c,l){let d;const u=i.parentControl;const g=s.bindList(a.getPath(),a.getContext(),[],[],{$$updateGroupId:"submitLater"});g.refreshInternal=function(){};const p=g.create(i.data,true);return new Promise(async(e,h)=>{const m="sap/fe/core/controls/NonComputedVisibleKeyFieldsDialog";const b=M.loadTemplate(m,"fragment"),y=S(u),E=s.getMetaModel(),D=[],T=a.isRelative()?a.getResolvedPath():a.getPath(),_=E.createBindingContext(T),N=E.getMetaPath(T);for(const e in r){D.push(E.createBindingContext(`${N}/${r[e]}`))}const R=new P(D);const B=R.createBindingContext("/");const k=O(N,E);const L=new P(k);const F=L.createBindingContext("/");const H=await x.process(b,{name:m},{bindingContexts:{entitySet:_,fields:B,requiredProperties:F},models:{entitySet:_.getModel(),fields:B.getModel(),metaModel:E,requiredProperties:L}});let $=[];const U={};const j=w.getMessageManager();const V=e=>{const t=j.getMessageModel().getData();const n=t.filter(t=>t.getControlIds().some(t=>t.includes(e)));j.removeMessages(n)};const W={handleChange:async e=>{const t=e.getParameter("id");const n=e.getSource();const o=J.find(e=>e.field===n);V(t);o.validationPromise=e.getParameter("promise");try{o.value=await o.validationPromise;o.hasError=false}catch(e){delete o.value;o.hasError=true}},handleLiveChange:e=>{const t=e.getParameter("id");V(t)}};const G=await A.load({definition:H,controller:W});let q;const K=function(){if(q.error){h(q.error)}else{e(q.response)}d.close()};d=new C(I(["CreateDialog",N]),{title:y.getText("C_TRANSACTION_HELPER_SAPFE_ACTION_CREATE"),content:[G],beginButton:{text:y.getText("C_TRANSACTION_HELPER_SAPFE_ACTION_CREATE_BUTTON"),type:"Emphasized",press:async e=>{if(!await t.validateProperties(j,J,y)){return}o.lock(d);i.bIsCreateDialog=true;try{const e=await Promise.all(Object.keys(U).map(async function(e){const t=await U[e];const n={};n[e]=t;return n}));if(i.beforeCreateCallBack){await v(i.beforeCreateCallBack({contextPath:a&&a.getPath(),createParameters:e}))}const t=p.getObject();const n={};Object.keys(t).forEach(function(e){const o=E.getObject(`${N}/${e}`);if(o&&o.$kind==="NavigationProperty"){return}n[e]=t[e]});const o=a.create(n,true,i.createAtEnd,i.inactive);const r=this.onAfterCreateCompletion(a,o,i);let s=await r;if(!s||s&&s.bKeepDialogOpen!==true){s=s??{};d.setBindingContext(null);s.newContext=o;q={response:s};K()}}catch(e){if(e!==f.Constants.CreationFailed){q={error:e};K()}}finally{o.unlock(d);l.showMessages()}}},endButton:{text:y.getText("C_COMMON_ACTION_PARAMETER_DIALOG_CANCEL"),press:function(){q={error:f.Constants.CancelActionDialog};K()}},afterClose:function(){var e;for(const e of J){const t=e.field.getId();V(t)}(e=d.getBindingContext("internal"))===null||e===void 0?void 0:e.setProperty("isCreateDialogOpen",false);d.destroy();g.destroy()}});$=G===null||G===void 0?void 0:G.getAggregation("form").getAggregation("formContainers")[0].getAggregation("formElements");const J=$.map(e=>{const t=e.getFields()[0];const n=t.isA("sap.ui.mdc.MultiValueField");return{parameter:e,isMultiValue:n,field:t,value:n?t.getItems():t.getValue(),validationPromise:undefined,hasError:false}});if(u&&u.addDependent){u.addDependent(d)}d.setBindingContext(p);try{await n.setUserDefaults(c,D,p,false,i.createAction,i.data);d.getBindingContext("internal").setProperty("isCreateDialogOpen",true);d.open()}catch(e){await l.showMessages();throw e}})};g.onAfterCreateCompletion=function t(n,o,a){let r;const s=new Promise(e=>{r=e});const i=e=>{const t=e.getParameter("context"),a=e.getParameter("success");if(t===o){n.detachCreateCompleted(i,this);r(a)}};const c=()=>{o.created().then(undefined,function(){e.trace("transient creation context deleted")}).catch(function(t){e.trace("transient creation context deletion error",t)})};n.attachCreateCompleted(i,this);return s.then(e=>{if(!e){if(!a.keepTransientContextOnFailed){c();n.resetChanges();n.getModel().resetChanges(n.getUpdateGroupId());throw f.Constants.CreationFailed}return{bKeepDialogOpen:true}}else{return o.created()}})};g._getNewAction=function e(t,n,o,a){let r;if(t&&t.preferredMode&&n.toUpperCase().indexOf("I-ACTION=CREATEWITH")>-1){const e=t.preferredMode[0];r=e.toUpperCase().indexOf("CREATEWITH:")>-1?e.substr(e.lastIndexOf(":")+1):undefined}else if(t&&t.preferredMode&&n.toUpperCase().indexOf("I-ACTION=AUTOCREATEWITH")>-1){const e=t.preferredMode[0];r=e.toUpperCase().indexOf("AUTOCREATEWITH:")>-1?e.substr(e.lastIndexOf(":")+1):undefined}else{r=o&&o.getObject!==undefined?o.getObject(`${a}@com.sap.vocabularies.Session.v1.StickySessionSupported/NewAction`)||o.getObject(`${a}@com.sap.vocabularies.Common.v1.DraftRoot/NewAction`):undefined}return r};g._getSpecificCreateActionDialogLabel=function e(t,n,o,a){const r=function(){if(t&&t.getObject(`${n}/@com.sap.vocabularies.UI.v1.LineItem`)){const e=t.getObject(`${n}/@com.sap.vocabularies.UI.v1.LineItem`).findIndex(function(e){const t=e.Action?e.Action.split("("):undefined;return t?t[0]===o:false});return e>-1?t.getObject(`${n}/@com.sap.vocabularies.UI.v1.LineItem`)[e].Label:undefined}else{return undefined}};return r()||t&&t.getObject(`${n}/${o}@com.sap.vocabularies.Common.v1.Label`)||a&&a.getText("C_TRANSACTION_HELPER_SAPFE_ACTION_CREATE")};return u}();const H=new F;return H},false);
//# sourceMappingURL=TransactionHelper.js.map