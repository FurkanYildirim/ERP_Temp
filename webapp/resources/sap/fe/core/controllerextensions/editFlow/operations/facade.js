/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/ActionRuntime","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/BusyLocker","sap/fe/core/controllerextensions/messageHandler/messageHandling","sap/fe/core/helpers/FPMHelper","sap/fe/core/helpers/ResourceModelHelper","sap/fe/core/helpers/StableIdHelper","sap/fe/core/library","sap/m/Button","sap/m/Dialog","sap/m/MessageBox","sap/ui/core/Core","sap/ui/core/Fragment","sap/ui/core/library","sap/ui/core/message/Message","sap/ui/core/util/XMLPreprocessor","sap/ui/core/XMLTemplateProcessor","sap/ui/model/json/JSONModel","../../../operationsHelper","./_internal"],function(e,t,n,s,i,o,a,r,l,c,u,d,g,f,m,p,h,M,E,P,C){"use strict";var x=C._validateProperties;var b=C._addMessageForActionParameter;var v=m.MessageType;var A=r.generate;var O=a.getResourceModel;const S=l.Constants,$=l.InvocationGrouping;const y=d.Action;function T(e,t,n,s,i,o){if(!o){o={is412Executed:false,strictHandlingTransitionFails:[],strictHandlingPromises:[],strictHandlingWarningMessages:[],delaySuccessMessages:[],processedMessageIds:[]}}if(!t||t.length===0){return Promise.reject("Bound actions always requires at least one context")}const a=Array.isArray(t);i.aContexts=a?t:[t];const r=n.getMetaModel(),l=`${r.getMetaPath(i.aContexts[0].getPath())}/${e}`,c=r.createBindingContext(`${l}/@$ui5.overload/0`);i.isCriticalAction=L(r,l,i.aContexts,c);const u=function(e){if(e[0].status==="fulfilled"){return e[0].value}else{throw e[0].reason||e}};return B(e,n,c,s,i,o).then(e=>{if(a){return e}else{return u(e)}},e=>{if(a){throw e}else{return u(e)}})}function _(e,t,n,s,i){if(!t){return Promise.reject("Action expects a model/context for execution")}const o=t.getMetaModel(),a=t.bindContext(`/${e}`).getPath(),r=o.createBindingContext(`/${o.createBindingContext(a).getObject("$Action")}/0`);s.isCriticalAction=L(o,`${a}/@$ui5.overload`);return B(e,t,r,n,s,i)}function N(e,t,n){if(!t){return Promise.reject("Bound functions always requires a context")}const s=n.getMetaModel(),i=`${s.getMetaPath(t.getPath())}/${e}`,o=s.createBindingContext(i);return I(e,n,o,t)}function w(e,t){if(!e){return Promise.resolve()}const n=t.getMetaModel(),s=t.bindContext(`/${e}`).getPath(),i=n.createBindingContext(`/${n.createBindingContext(s).getObject("$Function")}/0`);return I(e,t,i)}function I(e,t,n,s){let i;if(!n||!n.getObject()){return Promise.reject(new Error(`Function ${e} not found`))}if(s){n=t.bindContext(`${s.getPath()}/${e}(...)`);i="functionGroup"}else{n=t.bindContext(`/${e}(...)`);i="functionImport"}const o=n.execute(i);t.submitBatch(i);return o.then(function(){return n.getBoundContext()})}function B(e,t,n,s,i,o){if(!o){o={is412Executed:false,strictHandlingTransitionFails:[],strictHandlingPromises:[],strictHandlingWarningMessages:[],delaySuccessMessages:[],processedMessageIds:[]}}i.bGrouped=i.invocationGrouping===$.ChangeSet;return new Promise(async function(a,r){let l={};let c;let u;const d=i.label;const f=i.skipParameterDialog;const m=i.aContexts;const p=i.bIsCreateAction;const h=i.isCriticalAction;let M;let E;let P;let C;let x;let b;let v;const A=n.getObject();if(!n||!n.getObject()){return r(new Error(`Action ${e} not found`))}const O=F(n);const S=O.length>0&&!(O.length===1&&O[0].$Name==="ResultIsActiveEntity");const y=i.parameterValues;const T=s.getComponentData();const _=T&&T.startupParameters||{};if(S&&f){v=J(p,O,y,_)}c=null;if(S){if(!(f&&v)){c=j}}else if(h){c=D}l={fnOnSubmitted:i.onSubmitted,fnOnResponse:i.onResponse,actionName:e,model:t,aActionParameters:O,bGetBoundContext:i.bGetBoundContext,defaultValuesExtensionFunction:i.defaultValuesExtensionFunction,label:i.label,selectedItems:i.selectedItems};if(n.getObject("$IsBound")){if(i.additionalSideEffect&&i.additionalSideEffect.pathExpressions){M=t.getMetaModel();E=M.getMetaPath(m[0].getPath());P=M.getObject(`${E}/@com.sap.vocabularies.Common.v1.Messages/$Path`);if(P){C=i.additionalSideEffect.pathExpressions.findIndex(function(e){return typeof e==="string"&&e===P});b=n.getObject("$ReturnType");x=b&&!b.$isCollection&&n.getModel().getObject(E).$Type===b.$Type;if(C>-1||x){i.mBindingParameters=i.mBindingParameters||{};if(n.getObject(`$ReturnType/$Type/${P}`)&&(!i.mBindingParameters.$select||i.mBindingParameters.$select.split(",").indexOf(P)===-1)){i.mBindingParameters.$select=i.mBindingParameters.$select?`${i.mBindingParameters.$select},${P}`:P;if(C===-1){i.additionalSideEffect.pathExpressions.push("*")}if(i.additionalSideEffect.triggerActions.length===0&&C>-1){i.additionalSideEffect.pathExpressions.splice(C,1)}}}}}l.aContexts=m;l.mBindingParameters=i.mBindingParameters;l.additionalSideEffect=i.additionalSideEffect;l.bGrouped=i.invocationGrouping===$.ChangeSet;l.internalModelContext=i.internalModelContext;l.operationAvailableMap=i.operationAvailableMap;l.isCreateAction=p;l.bObjectPage=i.bObjectPage;if(i.controlId){l.control=i.parentControl.byId(i.controlId);i.control=l.control}else{l.control=i.parentControl;i.control=i.parentControl}}if(p){l.bIsCreateAction=p}const N=(A.$Parameter||[]).some(e=>(A.$EntitySetPath&&A.$EntitySetPath===e.$Name||A.$IsBound)&&e.$isCollection);l.isStatic=N;if(c){u=c(e,s,d,l,O,y,n,i.parentControl,i.entitySetName,i.messageHandler,o);return u.then(function(e){G(i,l,A);a(e)}).catch(function(e){r(e)})}else{if(y){for(const e in l.aActionParameters){var w;l.aActionParameters[e].value=y===null||y===void 0?void 0:(w=y.find(t=>t.name===l.aActionParameters[e].$Name))===null||w===void 0?void 0:w.value}}else{for(const e in l.aActionParameters){var I;l.aActionParameters[e].value=(I=_[l.aActionParameters[e].$Name])===null||I===void 0?void 0:I[0]}}let e;try{e=await X(s,l,i.parentControl,i.messageHandler,o);const t=g.getMessageManager().getMessageModel().getData();if(o&&o.is412Executed&&o.strictHandlingTransitionFails.length){o.delaySuccessMessages=o.delaySuccessMessages.concat(t)}G(i,l,A);a(e)}catch{r(e)}finally{var B,R;if(o&&o.is412Executed&&o.strictHandlingTransitionFails.length){try{const e=o.strictHandlingTransitionFails;const t=[];e.forEach(function(e){t.push(e.oAction.getContext())});l.aContexts=t;const n=await X(s,l,i.parentControl,i.messageHandler,o);o.strictHandlingTransitionFails=[];g.getMessageManager().addMessages(o.delaySuccessMessages);G(i,l,A);a(n)}catch(e){r(e)}}let e=false;if(i.bGrouped&&o&&o.strictHandlingPromises.length||U(i.bGrouped)!==-1){e=true}i===null||i===void 0?void 0:(B=i.messageHandler)===null||B===void 0?void 0:B.showMessageDialog({control:(R=l)===null||R===void 0?void 0:R.control,onBeforeShowMessage:function(t,n){return H(i,m,undefined,t,n,e)},aSelectedContexts:i.aContexts,sActionName:d});if(o){o={is412Executed:false,strictHandlingTransitionFails:[],strictHandlingPromises:[],strictHandlingWarningMessages:[],delaySuccessMessages:[],processedMessageIds:[]}}}}})}function D(e,t,n,s,i,o,a,r,l,c){return new Promise((n,i)=>{let o=e?e:null;o=o.indexOf(".")>=0?o.split(".")[o.split(".").length-1]:o;const a=o&&l?`${l}|${o}`:"";const u=O(r);const g=u.getText("C_OPERATIONS_ACTION_CONFIRM_MESSAGE",undefined,a);d.confirm(g,{onClose:async function(e){if(e===y.OK){try{const e=await X(t,s,r,c);n(e)}catch(e){try{await c.showMessageDialog();i(e)}catch(t){i(e)}}}else{n(S.CancelActionDialog)}}})})}async function R(e,t,n,s,i,o,a,r){var l;const c=await X(e,t,n,s,r);if((l=t.aContexts)!==null&&l!==void 0&&l.length){if(c!==null&&c!==void 0&&c.some(e=>e.status==="rejected")){throw c}}const u=g.getMessageManager().getMessageModel().getData();if(r&&r.is412Executed&&r.strictHandlingTransitionFails.length){if(!a){r.delaySuccessMessages=r.delaySuccessMessages.concat(u)}else{g.getMessageManager().addMessages(r.delaySuccessMessages);let e=false;if(t.bGrouped&&r.strictHandlingPromises.length||U(t.bGrouped)!==-1){e=true}if(u.length){o.attachEventOnce("afterClose",function(){s.showMessageDialog({onBeforeShowMessage:function(n,s){return H(t,i,o,n,s,e)},control:t.control,aSelectedContexts:t.aContexts,sActionName:t.label})})}}}else if(u.length){let e=false;if(t.bGrouped&&r&&r.strictHandlingPromises.length||U(t.bGrouped)!==-1){e=true}o.attachEventOnce("afterClose",function(){s.showMessageDialog({isActionParameterDialogOpen:t===null||t===void 0?void 0:t.oDialog.isOpen(),onBeforeShowMessage:function(n,s){return H(t,i,o,n,s,e)},control:t.control,aSelectedContexts:t.aContexts,sActionName:t.label})})}return c}function G(e,n,s){if(n.internalModelContext&&n.operationAvailableMap&&n.aContexts&&n.aContexts.length&&s.$IsBound){const s=n.isStatic;if(!s){t.setActionEnablement(n.internalModelContext,JSON.parse(n.operationAvailableMap),e.selectedItems,"table")}else if(n.control){const e=n.control;if(e.isA("sap.ui.mdc.Table")){const s=e.getSelectedContexts();t.setActionEnablement(n.internalModelContext,JSON.parse(n.operationAvailableMap),s,"table")}}}}function H(e,t,n,s,o,a){let r=o.showMessageBox,l=o.showMessageDialog;const c=e.control;const u=g.getLibraryResourceBundle("sap.fe.core");const d=s.filter(function(e){return e.getTarget()===""});const f=s.filter(function(t){var n;return t.getTarget&&t.getTarget().indexOf(e.actionName)!==-1&&(e===null||e===void 0?void 0:(n=e.aActionParameters)===null||n===void 0?void 0:n.some(function(e){return t.getTarget().indexOf(e.$Name)!==-1}))});f===null||f===void 0?void 0:f.forEach(function(e){e.isAPDTarget=true});const m=f.length?true:false;let h=false;if(a&&!m){h=true;let e=u.getText("C_COMMON_DIALOG_CANCEL_ERROR_MESSAGES_TEXT");let t=u.getText("C_COMMON_DIALOG_CANCEL_ERROR_MESSAGES_DETAIL_TEXT");const n=g.getMessageManager().getMessageModel();const o=n.getData();const a=i.getMessages(true);let d;const f=c&&c.getModel("ui").getProperty("/isEditable");const m=s.findIndex(function(e){return e.getType()==="Error"||e.getType()==="Warning"});const M=o.findIndex(function(e){return e.getType()==="Error"||e.getType()==="Warning"});if(m!==1&&M!==-1){if(o.length===1&&a.length===1){if(f===false){o[0].setMessage(u.getText("C_COMMON_DIALOG_CANCEL_SINGLE_ERROR_MESSAGE_TEXT")+"\n\n"+o[0].getMessage())}else{e=f?u.getText("C_COMMON_DIALOG_CANCEL_SINGLE_ERROR_MESSAGE_TEXT_EDIT"):u.getText("C_COMMON_DIALOG_CANCEL_SINGLE_ERROR_MESSAGE_TEXT");t="";d=new p({message:e,type:v.Error,target:"",persistent:true,description:t,code:"FE_CUSTOM_MESSAGE_CHANGESET_ALL_FAILED"});s.unshift(d);if(s.length===1){r=true;l=false}else{l=true;r=false}}}else{d=new p({message:e,type:v.Error,target:"",persistent:true,description:t,code:"FE_CUSTOM_MESSAGE_CHANGESET_ALL_FAILED"});s.unshift(d);if(s.length===1){r=true;l=false}else{l=true;r=false}}}}if(n&&n.isOpen()&&t.length!==0&&!e.isStatic){if(!e.bGrouped){if(t.length>1||!m){n.close();n.destroy()}}else if(!m){n.close();n.destroy()}}let M=[];const E=n&&n.isOpen();if(!h){if(s.length===1&&s[0].getTarget&&s[0].getTarget()!==undefined&&s[0].getTarget()!==""){if(c&&c.getModel("ui").getProperty("/isEditable")===false||!c){r=!m;l=false}else if(c&&c.getModel("ui").getProperty("/isEditable")===true){r=false;l=false}}else if(c){if(c.getModel("ui").getProperty("/isEditable")===false){if(E&&m){l=false}}else if(c.getModel("ui").getProperty("/isEditable")===true){if(!E&&m){l=true;M=d.concat(f)}else if(!E&&d.length===0){l=false}}}}return{showMessageBox:r,showMessageDialog:l,filteredMessages:M.length?M:s,fnGetMessageSubtitle:c&&c.isA("sap.ui.mdc.Table")&&i.setMessageSubtitle.bind({},c,t),showChangeSetErrorDialog:e.bGrouped}}function j(t,i,a,r,l,m,p,P,C,v,$){const y=K(p,t),T=p.getModel().oModel.getMetaModel(),_=T.createBindingContext(y),w=p.getObject("$IsBound")?p.getPath().split("/@$ui5.overload/0")[0]:p.getPath().split("/0")[0],I=T.createBindingContext(w),B=r.isCreateAction,D="sap/fe/core/controls/ActionParameterDialog";return new Promise(async function(y,T){let w;const G=g.getMessageManager();const j=e=>{const t=G.getMessageModel().getData();const n=A(["APD_",e.$Name]);const s=t.filter(e=>e.getControlIds().some(e=>n.split("-").includes(e)));G.removeMessages(s)};const F={handleChange:async function(e){const t=e.getSource();const n=w.find(e=>e.field===t);j(n.parameter);n.validationPromise=e.getParameter("promise");try{n.value=await n.validationPromise;n.hasError=false}catch(e){delete n.value;n.hasError=true;b(G,[{actionParameterInfo:n,message:e.message}])}}};const L=M.loadTemplate(D,"fragment");const V=new E({$displayMode:{}});try{const M=await h.process(L,{name:D},{bindingContexts:{action:p,actionName:I,entitySet:_},models:{action:p.getModel(),actionName:I.getModel(),entitySet:_.getModel(),metaModel:_.getModel()}});const b=r.aContexts||[];const J=[];let z;await n.setUserDefaults(i,l,V,true);const Y=await f.load({definition:M,controller:F});w=l.map(e=>{const t=g.byId(A(["APD_",e.$Name]));const n=t.isA("sap.ui.mdc.MultiValueField");return{parameter:e,field:t,isMultiValue:n}});const Q=O(P);let Z={dialogCancelled:true,result:undefined};const ee=new u(A(["fe","APD_",t]),{title:a||Q.getText("C_OPERATIONS_ACTION_PARAMETER_DIALOG_TITLE"),content:[Y],escapeHandler:function(){ee.close()},beginButton:new c(A(["fe","APD_",t,"Action","Ok"]),{text:B?Q.getText("C_TRANSACTION_HELPER_SAPFE_ACTION_CREATE_BUTTON"):k(Q,a,t,C),type:"Emphasized",press:async function(){try{if(!await x(G,w,Q)){return}s.lock(ee);try{v.removeTransitionMessages();let e;const t=z&&z.getParameterContext();for(const n in l){if(l[n].$isCollection){const t=ee.getModel("mvfview").getProperty(`/${l[n].$Name}`),s=[];for(const e in t){s.push(t[e].Key)}e=s}else{e=t.getProperty(l[n].$Name)}l[n].value=e;e=undefined}r.label=a;try{const e=await R(i,r,P,v,b,ee,false,$);Z={dialogCancelled:false,result:e};ee.close()}catch(e){const t=sap.ui.getCore().getMessageManager().getMessageModel().getData();if($&&$.is412Executed&&$.strictHandlingTransitionFails.length){$.delaySuccessMessages=$.delaySuccessMessages.concat(t)}throw e}finally{if($&&$.is412Executed&&$.strictHandlingTransitionFails.length){try{const e=$.strictHandlingTransitionFails;const t=[];e.forEach(function(e){t.push(e.oAction.getContext())});r.aContexts=t;const n=await R(i,r,P,v,b,ee,true,$);$.strictHandlingTransitionFails=[];Z={dialogCancelled:false,result:n}}catch{if($.is412Executed&&$.strictHandlingTransitionFails.length){g.getMessageManager().addMessages($.delaySuccessMessages)}let e=false;if(r.bGrouped&&$.strictHandlingPromises.length||U(r.bGrouped)!==-1){e=true}await v.showMessageDialog({isActionParameterDialogOpen:ee.isOpen(),onBeforeShowMessage:function(t,n){return H(r,b,ee,t,n,e)},aSelectedContexts:r.aContexts,sActionName:a})}}if(s.isLocked(ee)){s.unlock(ee)}}}catch(e){let t=true;let n=false;if(r.bGrouped&&$&&$.strictHandlingPromises.length||U(r.bGrouped)!==-1){n=true}await v.showMessages({context:r.aContexts[0],isActionParameterDialogOpen:ee.isOpen(),messagePageNavigationCallback:function(){ee.close()},onBeforeShowMessage:function(e,s){const i=H(r,b,ee,e,s,n);t=i.showMessageDialog;return i},aSelectedContexts:r.aContexts,sActionName:a,control:r.control});if(t){if(ee.isOpen()){}else{T(e)}}}}finally{if($){$={is412Executed:false,strictHandlingTransitionFails:[],strictHandlingPromises:[],strictHandlingWarningMessages:[],delaySuccessMessages:[],processedMessageIds:[]}}if(s.isLocked(ee)){s.unlock(ee)}}}}),endButton:new c(A(["fe","APD_",t,"Action","Cancel"]),{text:Q.getText("C_COMMON_ACTION_PARAMETER_DIALOG_CANCEL"),press:function(){ee.close()}}),beforeOpen:async function(t){const s=Object.assign({},t);v.removeTransitionMessages();const i=function(){const e=ee.getModel().getMetaModel(),t=p.sPath&&p.sPath.split("/@")[0],n=e.getObject(`${t}@com.sap.vocabularies.Common.v1.DefaultValuesFunction`);return n};const a=async function(t){const a=i();const c=async function(s,i){if(i!==undefined){if(b.length>0&&i.$Path){try{let e=await n.requestSingletonProperty(i.$Path,z.getModel());if(e===null){e=await z.getParameterContext().requestProperty(i.$Path)}if(b.length>1){let n=i.$Path;if(n.indexOf(`${t}/`)===0){n=n.replace(`${t}/`,"")}for(let t=1;t<b.length;t++){if(b[t].getProperty(n)!==e){return{paramName:s,value:undefined,bNoPossibleValue:true}}}}return{paramName:s,value:e}}catch(t){e.error("Error while reading default action parameter",s,r.actionName);return{paramName:s,value:undefined,bLatePropertyError:true}}}else{return{paramName:s,value:i}}}else if(V&&V.oData[s]){return{paramName:s,value:V.oData[s]}}else{return{paramName:s,value:undefined}}};const u=function(e){const t=ee.getModel().getMetaModel(),s=n.getParameterPath(p.getPath(),e)+"@",i=t.getObject(s),o=i&&i["@com.sap.vocabularies.UI.v1.ParameterDefaultValue"];return o};const g=[];let f,h;for(const e in l){f=l[e].$Name;h=u(f);g.push(c(f,h))}if(p.getObject("$IsBound")&&b.length>0){if(a&&a.length>0&&typeof a==="string"){for(const e in b){J.push(N(a,b[e],r.model))}}}const M=Promise.all(g);let E=Promise.resolve([]);let P;if(J&&J.length>0){E=Promise.all(J)}if(r.defaultValuesExtensionFunction){const e=r.defaultValuesExtensionFunction.substring(0,r.defaultValuesExtensionFunction.lastIndexOf(".")||-1).replace(/\./gi,"/"),t=r.defaultValuesExtensionFunction.substring(r.defaultValuesExtensionFunction.lastIndexOf(".")+1,r.defaultValuesExtensionFunction.length);P=o.actionWrapper(s,e,t,{contexts:b})}try{const e=await Promise.all([M,E,P]);const t=e[0];const n=e[1];const s=e[2];let i;for(const e in l){var C;i=l[e].$Name;const o=m===null||m===void 0?void 0:(C=m.find(t=>t.name===l[e].$Name))===null||C===void 0?void 0:C.value;if(o){z.setParameter(l[e].$Name,o)}else if(s&&s.hasOwnProperty(i)){z.setParameter(l[e].$Name,s[i])}else if(t[e]&&t[e].value!==undefined){z.setParameter(l[e].$Name,t[e].value)}else if(a&&!t[e].bNoPossibleValue){if(b.length>1){let t=0;while(t<b.length-1){if(n[t]&&n[t+1]&&n[t].getObject(i)===n[t+1].getObject(i)){t++}else{break}}if(t===b.length-1){z.setParameter(l[e].$Name,n[t].getObject(i))}}else if(n[0]&&n[0].getObject(i)){z.setParameter(l[e].$Name,n[0].getObject(i))}}}const o=t.some(function(e){if(e.bLatePropertyError){return e.bLatePropertyError}});if(o){const e=Q.getText("C_APP_COMPONENT_SAPFE_ETAG_LATE_PROPERTY");d.warning(e,{contentWidth:"25em"})}}catch(t){e.error("Error while retrieving the parameter",t)}};const c=async function(){if(p.getObject("$IsBound")&&b.length>0){const t=p.getObject("$Parameter");const n=t[0]&&t[0].$Name;try{const e=await b[0].requestObject();if(e){z.setParameter(n,e)}await a(n)}catch(t){e.error("Error while retrieving the parameter",t)}}else{await a()}};await c();for(const e of w){const t=e.isMultiValue?e.field.getItems():e.field.getValue();e.value=t;e.validationPromise=Promise.resolve(t)}},afterClose:function(){l.forEach(j);ee.destroy();if(Z.dialogCancelled){T(S.CancelActionDialog)}else{y(Z.result)}}});r.oDialog=ee;ee.setModel(p.getModel().oModel);ee.setModel(V,"paramsModel");ee.bindElement({path:"/",model:"paramsModel"});const te=new E({});ee.setModel(te,"mvfview");for(const e of w){if(e.isMultiValue){var W,q;e===null||e===void 0?void 0:(W=e.field)===null||W===void 0?void 0:(q=W.getBinding("items"))===null||q===void 0?void 0:q.attachChange(()=>{j(e.parameter)})}else{var X,K;e===null||e===void 0?void 0:(X=e.field)===null||X===void 0?void 0:(K=X.getBinding("value"))===null||K===void 0?void 0:K.attachChange(()=>{j(e.parameter)})}}let ne=`${t}(...)`;if(!b.length){ne=`/${ne}`}ee.bindElement({path:ne});if(P){P.addDependent(ee)}if(b.length>0){ee.setBindingContext(b[0])}z=ee.getObjectBinding();ee.open()}catch(e){T(e)}})}function F(e){const t=e.getObject("$Parameter")||[];if(t&&t.length){if(e.getObject("$IsBound")){return t.slice(1,t.length)||[]}}return t}function L(e,t,n,s){const i=e.getObject(`${t}@com.sap.vocabularies.Common.v1.IsActionCritical`);let o=i&&i.$Path;if(!o){return!!i}const a=s&&s.getObject("$Parameter"),r=o&&o.split("/"),l=a&&a.length&&typeof a==="object"&&o&&n&&n.length;if(l){a.filter(function(e){const t=r&&r.indexOf(e.$Name);if(t>-1){r.splice(t,1)}});o=r.join("/");return n[0].getObject(o)}else if(o){return n[0].getObject(o)}}function k(e,t,n,s){let i=n?n:null;const o=i.split(".");i=i.indexOf(".")>=0?o[o.length-1]:i;const a=i&&s?`${s}|${i}`:"";const r="ACTION_PARAMETER_DIALOG_ACTION_NAME";const l=e.checkIfResourceKeyExists(`${r}|${a}`);if(t){if(l){return e.getText(r,undefined,a)}else if(e.checkIfResourceKeyExists(`${r}|${s}`)){return e.getText(r,undefined,`${s}`)}else if(e.checkIfResourceKeyExists(`${r}`)){return e.getText(r)}else{return t}}else{return e.getText("C_COMMON_DIALOG_OK")}}function V(e,t,n,s,i,o,a,r,l,c,u){let d,g=true;if(t){t.internalOperationsPromiseResolve=l}if(n){var f;const t=e.getBoundContext().getPath();const n=e.getModel().getMetaModel().getMetaPath(t);const s=e.getModel().getMetaModel().getObject(n);if(s&&((f=s[0])===null||f===void 0?void 0:f.$kind)!=="Action"){g=false}}if(!g){d=e.execute(s).then(function(){l(e.getBoundContext());return e.getBoundContext()})}else{d=n?e.execute(s,undefined,P.fnOnStrictHandlingFailed.bind(Y,s,t,i,r,e.getContext(),a,o,u)).then(function(){if(u&&!t.bGrouped){W(e,s,u,t)}l(e.getBoundContext());return e.getBoundContext()}).catch(function(){if(u&&!t.bGrouped){W(e,s,u,t)}c();return Promise.reject()}):e.execute(s,undefined,P.fnOnStrictHandlingFailed.bind(Y,s,t,i,r,e.getContext(),a,o,u)).then(function(n){if(u&&!t.bGrouped){W(e,s,u,t)}l(n);return n}).catch(function(){if(u&&!t.bGrouped){W(e,s,u,t)}c();return Promise.reject()})}return d.catch(()=>{throw S.ActionExecutionFailed})}function W(e,t,n,s){const i=sap.ui.getCore().getMessageManager().getMessageModel().getData();let{processedMessageIds:o,delaySuccessMessages:a,strictHandlingTransitionFails:r}=n;const l=i.filter(function(e){const t=o.find(function(t){return e.id===t});if(!t){o.push(e.id);if(e.type===v.Success){a.push(e)}}return e.persistent===true&&e.type!==v.Success&&!t});if(l.length){if(s!==null&&s!==void 0&&s.internalModelContext){r.push({oAction:e,groupId:t})}}}function q(){let t=null,n=null;const s=new Promise(function(e,s){t=e;n=s}).catch(function(t){e.error("Error while executing action ",t)});return{oLocalActionPromise:s,internalOperationsPromiseResolve:t,internalOperationsPromiseReject:n}}function U(e){if(e){const e=i.getMessages();return e.findIndex(function(e){return e.getType()==="Error"||e.getType()==="Warning"})}return-1}function X(t,n,s,i,o){const a=n.aContexts||[];const r=n.model;const l=n.aActionParameters||[];const c=n.actionName;const u=n.fnOnSubmitted;const d=n.fnOnResponse;const f=O(s);let m;function p(){if(l&&l.length){for(let e=0;e<l.length;e++){if(!l[e].value){switch(l[e].$Type){case"Edm.String":l[e].value="";break;case"Edm.Boolean":l[e].value=false;break;case"Edm.Byte":case"Edm.Int16":case"Edm.Int32":case"Edm.Int64":l[e].value=0;break;default:break}}m.setParameter(l[e].$Name,l[e].value)}}}if(a.length){return new Promise(function(s){const l=n.mBindingParameters;const d=n.bGrouped;const h=n.bGetBoundContext;const M=[];let E;let C;let x;const b=q();const v=function(e,s,a,r){p();const l=[];x=!d?`$auto.${s}`:e.getUpdateGroupId();n.requestSideEffects=z.bind(Y,t,a,n,x,l);E=V(e,n,h,x,f,i,r,s,b.internalOperationsPromiseResolve,b.internalOperationsPromiseReject,o);M.push(E);l.push(b.oLocalActionPromise);z(t,a,n,x,l);return Promise.allSettled(l)};const A=function(e,s,a,l){const c=[];p();x=`apiMode${s}`;n.requestSideEffects=z.bind(Y,t,a,n,x,c);E=V(e,n,h,x,f,i,l,s,b.internalOperationsPromiseResolve,b.internalOperationsPromiseReject,o);M.push(E);c.push(b.oLocalActionPromise);z(t,a,n,x,c);r.submitBatch(x);return Promise.allSettled(c)};async function O(){const t=[];for(C=0;C<a.length;C++){m=r.bindContext(`${c}(...)`,a[C],l);t.push(v(m,a.length<=1?null:C,{context:a[C],pathExpressions:n.additionalSideEffect&&n.additionalSideEffect.pathExpressions,triggerActions:n.additionalSideEffect&&n.additionalSideEffect.triggerActions},a.length))}(u||function e(){})(M);await Promise.allSettled(t);if(o&&o.strictHandlingPromises.length){try{const e=U(true);if(e===-1){await P.renderMessageView(n,f,i,o.strictHandlingWarningMessages,o,a.length>1)}else{o.strictHandlingPromises.forEach(function(e){e.resolve(false)});const e=g.getMessageManager().getMessageModel();const t=e.getData();e.setData(t.concat(o.strictHandlingWarningMessages))}}catch{e.error("Retriggering of strict handling actions failed")}}$()}async function S(e){(u||function e(){})(M);function t(e,t,s){m=r.bindContext(`${c}(...)`,e,l);return A(m,t,{context:e,pathExpressions:n.additionalSideEffect&&n.additionalSideEffect.pathExpressions,triggerActions:n.additionalSideEffect&&n.additionalSideEffect.triggerActions},s)}await e.reduce(async(e,n,s)=>{await e;await t(n,s+1,a.length)},Promise.resolve());if(o&&o.strictHandlingPromises.length){await P.renderMessageView(n,f,i,o.strictHandlingWarningMessages,o,a.length>1)}$()}if(!d){S(a)}else{O()}function $(){return Promise.allSettled(M).then(s)}}).finally(function(){(d||function e(){})()})}else{m=r.bindContext(`/${c}(...)`);p();const t="actionImport";const s=m.execute(t,undefined,P.fnOnStrictHandlingFailed.bind(Y,t,{label:n.label,model:r},f,null,null,null,i,o));r.submitBatch(t);(u||function e(){})(s);return s.then(function(e){if(e){return e}else{var t,n,s;return(t=(n=m).getBoundContext)===null||t===void 0?void 0:(s=t.call(n))===null||s===void 0?void 0:s.getObject()}}).catch(function(t){e.error("Error while executing action "+c,t);throw t}).finally(function(){(d||function e(){})()})}}function K(e,t){let n=e.getPath();n=e.getObject("$IsBound")?n.split("@$ui5.overload")[0]:n.split("/0")[0];return n.split(`/${t}`)[0]}function J(e,t,n,s){if(n){for(const e of t){if(e.$Name!=="ResultIsActiveEntity"&&!(n!==null&&n!==void 0&&n.find(t=>t.name===e.$Name))){return false}}}else if(e&&s){for(const e of t){if(!s[e.$Name]){return false}}}return true}function z(n,s,i,o,a){const r=n.getSideEffectsService();let l;if(s&&s.triggerActions&&s.triggerActions.length){s.triggerActions.forEach(function(e){if(e){l=r.executeAction(e,s.context,o);if(a){a.push(l)}}})}if(s&&s.pathExpressions&&s.pathExpressions.length>0){l=r.requestSideEffects(s.pathExpressions,s.context,o);if(a){a.push(l)}l.then(function(){if(i.operationAvailableMap&&i.internalModelContext){t.setActionEnablement(i.internalModelContext,JSON.parse(i.operationAvailableMap),i.selectedItems,"table")}}).catch(function(t){e.error("Error while requesting side effects",t)})}}const Y={callBoundAction:T,callActionImport:_,callBoundFunction:N,callFunctionImport:w,executeDependingOnSelectedContexts:V,createinternalOperationsPromiseForActionExecution:q,valuesProvidedForAllParameters:J,getActionParameterActionName:k,actionParameterShowMessageCallback:H,afterActionResolution:G,checkforOtherMessages:U};return Y},false);
//# sourceMappingURL=facade.js.map