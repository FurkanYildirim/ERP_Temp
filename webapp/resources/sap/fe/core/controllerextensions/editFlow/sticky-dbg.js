/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log", "sap/fe/core/helpers/ResourceModelHelper", "sap/fe/core/library", "sap/m/MessageBox", "sap/ui/core/Core", "../../operationsHelper"], function (Log, ResourceModelHelper, FELibrary, MessageBox, Core, operationsHelper) {
  "use strict";

  var getResourceModel = ResourceModelHelper.getResourceModel;
  const ProgrammingModel = FELibrary.ProgrammingModel;
  /**
   * Opens a sticky session to edit a document.
   *
   * @function
   * @name sap.fe.core.actions.sticky#editDocumentInStickySession
   * @memberof sap.fe.core.actions.sticky
   * @static
   * @param context Context of the document to be edited
   * @param appComponent The AppComponent
   * @returns A Promise resolved when the sticky session is in edit mode
   * @private
   * @ui5-restricted
   */
  async function editDocumentInStickySession(context, appComponent) {
    const model = context.getModel(),
      metaModel = model.getMetaModel(),
      metaPath = metaModel.getMetaPath(context.getPath()),
      editActionAnnotation = metaModel.getObject(`${metaPath}@com.sap.vocabularies.Session.v1.StickySessionSupported/EditAction`);
    if (!editActionAnnotation) {
      throw new Error(`Edit Action for Sticky Session not found for ${metaPath}`);
    }
    const resourceModel = getResourceModel(appComponent);
    const actionName = resourceModel.getText("C_COMMON_OBJECT_PAGE_EDIT");
    const editAction = model.bindContext(`${editActionAnnotation}(...)`, context, {
      $$inheritExpandSelect: true
    });
    const groupId = "direct";
    const editPromise = editAction.execute(groupId, undefined, operationsHelper.fnOnStrictHandlingFailed.bind(sticky, groupId, {
      label: actionName,
      model
    }, resourceModel, null, null, null, undefined, undefined));
    model.submitBatch(groupId);
    const newContext = await editPromise;
    const sideEffects = appComponent.getSideEffectsService().getODataActionSideEffects(editActionAnnotation, newContext);
    if (sideEffects !== null && sideEffects !== void 0 && sideEffects.triggerActions && sideEffects.triggerActions.length) {
      await appComponent.getSideEffectsService().requestSideEffectsForODataAction(sideEffects, newContext);
    }
    return newContext;
  }
  /**
   * Activates a document and closes the sticky session.
   *
   * @function
   * @name sap.fe.core.actions.sticky#activateDocument
   * @memberof sap.fe.core.actions.sticky
   * @static
   * @param context Context of the document to be activated
   * @param appComponent Context of the document to be activated
   * @returns A promise resolve when the sticky session is activated
   * @private
   * @ui5-restricted
   */
  async function activateDocument(context, appComponent) {
    const model = context.getModel(),
      metaModel = model.getMetaModel(),
      metaPath = metaModel.getMetaPath(context.getPath()),
      saveActionAnnotation = metaModel.getObject(`${metaPath}@com.sap.vocabularies.Session.v1.StickySessionSupported/SaveAction`);
    if (!saveActionAnnotation) {
      throw new Error(`Save Action for Sticky Session not found for ${metaPath}`);
    }
    const resourceModel = getResourceModel(appComponent);
    const actionName = resourceModel.getText("C_OP_OBJECT_PAGE_SAVE");
    const saveAction = model.bindContext(`${saveActionAnnotation}(...)`, context, {
      $$inheritExpandSelect: true
    });
    const groupId = "direct";
    const savePromise = saveAction.execute(groupId, undefined, operationsHelper.fnOnStrictHandlingFailed.bind(sticky, groupId, {
      label: actionName,
      model
    }, resourceModel, null, null, null, undefined, undefined));
    model.submitBatch(groupId);
    try {
      return await savePromise;
    } catch (err) {
      const messagesPath = metaModel.getObject(`${metaPath}/@${"com.sap.vocabularies.Common.v1.Messages"}/$Path`);
      if (messagesPath) {
        try {
          await appComponent.getSideEffectsService().requestSideEffects([messagesPath], context);
        } catch (error) {
          Log.error("Error while requesting side effects", error);
        }
      }
      throw err;
    }
  }
  /**
   * Discards a document and closes sticky session.
   *
   * @function
   * @name sap.fe.core.actions.sticky#discardDocument
   * @memberof sap.fe.core.actions.sticky
   * @static
   * @param context Context of the document to be discarded
   * @returns A promise resolved when the document is dicarded
   * @private
   * @ui5-restricted
   */
  function discardDocument(context) {
    const model = context.getModel(),
      metaModel = model.getMetaModel(),
      metaPath = metaModel.getMetaPath(context.getPath()),
      discardActionAnnotation = metaModel.getObject(`${metaPath}@com.sap.vocabularies.Session.v1.StickySessionSupported/DiscardAction`);
    if (!discardActionAnnotation) {
      throw new Error(`Discard Action for Sticky Session not found for ${metaPath}`);
    }
    const discardAction = model.bindContext(`/${discardActionAnnotation}(...)`);
    return discardAction.execute("$direct").then(function () {
      return context;
    });
  }

  /**
   * Process the Data loss confirmation.
   *
   * @function
   * @name sap.fe.core.actions.sticky#discardDocument
   * @memberof sap.fe.core.actions.sticky
   * @static
   * @param fnProcess Function to execute after confirmation
   * @param view Current view
   * @param programmingModel Programming Model of the current page
   * @returns `void` i think
   * @private
   * @ui5-restricted
   */
  function processDataLossConfirmation(fnProcess, view, programmingModel) {
    const uiEditable = view.getModel("ui").getProperty("/isEditable"),
      resourceBundle = Core.getLibraryResourceBundle("sap.fe.templates"),
      warningMsg = resourceBundle && resourceBundle.getText("T_COMMON_UTILS_NAVIGATION_AWAY_MSG"),
      confirmButtonTxt = resourceBundle && resourceBundle.getText("T_COMMON_UTILS_NAVIGATION_AWAY_CONFIRM_BUTTON"),
      cancelButtonTxt = resourceBundle && resourceBundle.getText("T_COMMON_UTILS_NAVIGATION_AWAY_CANCEL_BUTTON");
    if (programmingModel === ProgrammingModel.Sticky && uiEditable) {
      return MessageBox.warning(warningMsg, {
        actions: [confirmButtonTxt, cancelButtonTxt],
        emphasizedAction: confirmButtonTxt,
        onClose: function (actionText) {
          if (actionText === confirmButtonTxt) {
            Log.info("Navigation confirmed.");
            fnProcess();
          } else {
            Log.info("Navigation rejected.");
          }
        }
      });
    }
    return fnProcess();
  }

  /**
   * Static functions for the sticky session programming model
   *
   * @namespace
   * @alias sap.fe.core.actions.sticky
   * @private
   * @experimental This module is only for experimental use! <br/><b>This is only a POC and maybe deleted</b>
   * @since 1.54.0
   */
  const sticky = {
    editDocumentInStickySession: editDocumentInStickySession,
    activateDocument: activateDocument,
    discardDocument: discardDocument,
    processDataLossConfirmation: processDataLossConfirmation
  };
  return sticky;
}, false);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJQcm9ncmFtbWluZ01vZGVsIiwiRkVMaWJyYXJ5IiwiZWRpdERvY3VtZW50SW5TdGlja3lTZXNzaW9uIiwiY29udGV4dCIsImFwcENvbXBvbmVudCIsIm1vZGVsIiwiZ2V0TW9kZWwiLCJtZXRhTW9kZWwiLCJnZXRNZXRhTW9kZWwiLCJtZXRhUGF0aCIsImdldE1ldGFQYXRoIiwiZ2V0UGF0aCIsImVkaXRBY3Rpb25Bbm5vdGF0aW9uIiwiZ2V0T2JqZWN0IiwiRXJyb3IiLCJyZXNvdXJjZU1vZGVsIiwiZ2V0UmVzb3VyY2VNb2RlbCIsImFjdGlvbk5hbWUiLCJnZXRUZXh0IiwiZWRpdEFjdGlvbiIsImJpbmRDb250ZXh0IiwiJCRpbmhlcml0RXhwYW5kU2VsZWN0IiwiZ3JvdXBJZCIsImVkaXRQcm9taXNlIiwiZXhlY3V0ZSIsInVuZGVmaW5lZCIsIm9wZXJhdGlvbnNIZWxwZXIiLCJmbk9uU3RyaWN0SGFuZGxpbmdGYWlsZWQiLCJiaW5kIiwic3RpY2t5IiwibGFiZWwiLCJzdWJtaXRCYXRjaCIsIm5ld0NvbnRleHQiLCJzaWRlRWZmZWN0cyIsImdldFNpZGVFZmZlY3RzU2VydmljZSIsImdldE9EYXRhQWN0aW9uU2lkZUVmZmVjdHMiLCJ0cmlnZ2VyQWN0aW9ucyIsImxlbmd0aCIsInJlcXVlc3RTaWRlRWZmZWN0c0Zvck9EYXRhQWN0aW9uIiwiYWN0aXZhdGVEb2N1bWVudCIsInNhdmVBY3Rpb25Bbm5vdGF0aW9uIiwic2F2ZUFjdGlvbiIsInNhdmVQcm9taXNlIiwiZXJyIiwibWVzc2FnZXNQYXRoIiwicmVxdWVzdFNpZGVFZmZlY3RzIiwiZXJyb3IiLCJMb2ciLCJkaXNjYXJkRG9jdW1lbnQiLCJkaXNjYXJkQWN0aW9uQW5ub3RhdGlvbiIsImRpc2NhcmRBY3Rpb24iLCJ0aGVuIiwicHJvY2Vzc0RhdGFMb3NzQ29uZmlybWF0aW9uIiwiZm5Qcm9jZXNzIiwidmlldyIsInByb2dyYW1taW5nTW9kZWwiLCJ1aUVkaXRhYmxlIiwiZ2V0UHJvcGVydHkiLCJyZXNvdXJjZUJ1bmRsZSIsIkNvcmUiLCJnZXRMaWJyYXJ5UmVzb3VyY2VCdW5kbGUiLCJ3YXJuaW5nTXNnIiwiY29uZmlybUJ1dHRvblR4dCIsImNhbmNlbEJ1dHRvblR4dCIsIlN0aWNreSIsIk1lc3NhZ2VCb3giLCJ3YXJuaW5nIiwiYWN0aW9ucyIsImVtcGhhc2l6ZWRBY3Rpb24iLCJvbkNsb3NlIiwiYWN0aW9uVGV4dCIsImluZm8iXSwic291cmNlUm9vdCI6Ii4iLCJzb3VyY2VzIjpbInN0aWNreS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21tb25Bbm5vdGF0aW9uVGVybXMgfSBmcm9tIFwiQHNhcC11eC92b2NhYnVsYXJpZXMtdHlwZXMvdm9jYWJ1bGFyaWVzL0NvbW1vblwiO1xuaW1wb3J0IExvZyBmcm9tIFwic2FwL2Jhc2UvTG9nXCI7XG5pbXBvcnQgdHlwZSBBcHBDb21wb25lbnQgZnJvbSBcInNhcC9mZS9jb3JlL0FwcENvbXBvbmVudFwiO1xuaW1wb3J0IHsgRkVWaWV3IH0gZnJvbSBcInNhcC9mZS9jb3JlL0Jhc2VDb250cm9sbGVyXCI7XG5pbXBvcnQgeyBnZXRSZXNvdXJjZU1vZGVsIH0gZnJvbSBcInNhcC9mZS9jb3JlL2hlbHBlcnMvUmVzb3VyY2VNb2RlbEhlbHBlclwiO1xuaW1wb3J0IEZFTGlicmFyeSBmcm9tIFwic2FwL2ZlL2NvcmUvbGlicmFyeVwiO1xuaW1wb3J0IE1lc3NhZ2VCb3ggZnJvbSBcInNhcC9tL01lc3NhZ2VCb3hcIjtcbmltcG9ydCBDb3JlIGZyb20gXCJzYXAvdWkvY29yZS9Db3JlXCI7XG5pbXBvcnQgdHlwZSBDb250ZXh0IGZyb20gXCJzYXAvdWkvbW9kZWwvb2RhdGEvdjQvQ29udGV4dFwiO1xuaW1wb3J0IG9wZXJhdGlvbnNIZWxwZXIgZnJvbSBcIi4uLy4uL29wZXJhdGlvbnNIZWxwZXJcIjtcblxuY29uc3QgUHJvZ3JhbW1pbmdNb2RlbCA9IEZFTGlicmFyeS5Qcm9ncmFtbWluZ01vZGVsO1xuLyoqXG4gKiBPcGVucyBhIHN0aWNreSBzZXNzaW9uIHRvIGVkaXQgYSBkb2N1bWVudC5cbiAqXG4gKiBAZnVuY3Rpb25cbiAqIEBuYW1lIHNhcC5mZS5jb3JlLmFjdGlvbnMuc3RpY2t5I2VkaXREb2N1bWVudEluU3RpY2t5U2Vzc2lvblxuICogQG1lbWJlcm9mIHNhcC5mZS5jb3JlLmFjdGlvbnMuc3RpY2t5XG4gKiBAc3RhdGljXG4gKiBAcGFyYW0gY29udGV4dCBDb250ZXh0IG9mIHRoZSBkb2N1bWVudCB0byBiZSBlZGl0ZWRcbiAqIEBwYXJhbSBhcHBDb21wb25lbnQgVGhlIEFwcENvbXBvbmVudFxuICogQHJldHVybnMgQSBQcm9taXNlIHJlc29sdmVkIHdoZW4gdGhlIHN0aWNreSBzZXNzaW9uIGlzIGluIGVkaXQgbW9kZVxuICogQHByaXZhdGVcbiAqIEB1aTUtcmVzdHJpY3RlZFxuICovXG5hc3luYyBmdW5jdGlvbiBlZGl0RG9jdW1lbnRJblN0aWNreVNlc3Npb24oY29udGV4dDogQ29udGV4dCwgYXBwQ29tcG9uZW50OiBBcHBDb21wb25lbnQpOiBQcm9taXNlPENvbnRleHQ+IHtcblx0Y29uc3QgbW9kZWwgPSBjb250ZXh0LmdldE1vZGVsKCksXG5cdFx0bWV0YU1vZGVsID0gbW9kZWwuZ2V0TWV0YU1vZGVsKCksXG5cdFx0bWV0YVBhdGggPSBtZXRhTW9kZWwuZ2V0TWV0YVBhdGgoY29udGV4dC5nZXRQYXRoKCkpLFxuXHRcdGVkaXRBY3Rpb25Bbm5vdGF0aW9uID0gbWV0YU1vZGVsLmdldE9iamVjdChgJHttZXRhUGF0aH1AY29tLnNhcC52b2NhYnVsYXJpZXMuU2Vzc2lvbi52MS5TdGlja3lTZXNzaW9uU3VwcG9ydGVkL0VkaXRBY3Rpb25gKTtcblxuXHRpZiAoIWVkaXRBY3Rpb25Bbm5vdGF0aW9uKSB7XG5cdFx0dGhyb3cgbmV3IEVycm9yKGBFZGl0IEFjdGlvbiBmb3IgU3RpY2t5IFNlc3Npb24gbm90IGZvdW5kIGZvciAke21ldGFQYXRofWApO1xuXHR9XG5cdGNvbnN0IHJlc291cmNlTW9kZWwgPSBnZXRSZXNvdXJjZU1vZGVsKGFwcENvbXBvbmVudCk7XG5cdGNvbnN0IGFjdGlvbk5hbWUgPSByZXNvdXJjZU1vZGVsLmdldFRleHQoXCJDX0NPTU1PTl9PQkpFQ1RfUEFHRV9FRElUXCIpO1xuXHRjb25zdCBlZGl0QWN0aW9uID0gbW9kZWwuYmluZENvbnRleHQoYCR7ZWRpdEFjdGlvbkFubm90YXRpb259KC4uLilgLCBjb250ZXh0LCB7ICQkaW5oZXJpdEV4cGFuZFNlbGVjdDogdHJ1ZSB9KTtcblx0Y29uc3QgZ3JvdXBJZCA9IFwiZGlyZWN0XCI7XG5cdGNvbnN0IGVkaXRQcm9taXNlID0gZWRpdEFjdGlvbi5leGVjdXRlKFxuXHRcdGdyb3VwSWQsXG5cdFx0dW5kZWZpbmVkLFxuXHRcdG9wZXJhdGlvbnNIZWxwZXIuZm5PblN0cmljdEhhbmRsaW5nRmFpbGVkLmJpbmQoXG5cdFx0XHRzdGlja3ksXG5cdFx0XHRncm91cElkLFxuXHRcdFx0eyBsYWJlbDogYWN0aW9uTmFtZSwgbW9kZWwgfSxcblx0XHRcdHJlc291cmNlTW9kZWwsXG5cdFx0XHRudWxsLFxuXHRcdFx0bnVsbCxcblx0XHRcdG51bGwsXG5cdFx0XHR1bmRlZmluZWQsXG5cdFx0XHR1bmRlZmluZWRcblx0XHQpXG5cdCk7XG5cdG1vZGVsLnN1Ym1pdEJhdGNoKGdyb3VwSWQpO1xuXG5cdGNvbnN0IG5ld0NvbnRleHQ6IENvbnRleHQgPSBhd2FpdCBlZGl0UHJvbWlzZTtcblx0Y29uc3Qgc2lkZUVmZmVjdHMgPSBhcHBDb21wb25lbnQuZ2V0U2lkZUVmZmVjdHNTZXJ2aWNlKCkuZ2V0T0RhdGFBY3Rpb25TaWRlRWZmZWN0cyhlZGl0QWN0aW9uQW5ub3RhdGlvbiwgbmV3Q29udGV4dCk7XG5cdGlmIChzaWRlRWZmZWN0cz8udHJpZ2dlckFjdGlvbnMgJiYgc2lkZUVmZmVjdHMudHJpZ2dlckFjdGlvbnMubGVuZ3RoKSB7XG5cdFx0YXdhaXQgYXBwQ29tcG9uZW50LmdldFNpZGVFZmZlY3RzU2VydmljZSgpLnJlcXVlc3RTaWRlRWZmZWN0c0Zvck9EYXRhQWN0aW9uKHNpZGVFZmZlY3RzLCBuZXdDb250ZXh0KTtcblx0fVxuXHRyZXR1cm4gbmV3Q29udGV4dDtcbn1cbi8qKlxuICogQWN0aXZhdGVzIGEgZG9jdW1lbnQgYW5kIGNsb3NlcyB0aGUgc3RpY2t5IHNlc3Npb24uXG4gKlxuICogQGZ1bmN0aW9uXG4gKiBAbmFtZSBzYXAuZmUuY29yZS5hY3Rpb25zLnN0aWNreSNhY3RpdmF0ZURvY3VtZW50XG4gKiBAbWVtYmVyb2Ygc2FwLmZlLmNvcmUuYWN0aW9ucy5zdGlja3lcbiAqIEBzdGF0aWNcbiAqIEBwYXJhbSBjb250ZXh0IENvbnRleHQgb2YgdGhlIGRvY3VtZW50IHRvIGJlIGFjdGl2YXRlZFxuICogQHBhcmFtIGFwcENvbXBvbmVudCBDb250ZXh0IG9mIHRoZSBkb2N1bWVudCB0byBiZSBhY3RpdmF0ZWRcbiAqIEByZXR1cm5zIEEgcHJvbWlzZSByZXNvbHZlIHdoZW4gdGhlIHN0aWNreSBzZXNzaW9uIGlzIGFjdGl2YXRlZFxuICogQHByaXZhdGVcbiAqIEB1aTUtcmVzdHJpY3RlZFxuICovXG5hc3luYyBmdW5jdGlvbiBhY3RpdmF0ZURvY3VtZW50KGNvbnRleHQ6IENvbnRleHQsIGFwcENvbXBvbmVudDogQXBwQ29tcG9uZW50KSB7XG5cdGNvbnN0IG1vZGVsID0gY29udGV4dC5nZXRNb2RlbCgpLFxuXHRcdG1ldGFNb2RlbCA9IG1vZGVsLmdldE1ldGFNb2RlbCgpLFxuXHRcdG1ldGFQYXRoID0gbWV0YU1vZGVsLmdldE1ldGFQYXRoKGNvbnRleHQuZ2V0UGF0aCgpKSxcblx0XHRzYXZlQWN0aW9uQW5ub3RhdGlvbiA9IG1ldGFNb2RlbC5nZXRPYmplY3QoYCR7bWV0YVBhdGh9QGNvbS5zYXAudm9jYWJ1bGFyaWVzLlNlc3Npb24udjEuU3RpY2t5U2Vzc2lvblN1cHBvcnRlZC9TYXZlQWN0aW9uYCk7XG5cblx0aWYgKCFzYXZlQWN0aW9uQW5ub3RhdGlvbikge1xuXHRcdHRocm93IG5ldyBFcnJvcihgU2F2ZSBBY3Rpb24gZm9yIFN0aWNreSBTZXNzaW9uIG5vdCBmb3VuZCBmb3IgJHttZXRhUGF0aH1gKTtcblx0fVxuXG5cdGNvbnN0IHJlc291cmNlTW9kZWwgPSBnZXRSZXNvdXJjZU1vZGVsKGFwcENvbXBvbmVudCk7XG5cdGNvbnN0IGFjdGlvbk5hbWUgPSByZXNvdXJjZU1vZGVsLmdldFRleHQoXCJDX09QX09CSkVDVF9QQUdFX1NBVkVcIik7XG5cdGNvbnN0IHNhdmVBY3Rpb24gPSBtb2RlbC5iaW5kQ29udGV4dChgJHtzYXZlQWN0aW9uQW5ub3RhdGlvbn0oLi4uKWAsIGNvbnRleHQsIHsgJCRpbmhlcml0RXhwYW5kU2VsZWN0OiB0cnVlIH0pO1xuXHRjb25zdCBncm91cElkID0gXCJkaXJlY3RcIjtcblxuXHRjb25zdCBzYXZlUHJvbWlzZSA9IHNhdmVBY3Rpb24uZXhlY3V0ZShcblx0XHRncm91cElkLFxuXHRcdHVuZGVmaW5lZCxcblx0XHRvcGVyYXRpb25zSGVscGVyLmZuT25TdHJpY3RIYW5kbGluZ0ZhaWxlZC5iaW5kKFxuXHRcdFx0c3RpY2t5LFxuXHRcdFx0Z3JvdXBJZCxcblx0XHRcdHsgbGFiZWw6IGFjdGlvbk5hbWUsIG1vZGVsIH0sXG5cdFx0XHRyZXNvdXJjZU1vZGVsLFxuXHRcdFx0bnVsbCxcblx0XHRcdG51bGwsXG5cdFx0XHRudWxsLFxuXHRcdFx0dW5kZWZpbmVkLFxuXHRcdFx0dW5kZWZpbmVkXG5cdFx0KVxuXHQpO1xuXG5cdG1vZGVsLnN1Ym1pdEJhdGNoKGdyb3VwSWQpO1xuXG5cdHRyeSB7XG5cdFx0cmV0dXJuIGF3YWl0IHNhdmVQcm9taXNlO1xuXHR9IGNhdGNoIChlcnIpIHtcblx0XHRjb25zdCBtZXNzYWdlc1BhdGggPSBtZXRhTW9kZWwuZ2V0T2JqZWN0KGAke21ldGFQYXRofS9AJHtDb21tb25Bbm5vdGF0aW9uVGVybXMuTWVzc2FnZXN9LyRQYXRoYCkgYXMgc3RyaW5nIHwgdW5kZWZpbmVkO1xuXG5cdFx0aWYgKG1lc3NhZ2VzUGF0aCkge1xuXHRcdFx0dHJ5IHtcblx0XHRcdFx0YXdhaXQgYXBwQ29tcG9uZW50LmdldFNpZGVFZmZlY3RzU2VydmljZSgpLnJlcXVlc3RTaWRlRWZmZWN0cyhbbWVzc2FnZXNQYXRoXSwgY29udGV4dCk7XG5cdFx0XHR9IGNhdGNoIChlcnJvcjogdW5rbm93bikge1xuXHRcdFx0XHRMb2cuZXJyb3IoXCJFcnJvciB3aGlsZSByZXF1ZXN0aW5nIHNpZGUgZWZmZWN0c1wiLCBlcnJvciBhcyBzdHJpbmcpO1xuXHRcdFx0fVxuXHRcdH1cblx0XHR0aHJvdyBlcnI7XG5cdH1cbn1cbi8qKlxuICogRGlzY2FyZHMgYSBkb2N1bWVudCBhbmQgY2xvc2VzIHN0aWNreSBzZXNzaW9uLlxuICpcbiAqIEBmdW5jdGlvblxuICogQG5hbWUgc2FwLmZlLmNvcmUuYWN0aW9ucy5zdGlja3kjZGlzY2FyZERvY3VtZW50XG4gKiBAbWVtYmVyb2Ygc2FwLmZlLmNvcmUuYWN0aW9ucy5zdGlja3lcbiAqIEBzdGF0aWNcbiAqIEBwYXJhbSBjb250ZXh0IENvbnRleHQgb2YgdGhlIGRvY3VtZW50IHRvIGJlIGRpc2NhcmRlZFxuICogQHJldHVybnMgQSBwcm9taXNlIHJlc29sdmVkIHdoZW4gdGhlIGRvY3VtZW50IGlzIGRpY2FyZGVkXG4gKiBAcHJpdmF0ZVxuICogQHVpNS1yZXN0cmljdGVkXG4gKi9cbmZ1bmN0aW9uIGRpc2NhcmREb2N1bWVudChjb250ZXh0OiBDb250ZXh0KSB7XG5cdGNvbnN0IG1vZGVsID0gY29udGV4dC5nZXRNb2RlbCgpLFxuXHRcdG1ldGFNb2RlbCA9IG1vZGVsLmdldE1ldGFNb2RlbCgpLFxuXHRcdG1ldGFQYXRoID0gbWV0YU1vZGVsLmdldE1ldGFQYXRoKGNvbnRleHQuZ2V0UGF0aCgpKSxcblx0XHRkaXNjYXJkQWN0aW9uQW5ub3RhdGlvbiA9IG1ldGFNb2RlbC5nZXRPYmplY3QoYCR7bWV0YVBhdGh9QGNvbS5zYXAudm9jYWJ1bGFyaWVzLlNlc3Npb24udjEuU3RpY2t5U2Vzc2lvblN1cHBvcnRlZC9EaXNjYXJkQWN0aW9uYCk7XG5cblx0aWYgKCFkaXNjYXJkQWN0aW9uQW5ub3RhdGlvbikge1xuXHRcdHRocm93IG5ldyBFcnJvcihgRGlzY2FyZCBBY3Rpb24gZm9yIFN0aWNreSBTZXNzaW9uIG5vdCBmb3VuZCBmb3IgJHttZXRhUGF0aH1gKTtcblx0fVxuXG5cdGNvbnN0IGRpc2NhcmRBY3Rpb24gPSBtb2RlbC5iaW5kQ29udGV4dChgLyR7ZGlzY2FyZEFjdGlvbkFubm90YXRpb259KC4uLilgKTtcblx0cmV0dXJuIGRpc2NhcmRBY3Rpb24uZXhlY3V0ZShcIiRkaXJlY3RcIikudGhlbihmdW5jdGlvbiAoKSB7XG5cdFx0cmV0dXJuIGNvbnRleHQ7XG5cdH0pO1xufVxuXG4vKipcbiAqIFByb2Nlc3MgdGhlIERhdGEgbG9zcyBjb25maXJtYXRpb24uXG4gKlxuICogQGZ1bmN0aW9uXG4gKiBAbmFtZSBzYXAuZmUuY29yZS5hY3Rpb25zLnN0aWNreSNkaXNjYXJkRG9jdW1lbnRcbiAqIEBtZW1iZXJvZiBzYXAuZmUuY29yZS5hY3Rpb25zLnN0aWNreVxuICogQHN0YXRpY1xuICogQHBhcmFtIGZuUHJvY2VzcyBGdW5jdGlvbiB0byBleGVjdXRlIGFmdGVyIGNvbmZpcm1hdGlvblxuICogQHBhcmFtIHZpZXcgQ3VycmVudCB2aWV3XG4gKiBAcGFyYW0gcHJvZ3JhbW1pbmdNb2RlbCBQcm9ncmFtbWluZyBNb2RlbCBvZiB0aGUgY3VycmVudCBwYWdlXG4gKiBAcmV0dXJucyBgdm9pZGAgaSB0aGlua1xuICogQHByaXZhdGVcbiAqIEB1aTUtcmVzdHJpY3RlZFxuICovXG5mdW5jdGlvbiBwcm9jZXNzRGF0YUxvc3NDb25maXJtYXRpb24oZm5Qcm9jZXNzOiBGdW5jdGlvbiwgdmlldzogRkVWaWV3LCBwcm9ncmFtbWluZ01vZGVsOiBzdHJpbmcpIHtcblx0Y29uc3QgdWlFZGl0YWJsZSA9IHZpZXcuZ2V0TW9kZWwoXCJ1aVwiKS5nZXRQcm9wZXJ0eShcIi9pc0VkaXRhYmxlXCIpLFxuXHRcdHJlc291cmNlQnVuZGxlID0gQ29yZS5nZXRMaWJyYXJ5UmVzb3VyY2VCdW5kbGUoXCJzYXAuZmUudGVtcGxhdGVzXCIpLFxuXHRcdHdhcm5pbmdNc2cgPSByZXNvdXJjZUJ1bmRsZSAmJiByZXNvdXJjZUJ1bmRsZS5nZXRUZXh0KFwiVF9DT01NT05fVVRJTFNfTkFWSUdBVElPTl9BV0FZX01TR1wiKSxcblx0XHRjb25maXJtQnV0dG9uVHh0ID0gcmVzb3VyY2VCdW5kbGUgJiYgcmVzb3VyY2VCdW5kbGUuZ2V0VGV4dChcIlRfQ09NTU9OX1VUSUxTX05BVklHQVRJT05fQVdBWV9DT05GSVJNX0JVVFRPTlwiKSxcblx0XHRjYW5jZWxCdXR0b25UeHQgPSByZXNvdXJjZUJ1bmRsZSAmJiByZXNvdXJjZUJ1bmRsZS5nZXRUZXh0KFwiVF9DT01NT05fVVRJTFNfTkFWSUdBVElPTl9BV0FZX0NBTkNFTF9CVVRUT05cIik7XG5cblx0aWYgKHByb2dyYW1taW5nTW9kZWwgPT09IFByb2dyYW1taW5nTW9kZWwuU3RpY2t5ICYmIHVpRWRpdGFibGUpIHtcblx0XHRyZXR1cm4gTWVzc2FnZUJveC53YXJuaW5nKHdhcm5pbmdNc2csIHtcblx0XHRcdGFjdGlvbnM6IFtjb25maXJtQnV0dG9uVHh0LCBjYW5jZWxCdXR0b25UeHRdLFxuXHRcdFx0ZW1waGFzaXplZEFjdGlvbjogY29uZmlybUJ1dHRvblR4dCxcblx0XHRcdG9uQ2xvc2U6IGZ1bmN0aW9uIChhY3Rpb25UZXh0OiBzdHJpbmcpIHtcblx0XHRcdFx0aWYgKGFjdGlvblRleHQgPT09IGNvbmZpcm1CdXR0b25UeHQpIHtcblx0XHRcdFx0XHRMb2cuaW5mbyhcIk5hdmlnYXRpb24gY29uZmlybWVkLlwiKTtcblx0XHRcdFx0XHRmblByb2Nlc3MoKTtcblx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRMb2cuaW5mbyhcIk5hdmlnYXRpb24gcmVqZWN0ZWQuXCIpO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0fSk7XG5cdH1cblx0cmV0dXJuIGZuUHJvY2VzcygpO1xufVxuXG4vKipcbiAqIFN0YXRpYyBmdW5jdGlvbnMgZm9yIHRoZSBzdGlja3kgc2Vzc2lvbiBwcm9ncmFtbWluZyBtb2RlbFxuICpcbiAqIEBuYW1lc3BhY2VcbiAqIEBhbGlhcyBzYXAuZmUuY29yZS5hY3Rpb25zLnN0aWNreVxuICogQHByaXZhdGVcbiAqIEBleHBlcmltZW50YWwgVGhpcyBtb2R1bGUgaXMgb25seSBmb3IgZXhwZXJpbWVudGFsIHVzZSEgPGJyLz48Yj5UaGlzIGlzIG9ubHkgYSBQT0MgYW5kIG1heWJlIGRlbGV0ZWQ8L2I+XG4gKiBAc2luY2UgMS41NC4wXG4gKi9cbmNvbnN0IHN0aWNreSA9IHtcblx0ZWRpdERvY3VtZW50SW5TdGlja3lTZXNzaW9uOiBlZGl0RG9jdW1lbnRJblN0aWNreVNlc3Npb24sXG5cdGFjdGl2YXRlRG9jdW1lbnQ6IGFjdGl2YXRlRG9jdW1lbnQsXG5cdGRpc2NhcmREb2N1bWVudDogZGlzY2FyZERvY3VtZW50LFxuXHRwcm9jZXNzRGF0YUxvc3NDb25maXJtYXRpb246IHByb2Nlc3NEYXRhTG9zc0NvbmZpcm1hdGlvblxufTtcblxuZXhwb3J0IGRlZmF1bHQgc3RpY2t5O1xuIl0sIm1hcHBpbmdzIjoiO0FBQUE7QUFBQTtBQUFBOzs7OztFQVdBLE1BQU1BLGdCQUFnQixHQUFHQyxTQUFTLENBQUNELGdCQUFnQjtFQUNuRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtFQUNBLGVBQWVFLDJCQUEyQixDQUFDQyxPQUFnQixFQUFFQyxZQUEwQixFQUFvQjtJQUMxRyxNQUFNQyxLQUFLLEdBQUdGLE9BQU8sQ0FBQ0csUUFBUSxFQUFFO01BQy9CQyxTQUFTLEdBQUdGLEtBQUssQ0FBQ0csWUFBWSxFQUFFO01BQ2hDQyxRQUFRLEdBQUdGLFNBQVMsQ0FBQ0csV0FBVyxDQUFDUCxPQUFPLENBQUNRLE9BQU8sRUFBRSxDQUFDO01BQ25EQyxvQkFBb0IsR0FBR0wsU0FBUyxDQUFDTSxTQUFTLENBQUUsR0FBRUosUUFBUyxvRUFBbUUsQ0FBQztJ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