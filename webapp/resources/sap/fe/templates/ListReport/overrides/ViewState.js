/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/CommonUtils","sap/fe/core/controls/filterbar/adapter/SelectionVariantToStateFilters","sap/fe/core/helpers/KeepAliveHelper","sap/fe/core/helpers/ModelHelper","sap/fe/core/library","sap/fe/core/templating/PropertyFormatters","sap/fe/macros/DelegateUtil","sap/fe/macros/filter/FilterUtils","sap/fe/navigation/library","sap/ui/Device","sap/ui/fl/apply/api/ControlVariantApplyAPI","sap/ui/mdc/enum/ConditionValidated","sap/ui/mdc/p13n/StateUtil"],function(t,e,a,n,i,r,o,s,l,c,d,f,h,g){"use strict";var u=d.system;const p=c.NavType,V=r.VariantManagement,C=r.TemplateContentView,_=r.InitialLoadMode,y=/\+|\*/g;const S={_bSearchTriggered:false,applyInitialStateOnly:function(){return true},onBeforeStateApplied:function(t,e){const a=this.getView(),n=a.getController(),i=n._getFilterBarControl(),r=n._getControls("table");if(i){i.setSuspendSelection(true);t.push(i.waitForInitialization());if(e===p.hybrid){this._clearFilterConditions(i)}}r.forEach(function(e){t.push(e.initialized())});delete this._bSearchTriggered},onAfterStateApplied:function(){const t=this.getView().getController();const e=t._getFilterBarControl();if(e){e.setSuspendSelection(false)}else if(t._isFilterBarHidden()){const e=t.getView().getBindingContext("internal");e.setProperty("hasPendingFilters",false);if(t._isMultiMode()){t._getMultiModeControl().setCountsOutDated(true)}}},adaptBindingRefreshControls:function(t){const e=this.base.getView(),a=e.getController(),i=a._getControls(),r=n.getControlsForRefresh(e,i);Array.prototype.push.apply(t,r)},adaptStateControls:function(t){const e=this.getView(),a=e.getController(),n=e.getViewData(),i=n.variantManagement===V.Control;const r=this._getFilterBarVM(e);if(r){t.push(r)}if(a._isMultiMode()){t.push(a._getMultiModeControl())}a._getControls("table").forEach(function(e){const a=e.getQuickFilter();if(a){t.push(a)}if(i){t.push(e.getVariant())}t.push(e)});if(a._getControls("Chart")){a._getControls("Chart").forEach(function(e){if(i){t.push(e.getVariant())}t.push(e)})}if(a._hasMultiVisualizations()){t.push(a._getSegmentedButton(C.Chart));t.push(a._getSegmentedButton(C.Table))}const o=a._getFilterBarControl();if(o){t.push(o)}t.push(e.byId("fe::ListReport"))},retrieveAdditionalStates:function(t){const e=this.getView(),a=e.getController(),n=e.getBindingContext("internal").getProperty("hasPendingFilters");t.dataLoaded=!n||!!this._bSearchTriggered;if(a._hasMultiVisualizations()){const a=e.getBindingContext("internal").getProperty("alpContentView");t.alpContentView=a}delete this._bSearchTriggered},applyAdditionalStates:function(t){const e=this.getView(),a=e.getController(),n=a._getFilterBarControl();if(t){if(t.dataLoaded===false&&n){n._bSearchTriggered=false}else if(t.dataLoaded===true){if(n){const t=n.getParent();t.triggerSearch()}this._bSearchTriggered=true}if(a._hasMultiVisualizations()){const a=e.getBindingContext("internal");if(!u.desktop&&t.alpContentView==C.Hybrid){t.alpContentView=C.Chart}a.getModel().setProperty(`${a.getPath()}/alpContentView`,t.alpContentView)}}},_applyNavigationParametersToFilterbar:function(e,a){const n=this.getView();const i=n.getController();const r=i.getAppComponent();const o=r.getComponentData();const s=o&&o.startupParameters||{};const l=this.handleVariantIdPassedViaURLParams(s);let c;a.push(l.then(t=>{if(t&&t.length>0){if(t[0]===true||t[1]===true){c=true}}return this._applySelectionVariant(n,e,c)}).then(()=>{const t=i._getDynamicListReportControl();let a=false;const r=this._getFilterBarVM(n);const o=i._getFilterBarControl();if(o){if(e.navigationType!==p.initial&&e.requiresStandardVariant||!r&&n.getViewData().initialLoad===_.Enabled||i._shouldAutoTriggerSearch(r)){const t=o.getParent();t.triggerSearch()}else{a=this._preventInitialSearch(r)}o.setSuspendSelection(false);this._bSearchTriggered=!a;t.setHeaderExpanded(u.desktop||a)}}).catch(function(){t.error("Variant ID cannot be applied")}))},handleVariantIdPassedViaURLParams:function(t){const e=t["sap-ui-fe-variant-id"],a=t["sap-ui-fe-filterbar-variant-id"],n=t["sap-ui-fe-table-variant-id"],i=t["sap-ui-fe-chart-variant-id"];let r;if(e||a||n||i){r={sPageVariantId:e&&e[0],sFilterBarVariantId:a&&a[0],sTableVariantId:n&&n[0],sChartVariantId:i&&i[0]}}return this._handleControlVariantId(r)},_handleControlVariantId:function(t){let e;const a=this.getView(),n=[];const i=a.getViewData().variantManagement;if(t&&t.sPageVariantId&&i==="Page"){e=a.byId("fe::PageVariantManagement");this._handlePageVariantId(t,e,n)}else if(t&&i==="Control"){if(t.sFilterBarVariantId){e=a.getController()._getFilterBarVariantControl();this._handleFilterBarVariantControlId(t,e,n)}if(t.sTableVariantId){const e=a.getController();this._handleTableControlVariantId(t,e,n)}if(t.sChartVariantId){const e=a.getController();this._handleChartControlVariantId(t,e,n)}}return Promise.all(n)},_handlePageVariantId:function(t,e,a){e.getVariants().forEach(n=>{this._findAndPushVariantToPromise(n,t.sPageVariantId,e,a,true)})},_handleFilterBarVariantControlId:function(t,e,a){if(e){e.getVariants().forEach(n=>{this._findAndPushVariantToPromise(n,t.sFilterBarVariantId,e,a,true)})}},_handleTableControlVariantId:function(t,e,a){const n=e._getControls("table");n.forEach(e=>{const n=e.getVariant();if(e&&n){n.getVariants().forEach(e=>{this._findAndPushVariantToPromise(e,t.sTableVariantId,n,a)})}})},_handleChartControlVariantId:function(t,e,a){const n=e._getControls("Chart");n.forEach(e=>{const n=e.getVariant();const i=n.getVariants();if(i){i.forEach(e=>{this._findAndPushVariantToPromise(e,t.sChartVariantId,n,a)})}})},_findAndPushVariantToPromise:function(t,e,a,n,i){if(t.key===e){n.push(this._applyControlVariant(a,e,i))}},_applyControlVariant:function(t,e,a){const n=this._checkIfVariantIdIsAvailable(t,e)?e:t.getStandardVariantKey();const i=f.activateVariant({element:t,variantReference:n});return i.then(function(){return a})},_getFilterBarVM:function(t){const e=t.getViewData();switch(e.variantManagement){case V.Page:return t.byId("fe::PageVariantManagement");case V.Control:return t.getController()._getFilterBarVariantControl();case V.None:return null;default:throw new Error(`unhandled variant setting: ${e.variantManagement}`)}},_preventInitialSearch:function(t){if(!t){return true}const e=t.getVariants();const a=e.find(function(e){return e.key===t.getCurrentVariantKey()});return!a.executeOnSelect},_applySelectionVariant:async function(t,a,n){var i;const r=t.getController()._getFilterBarControl(),o=a.selectionVariant,s=a.selectionVariantDefaults;if(!r||!o){return Promise.resolve()}let l={};const c=(i=t.getModel())===null||i===void 0?void 0:i.getMetaModel();const d=t.getViewData();const f=d.contextPath||`/${d.entitySet}`;const h=e.getMandatoryFilterFields(c,f);const g=r.data("useSemanticDateRange");let u;switch(d.variantManagement){case V.Page:u=t.byId("fe::PageVariantManagement");break;case V.Control:u=t.getController()._getFilterBarVariantControl();break;case V.None:default:break}const p=a.requiresStandardVariant;const C=s&&s.getSelectOptionsPropertyNames().length>0&&u.getDefaultVariantKey()===u.getStandardVariantKey()&&a.bNavSelVarHasDefaultsOnly===true;if(n||C){l=r.getConditions()}e.addDefaultDisplayCurrency(h,o,s);await this.addSelectionVariantToConditions(r,o,l,C);return this._activateSelectionVariant(r,l,u,p,n,C)},_activateSelectionVariant:function(t,e,a,n,i,r){let o;if(a&&!i){let t=n?a.getStandardVariantKey():a.getDefaultVariantKey();if(t===null){t=a.getId()}o=f.activateVariant({element:a,variantReference:t}).then(function(){return n||a.getDefaultVariantKey()===a.getStandardVariantKey()})}else{o=Promise.resolve(true)}return o.then(a=>{if(a){return this._fnApplyConditions(t,e,r)}})},_fnClearStateBeforexAppNav:async function(e){return await g.retrieveExternalState(e).then(t=>{const e=t.filter;for(const t in e){if(t!=="$editState"&&t!=="$search"&&e[t]){e[t].forEach(t=>{t["filtered"]=false})}}return Promise.resolve(e)}).catch(function(e){t.error("Error while retrieving the external state",e)})},_fnApplyConditions:async function(t,a,n){const r={},c=[],d=function(t){t.validated=h.Validated;if(t.operator==="Empty"){t.operator="EQ";t.values=[""]}else if(t.operator==="NotEmpty"){t.operator="NE";t.values=[""]}delete t.isEmpty};const f=function(t,a){const n=i.getEntitySetPath(a),r=t.getModel().getMetaModel(),s=e.getFilterRestrictionsByPath(n,r),c=s.NonFilterableProperties,d=l.getConvertedFilterFields(t,a),f=[];d.forEach(function(t){const e=t.conditionPath.replace(y,"");if(c.indexOf(e)===-1){const e=t.annotationPath;const a=r.createBindingContext(e);f.push({path:t.conditionPath,hiddenFilter:t.availability==="Hidden",hasValueHelp:!e?false:o.hasValueHelp(a.getObject(),{context:a})})}});return f};return t.waitForInitialization().then(async()=>{const e=s.getCustomData(t,"entityType");if(!n){const e=await this._fnClearStateBeforexAppNav(t);await g.applyExternalState(t,{filter:e,items:c})}const i=f(t,e);i.filter(function(t){return t.path!=="$editState"&&t.path!=="$search"}).forEach(t=>{if(t.path in a){r[t.path]=a[t.path];if(!t.hiddenFilter){c.push({name:t.path})}if(t.hasValueHelp){r[t.path].forEach(d)}else{r[t.path].forEach(function(t){t.validated=t.filtered?h.NotValidated:t.validated})}}else{r[t.path]=[]}});return g.applyExternalState(t,{filter:r,items:c})})},_clearFilterConditions:async function(t){const e=[];return t.waitForInitialization().then(async()=>{const a=await this._fnClearStateBeforexAppNav(t);return g.applyExternalState(t,{filter:a,items:e})})},addSelectionVariantToConditions:async(t,e,n,i)=>{await t.waitForInitialization();const r=await a.getFilterBarSupportedFields(t);const o=a.getFilterBarInfoForConversion(t);const s=a.getConditionsFromSV(e,o,r);r.forEach(t=>{const e=t.conditionPath;const a=s[e]||[];if(a.length>0){if(i){a.forEach(t=>{t["filtered"]=true});if(n.hasOwnProperty(e)){n[e].forEach(t=>{t["filtered"]=false});n[e]=n[e].concat(a)}else{n[e]=a}}else{n[e]=n.hasOwnProperty(e)?n[e].concat(a):a}}});return n}};return S},false);
//# sourceMappingURL=ViewState.js.map