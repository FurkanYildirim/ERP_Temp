/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/fe/core/buildingBlocks/BuildingBlockSupport","sap/fe/core/buildingBlocks/RuntimeBuildingBlock","sap/fe/core/controllerextensions/collaboration/CollaborationCommon","sap/fe/core/converters/MetaModelConverter","sap/fe/core/formatters/CollaborationFormatter","sap/fe/core/helpers/BindingToolkit","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/TypeGuards","sap/m/Avatar","sap/m/Button","sap/m/Column","sap/m/ColumnListItem","sap/m/Dialog","sap/m/HBox","sap/m/Label","sap/m/MessageStrip","sap/m/MessageToast","sap/m/ObjectStatus","sap/m/ResponsivePopover","sap/m/SearchField","sap/m/Table","sap/m/Text","sap/m/Title","sap/m/Toolbar","sap/m/ToolbarSpacer","sap/m/VBox","sap/ui/core/library","sap/ui/mdc/Field","sap/ui/mdc/ValueHelp","sap/ui/mdc/valuehelp/content/MTable","sap/ui/mdc/valuehelp/Dialog","sap/ui/mdc/valuehelp/Popover","sap/fe/core/jsx-runtime/jsx","sap/fe/core/jsx-runtime/jsxs","sap/fe/core/jsx-runtime/Fragment"],function(e,t,n,i,a,r,o,s,l,d,c,u,g,p,T,h,v,m,I,f,A,O,C,D,U,b,_,N,x,S,y,R,B,L,E){"use strict";var M,P,V,w,F,j,H;var z={};var k=_.ValueState;var G=s.isPathAnnotationExpression;var $=r.getExpressionFromAnnotation;var Y=r.formatResult;var q=r.constant;var X=r.compileExpression;var W=i.getInvolvedDataModelObjects;var Q=n.UserStatus;var J=n.UserEditingState;var K=n.shareObject;var Z=n.CollaborationUtils;var ee=e.defineBuildingBlock;var te=e.blockAttribute;function ne(e,t,n,i){if(!n)return;Object.defineProperty(e,t,{enumerable:n.enumerable,configurable:n.configurable,writable:n.writable,value:n.initializer?n.initializer.call(i):void 0})}function ie(e){if(e===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return e}function ae(e,t){e.prototype=Object.create(t.prototype);e.prototype.constructor=e;re(e,t)}function re(e,t){re=Object.setPrototypeOf?Object.setPrototypeOf.bind():function e(t,n){t.__proto__=n;return t};return re(e,t)}function oe(e,t,n,i,a){var r={};Object.keys(i).forEach(function(e){r[e]=i[e]});r.enumerable=!!r.enumerable;r.configurable=!!r.configurable;if("value"in r||r.initializer){r.writable=true}r=n.slice().reverse().reduce(function(n,i){return i(e,t,n)||n},r);if(a&&r.initializer!==void 0){r.value=r.initializer?r.initializer.call(a):void 0;r.initializer=undefined}if(r.initializer===void 0){Object.defineProperty(e,t,r);r=null}return r}function se(e,t){throw new Error("Decorating class property failed. Please ensure that "+"proposal-class-properties is enabled and runs after the decorators transform.")}const le="Users";const de="UserID";let ce=(M=ee({name:"CollaborationDraft",namespace:"sap.fe.templates.ObjectPage.components"}),P=te({type:"sap.ui.model.Context",required:true}),V=te({type:"string"}),M(w=(F=function(e){ae(t,e);function t(t){var n;for(var i=arguments.length,a=new Array(i>1?i-1:0),r=1;r<i;r++){a[r-1]=arguments[r]}n=e.call(this,t,...a)||this;ne(n,"contextPath",j,ie(n));ne(n,"id",H,ie(n));n.showCollaborationUserDetails=async e=>{var t,i;const a=e.getSource();if(!n.userDetailsPopover){n.userDetailsPopover=n.getUserDetailsPopover()}(t=n.userDetailsPopover)===null||t===void 0?void 0:t.setBindingContext(a.getBindingContext("internal"),"internal");(i=n.userDetailsPopover)===null||i===void 0?void 0:i.openBy(a,false)};n.manageCollaboration=()=>{var e;if(!n.manageDialog){n.manageDialog=n.getManageDialog()}n.readInvitedUsers(n.containingView);(e=n.manageDialog)===null||e===void 0?void 0:e.open()};n.formatUserStatus=e=>{switch(e){case Q.CurrentlyEditing:return n.getTranslatedText("C_COLLABORATIONDRAFT_USER_CURRENTLY_EDITING");case Q.ChangesMade:return n.getTranslatedText("C_COLLABORATIONDRAFT_USER_CHANGES_MADE");case Q.NoChangesMade:return n.getTranslatedText("C_COLLABORATIONDRAFT_USER_NO_CHANGES_MADE");case Q.NotYetInvited:default:return n.getTranslatedText("C_COLLABORATIONDRAFT_USER_NOT_YET_INVITED")}};n.addUserFieldChanged=e=>{const t=e.getSource();return e.getParameter("promise").then(function(e){const n=t.getBindingContext("internal");const i=n.getProperty("invitedUsers")||[];if(i.findIndex(t=>t.id===e)>-1){t.setValueState("Error");t.setValueStateText(this.getTranslatedText("C_COLLABORATIONDRAFT_INVITATION_USER_ERROR"))}else{t.setValueState("None");t.setValueStateText("")}}.bind(ie(n))).catch(function(){t.setValueState("Warning");t.setValueStateText(this.getTranslatedText("C_COLLABORATIONDRAFT_INVITATION_USER_NOT_FOUND"))}.bind(ie(n)))};n.inviteUser=async e=>{var t;const i=[];const a=e.getSource();const r=a.getBindingContext();const o=((t=n.manageDialogUserTable)===null||t===void 0?void 0:t.getBinding("items")).getContexts();let s=0;o.forEach(function(e){i.push({UserID:e.getProperty("id"),UserAccessRole:"O"});if(e.getObject().status===0){s++}});try{await K(r,i);v.show(n.getTranslatedText("C_COLLABORATIONDRAFT_INVITATION_SUCCESS_TOAST",[s.toString()],n.getSharedItemName(r)))}catch{v.show(n.getTranslatedText("C_COLLABORATIONDRAFT_INVITATION_FAILED_TOAST"))}n.closeManageDialog()};n.readInvitedUsers=async e=>{const t=e.getModel();const i={$select:"UserID,UserDescription,UserEditingState"};const a=t.bindList("DraftAdministrativeData/DraftAdministrativeUser",e.getBindingContext(),[],[],i);const r=e.getBindingContext("internal");return a.requestContexts(0,100).then(function(t){const n=[];const i=e.getModel("internal").getProperty("/collaboration/activeUsers")||[];const a=Z.getMe(e);let o;if((t===null||t===void 0?void 0:t.length)>0){t.forEach(function(e){const t=e.getObject();const r=(a===null||a===void 0?void 0:a.id)===t.UserID;const s=i.find(e=>e.id===t.UserID);let l=t.UserDescription||t.UserID;const d=Z.formatInitials(l);l+=r?` (${Z.getText("C_COLLABORATIONDRAFT_YOU")})`:"";if(s){o=Q.CurrentlyEditing}else if(t.UserEditingState===J.InProgress){o=Q.ChangesMade}else{o=Q.NoChangesMade}const c={id:t.UserID,name:l,status:o,color:Z.getUserColor(t.UserID,i,n),initials:d,me:r};n.push(c)})}else{n.push(a)}r.setProperty("collaboration/UserID","");r.setProperty("collaboration/UserDescription","");r.setProperty("collaboration/invitedUsers",n)}).catch(function(){v.show(this.getTranslatedText("C_COLLABORATIONDRAFT_READING_USER_FAILED"))}.bind(ie(n)))};n.closeManageDialog=()=>{var e;(e=n.manageDialog)===null||e===void 0?void 0:e.close()};n.contextObject=W(n.contextPath);return n}z=t;var n=t.prototype;n.getUserDetailsPopover=function e(){const t=B(I,{showHeader:"false",class:"sapUiContentPadding",placement:"Bottom",children:L(p,{children:[B(l,{initials:"{internal>initials}",displaySize:"S"}),L(b,{children:[B(T,{class:"sapUiMediumMarginBegin",text:"{internal>name}"}),B(T,{class:"sapUiMediumMarginBegin",text:"{internal>id}"})]})]})});this.containingView.addDependent(t);return t};n.getManageDialog=function e(){const t=B(g,{title:this.getInvitationDialogTitleExpBinding(),children:{beginButton:B(d,{text:this.getTranslatedText("C_COLLABORATIONDRAFT_INVITATION_DIALOG_CONFIRMATION"),press:this.inviteUser,type:"Emphasized"}),endButton:B(d,{text:this.getTranslatedText("C_COLLABORATIONDRAFT_INVITATION_DIALOG_CANCEL"),press:this.closeManageDialog}),content:L(b,{class:"sapUiMediumMargin",children:[B(b,{width:"40em",children:B(h,{text:this.getTranslatedText("C_COLLABORATIONDRAFT_INVITATION_MESSAGESTRIP"),type:"Information",showIcon:"true",showCloseButton:"false",class:"sapUiMediumMarginBottom"})}),B(T,{text:this.getTranslatedText("C_COLLABORATIONDRAFT_INVITATION_INPUT_LABEL")}),this.getManageDialogAddUserSection(),this.getManageDialogUserTable()]})}});this.containingView.addDependent(t);t.bindElement({model:"internal",path:"collaboration"});return t};n.getManageDialogUserTable=function e(){this.manageDialogUserTable=B(A,{width:"40em",items:{path:"internal>invitedUsers"},children:{headerToolbar:L(D,{width:"100%",children:[B(C,{text:this.getTranslatedText("C_COLLABORATIONDRAFT_INVITATION_TABLE_TOOLBAR_TITLE"),level:"H3"}),B(U,{}),B(f,{width:"15em"}),"pn"]}),columns:L(E,{children:[B(c,{width:"3em"}),B(c,{width:"20em",children:B(O,{text:this.getTranslatedText("C_COLLABORATIONDRAFT_INVITATION_TABLE_USER_COLUMN")})}),B(c,{width:"17em",children:B(O,{text:this.getTranslatedText("C_COLLABORATIONDRAFT_INVITATION_TABLE_USER_STATUS_COLUMN")})}),B(c,{width:"5em"})]}),items:L(u,{vAlign:"Middle",highlight:"{= ${internal>transient} ? 'Information' : 'None' }",children:[B(l,{displaySize:"XS",backgroundColor:"Accent{internal>color}",initials:"{internal>initials}"}),B(O,{text:"{internal>name}"}),B(m,{state:{path:"internal>status",formatter:this.formatUserStatusColor},text:{path:"internal>status",formatter:this.formatUserStatus}}),B(p,{children:B(d,{icon:"sap-icon://decline",type:"Transparent",press:this.removeUser,visible:"{= !!${internal>transient} }"})})]})}});return this.manageDialogUserTable};n.getManageDialogAddUserSection=function e(){return L(p,{class:"sapUiMediumMarginBottom",width:"100%",children:[B(N,{value:"{internal>UserID}",additionalValue:"{internal>UserDescription}",display:"DescriptionValue",width:"37em",required:"true",fieldHelp:"userValueHelp",placeholder:this.getTranslatedText("C_COLLABORATIONDRAFT_INVITATION_INPUT_PLACEHOLDER"),change:this.addUserFieldChanged,children:{dependents:B(x,{id:"userValueHelp",delegate:this.getValueHelpDelegate(),validateInput:"true",children:{typeahead:B(R,{children:B(S,{caseSensitive:"true",useAsValueHelp:"false"})}),dialog:B(y,{})}})}}),B(d,{class:"sapUiTinyMarginBegin",text:this.getTranslatedText("C_COLLABORATIONDRAFT_INVITATION_DIALOG_ADD_USER"),press:this.addUser})]})};n.formatUserStatusColor=function e(t){switch(t){case Q.CurrentlyEditing:return k.Success;case Q.ChangesMade:return k.Warning;case Q.NoChangesMade:case Q.NotYetInvited:default:return k.Information}};n.addUser=function e(t){const n=t.getSource();const i=n.getBindingContext("internal");const a=i.getProperty("invitedUsers")||[];const r=n.getModel("internal").getProperty("/collaboration/activeUsers");const o={id:i===null||i===void 0?void 0:i.getProperty("UserID"),name:i===null||i===void 0?void 0:i.getProperty("UserDescription")};if(!(a.findIndex(e=>e.id===o.id)>-1||o.id===o.name&&o.id==="")){o.name=o.name||o.id;o.initials=Z.formatInitials(o.name);o.color=Z.getUserColor(o.id,r,a);o.transient=true;o.status=Q.NotYetInvited;a.unshift(o);i.setProperty("invitedUsers",a);i.setProperty("UserID","");i.setProperty("UserDescription","")}};n.removeUser=function e(t){var n;const i=t.getSource();const a=i===null||i===void 0?void 0:i.getBindingContext("pageInternal");const r=i===null||i===void 0?void 0:(n=i.getBindingContext("internal"))===null||n===void 0?void 0:n.getProperty("id");let o=a===null||a===void 0?void 0:a.getProperty("collaboration/invitedUsers");o=o.filter(e=>e.id!==r);a===null||a===void 0?void 0:a.setProperty("collaboration/invitedUsers",o)};n.getSharedItemName=function e(t){var n;const i=(n=this.contextObject.targetObject.entityType.annotations.UI)===null||n===void 0?void 0:n.HeaderInfo;let a="";const r=i===null||i===void 0?void 0:i.Title;if(r){a=G(r.Value)?t.getProperty(r.Value.path):r.Value}return a||(i===null||i===void 0?void 0:i.TypeName)||""};n.getValueHelpDelegate=function e(){const t=this.contextObject.targetEntitySet.annotations.Common.DraftRoot.ShareAction.toString();const n=this.contextObject.targetEntityType.resolvePath(t);const i=n.parameters.find(e=>e.name===le);return{name:"sap/fe/macros/valuehelp/ValueHelpDelegate",payload:{propertyPath:`/${i.type}/${de}`,qualifiers:{},valueHelpQualifier:"",isActionParameterDialog:true}}};n.getInvitationDialogTitleExpBinding=function e(){var t,n;const i=(t=this.contextObject.targetEntityType.annotations.UI)===null||t===void 0?void 0:t.HeaderInfo;const r=$(i===null||i===void 0?void 0:(n=i.Title)===null||n===void 0?void 0:n.Value,[],"");const o=["C_COLLABORATIONDRAFT_INVITATION_DIALOG",q(i===null||i===void 0?void 0:i.TypeName),r];const s=Y(o,a.getFormattedText);return X(s)};n.getInviteButton=function e(){var t,n,i;if((t=this.contextObject.targetEntitySet)!==null&&t!==void 0&&(n=t.annotations.Common)!==null&&n!==void 0&&(i=n.DraftRoot)!==null&&i!==void 0&&i.ShareAction){return B(p,{visible:"{ui>/isEditable}",alignItems:"Center",justifyContent:"Start",children:B(l,{backgroundColor:"TileIcon",src:"sap-icon://add-employee",displaySize:"XS",press:this.manageCollaboration})})}else{return B(p,{})}};n.getContent=function e(t){this.containingView=t;if(o.isCollaborationDraftSupported(this.contextPath.getModel())){return L(E,{children:[B(p,{items:{path:"internal>/collaboration/activeUsers"},class:"sapUiTinyMarginBegin",visible:"{= ${ui>/isEditable} && ${internal>/collaboration/connected} }",alignItems:"Center",justifyContent:"Start",children:B(l,{initials:"{internal>initials}",displaySize:"XS",backgroundColor:"Accent{internal>color}",press:this.showCollaborationUserDetails})}),this.getInviteButton()]})}};return t}(t),j=oe(F.prototype,"contextPath",[P],{configurable:true,enumerable:true,writable:true,initializer:null}),H=oe(F.prototype,"id",[V],{configurable:true,enumerable:true,writable:true,initializer:null}),F))||w);z=ce;return z},false);
//# sourceMappingURL=CollaborationDraft.block.js.map