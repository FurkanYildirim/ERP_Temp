/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 */
sap.ui.define(["sap/ovp/cards/Filterhelper","sap/ovp/app/FilterHelper","sap/ovp/app/OVPLogger","sap/ui/base/SyncPromise","sap/ui/model/FilterOperator"],function(e,t,r,a,i){"use strict";var n=new r("sap.ovp.filter.filterUtils");var l={applyFiltersToV2Card:function(e,r){var a=r.getEntityType(),i=r.oMainComponent.getMacroFilterBar()||r.oMainComponent.getGlobalFilter(),l=i&&i.getModel(),o=r.getView().getModel("ovpCardProperties"),s=o&&o.getProperty("/entityType"),p=s&&s.name;if(a&&l&&p){var g=t.getEntityRelevantFilters(a,e,p,l);var d=t.mergeFilters(g,r.selectionVaraintFilter);try{var c=r.getCardItemsBinding();if(c){c.filter(d)}if(r.getKPIBinding()){r.getKPIBinding().filter(d)}}catch(e){n.error(e)}}},applyFiltersToV4Card:function(t,r){if(r.getView().getModel().getMetaModel().getData){var a=r.getView().getModel().getMetaModel().getData();var i=r.getView().getModel("ovpCardProperties").getProperty("/entityType");var l=i&&i["$Type"];if(l){var o=e._getEntityRelevantFilters(a[l],t);o=e.mergeFilters(o,r.selectionVaraintFilter);try{r.getCardItemsBinding().filter(o);if(r.getKPIBinding()){r.getKPIBinding().filter(o)}}catch(e){n.error(e)}}}},applyFiltersToV4AnalyticalCard:function(t,r){if(r.getView().getModel().getMetaModel().getData){var a=r.getView().getModel().getMetaModel().getData();var i=r.getView().getModel("ovpCardProperties").getData().entityType.$Type;var l=e._getEntityRelevantFilters(a[i],t);l=e.mergeFilters(l,r.selectionVaraintFilter);var o=r.getCardItemsBinding();try{if(l&&l.aFilters){this.fetchFilter(l,o,{}).then(function(e){var t=o.mParameters.$apply.split("/").length>1?r.getCardItemsBinding().mParameters.$apply.split("/")[1]:r.getCardItemsBinding().mParameters.$apply.split("/")[0];o.mParameters.$apply="filter("+e+")/"+t;o.setAggregation()}).catch(function(e){n.error(e)})}else{if(o.mParameters.$apply.split("/").length>1){o.mParameters.$apply=o.mParameters.$apply.split("/")[1];o.setAggregation()}}if(r.getKPIBinding()){r.getKPIBinding().filter(l)}}catch(e){n.error(e)}}},fetchFilter:function(e,t,r,n){var l;var o=t.oModel.getMetaModel();var s=o.getMetaContext(t.oModel.resolve(t.sPath,t.oContext));if(!e){return a.resolve()}if(e.aFilters){return a.all(e.aFilters.map(function(a){return this.fetchFilter(a,t,r,e.bAnd)},this)).then(function(t){return this.wrap(t.join(e.bAnd?" and ":" or "),n&&!e.bAnd)}.bind(this))}l=o.resolve(this.replaceLambdaVariables(e.sPath,r),s);return o.fetchObject(l).then(function(t){var a,o,s;if(!t){throw new Error("Type cannot be determined, no metadata for path: "+l)}s=e.sOperator;if(s===i.All||s===i.Any){a=e.oCondition;o=e.sVariable;if(s===i.Any&&!a){return e.sPath+"/any()"}r=Object.create(r);r[o]=this.replaceLambdaVariables(e.sPath,r);return this.fetchFilter(a,r).then(function(t){return e.sPath+"/"+e.sOperator.toLowerCase()+"("+o+":"+t+")"})}return this.getSingleFilterValue(e,t.$Type,n)}.bind(this))},wrap:function(e,t){return t?"("+e+")":e},replaceLambdaVariables:function(e,t){var r=e.split("/");r[0]=t[r[0]];return r[0]?r.join("/"):e},getSingleFilterValue:function(t,r,a){var n,l,o,s;function p(e){return o?"tolower("+e+")":e}o=r==="Edm.String"&&t.bCaseSensitive===false;l=p(decodeURIComponent(t.sPath));s=p(e.formatLiteral(t.oValue1,r));switch(t.sOperator){case i.BT:n=l+" ge "+s+" and "+l+" le "+p(e.formatLiteral(t.oValue2,r));break;case i.NB:n=this.wrap(l+" lt "+s+" or "+l+" gt "+p(e.formatLiteral(t.oValue2,r)),a);break;case i.EQ:case i.GE:case i.GT:case i.LE:case i.LT:case i.NE:n=l+" "+t.sOperator.toLowerCase()+" "+s;break;case i.Contains:case i.EndsWith:case i.NotContains:case i.NotEndsWith:case i.NotStartsWith:case i.StartsWith:n=t.sOperator.toLowerCase().replace("not","not ")+"("+l+","+s+")";break;default:throw new Error("Unsupported operator: "+t.sOperator)}return n}};return{applyFiltersToV2Card:l.applyFiltersToV2Card,applyFiltersToV4Card:l.applyFiltersToV4Card,applyFiltersToV4AnalyticalCard:l.applyFiltersToV4AnalyticalCard,fetchFilter:l.fetchFilter,wrap:l.wrap,replaceLambdaVariables:l.replaceLambdaVariables,getSingleFilterValue:l.getSingleFilterValue}});
//# sourceMappingURL=FilterUtils.js.map