/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 * @fileOverview Library to Manage rendering of Viz Charts.
 *
 * Any function that needs to be exported(used outside this file) via namespace should be defined as
 * a function and then added to the return statement at the end of this file
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ovp/cards/v4/charts/Utils","sap/ovp/cards/AnnotationHelper","sap/ui/core/format/NumberFormat","sap/ui/core/format/DateFormat","sap/viz/ui5/api/env/Format","sap/viz/ui5/controls/VizTooltip","sap/ovp/cards/CommonUtils","sap/ovp/cards/OVPCardAsAPIUtils","sap/viz/ui5/data/DimensionDefinition","sap/viz/ui5/data/MeasureDefinition","sap/viz/ui5/controls/common/feeds/FeedItem","sap/ui/core/Element","sap/ovp/app/resources","sap/ovp/app/OVPUtils","sap/base/util/each","sap/base/util/merge","sap/ovp/app/OVPLogger","sap/base/util/isEmptyObject","sap/ovp/helpers/V4/MetadataAnalyzer","sap/ovp/cards/Integration/Helpers/AnalyticalCard","sap/ovp/cards/NavigationHelper","sap/ovp/cards/Constants","sap/ovp/cards/MetadataAnalyser"],function(jQuery,e,t,a,r,i,n,o,s,l,u,f,c,v,p,g,m,A,d,h,P,y,E,C){"use strict";var _={LABEL_KEY:"sap:label",LABEL_KEY_V4:"com.sap.vocabularies.Common.v1.Label",TEXT_KEY:"sap:text",TEXT_KEY_V4:"com.sap.vocabularies.Common.v1.Text",TEXT_ARRANGEMENT_ANNO:"com.sap.vocabularies.UI.v1.TextArrangement",TYPE_KEY:"$Type",DISPLAY_FORMAT_KEY:"sap:display-format",SEMANTICS_KEY:"sap:semantics",UNIT_KEY:"sap:unit",UNIT_KEY_V4_ISOCurrency:"Org.OData.Measures.V1.ISOCurrency",UNIT_KEY_V4_Unit:"Org.OData.Measures.V1.Unit",CURRENCY_CODE:"currency-code",NAME_KEY:"name",NAME_CAP_KEY:"Name",EDM_TYPE:"type",EDM_INT32:"Edm.Int32",EDM_INT64:"Edm.Int64",SCATTER_CHARTTYPE:"com.sap.vocabularies.UI.v1.ChartType/Scatter",BUBBLE_CHARTTYPE:"com.sap.vocabularies.UI.v1.ChartType/Bubble",LINE_CHARTTYPE:"com.sap.vocabularies.UI.v1.ChartType/Line",COLUMNSTACKED_CHARTTYPE:"com.sap.vocabularies.UI.v1.ChartType/ColumnStacked",VERTICALBULLET_CHARTTYPE:"com.sap.vocabularies.UI.v1.ChartType/VerticalBullet",COLUMN_CHARTTYPE:"com.sap.vocabularies.UI.v1.ChartType/Column",BAR_CHARTTYPE:"com.sap.vocabularies.UI.v1.ChartType/Bar",COMBINATION_CHARTTYPE:"com.sap.vocabularies.UI.v1.ChartType/Combination",DONUT_CHARTTYPE:"com.sap.vocabularies.UI.v1.ChartType/Donut",V4_ANNOTATION:"annotations"};var T={CARD_WARNING:"OVP-AC: Analytic card: Warning: ",CARD_ERROR:"OVP-AC: Analytic card Error: ",DATA_ANNO_ERROR:"OVP-AC: Analytic card Error:",CARD_ANNO_ERROR:"OVP-AC: Analytic card: Error ",CHART_ANNO_ERROR:"OVP-AC: Analytic card: Error ",INVALID_CHART_ANNO:"OVP-AC: Analytic Cards: Invalid Chart Annotation.",ANALYTICAL_CONFIG_ERROR:"Analytic card configuration error",CACHING_ERROR:"no model defined while caching OdataMetaData",INVALID_MAXITEMS:"maxItems is Invalid. ",NO_DATASET:"OVP-AC: Analytic Cards: Could not obtain dataset.",SORTORDER_WARNING:"SortOrder is present in PresentationVariant, but it is empty or not well formed.",BOOLEAN_ERROR:"Boolean value is not present in PresentationVariant.",IS_MANDATORY:"is mandatory.",IS_MISSING:"is missing.",NOT_WELL_FORMED:"is not found or not well formed)",MISSING_CHARTTYPE:"Missing ChartType in ",CHART_ANNO:"Chart Annotation.",DATA_ANNO:"Data Annotation",CARD_ANNO:"card annotation.",CARD_CONFIG:"card configuration.",CARD_CONFIG_ERROR:"Could not obtain configuration for ",CARD_CONTAINER_ERROR:"Could not obtain card container. ",DATA_UNAVAIALABLE:"No data available.",CONFIG_LOAD_ERROR:"Failed to load config.json. Reason: ",INVALID_CHARTTYPE:"Invalid ChartType given for ",INVALID_CONFIG:"No valid configuration given for ",CONFIG_JSON:"in config.json",ENTER_INTEGER:"Please enter an Integer.",NO_CARD_MODEL:"Could not obtain Cards model.",ANNO_REF:"com.sap.vocabularies.UI.v1 annotation.",INVALID_REDUNDANT:"Invalid/redundant role configured for ",CHART_IS:"chart is/are ",CARD_CONFIG_JSON:"card from config.json",ALLOWED_ROLES:"Allowed role(s) for ",DIMENSIONS_MANDATORY:"DimensionAttributes are mandatory.",MEASURES_MANDATORY:"MeasureAttributes are mandatory.",CARD_LEAST:"card: Enter at least ",CARD_MOST:"card: Enter at most ",FEEDS:"feed(s).",MIN_FEEDS:"Minimum number of feeds required for ",FEEDS_OBTAINED:"card is not configured. Obtained ",FEEDS_REQUIRED:"feed(s), Required: ",INVALID_SEMANTIC_MEASURES:"More than one measure is being semantically coloured",INVALID_IMPROVEMENT_DIR:"No Improvement Direction Found",INVALID_CRITICALITY:"Invalid criticality values",INVALID_DIMMEAS:"Invalid number of Measures or Dimensions",INVALID_FORECAST:"Invalid/Redundant Datapoint or Forecast measure",INVALID_TARGET:"Invalid/Redundant Datapoint or Target measure",ERROR_MISSING_AXISSCALES:"Minimum and Maximum values are mandatory for AxisScale MinMax to work"};var I=["year","yearweek","yearmonth","yearquarter"];var N=[_.COLUMNSTACKED_CHARTTYPE,_.DONUT_CHARTTYPE,_.COLUMN_CHARTTYPE,_.BAR_CHARTTYPE,_.VERTICALBULLET_CHARTTYPE,_.LINE_CHARTTYPE,_.COMBINATION_CHARTTYPE,_.BUBBLE_CHARTTYPE];var R=[_.COLUMNSTACKED_CHARTTYPE];var D;var b=new A("OVP.charts.VizAnnotationManager");function O(e,t,a){var r=e.getMetaModel().getObject("/"+t+"/"+a+"@");return r["@com.sap.vocabularies.Common.v1.IsCalendarYear"]||r["@com.sap.vocabularies.Common.v1.IsCalendarYearMonth"]||r["@com.sap.vocabularies.Common.v1.IsCalendarYearQuarter"]||r["@com.sap.vocabularies.Common.v1.IsCalendarYearWeek"]}function S(a,r,i,n,o,s,l){var u="{";if(!a||!a.getSetting("ovpCardProperties")){b.error(T.ANALYTICAL_CONFIG_ERROR);u+="}";return u}var f=a.getSetting("dataModel");var c;if(l&&l.$EnumMember){c=l.$EnumMember.split("/");if(c&&c[1]!="Donut"&&o===undefined){return null}}var v=[];var p=[];var A=[];var d=[];var P=[];var y=[];var E=[];var I=[];var N=i&&i.Parameters;var R=n&&n.SortOrder;var D=n&&n.MaxItems,O=null;var S;var Y;var x;var F=null;var $=_.TEXT_KEY;var U=_.TEXT_KEY_V4;var K=_.UNIT_KEY;var w="@"+_.UNIT_KEY_V4_ISOCurrency;var B="@"+_.UNIT_KEY_V4_Unit;var k={};if(typeof D==="number"||typeof D==="string"&&!isNaN(D)){O=parseInt(D,10)}if(O){if(O==="0"){b.error("OVP-AC: Analytic card Error: maxItems is configured as "+O);u+="}";return u}if(!/^\d+$/.test(O)){b.error("OVP-AC: Analytic card Error: maxItems is Invalid. Please enter an Integer.");u+="}";return u}}var z=a.getSetting("ovpCardProperties"),H=z.getProperty("/parameters");var W=z.getProperty("/metaModel");var X=z.getProperty("/measureAggregate");var q=h.getEntitySetName(W,r.$Type);N=N||!!H;if(N){var Q=C.resolveParameterizedEntitySet(f,r,i,H);u+="path: '"+Q+"'"}else{u+="path: '/"+q+"'"}var Z=[];F=a.getSetting("ovpCardProperties").getProperty("/entitySet");if(!f||!F){return u}var J=ge(f,F);Ne(f,J,r.$Type);var ee=a.getSetting("ovpCardProperties").getProperty("/cardLayout");var te=1,ae;var re=G();var ie;var ne;if(o&&ee&&ee.colSpan&&ee.colSpan>1){ae=ee.colSpan-te;for(var oe in re){if((ne=re[oe].reference)&&re[ne]){var se=m({},re[ne]);re[oe]=se}if(oe===c[1]||re[oe].time&&re[oe].time.type===c[1].toLowerCase()){ie=re[oe];break}}var le=j(o,ie,f,F);if(le){ie=ie.time}else{ie=ie.default}var ue=a.getSetting("ovpCardProperties").getProperty("/dataStep");if(!ue){if(ie.resize&&ie.resize.hasOwnProperty("dataStep")&&!isNaN(ie.resize.dataStep)){ue=ie.resize.dataStep}}ue=parseInt(ue,10);if(ae>0&&ue&&!isNaN(ue)){O=parseInt(O,10)+ue*ae}}if(i){var z=a.getSetting("ovpCardProperties");Z=t.getFilters(z,i,true)}var fe=a.getSetting("ovpCardProperties").getProperty("/entityType");g(s,function(e,t){S=t.Measure.$PropertyPath;if(t.DataPoint&&t.DataPoint.AnnotationPath){var a=fe[t.DataPoint.AnnotationPath.substring(1)];if(a.ForecastValue&&(a.ForecastValue.PropertyPath||a.ForecastValue.Path)){var r=a.ForecastValue.PropertyPath||a.ForecastValue.Path;P.push(a.ForecastValue.PropertyPath||a.ForecastValue.Path);if(J&&J[r]){var i;if(J[r].annotations&&J[r].annotations[w]){i=J[r].annotations[w].$Path?J[r].annotations[w].$Path:undefined}else if(J[r].annotations&&J[r].annotations[B]){i=J[r].annotations[B].$Path?J[r].annotations[B].$Path:undefined}else if(J[r][K]){i=J[r][K]}if(i){if((y?Array.prototype.indexOf.call(y,i):-1)===-1){y.push(i)}}}}if(a.TargetValue&&(a.TargetValue.PropertyPath||a.TargetValue.Path)){var n=a.TargetValue.PropertyPath||a.TargetValue.Path;P.push(a.TargetValue.PropertyPath||a.TargetValue.Path);if(J&&J[n]){var i;if(J[n].annotations&&J[n].annotations[w]){i=J[n].annotations[w].$Path?J[n].annotations[w].$Path:undefined}else if(J[n].annotations&&J[n].annotations[B]){i=J[n].annotations[B].$Path?J[n].annotations[B].$Path:undefined}else if(J[n][K]){i=J[n][K]}if(i){if((y?Array.prototype.indexOf.call(y,i):-1)===-1){y.push(i)}}}}}P.push(S);if(J&&J[S]){if(J[S][U]){if(J[S][U].String&&S!=J[S][U].String){P.push(J[S][U].String?J[S][U].String:S)}else if(J[S][U].Path&&S!=J[S][U].Path){P.push(J[S][U].Path?J[S][U].Path:S)}}else if(J[S][$]&&S!=J[S][$]){P.push(J[S][$]?J[S][$]:S)}}if(J&&J[S]){var i;if(J[S].annotations&&J[S].annotations[w]){i=J[S].annotations[w].$Path?J[S].annotations[w].$Path:undefined}else if(J[S].annotations&&J[S].annotations[B]){i=J[S].annotations[B].$Path?J[S].annotations[B].$Path:undefined}else if(J[S][K]){i=J[S][K]}if(i){if((y?Array.prototype.indexOf.call(y,i):-1)===-1){y.push(i)}}}});g(o,function(e,t){S=t.Dimension.$PropertyPath;v.push(S);if(J&&J[S]){if(J[S]["annotations"]&&J[S]["annotations"]["@"+U]){if(typeof J[S]["annotations"]["@"+U]==="string"&&J[S]["annotations"]["@"+U]&&S!=J[S]["annotations"]["@"+U]){v.push(J[S]["annotations"]["@"+U])}else if(J[S]["annotations"]["@"+U].$Path&&S!=J[S]["annotations"]["@"+U].$Path){x=J[S]["annotations"]["@"+U].$Path;var a=x.split("/");if(a.length>1){Y=M(W,fe,x);if(Y!==""){v.push(x);p.push(Y);d=L(W,fe,x);if(d.length>0){A=A.concat(d)}}}else{v.push(x?x:S)}}}else if(J[S][$]&&S!=J[S][$]){v.push(J[S][$]?J[S][$]:S)}}});if(A.length>0){var ce=0;while(ce<A.length){if(v.indexOf(A[ce])!==-1){A.splice(ce,1)}else{ce++}}}if(P.length>0){g(P,function(e,t){t+="Aggregate";k[t]=true})}if(v.length>0){g(v,function(e,t){k[t]=true})}if(R){var ve=n.SortOrder;if(!ve.length){ve=e.getSortAnnotationCollection(f,n,r)}if(ve.length<1){b.warning(T.CARD_WARNING+T.SORTORDER_WARNING)}else{var pe="";var me;var Ae;var de;for(var he=0;he<ve.length;he++){me=ve[he];de=me.Property.$PropertyPath;if(P.includes(de)){de+="Aggregate"}I.push(de);if(typeof me.Descending==="undefined"){Ae="true"}else{var Pe=me.Descending.Bool||me.Descending.Boolean;if(!Pe){b.warning(T.CARD_WARNING+T.BOOLEAN_ERROR);Ae="true"}else{Ae=Pe.toLowerCase()==="true"?"true":"false"}}pe=pe+"{path: '"+de+"',descending: "+Ae+"},"}u+=", sorter: ["+pe.substring(0,pe.length-1)+"]"}}var ye=V(y,v);if(I.length>0){g(I,function(e,t){if(!k.hasOwnProperty(t)){ye.push(t)}})}u+=", parameters: {$apply:'groupby(("+ye.join(",")+"),";u+="aggregate(";var Ee=[];P.forEach(function(e,t){var a=X&&X["Axis"+(t+1)];var r=a?a:"sum";var i=[e," with ",r," as ",e,"Aggregate"].join("");Ee.push(i)});u+=Ee.join(",");u+="))";var Ce=W.getObject("/"+r.$Type);if(Ce){var _e=t.getRequestFields(n);if(_e&&_e.length>0){g(_e,function(e,t){if(!k.hasOwnProperty(t)){k[t]=true;E.push(t)}});if(E.length>0){u+=","+E.join(",")}}}if(p.length>0){u+="'"+","+" expand:'"+p.join(",")}var Te=t.checkFilterPreference(a.getSetting("ovpCardProperties"));if(Te){u+="', custom: {cardId: '"+a.getSetting("ovpCardProperties").getProperty("/cardId")+"'}}"}else{u+="'}"}if(c&&c[1]==="Donut"&&o===undefined){u+=", length: 1"}else if(c&&c[1]==="Donut"&&o&&O){u+=", length: "+(parseInt(O,10)+1)}else if(O){u+=", length: "+O}if(Z.length>0&&ye.length>0){var Ie=Z.every(function(e){return ye.indexOf(e.path)!==-1});var Re=Ie?JSON.stringify(Z):"[]";u+=", filters: "+Re}u+="}";return u}S.requiresIContext=true;function M(e,t,a){var r="";var i=a.split("/");if(i.length>1){for(var n=0;n<i.length-1;n++){var o=e.getODataAssociationEnd(t,i[n]);if(o){t=e.getODataEntityType(o.type);if(r){r=r+"/"}r=r+i[n]}else{return r}}}return r}function V(e,t){var a=e.length>0?t.concat(e):t;return a.filter(function(e,t){return a.indexOf(e)===t})}function L(e,t,a){var r=[];var i=[];var n;var o=a.split("/");if(o.length>1){for(var s=0;s<o.length-1;s++){var l=e.getODataAssociationEnd(t,o[s]);if(l){t=e.getODataEntityType(l.type);if(t){i=t&&t.key&&t.key.propertyRef;for(var u=0;u<i.length;u++){n=o[s]+"/"+i[u].name;r.push(n)}}}}}return r}function Y(e,t){var a=false;var r;if(e.DataPoint&&e.DataPoint.AnnotationPath){var i=t[e.DataPoint.AnnotationPath.substring(1)];if(i&&i.ForecastValue&&(i.ForecastValue.PropertyPath||i.ForecastValue.Path)){a=true;r=e}}if(a===true){return r}else{b.warning(T.CARD_WARNING+T.INVALID_FORECAST);return undefined}}function x(e,t){var a=false;var r;if(e.DataPoint&&e.DataPoint.AnnotationPath){var i=t[e.DataPoint.AnnotationPath.substring(1)];if(i&&i.TargetValue&&(i.TargetValue.PropertyPath||i.TargetValue.Path)){a=true;r=e}}if(a===true){return r}else{b.warning(T.CARD_WARNING+T.INVALID_TARGET);return undefined}}function F(e,t){var a;g(t,function(t,r){if(r.name===e){if(r["com.sap.vocabularies.Common.v1.Label"]){a=r["com.sap.vocabularies.Common.v1.Label"].String?r["com.sap.vocabularies.Common.v1.Label"].String:r["com.sap.vocabularies.Common.v1.Label"].Path}else if(r["sap:label"]){a=r["sap:label"]}return false}});return a}function $(e,t){var a=true;if(t==="line"||t==="column"||t==="bar"){g(e,function(e,t){if(t.getUid()==="valueAxis"||t.getUid()==="categoryAxis"){if(t.getValues().length!=1){a=false;b.warning(T.CARD_WARNING+T.INVALID_DIMMEAS);return false}}})}else if(t==="vertical_bullet"){g(e,function(e,t){if(t.getUid()==="actualValues"||t.getUid()==="categoryAxis"){if(t.getValues().length!=1){a=false;b.warning(T.CARD_WARNING+T.INVALID_DIMMEAS);return false}}})}if(a===true){return true}}function U(e,t,a){var r=_.TYPE_KEY;if(!e||!e[t]||!e[t][r]){return a}var i=["Edm.Int","Edmt.Int16","Edm.Int32","Edm.Int64","Edm.Decimal"];var n=e[t][r];if((i?Array.prototype.indexOf.call(i,n):-1)!==-1){return Number(a)}return a}function K(e){if(e){return e}return""}function w(e){var t={locale:function(){},format:function(e,t){var i="";if(t){i=t.split("/")}if(i.length>0){var n,s;if(i.length===3){n=Number(i[1]);s=Number(i[2]);if(isNaN(n)){n=-1}if(isNaN(s)){s=0}}else{n=2;s=0}if(i[0]==="axisFormatter"||i[0]==="ShortFloat"){var l;l=a.getFloatInstance({style:"short",minFractionDigits:n,maxFractionDigits:n?n:1});if(i[0]==="ShortFloat"){l=a.getFloatInstance({style:"short",minFractionDigits:n,maxFractionDigits:n})}if(n===-1){l=a.getFloatInstance({style:"short"})}return l.format(Number(e))}else if(i[0]==="tooltipNoScaleFormatter"){var u=a.getFloatInstance({style:"short",currencyCode:false,shortRefNumber:s,showScale:false,minFractionDigits:n,maxFractionDigits:n});if(n===-1){u=a.getFloatInstance({minFractionDigits:0,currencyCode:false})}return u.format(Number(e))}else if(i[0]==="CURR"){var f=a.getCurrencyInstance({style:"short",currencyCode:false,minFractionDigits:n,maxFractionDigits:n});if(n===-1){f=a.getCurrencyInstance({style:"short",currencyCode:false})}return f.format(Number(e))}else if(i[0].search("%")!==-1){var c=a.getPercentInstance({style:"short",minFractionDigits:n,maxFractionDigits:n});if(n===-1){c=a.getPercentInstance({style:"short",minFractionDigits:1,maxFractionDigits:1})}e=c.format(Number(e));return e}}if(e.constructor===Date){var v=r.getDateTimeInstance({pattern:t});if(t==="YearMonthDay"){v=r.getDateInstance({style:"medium"})}if(t==="YearMonth"||t==="MMM"){v=r.getDateTimeInstance({format:"MMM"})}if(t==="YearQuarter"||t==="Quarter"){v=r.getDateTimeInstance({format:"QQQ"})}if(t==="YearWeek"||t==="Week"){v=r.getDateTimeInstance({format:"www"})}var p=o.getApp();var g=p&&p.bResetChartAxisFormatter;if(g&&t==="hh:mm"){var m=e.toLocaleTimeString();var A=m.split(":");e=A[0]+":"+A[1];return e}var d=g?false:true;e=v.format(new Date(e),d)}return e}};i.numericFormatter(t)}function B(e,t){var a=e.getModel();var r=e.getVizType();if(r!="line"&&r!="bubble"){return}if(!t){t=r==="line"?"categoryAxis":"valueAxis"}var i=e.getModel("ovpCardProperties").getProperty("/entitySet");if(!a||!i){return}var n=ge(a,i);var o=e.getFeeds();for(var s=0;s<o.length;s++){if(o[s].getUid()===t){var l=o[s].getValues();if(!l){return}for(var u=0;u<l.length;u++){if(n[l[u][_.TYPE_KEY]]!="Edm.DateTime"){return}}e.setVizProperties({categoryAxis:{title:{visible:false}}});var f=e&&e.getModel("ovpCardProperties");if(f&&f.getProperty("/bInsightEnabled")){var c=e&&e.getId();P.setVizPropertyMap(c,{categoryAxis:{title:{visible:false}}})}return}}}function k(e,t,a,r,i,n){r=typeof r==="undefined"?false:r;var o=false;var s;if(!e&&r){b.error(i+T.CARD_ERROR+a+T.IS_MANDATORY);return o}if(!e){b.warning(i+T.CARD_WARNING+a+T.IS_MISSING);o=true;return o}s=t["@"+e];if(!s||typeof s!=="object"){var l=r?b.error:b.warning;l(i+T.CARD_ERROR+"in "+a+". (@"+e+" "+T.NOT_WELL_FORMED);return o}if(n&&n==="sap.ovp.cards.v4.charts.analytical.analyticalChart"&&a==="Chart Annotation"&&(!s.ChartType||!s.ChartType.$EnumMember)){b.error(i+T.CARD_ERROR+T.MISSING_CHARTTYPE+T.CHART_ANNO);return o}o=true;return o}function z(e){var t=false;if(!e){return t}var a;var r;var i;var n;var o;var s;var l;var u="";var f;var c=e.getView();if(c){u="["+c.getId()+"] "}if(!(f=e.getCardPropertiesModel())){b.error(u+T.CARD_ERROR+"in "+T.CARD_CONFIG+T.NO_CARD_MODEL);return t}l=f.getProperty("/entityType");var v=e.getMetaModel();var p=v.getData().$Annotations[l.$Type];if(!l||d(l)){b.error(u+T.CARD_ERROR+"in "+T.CARD_ANNO);return t}a=f.getProperty("/selectionAnnotationPath");r=f.getProperty("/chartAnnotationPath");n=f.getProperty("/presentationAnnotationPath");o=f.getProperty("/identificationAnnotationPath");s=f.getProperty("/dataPointAnnotationPath");i=f.getProperty("/contentFragment");t=k(a,p,"Selection Variant",false,u);t=k(r,p,"Chart Annotation",true,u,i)&&t;t=k(n,p,"Presentation Variant",false,u)&&t;t=k(o,p,"Identification Annotation",true,u)&&t;t=k(s,p,"Data Point",false,u)&&t;return t}function H(e,t,a){}function G(t){return e.getConfig(t)}function j(e,t,a,r){var i=false;var n;var o;var s;var l;var u;var f;if(!t.time||d(t.time)){return i}if(!e){return i}for(var c=0;c<e.length;c++){if(!e[c].Dimension||!(o=e[c].Dimension.$PropertyPath)){return i}n=ge(a,r);if(n&&n[o]){s=n[o][_.TYPE_KEY];l=n[o][_.DISPLAY_FORMAT_KEY];u=n[o][_.SEMANTICS_KEY];f=O(a,r,o)}if(s&&s.lastIndexOf("Edm.Date",0)===0){if(s.toLowerCase()==="edm.datetime"){if(l&&l.toLowerCase()==="date"){i=true}}else{i=true}}if(s==="Edm.String"&&(f||u&&I.indexOf(u)>-1)){i=true}if(i){e.unshift(e.splice(c,1)[0]);break}}return i}function W(e,t,a){var r="";var i=G(t);var n,o;if(!i){return r}r=i.default.type;n=e.getSetting("dataModel");o=e.getSetting("ovpCardProperties").getProperty("/entitySet");if(j(a,i,n,o)){r=i.time.type}return r}W.requiresIContext=true;function X(e,t,a){if(!e.length){return}var r=a==="dimension"?"Dimension":"Measure";var i=[];g(e,function(e,t){if(!t||!t[r]||!t[r].PropertyPath){b.error(T.INVALID_CHART_ANNO);return false}i.push(t[r].PropertyPath)});var n=jQuery.map(t.feeds,function(e){if(e.type===a){if(e.role){return e.role.split("|")}return[]}});n=jQuery.grep(n,function(e,t){return(n?Array.prototype.indexOf.call(n,e):-1)===t}).join(", ");b.error(T.CARD_ERROR+T.INVALID_REDUNDANT+a+"(s) "+i.join(", ")+". "+T.ALLOWED_ROLES+t.type+T.CHART_IS+n)}function q(e,t){var a;if(e){if(e.String){a=e.String}else if(e.Boolean||e.Bool){a=Q(e)}else{a=Z(e,t)}}return a}function Q(e,t){if(e&&e.Boolean){if(e.Boolean.toLowerCase()==="true"){return true}else if(e.Boolean.toLowerCase()==="false"){return false}}else if(e&&e.Bool){if(e.Bool.toLowerCase()==="true"){return true}else if(e.Bool.toLowerCase()==="false"){return false}}return t}function Z(e,t){var r;if(e){if(e.String){r=Number(e.String)}else if(e.Int){r=Number(e.Int)}else if(e.Decimal){r=Number(e.Decimal)}else if(e.Double){r=Number(e.Double)}else if(e.Single){r=Number(e.Single)}}if(t){var i=a.getFloatInstance({style:"short",minFractionDigits:2,maxFractionDigits:2});if(r){r=i.format(Number(r))}}return r}function J(e,a){function r(e){if(e){if(e.Path){return"{path:'"+e.Path+"'}"}else{return q(e)}}else{return""}}var i=e[e.measureNames];if(a&&a.CriticalityCalculation&&a.CriticalityCalculation.ImprovementDirection){var n=a.CriticalityCalculation.ImprovementDirection.EnumMember;var o=r(a.CriticalityCalculation.DeviationRangeLowValue);var s=r(a.CriticalityCalculation.DeviationRangeHighValue);var l=r(a.CriticalityCalculation.ToleranceRangeLowValue);var u=r(a.CriticalityCalculation.ToleranceRangeHighValue);return t._calculateCriticalityState(i,n,o,s,l,u,E.Criticality.StateValues)}else{var f=a.Criticality.EnumMember;var c=f?f.split("/"):[];if(c){return c[1]}}}function ee(e,t,a){var r,i;g(t,function(t,a){if(a["com.sap.vocabularies.Common.v1.Label"]&&a["com.sap.vocabularies.Common.v1.Label"].String===e.measureNames){r=a.name;return false}else if(a["com.sap.vocabularies.Common.v1.Label"]&&a["com.sap.vocabularies.Common.v1.Label"].Path===e.measureNames){r=a.name;return false}else if(a["sap:label"]===e.measureNames){r=a.name;return false}});g(a,function(e,t){if(t.Measure.PropertyPath===r){if(!t.DataPoint||!t.DataPoint.AnnotationPath){return false}i=t.DataPoint.AnnotationPath;return false}});return i}function te(e,t){if(e){if(e.Path){return e.Path}else{return q(e,t)}}else{return""}}function ae(e,t){function a(e,t){return e&&e.indexOf(t,e.length-t.length)!==-1}var r=false;g(e,function(e,i){if(i.DataPoint&&i.DataPoint.AnnotationPath){var n=t[i.DataPoint.AnnotationPath.substring(1)];if(n&&n.CriticalityCalculation&&n.CriticalityCalculation.ImprovementDirection&&n.CriticalityCalculation.ImprovementDirection.EnumMember){var o=n.CriticalityCalculation.ImprovementDirection.EnumMember;var s=te(n.CriticalityCalculation.DeviationRangeLowValue);var l=te(n.CriticalityCalculation.DeviationRangeHighValue);var u=te(n.CriticalityCalculation.ToleranceRangeLowValue);var f=te(n.CriticalityCalculation.ToleranceRangeHighValue);if(a(o,"Minimize")||a(o,"Minimizing")){if(f&&l){r=true;return false}else{b.warning(T.CARD_WARNING+T.INVALID_CRITICALITY)}}else if(a(o,"Maximize")||a(o,"Maximizing")){if(u&&s){r=true;return false}else{b.warning(T.CARD_WARNING+T.INVALID_CRITICALITY)}}else if(a(o,"Target")){if(u&&s&&f&&l){r=true;return false}else{b.warning(T.CARD_WARNING+T.INVALID_CRITICALITY)}}}else if(n&&n.Criticality){r=true;return false}else{b.warning(T.CARD_WARNING+T.INVALID_IMPROVEMENT_DIR)}}});if(r===true&&e.length>1){b.warning(T.CARD_WARNING+T.INVALID_SEMANTIC_MEASURES)}return r}function re(e,t,a,r){function i(e,t){return e&&e.indexOf(t,e.length-t.length)!==-1}var n=[null,null];var o=true;var s=e.Measure.PropertyPath;if(a[s]){if(a[s][_.LABEL_KEY_V4]){s=pe(a[s][_.LABEL_KEY_V4].String?a[s][_.LABEL_KEY_V4].String:a[s][_.LABEL_KEY_V4].Path,r,a)}else if(a[s][_.LABEL_KEY]){s=a[s][_.LABEL_KEY]}else if(s){s=s}}var l=e.DataPoint.AnnotationPath;var u=t[l.substring(1)];if(!u.CriticalityCalculation||!u.CriticalityCalculation.ImprovementDirection||!u.CriticalityCalculation.ImprovementDirection.EnumMember){return n}var f=u.CriticalityCalculation.ImprovementDirection.EnumMember;var c=te(u.CriticalityCalculation.DeviationRangeLowValue,o);var p=te(u.CriticalityCalculation.DeviationRangeHighValue,o);var g=te(u.CriticalityCalculation.ToleranceRangeLowValue,o);var m=te(u.CriticalityCalculation.ToleranceRangeHighValue,o);if(i(f,"Minimize")||i(f,"Minimizing")){if(m&&p){n[0]=v.getText("MINIMIZING_LESS",[s,m]);n[1]=v.getText("MINIMIZING_MORE",[s,p]);n[2]=v.getText("MINIMIZING_CRITICAL",[m,s,p])}}else if(i(f,"Maximize")||i(f,"Maximizing")){if(g&&c){n[0]=v.getText("MAXIMISING_MORE",[s,g]);n[1]=v.getText("MAXIMISING_LESS",[s,c]);n[2]=v.getText("MAXIMIZING_CRITICAL",[c,s,g])}}else if(i(f,"Target")){if(g&&c&&m&&p){n[0]=v.getText("TARGET_BETWEEN",[g,s,m]);n[1]=v.getText("TARGET_AROUND",[s,c,p]);n[2]=v.getText("TARGET_CRITICAL",[c,s,g,m,p])}}return n}function ie(e,t,a){if(t&&t.DataPoint&&t.DataPoint.AnnotationPath){var r=a[t.DataPoint.AnnotationPath.substring(1)];var i,n;if(r&&r.ValueFormat){i=r.ValueFormat}else if(r&&r.NumberFormat){i=r.NumberFormat}if(i&&i.NumberOfFractionalDigits&&i.NumberOfFractionalDigits.Int){n=i.NumberOfFractionalDigits.Int;if(e<Number(n)){e=Number(n)}}}return e}function ne(e,t,a){if(t&&t.DataPoint&&t.DataPoint.AnnotationPath){var r=a[t.DataPoint.AnnotationPath.substring(1)];var i,n;if(r&&r.ValueFormat){i=r.ValueFormat}else if(r&&r.NumberFormat){i=r.NumberFormat}if(i){if(i.ScaleFactor&&i.ScaleFactor.Decimal){n=Number(i.ScaleFactor.Decimal)}else if(i.ScaleFactor&&i.ScaleFactor.Int){n=Number(i.ScaleFactor.Int)}if(!isNaN(n)){if(e===undefined){e=Number(n)}else if(e>Number(n)){e=Number(n)}}}}return e}function oe(e,t){if(e&&e[t]&&(e[t]["Org.OData.Measures.V1.ISOCurrency"]||e[t][_.SEMANTICS_KEY]&&e[t][_.SEMANTICS_KEY]===_.CURRENCY_CODE)){return true}return false}function se(e,t,a){if(e[t[a].$PropertyPath].$Type===_.EDM_INT32){return true}return false}function le(e,t,a){if(e[t[a].$PropertyPath].$Type===_.EDM_INT64){return true}return false}function ue(e,t,a){var r,i,o,c,A;var d,h,y,C,I,S=false;var M;var V,L,U;var K,w=[],B=[];var k;var z;var H=a&&a.getView();var W,q;var Q=H&&H.getModel("ui");var Z=Q&&Q.getProperty("/chartSettings");r=e.getModel("ovpCardProperties");if(s.checkIfAPIIsUsed(a)){S=r&&r.getData()&&r.getData().showDataLabel}A=Z?Z.showDataLabel:S;d=e.getVizType();h=G();for(var te in h){if((z=h[te].reference)&&h[z]){var ue=m({},h[z]);h[te]=ue}if(h[te].default.type===d||h[te].time&&h[te].time.type===d){y=h[te];break}}if(!y){b.error(T.CARD_ERROR+"in "+T.CARD_CONFIG+T.CARD_CONFIG_ERROR+d+" "+T.CARD_CONFIG_JSON);return}if(!r){b.error(T.CARD_ERROR+"in "+T.CARD_CONFIG+T.NO_CARD_MODEL);return}var ve=e.getModel();var de=r.getProperty("/entitySet");if(!ve||!de){return}var he=r.getProperty("/entityType").$Type;var Pe=a.getMetaModel().getData().$Annotations[he];var ye={property:a.getMetaModel().getObject("/"+he+"/")};i=p.merge(true,{},Pe,ye);if(!i){b.error(T.CARD_ANNO_ERROR+"in "+T.CARD_ANNO);return}var Ee=ge(ve,de);Ne(ve,Ee,he);o=r.getProperty("/chartAnnotationPath");if(!o||!(c=i["@"+o])){b.error(T.CARD_ANNO_ERROR+"in "+T.CARD_ANNO);return}var Ce=ce(i,o,e);if(!(C=c.DimensionAttributes)||!C.length){b.error(T.CHART_ANNO_ERROR+"in "+T.CHART_ANNO+" "+T.DIMENSIONS_MANDATORY);return}var _e;if(!(I=c.MeasureAttributes)||!I.length){b.error(T.CHART_ANNO_ERROR+"in "+T.CHART_ANNO+" "+T.MEASURES_MANDATORY);return}else{var Te=I[0].DataPoint?i[I[0].DataPoint.AnnotationPath.substring(1)]:null;var Ie=Te&&Te.ValueFormat&&Te.ValueFormat.NumberOfFractionalDigits&&Te.ValueFormat.NumberOfFractionalDigits;_e=Ie?Ie:0}k=j(C,y,ve,de);if(k){y=y.time}else{y=y.default}var Oe=r.getProperty("/ChartProperties")||r.getProperty("/chartProperties");if(r&&r.getProperty("/tabs")&&Oe===undefined){W=H.byId("ovp_card_dropdown");q=parseInt(W.getSelectedKey(),10);Oe=r.getProperty("/tabs")&&r.getProperty("/tabs")[q-1]&&(r.getProperty("/tabs")[q-1]["ChartProperties"]||r.getProperty("/tabs")[q-1]["chartProperties"])}var Se=false;var Me=_e>0?"tooltipNoScaleFormatter/"+_e.toString()+"/":"tooltipNoScaleFormatter/-1/";var Ve=new n({formatString:Me});Ve.connect(e.getVizUid());Ve.connect(e.getVizUid());e._oOvpVizFrameTooltip=Ve;[y.dimensions,y.measures].forEach(function(e,t){var a=t?I:C;var r=t?"measure(s)":"dimension(s)";if(e.min&&a.length<e.min){b.error(T.CARD_ERROR+"in "+d+" "+T.CARD_LEAST+e.min+" "+r);Se=true}if(e.max&&a.length>e.max){b.error(T.CARD_ERROR+"in "+d+T.CARD_MOST+e.max+" "+r);Se=true}});if(Se){return}var Le=true;if(y.properties&&y.properties.hasOwnProperty("hideLabel")&&!y.properties["hideLabel"]){Le=false}var Ye=true;var xe=false;if(d==="donut"){xe=true}e.removeAllAggregation();M={legend:{isScrollable:false},title:{visible:true},interaction:{noninteractiveMode:Ye?false:true,selectability:{legendSelection:xe?true:false,axisLabelSelection:false,mode:"EXCLUSIVE",plotLassoSelection:false,plotStdSelection:true},zoom:{enablement:"disabled"}},plotArea:{window:{start:"firstDataPoint",end:"lastDataPoint"},dataLabel:{visible:A||xe?true:false,type:"value"},dataPoint:{invalidity:"ignore"},alignment:{vertical:"top"}},categoryAxis:{label:{truncatedLabelRatio:.15}},general:{groupData:false,showAsUTC:true}};if(y.properties&&y.properties.semanticColor===true&&ae(I,i)){var Fe=v.getText("GOOD");var $e=v.getText("BAD");var Ue=v.getText("CRITICAL");var Ke=v.getText("OTHERS");if(I.length===1){var we=re(I[0],i,Ee,e);var Fe=we[0]||Fe,$e=we[1]||$e,Ue=we[2]||Ue,Ke=v.getText("OTHERS")}M.plotArea.dataPointStyle={rules:[{callback:function(e){var t=ee(e,Ee,I);if(!t){return false}var a=i[t.substring(1)];var r=J(e,a);if(r===E.Criticality.StateValues.Positive){return true}else if(r==="Positive"){return true}},properties:{color:"sapUiChartPaletteSemanticGoodLight1"},displayName:Fe},{callback:function(e){var t=ee(e,Ee,I);if(!t){return false}var a=i[t.substring(1)];var r=J(e,a);if(r===E.Criticality.StateValues.Critical){return true}else if(r==="Critical"){return true}},properties:{color:"sapUiChartPaletteSemanticCriticalLight1"},displayName:Ue},{callback:function(e){var t=ee(e,Ee,I);if(!t){return false}var a=i[t.substring(1)];var r=J(e,a);if(r===E.Criticality.StateValues.Negative){return true}else if(r==="Negative"){return true}},properties:{color:"sapUiChartPaletteSemanticBadLight1"},displayName:$e},{callback:function(e){var t=ee(e,Ee,I);if(!t){return false}var a=i[t.substring(1)];var r=J(e,a);if(r===E.Criticality.StateValues.None){return true}else if(r==="Neutral"){return true}},properties:{color:"sapUiChartPaletteSemanticNeutralLight1"},displayName:Ke}]}}var Be=r.getProperty("/bEnableStableColors");var ke=r.getProperty("/colorPalette");var ze;if(!Be&&N.indexOf(c.ChartType.$EnumMember)>=0&&ke&&Object.keys(ke).length>=2&&Object.keys(ke).length<=4){g(C,function(e,t){if(t&&t.Role&&t.Role.$EnumMember==="com.sap.vocabularies.UI.v1.ChartDimensionRoleType/Series"){ze=t.Dimension&&t.Dimension.$PropertyPath;return}});var He;if(ze){if(Ee&&Ee[ze]){if(Ee[ze][_.LABEL_KEY_V4]){He=pe(Ee[ze][_.LABEL_KEY_V4]?Ee[ze][_.LABEL_KEY_V4]:Ee[ze][_.LABEL_KEY_V4].Path,e,Ee)}else if(Ee[ze][_.LABEL_KEY]){He=Ee[ze][_.LABEL_KEY]}else if(ze){He=ze}}if(ke instanceof Array){var Ge=ke.map(function(e){return e.color});var je=ke.map(function(e){return e.legendText});var We=je[0]!=undefined?je[0]:v.getText("OTHERS");var Xe=je[1]!=undefined?je[1]:v.getText("BAD");var qe=je[2]!=undefined?je[2]:v.getText("CRITICAL");var Qe=je[3]!=undefined?je[3]:v.getText("GOOD")}M.plotArea.dataPointStyle={rules:[{callback:function(e){if(e&&(e[He]==="3"||e[He]===3)){if(ke instanceof Array){if(ke.length<4){return false}}else if(ke&&!ke.hasOwnProperty(3)){return false}return true}},properties:{color:ke instanceof Array&&Ge.length?Ge[3]:ke[3]&&ke[3]["color"]},displayName:Qe||ke[3]&&ke[3]["legendText"]},{callback:function(e){if(e&&(e[He]==="2"||e[He]===2)){if(ke instanceof Array){if(ke.length<3){return false}}else if(ke&&!ke.hasOwnProperty(2)){return false}return true}},properties:{color:ke instanceof Array&&Ge.length?Ge[2]:ke[2]&&ke[2]["color"]},displayName:qe||ke[2]&&ke[2]["legendText"]},{callback:function(e){if(e&&(e[He]==="1"||e[He]===1)){return true}},properties:{color:ke instanceof Array&&Ge.length?Ge[1]:ke[1]&&ke[1]["color"]},displayName:Xe||ke[1]&&ke[1]["legendText"]},{callback:function(e){if(e&&(e[He]==="0"||e[He]===0)){return true}},properties:{color:ke instanceof Array&&Ge.length?Ge[0]:ke[0]&&ke[0]["color"]},displayName:We||ke[0]&&ke[0]["legendText"]}]};var Ze;if(r&&r.getProperty("/bInsightEnabled")){Ze=m({},M.plotArea.dataPointStyle);var Je=Ee&&Ee[ze]&&Ee[ze][_.TYPE_KEY]||"";Ze.rules.forEach(function(e,t,a){delete e["callback"];e.dataContext={};if(Je){e.dataContext[He]=Je==="Edm.String"?a.length-1-t+"":a.length-1-t}else{e.dataContext[He]=a.length-1-t+""}})}}}var et=false;var tt=false;if(c.ChartType.$EnumMember===_.SCATTER_CHARTTYPE||c.ChartType.$EnumMember===_.BUBBLE_CHARTTYPE||c.ChartType.$EnumMember===_.LINE_CHARTTYPE){if(c&&c.AxisScaling&&c.AxisScaling.RecordType=="com.sap.vocabularies.UI.v1.ChartAxisScalingType"){var at=c.AxisScaling;if(at.AutoScaleBehavior&&at.AutoScaleBehavior.RecordType=="com.sap.vocabularies.UI.v1.ChartAxisAutoScaleBehaviorType"){var rt=at.AutoScaleBehavior;if(rt.ZeroAlwaysVisible&&rt.ZeroAlwaysVisible=="true"){M.plotArea.adjustScale=false;et=true}else if(rt.DataScope){M.plotArea.adjustScale=true;et=true}}else if(at.RecordType=="com.sap.vocabularies.UI.v1.ChartAxisScalingType"&&at.ScaleBehavior&&at.ScaleBehavior.$EnumMember){var it=at.ScaleBehavior.$EnumMember;var nt=it.substring(it.lastIndexOf("/")+1,it.length);if(nt=="FixedScale"){tt=true}}}else if(c&&c.AxisScaling&&c.AxisScaling.$EnumMember){var ot=c.AxisScaling.$EnumMember.substring(c.AxisScaling.$EnumMember.lastIndexOf("/")+1,c.AxisScaling.$EnumMember.length);switch(ot){case"AdjustToDataIncluding0":M.plotArea.adjustScale=false;et=true;break;case"AdjustToData":M.plotArea.adjustScale=true;et=true;break;case"MinMaxValues":tt=true;break;default:break}}if(tt){var st=[];if(c["MeasureAttributes"][0]&&c["MeasureAttributes"][0].DataPoint&&c["MeasureAttributes"][0].DataPoint.AnnotationPath){var lt=c["MeasureAttributes"][0].DataPoint.AnnotationPath;var ut=lt.substring(lt.lastIndexOf("@")+1,lt.length);if(i&&i[ut]){var ft=i[ut];if(ft&&ft.MaximumValue&&ft.MaximumValue&&ft.MinimumValue&&ft.MinimumValue){st.push({feed:"valueAxis",max:ft.MaximumValue,min:ft.MinimumValue});et=true}else{b.error(T.ERROR_MISSING_AXISSCALES)}}}if(c.ChartType.$EnumMember!==_.LINE_CHARTTYPE&&c["MeasureAttributes"][1]&&c["MeasureAttributes"][1].DataPoint&&c["MeasureAttributes"][1].DataPoint.AnnotationPath){var lt=c["MeasureAttributes"][1].DataPoint.AnnotationPath;var ut=lt.substring(lt.lastIndexOf("@")+1,lt.length);if(i&&i[ut]){var ft=i[ut];if(ft&&ft.MaximumValue&&ft.MaximumValue&&ft.MinimumValue&&ft.MinimumValue){st.push({feed:"valueAxis2",max:ft.MaximumValue,min:ft.MinimumValue});et=true}else{b.error(T.ERROR_MISSING_AXISSCALES)}}}e.setVizScales(st)}}L=C.slice();U=I.slice();var ct=0;var vt=0;var pt;var gt;var mt=false;var At=false;var dt;var ht=[];var Pt=[],yt=[];if((d==="column"||d==="bar"||d==="vertical_bullet")&&y.feeds&&y.feeds.length>0){var Et;for(Et=0;Et<y.feeds.length;Et++){if(y.feeds[Et].uid==="color"){y.feeds.splice(Et,1);break}}for(Et=0;Et<y.feeds.length;Et++){if(y.feeds[Et].uid==="categoryAxis"){delete y.feeds[Et].role;break}}if(r.getProperty("/colorPalette")){for(Et=0;Et<y.feeds.length;Et++){if(y.feeds[Et].uid==="categoryAxis"){y.feeds[Et].role="Category";break}}y.feeds.push({uid:"color",min:1,type:"dimension",role:"Series"})}}g(y.feeds,function(t,a){var n=a.uid;var o=[];if(a.type){var s,c,v;if(a.type==="dimension"){s=C.length;c="Dimension";v="dimensions";V=L;K=w}else{s=I.length;c="Measure";v="measures";V=U;K=B}var p=0,m=s;if(a.min){p=p>a.min?p:a.min}if(a.max){m=m<a.max?m:a.max}if(!a.role){var A=V.length;for(var h=0;h<A&&o.length<m;++h){var E=V[h];V.splice(h,1);--A;--h;o.push(E);if(Ee[E[c].$PropertyPath][_.UNIT_KEY_V4_ISOCurrency]){dt=Ee[E[c].$PropertyPath][_.UNIT_KEY_V4_ISOCurrency].$Path?Ee[E[c].$PropertyPath][_.UNIT_KEY_V4_ISOCurrency].$Path:undefined}else if(Ee[E[c].$PropertyPath][_.UNIT_KEY_V4_Unit]){dt=Ee[E[c].$PropertyPath][_.UNIT_KEY_V4_Unit].$Path?Ee[E[c].$PropertyPath][_.UNIT_KEY_V4_Unit].$Path:undefined}else if(Ee[E[c].$PropertyPath][_.UNIT_KEY]){dt=Ee[E[c].$PropertyPath][_.UNIT_KEY]}if(oe(Ee,dt)){mt=true}else{At=true}if(!mt){ct=ie(ct,E,i);pt=ne(pt,E,i)}else{vt=ie(vt,E,i);gt=ne(gt,E,i)}}}else{var N=a.role.split("|");g(N,function(e,t){if(o.length===m){return false}var a=V.length;for(var r=0;r<a&&o.length<m;++r){var n=V[r];if(n&&n.Role&&n.Role.$EnumMember&&n.Role.$EnumMember.split("/")&&n.Role.$EnumMember.split("/")[1]){var s=n.Role.$EnumMember.split("/")[1];if(s===t){V.splice(r,1);--a;--r;o.push(n);if(Ee[n[c].$PropertyPath][_.UNIT_KEY_V4_ISOCurrency]){dt=Ee[n[c].$PropertyPath][_.UNIT_KEY_V4_ISOCurrency].$Path?Ee[n[c].$PropertyPath][_.UNIT_KEY_V4_ISOCurrency].$Path:undefined}else if(Ee[n[c].$PropertyPath][_.UNIT_KEY_V4_Unit]){dt=Ee[n[c].$PropertyPath][_.UNIT_KEY_V4_Unit].$Path?Ee[n[c].$PropertyPath][_.UNIT_KEY_V4_Unit].$Path:undefined}else if(Ee[n[c].$PropertyPath][_.UNIT_KEY]){dt=Ee[n[c].$PropertyPath][_.UNIT_KEY]}if(oe(Ee,dt)){mt=true}else{At=true}if(!mt){ct=ie(ct,n,i);pt=ne(pt,n,i)}else{vt=ie(vt,n,i);gt=ne(gt,n,i)}}}else if((K?Array.prototype.indexOf.call(K,n):-1)===-1){K.push(n)}}});if(o.length<m){g(K,function(e,t){var a;var r;if((a=y[v].defaultRole)&&(N?Array.prototype.indexOf.call(N,a):-1)!==-1&&(r=(V?Array.prototype.indexOf.call(V,t):-1)!==-1)){V.splice(r,1);o.push(t);if(Ee[t[c].$PropertyPath][_.UNIT_KEY_V4_ISOCurrency]){dt=Ee[t[c].$PropertyPath][_.UNIT_KEY_V4_ISOCurrency].$Path?Ee[t[c].$PropertyPath][_.UNIT_KEY_V4_ISOCurrency].$Path:undefined}else if(Ee[t[c].$PropertyPath][_.UNIT_KEY_V4_Unit]){dt=Ee[t[c].$PropertyPath][_.UNIT_KEY_V4_Unit].$Path?Ee[t[c].$PropertyPath][_.UNIT_KEY_V4_Unit].$Path:undefined}else if(Ee[t[c].$PropertyPath][_.UNIT_KEY]){dt=Ee[t[c].$PropertyPath][_.UNIT_KEY]}if(oe(Ee,dt)){mt=true}else{At=true}if(!mt){ct=ie(ct,t,i);pt=ne(pt,t,i)}else{vt=ie(vt,t,i);gt=ne(gt,t,i)}if(o.length===m){return false}}})}if(o.length<p){b.error(T.CARD_ERROR+T.MIN_FEEDS+d+" "+T.FEEDS_OBTAINED+o.length+" "+T.FEEDS_REQUIRED+p+" "+T.FEEDS);return false}}if(o.length){var R=[];var S;if(!(S=e.getDataset())){b.error(T.NO_DATASET);return false}D=i;g(o,function(t,a){if(!a||!a[c]||!a[c].$PropertyPath){b.error(T.INVALID_CHART_ANNO);return false}var i=a[c].$PropertyPath;var o=i;var s=i;var f=null;if(Ee&&Ee[i]){if(Ee[i]["annotations"]){if(Ee[i]["annotations"]["@"+_.LABEL_KEY_V4]){if(Ee[i]["annotations"]["@"+_.LABEL_KEY_V4]instanceof String&&Ee[i]["annotations"]["@"+_.LABEL_KEY_V4]){o=pe(Ee[i]["annotations"]["@"+_.LABEL_KEY_V4],e,Ee)}else if(Ee[i]["annotations"]["@"+_.LABEL_KEY_V4].$Path){o=Ee[i]["annotations"]["@"+_.LABEL_KEY_V4].$Path}else{o=Ee[i]["annotations"]["@"+_.LABEL_KEY_V4]}}else if(Ee[i]["annotations"]["@"+_.LABEL_KEY]){o=Ee[i]["annotations"]["@"+_.LABEL_KEY]}else if(i){o=i}if(Ee[i]["annotations"]["@"+_.TEXT_KEY_V4]){s=Ee[i]["annotations"]["@"+_.TEXT_KEY_V4].$String?Ee[i]["annotations"]["@"+_.TEXT_KEY_V4].$String:Ee[i]["annotations"]["@"+_.TEXT_KEY_V4].$Path}else if(Ee[i]["annotations"]["@"+_.TEXT_KEY]){s=Ee[i]["annotations"]["@"+_.TEXT_KEY]}}else if(i){s=i}f=Ee[i].$Type||null}var v;if((f==="Edm.DateTime"||f==="Edm.DateTimeOffset")&&s===i){v="{path:'"+i+"', formatter: 'sap.ovp.cards.v4.charts.VizAnnotationManager.returnDateFormat'}"}else{if(Ee[i]&&Ee[i]["annotations"]&&Ee[i]["annotations"]["@"+_.TEXT_KEY_V4]&&Ee[i]["annotations"]["@"+_.TEXT_KEY_V4+"@"+_.TEXT_ARRANGEMENT_ANNO]){var p,g;p=Ee[i]["annotations"]["@"+_.TEXT_KEY_V4+"@"+_.TEXT_ARRANGEMENT_ANNO];g=p&&p.$EnumMember;if(!g){p=Ee[i]["annotations"]["@"+_.TEXT_KEY_V4]["@"+_.TEXT_ARRANGEMENT_ANNO];g=p&&p.$EnumMember}if(!g){var m=D;p=m&&m["@"+_.TEXT_ARRANGEMENT_ANNO];g=p&&p.$EnumMember}switch(g){case"com.sap.vocabularies.UI.v1.TextArrangementType/TextFirst":v="{"+s+"}"+" "+"("+"{"+i+"}"+")";break;case"com.sap.vocabularies.UI.v1.TextArrangementType/TextLast":v="{"+i+"}"+" "+"("+"{"+s+"}"+")";break;case"com.sap.vocabularies.UI.v1.TextArrangementType/TextOnly":v="{"+s+"}";break;case"com.sap.vocabularies.UI.v1.TextArrangementType/TextSeperate":v="{"+i+"}"+" "+"("+"{"+s+"}"+")";break;default:v="{"+i+"}";break}}else{v="{"+s+"}"}if(r&&r.getProperty("/bInsightEnabled")){P.setDimensionPath(r.getData().cardId,i,v)}}R.push(o);if(c==="Dimension"){if(n==="waterfallType"){var A=new l({name:o,value:"{"+i+"}"})}else{var A=new l({name:o,value:"{"+i+"}",displayValue:v})}var d=Ee[i][_.SEMANTICS_KEY];var h=O(e.getModel(),de,i);if(k&&(f==="Edm.DateTime"||h||f==="Edm.DateTimeOffset"||d&&d.lastIndexOf("year",0)===0)){A.setDataType("date")}S.addDimension(A);if((yt?Array.prototype.indexOf.call(yt,o):-1)===-1){yt.push(o)}}else{S.addMeasure(new u({name:o,value:"{"+i+"}"}));if((Pt?Array.prototype.indexOf.call(Pt,o):-1)===-1&&n!="bubbleWidth"){Pt.push(o)}}});e.addFeed(new f({uid:n,type:c,values:R}));if(n==="categoryAxis"){M[n]={title:{visible:Le?false:true,text:R.join(", ")},label:{formatString:mt?"CURR":"axisFormatter",truncatedLabelRatio:.15}}}else{M[n]={title:{visible:Le?false:true,text:R.join(", ")},label:{formatString:mt?"CURR":"axisFormatter"}}}ht.push(M[n]);if(y.hasOwnProperty("vizProperties")){var Y=0;var x=y.vizProperties.length;var F;var $;for(;Y<x;Y++){if(y.vizProperties[Y].hasOwnProperty("value")){$=y.vizProperties[Y].value}if(y.vizProperties[Y].hasOwnProperty("path")){F=y.vizProperties[Y].path.split(".");var z=F.length;var H,G;var j;for(var W=0,j=F[0],H=M,G=Oe;W<z;++W){if(W===z-1){if(G&&G.hasOwnProperty(j)){if(d==="donut"&&(G[j]==="value"||G[j]==="percentage")){$=G[j]}else if(d!="donut"){$=G[j]}}if(et&&j!="adjustScale"||!et&&j==="adjustScale"||!et&&j!="adjustScale"){H[j]=$}break}H[j]=H[j]||{};H=H[j];if(G){G[j]=G[j]||{};G=G[j]}j=F[W+1]}}}}if(a.hasOwnProperty("vizProperties")){var t=0;var X=a.vizProperties.length;var q;var Q;var Z;for(;t<X;t++){if(a.vizProperties[t].hasOwnProperty("method")){Q=a.vizProperties[t].method;switch(Q){case"count":q=R.length;if(a.vizProperties[t].hasOwnProperty("min")&&q<=a.vizProperties[t].min){q=a.vizProperties[t].min}else if(a.vizProperties[t].hasOwnProperty("max")&&q>=a.vizProperties[t].max){q=a.vizProperties[t].max}break;default:break}}else if(a.vizProperties[t].hasOwnProperty("value")){q=a.vizProperties[t].value}if(a.vizProperties[t].hasOwnProperty("path")){Z=a.vizProperties[t].path.split(".");var J=Z.length;for(var h=0,ee=Z[0],te=M;h<J;++h){if(h===J-1){te[ee]=q;break}te[ee]=te[ee]||{};te=te[ee];ee=Z[h+1]}}}}}}});var Ct=e.getFeeds();if(y.properties&&y.properties.semanticPattern===true&&$(Ct,d)){g(Ct,function(t,a){if(Ct[t].getType()==="Measure"&&(Ct[t].getUid()==="valueAxis"||Ct[t].getUid()==="actualValues")){var r;g(I,function(e,a){var n=F(a.Measure.$PropertyPath,Ee);if(n===Ct[t].getValues()[0]){r=Y(a,i);return false}});if(r){var n=F(r.Measure.$PropertyPath,Ee);var o=i[r.DataPoint.AnnotationPath.substring(1)].ForecastValue.PropertyPath||i[r.DataPoint.AnnotationPath.substring(1)].ForecastValue.Path;var s=F(o,Ee);var l=v.getText("ACTUAL",[n]);var f=v.getText("FORECAST",[s]);M.plotArea.dataPointStyle={rules:[{dataContext:{MeasureNamesDimension:n},properties:{color:"sapUiChartPaletteSequentialHue1Light1",lineType:"line",lineColor:"sapUiChartPaletteSequentialHue1Light1"},displayName:l},{dataContext:{MeasureNamesDimension:s},properties:{color:"sapUiChartPaletteSequentialHue1Light1",lineType:"dotted",lineColor:"sapUiChartPaletteSequentialHue1Light1",pattern:"diagonalLightStripe"},displayName:f}]};e.getDataset().addMeasure(new u({name:s,value:"{"+o+"}"}));var c=Ct[t].getValues();c.push(s);Ct[t].setValues(c)}return false}})}var _t=false;if(ke&&ke.dimensionSettings&&Object.keys(ke.dimensionSettings).length>0){var Tt=Object.keys(ke.dimensionSettings);for(var It=0;It<Tt.length;It++){var Nt=Tt[It];var Rt=ke.dimensionSettings[Nt];if(Object.keys(Rt).length>10){_t=true;break}}}if(Be&&R.indexOf(c.ChartType.$EnumMember)>=0&&!Boolean(_t)){var Dt=[];var bt=true;for(var It=0;It<C.length;It++){var Ot=C[It].Dimension.$PropertyPath;Dt.push(Ot)}for(var It=0;It<Dt.length;It++){var Nt=Dt[It];if(Tt.indexOf(Nt)>-1){var St=ke.dimensionSettings[Nt];var Mt=Object.keys(St);var Vt=[];for(var It=0;It<Mt.length;It++){var Lt=St[Mt[It]];Vt.push(Lt)}bt=bt&&Vt.every(De)}}if(bt){var Yt=[];for(var It=0;It<Dt.length;It++){var Nt=Dt[It];if(Tt.indexOf(Nt)>-1){var St=ke.dimensionSettings[Nt];var Mt=Object.keys(St);var Vt=[];for(var It=0;It<Mt.length;It++){var Lt=St[Mt[It]];Vt.push(Lt)}Re(Vt);for(var xt=0;xt<Vt.length;xt++){var Ft=Vt[xt].dimensionValue;var $t=Vt[xt].color;var Lt={properties:{color:$t}};Lt.dataContext={};var Ut=fe(Ee,e,Nt);Lt.dataContext[Ut]=Ft;Lt.displayName=Ft;Yt.push(Lt)}}}M.plotArea.dataPointStyle=M.plotArea.dataPointStyle||{};M.plotArea.dataPointStyle["rules"]=Yt}else{var Yt=[];for(var It=0;It<Dt.length;It++){var Nt=Dt[It];if(Tt.indexOf(Nt)>-1){var St=ke.dimensionSettings[Nt];var Mt=Object.keys(St);var Vt=[];for(var It=0;It<Mt.length;It++){var Lt=St[Mt[It]];Vt.push(Lt)}Re(Vt);var Kt=Vt.map(be)}}M.legend.order=function(e,t){var a=Kt.indexOf(e);var r=Kt.indexOf(t);return a>r?1:-1}}}if(y.properties&&y.properties.semanticPattern===true&&$(Ct,d)&&e.getVizType()==="vertical_bullet"){g(Ct,function(t,a){if(Ct[t].getType()==="Measure"&&(Ct[t].getUid()==="valueAxis"||Ct[t].getUid()==="actualValues")){var r;g(I,function(e,a){var n=F(a.Measure.PropertyPath,Ee);if(n===Ct[t].getValues()[0]){r=x(a,i);return false}});if(r){var n=i[r.DataPoint.AnnotationPath.substring(1)].TargetValue.PropertyPath||i[r.DataPoint.AnnotationPath.substring(1)].TargetValue.Path;var o=F(n,Ee);e.getDataset().addMeasure(new u({name:o,value:"{"+n+"}"}));e.addFeed(new f({uid:"targetValues",type:"Measure",values:[o]}))}return false}})}if(mt&&At){b.warning(v.getText("Currency_non_currency_measure"))}g(Ct,function(e,t){var a=t.getProperty("type");if(a==="Measure"){var r=t.getProperty("values");var i=true;var n=c.MeasureAttributes.filter(function(e){var t=e[a].$PropertyPath;var i=Ee[t];return Object.keys(i).length>0&&r.indexOf(t)>=0});g(n,function(e,t){if(se(Ee,t,a)||le(Ee,t,a)){i=false}else{i=true;return false}});if(!i){M[t.getProperty("uid")]["label"]["allowDecimals"]=false}}});var wt;if(gt===undefined){gt=""}if(pt===undefined){pt=""}if(mt){wt=Ae(gt,mt)}else{wt=Ae(pt,mt)}if(t){t.setScale(wt)}var Bt=me(Pt,yt,Ce);var kt="";g(Ct,function(e,t){var a="-1";var r=t.getProperty("type");if(r==="Measure"){var n=ht.filter(function(e){var a=e["title"]["text"].split(",").filter(function(e){if(t.getValues().indexOf(e.trim())>=0){return true}else{return false}});if(a.length>0){return true}else{return false}});if(n&&n.length){var o=t.getValues();if(o&&o.length){g(o,function(e,t){var n=t.trim();var o=I.filter(function(e){if(e["Measure"]&&e["Measure"]["PropertyPath"]){var t=e["Measure"]["PropertyPath"];if(Ee[t]&&Ee[t][_.LABEL_KEY]===n||Ee[t]&&Ee[t][_.LABEL_KEY_V4]===n){return true}else{return false}}});if(o&&o.length){var s=o[0];if(!se(Ee,s,r)&&!le(Ee,s,r)){var l="";if(s&&s["DataPoint"]&&s["DataPoint"]["AnnotationPath"]&&s["DataPoint"]["AnnotationPath"]){l=s["DataPoint"]["AnnotationPath"]&&s["DataPoint"]["AnnotationPath"].substring(1);if(l!=""){var u;u=i[l]&&i[l]["ValueFormat"]&&i[l]["ValueFormat"]["NumberOfFractionalDigits"]&&i[l]["ValueFormat"]["NumberOfFractionalDigits"]["Int"];a=u>a?u:a}}}else{a=a<"0"?"0":a}}})}}if(n&&n[0]&&n[0].label&&n[0].label.formatString){var s=n[0].label.formatString}kt="";if(mt){if(s==="CURR"){kt="CURR/"+a.toString()+"/"}else{kt="axisFormatter/"+a.toString()+"/"}}else{kt="axisFormatter/"+a.toString()+"/"}if(n&&n[0]){n[0].label.formatString=kt}}});if(d==="vertical_bullet"){M["valueAxis"]={title:{visible:Le?false:true},label:{formatString:kt}}}var zt="";var Ht="";if(mt){zt=vt.toString();Ht="CURR/"+vt.toString()+"/"}else{zt=ct.toString();Ht="axisFormatter/"+ct.toString()+"/"}if(d==="donut"||A){M.plotArea.dataLabel.formatString=Ht;if(M.plotArea.dataLabel.type==="percentage"){M.plotArea.dataLabel.formatString="0.0%/"+zt+"/"}}X(L,y,"dimension");X(U,y,"measure");if(k){var Gt=C[0].Dimension.$PropertyPath;var jt=e.getModel().getMetaModel().getObject("/"+de+"/"+Gt+"@");if(jt["@com.sap.vocabularies.Common.v1.IsCalendarYearMonth"]){M.timeAxis.levels=["year","month"]}else if(jt["@com.sap.vocabularies.Common.v1.IsCalendarYearQuarter"]){M.timeAxis.levels=["year","quarter"]}else if(jt["@com.sap.vocabularies.Common.v1.IsCalendarYearWeek"]){M.timeAxis.levels=["year","week"]}else if(jt["@com.sap.vocabularies.Common.v1.IsCalendarYear"]){M.timeAxis.levels=["year"]}}M.title={text:Ce?Ce:Bt,alignment:"left",layout:{respectPlotPosition:false},style:{fontFamily:"72, 72full, Arial, Helvetica, sans-serif !important",fontSize:".875rem",fontWeight:"normal"}};e.setVizProperties(M);if(r&&r.getProperty("/bInsightEnabled")){var Wt=e&&e.getId();var Xt=m({},M);if(Ze!==undefined){Xt.plotArea.dataPointStyle=Ze}P.setVizPropertyMap(Wt,Xt)}}function fe(e,t,a){var r="";if(e&&e[a]){if(e[a].annotations&&e[a].annotations["@"+_.LABEL_KEY_V4]){r=pe(e[a].annotations["@"+_.LABEL_KEY_V4],t,e)}else if(e[a][_.LABEL_KEY]){r=e[a][_.LABEL_KEY]}else if(a){r=a}}return r}function ce(e,t,a){var r="";var i=e&&e["@"+t]&&e["@"+t].Title;if(i){r=i;var n=a.getModel("@i18n")?a.getModel("@i18n"):a.getModel("i18n");if(r.match(/{[@]?i18n>.+}/gi)||r.match(/{[@]?i18n&gt;.+}/gi)){var o=n.getResourceBundle();var s=r.indexOf(">")>-1?r.indexOf(">"):r.indexOf("&gt;")+3;var l=r.substring(s+1,r.length-1);r=o.getText(l)}}return r}function ve(e,t,a){if(e&&(e.getVizType()==="bubble"||e.getVizType()==="scatter")){return}var r,i,n,o;var s;var l=_.UNIT_KEY;var u="@"+_.UNIT_KEY_V4_ISOCurrency;var f="@"+_.UNIT_KEY_V4_Unit;var c;var p=[];if(!(r=e.getModel("ovpCardProperties"))){b.error(T.CARD_ERROR+"in "+T.CARD_CONFIG+T.NO_CARD_MODEL);return}var m=e.getModel();var A=r.getProperty("/entitySet");if(!m||!A){return}i=a[r.getProperty("/entityType").$Type];if(!i){b.error(T.CARD_ANNO_ERROR+"in "+T.CARD_ANNO);return}var d=ge(m,A);n=r.getProperty("/chartAnnotationPath");if(!n||!(o=i["@"+n])){b.error(T.CARD_ANNO_ERROR+"in "+T.CARD_ANNO);return}if(!(s=o.MeasureAttributes)||!s.length){b.error(T.CHART_ANNO_ERROR+"in "+T.CHART_ANNO+" "+T.MEASURES_MANDATORY);return}g(s,function(e,t){c=t.Measure.$PropertyPath;if(t.DataPoint&&t.DataPoint.AnnotationPath){var a=i[t.DataPoint.AnnotationPath.substring(1)];if(a.ForecastValue&&(a.ForecastValue.PropertyPath||a.ForecastValue.Path)){p.push(a.ForecastValue.PropertyPath||a.ForecastValue.Path)}}p.push(c)});var h=t?t:null;var P="";var y=true;var E=[];var C=e.getFeeds();g(C,function(e,t){if(t.getType()==="Measure"){E=E.concat(t.getValues())}});if(h){g(p,function(t,a){var r=fe(d,e,a);if((E?Array.prototype.indexOf.call(E,r):-1)!=-1){if(d&&d[a]){var i;if(d[a].annotations[u]){i=d[a].annotations[u].$Path?d[a].annotations[u].$Path:d[a].annotations[u].$String}else if(d[a].annotations[f]){i=d[a].annotations[f].$Path?d[a].annotations[f].$Path:d[a].annotations[f].$String}else if(d[a][l]){i=d[a][l]}if(!i){y=false;return false}if(i&&d[i]){for(var t=0;t<h.length;t++){var n=h[t];if(y){if(P&&n[i]&&n[i]!=""&&P!=""&&P!=n[i]){y=false;break}}P=n[i];if(!P){y=false;break}}}}}})}var I="";if(y){if(P!=""){I=v.getText("IN_NO_SCALE",[P]);I=" "+I}var N=e.data("aria-label");if(N&&I&&N.indexOf(I)===-1){var R=N+I;e.data("aria-label",R,true)}var D=e.getVizProperties().title&&e.getVizProperties().title.text;if(D){var O=D.indexOf("|");if(O!==-1){var S=D.slice(O+2);if(S!==P){D=D.slice(0,O-1)}}var M={title:{visible:true,text:S===P?D:D+I,alignment:"left",layout:{respectPlotPosition:false},style:{fontFamily:"72, 72full, Arial, Helvetica, sans-serif !important",fontSize:".875rem",fontWeight:"normal"}}};e.setVizProperties(M)}}}function pe(e,t,a){var r;var i;var n;if(e&&e.indexOf("{")===0){e=e.slice(1,-1);if(e.indexOf(">")!=-1){n=e.split(">");r=n[0];i=n[1]}else if(e.indexOf("&gt;")!=-1){n=e.split("&gt;");r=n[0];i=n[1]}try{e=t.getModel(r).getProperty(i)}catch(t){e=a[e][_.LABEL_KEY_V4].String;b.error("Unable to read labels from resource file",t)}}return e}function ge(t,a){var r=e.cacheODataMetadata(t);if(!r){return undefined}return r[a]}function me(e,t,a){var r="",i="",n="";if(a){r=a}if(e&&e.length>1){for(var o=0;o<e.length-1;o++){if(i!=""){i+=", "}i+=e[o]}i=v.getText("MEAS_DIM_TITLE",[i,e[o]])}else if(e){i=e[0]}if(t&&t.length>1){for(var o=0;o<t.length-1;o++){if(n!=""){n+=", "}n+=t[o]}n=v.getText("MEAS_DIM_TITLE",[n,t[o]])}else if(t){n=t[0]}if(r===""){a=v.getText("NO_CHART_TITLE",[i,n])}return a}function Ae(e,t){var r=1;var i;if(t){var n=a.getCurrencyInstance({style:"short",currencyCode:false,shortRefNumber:e});i=n.format(Number(r))}else{var o=a.getFloatInstance({style:"short",shortRefNumber:e});i=o.format(Number(r))}var s=i.slice(-1);return s}function de(e,a){e.attachSelectData(function(i){var n=p.bCRTLPressed?p.constants.explace:p.constants.inplace;p.bCRTLPressed=false;var l=e.getModel("ovpCardProperties");var u=e.getModel();var f=l.getProperty("/entitySet");var c=ge(u,f);var v=[],m=[];var A={},d={};var h=e.getDataset().getDimensions();var P;var E=l.getProperty("/entityType");var C=a.getMetaModel().getData()["$Annotations"];for(var T=0;T<h.length;T++){v.push(h[T].getName())}var I=e.getDataset().getBinding("data").getCurrentContexts().map(function(e){return e.getObject()});if(i.getParameter("data")&&i.getParameter("data")[0]&&i.getParameter("data")[0].data){m=Object.keys(i.getParameter("data")[0].data);P=i.getParameter("data")[0].data._context_row_number;var N=e.getDataset().getBinding("data").getContexts()[P];var R=y.getEntityNavigationEntries(N,u,a.getEntityType(),a.getCardPropertiesModel())[0];if(I[P].$isOthers&&I[P].$isOthers===true){var D={},b=[];for(var O=0;O<v.length;O++){for(var S=0;S<m.length;S++){if(v[O]===m[S]){for(var M in c){if(c.hasOwnProperty(M)){var V=c[M][_.LABEL_KEY]||c[M][_.NAME_KEY]||c[M][_.NAME_CAP_KEY];if(V===m[S]){b.push(M)}}}}}}for(var T=0;T<b.length;T++){D[b[T]]=[];for(var O=0;O<I.length-1;O++){if(O!=P){D[b[T]].push(I[O][b[T]])}}}var L={$isOthers:true};var Y={getObject:function(){return L},getOtherNavigationDimensions:function(){return D}};if(s.checkIfAPIIsUsed(a)){if(a.checkAPINavigation()){o.onContentClicked(Y)}}else{if(R){a.doNavigation(Y,R,n)}}}else{for(var O=0;O<v.length;O++){for(var S=0;S<m.length;S++){if(v[O]===m[S]){for(var M in c){if(C[E.$Type+"/"+M]){var V=typeof C[E.$Type+"/"+M]["@"+_.LABEL_KEY_V4]==="string"&&C[E.$Type+"/"+M]["@"+_.LABEL_KEY_V4]||C[E.$Type+"/"+M][_.LABEL_KEY]||C[E.$Type+"/"+M][_.NAME_KEY]||C[E.$Type+"/"+M][_.NAME_CAP_KEY]||M;if(V.match(/{@i18n>.+}/gi)){var x=this.getModel("@i18n").getResourceBundle();V=x.getText(V.substring(V.indexOf(">")+1,V.length-1))}if(V===m[S]){A[M]=I[P][M]}}}}for(var M in I[P]){if(c.hasOwnProperty(M)){d[M]=I[P][M]}}}}if(A){g(Object.keys(A),function(e,t){var a=c[t]&&c[t]["annotations"];if(c[t]["$Type"]==="Edm.String"){if(c[t]["sap:semantics"]==="yearmonth"||a&&a["@com.sap.vocabularies.Common.v1.IsCalendarYearMonth"]){A[t]=A[t].constructor===Date?r.getDateTimeInstance({pattern:"YYYYMM"}).format(A[t]):A[t]}else if(c[t]["sap:semantics"]==="yearquarter"||a&&a["@com.sap.vocabularies.Common.v1.IsCalendarYearQuarter"]){A[t]=A[t].constructor===Date?r.getDateTimeInstance({pattern:"YYYYQ"}).format(A[t]):A[t]}else if(c[t]["sap:semantics"]==="yearweek"||a&&a["@com.sap.vocabularies.Common.v1.IsCalendarYearWeek"]){A[t]=A[t].constructor===Date?r.getDateTimeInstance({pattern:"YYYYww"}).format(A[t]):A[t]}else if(c[t]["@com.sap.vocabularies.Common.v1.IsFiscalYearPeriod"]){var i=A[t];if(i.includes(".")){A[t]=i.split(".").reverse().join("")}else if(i.includes("/")){A[t]=i.split("/").reverse().join("")}}}})}if(d){g(Object.keys(d),function(e,t){var a=c[t]&&c[t]["annotations"];if(c[t]["$Type"]==="Edm.String"){if(c[t]["sap:semantics"]==="yearmonth"||a&&a["@com.sap.vocabularies.Common.v1.IsCalendarYearMonth"]){d[t]=d[t].constructor===Date?r.getDateTimeInstance({pattern:"YYYYMM"}).format(d[t]):d[t]}else if(c[t]["sap:semantics"]==="yearquarter"||a&&a["@com.sap.vocabularies.Common.v1.IsCalendarYearQuarter"]){d[t]=d[t].constructor===Date?r.getDateTimeInstance({pattern:"YYYYQ"}).format(d[t]):d[t]}else if(c[t]["sap:semantics"]==="yearweek"||a&&a["@com.sap.vocabularies.Common.v1.IsCalendarYearWeek"]){d[t]=d[t].constructor===Date?r.getDateTimeInstance({pattern:"YYYYww"}).format(d[t]):d[t]}else if(c[t]["@com.sap.vocabularies.Common.v1.IsFiscalYearPeriod"]){var i=d[t];if(i.includes(".")){d[t]=i.split(".").reverse().join("")}else if(i.includes("/")){d[t]=i.split("/").reverse().join("")}}}})}var F=E[l.getProperty("/presentationAnnotationPath")];if(E){var $=t.getRequestFields(F);if($&&$.length>0){g($,function(e,t){if(!A.hasOwnProperty(t)){A[t]=I[P][t]}})}}var Y={getObject:function(){return A},getAllData:function(){return d}};if(s.checkIfAPIIsUsed(a)){if(a.checkAPINavigation()){o.onContentClicked(Y)}}else{if(R){a.doNavigation(Y,R,n)}}}}})}function he(e){if(e.$EnumMember.endsWith("Bubble")){return true}else{return false}}function Pe(e){var t=false;if(!e||e.constructor!=Array||e.length<1||e[0].constructor!=Object||!e[0].Dimension||!e[0].Dimension.$PropertyPath){b.error(T.CHART_ANNO_ERROR+"in "+T.CHART_ANNO+" "+T.DIMENSIONS_MANDATORY);return t}t=true;return t}function ye(e){var t=false;if(!e||e.constructor!=Array||e.length<1||e[0].constructor!=Object||!e[0].Measure||!e[0].Measure.$PropertyPath){b.error(T.CHART_ANNO_ERROR+"in "+T.CHART_ANNO+" "+T.MEASURES_MANDATORY);return t}t=true;return t}function Ee(e){e=e["$Type"];return e}function Ce(e){if(e&&e.indexOf("#")!=-1){var t=e.split("#");if(t.length>1){return t[1]}}return""}function _e(e,t){var a=t.getModel("ovpCardProperties");var r=Te(t);var i=+r.itemsLength;var n=+a.getProperty("/dataStep");if(i&&n){var o=e.colSpan-1;if(o>=0){i+=n*o;Ie(t,i)}}}function Te(e){var t=e.getModel("ovpCardProperties");var a=t.getProperty("/entityType");var r=t.getProperty("/presentationAnnotationPath");var i=a.hasOwnProperty(r)&&a[r];var n=i&&i.MaxItems;if(typeof n==="number"||typeof n==="string"&&!isNaN(n)){var o=parseInt(n,10);return{itemsLength:+o,dataStep:+t.getProperty("/dataStep")}}}function Ie(e,t){var a,r={},i=[];var n=e.getVizType();var o=e.getModel("ovpCardProperties");var s=o.getProperty("/entityType");var l=o.getProperty("/chartAnnotationPath");var u=s[l];var f=e.getParent();var v=f.getBinding("data");r.path=v.getPath();r.parameters={};if(v.mParameters&&v.mParameters.select){r.parameters.select=v.mParameters.select}r.parameters.custom=r.parameters.custom||{};r.parameters.custom._requestFrom="ovp_internal";r.filters=v.aApplicationFilters;r.sorter=v.aSorters;r.length=n==="donut"?t+1:t;r.template=new c;f.bindAggregation("data",r);if(n==="donut"){g(u.MeasureAttributes,function(e,t){i.push(t.Measure.PropertyPath)});a={};a.path=v.getPath();a.parameters={};a.parameters.select=i.join(",");a.filters=v.aApplicationFilters;a.sorter=v.aSorters;a.length=1;a.template=new c;f.bindAggregation("aggregateData",a)}f.updateBindingContext()}function Ne(e,t,a){var r=e.getMetaModel().getData().$Annotations;for(var i in t){if(r[a+"/"+i]&&!t[i]["annotations"]){t[i]["annotations"]=r[a+"/"+i]}}}function Re(e){e.sort(function(e,t){if(e.index<t.index){return-1}if(e.index>t.index){return 1}return 0})}function De(e){return e.color!==undefined}function be(e){return e.dimensionValue}return{constants:_,errorMessages:T,formatItems:S,formatByType:U,returnDateFormat:K,formatChartAxes:w,hideDateTimeAxis:B,checkExists:k,validateCardConfiguration:z,checkNoData:H,getConfig:G,hasTimeSemantics:j,getChartType:W,getPrimitiveValue:q,formThePathForCriticalityStateCalculation:J,checkFlag:ae,buildVizAttributes:ue,setChartUoMTitle:ve,getMetadata:ge,getSelectedDataPoint:de,checkBubbleChart:he,dimensionAttrCheck:Pe,measureAttrCheck:ye,getEntitySet:Ee,getAnnotationQualifier:Ce,reprioritizeContent:_e,getMaxItems:Te,getLabelFromAnnotationPath:pe,formGroupByList:V,getChartTitle:ce}},true);
//# sourceMappingURL=VizAnnotationManager.js.map