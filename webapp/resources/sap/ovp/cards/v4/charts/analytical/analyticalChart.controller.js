/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 */
sap.ui.define(["sap/ovp/cards/generic/Card.controller","sap/ovp/cards/v4/charts/VizAnnotationManager","sap/viz/ui5/data/FlattenedDataset","sap/ovp/cards/OVPCardAsAPIUtils","sap/ovp/app/resources","sap/base/util/each","sap/ovp/app/OVPLogger","sap/ovp/cards/Filterhelper","sap/ovp/cards/v4/charts/Utils","sap/ovp/cards/Integration/IntegrationCard","sap/ovp/filter/FilterUtils","sap/ui/core/Fragment","sap/ui/core/Core","sap/ui/Device","sap/ui/dom/units/Rem","sap/ui/model/json/JSONModel","sap/m/MessageBox"],function(t,e,a,i,r,s,o,n,d,l,h,g,p,u,v,c,y){"use strict";var b=new o("OVP.v4.analytical.analyticalChart");return t.extend("sap.ovp.cards.charts.v4.analytical.analyticalChart",{onInit:function(){t.prototype.onInit.apply(this,arguments);var a=this;this.eventhandler=function(t,e,i){h.applyFiltersToV4AnalyticalCard(i,a)};this.GloabalEventBus=p.getEventBus();if(this.oMainComponent&&(this.oMainComponent.isMacroFilterBar||this.oMainComponent.oGlobalFilter)){this.GloabalEventBus.subscribe("OVPGlobalfilter","OVPGlobalFilterSeacrhfired",a.eventhandler)}e.formatChartAxes();this.iPreviousRowSpan=0;var i=new c({error:false});this.getView().setModel(i,"oAnalyticalCardErrorModel");this.bdataLoadedToEnableAddToInsight=false},onBeforeRendering:function(){if(this.bCardProcessed){return}e.validateCardConfiguration(this);var t=this.getView().byId("analyticalChart");var i=this.getOwnerComponent().getComponentData();if(t){t.setHeight("21rem")}if(this.getCardPropertiesModel().getProperty("/layoutDetail")==="resizable"&&i&&i.appComponent){var r=i.appComponent.getDashboardLayoutUtil();var s=r.dashboardLayoutModel.getCardById(i.cardId);if(s.dashboardLayout.autoSpan&&t){t.setHeight("21rem")}}var o=this.getView().byId("vbLayout");var n;var d=false;var l=new a({data:{path:"/"}});this.isVizPropSet=d;this.oDataSet=l;this.vizFrame=t;this.vbLayout=o;if(!t){b.error(e.constants.ERROR_NO_CHART+": ("+this.getView().getId()+")")}else{this.vbLayout.setBusy(true);n=t.getModel("ovpCardProperties").getProperty("/navigation");if(n===undefined||n=="datapointNav"||n!="headerNav"){e.getSelectedDataPoint(t,this)}t.destroyDataset();var h=t.getParent().getBinding("data");this._handleKPIHeader();if(h&&h.getPath()){h.attachDataReceived(this.onDataReceived.bind(this));h.attachDataRequested(this.onDataRequested.bind(this))}else{g.load("sap.ovp.cards.charts.generic.noData").then(function(t){var e=this.getCardContentContainer();e.removeAllItems();e.addItem(t)}.bind(this))}t.addEventDelegate({onmouseover:function(){var e=t._oOvpVizFrameTooltip;if(e){e._oPopup.close()}}})}this.bCardProcessed=true},onAfterRendering:function(){t.prototype.onAfterRendering.apply(this,arguments);if(!i.checkIfAPIIsUsed(this)&&this.getCardPropertiesModel().getProperty("/layoutDetail")==="resizable"){var e=this.oDashboardLayoutUtil.dashboardLayoutModel.getCardById(this.cardId);var a=this.oDashboardLayoutUtil.getCardDomId(this.cardId);var r=document.getElementById(a);var s=this.getHeaderHeight();if(!e.dashboardLayout.autoSpan){if(r){var o=r.getElementsByClassName("sapOvpWrapper")[0];if(o){o.style.height=e.dashboardLayout.rowSpan*this.oDashboardLayoutUtil.ROW_HEIGHT_PX+2-(s+2*this.oDashboardLayoutUtil.CARD_BORDER_PX)+"px"}}}if(e.dashboardLayout.showOnlyHeader){r.classList.add("sapOvpMinHeightContainer")}var d=this.getView().byId("analyticalChart");if(d){d.setHeight(this._calculateVizFrameHeight()+"px");this._calculateWidth()}}if(!i.checkIfAPIIsUsed(this)){var l=this.getCardPropertiesModel();var g=this.getOwnerComponent().getModel("ui").getData().cards;var p=this.getEntitySet()&&this.getEntitySet()["$Type"];var u=p&&this.getMetaModel().getContext("/"+p);if(u){this.selectionVaraintFilter=n.getSelectionVariantFilters(g,l,this.getEntityType())}var v=this.oCardComponentData.mainComponent;var c=[];if(v.getGlobalFilter()){c=v.oGlobalFilter.getFilters()}if(v.getMacroFilterBar()){c=v.aFilters}h.applyFiltersToV4AnalyticalCard(c,this)}},onDataReceived:function(t){if(d.checkIfDataExistInEvent(t)){var a=this;var i=this.getView().byId("analyticalChart");var o=this.getView().byId("bubbleText");var n=r.getText("BUBBLESIZE");var l=a.getMetaModel().getData()["$Annotations"];this.oDataSet.bindData("analyticalmodel>/","");i.setDataset(this.oDataSet);var h=i.getParent();if(!this.isVizPropSet){e.buildVizAttributes(i,h,this);this.isVizPropSet=true;if(o!=undefined){var g=i.getFeeds();s(g,function(t,e){if(g[t].getUid()=="bubbleWidth"){o.setText(n+" "+g[t].getValues())}})}e.hideDateTimeAxis(i)}if(this.getCardPropertiesModel()&&this.getCardPropertiesModel().getData()&&this.getCardPropertiesModel().getData().colorPalette&&i.getVizType()==="stacked_column"){var p=i.getDataset().getDimensions(),v=i.getFeeds(),y,b;for(var f=0;f<v.length;f++){if(v[f].getUid()==="color"){y=v[f].getValues()[0];break}}for(var C=0;C<p.length;C++){if(p[C].getName()===y){b=p[C];break}}if(y&&b){var m={};m["bDescending"]=true;b.setSorter(m)}}var I=t?t.getSource().getCurrentContexts().map(function(t){return t&&t.getObject()}):null;e.setChartUoMTitle(i,I,l);if(this.bFlag==true){this.bFlag=false;this.vbLayout.setBusy(false)}else{setTimeout(function(){a.vbLayout.setBusy(false);a.bdataLoadedToEnableAddToInsight=true},0)}e.checkNoData(t,this.getCardContentContainer(),i);if(u.system.phone){if(this.getCardPropertiesModel().getProperty("/layoutDetail")==="resizable"){var P=this.oDashboardLayoutUtil.dashboardLayoutModel.getCardById(this.cardId);var V=Math.max(P.dashboardLayout.rowSpan,this.iPreviousRowSpan);this.iPreviousRowSpan=V}if(d.isDataSetEmpty(t)){i.setHeight(50+"px")}else{var D=this._calculateVizFrameHeight();if(D!==undefined&&typeof D==="number"){i.setHeight(D+"px")}}}}else if(t&&t.getParameters().error){this.vbLayout.setBusy(false);var w=new c({error:true});this.getView().setModel(w,"oAnalyticalCardErrorModel")}},onDataRequested:function(){this.vbLayout.setBusy(true)},getCardItemsBinding:function(){var t=this.getView().byId("analyticalChart");if(t&&t.getParent()){return t.getParent().getBinding("data")}return null},resizeCard:function(t){var a=this.getCardPropertiesModel();this.newCardLayout=t;a.setProperty("/cardLayout/rowSpan",t.rowSpan);a.setProperty("/cardLayout/colSpan",t.colSpan);var i=this.getCardPropertiesModel().getProperty("/cardLayout");var o=this.getHeaderHeight();var n=this.getView().getDomRef().querySelectorAll(".sapOvpWrapper");for(var d=0;d<n.length;d++){n[d].style.height=t.rowSpan*i.iRowHeightPx+2-(o+2*i.iCardBorderPx)+"px"}var l=this.getView().byId("analyticalChart");var h=this.getView().byId("bubbleText");if(l){if(l.getVizType()==="timeseries_bubble"||l.getVizType()==="bubble"){if(i.colSpan>1){h.setVisible(false)}else{h.setVisible(true)}}l.setHeight(this._calculateVizFrameHeight()+"px");this._calculateWidth()}var g=this.getView().byId("ovpCardContentContainer").getDomRef();if(g){if(!t.showOnlyHeader){g.classList.remove("sapOvpContentHidden")}else{g.classList.add("sapOvpContentHidden")}}var p=r.getText("BUBBLESIZE");this.oDataSet.bindData("analyticalmodel>/","");this.vizFrame.setDataset(this.oDataSet);var u=l.getParent();if(!this.isVizPropSet){e.buildVizAttributes(l,u,this);this.isVizPropSet=true;if(h!=undefined){var v=l.getFeeds();s(v,function(t,e){if(v[t].getUid()=="bubbleWidth"){h.setText(p+" "+v[t].getValues())}})}e.hideDateTimeAxis(l)}e.reprioritizeContent(this.newCardLayout,l)},_calculateVizFrameHeight:function(){var t;if(this.getCardPropertiesModel().getProperty("/layoutDetail")==="resizable"){var e=this.getView().byId("analyticalChart");var a=this.oDashboardLayoutUtil.dashboardLayoutModel.getCardById(this.cardId);var i=this.getView().getController();var r=this.getItemHeight(i,"toolbar");var s=this.getHeaderHeight();var o=(e.getVizType()==="timeseries_bubble"||e.getVizType()==="bubble")&&a.dashboardLayout.colSpan===1?43:0;var n=u.system.phone&&this.iPreviousRowSpan>0?this.iPreviousRowSpan:a.dashboardLayout.rowSpan;t=n*this.oDashboardLayoutUtil.ROW_HEIGHT_PX+2-(s+2*this.oDashboardLayoutUtil.CARD_BORDER_PX+r+o+30);var d=e.sId;var l=this._calculateVizLegendGroupHeight(t);var h=this.getView().byId(d);if(h){h.setVizProperties(l)}}else{t=v.toPx(21)}return t},_calculateVizLegendGroupHeight:function(t){var e;if(t<=270){e=.1}else{var a=240;e=(t-a)/t}var i={legendGroup:{layout:{height:e}}};return i},_calculateWidth:function(){var t=this.oDashboardLayoutUtil.dashboardLayoutModel.getCardById(this.cardId);var e=this.getView().byId("analyticalChart");if(t){var a=parseInt(t.dashboardLayout.width,10);var i=e.getVizType();var r=e.sId;if(i==="donut"){var s=this._calculateVizLegendGroupWidth(a);var o=this.getView().byId(r);if(o){o.setVizProperties(s)}}}},_calculateVizLegendGroupWidth:function(t){var e;if(t<=600){e=.25}else if(t<=900){e=.55}else if(t>=1200){e=.7}else{e=.65}var a={legendGroup:{layout:{maxWidth:e}}};return a},refreshCard:function(){this.getView().rerender()},onShowInsightCardPreview:function(t){var e=this.getView();var a=e.getController();var i=a.oCardComponentData;var s=this;if(this.checkIBNNavigationExistsForCard()){l.showCard({vizFrame:a.vizFrame,entitySet:a.entitySet,entityType:a.entityType,cardComponentName:"Analytical",cardComponentData:i,cardComponent:a.oCardComponent,view:e}).then(function(t){s.saveGeneratedCardManifest(t)})}else{y.error(r.getText("INT_IBN_NAVIGATION_NOT_FOUND_ERROR_MESSAGE_TEXT"))}}})});
//# sourceMappingURL=analyticalChart.controller.js.map