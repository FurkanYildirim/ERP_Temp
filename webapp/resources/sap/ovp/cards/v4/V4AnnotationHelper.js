/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 * Any function that needs to be exported(used outside this file) via namespace should be defined as
 * a function and then added to the return statement at the end of this file
 */
sap.ui.define(["sap/ovp/cards/CommonUtils","sap/ui/model/odata/v4/AnnotationHelper","sap/ovp/cards/MetadataAnalyser","sap/ovp/helpers/V4/MetadataAnalyzer","sap/ovp/cards/AnnotationHelper"],function(e,t,a,r,i){"use strict";var n={TEXT:"com.sap.vocabularies.Common.v1.Text",TEXT_ARRANGEMENT:"com.sap.vocabularies.UI.v1.TextArrangement",UOM:"Org.OData.Measures.V1.Unit",ISO_CURRENCY:"Org.OData.Measures.V1.ISOCurrency"};var o={TEXT_LAST:"com.sap.vocabularies.UI.v1.TextArrangementType/TextLast",TEXT_FIRST:"com.sap.vocabularies.UI.v1.TextArrangementType/TextFirst",TEXT_ONLY:"com.sap.vocabularies.UI.v1.TextArrangementType/TextOnly",TEXT_SEPARATE:"com.sap.vocabularies.UI.v1.TextArrangementType/TextSeparate"};function l(e,t,a){var r=i.getSortedDataFields(e,t)[a];if(r){return c(e,r)}return""}function u(e,t,a,r){var n=i.getSortedDataPoints(e,t)[a];if(!n){return""}var o=e.getSetting("ovpCardProperties");var l=o.getProperty("/entityType");var u=o.getProperty("/metaModel");return g(e,n,l,u,r)}function g(e,t,a,r,i){if(!t||!t.Value){return""}var o=e.getSetting("ovpCardProperties");var l=false;if(o){var u=o.getProperty("/ignoreSapText");l=u==undefined?l:u}var g=r.getData()["$Annotations"][a.$Type+"/"+t.Value.$Path];var s=false;if(l==true){if(g&&(g["@com.sap.vocabularies.Analytics.v1.Measure"]||g["sap:aggregation-role"]=="measure")){s=true}}if(!s&&g){var p;if(g[n.TEXT]){p=g[n.TEXT]?g[n.TEXT]:g[n.TEXT].$Path}else if(g["sap:text"]){p=g["sap:text"]}if(p){t={Value:{$Path:p}}}}return c(e,t,i)}function c(e,a,r,i){if(a.Value.Apply){return t.format(e,a.Value)}var n=e.getSetting("ovpCardProperties");var o=n.getProperty("/entityType");var l=n.getProperty("/metaModel");return p(e,a,o,l,r,i)}c.requiresIContext=true;function s(e,a,r,i){var e=!e.getPath()?e.getInterface(0):e;if(!r||typeof i!=="string"){return i}var l=r.annotations&&r.annotations["@"+n.TEXT];var u=Object.keys(a.$NavigationPropertyBinding);if(!l||u&&u.indexOf(l&&l.$Path&&l.$Path.split("/")[0])===-1){return i}var g,c;g=r.annotations["@"+n.TEXT+"@"+n.TEXT_ARRANGEMENT];c=g&&g.$EnumMember;if(!c){g=l&&l["@"+n.TEXT_ARRANGEMENT];c=g&&g.$EnumMember}if(!c){g=a&&a[n.TEXT_ARRANGEMENT];c=g&&g.$EnumMember}var s=t.format(l,{context:e});if(!s||s===" "){return i}if(!c){return i+" ("+s+")"}var p;switch(c){case o.TEXT_FIRST:p=s+" ("+i+")";break;case o.TEXT_LAST:p=i+" ("+s+")";break;case o.TEXT_ONLY:p=s;break;case o.TEXT_SEPARATE:p=i+" ("+s+")";break;default:p=i;break}return p}function p(e,a,o,l,u,g,c){if(a.Value.Apply){return t.format(e,a.Value)}var p=a.Value.$Path||a.Value.String;var f=i._getEntityTypeForODataV4Model(l,o,p),v="",h,y;var P=e.getSetting("ovpCardProperties");var m=P&&P.getProperty("/contentFragment");if(!g){if(a.Value.$Path&&a.Value.$Path.split("/").length>1){f=i._getNavigationSuffix(l,o,a.Value.$Path,e)}if(!f){return""}if(f.$Type==="Edm.DateTime"||f.$Type==="Edm.DateTimeOffset"){var T={relative:true,relativeScale:"auto"},C=P&&P.getProperty("/showDateInRelativeFormat");if(C!==undefined&&!C){T={style:"medium"}}y={dateFormat:T,bUTC:f.$Type==="Edm.DateTime"?true:false};h="sap.ovp.cards.AnnotationHelper.formatDate";v=i._generatePathForField([a.Value.$Path||p.split("/")[p.split("/").length-1]],h,y)}else if(a.ValueFormat&&a.ValueFormat.NumberOfFractionalDigits>=0||f["scale"]){var d=a.ValueFormat&&a.ValueFormat.NumberOfFractionalDigits||0,$=a.ValueFormat&&a.ValueFormat.ScaleFactor&&a.ValueFormat.ScaleFactor.$Decimal,V;if(f&&f["@"+n.ISO_CURRENCY]){V=f["@"+n.ISO_CURRENCY].$Path||f["@"+n.ISO_CURRENCY]}else if(f&&f["@"+n.UOM]){V=f["@"+n.UOM].$Path||f["@"+n.UOM]}else if(f&&f["@sap:unit"]){V=f["@sap:unit"]}var O=r.getODataPropertyFromV4Metadata(l,o.$Type,V),E=[a.Value.$Path||p.split("/")[p.split("/").length-1]];if(d>2){d=2}y={numberOfFractionalDigits:d,scaleFactor:$,bODataV4:i.isODataV4Context(e)};if(f&&f["@"+n.ISO_CURRENCY]){var R=f["@"+n.ISO_CURRENCY];if(R.$Path){h="sap.ovp.cards.AnnotationHelper.formatCurrency";E.push(R.$Path)}else if(R.String){y.currencyString=R.String;h="sap.ovp.cards.AnnotationHelper.formatCurrency"}}else if(O&&(O[n.ISO_CURRENCY]||O["sap:semantics"]==="currency-code")){h="sap.ovp.cards.AnnotationHelper.formatCurrency";E.push(V)}else{h="sap.ovp.cards.AnnotationHelper.formatNumberCalculation"}y.functionName=h;v=i._generatePathForField(E,h,y)}else{if(c){v=t.format(a.Value,{context:e})}else{var A=t.format(a.Value,e.getModel()?{context:e}:{context:e.getInterface(0)});var x=A.split(",");var S=[];if(x.length>1){for(var D=0;D<x.length;D++){if(x[D].indexOf("path:")>=0||x[D].indexOf("type:")>=0){S.push(x[D])}}if(S.length>0){v=v+S.join(",");if(v.substring(v.length-1)!=="}"){v=v+"}"}}}else{v=A}}}if(m){v=s(e,o,f,v)}if(f&&f["@"+n.UOM]){var I=f["@"+n.UOM];if(I.$Path){v+=" "+i._generatePathForField([I.$Path]);v+=" "+i.getSapTextPathForUOM(I.$Path,l,o,e)}else if(I.String){if(I.String!=="%"){v+=" "}v+=I.String}}}if(!u){if(f&&f["@"+n.ISO_CURRENCY]){var R=f["@"+n.ISO_CURRENCY];if(R){if(R.$Path){v+=" "+i._generatePathForField([R.$Path])}else{v+=" "+R}v+=" "+i.getSapTextPathForUOM(R.$Path,l,o,e)}}}if(v[0]===" "){v=v.substring(1)}v=v.replace("\\","");v=v.replace("\\","");v=v.replace("Unsupported: ","");v=v.replace("$P","p");return v}function f(e,t){var r=e.getSetting("ovpCardProperties");var n=r.getProperty("/metaModel");var o=n.getData();var l=t;var u,g,c,s;if(r.getProperty("/selectionAnnotationPath")){u="@"+r.getProperty("/selectionAnnotationPath");g=o["$Annotations"][l.$Type][u]}if(r.getProperty("/presentationAnnotationPath")){c=r.getProperty("/presentationAnnotationPath");c="@"+c;s=o["$Annotations"][l.$Type][c]}var p="/"+r.getProperty("/entitySet");var f=Array.prototype.slice.call(arguments,2);var h=e.getSetting("ovpCardProperties"),y=h.getProperty("/parameters");if(g||!!y){if(g&&g.Parameters&&g.Parameters.length>0||!!y){p=a.resolveParameterizedEntitySet(e.getSetting("dataModel"),t,g,y)}}if(r.getProperty("/cardLayout")&&r.getProperty("/cardLayout/noOfItems")){var P="{path: '"+p+"', length: "+ +r.getProperty("/cardLayout/noOfItems")}else{var P="{path: '"+p+"', length: "+i._getItemsLength(r)}var m=v(n,l.$Type,f,e);var T=i.checkFilterPreference(r);if(T||m.length>0){P=P+", parameters: {"}if(m.length>0){if(m.length>0){P=P+"$expand: '"+m.join(",")+"'"}if(T){P=P+", "}}if(T){P=P+"custom: {cardId: '"+r.getProperty("/cardId")+"'}"}if(T||m.length>0){P=P+", $count: true}"}else{P=P+", parameters: {$count:true}"}var C=i.getSorters(r,s,true);if(C.length>0){P=P+", sorter:"+JSON.stringify(C)}var d=i.getFilters(r,g,true);if(d.length>0){P=P+", filters:"+JSON.stringify(d)}P=P+"}";return P}f.requiresIContext=true;function v(e,t,a,r){var n=[];var o,l;for(var u=0;u<a.length;u++){if(!a[u]){continue}o=e.getData()["$Annotations"][t]["@"+a[u]];o=o?o:[];for(var g=0;g<o.length;g++){if(o[g].Value&&o[g].Value.$Path){l=i._getNavigationPrefix(e,t,o[g].Value.$Path,r);if(l&&n.indexOf(l)===-1){n.push(l)}}}}return n}function h(e,t,a){return l(e,t,a)}h.requiresIContext=true;function y(e,t,a){return u(e,t,a)}y.requiresIContext=true;function P(e,t,a,r){var n=i.getDataPointsCount(e,t);if(n>0){return y(e,t,a)}else{return h(e,t,r)}}P.requiresIContext=true;function m(e,t,a,r){return u(e,t,a,r)}m.requiresIContext=true;function T(e,t){if(!t){return""}return c(e,t)}T.requiresIContext=true;function C(e,t,a){if(!t){return""}var r=e.getSetting("ovpCardProperties");var n=r.getProperty("/entityType");var o=r.getProperty("/metaModel");var l=Object.assign({},t);var u=Object.assign({},e);t=i._formatValueFromTarget(u,l);return g(e,t,n,o,a)}C.requiresIContext=true;function d(e){var t=e.getObject();var a=e.getModel();var r=a.getProperty("/metaModel");var i="/"+a.getProperty("/entitySet");var n=r.getObject(i);t="/"+n.$Type+"/@"+t;return r.createBindingContext(t)}function $(t,n,o,l){var u;if(o&&o.Value&&o.Value.$Path){u=o.Value.$Path}else if(o&&o.Description&&o.Description.Value&&o.Description.Value.$Path){u=o.Description.Value.$Path}var g="";var c=l&&l.Parameters;var s="";var p=t.getSetting("ovpCardProperties"),f=p.getProperty("/parameters");c=c||!!f;var v=t.getSetting("dataModel");var h=t.getModel(0);var y=r.getEntitySetName(h,n.$Type);if(c){var P=a.resolveParameterizedEntitySet(v,n,l,f);g+="{path: '"+P+"'"}else{g+="{path: '/"+y+"'"}g+=", length: 1";var m=t.getSetting("ovpCardProperties");var T=m.getProperty("/entityType");var C=h.getObject("/"+y+"/");var d,$;for(d in C){if(d.startsWith("$")){continue}$=T.$Type.concat("/",d);C[d].annotations=h.getData(d).$Annotations[$]}var O=i.getFilters(m,l,true);if(O.length>0){s+=", filters: "+JSON.stringify(O)}var E=[];var R=v.oMetaModel.getData().$Annotations;var A;var x=m.getProperty("/measureAggregate");if(x&&x.hasOwnProperty(u)){A=x[u]}else{A=V(u,R,n.$Type)}E.push("'"+u+"Agg' : { 'name' : '"+u+"', 'with' : '"+A+"'}");if(o&&o.Criticality&&o.Criticality.$Path){A=V(o.Criticality.$Path,R,n.$Type);E.push("'"+o.Criticality.$Path+"Agg' : { 'name' : '"+o.Criticality.$Path+"', 'with' : '"+A+"'}")}if(o&&o.CriticalityCalculation&&o.CriticalityCalculation.DeviationRangeLowValue&&o.CriticalityCalculation.DeviationRangeLowValue.$Path){A=V(o.CriticalityCalculation.DeviationRangeLowValue.$Path,R,n.$Type);E.push("'"+o.CriticalityCalculation.DeviationRangeLowValue.$Path+"Agg' : { 'name' : '"+o.CriticalityCalculation.DeviationRangeLowValue.$Path+"', 'with' : '"+A+"'}")}if(o&&o.CriticalityCalculation&&o.CriticalityCalculation.ToleranceRangeLowValue&&o.CriticalityCalculation.ToleranceRangeLowValue.$Path){var A=V(o.CriticalityCalculation.ToleranceRangeLowValue.$Path,R,n.$Type);E.push("'"+o.CriticalityCalculation.ToleranceRangeLowValue.$Path+"Agg' : { 'name' : '"+o.CriticalityCalculation.ToleranceRangeLowValue.$Path+"', 'with' : '"+A+"'}")}if(o&&o.CriticalityCalculation&&o.CriticalityCalculation.DeviationRangeHighValue&&o.CriticalityCalculation.DeviationRangeHighValue.$Path){var A=V(o.CriticalityCalculation.DeviationRangeHighValue.$Path,R,n.$Type);E.push("'"+o.CriticalityCalculation.DeviationRangeHighValue.$Path+"Agg' : { 'name' : '"+o.CriticalityCalculation.DeviationRangeHighValue.$Path+"', 'with' : '"+A+"'}")}if(o&&o.CriticalityCalculation&&o.CriticalityCalculation.ToleranceRangeHighValue&&o.CriticalityCalculation.ToleranceRangeHighValue.$Path){var A=V(o.CriticalityCalculation.ToleranceRangeHighValue.$Path,R,n.$Type);E.push("'"+o.CriticalityCalculation.ToleranceRangeHighValue.$Path+"Agg' : { 'name' : '"+o.CriticalityCalculation.ToleranceRangeHighValue.$Path+"', 'with' : '"+A+"'}")}if(o&&o.TrendCalculation&&o.TrendCalculation.ReferenceValue&&o.TrendCalculation.ReferenceValue.$Path){var A=V(o.TrendCalculation.ReferenceValue.$Path,R,n.$Type);E.push("'"+o.TrendCalculation.ReferenceValue.$Path+"Agg' : { 'name' : '"+o.TrendCalculation.ReferenceValue.$Path+"', 'with' : '"+A+"'}")}var S=i.checkFilterPreference(p);var D=S?", custom: {cardId: '"+p.getProperty("/cardId")+"'}":"";var I=e.getUnitColumnForODataV4(u,h,y);var F=I?", group: {"+I+": {}}":"";var M="parameters:{'$$aggregation' : {'aggregate' : {"+E.join(",")+"}"+F+"}"+D+"}";return g+", "+M+s+"}"}$.requiresIContext=true;function V(e,t,a){var r=t[a+"/"+e];if(r["@Org.OData.Aggregation.V1.default"]){return r["@Org.OData.Aggregation.V1.default"].$EnumMember.split("/")[1].toLowerCase()}return"sum"}function O(e,a){for(var r=0;r<a.length;r++){if(a[r].type.$EnumMember.indexOf("ContactInformationType/work")>=0){var i=t.format(a[r].address,{context:e});return i}}return""}O.requiresIContext=true;function E(e,a){for(var r=0;r<a.length;r++){if(a[r].type.$EnumMember.indexOf("PhoneType/work")>=0){var i=t.format(a[r].uri,{context:e});return i}}return""}E.requiresIContext=true;function R(e,a){for(var r=0;r<a.length;r++){if(a[r].type.$EnumMember.indexOf("PhoneType/cell")>=0){var i=t.format(a[r].uri,{context:e});return i}}return""}R.requiresIContext=true;function A(e,a){for(var r=0;r<a.length;r++){if(a[r].type.$EnumMember.indexOf("PhoneType/fax")>=0){var i=t.format(a[r].uri,{context:e});return i}}return""}A.requiresIContext=true;return{TextArrangementType:o,formatField:c,formatItems:f,formatDataFieldValueOnIndex:h,formatDataPointValueOnIndex:y,formatDataPointOrField:P,formatObjectNumber:m,formatDataFieldValueGeneric:T,formatDataPointValue:C,resolveEntityTypePath:d,getAggregateNumber:$,getEmail:O,getPhone:E,getDevice:R,getPhoneType:A}},true);
//# sourceMappingURL=V4AnnotationHelper.js.map