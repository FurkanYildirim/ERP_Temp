/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 */
sap.ui.define(["sap/fe/navigation/SelectionVariant","sap/ui/model/Filter","sap/ovp/cards/Integration/Helpers/Filters","sap/ovp/app/FilterHelper","sap/base/security/encodeURL","sap/ovp/cards/CommonUtils","sap/ui/model/odata/ODataUtils","sap/ui/model/FilterProcessor","sap/ovp/cards/MetadataAnalyser"],function(t,e,a,r,n,i,l,o,s){"use strict";var u={contentDataUrlUpdated:false,headerDataUrlUpdated:false};function f(t,e){var a=t.split(/\?/);var r=a[1]&&a[1].replace(/^.*\?/,"").split(/&/);var n="";r&&r.forEach(function(t){if(t.indexOf(e)===-1){if(n.length===0){n+=t}else{n+="&"+t}}});return a[0]+(n!==""?"?"+n:"")}function v(t,e){if(t&&e){if(t.indexOf("?")===-1){t+="?"+e}else{t+="&"+e}}return t}function d(t,e){var a=t.split(/\?/);if(a.length>1){var r=a[1].replace(/^.*\?/,"").split(/&/);var n=r.filter(function(t){return t.includes(e)});return n.length===1?n[0]:""}return""}function g(t,e,a,r){if(r){var n=a&&a._oFilterProvider;var l=n&&n._oParameterization;var o=l&&l.getNavigationPropertyToQueryResult();return{_entitySet:{value:l&&l.getName()},_urlSuffix:{value:"/"+o}}}else{var s=e&&e.getModel(),u=s&&s.getMetaModel(),f="";if(!i.isODataV4(s)){var v=u&&u.getODataEntityContainer(),d=t&&t.startsWith("/")?t.substr(1):t,g=v&&v["entitySet"];g=g.filter(function(t){return t&&t.name&&d&&d.startsWith(t.name)});f=g[0]&&g[0].name}else{f=e.oCardComponentData.settings.entitySet}var p=t.split("/").length>2?t.substring(t.lastIndexOf("/")):"";return{_entitySet:{value:f},_urlSuffix:{value:p}}}}function p(t){var e=t.cardComponentData.mainComponent;var a=t.view.getController();var r=e.getGlobalFilter();var n=a.getCardItemsBinding().getPath();var i;if(r&&r.getConsiderAnalyticalParameters()){var l=r.getAnalyticBindingPath();var o=a.getEntitySet().entityType;var u=r.getEntityType();if(l&&l.length>0){if(o===u){i=g(l,a,r,true);return{sPath:l,_entitySet:i._entitySet,_urlSuffix:i._urlSuffix}}}else{var f=a.getCardPropertiesModel().getProperty("/selectionAnnotationPath");var v=t.entityType[f];var d=s.resolveParameterizedEntitySet(a.getModel(),t.entitySet,v);i=g(d,a,r,false);return{sPath:d,_entitySet:i._entitySet,_urlSuffix:i._urlSuffix}}}i=g(n,a,r,false);return{sPath:"",_entitySet:i._entitySet,_urlSuffix:i._urlSuffix}}function c(t,e){var a=e.oMainComponent,r=a.getGlobalFilter(),n=r&&r.getAnalyticBindingPath();var l=e.getModel();var o=l.getMetaModel();if(!i.isODataV4(l)){var s=e.getEntityType().name;var u=o.getODataEntityContainer();var f=u.entitySet.filter(function(t){return t.entityType===u.namespace+"."+s});var v=f.length>0?f[0]:{}}else{var s=e.oCardComponentData.settings.entitySet;var u=o.getObject("/");var v=u[s];v.entityType=v.$Type}if(r&&r.getConsiderAnalyticalParameters()){var n=r.getAnalyticBindingPath();var d,g,p;if(n&&n.length>0){if(v.entityType===r.getEntityType()){g=t;d=t.indexOf("$");if(d>0){g=t.substring(0,d-1)}p=n;if(p.startsWith("/")){p=p.slice(1)}if(g!==p){t=t.replace(g,p)}}else{var c=a._getParametersFromEntityPath(t);var h=a._getParametersFromEntityPath(n);var m,y,_;var U={};if(c&&c.length>0){var D=a._getEntityTypeFromPath(l,t,U.context,true);for(var P=0;P<h.length;P++){m=a._getPropertyMapping(c,h[P].name,D.name,r.getEntityType(),l,r.getModel());if(m){y=m+"=.*?[,)]";_=t.match(new RegExp(y));if(_&&_.length>0){g=_[0].slice(0,-1);p=m+"="+h[P].sValue;if(g!==p){t=t.replace(g,p)}}}}}}}}return t}function h(t,e,a,r){var i=t.view.getModel("ovpCardProperties");var l=i&&i.getProperty("/bInsightRTEnabled");var o="";if(l||r){o+=U(t)}else{o+=m(t,e)}var s=d(a,"$filter");if(s.length>0){s=decodeURIComponent(s);s=s.replace("$filter=","");s=!s.startsWith("(")?"("+s+")":s}if(o.length>0&&s.length>0){o=!o.startsWith("(")?"("+o+")":o;o+=" and "}o+=s;if(o.length!==0){return"$filter="+n(o)}return""}function m(r,n){var i=r.cardComponentData.mainComponent;var l=i.getGlobalFilter();var o=l&&l.getUiState();var s=l&&l.determineMandatoryFilterItems();var u=n.parameters._mandatoryODataFilters.value;var f=new t(o&&o.getSelectionVariant());if(!s||s.length===0||(!u||u.length===0)){return""}else{var v=[];for(var d=0;d<u.length;d++){var g=u[d];var p=f.getSelectOption(g);var c=new e(p);var h=c.aFilters&&c.aFilters.length||0;var m=[];for(var y=0;y<h;y++){var _=c.aFilters[y];var U=a.getSingleFilterValue(_,g);if(U.length>0){m.push(U)}}if(m.length>0){var D=m.join(" or ");D="("+D+")";v.push(D)}}return v.length>0?v.join(" and "):""}}function y(t,e){t&&t.forEach(function(t){if(t&&t.getFilters()){y(t.getFilters(),e)}else if(t&&t.getPath()&&e.indexOf(t.getPath())===-1){e.push(t.getPath())}});return e}function _(t,e){if(t&&e){var a=t&&t.property.filter(function(t){return e.indexOf(t.name)>-1})||[];a.forEach(function(t){var e=t.type||"";if(!e.startsWith("Edm")){t.type="Edm."+t.type}})}}function U(t){var e=t.view;var a=e.getController();var n=a.getEntityType(),i=a.oMainComponent.getGlobalFilter(),s=i&&i.getModel(),u=a.getView().getModel("ovpCardProperties"),f=u&&u.getProperty("/entityType"),v=f&&f.name,d=a.oMainComponent.aFilters;if(n&&s&&v){var g=r.getEntityRelevantFilters(n,d,v,s);if(g.length){var p=o.groupFilters(g),c=y(g,[]),h=e&&e.getModel()&&e.getModel().oMetadata;_(n,c);var m=l.createFilterParams(p,h,n);if(m.length){m=m.replace("$filter=","");m=decodeURIComponent(m);return m}return""}}return""}function D(t,e,a,r){var n=t.view;if(!n){return{}}var l=t.cardComponentData.model.sServiceUrl;var o=n.getController();var s=a?o.getKPIBinding():o.getCardItemsBinding();var u=s&&s.sRangeParams||"";if(t.cardComponentName==="List"||t.cardComponentName==="Table"){u="$skip=0&$top=13"}var g=p(t);var m=s&&s.getDownloadUrl()||"";var y;if(m){m=f(m,"sap-client");m=f(m,"_requestFrom");if(!i.isODataV4(n.getModel())){m=m.split(l+"/")[1]}else{m=m.split(l)[1]}m=c(m,o);y=h(t,e,m,r);if(y.length>0){m=f(m,"$filter");m=v(m,y)}var _=d(m,"$inlinecount");if(_.length===0&&(t.cardComponentName==="List"||t.cardComponentName==="Table")&&!i.isODataV4(n.getModel())){var U="$inlinecount=allpages";m=v(m,U)}if(u){m=v(m,u)}}return{sPath:m,_entitySet:g._entitySet,_urlSuffix:g._urlSuffix}}function P(t,e,a){if(!u.headerDataUrlUpdated){var r=this._getRequestUrlAndEntityInfo(t,e,true,a);e["parameters"]["_headerDataUrl"]={value:r.sPath}}if(!u.contentDataUrlUpdated){var n=this._getRequestUrlAndEntityInfo(t,e,false,a)||"";e["parameters"]["_contentDataUrl"]={value:n.sPath}}u.contentDataUrlUpdated=false;u.headerDataUrlUpdated=false}function S(t,e){var a=t.cardComponentData.settings,r=t.entitySet.name||a.entitySet,n={};if(r.endsWith("Results")){r=r.replace("Results","")}if(a.dataPointAnnotationPath||a.kpiAnnotationPath){var i=this._getRequestUrlAndEntityInfo(t,e,true)||"";e["parameters"]["_headerDataUrl"]={value:i.sPath};if(i.sPath){n.header={method:"GET",url:i.sPath,headers:{Accept:"application/json","Accept-Language":"{{parameters.LOCALE}}"},retryAfter:30}}}var l=this._getRequestUrlAndEntityInfo(t,e,false)||"";e["parameters"]["_contentDataUrl"]={value:l.sPath};if(l.sPath){n.content={method:"GET",url:l.sPath,headers:{Accept:"application/json","Accept-Language":"{{parameters.LOCALE}}"}}}if(l._entitySet||l._urlSuffix){e["parameters"]["_entitySet"]=l._entitySet;e["parameters"]["_urlSuffix"]=l._urlSuffix}return n}function C(t){var e=t.configuration.parameters;var a=e._mandatoryODataParameters.value;var r=e._mandatoryODataFilters.value;var n=r.some(function(t){var a=e[t]&&e[t].value;var r=true;if(a&&i.isJSONData(a)){a=JSON.parse(a);var n=a&&a["SelectOptions"];n.forEach(function(t){if(t&&t["Ranges"]&&t["Ranges"].length>0){r=false}});return r}return false});var l=a.some(function(t){return e[t]&&!e[t].value});if(n||l){if(!e._headerDataUrl){e._headerDataUrl={value:""}}if(!e._contentDataUrl){e._contentDataUrl={value:""}}e._headerDataUrl.value="";e._contentDataUrl.value="";u.headerDataUrlUpdated=true;u.contentDataUrlUpdated=true}}function E(t){var e=t&&t.data&&t.data.request,a=t&&t.configuration.parameters._headerDataUrl,r=t&&t.configuration.parameters._contentDataUrl,n=t.configuration.parameters._semanticDateRangeSetting;if(e&&e.batch&&n){var i=e.batch.header||{},l=e.batch.content||{};i.url="{= extension.formatters.formatHeaderDataUrlForSemanticDate() }";a.value="";l.url="{= extension.formatters.formatContentDataUrlForSemanticDate() }";r.value="";u.headerDataUrlUpdated=true;u.contentDataUrlUpdated=true}else if(e&&e.url&&n){e.url="{= extension.formatters.formatContentDataUrlForSemanticDate() }";r.value="";u.contentDataUrlUpdated=true}}function F(t,e){if(!i.isODataV4(e)){return t}else{return t.replace("d/results","value")}}function O(t,e){if(!i.isODataV4(e)){return t}else{return t.replace("d/__count","@odata.count")}}return{_getQueryParam:d,_removeQueryParam:f,_getRequestUrlAndEntityInfo:D,getBatchObject:S,enhanceHeaderAndContentURL:C,updateBatchObject:P,enhanceHeaderAndContentURLForSemanticDate:E,getBatchRequestPath:F,getBatchResultCount:O}},true);
//# sourceMappingURL=Batch.js.map