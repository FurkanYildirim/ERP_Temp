/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 */
sap.ui.define(["sap/ovp/cards/AnnotationHelper","sap/ui/model/odata/AnnotationHelper","sap/ui/model/odata/v4/AnnotationHelper","sap/ui/core/CustomData","sap/ovp/cards/CommonUtils","sap/fe/navigation/SelectionVariant","sap/fe/navigation/PresentationVariant","sap/ovp/cards/jUtils","sap/base/util/merge","sap/base/util/isPlainObject","sap/base/util/isEmptyObject","sap/ovp/app/OVPLogger","sap/m/MessageToast","sap/ui/core/library","sap/ui/model/FilterOperator","sap/ui/generic/app/library","sap/ui/thirdparty/jquery","sap/ovp/app/resources","sap/m/MessageBox"],function(e,t,a,r,i,n,o,s,l,c,v,p,u,f,m,g,jQuery,d,h){"use strict";var y=new p("OVP.cards.NavigationHelper");var S=f.TextDirection;function P(n,o,s,l,c,v){if(!s){return[]}var p=[];var u=l.getProperty("/template");var f=i.isODataV4(o);if(!c&&!n){if(!v){var m=l.getProperty("/kpiAnnotationPath");if(m&&u==="sap.ovp.cards.charts.analytical"){c=m;var g=s[c];var d=g&&g.Detail;if(d){var h=d.SemanticObject&&d.SemanticObject.String;var S=d.Action&&d.Action.String;if(d.RecordType==="com.sap.vocabularies.UI.v1.KPIDetailType"){if(h&&S){p.push({type:d.RecordType,semanticObject:h,action:S,label:""})}else{y.error("Invalid Semantic object and action configured for annotation "+d.RecordType)}}}else{throw new Error("KPI does not have a KPIDetailType annotation")}}}}if(!c){var v=l.getProperty("/identificationAnnotationPath");var P=v?v.split(","):[];if(P&&P.length>1){c=P[0]}else{c=v}}if(f){c="@"+c}var b=s[c];if(Array.isArray(b)){b=e.sortCollectionByImportance(b);for(var I=0;I<b.length;I++){var F=f?b[I].$Type:b[I].RecordType;var O=f?b[I].Label:b[I].Label&&b[I].Label.String;if(F==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"){var h=f?b[I].SemanticObject:b[I].SemanticObject.String;var S=f?b[I].Action:b[I].Action.String;p.push({type:F,semanticObject:h,action:S,label:O||null})}if(F==="com.sap.vocabularies.UI.v1.DataFieldWithUrl"&&!b[I].Url.UrlRef){var A=o.getMetaModel();var C,D;if(f){C=n?n.getInterface(0).getPath():"/"+l.getInterface().getData().entitySet;var V=A.createBindingContext(C);D=a.format(b[I].Url,{context:V})}else{C=s.$path;var V=A.createBindingContext(C);D=t.format(V,b[I].Url)}var k=new r({key:"url",value:D});if(n&&u==="sap.ovp.cards.charts.analytical"){o=n.getModel()}k.setModel(o);k.setBindingContext(n);var x=k.getValue();var N=f?b[I].Value:b[I].Value.String;p.push({type:F,url:x,value:N,label:O||null})}}}return p}function b(e){if(!e){return false}var t=e.getProperty("/template");var a=e.getProperty("/navigation");return a==="noHeaderNav"&&["sap.ovp.cards.charts.analytical","sap.ovp.cards.charts.smart.chart","sap.ovp.cards.v4.charts.analytical"].indexOf(t)>-1}function I(e,t){var a=i.isODataV4(e);if(t&&t.length){for(var r=0;r<t.length;r++){var n=t[r];var o=a?n.$Type:n.RecordType;if(o==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"||o==="com.sap.vocabularies.UI.v1.DataFieldForAction"||o==="com.sap.vocabularies.UI.v1.DataFieldWithUrl"){return true}}}return false}function F(e,t){var a=i.isODataV4(e);if(t){var r=a?"@com.sap.vocabularies.UI.v1.LineItem":"com.sap.vocabularies.UI.v1.LineItem";var n=t[r];var o=a?n&&n[0].$Type:n&&n[0].RecordType;if(o){return o==="com.sap.vocabularies.UI.v1.DataFieldForAction"||o==="com.sap.vocabularies.UI.v1.DataFieldWithUrl"}}return false}function O(e,t,a){var r=i.isODataV4(e);var n=a&&a.getProperty("/annotationPath");if(t&&n){n=r?"@"+n:n;var o=t[n];return this.isNavigationInAnnotation(e,o)}return false}function A(e,t,a){var r=i.isODataV4(e);var n=a&&a.getProperty("/template");if(t&&a){var o=a.getProperty("/identificationAnnotationPath");var s=o;var l=a.getProperty("/contentFragment");if(l==="sap.ovp.cards.stack.Stack"||l==="sap.ovp.cards.quickview.Quickview"){var c=o?o.split(","):[];if(c&&c.length>1){if(l==="sap.ovp.cards.stack.Stack"){s=c[0]}else{s=c[1]}}}var v=r?t["@"+s]:t[s];if(this.isNavigationInAnnotation(e,v)){return true}if(n==="sap.ovp.cards.charts.analytical"||n==="sap.ovp.cards.v4.charts.analytical"){var p=a.getProperty("/kpiAnnotationPath");if(t&&p){var u=t[p];if(u&&u.Detail){var f=u.Detail.SemanticObject&&u.Detail.SemanticObject.String;var m=u.Detail.Action&&u.Detail.Action.String;if(f&&m){return true}}}}}else if(a&&(n==="sap.ovp.cards.linklist"||n==="sap.ovp.cards.v4.linklist")&&a.getProperty("/staticContent")&&a.getProperty("/targetUri")){return true}return false}function C(e,t){for(var a=0;a<e.property.length;a++){var r=e.property[a]["com.sap.vocabularies.PersonalData.v1.IsPotentiallySensitive"];var i=r&&r.Bool;if(i){t.removeSelectOption(e.property[a].name)}}}function D(e,t){for(var a in e.property){if(typeof e.property[a]==="object"&&e.property[a].$kind==="Property"){var r=e.property[a];var i=r.annotations&&r.annotations["@com.sap.vocabularies.PersonalData.v1.IsPotentiallySensitive"]||false;if(i){t.removeSelectOption(a)}}}}function V(e){var t=e.getParameterNames();for(var a=0;a<t.length;a++){if(e.getParameter(t[a])===""){e.removeParameter(t[a])}}var r=e.getSelectOptionsPropertyNames();for(a=0;a<r.length;a++){var i=e.getSelectOption(r[a]);for(var n=0;n<i.length;n++){if(i[n].Low===""&&!i[n].High){i.splice(n,1);n--}}e.removeSelectOption(r[a]);if(i.length>0){e.massAddSelectOption(r[a],i)}}return e}function k(e,t){var a=e.sFunctionLabel||"";var r={batchGroupId:"Changes",changeSetId:"Changes",urlParameters:t,forceSubmit:true,context:e.oContext,functionImport:e.oFunctionImport};var n=new Promise(function(t,i){var n=e.oContext.getModel();var o;o="/"+r.functionImport.name;n.callFunction(o,{method:r.functionImport.httpMethod,urlParameters:r.urlParameters,batchGroupId:r.batchGroupId,changeSetId:r.changeSetId,headers:r.headers,success:function(e,a){t(a)},error:function(e){e.actionText=a;i(e)}})});n.then(function(e){return u.show(d.getText("Toast_Action_Success"),{duration:1e3})},function(e){var t=i.showODataErrorMessages(e);if(t===""&&e.actionText){t=d.getText("Toast_Action_Error")+' "'+e.actionText+'"'+"."}return h.error(t,{title:d.getText("OVP_GENERIC_ERROR_TITLE"),onClose:null,styleClass:"",initialFocus:null,textDirection:S.Inherit})})}function x(e){var t;if(e&&e.mainComponent){t=e.mainComponent._getFilterPreference(e.cardId)}return t}function N(e,t){var a=[];if(e&&e.filterAll==="card"){a=t.getSelectOptionsPropertyNames()}else if(e&&e.cardFilter){a=e.cardFilter}a.forEach(function(e){if(e!=="$.basicSearch"){t.removeSelectOption(e)}});return t}function E(e,t){var a=true;if(e&&e.filterAll==="global"){a=false}else if(e&&e.globalFilter){if(e.globalFilter.indexOf(t)>=0){a=false}}return a}function L(e,t){var a=e&&e.getUiState({allFilters:false});var r=a?JSON.stringify(a.getSelectionVariant()):"{}";var i=new n(r);var o,s,l,c;var v=this.getFilterPreference();i=this.removeFilterFromGlobalFilters(v,i);var p=t.filters;var u=t.parameters;for(var f=0;f<p.length;f++){o=p[f];if(o.path&&o.operator&&typeof o.value1!=="undefined"){s=o.value1.toString();l=typeof o.value2!=="undefined"?o.value2.toString():undefined;if(this._checkIfCardFiltersAreValid(v,o.path)){i.addSelectOption(o.path,o.sign,o.operator,s,l)}}}var m,g,d;for(var h=0;h<u.length;h++){c=u[h];if(!c.path||!c.value){continue}m=c.path.split("/").pop();m=m.split(".").pop();if(m.indexOf("P_")===0){g=m;d=m.substr(2)}else{g="P_"+m;d=m}if(i.getParameter(g)){continue}if(i.getParameter(d)){continue}i.addParameter(m,c.value)}return i}function T(e,t,a,r,i){if(!e||!t){return}var n;if(a&&a.bStaticLinkListIndex){var o=t.getProperty("/staticContent");n=o[a.iStaticLinkListIndex]["customParams"];a=null}else{n=t.getProperty("/customParams")}if(!n||!e.templateBaseExtension.provideCustomParameter||!e.onCustomParams){return}var p=e.templateBaseExtension.provideCustomParameter(n)?e.templateBaseExtension.provideCustomParameter(n):e.onCustomParams(n);if(!p||!s.checkIfFunction(p)){return}var u=l({},a);var f=l({},r);var m;try{m=p(u,f)}catch(e){y.error("Could not process custom navigation parameters for the card. Plese check the implementation for the custom parameters extension implementation",e)}if(!m||!Array.isArray(m)&&!c(m)){return}var g=c(m);if(g&&v(m)){return}var d=g&&(!!m.bIgnoreEmptyString||!!m.ignoreEmptyString);var h=g?m.aSelectionVariant||m.selectionVariant:m;if(!Array.isArray(h)){return}var S,P,b,I,F,O;P=h.length;for(S=0;S<P;S++){b=h[S];if(!b){continue}I=b.path;F=b.value1;O=b.value2;if(!I||typeof I!=="string"||I===""){y.error("Custom Variant property path '"+I+"' should be valid string");continue}if(!(F||F===0||F===false||F==="")){continue}F=F.toString();O=O&&O.toString();if(a){delete a[I]}if(i){delete i[I]}if(F===""&&d){r.removeSelectOption(I)}r.addSelectOption(I,b.sign,b.operator,F,O)}if(d){this._removeEmptyStringsFromSelectionVariant(r)}return d}function U(t,a,r,s,l,c,v,p){var u={};var f,d,h;var y=r?r.globalFilter:undefined;var S=s&&s.getProperty("/staticContent");var P=i.isODataV4(a);if(!S){var b=e.getCardSelections(s,P);var I=b.filters;var F=b.parameters;I&&I.forEach(function(e){e.path=e.path.replace("/",".");switch(e.operator){case m.NE:e.operator=m.EQ;e.sign="E";break;case m.Contains:e.operator="CP";var t=e.value1;e.value1="*"+t+"*";break;case m.EndsWith:e.operator="CP";var t=e.value1;e.value1="*"+t;break;case m.StartsWith:e.operator="CP";var t=e.value1;e.value1=t+"*"}});b.filters=I;if(p&&c&&c.hasOwnProperty("$isOthers")){var O=p.getOtherNavigationDimensions();for(var A in O){var C=O[A];for(var D=0;D<C.length;D++){b.filters.push({path:A,operator:"EQ",value1:C[D],sign:"E"})}}}F&&F.forEach(function(e){e.path=e.path.replace("/",".")});b.parameters=F;var V=e.getCardSorters(s,P);if(c){var A;for(var D=0;l.property&&D<l.property.length;D++){A=l.property[D].name;var k=c[A];if(c.hasOwnProperty(A)){if(Array.isArray(c[A])&&c[A].length===1){u[A]=c[A][0]}else if(jQuery.type(k)!=="object"){u[A]=k}}}}var x=s&&s.getProperty("/kpiAnnotationPath");var N=s&&s.getProperty("/template");if(x&&N==="sap.ovp.cards.charts.analytical"){var E=l[x];var L=E&&E.Detail;if(L&&L.RecordType==="com.sap.vocabularies.UI.v1.KPIDetailType"){u["kpiID"]=E.ID.String}}d=V&&new o(V);f=this._buildSelectionVariant(y,b);h=s&&s.getProperty("/staticParameters")}else{var T=y&&y.getUiState({allFilters:false});var U=T?JSON.stringify(T.getSelectionVariant()):"{}";f=new n(U);var _=r||null;var w=this.getFilterPreference(_);f=this.removeFilterFromGlobalFilters(w,f);if(S[v.iStaticLinkListIndex].params){h=S[v.iStaticLinkListIndex].params}else if(S[v.iStaticLinkListIndex].staticParameters){h=S[v.iStaticLinkListIndex].staticParameters}}var j;if(v&&!v.bStaticLinkListIndex){j=this.processCustomParameters(t,s,v,f,u)}else if(v&&v.bStaticLinkListIndex){j=this.processCustomParameters(t,s,v,f)}else{j=this.processCustomParameters(t,s,u,f)}var M=j?g.navigation.service.SuppressionBehavior.ignoreEmptyString:undefined;if(h){for(var A in h){if(!u.hasOwnProperty(A)){u[A]=h[A]}}}var B=i.getNavigationHandler();var R=B&&B.mixAttributesAndSelectionVariant(u,f.toJSONString(),M);if(!S){if(P){this._removeSensitiveAttributesFromNavSelectionVariantForODataV4Model(l,R)}else{this._removeSensitiveAttributesFromNavSelectionVariantForODataV2Model(l,R)}}return{sNavSelectionVariant:R?R.toJSONString():null,sNavPresentationVariant:d?d.toJSONString():null}}return{_checkIfCardFiltersAreValid:E,processCustomParameters:T,_removeSensitiveAttributesFromNavSelectionVariantForODataV2Model:C,_removeSensitiveAttributesFromNavSelectionVariantForODataV4Model:D,_removeEmptyStringsFromSelectionVariant:V,_buildSelectionVariant:L,getEntityNavigationEntries:P,checkHeaderNavigationDisabledForAnalyticalCard:b,isNavigationInAnnotation:I,checkNavigationForLinkedList:F,checkLineItemNavigation:O,checkNavigation:A,callFunction:k,getFilterPreference:x,removeFilterFromGlobalFilters:N,getEntityNavigationParameters:U}});
//# sourceMappingURL=NavigationHelper.js.map