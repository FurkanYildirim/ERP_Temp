/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 */
sap.ui.define(["sap/fe/core/AppComponent","sap/base/util/ObjectPath","sap/ui/model/json/JSONModel","sap/ovp/ui/DashboardLayoutUtil","sap/ui/core/mvc/ViewType","sap/ui/model/resource/ResourceModel","sap/ovp/app/resources","sap/ui/core/CustomData","sap/base/util/merge","sap/base/util/isEmptyObject","sap/ovp/app/OVPLogger","sap/ui/Device","sap/ovp/cards/CommonUtils","sap/ovp/placeholder/placeholderHelper","sap/m/App","sap/m/DynamicDateUtil","sap/ovp/cards/MetadataAnalyser","sap/ovp/cards/charts/VizAnnotationManager","sap/ui/core/mvc/XMLView","sap/ui/core/Core","sap/insights/CardHelper","sap/ui/VersionInfo","sap/suite/ui/commons/collaboration/CollaborationHelper","sap/ui/rta/RuntimeAuthoring"],function(e,t,i,r,n,a,o,s,l,u,p,g,f,c,d,h,v,y,m,b,C,P,E,S){"use strict";var T=new p("OVP.app.Component");return e.extend("sap.ovp.app.Component",{metadata:{manifest:"json",routing:{config:{routerClass:"sap.m.routing.Router"},targets:{},routes:[]},properties:{cardContainerFragment:{type:"string",defaultValue:"sap.ovp.app.CardContainer"},dashboardLayoutUtil:{type:"sap.ovp.ui.DashboardLayoutUtil"},designtimePath:{type:"string",defaultValue:"sap/ovp/ui/OVPWrapper.designtime"}},designtime:{actions:{},tool:{start:function(e){var t=e.getModel("ui");if(t){t.setProperty("/bRTAActive",true)}},stop:function(e){var t=e.getModel("ui");if(t){t.setProperty("/bRTAActive",false)}}},aggregations:{rootControl:{actions:{},propagateMetadata:function(){return{}}}}},version:"1.115.0",library:"sap.ovp.app",dependencies:{libs:["sap.ovp"],components:[]},config:{fullWidth:true,hideLightBackground:true}},onServicesStarted:function(){},getRoutingService:function(){return{beforeExit:function(){}}},_getOvpCardOriginalConfig:function(e){var t=this.getOvpConfig();return t.cards[e]},suspend:function(){},restore:function(){var e=this.ovpConfig.cards,t=this.createId("mainView"),i=this.byId(t);var r=this.ovpConfig.refreshStrategyOnAppRestore&&this.ovpConfig.refreshStrategyOnAppRestore.entitySets;if(typeof r==="object"){var n=Object.keys(r);var a=e.filter(function(e){return n.includes(e.settings.entitySet)});for(var o=0;o<a.length;o++){var s=a[o];var l=i.createId(s.id);var u=this.byId(l);var p=u.getComponentInstance()&&u.getComponentInstance().getRootControl()&&u.getComponentInstance().getRootControl().getController();if(p){p.refreshCardContent()}}}y.formatChartAxes()},getOvpConfig:function(){var e;var t=[];var i=this.getMetadata();while(i&&i.getComponentName()!=="sap.ovp.app"){e=i.getManifestEntry("sap.ovp");if(e){t.unshift(e)}i=i.getParent()}t.unshift({});t.unshift(true);e=l.apply(l,t);return e},_removeExtraArrayElements:function(e,t){var i=e["staticContent"],r=t["staticContent"],n=e["tabs"],a=t["tabs"];if(i&&r){if(i.length>r.length){e["staticContent"].splice(r.length,i.length-r.length)}}if(n&&a){if(n.length>a.length){e["tabs"].splice(a.length,n.length-a.length)}}},_emptyAllArrayElements:function(e,t){var i=e["staticContent"],r=t["staticContent"],n=e["tabs"],a=t["tabs"];if(i&&r){for(var o=0;o<i.length;o++){e["staticContent"][o]={}}}if(n&&a){for(var o=0;o<n.length;o++){e["tabs"][o]={}}}},_mergeObjects:function(e,t){for(var i in t){if(t.hasOwnProperty(i)){var r=t[i];if(typeof r=="object"&&e[i]){if(r.operation==="DELETE"){delete e[i]}else{this._mergeObjects(e[i],r)}}else{if(typeof r=="object"&&!e[i]&&r.operation==="DELETE"){continue}e[i]=r}}}return e},_mergeLayerObject:function(e,t){if(!e[t+".settings"]){return e}var i=l({},e["settings"]),r=l({},e[t+".settings"]);this._removeExtraArrayElements(i,r);this._emptyAllArrayElements(i,r);e["settings"]=this._mergeObjects(i,r);return e},_mergeKeyUserChanges:function(e){if(!e.hasOwnProperty("customer.settings")&&!e.hasOwnProperty("customer_base.settings")&&!e.hasOwnProperty("vendor.settings")){return e}e=this._mergeLayerObject(e,"vendor");e=this._mergeLayerObject(e,"customer_base");e=this._mergeLayerObject(e,"customer");return e},_getFullyQualifiedNameForEntity:function(e,t){var i="",r;if(!e){return""}if(e.indexOf(".")>-1){return e}var n=t.getMetaModel();if(f.isODataV4(t)){var a=n.getObject("/");var o=a[e];i=o.$Type;return i}else{var s=n&&n.getODataEntityContainer();i=s&&s.namespace;if(i&&!(e.indexOf(i)>-1)){r=i+"."+e}else{r=e}return r}},_getDatePropertiesFromEntitySet:function(e,t,i){var r=[],n=[];var a=e.getMetaModel();var o=a&&a.getODataEntityContainer();var s=o.entitySet.filter(function(e){return e.entityType===i});var l=s.length>0?s[0]:{};var p=v.checkAnalyticalParameterisedEntitySet(e,l.name);if(p){var g=v.getParametersByEntitySet(e,l.name);if(g.entitySetName){r=v.getPropertyOfEntitySet(e,g.entitySetName);r.forEach(function(e){e._filterRestriction="single-value"})}}r=r.concat(t.property);for(var c in r){var d={};if(f.isDate(r[c])){d.PropertyPath=r[c].name}if(!u(d)){n.push(d)}}return n},_getAllControlConfiguration:function(e,t,i){for(var r=0;r<e.length;r++){if(i[e[r].PropertyPath]){var n=false;for(var a=0;a<t.length;a++){if(t[a].PropertyPath===e[r].PropertyPath){n=true}}if(!n){e[r].bNotPartOfSelectionField=true;t.push(e[r])}}}return t},_getSettingsForDateProperties:function(e,t){var i={};for(var r in e){if(t.fields&&t.fields[e[r].PropertyPath]){i[e[r].PropertyPath]=this.getConditionTypeForDateSetting(t.fields[e[r].PropertyPath])}else{if(t.customDateRangeImplementation||t.filter||t.selectedValues){i[e[r].PropertyPath]=this.getConditionTypeForDateSetting(t)}}}return i},getConditionTypeForDateSetting:function(e){if(e.customDateRangeImplementation){return{customDateRangeImplementation:e.customDateRangeImplementation}}else if(e.filter){return{filter:e.filter}}else if(e.selectedValues){return{selectedValues:e.selectedValues,exclude:e.exclude!==undefined?e.exclude:true}}else if(e.defaultValue){return{defaultValue:e.defaultValue}}return undefined},createXMLView:function(e){if(this.getRouter()){this.getRouter().initialize()}var a=this.getMetadata().getManifestEntry("sap.app");var o=this.getMetadata().getManifestEntry("sap.ui");var p=t.get("icons.icon",o);var c=this.getModel(e.globalFilterModel);var d=c&&c.getMetaModel();this.setModel(c);var v=this.getMetadata().getComponentName();var y=v.replace(/\./g,"/");e.baseUrl=sap.ui.require.toUrl(y);e.useMacroFilterBar=c?f.isODataV4(c):false;if(e.smartVariantRequired===undefined||e.smartVariantRequired===null){e.smartVariantRequired=true}if(e.enableLiveFilter===undefined||e.enableLiveFilter===null){e.enableLiveFilter=true}if(e.showDateInRelativeFormat===undefined||e.showDateInRelativeFormat===null){e.showDateInRelativeFormat=true}if(e.filterSettings&&e.filterSettings.dateSettings&&e.filterSettings.dateSettings.useDateRange!==undefined&&e.useDateRangeType!==undefined){throw new Error("Defining both useDateRange and useDateRangeType in the manifest is not allowed")}e.useDateRangeType=e.filterSettings&&e.filterSettings.dateSettings&&e.filterSettings.dateSettings.useDateRange!==undefined?e.filterSettings.dateSettings.useDateRange:e.useDateRangeType;if(e.useDateRangeType===undefined||e.useDateRangeType===null){e.useDateRangeType=false}if(e.bHeaderExpanded===undefined||e.bHeaderExpanded===null){e.bHeaderExpanded=g.system.desktop?true:false}if(e.chartSettings===undefined||e.chartSettings===null){e.chartSettings={}}if(e.chartSettings.showDataLabel===undefined||e.chartSettings.showDataLabel===null){e.chartSettings.showDataLabel=false}if(e.globalFilterEntitySet&&e.globalFilterEntitySet!==" "){var b=d&&d.getODataEntitySet(e.globalFilterEntitySet);e.globalFilterEntityType=b&&b.entityType}var C=e.globalFilterEntityType;if(e.globalFilterEntityType&&e.globalFilterEntityType!==" "&&e.globalFilterEntityType.length>0){e.globalFilterEntityType=this._getFullyQualifiedNameForEntity(e.globalFilterEntityType,c);e.globalFilterEntityTypeNQ=e.globalFilterEntityType.split(".").pop()}var P=new i(e);var E=S.willRTAStartAfterReload();P.setProperty("/bRTAActive",E);P.setProperty("/applicationId",t.get("id",a));P.setProperty("/title",t.get("title",a));P.setProperty("/description",t.get("description",a));if(e.globalFilterEntityType){var T,O;if(f.isODataV4(c)){T=d.getObject("/"+e.globalFilterEntityType+"@com.sap.vocabularies.UI.v1.SelectionFields");O=d.getObject("/"+e.globalFilterEntityType);P.setProperty("/mainEntityVersion","ODataV4")}else{O=d.getODataEntityType(e.globalFilterEntityType);T=l([],O["com.sap.vocabularies.UI.v1.SelectionFields"]);P.setProperty("/mainEntityVersion","ODataV2");if(e.filterSettings&&e.filterSettings.dateSettings){var F=this._getDatePropertiesFromEntitySet(c,O,e.globalFilterEntityType);var D=this._getSettingsForDateProperties(F,e.filterSettings.dateSettings);if(P.getProperty("/useDateRangeType")&&D&&!u(D)){P.setProperty("/useDateRangeType",false);F.forEach(function(e){if(!D.hasOwnProperty(e["PropertyPath"])||!D[e["PropertyPath"]]){var t=e["PropertyPath"];D[t]={selectedValues:h.getAllOptionKeys().toString(),exclude:false}}})}T=this._getAllControlConfiguration(F,T,D);P.setProperty("/datePropertiesSettings",D)}}P.setProperty("/allControlConfiguration",T);P.setProperty("/mainEntityType",O)}if(p){if(p.indexOf("sap-icon")<0&&p.charAt(0)!=="/"){p=e.baseUrl+"/"+p}P.setProperty("/icon",p)}var _=e.cards;var R=[];var A;for(var M in _){if(_.hasOwnProperty(M)&&_[M]){A=this._mergeKeyUserChanges(_[M]);A.id=M;R.push(A)}}R.sort(function(e,t){if(e.id<t.id){return-1}else if(e.id>t.id){return 1}else{return 0}});P.setProperty("/cards",R);if(this.inResizableTestMode()===true){e.containerLayout="resizable"}if(e.containerLayout&&e.containerLayout==="resizable"){P.setProperty("/cardContainerFragment","sap.ovp.app.DashboardCardContainer");P.setProperty("/dashboardLayout",e.resizableLayout);var w=new r(P);this.setDashboardLayoutUtil(w)}else{P.setProperty("/cardContainerFragment",this.getCardContainerFragment())}this.setModel(P,"ui");var V=this._getOvpLibResourceBundle();this.setModel(V,"ovplibResourceBundle");var O;if(f.isODataV4(c)){O="/"+e.globalFilterEntityType}else{O=d&&d.getODataEntityType(e.globalFilterEntityType,true)}var I=this.createId("mainView");var L=new i({});var x=new m(I,{height:"100%",preprocessors:{xml:{bindingContexts:{ui:P.createBindingContext("/"),meta:d.createBindingContext(O),contextPath:d.createBindingContext("/"+C),entitySet:C,converterContext:L.createBindingContext("/")},models:{ui:P,meta:d,contextPath:d,metaModel:d,converterContext:L}}},type:n.XML,viewName:"sap.ovp.app.Main",async:true,customData:[new s({key:"sap-ui-custom-settings",value:{"sap.ui.dt":{designtime:"sap/ovp/ui/OVPWrapper.designtime"}}})]});x.bindElement({path:"/",model:"internal"});return x},_showErrorPage:function(){var e=new m({height:"100%",type:n.XML,viewName:"sap.ovp.app.Error"});var t=this._getOvpLibResourceBundle();e.setModel(t,"ovplibResourceBundle");this.setAggregation("rootControl",e);if(this.oContainer){this.oContainer.invalidate()}},_formParamString:function(e){var t=Object.keys(e);var i;var r="?";for(i=0;i<t.length;i++){r=r+t[i]+"="+e[t[i]]+"&"}return r.slice(0,-1)},_checkForAuthorizationForCards:function(e){var t=b.getConfiguration();var i=t&&t.getDesignMode();if(i){return Promise.resolve(e)}var r=[];var n=[];for(var a in e.cards){var o=e.cards[a];if(o&&o.settings&&o.settings.requireAppAuthorization){n.push(a);r.push({target:{shellHash:o.settings.requireAppAuthorization}})}}if(r.length>0&&sap.ushell&&sap.ushell.Container){return sap.ushell.Container.getServiceAsync("CrossApplicationNavigation").then(function(e){return e.isNavigationSupported(r)}).then(function(t){var i=n.filter(function(e,i){if(!t[i].supported){return e}});for(var r=0;r<i.length;r++){for(var a in e.cards){if(i[r]===a){delete e.cards[a];break}}}return Promise.resolve(e)}).catch(function(e){T.error(e);return Promise.reject(e)})}else{return Promise.resolve(e)}},_checkForAuthorizationForLineItems:function(){return new Promise(function(e,t){var i=[],r=[];var n=this.getOvpConfig();var a=n["cards"];for(var o in a){if(a.hasOwnProperty(o)&&a[o]){var s=a[o];var l=s.settings;if((s.template==="sap.ovp.cards.linklist"||s.template==="sap.ovp.cards.v4.linklist")&&l.listFlavor==="standard"&&l.staticContent){var u=l.staticContent;for(var p=0;p<u.length;p++){if(u[p].semanticObject||u[p].action){var g="#"+u[p].semanticObject+"-"+u[p].action;if(u[p].params){var f=this._formParamString(u[p].params);g=g+f}if(r.indexOf(o)===-1){r.push(o)}if(i.indexOf(g)===-1){i.push(g)}}}}}}this._oCardsWithStaticContent=r;if(sap.ushell&&sap.ushell.Container){sap.ushell.Container.getService("CrossApplicationNavigation").isIntentSupported(i).done(function(t){var i=this.getOvpConfig();for(var r in t){if(t.hasOwnProperty(r)&&t[r].supported===false){for(var n=0;n<this._oCardsWithStaticContent.length;n++){var a=i["cards"][this._oCardsWithStaticContent[n]].settings.staticContent;for(var o=a.length-1;o>=0;o--){var s="#"+a[o].semanticObject+"-"+a[o].action;if(a[o].params){var l=this._formParamString(a[o].params);s=s+l}if(r===s){a.splice(o,1)}}i["cards"][this._oCardsWithStaticContent[n]].settings.staticContent=a}}}delete this._oCardsWithStaticContent;e(i)}.bind(this)).fail(function(e){T.error(e);t(e)})}else{e(n)}}.bind(this))},createContent:function(){if(E&&E.processAndExpandHash&&typeof E.processAndExpandHash==="function"){E.processAndExpandHash().catch(function(e){T.error(e)}).finally(function(){this._createContent()}.bind(this))}else{this._createContent()}},_createContent:function(){var e=this.getOvpConfig();var t=this.getModel(e.globalFilterModel);var i=[this._checkForAuthorizationForLineItems(e),o.pResourcePromise,this._isInsightRTEnabled(),P.load({library:"sap.ui.core"}),this._isTeamsModeActive()];if(f.isODataV4(t)){i.unshift(t&&t.getMetaModel().requestObject("/"+e.globalFilterModel))}else{i.unshift(t&&t.getMetaModel().loaded())}if(t&&!this.getAggregation("rootControl")){Promise.all(i).then(function(e){var t=e[3];this.ovpConfig=e[1];this.ovpConfig.sapUICoreVersionInfo=e[4];this.ovpConfig.isTeamsModeActive=e[5];this.ovpConfig.enableV4Insight=this._isInsightEnabledForV4Cards();if(this._isInsightDTEnabled()){this.ovpConfig.bInsightDTEnabled=true;return Promise.resolve(this.ovpConfig)}else{if(t){this.ovpConfig.bInsightRTEnabled=true}return this._checkForAuthorizationForCards(this.ovpConfig)}}.bind(this)).then(function(e){this.oOvpConfig=e;this.runAsOwner(function(){var e=this.createId("host"),t=new d(e),i=this.createXMLView(this.oOvpConfig);i.loaded().then(function(){if(c.isPlaceHolderEnabled()){t.addPage(i);this.setAggregation("rootControl",t);c.showPlaceholder(t)}else{this.setAggregation("rootControl",i)}this.oContainer.invalidate()}.bind(this))}.bind(this))}.bind(this));if(!f.isODataV4(t)){t.attachMetadataFailed(function(){this._showErrorPage()}.bind(this))}}},_getOvpLibResourceBundle:function(){if(!this.ovplibResourceBundle){var e=b.getLibraryResourceBundle("sap.ovp");this.ovplibResourceBundle=e?new a({bundleUrl:e.oUrlInfo.url,bundle:e}):null}return this.ovplibResourceBundle},createMapForEntityContainer:function(e){var t={};var i=e.entitySet;for(var r=0;r<i.length;r++){t[i[r].name]=i[r].entityType}return t},inResizableTestMode:function(){return this._getQueryParamUpToTop("resizableTest")=="true"},_isInsightEnabledForV4Cards:function(){return this._getQueryParamUpToTop("enable-v4-insight")==="true"},_isInsightDTEnabled:function(){return this._getQueryParamUpToTop("mode")==="myInsight"||this._getQueryParamUpToTop("mode")==="DT"},_isInsightRTEnabled:function(){var e=this._getQueryParamUpToTop("mode")==="RT";return new Promise(function(t,i){if(!C||!C.getServiceAsync){t(e);return}return C.getServiceAsync().then(function(i){t(!!i||e)}).catch(function(i){T.info("Failed to get CardHelperServiceInstance."+i);t(e)})})},_isTeamsModeActive:function(){var e=false;return new Promise(function(t,i){if(E&&E.isTeamsModeActive&&typeof E.isTeamsModeActive==="function"){return E.isTeamsModeActive().then(function(t){e=t}).catch(function(e){T.error("Failed to get Collaboration Helper."+e)}).finally(function(){t(e)})}else{t(e)}})},_getQueryParamUpToTop:function(e){var t=window;var i=this.getQueryParam(t.location.search,e);if(i!=null){return i}if(t==t.parent){return null}t=t.parent;return null},getQueryParam:function(e,t){var i=null;if(!e){return i}if(e.indexOf("?")!=-1){e=e.substring(e.indexOf("?"))}if(e.length>1&&e.indexOf(t)!=-1){e=e.substring(1);var r=e.split("&");for(var n=0;n<r.length;n++){var a=r[n].split("=");if(a[0]==t){i=a[1];break}}}return i}})});
//# sourceMappingURL=Component.js.map