/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 */
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/odata/ODataUtils","sap/ovp/cards/generic/Component","sap/ovp/cards/v4/generic/Component","sap/ui/generic/app/navigation/service/NavigationHandler","sap/ovp/cards/CommonUtils","sap/ovp/cards/PersonalizationUtils","sap/ui/model/Filter","sap/fe/navigation/SelectionVariant","sap/ui/comp/state/UIState","sap/ui/Device","sap/ovp/ui/SmartphoneHeaderToggle","sap/ui/model/odata/v2/ODataModel","sap/ui/model/odata/ODataMetadata","sap/ui/model/analytics/odata4analytics","sap/ovp/support/lib/CommonMethods","sap/ovp/app/resources","sap/ovp/app/TemplateBaseExtension","sap/ui/core/mvc/ControllerExtension","sap/ovp/app/OVPUtils","sap/ovp/app/ShareUtils","sap/base/security/encodeURL","sap/base/util/ObjectPath","sap/ui/thirdparty/jquery","sap/base/util/merge","sap/ui/fl/apply/api/FlexRuntimeInfoAPI","sap/ui/core/CustomData","sap/ovp/app/OVPLogger","sap/base/util/isEmptyObject","sap/ovp/cards/semanticDateRangeTypeHelper","sap/ovp/placeholder/placeholderHelper","sap/ui/core/Component","sap/ui/base/Event","sap/ui/core/Core","sap/ovp/app/ManageCardsUtils"],function(t,e,a,i,r,s,n,o,l,d,h,f,u,g,c,p,v,m,y,b,C,F,P,jQuery,S,M,O,A,V,_,w,E,I,L,D){"use strict";var T=new A("OVP.app.Main");var R="sap.ovp.app.customData",x="sap.ovp.app.extensionData",B;return t.extend("sap.ovp.app.Main",{getCustomAppStateDataExtension:function(t){},restoreCustomAppStateDataExtension:function(t){},getCustomFilters:function(){},onCustomActionPress:function(t){},onCustomParams:function(t){},modifyStartupExtension:function(t){},getCustomMessage:function(t,e){},onBeforeRebindPageExtension:function(){},oRefreshTimer:null,nRefreshInterval:0,filterItemInFocus:null,bFinishedCardsCreationProcess:false,storeIncomingDeltaChanges:function(t){this.deltaCardsInfo=t?t:[]},appendIncomingDeltaChange:function(t){this.deltaChanges.push(t)},templateBaseExtension:m,onInit:function(){this.bDeltaChangesEnabled=false;this.bResetChartAxisFormatter=false;this.deltaChanges=[];this._initFlexibilityPersonalization();this.globalEventBus=L.getEventBus();this.oShareUtils=new C(this);this.oManageCardsUtils=new D(this);this.getView().loaded().then(function(){var t=this.getOwnerComponent();var e=t.getMetadata();if(t&&e&&e.getManifest()){p.setAppComponent(this.getOwnerComponent())}p.setApplicationStatus(p.mApplicationStatus.LOADING);p.publishEvent("elements","ViewRenderingStarted",{});this.oContainer=sap.ushell&&sap.ushell.Container;this.aErrorCards=[];this.oCardsModels={};this.aFilters=[];this.errorHandlingObject={atLeastOneRequestSuccess:false,errorLoadingTimeout:{}};this.sPreviousEntityType="";this.sCurrentEntityType="";this.oLoadedComponents={};this.bGlobalFilterLoaded=false;this.bGoButtonPressed=false;this.bSearchButtonPressed=false;this.fnMacroFilterBarLoaded=undefined;this.isInitialLoading=true;this.isMacroFilterBar;var a=this.getUIModel();this.bDisableErrorPage=a&&a.getProperty("/disableErrorPage");this.oNavigationHandler=this.oNavigationHandler||new r(this);this.getLayout().addStyleClass("ovpLayoutElement");this.oState={};this.oState.oSmartFilterbar=this.byId("ovpGlobalFilter");this._initGlobalFilter();this.oShareUtils.init();s.enable(this,this.oNavigationHandler);this._loadCardComponent("sap.ovp.cards.error");B=this.getView().byId("sapOvpShareButton");if(B){B.attachBrowserEvent("click",function(){this.onShareButtonPress()}.bind(this))}}.bind(this))},onShareButtonPress:function(){if(B&&B.getVisible()&&B.getEnabled()){this.oShareUtils.onShareButtonAvailableAndPressed(B)}},performRecreationOfCard:function(t){t.settings.baseUrl=this._getBaseUrl();this._clearStoredEntities();this._initCardModel(t.model);t=this._getTemplateForChart(t);this._loadCardComponent(t.template);this._createModelViewMap(t);if(t.settings.tabs&&t.settings.selectedKey){var e=t.settings.selectedKey-1;t.settings.measureAggregate=t.settings.tabs[e].measureAggregate}jQuery.when(this.createCard(t)).then(function(){if(this.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){var e=this.getLayout().getDashboardLayoutUtil();if(e){var a=e.getDashboardLayoutModel();var i=a.getCardById(t.id);e._sizeCard(i);a.extractCurrentLayoutVariant()}}}.bind(this))},onExit:function(){this.bResetChartAxisFormatter=true},_getOriginalCardDescriptorById:function(t){if(!t){return null}var e=this.getView().byId(t);var a=e.getComponentInstance();var i=a.getComponentData();var r=i.appComponent;return r._getOvpCardOriginalConfig(t)},recreateCard:function(t){var e=t.cardId;var a=this._getCardFromManifest(e);var i=this._getOriginalCardDescriptorById(e);if(a.template=="sap.ovp.cards.charts.analytical"||a.template=="sap.ovp.cards.charts.smart.chart"||a.template=="sap.ovp.cards.v4.charts.analytical"){a.settings.chartAnnotationPath=t.chartAnnotationPath;a.settings.colorPalette=t.colorPalette;a.settings.bEnableStableColors=t.bEnableStableColors;if(t.navigation){a.settings.navigation=t.navigation}}if(t.entitySet){a.settings.entitySet=t.entitySet}a.settings.annotationPath=t.annotationPath;a.settings.dynamicSubtitleAnnotationPath=t.dynamicSubtitleAnnotationPath;a.settings.presentationAnnotationPath=t.presentationAnnotationPath;a.settings.selectionAnnotationPath=t.selectionAnnotationPath;a.settings.selectionPresentationAnnotationPath=t.selectionPresentationAnnotationPath;a.settings.kpiAnnotationPath=t.kpiAnnotationPath;a.settings.dataPointAnnotationPath=t.dataPointAnnotationPath;a.settings.identificationAnnotationPath=t.identificationAnnotationPath;a.settings.headerAnnotationPath=t.headerAnnotationPath;a.settings.staticParameters=i&&i.settings&&i.settings.staticParameters;if(t.staticParameters){a.settings.staticParameters=t.staticParameters}if(t.customParams){a.settings.customParams=t.customParams}var r=a.settings.selectedKey;a.settings.selectedKey=t.selectedKey;if(a){this.performRecreationOfCard(a)}var s={changeType:"viewSwitch",content:{cardId:t.cardId,selectedKey:t.selectedKey,oldKey:r},isUserDependent:true};n.savePersonalization(s,this.getView())},recreateRTAClonedCard:function(t){var e=this._getCardFromManifest(t.id);if(e){e.settings=t.settings;this.performRecreationOfCard(e)}},onBeforeRendering:function(){},onRequestSent:function(t){this.destroyErrorCardsAndReplaceWithOriginal()},onRequestCompleted:function(t){if(t&&t.getParameters()&&t.getParameters().success){var e=t.getParameters().response&&t.getParameters().response.responseText?JSON.parse(t.getParameters().response.responseText):"";if(e&&e.d&&e.d.results&&e.d.results.length==0){this.fVerifyAndSetErrorOrCustomMessageCard(t,true)}}else if(t&&t.getParameters()&&t.getParameters().response&&t.getParameters().response.statusCode!==0){this.fVerifyAndSetErrorOrCustomMessageCard(t,false)}},fVerifyAndSetErrorOrCustomMessageCard:function(t,a){var i;var r=this.getView().getModel("ui").getProperty("/aOrderedCards");for(i in r){var n=this.getView().byId(r[i].id);var o=n&&n.getComponentInstance();var l=o&&o.getComponentData();var d=o&&o.getRootControl();var h=d&&d.getController();var f=h&&h.getCardItemsBinding();if(f&&!s.isODataV4(h.oView.getModel())){var u=t.getParameters().url;var g=f.sCustomParams;var c=f.sFilterParams;var p=f.sPath.replace("/","");var v=f.sRangeParams;var m=f.sCountMode&&f.sCountMode.indexOf("Inline");var y=f.sSortParams;var b=t.getSource().sServiceUrl;var C=t.oSource&&t.oSource.oMetadata;var F=h.getEntityType();var P=this.getView().getModel();var M=h.oView.getModel();var O=this._getEntityRelevantFilters(F,this.aFilters,M,P);var A;try{A=e.createFilterParams(O,C,F)}catch(t){T.error("applying filter on a card which is not valid")}if(c&&A){c="("+c.replaceAll("$filter=","")+")";A="("+A.replaceAll("$filter=","")+")";c="$filter="+c+"%20and%20"+A}u=u.split(p).join("").split(g).join("").split(c).join("").split(v).join("").split(y).join("").split(b).join("").split(A).join("").split("?").join("").split("&").join("").split("/").join("");if(!m){u=u.split("$inlinecount=allpages").join("")}var V=l&&l.cardId;var _=this._getCardFromManifest(V);if(u){var w=/sap-client=[0-9][0-9][0-9]/i;u=u.replace(w,"")}if(_&&!u){var E=S({},t);var I=S({},_);var L=this.getCustomMessage(E,I.id);L=L&&typeof L==="object"?L:"";if(a&&!L){return}if(L){if(a&&L.hasOwnProperty("sMessage")&&L.sMessage&&typeof L.sMessage==="string"){t.getParameters().response.statusText=L.sMessage;if(L.hasOwnProperty("sIcon")&&L.sIcon&&typeof L.sIcon==="string"&&L.sIcon.indexOf("sap-icon")!==-1){t.getParameters().response.sIcon=L.sIcon}}else if(!a&&L.hasOwnProperty("sMessage")&&L.sMessage&&typeof L.sMessage==="string"){t.getParameters().response.statusText=L.sMessage}}if(this.aErrorCards.indexOf(V)==-1){this.aErrorCards.push(_.id)}else{o.destroy()}this.createErrorCard(_,t)}}}},onAfterRendering:function(){p.setApplicationStatus(p.mApplicationStatus.RENDERED);p.publishEvent("elements","ViewRendered",{});this.oModelViewMap={};this.oAppStatePromise=null;if(this.getView().getModel("ui").getProperty("/refreshIntervalInMinutes")){this.nRefreshInterval=this.getView().getModel("ui").getProperty("/refreshIntervalInMinutes");this.nRefreshInterval=(this.nRefreshInterval<=1?1:this.nRefreshInterval)*6e4}var t=this._getCardsModel();var e=[];var a;for(a in t){if(e.indexOf(t[a].model)==-1){e.push(t[a].model)}}var i=this.getOwnerComponent();if(i){for(a in e){var r=i.getModel(e[a]);if(r&&s.isODataV4(r)){setTimeout(this.destroyErrorCardsAndReplaceWithOriginal.bind(this),0)}else if(r){r.attachRequestCompleted(this.onRequestCompleted.bind(this));r.attachRequestSent(this.onRequestSent.bind(this))}}}if(this.initialized){return}this.initialized=true;Promise.all([this.oFlexibilityPersonalizationPromise,this.oGlobalFilterLoadedPromise]).then(function(){this.isMacroFilterBar=this.getMacroFilterBar()!==undefined;this.getView().byId("ovpFilterNotFulfilledPage").setVisible(false);this.getView().byId("ovpCardPage").setVisible(true);this.persistencyVariantLoaded=true;var t;var e=[],a=[];this.aManifestOrderedCards=this._getCardArrayAsVariantFormat(this.getLayout().getContent());for(var i=0;i<this.aManifestOrderedCards.length;i++){t=this._getCardFromManifest(this.aManifestOrderedCards[i].id);if(t&&t.settings&&t.settings.requireAppAuthorization){e.push({id:t.id,cardIntent:t.settings.requireAppAuthorization});a.push(t.settings.requireAppAuthorization)}}var r=this._mergeLREPContent(this.aManifestOrderedCards);this.getView().getModel("ui").setProperty("/aOrderedCards",r);var s=r.some(function(t){return t.visibility});this.organizeCards(r);if(!s){w.hidePlaceholder()}}.bind(this));if(h.system.phone){f.enable(this)}},organizeCards:function(t){var e;var a=[];this.updateLayoutWithOrderedCards();this.updateDashboardLayoutCards(t);if(this.isDragAndDropEnabled()){if(sap.ushell&&sap.ushell.Container){this._initShowHideCardsButton()}}this._clearStoredEntities();t=this.getView().getModel("ui").getProperty("/aOrderedCards");for(var i=0;i<t.length;i++){if(t[i].visibility){e=this._getCardFromManifest(t[i].id);if(e){a.push(e)}}}for(var i=0;i<a.length;i++){this._initCardModel(a[i].model);this._loadCardComponent(a[i].template);this._createModelViewMap(a[i])}setTimeout(function(){this.getLayout().addStyleClass("ovpLayoutElementShow")}.bind(this),0);var r=this.fGetViewSwitchIndex(a);var s=[];for(var i=0,n=0;n<a.length;i++,n++){while(a[n].id!==t[i].id){i++}e=a[n];if(!e.settings.title){T.error("title is mandatory for card ID : "+e.id)}if(e.settings.tabs){var o=0;var l=r&&r.hasOwnProperty(e.id)?r[e.id]:"";if(l&&typeof l=="number"&&l>0&&l<=e.settings.tabs.length){o=l>=1?l-1:l;this.setOrderedCardsSelectedKey(e.id,l)}else if(t[i].selectedKey&&e.settings.tabs.length>=t[i].selectedKey){o=t[i].selectedKey-1}this.initializeTabbedCard(e,o)}e=this._getTemplateForChart(e);this._loadCardComponent(e.template);e.settings.baseUrl=this._getBaseUrl();s.push(this.createCard(e))}Promise.all(s).then(function(){this.bFinishedCardsCreationProcess=true}.bind(this));if(this.busyDialog){this.busyDialog.close()}},_getTemplateForChart:function(t){if(t.template==="sap.ovp.cards.charts.smart.chart"){var e=this.getView();var a=e.getModel(t.model);var i=a.getMetaModel();var r=i.getODataEntitySet(t.settings.entitySet);var s=i.getODataEntityType(r.entityType);var n;var o;var l;var d=false;var h;if(t&&t.settings){if(!d&&t.settings.kpiAnnotationPath){var f=s[t.settings.kpiAnnotationPath];h=f.Detail.DefaultPresentationVariant&&f.Detail.DefaultPresentationVariant.Path;if(h){l=this._getTemplateForChartFromVisualization(h,t,a,r,s);d=l.bTemplateUpdated;if(d){t=l.oCard;return t}}}if(!d&&t.settings.selectionPresentationAnnotationPath){var u=s[t.settings.selectionPresentationAnnotationPath];if(u){h=u.PresentationVariant&&u.PresentationVariant.Path;if(h){l=this._getTemplateForChartFromVisualization(h,t,a,r,s);d=l.bTemplateUpdated;if(d){t=l.oCard;return t}}}}if(!d&&t.settings.presentationAnnotationPath){h=t.settings.presentationAnnotationPath;l=this._getTemplateForChartFromVisualization(h,t,a,r,s);d=l.bTemplateUpdated;if(d){t=l.oCard;return t}}if(!d&&t.settings.chartAnnotationPath){n=s[t.settings.chartAnnotationPath];o=n&&n.ChartType&&n.ChartType.EnumMember;if(o&&o.split("/")[1]==="Donut"){t.template="sap.ovp.cards.charts.analytical"}else{t.template="sap.ovp.cards.charts.smart.chart"}}}}return t},_getTemplateForChartFromVisualization:function(t,e,a,i,r){if(/^@/.test(t)){t=t.slice(1)}e.settings.presentationAnnotationPath=t;var s=r[t]&&r[t].Visualizations;var n;var o;var l;var d=false;if(s&&s.length>0){for(n=0;n<s.length;n++){var h=s[n].AnnotationPath;if(!h){return{oCard:e,bTemplateUpdated:d}}h.trim();if(h.startsWith("@")){h=h.slice(1)}if(h.indexOf("Chart")!=-1){e.settings.chartAnnotationPath=h;o=r[h];l=o&&o.ChartType&&o.ChartType.EnumMember;if(l&&l.split("/")[1]==="Donut"){e.template="sap.ovp.cards.charts.analytical"}else{e.template="sap.ovp.cards.charts.smart.chart"}}d=true}}return{oCard:e,bTemplateUpdated:d}},_createModelViewMap:function(t){if(!t||!t.settings||!t.model){return}if(!t.settings.entitySet||t.settings.entitySet===""){return}if(!t.template.startsWith("sap.ovp.cards")){return}var e=t.model;if(!this.oModelViewMap[e]){this.oModelViewMap[e]={}}this.oModelViewMap[e][t.id]=true},setTabIndex:function(t){if(typeof t=="object"){this.oTabIndexList=t}else{this.oTabIndexList={}}},getTabIndex:function(){return this.oTabIndexList},fGetViewSwitchIndex:function(t){var e=this.getGlobalFilter();var a=e&&e.getUiState();var i=a&&a.getSelectionVariant()?JSON.stringify(a.getSelectionVariant()):"{}";var r=JSON.parse(i);var s=S({},r);var n=[];if(t&&t.length>0){for(var o=0;o<t.length;o++){var l=S({},t[o]);n.push(l)}}this.onBeforeRebindPageExtension(n,s);return this.getTabIndex()},changeViewSwitchForVisibleCard:function(){var t=this.getView().getModel("ui").getProperty("/aOrderedCards");if(t&&t.length>0){var e=[],a=[];for(var i=0;i<t.length;i++){e.push(this._getCardFromManifest(t[i].id))}var r=this.fGetViewSwitchIndex(e);if(r&&typeof r=="object"){a=Object.keys(r)}if(a&&a.length>0){for(var i=0;i<t.length;i++){if(t[i]&&t[i].visibility==true){var s=this._getCardFromManifest(t[i].id);if(s&&s.settings&&s.settings.tabs&&s.settings.hasOwnProperty("selectedKey")){var n=r&&r.hasOwnProperty(s.id)?r[s.id]:"";var o=s.settings.selectedKey;if(n&&typeof n=="number"&&n<=s.settings.tabs.length&&n!==o){this.setOrderedCardsSelectedKey(s.id,n);var l={};l=s.settings.tabs[n-1];var d={cardId:s.id,selectedKey:n};for(var h in l){d[h]=l[h]}this.recreateCard(d)}}}}}}},setOrderedCardsSelectedKey:function(t,e){var a=this.getView().getModel("ui").getProperty("/aOrderedCards");for(var i=0;i<a.length;i++){if(a[i]&&a[i].id==t){a[i].selectedKey=e;break}}this.getView().getModel("ui").setProperty("/aOrderedCards",a)},getOrderedCardsSelectedKey:function(t){var e=this.getView().getModel("ui").getProperty("/aOrderedCards");for(var a=0;a<e.length;a++){if(e[a]&&e[a].id==t){return e[a].selectedKey}}},initializeTabbedCard:function(t,e){if(t.template=="sap.ovp.cards.charts.analytical"||t.template=="sap.ovp.cards.charts.smart.chart"||t.template=="sap.ovp.cards.v4.charts.analytical"){t.settings.chartAnnotationPath=t.settings.tabs[e].chartAnnotationPath;t.settings.colorPalette=t.settings.tabs[e].colorPalette;t.settings.bEnableStableColors=t.settings.tabs[e].bEnableStableColors;if(t.settings.tabs[e].navigation){t.settings.navigation=t.settings.tabs[e].navigation}}if(t.settings.tabs[e].entitySet){t.settings.entitySet=t.settings.tabs[e].entitySet}t.settings.annotationPath=t.settings.tabs[e].annotationPath;t.settings.dynamicSubtitleAnnotationPath=t.settings.tabs[e].dynamicSubtitleAnnotationPath;t.settings.presentationAnnotationPath=t.settings.tabs[e].presentationAnnotationPath;t.settings.selectionAnnotationPath=t.settings.tabs[e].selectionAnnotationPath;t.settings.selectionPresentationAnnotationPath=t.settings.tabs[e].selectionPresentationAnnotationPath;t.settings.kpiAnnotationPath=t.settings.tabs[e].kpiAnnotationPath;t.settings.dataPointAnnotationPath=t.settings.tabs[e].dataPointAnnotationPath;t.settings.identificationAnnotationPath=t.settings.tabs[e].identificationAnnotationPath;t.settings.params=t.settings.tabs[e].params;t.settings.measureAggregate=t.settings.tabs[e].measureAggregate;t.settings.selectedKey=e+1;if(!t.settings.staticParameters){t.settings.staticParameters=t.settings.tabs[e].staticParameters}if(!t.settings.customParams){t.settings.customParams=t.settings.tabs[e].customParams}},_getLibraryResourceBundle:function(){if(!this.oLibraryResourceBundle){this.oLibraryResourceBundle=L.getLibraryResourceBundle("sap.ovp")}return this.oLibraryResourceBundle},_getOvplibResourceBundle:function(){return this.getOwnerComponent()._getOvpLibResourceBundle()},_getCardsModel:function(){if(!this.oCards){var t=this.getUIModel();this.oCards=t.getProperty("/cards")}return this.oCards},_getBaseUrl:function(){var t=this.getUIModel();if(!this.sBaseUrl){this.sBaseUrl=t.getProperty("/baseUrl")}return this.sBaseUrl},_getApplicationId:function(){var t=this.getUIModel();return t.getProperty("/applicationId")},_getCardFromManifest:function(t){var e=this._getCardsModel();for(var a=0;a<e.length;a++){if(e[a].id===t){return e[a]}}if(!t.includes("ObjectStream")){T.error("Card id "+t+" is not available in the manifest")}return null},_getCardArrayAsVariantFormat:function(t){var e=[];for(var a=0;a<t.length;a++){var i=this._getCardId(t[a].getId());e.push({id:i,visibility:t[a].getVisible()});var r;if(this.getView()&&this.getView().byId){if(this.getView().byId(i).getComponentInstance()){r=this.getView().byId(i).getComponentInstance().getComponentData().settings.selectedKey}}if(r){e[e.length-1].selectedKey=r}}return e},_mergeLREPContent:function(t){var e=[];var a=false;if(this.bDeltaChangesEnabled&&Array.isArray(this.deltaCardsInfo)&&this.deltaCardsInfo.length>0){t=n.addMissingCardsFromManifest(t,this.deltaCardsInfo);a=true}if(this.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){if(!a){t=this.getLayout().getLayoutDataJSON()}e=n.mergeChanges(t,this.deltaChanges);this._bDashboardLayoutLrepActive=true;this.getLayout().getDashboardLayoutModel().setLayoutVars(e)}else{e=n.mergeChanges(t,this.deltaChanges)}return e?e:[]},updateLayoutWithOrderedCards:function(){var t=this.getLayout();var e=this.getView().getModel("ui").getProperty("/aOrderedCards");t.removeAllContent();var a,i=false;if(this.getView().getModel("ui")&&this.getView().getModel("ui").getProperty("/cards")){a=this.getView().getModel("ui").getProperty("/cards");for(var r=0;r<a.length;r++){i=false;for(var s=0;s<e.length;s++){if(a[r].id==e[s].id){i=true;break}}if(!i&&this.getView().byId(a[r].id)){this.getView().byId(a[r].id).destroy()}}}for(var r=0;r<e.length;r++){var n=this.getView().byId(e[r].id);if(n){n.setVisible(e[r].visibility);t.addContent(n)}}},_updateErrorCardsArray:function(t){var e;for(e=0;e<t.length;e++){var a=this.aErrorCards.indexOf(t[e].id);if(a>-1&&t[e].visibility==false){this.aErrorCards.splice(a,1)}}},updateDashboardLayoutCards:function(t){if(this.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){if(this.getLayout().getDashboardLayoutUtil()){this.getLayout().getDashboardLayoutUtil().updateCardVisibility(t)}}},resetDashboardLayout:function(){if(this.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){if(this.getLayout().getDashboardLayoutUtil()){this.getLayout().getDashboardLayoutUtil().resetToManifest()}this.getLayout().rerender()}},_getCardArrayAsVariantFormatDashboard:function(){var t=[];var e=this.getLayout();var a=e.dashboardLayoutUtil.aCards;e.dashboardLayoutUtil.dashboardLayoutModel._sortCardsByRow(a);a.forEach(function(e){t.push({id:e.id,visibility:e.dashboardLayout.visible})});return t},_fnIsLoadDataOnGoButton:function(t){var e=this.getView().byId("ovpFilterNotFulfilledPage");var a;e.setVisible(true);var i=this.getUIModel().getProperty("/smartVariantRequired");if(!i){w.hidePlaceholder();return false}var r=this&&this.getView().byId("ovpMain");if(!this.oState.oSmartFilterbar.isCurrentVariantStandard()){a=this.oState.oSmartFilterbar.isCurrentVariantExecuteOnSelectEnabled();w.hidePlaceholder();if(!a){r.setHeaderExpanded(true)}if(t&&!a){e.setVisible(false)}return false}var s=this.getUIModel().getProperty("/dataLoadSettings");var n=s?s.loadDataOnAppLaunch:"ifAnyFilterExist";if(!["ifAnyFilterExist","always","never"].includes(n)){T.error("dataLoadSetting is incorrect. It should be one of ifAnyFilterExist,always,never")}var o=false,l=true;if(n==="ifAnyFilterExist"){var d=this.oState.oSmartFilterbar.getFiltersWithValues();o=true;l=d.length?true:false}else if(n==="always"){o=true}else if(n==="never"){o=false}if(o){var h=this.oState.oSmartFilterbar.getSmartVariant();if(h){h.setExecuteOnStandard(true);o=h.getExecuteOnStandard();a=this.oState.oSmartFilterbar.isCurrentVariantExecuteOnSelectEnabled();if(a){this.oState.oSmartFilterbar.search()}}}if(!a||!o){r.setHeaderExpanded(true)}if(t&&(!a||!o)){e.setVisible(false)}b.loadingState.GLOBALFILTERFILLED=o;if(!o||!t||!l){w.hidePlaceholder()}return o&&t&&l},verifyGlobalFilterLoaded:function(){var t=this.getUIModel().getProperty("/enableLiveFilter");var e=this.getGlobalFilter();var a=true;var i=e.determineMandatoryFilterItems();var r,s=e.getFilterData(),n;if(i&&s){var o=i.length;while(o--){r=i[o];n=e.determineControlByFilterItem(r,true);if(n){if(!e._checkForValues(s,r,n)){a=false;break}}}}if(!this.bGlobalFilterLoaded&&t===false){if(!a){var l=h&&h.system&&h.system.phone;if(l){var d=this&&this.getView().byId("ovpMain"),f=d&&d.getHeaderExpanded();if(!f){d.setHeaderExpanded(true)}}if(w.hidePlaceholderNeeded()){w.hidePlaceholder()}}return this._fnIsLoadDataOnGoButton(a)}if(a){if(e.validateMandatoryFields()){b.loadingState.GLOBALFILTERFILLED=true;return true}}else if(!a){if(w.hidePlaceholderNeeded()){w.hidePlaceholder()}}this.getView().byId("ovpMain").setHeaderExpanded(true);this.getView().byId("ovpFilterNotFulfilledPage").setVisible(true);b.loadingState.GLOBALFILTERFILLED=false;return false},onGlobalFilterChange:function(t){this.filterChanged=true;if(this.bGlobalFilterInitialized){var e=this.getGlobalFilter();var a=e.getLiveMode();var i=this.getLayout();var r=t.getParameter("afterFilterDataUpdate");if(!a&&i&&!r){i.setActive(false)}else{i.setActive(true);this.changeViewSwitchForVisibleCard()}}},destroyErrorCardsAndReplaceWithOriginal:function(){if(this.isModelRefreshTriggered||this.filterChanged||this.bGoButtonPressed||this.bSearchButtonPressed){var t;var e=Object.assign({},this.aErrorCards);for(t in e){var a=this.getView().byId(e[t]);var i=a&&a.getComponentInstance();var r=i&&i.getComponentData();var s=r&&r.cardId;var n=this._getCardFromManifest(s);i.destroy();var o=this.aErrorCards.indexOf(s);if(o>-1){this.aErrorCards.splice(o,1)}this.createCard(n)}this.isModelRefreshTriggered=false}},onTriggerFilterSearch:function(){var t=this.getGlobalFilter();if(t&&t.validateMandatoryFields()&&V(t.verifySearchAllowed())){this.onGlobalFilterSearch()}if(this.getMacroFilterBar()){this.onMacroFilterBarSearch()}},onGlobalFilterSearch:function(){if(this.filterChanged||this.bGoButtonPressed||this.bSearchButtonPressed){var t=this.getGlobalFilter();var e=this.getLayout();if(e){e.setActive(true)}if(this.aErrorCards&&this.aErrorCards.length>0){this.destroyErrorCardsAndReplaceWithOriginal()}if(t&&!t.isDialogOpen()){this._storeCurrentAppStateAndAdjustURL()}if(t&&t.getLiveMode()&&t._bResetFiltersDialogTriggered){this._storeCurrentAppStateAndAdjustURL()}this._clearStoredEntities();var a=[];if(this.oGlobalFilter["_aFields"].length>0){a=this.oGlobalFilter["_aFields"]}else{var i=this.oGlobalFilter["_aFilterBarViewMetadata"];for(var r=0;r<i.length;r++){var n=i[r];for(var o=0;o<n.fields.length;o++){a.push(n.fields[o])}}}for(var r=0;r<a.length;r++){if(a[r].control){var l=document.getElementById(a[r].control.sId);if(jQuery(l).hasClass("sapMFocus")){this.filterItemInFocus=a[r].control;break}}}var d="ovp-"+(new Date).getTime();this._processFilters();this.globalEventBus.publish("OVPGlobalfilter","OVPGlobalFilterSeacrhfired",this.aFilters);if(this.nRefreshInterval!==0){if(this.oRefreshTimer!==null){clearTimeout(this.oRefreshTimer)}this.attachRefreshInterval(this.nRefreshInterval)}for(var h in this.oCardsModels){if(this.oCardsModels.hasOwnProperty(h)&&!s.isODataV4(this.oCardsModels[h])){try{this.oCardsModels[h].refresh(false,false,d)}catch(t){T.warning(t)}}}this.filterChanged=false;this.bGoButtonPressed=false;this.bSearchButtonPressed=false;this._clearStoredEntities()}},_clearStoredEntities:function(){if(this.sPreviousEntityType){this.sPreviousEntityType=""}if(this.sCurrentEntityType){this.sCurrentEntityType=""}},_processSFBFilters:function(){var t=this.getGlobalFilter();var e=t.getFilters();var a=this.getCustomFilters();var i=true;var r;var s=function(t,e){if(!(t instanceof y)){throw new Error("State must always be set with respect to a ControllerExtension")}if(!i){throw new Error("State must always be provided synchronously")}if(e){r=e}};this.templateBaseExtension.addFilters(s);i=false;var n=[];if(a&&a instanceof o){n.push(a)}if(r&&r instanceof o){n.push(r)}if(n.length!==0){var l=[];if(e&&e.length>0){n.push(e[0])}l.push(new o(n,true));if(l.length>0){e=l}}this.aFilters=e},_processFilters:function(){if(this.getGlobalFilter()){this.aFilters=[];this._processSFBFilters()}else if(this.getMacroFilterBar()){this.aFilters=this.aFilters||[]}else{this.aFilters=[]}},_processSearch:function(){var t,e;var a=this.getGlobalFilter();if(!a){return}var i=a.getParameters();var e=i&&i["custom"];if(!e){return}for(var r in e){t=r+"="+F(e[r])}return t},_collapseHeaderForPage:function(){var t=h&&h.system&&h.system.phone;if(t){var e=this.getGlobalFilter();var a=this&&this.getView().byId("ovpMain"),i=a&&a.getHeaderExpanded();if(i&&e.validateMandatoryFields()){a.setHeaderExpanded(false)}}},_initGlobalFilter:function(){var t=this.getGlobalFilter();if(!t){var e=this.getLayout();var a=this.getOwnerComponent().oOvpConfig;if(e&&a&&(a.globalFilterEntitySet||a.globalFilterEntityType)){e.setActive(false)}var i=this.getMacroFilterBar();if(!i){this.bGlobalFilterLoaded=true;this._parseNavigationVariant();return}this.getView().byId("ovpMain").setHeaderExpanded(true);this.getView().byId("ovpFilterNotFulfilledPage").setVisible(true);b.loadingState.GLOBALFILTERFILLED=false;this.oGlobalFilterLoadedPromise=new Promise(function(t,e){this.fnMacroFilterBarLoaded=t;w.hidePlaceholder()}.bind(this));return}t.attachFiltersDialogClosed(this._storeCurrentAppStateAndAdjustURL.bind(this));var r=t.getVariantManagement();if(r){r.attachAfterSave(function(t){this._storeCurrentAppStateAndAdjustURL(undefined,true)}.bind(this))}this.oGlobalFilterLoadedPromise=new Promise(function(e,a){t.attachInitialized(function(){this._parseNavigationVariant();if(this.oParseNavigationPromise){var a;this.oParseNavigationPromise.then(function(t){var e=t&&t[0];var i=t&&t[1];var r=t&&t[2];if(e){a=Promise.resolve(this._setNavigationVariantToGlobalFilter(e,i,r)).then(function(){this.filterChanged=false}.bind(this))}}.bind(this));this.oParseNavigationPromise.catch(function(){T.error("Could not parse navigation variant from URL")});this.oParseNavigationPromise.finally(function(){Promise.all([a]).then(function(){this.bGlobalFilterInitialized=true;if(t&&this.verifyGlobalFilterLoaded()){e()}}.bind(this))}.bind(this))}else if(t&&this.verifyGlobalFilterLoaded()){e()}},this);t.attachSearch(function(){if(t.validateMandatoryFields()){if(!this.bGlobalFilterLoaded){e();this.bGlobalFilterLoaded=true;if(!t.isDialogOpen()){this._storeCurrentAppStateAndAdjustURL()}var a=this.getLayout();if(a){a.setActive(true)}return}this.onGlobalFilterSearch()}},this);t.attachFilterChange(this.onGlobalFilterChange,this);t._oSearchButton&&t._oSearchButton.attachPress(function(){this.bGoButtonPressed=true;this._collapseHeaderForPage();var t=this.getLayout();if(t){t.setActive(true)}}.bind(this))}.bind(this));this.oGlobalFilterLoadedPromise.then(function(e){this.bGlobalFilterLoaded=true;this._collapseHeaderForPage();t._oBasicSearchField&&t._oBasicSearchField.attachSearch(function(){this.bSearchButtonPressed=true}.bind(this))}.bind(this))},_loadCardComponent:function(t){var e=t.replace(/\./g,"/");var a=sap.ui.require.toUrl(e);if(!this.oLoadedComponents[t]){this.oLoadedComponents[t]=E.load({name:t,url:a,manifest:false}).then(function(t){return t})}},_initCardModel:function(t){var e=false;if(this.oCardsModels[t]||!t){return}this.oCardsModels[t]=this.getView().getModel(t);if(!s.isODataV4(this.getView().getModel(t))){if(!this.oCardsModels[t].bUseBatch){this.oCardsModels[t].setUseBatch(false)}else{this.oCardsModels[t].setUseBatch(true)}}if(this.getGlobalFilter()||this.getMacroFilterBar()){e=true}if(!s.isODataV4(this.oCardsModels[t])){this._overrideCardModelRead(this.oCardsModels[t],e)}},getVisibleCustomFields:function(){var t=this.getGlobalFilter();var e=t.getAllFilterItems(true);var a,i,r=[];if(e){a=e.length;while(a--){i=e[a];if(i&&i.getVisibleInFilterBar()){r.push(i.getName())}}}var s,n,o,l=t.getFilterBarViewMetadata();var d=[];if(l){s=l.length;while(s--){o=l[s].fields;if(o){n=o.length;while(n--){if(o[n].isCustomFilterField&&r.indexOf(o[n].fieldName)>-1){d.push({name:o[n].fieldName})}}}}}return d},_showErrorPage:function(t){if(this.bDisableErrorPage){return}var e=this.getView().byId("ovpErrorPage");var a=this.getView().byId("ovpMain");if(t){e.setVisible(true);a.setVisible(false);return}e.setVisible(false);a.setVisible(true)},_removeFilter:function(t,e){var a=t.lastIndexOf(e);var i=t.indexOf(e);if(a===-1||i===-1){return t}var r="%20and%20";var s=t.substring(a).indexOf(r);s=s!==-1?a+s:s;var n=t.substring(0,i).lastIndexOf(r);if(s===-1&&n===-1){if(t.lastIndexOf("$filter=")===0){return t.slice(0,8)}else{return""}}else if(n===-1){if(t.lastIndexOf("$filter=")===0){return t.slice(0,8)+t.slice(s+r.length)}else{return t.slice(s+r.length)}}else if(s===-1){return t.slice(0,n)}else{return t.slice(0,n)+t.slice(s)}},_removeRelevantFilterRecursively:function(t,e){if(!t._bMultiFilter){if(t.sPath===e){return undefined}return t}else{t.aFilters.forEach(function(a,i){t.aFilters[i]=this._removeRelevantFilterRecursively(a,e)}.bind(this));for(var a=0;a<t.aFilters.length;a++){if(!t.aFilters[a]){t.aFilters.splice(a,1);a--}}if(t.aFilters.length>0){return t}else{return undefined}}},_removeRelevantFilter:function(t,e){if(!t||t.length===0){return t}t[0]=this._removeRelevantFilterRecursively(t[0],e);return!t[0]?undefined:t},_getFilterPreference:function(t){var e;var a=this._getCardFromManifest(t);if(a){if(a.settings.tabs){var i=0;var r=a.settings.selectedKey;if(r&&a.settings.tabs.length>=r){i=r-1}e=a.settings.tabs[i].mFilterPreference}else{e=a.settings.mFilterPreference}}return e},_getFilterPreferenceFromUrlParams:function(t){var e=t.urlParameters;var a;var i="cardId=";var r=-1;if(e){for(var s=0;s<e.length;s++){if(e[s].lastIndexOf(i)>=0){r=s;break}}if(r>=0){var n=e[r].lastIndexOf(i);var o=e[r].slice(n+i.length);a=this._getFilterPreference(o);if(n>0){e[r]=e[r].slice(0,n-1)}else{e.splice(r,1)}}}return a},_addRelevantFilters:function(t,a,i,r){var s=t.urlParameters;var n=-1;if(s){for(var o=0;o<s.length;o++){if(s[o].lastIndexOf("$filter=",0)===0){n=o;break}}}if(this.aRelevantFilters&&this.aRelevantFilters.length>0){if(n>=0){var l=e.createFilterParams(this.aRelevantFilters,a.oMetadata,i).substr(8);if(r&&r.filterAll==="card"){s[n]=s[n]}else if(r&&r.filterAll==="global"){s[n]=s[n].slice(0,8)+l}else if(r&&(r.cardFilter||r.globalFilter)){if(Array.isArray(r.cardFilter)&&r.cardFilter.length>0){r.cardFilter.forEach(function(t){l=this._removeFilter(l,t)}.bind(this))}if(Array.isArray(r.globalFilter)&&r.globalFilter.length>0){r.globalFilter.forEach(function(t){s[n]=this._removeFilter(s[n],t)}.bind(this))}if(l===""&&s[n].length===8){s.splice(n,1)}else if(l===""){s[n]=s[n]}else if(s[n].length===8){s[n]=s[n]+l}else{if(this.aRelevantFilters.length===1){l="("+l+")"}s[n]=s[n].slice(0,8)+"("+s[n].slice(8,s[n].length)+")%20and%20"+l}}else{if(this.aRelevantFilters.length===1){l="("+l+")"}s[n]=s[n].slice(0,8)+"("+s[n].slice(8,s[n].length)+")%20and%20"+l}}else{if(r&&r.filterAll==="card"){t.filters=undefined}else if(r&&r.filterAll==="global"){t.filters=this.aRelevantFilters}else if(r&&(r.cardFilter||r.globalFilter)){if(Array.isArray(r.cardFilter)&&r.cardFilter.length>0){r.cardFilter.forEach(function(t){this.aRelevantFilters=this._removeRelevantFilter(this.aRelevantFilters,t)}.bind(this))}if(this.aRelevantFilters&&this.aRelevantFilters.length>0){t.filters=this.aRelevantFilters}}else{t.filters=this.aRelevantFilters}}}else{if(n>=0){if(r&&r.filterAll==="card"){s[n]=s[n]}else if(r&&r.filterAll==="global"){s.splice(n,1)}else if(r&&r.globalFilter){if(Array.isArray(r.globalFilter)&&r.globalFilter.length>0){r.globalFilter.forEach(function(t){s[n]=this._removeFilter(s[n],t)}.bind(this))}if(s[n].length===8){s.splice(n,1)}}}}return t},removeInternalParamValue:function(t,e){return t&&t.reduce(function(t,a){if(a&&a.includes(e)){a=a.substring(0,a.indexOf(e)-1)}if(a){t.push(a)}return t},[])},_overrideCardModelRead:function(t,e){var a=t.read;var i=this;t.read=function(){var r=arguments[1];if(!r){r={};Array.prototype.push.call(arguments,r)}var s=i._getEntityTypeFromPath(t,arguments[0],r.context,false);var n=i._getEntitySetFromEntityType(t,s);var o=r&&r.urlParameters;var l=false;if(o&&Array.isArray(o)){l=o.some(function(t){return t&&t.indexOf("_requestFrom=ovp_internal")>-1})}else if(o&&typeof o==="object"){l=o["_requestFrom"]==="ovp_internal"}if(!l){return a.apply(t,arguments)}if(o&&Array.isArray(o)){o=i.removeInternalParamValue(o,"_requestFrom=ovp_internal");r.urlParameters=o}else if(o&&typeof o==="object"&&l){delete o["_requestFrom"]}var d=i._getFilterPreferenceFromUrlParams(r);if(e){i._processFilters();var h=i.getGlobalFilter();var f=i.getMacroFilterBar();var u=h!==undefined?h.getModel():f.getModel();if(!i.aFilters){i.aFilters=[]}var g=false;var c;var p=n["Org.OData.Capabilities.V1.SearchRestrictions"];if(n["sap:searchable"]==="true"||p&&p.Searchable&&p.Searchable.Bool&&p.Searchable.Bool==="true"){c=i._processSearch()}i.sCurrentEntityType=s.entityType;if(i.sPreviousEntityType!==i.sCurrentEntityType){i.sPreviousEntityType=i.sCurrentEntityType;g=true}if(!i.aRelevantFilters){i.aRelevantFilters=[];g=true}if(g){i.aRelevantFilters=[];if(s){i.aRelevantFilters=i._getEntityRelevantFilters(s,i.aFilters,t,u)}}r=i._addRelevantFilters(r,t,s,d);var v=r.urlParameters;if(c){v[v.length]=c}if(h&&h.getConsiderAnalyticalParameters()){var m=h.getAnalyticBindingPath();var y,b,C;if(m&&m.length>0){if(s.entityType===h.getEntityType()){b=arguments[0];y=arguments[0].indexOf("$");if(y>0){b=arguments[0].substring(0,y-1)}C=m;if(b!==C){arguments[0]=arguments[0].replace(b,C)}}else{var F=i._getParametersFromEntityPath(arguments[0]);var P=i._getParametersFromEntityPath(m);var S,M,O;if(F&&F.length>0){var A=i._getEntityTypeFromPath(t,arguments[0],r.context,true);for(var V=0;V<P.length;V++){S=i._getPropertyMapping(F,P[V].name,A.name,h.getEntityType(),t,h.getModel());if(S){M=S+"=.*?[,)]";O=arguments[0].match(new RegExp(M));if(O&&O.length>0){b=O[0].slice(0,-1);C=S+"="+P[V].sValue;if(b!==C){arguments[0]=arguments[0].replace(b,C)}}}}}}}}}var _=t.getMetaModel();var w=_.getODataEntityType(n.entityType);v=i._getExpandPropertiesForSmartCharts(v,_,w);var E=arguments[1].success;arguments[1].success=function(t,e){return function(){if(!e.errorHandlingObject.atLeastOneRequestSuccess){e.errorHandlingObject.atLeastOneRequestSuccess=true;e._showErrorPage(false)}if(e.filterItemInFocus!=null){e.filterItemInFocus.focus();e.filterItemInFocus=null}if(e.nRefreshInterval!==0){if(e.oRefreshTimer!==null){clearTimeout(e.oRefreshTimer)}e.attachRefreshInterval(e.nRefreshInterval)}return t.apply(this,arguments)}}(E,i);var I=arguments[1].error;arguments[1].error=function(t,e){return function(){if(!e.errorHandlingObject.atLeastOneRequestSuccess){clearTimeout(e.errorHandlingObject.errorLoadingTimeout);e.errorHandlingObject.errorLoadingTimeout=setTimeout(function(){if(!e.errorHandlingObject.atLeastOneRequestSuccess){e._showErrorPage(true)}},9e3)}return t.apply(this,arguments)}}(I,i);var L=a.apply(t,arguments);return L}},showErrorCardForMissingParam:function(t,e){var a=t[0];var i=t[1].urlParameters;for(var r in i){a=a+i[r]}var s=new I;s.mParameters={url:a,response:{statusText:v.getText("Missing_Param_Text")}};s.oSource=e;setTimeout(function(){this.fVerifyAndSetErrorOrCustomMessageCard(s,false)}.bind(this),0)},_checkMandatoryParams:function(t,e,a){var i=new c.Model(c.Model.ReferenceByModel(t));var r=i.findQueryResultByName(e);var s=r&&r.getParameterization();if(!s){return true}var n=s.getAllParameterNames();var o=a.match(/\(.*\)/g);if(n.length>0&&o===null){return false}var l=o[0].replace("(","").replace(")","").split(",");if(l.length===n.length){for(var d in l){var h=l[d].split("=")[1];if(h.indexOf("%27")>-1){h=h.split("%27")[1]}if(h.length===0){return false}}}else{return false}},_getExpandPropertiesForSmartCharts:function(t,e,a){var i;var r="";var s;var n;var o;var l="$expand";var d=false;var h=false;var f;var u;var g;var c="com.sap.vocabularies.Common.v1.Text";var p=a&&a.property;if(!t||!(t.length>0)){return t}for(var v=0;v<t.length;v++){if(t[v].indexOf("$expand")>-1){return t}}for(var m=0;m<t.length;m++){if(t[m].indexOf("$select")>-1){h=true;u=t[m];o=t[m].split("$select=");if(o&&o[1]){f=decodeURIComponent(o[1]);i=f.split(",");if(!i||!(i.length>1)){return t}}break}}if(!h){return t}if(!i||!(i.length>0)||!p||!(p.length>0)){return t}for(var y=0;y<i.length;y++){for(var b=0;b<p.length;b++){if(i[y]==(p[b]&&p[b].name)){if(p[b]&&p[b]["sap:aggregation-role"]&&p[b]["sap:aggregation-role"]=="dimension"){if(!p[b][c]||!p[b][c].Path||!(p[b][c].Path.indexOf("/")>0)){break}r=p[b][c].Path;s=r.split("/");if(!s.length){break}n=e.getODataAssociationEnd(a,s[0]);if(!n){break}if(!d){l=l+"="+s[0];d=true}else if(d){l=l+","+s[0]}g=u+","+r}break}}}if(g&&l){t[m]=g;t.push(l)}return t},attachRefreshInterval:function(t){this.oRefreshTimer=setTimeout(function(){this._processFilters();this.globalEventBus.publish("OVPGlobalfilter","OVPGlobalFilterSeacrhfired",this.aFilters);var t=this.getLayout();if(t&&t.getActive()){for(var e in this.oCardsModels){this.isModelRefreshTriggered=true;if(!s.isODataV4(this.oCardsModels[e])){this.oCardsModels[e].refresh(false,false)}}}}.bind(this),t)},_getEntityTypeFromPath:function(t,e,a,i){var r=u.prototype._normalizePath.apply(t,[e,a]);if(i){r=e.replace(/^\/|\/$/g,"").split("/")[0];if(r.indexOf("(")!=-1){r=r.substring(0,r.indexOf("("))}}var s=g.prototype._getEntityTypeByPath.apply(t.oMetadata,[r]);return s},_getEntitySetFromEntityType:function(t,e){if(!t||!e){return}var a=t.getMetaModel();var i=a&&a.getODataEntityContainer();var r=i&&i.entitySet;if(!r||!Array.isArray(r)){return}var s=r.length;for(var n=0;n<s;n++){if(r[n].entityType===e.entityType){return r[n]}}},_getPropertyMapping:function(t,e,a,i,r,s){var n,o;for(n=0;n<t.length;n++){if(t[n].name===e){o=t[n].name;return o}if("P_"+t[n].name===e||t[n].name==="P_"+e){o=t[n].name;return o}}if(!a||!i||!r||!s){return}var l=r.oMetadata._getEntityTypeByName(a);var d=s.oMetadata._getEntityTypeByName(i);if(!l||!d){return}var h="com.sap.vocabularies.Common.v1.SemanticObject";var f="com.sap.vocabularies.Common.v1.SemanticObjectMapping";var u=r.oAnnotations.getAnnotationsData();if(!u||!u.propertyAnnotations){return}var g=u.propertyAnnotations[l.namespace+"."+l.name];var c=s.oAnnotations.getAnnotationsData();if(!c||!c.propertyAnnotations){return}var p=c.propertyAnnotations[d.namespace+"."+d.name];var v=p&&p[e];if(!v||!v[h]){return}var m,y,b,C,F;for(m in g){y=g[m];if(y[h]&&y[h].String===v[h].String){b=y[f];if(!b){continue}C=b.length;F="";while(C--){if(b[C].SemanticObjectProperty.String===e){F=b[C].LocalProperty.PropertyPath;break}}if(F!==""){for(n=0;n<t.length;n++){if(t[n].name===F){o=t[n].name;return o}}}}}return o},_getParametersFromEntityPath:function(t){t=t.split("?")[0];var e=t.match(/\(.*=.*\)/);var a=[];if(!e){return a}var i=e[0].slice(1,-1).trim().split(/\=|\,/);for(var r=0;r<i.length;r=r+2){a.push({name:i[r],sValue:i[r+1]})}return a},_checkRelevantFiltersRecursive:function(t,e,a,i,r,s){if(!e._bMultiFilter){e.sPath=e.sPath.split("/").pop();var n=this._getPropertyMapping(t,e.sPath,a,i,r,s);if(n){e.sPath=n;return e}}else{var l=e.aFilters;var d,h=[];if(l){for(var f=0;f<l.length;f++){d=this._checkRelevantFiltersRecursive(t,l[f],a,i,r,s);if(d){h.push(d)}}if(h.length>0){return new o(h,e.bAnd)}}}},_getEntityRelevantFilters:function(t,e,a,i){var r=[];if(e.length>0&&t){var s=this.isMacroFilterBar?t.entityType:this.getGlobalFilter().getEntityType();var n=this._checkRelevantFiltersRecursive(t.property,e[0],t.name,s,a,i);if(n){r.push(n)}}return r},_checkIsCardValid:function(t){var e=t+".Component";var r,s;sap.ui.require(e);var n=P.get(e);if(!n){return false}if(n!==a&&!(n.prototype instanceof a||n.prototype instanceof i)){return false}if((r=n.getMetadata())&&(s=r.getCustomizing())){if(s["sap.ui.viewReplacements"]&&s["sap.ui.viewReplacements"]["sap.ovp.cards.generic.Card"]){return false}}if(n.prototype.createContent!=a.prototype.createContent&&n.prototype.createContent!=i.prototype.createContent){return false}if(n.prototype.getPreprocessors!=a.prototype.getPreprocessors&&n.prototype.getPreprocessors!=i.prototype.getPreprocessors){return false}return true},_createCardComponent:function(t,e,a){var i=t.getModel("@i18n");if(a.template&&this._checkIsCardValid(a.template)){var r={name:a.template,manifest:false,componentData:{model:e,modelName:a.model,i18n:i,cardId:a.id,settings:a.settings,appComponent:this.getOwnerComponent(),mainComponent:this}};var s=this.getGlobalFilter();if(a.errorReason){r.componentData.errorReason=a.errorReason}if(s){r.componentData.globalFilter={getUiState:s.getUiState.bind(s)}}var n=t;this.getOwnerComponent().runAsOwner(function(){E.create(r).then(function(t){var e=t.getComponentData().cardId;var a=n.byId(e);a.setPropagateModel(true);var i=a.getComponentInstance();a.setComponent(t);if(i){setTimeout(function(){i.destroy()},0)}})})}else{T.error("Could not create Card from '"+a.template+"' template. Card is not valid.")}},createErrorCard:function(t,e){var a=S({},t,{template:"sap.ovp.cards.error"});a.errorReason=Object.assign({},e);a.settings.oldTemplate=t.template;a.settings.template="sap.ovp.cards.error";this.oLoadedComponents[a.settings.template].then(function(){this._createCardComponent(this.getView(),undefined,a)}.bind(this))},createCard:function(t){var e=this.getView();var a=e.getModel(t.model);var i;if(s.isODataV4(a)){i=[a.getMetaModel().requestObject("/"+t.settings.entitySet),this.oGlobalFilterLoadedPromise,this.oLoadedComponents[t.template]]}else{i=[a.getMetaModel().loaded(),this.oGlobalFilterLoadedPromise,this.oLoadedComponents[t.template],this.oLoadedComponents["sap.ovp.cards.error"]]}return Promise.all(i).then(function(){this._createCardComponent(e,a,t)}.bind(this),function(e){T.error("Can't load card with id:'"+t.id+"' and type:'"+t.template+"', reason:"+e)})},_getCardId:function(t){var e=this.getView().getId()+"--";var a="mainView--";if(t.indexOf(e)!=-1){var i=t.indexOf(e)+e.length;return t.substring(i)}if(t.indexOf(a)!==-1){var i=t.indexOf(a)+a.length;return t.substring(i)}return t},_initFlexibilityPersonalization:function(){var t=this.getLayout();var e="sap/ovp/flexibility/changeHandler/PersonalizationChangeHandler";var a=t.getContent();if(a&&a.length){for(var i=0;i<a.length;i++){a[i].addCustomData(new O({key:"sap-ui-custom-settings",value:{"sap.ui.fl":{flexibility:e}}}))}this.oFlexibilityPersonalizationPromise=new Promise(function(t,e){M.waitForChanges({selectors:a}).then(function(){if(this.deltaChanges.length>0){this.bDeltaChangesEnabled=true}t()}.bind(this),function(e){t()})}.bind(this))}},layoutChanged:function(t){var e=t.getParameter("positionChanges");var a=[],i=[];var r,s;if(this.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){var o=this.getLayout().dashboardLayoutUtil.dashboardLayoutModel.iColCount;if(e){for(var l=e.length-1;l>=0;l--){r=e[l];s=r.content.cardId;if(r.content.dashboardLayout.oldRow===r.content.dashboardLayout.row&&r.content.dashboardLayout.oldColumn===r.content.dashboardLayout.column&&r.content.dashboardLayout.oldRowSpan===r.content.dashboardLayout.rowSpan&&r.content.dashboardLayout.oldColSpan===r.content.dashboardLayout.colSpan){continue}if(i[s]){i[s].content.dashboardLayout.oldRow=r.content.dashboardLayout.oldRow;continue}i[s]=r}Object.keys(i).forEach(function(t){var e=i[t];if(e.content.dashboardLayout.oldRow===e.content.dashboardLayout.row&&e.content.dashboardLayout.oldColumn===e.content.dashboardLayout.column&&e.content.dashboardLayout.oldRowSpan===e.content.dashboardLayout.rowSpan&&e.content.dashboardLayout.oldColSpan===e.content.dashboardLayout.colSpan){return}a.push(i[t])});a.forEach(function(t){var e=t.content.dashboardLayout;t.content.dashboardLayout={};t.content.dashboardLayout["C"+o]=e})}}else{var d=this.getLayout().getContent();var h=this._getCardArrayAsVariantFormat(d);this.getView().getModel("ui").setProperty("/aOrderedCards",h);a=e}if(a.length>0){n.savePersonalization(a,this.getView())}},saveVariant:function(t){var e=this;this.smartVariandManagement.getVariantsInfo(function(t){var a=null;if(t&&t.length>0){a=t[0].key}var i=a!==null;var r={name:"Personalisation",global:false,overwrite:i,key:a,def:true};e.smartVariandManagement.fireSave(r)})},getLayout:function(){return this.getView()?this.getView().byId("ovpLayout"):null},_initShowHideCardsButton:function(){var t=sap.ushell.Container.getRenderer("fiori2");if(t){var e={controlType:"sap.ushell.ui.launchpad.ActionItem",bCurrentState:true,oControlProperties:{icon:"sap-icon://dimension",id:this.createId("managecards"),text:v.getText("MANAGE_CARDS_TITLE"),tooltip:v.getText("MANAGE_CARDS_TITLE"),press:this.oManageCardsUtils.onManageCardsMenuButtonPress.bind(this.oManageCardsUtils)},bIsVisible:true,aStates:["app"]};t.addUserAction(e)}},createOrDestroyCards:function(t,e,a){var i=-1,r=[],s=[];for(var n=0;n<e.length;n++){if(t[n].id==e[n].id){i=n}else{i=this.getCardIndexInArray(t,e[n].id)}var o=this.getView().byId(e[n].id);var l=o.getComponentInstance();if(a){if(l){l.destroy()}}if(e[n].visibility!=t[i].visibility||a){if(e[n].visibility===true){var d=this._getCardFromManifest(e[n].id);r.push({oCard:d,sCreateOrDestroy:"create"});s.push(d)}else if(l){r.push({oCard:l,sCreateOrDestroy:"destroy"})}}}var h=this.fGetViewSwitchIndex(s);if(r&&r.length>0){var f=this.getView().getModel("ui").getProperty("/aOrderedCards");for(var u=0;u<r.length;u++){if(r[u]&&r[u].oCard&&r[u].hasOwnProperty("sCreateOrDestroy")&&r[u].sCreateOrDestroy=="create"){var g=r[u].oCard;if(g){g.settings.baseUrl=this._getBaseUrl();this._clearStoredEntities();this._initCardModel(g.model);g=this._getTemplateForChart(g);this._loadCardComponent(g.template);this._createModelViewMap(g);if(g.settings.tabs){var c=0;var p=[];p.push(g);var v=h&&h.hasOwnProperty(g.id)?h[g.id]:"";var m=this.getOrderedCardsSelectedKey(g.id);if(v&&typeof v=="number"&&v<=g.settings.tabs.length&&v!==m){c=v>=1?v-1:v;this.setOrderedCardsSelectedKey(g.id,v)}else if(f[u].selectedKey&&g.settings.tabs.length>=f[u].selectedKey){c=f[u].selectedKey-1}this.initializeTabbedCard(g,c)}this.createCard(g)}}else if(r[u]&&r[u].oCard&&r[u].hasOwnProperty("sCreateOrDestroy")&&r[u].sCreateOrDestroy=="destroy"){r[u].oCard.destroy()}}}},getCardIndexInArray:function(t,e){for(var a=0;a<t.length;a++){if(t[a].id==e){return a}}return-1},rerenderCards:function(t){var e=this.getView().getModel("ui").getProperty("/aOrderedCards");this.createOrDestroyCards.apply(this,[e,t,false]);this.getView().getModel("ui").setProperty("/aOrderedCards",t);this.updateDashboardLayoutCards(t);this.updateLayoutWithOrderedCards();n.savePersonalization(this.visibilityChanges,this.getView());for(var a=0;a<t.length;a++){var i=t[a];var r=this.aErrorCards.indexOf(i.id);if(r>-1&&i.visibility==false){this.aErrorCards.splice(r,1)}}},isDragAndDropEnabled:function(){return!h.system.phone},getGlobalFilter:function(){if(!this.oGlobalFilter){this.oGlobalFilter=this.getView().byId("ovpGlobalFilter")}return this.oGlobalFilter},getMacroFilterBar:function(){if(!this.oMacroFilterBar){this.oMacroFilterBar=this.getView().byId("ovpGlobalMacroFilter")}return this.oMacroFilterBar},getUIModel:function(){if(!this.oUIModel){var t=this.getOwnerComponent();this.oUIModel=t&&t.getModel("ui")}return this.oUIModel},_parseNavigationVariant:function(){if(!this.oContainer){this.oParseNavigationPromise=Promise.resolve();return}var t=this.oNavigationHandler;this.oParseNavigationPromise=new Promise(function(e,a){return t.parseNavigation().done(function(t,a,i){e([t,a,i])}).fail(function(){a()})})},_setUiStateToGlobalFilter:function(t,e,a){var i=this.getGlobalFilter();var r=new d({selectionVariant:t.toJSONObject()});i.setUiState(r,{replace:a,strictMode:false});e=e.concat(t.getParameterNames().concat(t.getSelectOptionsPropertyNames()));e=e.filter(function(t,e,a){return a.indexOf(t)==e});return e},_processModifyStartupExtension:function(t){if(!t){t=[]}var e=this.getGlobalFilter();var a=e.getUiState();var i=new l(a.getSelectionVariant());var r=JSON.parse(JSON.stringify(i));return new Promise(function(e,a){Promise.all([this.modifyStartupExtension(i),this.templateBaseExtension.provideStartupExtension(i)]).then(function(){if(JSON.stringify(i)!==JSON.stringify(r)){try{t=this._setUiStateToGlobalFilter(i,t,true)}catch(e){T.error("Error with modifyStartupExtension, falling back to default behavior"+e);t=this._setUiStateToGlobalFilter(r,t,true)}}e(t)}.bind(this))}.bind(this))},_addFieldsToSFBAdvancedArea:function(t){var e;var a=this.getGlobalFilter();if(t&&t.length>0){e=t.length;while(e--){a.addFieldToAdvancedArea(t[e])}}},_restoreAppState:function(t){this.restoreCustomAppStateDataExtension(t._CUSTOM);var e=t._EXTENSION;if(!e){return}var a=true;var i=function(t){if(!(t instanceof y)){throw new Error("State must always be retrieved with respect to a ControllerExtension")}var i=t.getMetadata().getNamespace();if(!a){throw new Error("State must always be restored synchronously")}return e[i]};this.templateBaseExtension.restoreExtensionAppStateData(i);a=false},_setNavigationVariantToGlobalFilter:function(t,e,a){return new Promise(function(i,r){var s=this.getGlobalFilter();var n=this.getUIModel()&&this.getUIModel().oData;var o=this.oState&&this.oState.oSmartFilterbar;var h=this.oGlobalFilter&&this.oGlobalFilter.getUiState().getSemanticDates();if(!s){return}switch(a){case"iAppState":if(this.getUIModel()&&this.getUIModel().getProperty("/bRTAActive")){i();break}if(t.selectionVariant){var f=JSON.parse(t.selectionVariant);if(f.SelectionVariantID.length!==0){var u=s.getVariantManagement().getVariantItems().map(function(t){return t.getKey()});var g=f.SelectionVariantID;if(u.indexOf(g)===-1){i();break}}var c,p,v=false;var m,y,b,C;var F,P,S;s.clearVariantSelection();f=JSON.parse(t.selectionVariant);s.setCurrentVariantId(f.SelectionVariantID);P=s.getUiState({allFilters:false});y=P&&JSON.stringify(P.getSelectionVariant());C=s.getFilterData()._CUSTOM;C=typeof C=="undefined"?{}:C;F=new d({selectionVariant:t.oSelectionVariant.toJSONObject(),semanticDates:t.semanticDates});s.setUiState(F,{replace:true,strictMode:false});c=new l(t.selectionVariant);p=c.getParameterNames().concat(c.getSelectOptionsPropertyNames());for(var M=0;M<p.length;M++){s.addFieldToAdvancedArea(p[M])}S=s.getUiState({allFilters:false});m=S&&JSON.stringify(S.getSelectionVariant());if(y!==m){v=true}if(t.customData&&Object.keys(t.customData).length>0){var b=t.customData;this._restoreAppState(b);if(JSON.stringify(C)!==JSON.stringify(b)){v=true}}s.getSmartVariant().currentVariantSetModified(v);s._updateToolbarText()}i();break;case"xAppState":case"URLParams":var O=[];var A=new l(t.oSelectionVariant.toJSONObject());var V=new l(t.oDefaultedSelectionVariant.toJSONObject());if(!t.bNavSelVarHasDefaultsOnly&&!A.isEmpty()){s.clearVariantSelection();s.clear();O=this._setUiStateToGlobalFilter(A,O,true)}if(t.bNavSelVarHasDefaultsOnly&&!V.isEmpty()&&s.getCurrentVariantId()===""){var w=this._mergeDefaultWithSFBVariant(V,new l(JSON.stringify(s.getUiState().getSelectionVariant())));O=this._setUiStateToGlobalFilter(w,O,true)}if(s.getCurrentVariantId()!==""){this._setDisplayCurrency(V)}Promise.resolve(this._processModifyStartupExtension(O)).then(function(a){this._addFieldsToSFBAdvancedArea(a);if(this.oGlobalFilter.isCurrentVariantStandard()&&t.bNavSelVarHasDefaultsOnly!==false&&this.oGlobalFilter.getSmartVariant()){_.setSemanticDateRangeDefaultValue(n,o,h,e||{});this.oGlobalFilter.getSmartVariant().currentVariantSetModified(false)}i()}.bind(this));break;case"initial":Promise.resolve(this._processModifyStartupExtension()).then(function(a){this._addFieldsToSFBAdvancedArea(a);if(this.oGlobalFilter.isCurrentVariantStandard()&&t.bNavSelVarHasDefaultsOnly!==false&&this.oGlobalFilter.getSmartVariant()){_.setSemanticDateRangeDefaultValue(n,o,h,e||{});this.oGlobalFilter.getSmartVariant().currentVariantSetModified(false)}i()}.bind(this));break;default:break}}.bind(this))},_mergeDefaultWithSFBVariant:function(t,e){if(t.isEmpty()){return e}var a=new l;var i,r;[e,t].forEach(function(t){i=t.getSelectOptionsPropertyNames();i.forEach(function(e){a.removeSelectOption(e);if(!a.getParameter(e)){a.massAddSelectOption(e,t.getSelectOption(e))}});r=t.getParameterNames();r.forEach(function(e){a.removeParameter(e);if(!a.getSelectOption(e)){a.addParameter(e,t.getParameter(e))}})});return a},_setDisplayCurrency:function(t){var e=this.getGlobalFilter();if(!e){return}var a,i;var r=e.getAnalyticalParameters();if(r&&r.length>0){a=r.length;while(a--){if(r[a].name==="P_DisplayCurrency"||r[a].name==="DisplayCurrency"){i=r[a];break}}}if(!i){return}var s=e.getFilters([i.fieldName]);var n=s&&s[0]&&s[0].oValue1;if(n&&n!==" "){return}var o,h;if(i.name.indexOf("P_")===0){h=i.name;o=i.name.substr(2)}else{h="P_"+i.name;o=i.name}if(t&&!t.isEmpty()){var f;n=t.getParameter(o);if(!n||n===" "){n=t.getParameter(h)}if(!n||n===" "){f=t.getSelectOption(o);n=f&&f[0]&&f[0].Low}if(!n||n===" "){f=t.getSelectOption(h);n=f&&f[0]&&f[0].Low}}if(!n||n===" "){n=i.defaultPropertyValue}if(!n||n===" "){return}var u=new l;u.addParameter(i.name,n);var g=new d({selectionVariant:u.toJSONObject()});e.setUiState(g,{replace:false,strictMode:false})},_getCustomAppState:function(){var t={},e={};this.getCustomAppStateDataExtension(t);if(!V(t)){e[R]=t}var a;var i=true;var r=function(t,e){if(!(t instanceof y)){throw new Error("State must always be set with respect to a ControllerExtension")}if(!i){throw new Error("State must always be provided synchronously")}if(e){a=a||Object.create(null);var r=t.getMetadata().getNamespace();a[r]=e}};this.templateBaseExtension.provideExtensionAppStateData(r);i=false;if(a){e[x]=a}return e},onBeforeSFBVariantSave:function(){var t=this._getCustomAppState();var e=this.getGlobalFilter().getFilterData();var a,i=this.getGlobalFilter().getBasicSearchControl();if(i&&i.getValue){a=i.getValue()}e._CUSTOM=t[R];e._EXTENSION=t[x];this.getGlobalFilter().setFilterData(e,true);if(a){this.getGlobalFilter().getBasicSearchControl().setValue(a)}this.getGlobalFilter().fireFilterChange()},onAfterSFBVariantLoad:function(){var t=this.getGlobalFilter().getFilterData();var e=this.getUIModel().getProperty("/enableLiveFilter");if(e){this.getGlobalFilter().fireFilterChange()}if(t){this._restoreAppState(t)}},onAssignedFiltersChanged:function(t){if(t.getSource()&&this.getView().byId("ovpFilterText")){this.getView().byId("ovpFilterText").setText(t.getSource().retrieveFiltersWithValuesAsText())}},_CustomFilterField:function(t,e){for(var a in t){if(t.hasOwnProperty(a)){e[a]=t[a]}}},_getCurrentAppState:function(t){var e=this.getGlobalFilter();if(!e){return}var a={};var i=this._getCustomAppState();var r={_CUSTOM:i[R],_EXTENSION:i[x]};if(!t){if(r._CUSTOM){this._CustomFilterField(r._CUSTOM,a)}if(r._EXTENSION){var s=Object.keys(r._EXTENSION);if(s){this._CustomFilterField(r._EXTENSION[s],a)}}if(!V(a)){var n=this.getGlobalFilter().getFilterData();n._CUSTOM=a;this.getGlobalFilter().setFilterData(n,true)}}var o=e.getUiState({allFilters:false});var d=o&&o.getSelectionVariant();if(e.getSmartVariant().currentVariantGetModified()){d.SelectionVariantID=""}var h=d&&JSON.stringify(d);var f=new l(h);return{selectionVariant:f.toJSONString(),semanticDates:o.getSemanticDates(),customData:r}},_storeCurrentAppStateAndAdjustURL:function(t,e){if(this.getUIModel()&&this.getUIModel().getProperty("/bRTAActive")){return}if(t&&!t.oSource._bDirtyViaDialog){return}if(!this.bGlobalFilterLoaded){return}if(!this.oNavigationHandler){return}if(this.oAppStatePromise){this.rejectPreviousPromise&&this.rejectPreviousPromise("skip")}this.oAppStatePromise=new Promise(function(t,a){this.rejectPreviousPromise=a;var i=this._getCurrentAppState(e);var r=this.oNavigationHandler.storeInnerAppStateWithImmediateReturn(i,true);r.promise.then(function(e){t(e)},function(t){a(t.getErrorCode())})}.bind(this));var a=function(t){this.oAppStatePromise=null;if(t&&t.length>0){this.oNavigationHandler.replaceHash(t);return}throw"AppState key is empty"};var i=function(t){this.oAppStatePromise=null;if(t==="skip"){throw t}throw"Something went wrong while storing AppState - "+t};this.oAppStatePromise.then(a.bind(this),i.bind(this)).catch(function(t){if(t==="skip"){return}})},setTitle:function(t,e,a){var i="";if(t){i=t}else if(e){i=e}else{i=a}return i},onMacroFilterBarSearch:function(t){this._collapseHeaderForPage();if(this.fnMacroFilterBarLoaded!==undefined){this.fnMacroFilterBarLoaded();b.loadingState.GLOBALFILTERFILLED=true;this.getView().byId("ovpFilterNotFulfilledPage").setVisible(false);this.bGlobalFilterLoaded=true}this.bGoButtonPressed=true;var e=this.getLayout();if(e){e.setActive(true)}if(this.aErrorCards&&this.aErrorCards.length>0){this.destroyErrorCardsAndReplaceWithOriginal()}this._clearStoredEntities();if(t){this.aFilters=t.getParameter("filters")}var a="ovp-"+(new Date).getTime();for(var i in this.oCardsModels){if(this.oCardsModels.hasOwnProperty(i)&&!s.isODataV4(this.oCardsModels[i])){try{this.oCardsModels[i].refresh(false,false,a)}catch(t){T.warning(t)}}}this.globalEventBus.publish("OVPGlobalfilter","OVPGlobalFilterSeacrhfired",this.aFilters)}})});
//# sourceMappingURL=Main.controller.js.map