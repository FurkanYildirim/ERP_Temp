/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/core/Core","sap/gantt/misc/Utility","./GanttExtension","../drawer/CursorLine","./CoordinateUtils","./GanttUtils","sap/ui/core/format/DateFormat","sap/m/Text","sap/ui/core/format/TimezoneUtil"],function(jQuery,t,e,o,i,r,n,a,l,s){"use strict";var u=".sapGanttPointer";var c="contextmenu"+u;var g=sap.gantt.DragOrientation;var h=["mouseenter","mouseleave","click","dblclick","mouseup","mousedown"],f=h.map(function(t){return t+u});var d="mousemove",p=d+u,v=p+" mouseup"+u;var S=h.reduce(function(t,e){t[e]=e;return t},{});S[d]=d;var m={Forward:"forward",Backward:"backward",Bottom:"bottom",Top:"top"};var w=50;var b=null;var A={addEventListeners:function(t){var e=t._getPointerExtension(),o=jQuery(e.getDomRefs().ganttSvg),i=jQuery(e.getDomRefs().headerSvg);A.removeEventListeners(t);if(b===null){b=n.adhocLinesPresentAndEnabled(t)}f.forEach(function(t){o.on(t,e.onGanttChartMouseEvent.bind(e));if(b){i.on(t,e.onGanttChartMouseEvent.bind(e))}else{i.off(t,e.onGanttChartMouseEvent.bind(e))}});o.on(v,e.onCrossSvgMouseEvent.bind(e));i.on(v,e.onCrossSvgMouseEvent.bind(e));o.on(p,e.updateGanttCursorLine.bind(e));o.on("mouseover"+u,e.onGanttChartRowHoverOn.bind(e));o.on("mouseout"+u,e.onGanttChartRowHoverOff.bind(e));o.on(c,e.onGanttChartContextMenu.bind(e));e._bIsMouseOnCorrectRow=true;e._bMouseOnSvg=true;if(b){this.bindBackgroundRowEventHeader(i,e)}else{this.unbindBackgroundRowEventHeader(i)}i.on(S.mousedown+u,function(e){var o=t._getDragDropExtension();if(!o.isEventTargetAdhocLine(e)&&!o.isEventTargetDeltaLine(e)){e.preventDefault();e.stopPropagation();e.stopImmediatePropagation();return false}});jQuery(document.getElementById(t.getId())).on(p,r.updateCursorPosition)},removeEventListeners:function(t){var e=t._getPointerExtension(),o=jQuery(e.getDomRefs().ganttSvg),i=jQuery(e.getDomRefs().headerSvg);o.off(u);if(b===null){b=n.adhocLinesPresentAndEnabled(t)}if(b){i.on(S.mousedown+u)}else{i.off(S.mousedown+u)}},doGanttAutoScroll:function(e,o,i,r){var n=e._getPointerExtension();if(n.iTableAutoScrollTimerId){window.clearTimeout(n.iTableAutoScrollTimerId);n.iTableAutoScrollTimerId=null}if(n._bAutoScroll){if(!n.allowAutoScroll()){return}if(!e._getDragDropExtension().isSnapping){n._toggleCursorLine(false)}var a=e._getResizeExtension();if(a.isResizing()){a.onResizing(i)}var l=e._getConnectExtension();if(l.isShapeConnecting()){l.onShapeConnecting(i)}var s=e._getPopoverExtension();s._updatePopoverWhenAutoScroll(i);var u=e._getZoomExtension();u._handleAutoScroll(i);var c=t.getConfiguration().getRTL();var g=30;if(m.Backward===o||m.Top===o){g=-1*g}if(m.Backward===o||m.Forward===o){n._iStep=g}else{n._iStep=0}var h=this.getScrollArea(e,o);var f,d=false;if(o===m.Forward||o===m.Backward){f=c?"scrollLeftRTL":"scrollLeft";d=true}else{f="scrollTop";d=false}l.storeScrollDistance(g,d);var p=h[f]()+g;h[f](p);var v=h[f]();if(v!==p){l.storeScrollDistance(v-p,d)}if(!(r!==undefined&&r===v)){n.iTableAutoScrollTimerId=window.setTimeout(A.doGanttAutoScroll.bind(A),w,e,o,i,v)}}},getScrollArea:function(t,e){var o;var i=t.getTable();var r=jQuery(i.getDomRef(sap.ui.table.SharedDomRef.VerticalScrollBar));if(e===m.Forward||e===m.Backward){o=jQuery(document.getElementById(t.getId()+"-hsb"))}else{o=r}return o},bindBackgroundRowEventHeader:function(t,e){jQuery(t[0]).on(S.click+u+" "+S.dblclick+u,function(t){e.dispatchGanttClickHeader(t)})},unbindBackgroundRowEventHeader:function(t){jQuery(t[0]).off(u)}};var T=o.extend("sap.gantt.simple.GanttPointerExtension",{_init:function(t,e){this._oCursorLineDrawer=new i;this.bPreventSingleClick=false;this.iTableAutoScrollTimerId=null;this._iStep=0;this._iHoveredRowElement=null;return"PointerExtension"},_attachEvents:function(){var t=this.getGantt();A.addEventListeners(t)},_detachEvents:function(){var t=this.getGantt();A.removeEventListeners(t)},destroy:function(){if(this._oCursorLineDrawer){this._oCursorLineDrawer.destroy()}delete this.bPreventSingleClick}});T.prototype.onGanttChartContextMenu=function(t){t.preventDefault();if(this.isEventTargetOnGanttRow(t)===false){return}var e=this.getGantt();var o=this._getRowIndexFromEvent(t);var i=e.getTable().getRows()[o].getAggregation("_settings");e.fireShapeContextMenu({rowSettings:i,pageX:t.pageX,pageY:t.pageY})};T.prototype.onGanttChartRowHoverOn=function(t){if(this.isEventTargetOnGanttRow(t)===false){return}this._iHoveredRowElement=t.target;var e=this._getRowIndexFromEvent(t);var o=this.getGantt();var i=o._getDragDropExtension();this._bIsMouseOnCorrectRow=true;if(i._bEnableRowHighlight&&i.isDragging()){this._bIsMouseOnCorrectRow=false;if(i.oLastDraggedShapeData._highlightedRowIndex){i.oLastDraggedShapeData._highlightedRowIndex.forEach(function(t){if(t===e){this._bIsMouseOnCorrectRow=true}}.bind(this))}}this.onMouseHover(e,true)};T.prototype.onGanttChartRowHoverOff=function(t){if(!this._iHoveredRowElement){return}var e=t.relatedTarget;while(e){if(e==this._iHoveredRowElement){return}e=e.parentNode}var o=this._getRowIndexFromEvent(t);this.onMouseHover(o,false);this._iHoveredRowElement=null};T.prototype.onGanttChartMouseEvent=function(t){this.updateGanttCursorLine(t);if(t.type===S.mousedown){this.oMousedownTargetElement=t.target}if(t.type===S.click||t.type===S.dblclick){if(this.isEventTargetOnGanttRow(t)===false){return}this.dispatchGanttClick(t)}this.onMouseEnterLeaveEvent(t)};T.prototype.onCrossSvgMouseEvent=function(t){var e=this.getGantt();if(t.type===S.mousemove){if(this.needAutoscrollInContainerIfNecessary()){this.updateCursorStyle("move");this.tableAutoScroll(t)}else{var o=e._getDragDropExtension();var i=e._getConnectExtension();var r=e._getResizeExtension();var n=e._getZoomExtension();if(o.isDeltaLineDragging()||o.isAdhocLineDragging()||o.isDragging()||r.isResizing()||i.isShapeConnecting()||n.isTimeZooming()){this.tableAutoScroll(t)}}}if(t.type===S.mouseup){this.oMouseupTargetElement=t.target;this._bAutoScroll=false}};T.prototype.needAutoscrollInContainerIfNecessary=function(){var t=this.getGantt().getParent();if(t&&t.getGanttCharts){var e=t.getGanttCharts();var o=this.getGantt();return e.some(function(t){return t!==o&&t._getDragDropExtension().isDragging()})}return false};T.prototype.updateCursorStyle=function(t){document.body.style.cursor=t;this.getDomRefs().ganttSvg.style.cursor=t};T.prototype.isPointerInGanttChart=function(t){return this._bMouseOnSvg};T.prototype.isPointerInCorrectRow=function(t){return this._bIsMouseOnCorrectRow};T.prototype.onMouseEnterLeaveEvent=function(t){this.updateCursorStyle("default");if(t.type===S.mouseenter){this._bMouseOnSvg=true}else if(t.type===S.mouseleave){this._bMouseOnSvg=false}};T.prototype.dispatchGanttClick=function(t){if(t.type===S.click){if(this.oMousedownTargetElement===this.oMouseupTargetElement){this.onGanttSingleClick(t);delete this.oMouseupTargetElement;delete this.oMousedownTargetElement}}else if(t.type===S.dblclick){this.onGanttDoubleClick(t)}};T.prototype.dispatchGanttClickHeader=function(t){if(t.type===S.click){this.onGanttSingleClick(t);delete this.oMouseupTargetElement;delete this.oMousedownTargetElement}};T.prototype.isEventTargetOnGanttRow=function(t){return jQuery(t.target).hasClass("sapGanttBackgroundSVGRow")};T.prototype._getRowIndexFromEvent=function(t){return parseInt(t.target.getAttribute("data-sap-ui-index"),10)};T.prototype._getRowIndexFromElement=function(t){return parseInt(t.getAttribute("data-sap-ui-index"),10)};T.prototype.onGanttSingleClick=function(t){this.getGantt().getSelection().clearAllSelectedShapeIds();this.getGantt().getSelection().updateShape(null,{selected:false,ctrl:t.ctrlKey||t.metaKey});var e=this.getGantt();n.resetStrokeDasharray(e);var o=this._getRowIndexFromEvent(t);var i=e.getTable().getRows()[o];if(!i){return}var r=function(){if(this.bPreventSingleClick===false){this._selectTableRow(e,o);e.fireShapePress({shape:null,row:i})}this.bPreventSingleClick=false}.bind(this);if(e.getDisableShapeDoubleClickEvent()){this.bPreventSingleClick=false;r();return}this.iSingleClickTimer=window.setTimeout(r.bind(this),300)};T.prototype.onGanttDoubleClick=function(t){var e=this.getGantt(),o=e.getDisableShapeDoubleClickEvent(),i,r;if(!o){window.clearTimeout(this.iSingleClickTimer);this.bPreventSingleClick=true}i=this._getRowIndexFromEvent(t);r=e.getTable().getRows()[i];this._selectTableRow(e,i);if(!o){e.fireShapeDoubleClick({shape:null,row:r})}};T.prototype._selectTableRow=function(t,e){var o=this.getGantt().getTable().getSelectionBehavior();var i=sap.ui.table.SelectionBehavior;if(i.Row===o||i.RowOnly===o){t.getSyncedControl().syncRowSelection(e)}};T.prototype.onMouseHover=function(t,e){this.getGantt().getSyncedControl().syncRowHover(t,e)};T.prototype._getAutoScrollStep=function(){if(this._bAutoScroll){return this._iStep}return 0};T.prototype.updateGanttCursorLine=function(t){if(this.getGantt().getEnableCursorLine()===false){return}if(this.getGantt()._getDragDropExtension().isSnapping){return}if(t.type===S.mousemove){var e=r.getEventSVGPoint(this.getDomRefs().ganttSvg,t);this._toggleCursorLine(true,e)}else if(t.type===S.mouseleave){this._toggleCursorLine(false)}};T.prototype._toggleCursorLine=function(t,e){var o=this._getCursorLineDOMs();var i=this.getGantt().getParent();var r=i.isA("sap.gantt.simple.GanttChartContainer")&&i.getEnableStatusBar();if(t){this._oCursorLineDrawer.drawSvg(o.allGanttSvg,o.allHeaderSvg,this.getGantt().getLocale(),e);if(r){this.customBar(i,true,this.getGantt().getAxisTime().viewToTime(e.x))}i._bCalcTimeStamp=true;i._timeStamp=false}else{this._oCursorLineDrawer.destroySvg(o.allGanttSvg,o.allHeaderSvg);if(r){this.customBar(i,false)}}};T.prototype.customBar=function(t,o,i){var r=new l({text:""});var n=a.getDateTimeWithTimezoneInstance({pattern:t.getStatusBarDatePattern(),calendarWeekNumbering:this.getGantt().getAxisTimeStrategy().getCalendarWeekNumbering(),showTimezone:false});var s=a.getDateTimeWithTimezoneInstance({pattern:t.getStatusBarTimePattern(),showTimezone:false});t.msgText.setWidth(o?"70%":"100%");t.dateTimeText.setWidth(o?"30%":"0%");t.dateTimeText.setText(o?e.getLowerCaseLabel(e.getFormattedDate(n,i)+" "+e.getFormattedDate(s,i)):r.getText())};T.prototype._getCursorLineDOMs=function(){return{allHeaderSvg:d3.selectAll(".sapGanttChartWithSingleTable .sapGanttChartHeaderSvg"),allGanttSvg:d3.selectAll(".sapGanttChartWithSingleTable .sapGanttChartSvg")}};T.prototype.tableAutoScroll=function(t){this._bAutoScroll=false;var e=this.getGantt();var o=e._getDragDropExtension();var i=o.isDragging();var r=e.getDragOrientation();var n=i&&r===g.Horizontal;var a=i&&r===g.Vertical;if(this.ifAutoScrollToRight()&&!a){window.setTimeout(function(){A.doGanttAutoScroll(this.getGantt(),m.Forward,t)}.bind(this),w)}else if(this.ifAutoScrollToLeft()&&!a){window.setTimeout(function(){A.doGanttAutoScroll(this.getGantt(),m.Backward,t)}.bind(this),w)}else if(this.ifAutoScrollToDown()&&!n){window.setTimeout(function(){A.doGanttAutoScroll(this.getGantt(),m.Bottom,t)}.bind(this),w)}else if(this.ifAutoScrollToUp()&&!n){window.setTimeout(function(){A.doGanttAutoScroll(this.getGantt(),m.Top,t)}.bind(this),w)}else{this._bAutoScroll=false}};T.prototype.ifAutoScrollToRight=function(){var t=this.getAutoScrollPosition();this._bAutoScroll=t.iLocationX>t.oScrollAreaRect.left+t.iScrollAreaWidth-t.iScrollTriggerAreaWidth&&t.iLocationX<t.oScrollAreaRect.left+t.iScrollAreaWidth&&t.iScrollAreaScrollLeft+t.iScrollAreaWidth<t.oScrollArea.scrollWidth;return this._bAutoScroll};T.prototype.ifAutoScrollToLeft=function(){var t=this.getAutoScrollPosition();this._bAutoScroll=t.iLocationX<t.oScrollAreaRect.left+t.iScrollTriggerAreaWidth&&t.iLocationX>t.oScrollAreaRect.left&&t.iScrollAreaScrollLeft>0;return this._bAutoScroll};T.prototype.ifAutoScrollToDown=function(){var t=this.getAutoScrollPosition();this._bAutoScroll=t.iLocationY>t.oVisibleScrollAreaRect.top+t.iVisibleScrollAreaHeight-t.iScrollTriggerAreaHeight&&t.iLocationY<t.oVisibleScrollAreaRect.top+t.iVisibleScrollAreaHeight&&t.iScrollAreaScrollTop+t.iScrollAreaHeight-t.iBaseRowHeight<=t.iScrollHeight;return this._bAutoScroll};T.prototype.ifAutoScrollToUp=function(){var t=this.getAutoScrollPosition();this._bAutoScroll=t.iLocationY<t.oVisibleScrollAreaRect.top+t.iScrollTriggerAreaHeight&&t.iLocationY>t.oVisibleScrollAreaRect.top;return this._bAutoScroll};T.prototype.getAutoScrollPosition=function(){var e=t.getConfiguration().getRTL();var o=this.getGantt().getTable();var i=20,n=20,a=document.getElementById(this.getGantt().getId()+"-gantt"),l=jQuery(a),s=a.getBoundingClientRect(),u=l.outerWidth(),c=l.outerHeight(),g=s,h=c,f=this.getGantt()._oExpandModel.getBaseRowHeight(),d=e?l.scrollLeftRTL():l.scrollLeft();var p=jQuery(o.getDomRef(sap.ui.table.SharedDomRef.VerticalScrollBar)),v=p.scrollTop(),S=p.get(0).scrollHeight;var m=r.getLatestCursorPosition().pageX,w=r.getLatestCursorPosition().pageY;return{iLocationX:m,iLocationY:w,oScrollAreaRect:s,oScrollArea:a,iScrollAreaWidth:u,iScrollTriggerAreaWidth:i,iScrollTriggerAreaHeight:n,iScrollAreaScrollLeft:d,oVisibleScrollAreaRect:g,iVisibleScrollAreaHeight:h,iScrollAreaScrollTop:v,iBaseRowHeight:f,iScrollHeight:S,iScrollAreaHeight:c}};T.prototype.allowAutoScroll=function(){return this.ifAutoScrollToRight()||this.ifAutoScrollToLeft()||this.ifAutoScrollToDown()||this.ifAutoScrollToUp()};return T});
//# sourceMappingURL=GanttPointerExtension.js.map