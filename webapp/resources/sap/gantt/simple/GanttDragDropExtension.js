/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/events/KeyCodes","sap/ui/core/Core","sap/gantt/library","./GanttExtension","./CoordinateUtils","./GanttUtils","sap/gantt/misc/Format","./RenderUtils","sap/gantt/misc/Utility"],function(jQuery,t,e,a,i,r,n,o,s,g){"use strict";var h=".sapGanttDragDrop";var p=["mousemove","mouseup","keydown"];var l="mousedown";var d=p.reduce(function(t,e){t[e]=e;return t},{});d[l]=l;var u=p.map(function(t){return t+h});var v=l+h;var D=3;var f=a.dragdrop.GhostAlignment;var c=a.dragdrop.SnapMode;var m=sap.gantt.DragOrientation;var S={dispatchEvent:function(t){var e=this._getDragDropExtension();if(t.type===d.mousedown){e.onMouseDown(t)}else if(t.type===d.mousemove){e.onMouseMove(t)}else if(t.type===d.mouseup){e.onMouseUp(t)}else if(t.type===d.keydown){e.onKeydown(t)}},addEventListeners:function(t){this.removeEventListeners(t);var e=jQuery(t._getDragDropExtension().getDomRefs().ganttSvg);e.on(v,S.dispatchEvent.bind(t));var a=jQuery(t._getDragDropExtension().getDomRefs().headerSvg);a.on(v,S.dispatchEvent.bind(t))},removeEventListeners:function(t){var e=jQuery(t._getDragDropExtension().getDomRefs().ganttSvg);e.off(h);var a=jQuery(t._getDragDropExtension().getDomRefs().headerSvg);a.off(h)},addDragDropEventListeners:function(t){this.removeDragDropEventListeners(t);u.forEach(function(e){jQuery(document).on(e,S.dispatchEvent.bind(t))})},removeDragDropEventListeners:function(t){u.forEach(function(t){jQuery(document).off(t)})}};var y=i.extend("sap.gantt.simple.GanttDragDropExtension",{_init:function(t,e){this._initDragStates();return"DragDropExtension"},_attachEvents:function(){var t=this.getGantt();S.addEventListeners(t)},_detachEvents:function(){var t=this.getGantt();S.removeEventListeners(t)}});y.prototype._initDragStates=function(){this.bDragging=false;this.adhocLineDrag=false;this.deltaLineDrag=false;this.adhocLineDragStart=false;this.deltaLineDragStart=false;this.isCursorlineDisabled=false;this.bElementDraggable=false;this.oAdhocLineElmDraggable=false;this.oDeltaLineElmDraggable=false;this.oMouseDownTarget=null;this.oLastDraggedShapeData=null;this.mDragPoint={};this.bDragging=false;this.dragGhost=null;this.prevDragPoint={};this.snapTimer=null;this.snapVal=0;this.isSnapping=false;this.cursorLineSnapPoint=null};y.prototype.onAdhocMarkerMouseDown=function(t){var a=r.getEventSVGPoint(this.getDomRefs().headerSvg,t),i=t.target.getBBox();this.oMouseDownTarget=t.target;var n=e.byId(this.oMouseDownTarget.id),o={x:0,y:0};if(n){o=g.getShapeBias(n)}this.mDragPoint={cursorX:a.x,cursorY:a.y,shapeX:i.x,shapeY:i.y,shapeWidth:i.width,shapeBias:o};S.addDragDropEventListeners(this.getGantt());this.adhocLineDrag=true};y.prototype.onDeltaAreaMouseDown=function(t){var a=r.getEventSVGPoint(this.getDomRefs().headerSvg,t),i=t.target.getBBox();this.oMouseDownTarget=t.target;var n=e.byId(this.oMouseDownTarget.id),o={x:0,y:0};if(n){o=g.getShapeBias(n)}this.mDragPoint={cursorX:a.x,cursorY:a.y,shapeX:i.x,shapeY:i.y,shapeWidth:i.width,shapeBias:o};var s=n.getParent();this.oLastDraggedShapeData={timeStamp:s.getTimeStamp(),endTimeStamp:s.getEndTimeStamp()};S.addDragDropEventListeners(this.getGantt());this.deltaLineDrag=true};y.prototype.onAdhocLineDrop=function(t){if(this.oMouseDownTarget){var e=jQuery(this.oMouseDownTarget).control(0,true).getParent();var a=this._getAdhocDropData(t);if(a){e.fireAdhoclineDrop(a)}if(this.isCursorlineDisabled){this.getGantt().setEnableCursorLine(true)}this.stopDragging()}};y.prototype.onDeltaLineDrop=function(t){if(this.oMouseDownTarget){var e=jQuery(this.oMouseDownTarget).control(0,true).getParent();var a=this._getDeltaMarkerDropEvent(t);if(a){e.fireDeltalineDrop(a)}if(this.isCursorlineDisabled){this.getGantt().setEnableCursorLine(true)}this.stopDragging()}};y.prototype.onAdhocLineMove=function(t){if(!this.adhocLineDragStart){this.dragGhost=this.createDragGhost(this.oMouseDownTarget);this._hideScrollBarOnBody(true);this.adhocLineDragStart=true;if(this.getGantt().getEnableCursorLine()){this.getGantt().setEnableCursorLine(false);this.isCursorlineDisabled=true}}else{this.onLineDrag(t)}};y.prototype.onDeltaLineMove=function(t){if(!this.deltaLineDragStart){this.dragGhost=this.createDragGhost(this.oMouseDownTarget);this._hideScrollBarOnBody(true);this.deltaLineDragStart=true;if(this.getGantt().getEnableCursorLine()){this.getGantt().setEnableCursorLine(false);this.isCursorlineDisabled=true}}else{this.onLineDrag(t)}};y.prototype.onLineDrag=function(t){if(this.isValidDropZoneForLines(t)){this.updateCursorStyle("Move");this.updateHeaderCursorStyle("Move")}else{this.updateCursorStyle("not-allowed");this.updateHeaderCursorStyle("not-allowed")}this.showGhost(t)};y.prototype.onMouseDown=function(t){if(t.button!==0){return}this._bGhostsPositioned=false;this.bMultipleGhosts=false;this._bEnableRowHighlight=false;var a;if(this.isEventTargetAdhocLine(t)){this.oAdhocLineElmDraggable=this.isAdhocLineDraggable(t);if(this.oAdhocLineElmDraggable){this.onAdhocMarkerMouseDown(t);return}}if(this.isEventTargetDeltaLine(t)){this.oDeltaLineElmDraggable=this.isDeltaLineDraggable(t);if(this.oDeltaLineElmDraggable){this.onDeltaAreaMouseDown(t);return}}if(!this.getGantt().getEnableSelectAndDrag()){a=this.getShapeElementByTarget(t.target);if(a){this.shapeSelectedOnMouseDown=true;this.initiallySelected=a.getSelected();if(!(a.isA("sap.gantt.simple.Relationship")&&this.getGantt().getIsConnectorDetailsVisible())){this.getGantt().getSelection().updateShape(a.getShapeUid(),{selected:true,ctrl:t.ctrlKey||t.metaKey,draggable:a.getDraggable(),time:a.getTime(),endTime:a.getEndTime()})}}}this.bElementDraggable=this.isEventTargetDraggable(t);if(this.bElementDraggable){var i=r.getEventSVGPoint(this.getDomRefs().ganttSvg,t);var o=this.getDraggableDOMElement(t.target),s=e.byId(o.id),h=s.getDomRef("nonLabelGroup")?s.getDomRef("nonLabelGroup").getBBox():o.getBBox(),p={x:0,y:0};if(s){p=g.getShapeBias(s)}this.mDragPoint={cursorX:i.x,cursorY:i.y,shapeX:h.x,shapeY:h.y,shapeWidth:h.width,shapeBias:p};a=this.getShapeElementByTarget(o);this.oMouseDownTarget=o;this.oLastDraggedShapeData={shapeUid:a.getShapeUid(),startTime:a.getTime(),endTime:a.getEndTime()};this.oSourceRow=this.getRowByShape(a);if(this.getGantt().getDragOrientation()===m.Horizontal){this.oCurrentRow=n.getRowInstancefromShape(a)}var l=n.getShapesWithUid(this._gantt.getId(),this._gantt.getSelectedShapeUid());this._aVisibleDraggableShapes=[];l.forEach(function(t){if(t&&t.getDraggable()&&t.sParentAggregationName!=="relationships"){this._aVisibleDraggableShapes.push(t)}}.bind(this));this.bMultipleGhosts=this._aVisibleDraggableShapes.length>1;this.mGhostLabelStyle={};this._bEnableRowHighlight=a.getDragHighlightRows().length>0&&!this.bMultipleGhosts;S.addDragDropEventListeners(this.getGantt())}};y.prototype.updateCursorStyle=function(t,e){document.body.style.cursor=t;this.getDomRefs().ganttSvg.style.cursor=t;if(e){this.getDomRefs().ganttChart.style.pointerEvents=e;this.getDomRefs().gantt.style.pointerEvents="auto";this._bArePointerEventsDisabled=true;if(this.getDomRefs().ganttChartContainerToolbar){this.getDomRefs().ganttChartContainerToolbar.style.pointerEvents=e}}else{if(this._bArePointerEventsDisabled){this.getDomRefs().ganttChart.style.removeProperty("pointer-Events");this.getDomRefs().gantt.style.removeProperty("pointer-Events");this._bArePointerEventsDisabled=false;if(this.getDomRefs().ganttChartContainerToolbar){this.getDomRefs().ganttChartContainerToolbar.style.removeProperty("pointer-Events")}}}};y.prototype.updateHeaderCursorStyle=function(t,e){this.getDomRefs().headerSvg.style.cursor=t;if(e){this.getDomRefs().ganttChart.style.pointerEvents=e;this.getDomRefs().gantt.style.pointerEvents="auto";this._bArePointerEventsDisabled=true;if(this.getDomRefs().ganttChartContainerToolbar){this.getDomRefs().ganttChartContainerToolbar.style.pointerEvents=e}}else{if(this._bArePointerEventsDisabled){this.getDomRefs().ganttChart.style.removeProperty("pointer-Events");this.getDomRefs().gantt.style.removeProperty("pointer-Events");this._bArePointerEventsDisabled=false;if(this.getDomRefs().ganttChartContainerToolbar){this.getDomRefs().ganttChartContainerToolbar.style.removeProperty("pointer-Events")}}}};y.prototype.onMouseMove=function(t){if(this.skipEvent(t)){return}if(!!this.adhocLineDrag&&!!this.oMouseDownTarget){this.onAdhocLineMove(t);return}if(!!this.deltaLineDrag&&!!this.oMouseDownTarget){this.onDeltaLineMove(t);return}if(this.bDragging===false){var a=this.getGantt(),i=this.getShapeElementByTarget(t.target);if(this._bEnableRowHighlight&&i){this.getShapeDndRowHighlightIndex(a,i)}var n=r.getEventSVGPoint(this.getDomRefs().ganttSvg,t),o=this.isExceedDraggingThreshold(n),s=o&&this.isAllowedVerticalOrentationDrag();this.bDragging=s;this._aShapeNodes=[];this._aGhostImages=[];if(s&&this.oMouseDownTarget){this._hideScrollBarOnBody(true);var h=e.byId(this.oMouseDownTarget.id);this.oTargetDom=h.getDomRef("nonLabelGroup")?h.getDomRef("nonLabelGroup"):this.oMouseDownTarget;this.dragGhost=this.createDragGhost(this.oTargetDom,true);var p=this.oTargetDom.getBBox();if(this.bMultipleGhosts){var l=g.getShapeBias(h);this._coordinateDiff={};var d=e.getConfiguration().getRTL();var u=d?p.x+l.x+p.width:p.x+l.x;var v=p.y+l.y;this._aVisibleDraggableShapes.forEach(function(t){if(t.getId()!==this.oMouseDownTarget.id){var e=t.getDomRef("nonLabelGroup")?t.getDomRef("nonLabelGroup"):document.getElementById(t.getId());this.createDragGhost(e,false);var a=d?e.getBBox().width:0;l=g.getShapeBias(t);var i={xDiff:e.getBBox().x+l.x+a-u,yDiff:e.getBBox().y+l.y-v,shape:t};this._coordinateDiff[t.getId()]=i}}.bind(this))}this._bFirstTimeDrag=true;var D=this._getDragStartEventData(t);if(D){this.getGantt().fireDragStart(D)}}else if(o){this.updateCursorStyle("not-allowed","none")}}else{var f=r.getEventSVGPoint(this.getDomRefs().ganttSvg,t);if(Object.keys(this.prevDragPoint).length===0||this.prevDragPoint.cursorX!==f.x||this.prevDragPoint.cursorY!==f.y){this.prevDragPoint={cursorX:f.x,cursorY:f.y};if(this.bMultipleGhosts&&this._bFirstTimeDrag){this.iGhostTimer=window.setTimeout(function(){this._updateGhostShapesPosition()}.bind(this),100);this._bGhostsPositioned=true}this._bFirstTimeDrag=false;this.onDragging(t)}}};y.prototype.getShapeDndRowHighlightIndex=function(t,e){var a=t.getTable(),i=a.getRows(),r=i[0].getIndex();var n=e?e.getDragHighlightRows():this.oLastDraggedShapeData._dragHighlightRows;this.oLastDraggedShapeData._highlightedRowIndex=[];if(n){n.forEach(function(t){var e=i.filter(function(e){return e.getAggregation("_settings").getRowId()===t})[0];if(e){this.oLastDraggedShapeData._highlightedRowIndex.push(e.getIndex()-r)}}.bind(this));this.oLastDraggedShapeData._dragHighlightRows=n}};y.prototype._updateGhostShapesPosition=function(){var t=document.getElementsByClassName("sapGanttDragGhost");var e=document.getElementById("sapGanttDragGhostWrapper");if(e){var a=[],i;for(i=0;i<t.length;i++){a.push(t[i].offsetHeight)}while(document.getElementsByClassName("sapGanttDragGhost").length>1){e.lastElementChild.remove()}var r=a[0];for(i=1;i<this._aShapeNodes.length;i++){var n=this._aShapeNodes[i];var o=this._coordinateDiff[n.id].xDiff;var s=this._coordinateDiff[n.id].yDiff;var g={left:o+"px",top:s-r+"px"};var h=this._getGhostLabel(this._coordinateDiff[n.id].shape,n);var p="<div class='sapGanttDragGhost'>"+"<img class='sapGanttDragGhostImg' src='"+this._aGhostImages[i]+"'>"+h+"</div>";e.insertAdjacentHTML("beforeend",p);e.lastElementChild.style.left=g.left;e.lastElementChild.style.top=g.top;if(h!==""){this._updateGhostLabelStyle()}r+=a[i]}e.classList.remove("sapGanttDragElementHidden")}};y.prototype._getGhostLabel=function(t,a){if(!this.getGantt().getShowTextOnGhost()){return""}var i="",r="",n="13px",o="#000",s="Arial",g="normal";var h=t.getVerticalTextAlignment();var p=a.nextSibling;if(p&&p.tagName==="text"&&t.getShowTitle()&&t.getTitle()&&t.getTitle().length&&p.textContent&&p.textContent.length){r=p.textContent;n=p.style.fontSize||n;o=p.style.fill||o;s=p.style.fontFamily||s;g=p.style.fontWeight||g}else{return i}var l=e.getConfiguration().getRTL();var d="0px",u="0px";if(l){d=a.getBBox().x-t.getXBias()+a.getBBox().width-(p.getBBox().x+p.getBBox().width)+"px"}else{u=p.getBBox().x-(a.getBBox().x+t.getXBias())+"px"}var v=a.getBBox().height-p.getBBox().height;if(h==="Top"){v=0}else if(h==="Center"){v=v/2}this.mGhostLabelStyle={fontSize:n,color:o,fontFamily:s,fontWeight:g,top:v+"px",right:d,left:u};i="<div class='sapGanttDragGhostLabel'>"+r+"</div>";return i};y.prototype._updateGhostLabelStyle=function(){var t=document.getElementsByClassName("sapGanttDragGhostLabel");var e=t[t.length-1];for(var a in this.mGhostLabelStyle){e.style[a]=this.mGhostLabelStyle[a]}};y.prototype.onMouseUp=function(t){if(this.bElementDraggable===true&&this.bDragging===false){this.stopDragging(t);this._initDragStates();return}if(!!this.adhocLineDragStart&&!!this.oMouseDownTarget){this.onAdhocLineDrop(t);this._initDragStates();return}if(!!this.deltaLineDragStart&&!!this.oMouseDownTarget){this.onDeltaLineDrop(t);this._initDragStates();return}var e=this._getShapeDropEventData(t);this.stopDragging(t);if(e){var a=this.getGantt();if(a.getEnablePseudoShapes()){var i=e.targetRow&&e.targetRow.getIndex();var r=e.draggedShapeDates;a.pseudoShapeSpecificData=a.pseudoShapeSpecificData?a.pseudoShapeSpecificData:{};a.pseudoShapeSpecificData.oDraggedShapeDates=r;r&&Object.keys(r).forEach(function(t){var e=n.getShapesWithUid(a.getId(),[t])[0];var r=e.getParentRowSettings().getParentRow().getIndex&&e.getParentRowSettings().getParentRow().getIndex();a.pseudoShapeSpecificData.draggedShapeTRowIndex=i==undefined?r:i;var o=e.getParent().isA("sap.gantt.simple.BaseConditionalShape")?e.getParent().getParent()._parent:e.getParent()._parent;if(o){var s=a.oOverlapShapeIds&&a.oOverlapShapeIds[r]&&a.oOverlapShapeIds[r].indexOf(e.getShapeId());a.oOverlapShapeIds&&a.oOverlapShapeIds[r]&&a.oOverlapShapeIds[r].splice(s,1)}});a.pseudoShapeSpecificData.needUpdateForTasksInAggr=true}this.getGantt().triggerShapeDrop(e)}if(this.oMouseDownTarget){var o=this.getShapeElementByTarget(this.oMouseDownTarget);if(o){n.rerenderAssociatedRelationships(this.getGantt(),o)}}this._initDragStates()};y.prototype._getDragStartEventData=function(t){return{sourceGanttChart:this.getGantt(),draggedShapeDates:this._getDraggedShapeDates(),lastDraggedShapeUid:this.oLastDraggedShapeData.shapeUid,cursorDateTime:this._getGhostTime(t).cursorTime}};y.prototype._getShapeDropEventData=function(t){var e=this.getGantt();var a=e._getPointerExtension();if(this.isValidDropZone(t)&&a.isPointerInCorrectRow()){var i;var r=this._getDraggedShapeDates();var o=this.getGanttChartByTarget(t.target);if(this.getGantt().getDragOrientation()===m.Horizontal){i=this.oCurrentRow}else{i=n.getRowInstance(t,o.getTable())}var s=this.getShapeElementByTarget(t.target);var g=this._getGhostTime(t);return{dragged:true,sourceGanttChart:e,targetGanttChart:o,draggedShapeDates:r,lastDraggedShapeUid:this.oLastDraggedShapeData.shapeUid,targetRow:i,cursorDateTime:g.cursorTime,newDateTime:g.newDateTime,targetShape:s,sourceRowData:this.oSourceRow}}else{return{dragged:false}}};y.prototype._getAdhocDropData=function(t){if(this.isValidDropZoneForLines(t)){var e=this.getGantt();var a=e.getAxisTime();var i=r.getEventSVGPoint(this.getDomRefs().headerSvg,t);var n=o.dateToAbapTimestamp(a.viewToTime(this.mDragPoint.cursorX));var s=o.dateToAbapTimestamp(a.viewToTime(i.x));return{newTimeStamp:s,oldTimeStamp:n}}};y.prototype._getGhostTime=function(t,a){var i=this.getGantt();var n=this.getGanttChartByTarget(t.target);var o=n!=null?n.getId()!==i.getId():false;var s=o?n.getAxisTime():i.getAxisTime();var g=o?window.document.getElementById(n.getId()+"-svg"):window.document.getElementById(i.getId()+"-svg");var h=this.mDragPoint.shapeBias.x;var p=a?r.getEventSVGPoint(g,t).x:r.getEventSVGPoint(g,t).x-h;if(i.getSnapMode()!==c.None){p=p-this.snapVal}var l=s.viewToTime(p);var d=l;var u=e.getConfiguration().getRTL();var v=this.mDragPoint.shapeX+h,D=u?-this.mDragPoint.shapeWidth:this.mDragPoint.shapeWidth,S=this.mDragPoint.cursorX;var y=l;var T=l;var x=this.oLastDraggedShapeData.endTime-this.oLastDraggedShapeData.startTime;if(this.getGantt().getDragOrientation()===m.Vertical){y=this.oLastDraggedShapeData.startTime;T=this.oLastDraggedShapeData.endTime;d=y}else{if(this.getGantt().getGhostAlignment()===f.Start){T=x?new Date(y.getTime()+x):s.viewToTime(p+D);d=l}else if(this.getGantt().getGhostAlignment()===f.End){y=x?new Date(T.getTime()-x):s.viewToTime(p-D);d=l}else if(this.getGantt().getGhostAlignment()===f.None){var G=u?p-D-(S-v):p-(S-v);var b=s.viewToTime(G);y=b;T=x?new Date(y.getTime()+x):s.viewToTime(G+D);d=b}}return{newDateTime:d,cursorTime:l,time:y,endTime:T}};y.prototype._getDeltaMarkerDropEvent=function(t){if(this.isValidDropZoneForLines(t)){var a=jQuery(this.oMouseDownTarget).control(0,true).getParent();var i=e.getConfiguration().getRTL();var n=this.getGantt().getGhostAlignment();var s=this.getGantt().getAxisTime();var g=r.getEventSVGPoint(this.getDomRefs().headerSvg,t);var h,p;var l=this.mDragPoint.shapeWidth,d=this.mDragPoint.shapeX,u=this.mDragPoint.cursorX;if(n===f.Start){h=i?g.x-l:g.x;p=i?g.x:g.x+l}else if(n===f.None){h=g.x+(d-u);p=h+l}else if(n===f.End){h=i?g.x:g.x-l;p=i?g.x+l:g.x}return{newStartTime:o.dateToAbapTimestamp(s.viewToTime(i?p:h)),newEndTime:o.dateToAbapTimestamp(s.viewToTime(i?h:p)),oldStartTime:a.getTimeStamp(),oldEndTime:a.getEndTimeStamp()}}};y.prototype._getDraggedShapeDates=function(){var t=this.getGantt(),e=t.getSelection();var a=e.allSelectedDraggableUid();var i={};a.forEach(function(a){var r=e.getSelectedShapeDataByUid(a),o;if(!r.time||!r.endTime){o=t.setTimeForGroupShape(n.getShapesWithUid(t.getId(),[a])[0])}i[a]={time:r.time||o&&o.getTime(),endTime:r.endTime||o&&o.getEndTime()}});return i};y.prototype.getDroppedShapeStartTime=function(t,a,i){if(this.getGantt().getGhostAlignment()===f.None){var r=this.mDragPoint.shapeX,n=this.mDragPoint.shapeWidth,s=this.mDragPoint.cursorX;var g=e.getConfiguration().getRTL();var h=g?t+n-(s-r):t-(s-r);var p=a.viewToTime(h),l=o.abapTimestampToDate(p);return l}return i};y.prototype.isValidDropZone=function(t){return jQuery(t.target).closest("svg.sapGanttChartSvg").length===1};y.prototype.isValidDropZoneForLines=function(t){return jQuery(t.target).closest("svg.sapGanttChartHeaderSvg").length===1||jQuery(t.target).closest("svg.sapGanttChartSvg").length===1};y.prototype._hideScrollBarOnBody=function(t){jQuery(document.body).toggleClass("sapGanttDraggingOverflow",t)};y.prototype.onKeydown=function(e){if(this.skipEvent(e)){return}if(e.keyCode===t.ESCAPE){this.stopDragging(e);this.getGantt()._triggerCancelShapeDrop();this._initDragStates()}};y.prototype.stopDragging=function(t){this._enableTextSelection();this._avoidShapeSelectionAfterDragging();this.removeGhost();this.updateCursorStyle("default");this.updateHeaderCursorStyle("default");this._hideScrollBarOnBody(false);this._stopAutoScroll();S.removeDragDropEventListeners(this.getGantt())};y.prototype._avoidShapeSelectionAfterDragging=function(){if(this.bDragging&&this.oMouseDownTarget){var t=this.getShapeElementByTarget(this.oMouseDownTarget);window.setTimeout(function(){if(t){window.clearTimeout(t.iSingleClickTimer)}},100,this)}};y.prototype.isEventTargetDraggable=function(t){var e=this.getShapeElementByTarget(t.target);if(e){return e.getDraggable()&&(e.getSelected()||!this.getGantt().getEnableSelectAndDrag())}return false};y.prototype.getShapeElementByTarget=function(t){return jQuery(this.getDraggableDOMElement(t)).control(0,true)};y.prototype.getGanttChartByTarget=function(t){return jQuery(t).closest("svg.sapGanttChartSvg").control(0,true)};y.prototype.isEventTargetAdhocLine=function(t){return jQuery(t.target).control(0,true)&&jQuery(t.target).control(0,true).sParentAggregationName==="_marker"};y.prototype.isEventTargetDeltaLine=function(t){return jQuery(t.target).control(0,true)&&jQuery(t.target).control(0,true).sParentAggregationName==="_headerDeltaArea"};y.prototype.isAdhocLineDraggable=function(t){var e=jQuery(t.target).control(0,true).getParent();return e.getDraggable()&&e._getSelected()};y.prototype.isDeltaLineDraggable=function(t){var e=jQuery(t.target).control(0,true).getParent();return e.getDraggable()&&e._getIsSelected()};y.prototype.getDraggableDOMElement=function(t){return jQuery(t).closest("["+n.SHAPE_ID_DATASET_KEY+"]").get(0)};y.prototype.isExceedDraggingThreshold=function(t){return Math.abs(t.x-this.mDragPoint.cursorX)>D||Math.abs(t.y-this.mDragPoint.cursorY)>D};y.prototype.onDragging=function(t){if(this.dragGhost){this.isSnapping=false;var e=this.getGantt()._getPointerExtension();if(e.isPointerInGanttChart()===true&&e.isPointerInCorrectRow()===true){this.updateCursorStyle("move")}else{this.updateCursorStyle("not-allowed","none");this.updateHeaderCursorStyle("not-allowed","none");this._stopAutoScroll()}this.showGhost(t);this._disableTextSelection();if(this.getGantt().getSnapMode()!==c.None){this.executeSnappingEffect(t)}}};y.prototype.executeSnappingEffect=function(t){if(this.snapTimer){window.clearTimeout(this.snapTimer);this.snapTimer=null}this.snapTimer=window.setTimeout(function(){this.showGhost(t,true)}.bind(this),100)};y.prototype._stopAutoScroll=function(){var t=this.getGantt()._getPointerExtension();t._bAutoScroll=false};y.prototype.isDragging=function(){return this.bDragging};y.prototype.isAdhocLineDragging=function(){return this.adhocLineDragStart};y.prototype.isDeltaLineDragging=function(){return this.deltaLineDragStart};y.prototype.skipEvent=function(t){return this.bElementDraggable===false&&this.oAdhocLineElmDraggable===false&&this.oDeltaLineElmDraggable===false};y.prototype.showGhost=function(t,e){var a=this.getGantt().getGhostAlignment();var i=document.getElementById("sapGanttDragGhostWrapper");var r=this.adhocLineDragStart||this.deltaLineDragStart?this.calcGhostAligmentForLines(t,a):this.calcGhostOffsetByAlignment(t,a,e);if(this.adhocLineDragStart||this.deltaLineDragStart){var o=n.getTimeLabel(t,this.getGantt().getAxisTime(),this.getGantt().getLocale(),this.getDomRefs().headerSvg);document.getElementById("sapGanttDragText").innerText=o}i.style.left=r.left;i.style.top=r.top;if(!this._bGhostsPositioned){i.classList.remove("sapGanttDragElementHidden")}};y.prototype.calcGhostAligmentForLines=function(t,a){var i=e.getConfiguration().getRTL();var n=r.xPosOfEvent(t);if(this.adhocLineDragStart){n-=this.mDragPoint.shapeWidth/2}if(this.deltaLineDragStart){var o=this.mDragPoint.shapeWidth,s=this.mDragPoint.shapeX,g=this.mDragPoint.cursorX;if(a===f.Start){n=i?n-o:n}else if(a===f.None){n=n+(s-g)}else if(a===f.End){n=i?n:n-o}}var h=r.getSvgScreenPoint(this.getDomRefs().headerSvg,{pageX:this.mDragPoint.cursorX,clientX:this.mDragPoint.cursorX,pageY:this.mDragPoint.cursorY,clientY:this.mDragPoint.cursorY});return{left:n+"px",top:h.y+"px"}};y.prototype.calcGhostOffsetByAlignment=function(t,a,i){var n=e.getConfiguration().getRTL();var o=this.mDragPoint.shapeWidth,s=this.mDragPoint.shapeX+this.mDragPoint.shapeBias.x,g=this.mDragPoint.cursorX;var h;var p=document.getElementById("sapGanttDragGhostWrapper").offsetWidth-document.getElementsByClassName("sapGanttDragGhostImg")[0].offsetWidth;var l=r.xPosOfEvent(t);if(this.getGantt().getDragOrientation()===m.Vertical){var d=r.getSvgScreenPoint(this.getDomRefs().ganttSvg,{pageX:this.mDragPoint.shapeX,clientX:this.mDragPoint.shapeX,pageY:this.mDragPoint.shapeY,clientY:this.mDragPoint.shapeY});h=d.x+this.mDragPoint.shapeBias.x}else{if(a===f.Start){h=n?l-o:l}else if(a===f.None){h=l+(s-g)}else if(a===f.End){h=n?l:l-o}}var u=r.getEventPosition(t).pageY-2;if(this.getGantt().getDragOrientation()===m.Horizontal){var v=r.getSvgScreenPoint(this.getDomRefs().ganttSvg,{pageX:this.mDragPoint.shapeX,clientX:this.mDragPoint.shapeX,pageY:this.mDragPoint.shapeY,clientY:this.mDragPoint.shapeY});u=v.y+this.mDragPoint.shapeBias.y}if(i){this._generateSnapvalue(t,o);h=h-this.snapVal}if(n&&this.bMultipleGhosts){h=h-p}return{left:h+"px",top:u+"px"}};y.prototype._getSnapOffsetByAligment=function(t,a){var i={};var r=this.mDragPoint.shapeWidth;var n=e.getConfiguration().getRTL();if(a===f.Start){i.xPosStart=t.x;i.xPosEnd=n?t.x-r:t.x+r}else if(a===f.End){i.xPosStart=n?t.x+r:t.x-r;i.xPosEnd=t.x}else if(a===f.None){i.xPosStart=t.x-(this.mDragPoint.cursorX-this.mDragPoint.shapeX-this.mDragPoint.shapeBias.x);i.xPosEnd=i.xPosStart+r}return i};y.prototype._getSnappedTime=function(t,e,a,i){var r,n;var o=t%e;if(o>e/2){n=e-o;r=new Date(a.getTime()+n*i)}else{n=o;r=new Date(a.getTime()-n*i)}return r};y.prototype._computeSnapping=function(t,a,i){var r=this.getGantt();var n=e.getConfiguration().getRTL();var o=this.getGantt().getGhostAlignment();var s=this.mDragPoint.shapeWidth;var g,h;if(r.getSnapMode()===c.Left){g=n?a-1:t-1;h=n?i.x-g-s:i.x-g}else if(r.getSnapMode()===c.Right){g=n?t+1:a+1;h=n?i.x-g:i.x-g+s}else{if(Math.abs(t)<Math.abs(a)){g=n?t-1:t-1;h=n?i.x-g:i.x-g}else{g=n?a-1:a+1;h=n?i.x-g-s:i.x-g+s}}if(Math.abs(g)<Math.abs(this.snapVal)){this.snapVal=g;if(o===f.Start){this.cursorLineSnapPoint=h}else if(o===f.End){this.cursorLineSnapPoint=n?h+s:h-s}else if(o===f.None){this.cursorLineSnapPoint=n?h-this.mDragPoint.cursorX:h-(this.mDragPoint.cursorX-this.mDragPoint.shapeX)}}};y.prototype._computeSnapByTime=function(t,a,i,r){var n=e.getConfiguration().getRTL();var o=this.getGantt();var s=o.getAxisTime();var g=r[i].timeInterval/60;var h=6e4;var p=s.viewToTime(t.xPosStart);var l=s.viewToTime(t.xPosEnd);var d=p.getMinutes();var u=l.getMinutes();if(g>60){d=p.getHours();u=l.getHours();g=g/60;if(d%g===0||u%g===0){d=p.getMinutes()%30;u=l.getMinutes()%30;p.setMinutes(d);l.setMinutes(u);g=60}else{p.setMinutes(0);l.setMinutes(0);h=36e5}}else if(g<1){d=p.getSeconds();u=l.getSeconds();h=1e3;g=g*60}else{p.setSeconds(0);l.setSeconds(0)}if(d%g!==0||u%g!==0){var v=n?this._getSnappedTime(u,g,l,h):this._getSnappedTime(d,g,p,h);var D=n?this._getSnappedTime(d,g,p,h):this._getSnappedTime(u,g,l,h);var f=s.timeToView(v);var c=s.timeToView(D);if(n){this._computeSnapping(t.xPosEnd-f-1,t.xPosStart-c+1,a)}else{this._computeSnapping(t.xPosStart-f+1,t.xPosEnd-c-1,a)}a.x=a.x-this.snapVal;o._getPointerExtension()._toggleCursorLine(true,a);this.isSnapping=true}else{this.snapVal=0}};y.prototype._generateSnapvalue=function(t){var a=e.getConfiguration().getRTL();var i=this.getGantt().getGhostAlignment();var o=this.getDomRefs().ganttSvg;var g=r.getEventSVGPoint(o,t);var h=this._getSnapOffsetByAligment(g,i);var p=h.xPosStart;var l=h.xPosEnd;var d=g.y;var u=this.getGantt();var v=u._getPointerExtension();var D=u.getAxisTime();var f=D.getCurrentTickTimeIntervalKey();var c=u.getSnapTimeInterval();var m=D.getZoomStrategy();this.snapVal=Number.MAX_SAFE_INTEGER/2;if(c[f]&&c[f].timeInterval){this._computeSnapByTime(h,g,f,c);return}var S=s.getGanttRenderWidth(u);var y=D.getTickTimeIntervalLabel(m.getTimeLineOption(),null,[0,S]);var T=y[1];T.forEach(function(t){this._computeSnapping(p-t.value,l-t.value,g)}.bind(this));var x=n.getVisibleElements(o,".sapGanttChartDeltaLine",".baseShapeSelection");x.forEach(function(t){var e=t.getBBox().x;this._computeSnapping(p-e,l-e,g)}.bind(this));var G=n.getVisibleElements(o,".sapGanttChartAdhocLine",".baseShapeSelection");G.forEach(function(t){var e=t.getBBox().x;this._computeSnapping(p-e,l-e,g)}.bind(this));var b=n.getVisibleElements(o,".sapGanttChartShapes",".baseShapeSelection");b.forEach(function(t){var e=t.getBBox().x,i=e+t.getBBox().width,r=t.getBBox().y,n=r+t.getBBox().height;var o=d+t.getBBox().height;if(d>r&&d<n||o>r&&o<n){var s=a?p-e:p-i;var h=a?l-i:l-e;this._computeSnapping(s,h,g)}}.bind(this));var E=n.getVisibleElements(o,".calendarPattern","rect");E.forEach(function(t){var e=t.getBBox().x,i=e+t.getBBox().width;var r=a?p-e:p-i;var n=a?l-i:l-e;this._computeSnapping(r,n,g)}.bind(this));g.x=this.cursorLineSnapPoint;v._toggleCursorLine(true,g);this.isSnapping=true};y.prototype.removeGhost=function(){this.dragGhost=null;var t=document.getElementById("sapGanttDragGhostWrapper");if(t){t.parentNode.removeChild(t)}};y.prototype.createDragGhost=function(t,e){var a=jQuery("<div id='sapGanttDragGhostWrapper' class='sapGanttDragElementHidden'></div>");if(!this.bMultipleGhosts||e){jQuery(document.body).append(a)}var i=document.createElement("canvas");var r=t.getBBox();i.width=this.normalizeGhostImageWidth(r.width);i.height=r.height;if(this.adhocLineDrag){var n=jQuery(this.oMouseDownTarget).control(0,true).getParent()._getLine();var o=document.getElementById(n.sId);var s=jQuery(this.oMouseDownTarget).control(0,true).getParent()._getHeaderLine();var g=document.getElementById(s.sId);var h=o.getBBox();var p=g.getBBox();i.height+=h.height+p.height}if(this.deltaLineDrag){var l=jQuery(this.oMouseDownTarget).control(0,true).getParent();if(l.getVisibleDeltaStartEndLines()){var d=l._getStartLine();var u=l._getEndLine();var v=l._getHeaderStartLine();var D=l._getHeaderEndLine();var f=document.getElementById(d.sId);var c=document.getElementById(u.sId);var m=document.getElementById(v.sId);var S=document.getElementById(D.sId);var y={headerStartLine:m,startLine:f,headerEndLine:S,endLine:c};var T=m.getBBox();var x=f.getBBox();i.height+=x.height+T.height}}this.createGhostImage(t,i,g,o,y,e);return a};y.prototype.normalizeGhostImageWidth=function(t){return t};y.prototype.createGhostImage=function(t,e,a,i,r,n){var o=this.serializeClonedSvg(e,t,a,i,r);var s=this._b64EncodeUnicode(o);var g="data:image/svg+xml;base64,"+s;this.appendGhostImageToWrapper(t,g,n)};y.prototype._b64EncodeUnicode=function(t){return btoa(encodeURIComponent(t).replace(/%([0-9A-F]{2})/g,function t(e,a){return String.fromCharCode("0x"+a)}))};y.prototype.appendGhostImageToWrapper=function(t,a,i){var r=document.getElementById("sapGanttDragGhostWrapper");var n=this._getDragTextOverlayStyle(t);var o=i?"":"<div id='sapGanttDragText' class='sapGanttDragTextOverlay "+n.css+"'>"+"</div>";var s=e.byId(t.id);var g=!s&&t.parentNode&&e.byId(t.parentNode.id)instanceof sap.gantt.simple.BaseGroup;if(g){s=e.byId(t.parentNode.id)}if(i&&this.getGantt().getShowTextOnGhost()){o=this._getGhostLabel(s,t)}if(this.bMultipleGhosts){this._aShapeNodes.push(g?t.parentNode:t);this._aGhostImages.push(a);if(!i){o=""}}var h="<div class='sapGanttDragGhost'>"+"<img class='sapGanttDragGhostImg' src='"+a+"'>"+o+"</div>";r.insertAdjacentHTML("beforeend",h);if(i&&this.getGantt().getShowTextOnGhost()&&o!==""){this._updateGhostLabelStyle()}};y.prototype._getDragTextOverlayStyle=function(t){var a=e.getConfiguration().getRTL();var i=this.getGantt().getGhostAlignment();var r=this.mDragPoint.shapeWidth,n=this.mDragPoint.shapeX+this.mDragPoint.shapeBias.x,o=this.mDragPoint.cursorX;var s=o-n;var g=document.getElementById("sapGanttDragGhostWrapper");var h="";if(i===f.None){if(a){g.style.setProperty("--sapShapeDragTextOverlay-right-val",r-s+"px")}else{g.style.setProperty("--sapShapeDragTextOverlay-left-val",s+"px")}}else if(i===f.End){h="sapGanttDragTextOverlayGhostAlignEnd"}g.style.setProperty("--sapShapeDragTextOverlay-lineHeight",t.getBBox().height+"px");return{css:h}};y.prototype.serializeClonedSvg=function(t,a,i,r,n){var o=d3.ns.prefix.svg;var s=a.getBBox();var g=e.getConfiguration().getRTL();var h=document.createElementNS(o,"svg");h.setAttribute("width",t.width);h.setAttribute("height",t.height);var p=a.cloneNode(true);p.style.transform="translate(0, 0)";if(!this.getGantt().getShowTextOnGhost()){this.removeOriginalTextNode(p)}else if(g&&(p.tagName==="g"||p.tagName==="text")){this._aOriginalTextX=[];this._iCount=0;this._populateTextNodeX(a);this._repositionTextNode(p)}var l=document.createElementNS(o,"g");l.setAttribute("transform","translate("+-s.x+", "+-s.y+")");l.appendChild(p);if(this.adhocLineDrag){var d=i.cloneNode(true);var u=r.cloneNode(true);l.appendChild(d);l.appendChild(u)}if(this.deltaLineDrag){var v=sap.ui.getCore().byId(this.oMouseDownTarget.id).getParent();if(v.getVisibleDeltaStartEndLines()){var D=n.headerStartLine.cloneNode(true);var f=n.startLine.cloneNode(true);var c=n.headerEndLine.cloneNode(true);var m=n.endLine.cloneNode(true);l.appendChild(D);l.appendChild(f);l.appendChild(c);l.appendChild(m)}}var S=this.getGantt().getSvgDefs();if(S){var y=jQuery(document.getElementById(S.getId())).get(0).cloneNode(true);h.appendChild(y)}h.appendChild(l);return(new XMLSerializer).serializeToString(h)};y.prototype.removeOriginalTextNode=function(t){if(t.parentNode&&t.tagName==="text"){t.parentNode.removeChild(t)}var e=t.children||t.childNodes;var a=Array.prototype.slice.call(e);a.forEach(function(t){this.removeOriginalTextNode(t)}.bind(this))};y.prototype._repositionTextNode=function(t){if(t.tagName==="text"){t.setAttribute("x",this._aOriginalTextX[this._iCount]);this._iCount++}var e=t.children||t.childNodes;var a=Array.prototype.slice.call(e);a.forEach(function(t){this._repositionTextNode(t)}.bind(this))};y.prototype._populateTextNodeX=function(t){if(t.tagName==="text"){var e=0;var a=t.getAttribute("text-anchor");var i=t.getBBox();if(a==="start"){e=i.x}else if(a==="end"){e=i.x+i.width}else{e=i.x+i.width/2}this._aOriginalTextX.push(e)}var r=t.children||t.childNodes;var n=Array.prototype.slice.call(r);n.forEach(function(t){this._populateTextNodeX(t)}.bind(this))};y.prototype.getNumberOfDragObject=function(t){var a=this.getGantt().getSelection();var i=a.numberOfSelectedDraggableShapes();var r=e.getLibraryResourceBundle("sap.gantt");var n=r.getText("GNT_DRAGGED_OBJECT");var o=r.getText("GNT_DRAGGED_OBJECTS");var s=i>1?o:n;return i+" "+s};y.prototype._disableTextSelection=function(){jQuery(document.body).attr("unselectable","on").css({"-moz-user-select":"none","-webkit-user-select":"none","user-select":"none"}).bind("selectstart",function(t){t.preventDefault();return false})};y.prototype._enableTextSelection=function(){jQuery(document.body).attr("unselectable","off").css({"-moz-user-select":"","-webkit-user-select":"","user-select":""}).unbind("selectstart")};y.prototype.isAllowedVerticalOrentationDrag=function(){var t=this.getGantt();if(t.getDragOrientation()===m.Vertical){return t.oSelection.numberOfSelectedDraggableShapes()<2}return true};y.prototype.getRowByShape=function(t){var e=n.getRowInstancefromShape(t);var a=e.clone();a=this._addBackOriginalGanttRowProperties(e,a);return a};y.prototype._addBackOriginalGanttRowProperties=function(t,e){e.oPropagatedProperties=t._getPropertiesToPropagate();e.propagateProperties(true);e.oParent=t.getParent();return e};return y});
//# sourceMappingURL=GanttDragDropExtension.js.map