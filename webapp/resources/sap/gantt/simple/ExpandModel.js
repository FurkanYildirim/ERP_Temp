/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/base/assert","sap/ui/base/ManagedObject","./AggregationUtils","./GanttUtils"],function(jQuery,e,t,a,n){"use strict";var r=t.extend("sap.gantt.simple.ExpandModel",{metadata:{properties:{baseRowHeight:{type:"int",group:"Appearance",defaultValue:null}}},constructor:function(){t.apply(this,arguments);this.mExpanded={}}});r.prototype.isTableRowHeightNeedChange=function(e,t,r,i,s){var o=false;this.rowMaxLevelMap={};var p=[];Array.isArray(s)&&s.forEach(function(e){p.push(e.getKey())});for(var h=0;h<r.length;h++){var d=r[h];var u=n.getSelectedTableRowSettings(t,d);var l=t.getParent(),g=l.getUseParentShapeOnExpand();if(!l._bExpandRows&&u==null){break}else if(u!=null){var f=u.getAllExpandableShapes(l);if(f.length===0&&!e){this.toggle(e,u,i,s,0);o=true;return o}var m=[];var c=[];var v=[];var w=[];var x=v.length;f.forEach(function(e){if(g){var t=p.indexOf(e.getScheme())>-1?[e]:[];c=e instanceof sap.gantt.simple.MultiActivityGroup?a.getNonLazyElementsByScheme(e,p):t;v=n._getExpandedChildArray(c,l,p,v);if(x!=v.length){v[v.length-1].setProperty("childElement",false,true);x=v.length}}else if(e.mBindingInfos.hasOwnProperty("subTasks")||typeof e.getSubTasks==="function"&&e.getSubTasks()){c=a.getLazyElementsByScheme(e,p);v=n._getExpandedChildArray(c,l,p,v);if(x!=v.length){v[v.length-1].getParent().setProperty("childElement",false,true);x=v.length}}else if(e.getScheme()&&p.indexOf(e.getScheme())>-1){c=[e];v=n._getExpandedChildArray(c,l,p,v);if(x!=v.length){v[v.length-1].setProperty("childElement",false,true);x=v.length}}else{c=a.getLazyElementsByScheme(e,p);w=n.calculateLevelForShapes(c,"time","endTime");m.push(w.maxLevel)}}.bind(this));if(v.length!==0){if(!l.oExpandedTableRowShapesMap){l.oExpandedTableRowShapesMap={}}l.oExpandedTableRowShapesMap[d]=v;w=n.calculateLevelForShapes(v,"time","endTime");m.push(w.maxLevel)}w=n.calculateLevelForShapes(v,"time","endTime");m.push(w.maxLevel);var E=Math.max.apply(null,m);if(E>0){this.toggle(e,u,i,s,E,g);this.rowMaxLevelMap["row"+d]=E;o=true}}}return o};r.prototype.refreshRowYAxis=function(e){if(this.hasExpandedRows()===false){return}var t=e.getParent();var a=e.getRows();var n=e.getParent().getTableRowHeights();var r=0;for(var i=0;i<a.length;i++){var s=a[i],o=s.getAggregation("_settings"),p=o.getRowUid();r+=n[i-1]||0;if(!this.isRowExpanded(p)){continue}var h=this.getBaseRowHeight();if(t.getExpandedRowHeight()){h=t.getExpandedRowHeight()}this.calcExpandRowYAxis({uid:o.getRowUid(),rowIndex:i,rowY:r,baseRowHeight:h,allRowHeights:n})}return this.getBaseRowHeight()};r.prototype.toggle=function(e,t,a,n,r,i){if(e){this.expand(t,a,n,r,i)}else{this.collapse(t,n)}};r.prototype.expand=function(t,a,n,r,i){e(typeof r==="number","iMaxNumberOfDetails must be a number");var s=t.getRowUid(),o=t.getParentGantt(),p=a.getKey(),h=a.getRowSpan();var d=[];Array.isArray(n)&&n.forEach(function(e){d.push(e.getKey())});var u=[];Array.isArray(n)&&n.forEach(function(e){u.push(e.getRowSpan())});var l=function(){if(i){if(o.oOverlapShapeIds&&o.oOverlapShapeIds[t.getParent().getIndex()]&&o.oOverlapShapeIds[t.getParent().getIndex()].length>0){if(!g||g.length===0){this.mExpanded[s]=[{scheme:"",metadata:{rowSpan:h,numberOfRows:r,main:true}},{expandSchemeShape:true,metadata:{numberOfRows:r,rowSpan:h,useParentOnExpand:true}}]}else{this.mExpanded[s][1].metadata.numberOfRows=r}}else{if(!g||g.length===0){this.mExpanded[s]=[{scheme:"",metadata:{rowSpan:h,numberOfRows:r,main:true}}]}if(!this.hasExpandScheme(s,d[f])){this.mExpanded[s].push({scheme:d[f],metadata:{numberOfRows:r,rowSpan:u[f]}})}if(!(!g||g.length===0)){for(var e=1;e<this.mExpanded[s].length;e++){this.mExpanded[s][e].metadata.numberOfRows=r}}}}else{if(!g||g.length===0){this.mExpanded[s]=[{scheme:p,metadata:{rowSpan:h,main:true}}]}if(!this.hasExpandScheme(s,d[f])){this.mExpanded[s].push({scheme:d[f],metadata:{numberOfRows:r,rowSpan:u[f]}})}if(!this.mExpanded[s][1]){this.mExpanded[s][0].metadata={numberOfRows:r,rowSpan:h,main:true}}}}.bind(this);var g=this.mExpanded[s];if(d.length){for(var f=0;f<d.length;f++){g=this.mExpanded[s];l()}}else{l()}this.updateVisibleRowSpan(s)};r.prototype.collapse=function(e,t){var a=e.getRowUid();if(!a&&!this.mExpanded[a]){return}var n=[];Array.isArray(t)&&t.forEach(function(e){n.push(e.getKey())});var r=this.mExpanded[a]||[],i=r.length;for(var s=i-1;s>-1;s--){var o=r[s];if(n.indexOf(o.scheme)>-1||!o.scheme&&o.expandSchemeShape){r.splice(s,1)}if(this.hasNoExpandRows(a)){delete this.mExpanded[a];break}else{this.updateVisibleRowSpan(a)}}};r.prototype.hasExpandScheme=function(e,t){return this.mExpanded[e].filter(function(e){return e.scheme===t}).length>0};r.prototype.hasExpandedRows=function(){return!jQuery.isEmptyObject(this.mExpanded)};r.prototype.isRowExpanded=function(e){return!this.hasNoExpandRows(e)};r.prototype.hasNoExpandRows=function(e){var t=this.mExpanded[e]||[];return t.every(function(e){return e.metadata.main&&!e.metadata.useParentOnExpand})};r.prototype.updateVisibleRowSpan=function(e){var t=this.mExpanded[e]||[];var a,n,r=0;for(var i=0;i<t.length;i++){var s=t[i];var o=s.scheme;var p=s.metadata;if(p.main){a=o;n=p;if(p.useParentOnExpand){r=p.rowSpan*(p.numberOfRows||1)}}else{r=p.rowSpan*(p.numberOfRows||1)}}n.numberOfSubRows=r;this.mExpanded[e][0]={scheme:a,metadata:n}};r.prototype.getMainRowScheme=function(e){var t=this.mExpanded[e]||[];return t.filter(function(e){return e.metadata.main}).map(function(e){return{key:e.scheme,value:e.metadata}})[0]};r.prototype.getExpandSchemeKeys=function(e){var t=this.mExpanded[e]||[];return t.filter(function(e){return!e.metadata.main}).map(function(e){return e.scheme})};r.prototype.getCalculatedRowHeight=function(e,t,a){var n=t;var r=a.getParent(),i=r.getExpandedRowHeight();var s=e.getParent().getIndex(),o=r.oOverlapShapeIds&&r.oOverlapShapeIds[s]&&r.oOverlapShapeIds[s].length>0;var p=r.getShowParentRowOnExpand()&&!r.getUseParentShapeOnExpand()||r._aExpandedIndices.indexOf(s)>-1&&o;if(this.hasExpandedRows()){var h=e.getRowUid();if(!h){return n}var d=this.mExpanded[h];if(d){var u=this.getMainRowScheme(h);if(!i){n=p?t*(u.value.rowSpan+u.value.numberOfSubRows):t*u.value.numberOfSubRows}else{if(!p){if(i<t&&u.value.numberOfSubRows===1){n=u.value.numberOfSubRows*t}else{n=u.value.numberOfSubRows*i+.5}}else{n=t*u.value.rowSpan+u.value.numberOfSubRows*i+.5}}}}return n};r.prototype.getRowHeightByIndex=function(e,t,a){if(e==null){return a}var n=e.getRows(),r=n[t].getAggregation("_settings");return this.getCalculatedRowHeight(r,a,e)};r.prototype.calcExpandRowYAxis=function(e){var t=e.uid,a=e.baseRowHeight;var n=e.rowY;var r,i,s=[];var o=[];var p=this.mExpanded[t];if(jQuery.isEmptyObject(p)){return}for(var h=0;h<p.length;h++){var d=p[h],u=d.scheme,l=d.metadata;if(l.main){r=l;i=u;if(l.useParentOnExpand){o.push(l);s.push(u)}}else{o.push(l);s.push(u)}}var g=r?r.rowSpan:1;var f={};f[i]=[g];var m=[f];for(var c=0;c<o.length;c++){var v=o[c],w=v.rowSpan,x=v.numberOfRows;var E=[];for(var R=0;R<x;R++){E.push(w)}f={};f[s[c]]=E;m.push(f)}var S=n;for(var y=0;y<m.length;y++){var b=m[y],O=Object.keys(b)[0],A=b[O];if(y===0){this._updateRowYAxis(t,O,{rowYAxis:[S].slice()})}else if(y===1){var H=[];if(A.length===1){H.push(S+this.getBaseRowHeight());S+=A[0]*a}else{for(var P=0;P<A.length;P++){if(P===0){if(this.getBaseRowHeight()!==a){S=S+A[P]*this.getBaseRowHeight()}else{S=S+A[P]*a}}else{S=S+A[P]*a}H.push(S)}}this._updateRowYAxis(t,O,{rowYAxis:H.slice()})}else{this._updateRowYAxis(t,O,{rowYAxis:H.slice()})}}};r.prototype._updateRowYAxis=function(e,t,a){var n=a.rowYAxis;var r=this.mExpanded[e]||[];for(var i=0;i<r.length;i++){var s=r[i];if(s.scheme===t||!s.scheme&&s.expandSchemeShape){s.metadata.yAxis=n;break}}};r.prototype.getRowYCenterByUid=function(e,t,a,n,r,i){var s=this.isRowExpanded(e);if(s===false){return t}var o=this.mExpanded[e],p=a||this.getMainRowScheme(e).key;for(var h=0;h<o.length;h++){var d=o[h];if(d.scheme===p||!d.scheme&&d.expandSchemeShape){var u=this.getBaseRowHeight();var l=d.metadata.yAxis,g=r.oOverlapShapeIds&&r.oOverlapShapeIds[i]&&r.oOverlapShapeIds[i].length>0;var f=r.getShowParentRowOnExpand()&&!r.getUseParentShapeOnExpand()||r._aExpandedIndices.indexOf(i)>-1&&g,m=r.getExpandedRowHeight();if(m&&!(d.metadata.main&&!d.metadata.useParentOnExpand)){if(l.length===1&&m<u&&!f){u=this.getBaseRowHeight()}else{u=m}}var c=u*d.metadata.rowSpan;var v=l.map(function(e){return e+c/2});var w=n===undefined?0:n;return v[w]}}};r.prototype.getExpandShapeHeightByUid=function(e,t,a){var n=this.mExpanded[e];var r=n&&n.filter(function(e){return e.scheme===t||!e.scheme&&e.expandSchemeShape})[0];return r?r.metadata.rowSpan*this.getBaseRowHeight():a};r.prototype.intersectRows=function(e,t){return jQuery.grep(e,function(e){return jQuery.inArray(e,t)>-1})};r.prototype.collectExpandedBgData=function(e,t,a){var n=this.intersectRows(e,Object.keys(this.mExpanded));if(jQuery.isEmptyObject(this.mExpanded)||jQuery.isEmptyObject(e)||jQuery.isEmptyObject(n)){return[]}var r=this.getBaseRowHeight();var i=[];for(var s=0;s<n.length;s++){var o=n[s],p=this.mExpanded[o]||[];for(var h=0;h<p.length;h++){var d=p[h],u=d.metadata.yAxis||[],l=d.metadata.main;if(!l||d.metadata.useParentOnExpand){var g=[];if(t){if(u.length===1&&!a&&t<this.getBaseRowHeight()){r=this.getBaseRowHeight()}else{r=t}}u.forEach(function(e){g.push({x:0,y:e,rowUid:o,rowHeight:r*d.metadata.rowSpan})});i.push(g)}}}return i};return r},true);
//# sourceMappingURL=ExpandModel.js.map