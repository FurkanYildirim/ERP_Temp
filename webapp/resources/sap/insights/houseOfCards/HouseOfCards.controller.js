/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/integration/widgets/Card","sap/ui/integration/Host","../utils/Transformations","sap/ui/model/resource/ResourceModel","sap/ui/model/json/JSONModel","../CardHelper","../utils/CardPreviewManager","sap/ui/Device","../utils/AppConstants","../utils/DeviceType","sap/ui/model/Filter","sap/ui/model/FilterOperator","../base/InMemoryCachingHost"],function(e,t,o,r,i,a,s,n,d,c,h,l,g,f){"use strict";return e.extend("sap.insights.houseofcards.houseofcards",{onInit:function(){var e=this.createId("HouseOfCardsHost");this.I18_BUNDLE=sap.ui.getCore().getLibraryResourceBundle("sap.insights");this.getView().setModel(new i({bundle:this.I18_BUNDLE}),"i18n");this._oHocViewModel=new a({oCard:{},oSelected:{},bShowPreview:false,aCards:[],aPreviewCards:[],aAllowedChartTypes:[],sOriginalChartType:""});this.getView().setModel(this._oHocViewModel,"hocModel");d.resize.attachHandler(this._adjustLayoutStyles.bind(this));this._adjustLayoutStyles();this.host=new f(e,{action:function(e){var t=e.getParameter("card")||{};if(this.getView().getModel("configureView")){this.getView().getModel("configureView").setProperty("/oConfCard",t.getManifest())}}.bind(this)})},onChartTypePress:function(e){var t=e.getParameter("listItem");if(t.getBindingContext("hocModel")){var o=t.getBindingContext("hocModel").getPath();var r=this._oHocViewModel.getProperty(o);var i=this.byId("CardContainer");var a;var s=i.getItems();var n=this._oHocViewModel.getProperty("/selectedPath");s.forEach(function(e){if(e.getBindingContext("hocModel")){var t=e.getBindingContext("hocModel").getPath();if(t===n&&n!==o){a=e}}});if(a){a.removeStyleClass("sapThemeHighlight-asBorderColor")}this._oHocViewModel.setProperty("/oSelected",r);this._oHocViewModel.setProperty("/selectedPath",o);var d=o.split("/");var c=d[d.length-1];var h=this._oHocViewModel.getProperty("/aCards/"+c);if(this.getView().getModel("configureView")){this.getView().getModel("configureView").setProperty("/oConfCard",h);this.getView().byId("previewCardHoCSD").refresh()}var l=this.getView().byId("hocChartCombo");l.setSelectedKey(r["sap.card"].content.chartType)}},onChartTypeSearch:function(e){var t="";if(e){t=e.getSource().getValue()}var o=new l("sap.card/content/chartType",g.Contains,t);var r=[];r.push(o);var i=this.byId("insightsCardsTypeTable");var a=i.getBinding("items");a.filter(r,"Application")},_onCardLoadFailure:function(e,t){this.byId("CardContainer").removeItem(e.sId)},_onCardStateChanged:function(e){var t=e.getAggregation("_content")&&e.getAggregation("_content").getAggregation("_content");if(t&&t.attachRenderComplete){t.attachRenderComplete(function(t){var o=t.getSource()._errorType;if(o){this.byId("CardContainer").removeItem(e.sId)}}.bind(this))}var o=e.getManifest()["sap.card"].content.chartType;var r=this._oHocViewModel.getProperty("/sOriginalChartType");if(!n.hasVizData(e)&&o!==r){var i=this._oHocViewModel.getProperty("/aPreviewCards");var a=i.findIndex(function(e){return e["sap.card"].content.chartType===o});if(a>-1){this.byId("CardContainer").removeItem(a);i.splice(a,1);this._oHocViewModel.setProperty("/aPreviewCards",i)}}},createHouseOfCards:function(){var e=this._oHocViewModel.getProperty("/oCard");var t=e["sap.card"].content.chartType;this._oHocViewModel.setProperty("/sOriginalChartType",t);this._oHocViewModel.setProperty("/aCards",[]);this._oHocViewModel.setProperty("/aPreviewCards",[]);var o=this.byId("CardContainer");var i=JSON.parse(JSON.stringify(e));var a=i["sap.card"];var s=o.getMetadata().getDefaultAggregation();var d=[],c=[];var h;o.removeAllAggregation(s.name);if(a.type==="Analytical"){var l=e["sap.insights"].allowedChartTypes;var g=[];if(l){this._oHocViewModel.setProperty("/aAllowedChartTypes",l);g=l.map(function(e){return e.key});var f=g.filter(function(e){return!!e});if(f.length===0){g=l.map(function(e){return e.chart})}}d=r.transformAnalyticalManifest(i,g)}else if(a.type==="List"){d=r.createListOptions(i)}else if(a.type==="Table"){d=r.createTableOptions(i)}d=d.filter(function(e){return!!e});if(d.length===0){d.push(i)}else{var p=d.findIndex(function(e){return e["sap.card"].content.chartType===t});d.splice(p,1);d.unshift(i)}d.forEach(function(e){var t=JSON.parse(JSON.stringify(e));var o=n.getCardPreviewManifest(t);c.push(o)});this._oHocViewModel.setProperty("/aCards",d);this._oHocViewModel.setProperty("/aPreviewCards",c);if(!this._oHocViewModel.getProperty("/selectedPath")){this.byId("idHoCScrollContainer").scrollTo(0);var C=this.byId("chartTypeSearch");C.setValue("");this.onChartTypeSearch()}if(!this._oHocViewModel.getProperty("/oSelected")||Object.keys(this._oHocViewModel.getProperty("/oSelected")).length===0){this._oHocViewModel.setProperty("/oSelected",c[0]);if(this.getView().getModel("configureView")){this.getView().getModel("configureView").setProperty("/oConfCard",d[0])}this._oHocViewModel.setProperty("/selectedPath","/aPreviewCards/0")}else{h=this._oHocViewModel.getProperty("/oSelected");var y=this.getView().getModel("configureView").getProperty("/oConfCard");h["sap.card"].header.title=y["sap.card"].header.title;h["sap.card"].header.subTitle=y["sap.card"].header.subTitle;this.getView().byId("previewCardHoC").refresh()}h=this._oHocViewModel.getProperty("/oSelected");var u=this.getView().byId("hocChartCombo");u.setSelectedKey(h["sap.card"].content.chartType)},onCardRender:function(e){var t=e.getSource();t.attachManifestApplied(function(e){var t=e.getSource();var o=this.byId("CardContainer");var r=o.getItems();r.forEach(function(e){if(e.getBindingContext("hocModel")){var o=e.getBindingContext("hocModel").getPath();if(this._oHocViewModel.getProperty("/selectedPath")===o&&e.sId===t.sId){e.addStyleClass("sapThemeHighlight-asBorderColor");e.focus();this.byId("idHoCScrollContainer").scrollToElement(e)}}}.bind(this));if(t.getCardHeader()){var i=t.getCardHeader();i.addStyleClass("sapFCardHeaderToolbarFocused")}t.attachEvent("_error",this._onCardLoadFailure.bind(this,t));t.attachEvent("stateChanged",this._onCardStateChanged.bind(this,t))}.bind(this));var o=t.getDomRef();o.removeEventListener("click",this.onClickFunction.bind(this,t));o.addEventListener("click",this.onClickFunction.bind(this,t),{capture:true})},setBorderStyleSelectedCard:function(e){var t=this.byId("CardContainer");var o=t.getItems();var r;o.forEach(function(t){if(t.getBindingContext("hocModel")){var o=t.getBindingContext("hocModel").getPath();if(e&&!r&&o===e){r=t}}});if(r){setTimeout(function(){r.addStyleClass("sapThemeHighlight-asBorderColor")},0);r.focus()}},onClickFunction:function(e,t){var o=this.byId("CardContainer");var r;var i=o.getItems();var a=this._oHocViewModel.getProperty("/selectedPath");i.forEach(function(o){if(o.getBindingContext("hocModel")){var i=o.getBindingContext("hocModel").getPath();if(t&&!e&&i===t){e=o}if(i===a&&a!==t){r=o}}});if(o.getItems()[0].hasStyleClass("sapThemeHighlight-asBorderColor")){o.getItems()[0].removeStyleClass("sapThemeHighlight-asBorderColor")}else if(r){r.removeStyleClass("sapThemeHighlight-asBorderColor")}if(e){setTimeout(function(){e.addStyleClass("sapThemeHighlight-asBorderColor")},0);e.focus();this.byId("idHoCScrollContainer").scrollToElement(e);var s=e.getBindingContext("hocModel").getPath();this._oHocViewModel.setProperty("/selectedPath",s);var n=s.split("/");var d=n[n.length-1];var c=this._oHocViewModel.getProperty("/aCards/"+d);this._oHocViewModel.setProperty("/oSelected",e.getManifest());if(this.getView().getModel("configureView")){this.getView().getModel("configureView").setProperty("/oConfCard",c);this.getView().byId("previewCardHoC").refresh()}var h=this.getView().byId("hocChartCombo");h.setSelectedKey(e.getManifest()["sap.card"].content.chartType)}},saveCard:function(e){return new Promise(function(t){s.getServiceAsync("UIService").then(function(o){var r=e.getManifestRawJson();var i=this.byId("houseofcardseditordialog");if(i){i.close()}o.showCardPreview(r,false,true).then(function(){t()})}.bind(this))}.bind(this))},setChartDetail:function(e,t){var o=c.CHART_TYPE_DETAILS;if(t==="icon"){return o[e]?o[e].icon:o["default"].icon}if(t==="title"){return o[e]?o[e].title:e.replaceAll("_"," ")}},_adjustLayoutStyles:function(){var e=h.getDialogBasedDevice();if(e===c.DEVICE_TYPES.Desktop){this._oHocViewModel.setProperty("/bDesktop",true)}else{this._oHocViewModel.setProperty("/bDesktop",false)}},showHouseOfCardsDialog:function(e){this._oHocViewModel.setProperty("/oCard",e);if(this._oHocViewModel.getProperty("/bDesktop")){this._oHocViewModel.setProperty("/bShowPreview",true)}else{this._oHocViewModel.setProperty("/bShowPreview",false)}if(!Object.keys(this._oHocViewModel.getProperty("/oSelected")).length){this._oHocViewModel.setProperty("/selectedPath","");if(this.getView().byId("chartTypeSearch")){this.getView().byId("chartTypeSearch").setValue("");this.onChartTypeSearch()}this.createHouseOfCards()}else if(this._oHocViewModel.getProperty("/selectedPath")){this.setBorderStyleSelectedCard(this._oHocViewModel.getProperty("/selectedPath"))}},_callPreview:function(e){var t=this._oHocViewModel.getProperty("/bDesktop");var o=t?"previewCardHoC":"previewCardHoCSD";this._oHocViewModel.setProperty("/bShowPreview",true);if(this.getView().byId(o)){this.getView().byId(o).refresh()}},_callShowPreview:function(e){this._oHocViewModel.setProperty("/bShowPreview",true);var t=this._oHocViewModel.getProperty("/bDesktop");var o=t?"previewCardHoC":"previewCardHoCSD";if(this.getView().byId(o)){this.getView().byId(o).refresh()}},_callClosePreview:function(e){this._oHocViewModel.setProperty("/bShowPreview",false)},selectionChange:function(e){var t=e.getParameters();var o=t.selectedItem;var r=o&&o.getBindingContext("hocModel").getPath();this.onClickFunction(null,r)},closeDialog:function(){var e=this.byId("houseofcardseditordialog");s.getServiceAsync("UIService").then(function(t){var o=this._oHocViewModel.getProperty("/oCard");if(e){e.close()}t.showCardPreview(o,false,true)}.bind(this))},formatChartName:function(e){var t=this._oHocViewModel.getProperty("/aAllowedChartTypes");var o=t.find(function(t){return t.key===e});if(o){return o.text}return e}})});
//# sourceMappingURL=HouseOfCards.controller.js.map