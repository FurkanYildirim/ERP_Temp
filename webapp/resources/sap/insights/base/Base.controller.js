/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","../utils/MetadataAnalyser","../utils/SelectionVariantHelper","sap/fe/navigation/SelectionVariant","sap/m/Token","../utils/oDataModelProvider","sap/ui/core/CustomData","sap/m/DynamicDateUtil","sap/ui/comp/util/DateTimeUtil","sap/ui/core/format/DateFormat","../utils/AppConstants","../utils/UrlGenerateHelper","sap/ui/core/IconPool","sap/base/util/deepClone","sap/ui/core/date/UI5Date","../utils/V4MetadataAnalyser","sap/ui/mdc/MultiValueField","sap/ui/mdc/field/MultiValueFieldItem","sap/ui/layout/form/SimpleForm","sap/m/Toolbar","sap/m/Title","sap/m/Text"],function(e,t,a,r,i,n,o,s,l,d,u,g,c,p,f,h,m,v,y,S,C,b,T){"use strict";var D="smartForm";var _="copyCardSmartForm";return e.extend("sap.insights.base.BaseController",{constructor:function(){this._oParentViewModel=new t({oCard:{}});this.oSmartFormMap={};this.oDraftCardParams={};this.bEnableCardEdit=true},_createOdataModelsforDialog:function(e){var t=[];e.forEach(function(e){t.push(o.getOdataModel(e.descriptorContent["sap.app"].dataSources))});if(t.length){return Promise.all(t)}},setFilterTextForNoData:function(e,t,a){sap.ui.getCore().loadLibrary("sap.ui.comp",{async:true}).then(function(){sap.ui.require(["sap/ui/comp/smartform/Group","sap/ui/comp/smartform/GroupElement","sap/ui/comp/smartform/Layout","sap/m/Text"],function(r,i,n,o){e.removeAllGroups();var s=new r;var l=new i;var d=new o({text:t?this.i18Bundle.getText("noFilterMsg"):this.i18Bundle.getText("noFilterLoaded"),textAlign:"Center"});l.addElement(d);s.addGroupElement(l);e.setLayout(new n);e.addGroup(s);if(a){e.getAggregation("content").getLayout().setBackgroundDesign("Transparent")}}.bind(this))}.bind(this))},_setSmartFormForCardEdit:function(e){if(e&&e.descriptorContent&&e.descriptorContent["sap.app"]){var t=e.descriptorContent["sap.app"];var a=t&&t.dataSources;var r=a&&a.filterService;if(r&&r.settings&&r.settings.odataVersion===g.ODATA_VERSION_2){this._oParentViewModel.setProperty("/oCard",e);var i=e.descriptorContent["sap.app"].id,n=this.oSmartFormMap[i]&&!this.smartFormEditable?Promise.resolve(this.oSmartFormMap[i]):this._createSmartFormForCardEdit(e,this.smartFormEditable);n.then(function(t){if(this.smartFormEditable){t.setEditable(true)}var a=this.byId(D)||this.byId(_);a.removeAllItems();var r=e.descriptorContent["sap.app"].dataSources;o.getOdataModel(r).then(function(e){var r=e&&e.loaded;var i=false;if(t.getGroups()&&t.getGroups().length&&t.getGroups()[0].getGroupElements()){i=t.getGroups()[0].getGroupElements().some(function(e){return e.getElements().some(function(e){return e.getVisible()})})}if(t.getAggregation("content").getFormContainers().length&&r&&i){t.setVisible(true);setTimeout(function(){var e=t.getAggregation("content").getLayout();if(e){e.setBackgroundDesign("Transparent")}a.addItem(t)},0)}else{this.setFilterTextForNoData(t,r,true);a.addItem(t)}}.bind(this))}.bind(this))}else if(r&&r.settings&&r.settings.odataVersion===g.ODATA_VERSION_4){this.createSimpleForm(e)}}},_search:function(e,t){return t?t.split("/").reduce(function(e,t){return e&&t?e[t]:e},e):undefined},_fetchParameterizedFilters:function(e,t){var a=this._search(e,"/sap.card/configuration/parameters"),r=this._search(a,"/_relevantODataParameters/value")||[];return r.reduce(function(r,i){return r.then(function(r){return m.getAnnotations(t,e,i,["@com.sap.vocabularies.Common.v1.Label","@com.sap.vocabularies.UI.v1.Hidden"]).then(function(e){var t=e[0],o=e[1],s=a[i].value,l=a[i].label;if(s&&!o){r.push({name:t||i,tokens:[new n({key:s,text:l?l:s})]})}return Promise.resolve(r)})})},Promise.resolve([]))},_fetchRelevantFilters:function(e,t){var a=this._search(e,"/sap.card/configuration/parameters"),n=this._search(a,"/_relevantODataFilters/value")||[];return n.reduce(function(n,o){return n.then(function(n){return m.getAnnotations(t,e,o,["@com.sap.vocabularies.Common.v1.Label","@com.sap.vocabularies.UI.v1.Hidden"]).then(function(e){var t=e[0],s=e[1],l=a[o].value,d=new i(l),u=d.getSelectOption(o);if(u.length&&!s){var g=r.getTokenFromSelectOptions(u,o);n.push({name:t||o,tokens:g})}return Promise.resolve(n)})})},Promise.resolve([]))},_generateMutltiValueField:function(e){var a=new t(e.map(function(e){return{key:e.getKey(),name:e.getText()}}));var r=new v({editMode:"Display",display:"Description",width:"100%",items:{path:"/",template:new y({description:"{name}",key:"{key}"})}});r.setModel(a);return r},createSimpleForm:function(e){o.getOdataModel(this._search(e,"/descriptorContent/sap.app/dataSources")).then(function(t){var a=this.byId(D),r=e.descriptorContent,i=t.oData,n=this._search(r,"/sap.app/id"),o=function(e){return new T({text:e,textAlign:"Center"})};a.removeAllItems();this._oSimpleForm=this._oSimpleForm||{};if(!this._oSimpleForm[n]){this._oSimpleForm[n]=new S({layout:"ColumnLayout",editable:false,toolbar:new C({style:"Clear",content:[new b({text:this.i18Bundle.getText("filterBy"),titleStyle:"H5"})]})});if(t.loaded){Promise.all([this._fetchRelevantFilters(r,i),this._fetchParameterizedFilters(r,i)]).then(function(e){var t=e[0],a=e[1];if(t.length||a.length){a.concat(t).forEach(function(e){this._oSimpleForm[n].addContent(new sap.m.Label({text:e.name}));this._oSimpleForm[n].addContent(this._generateMutltiValueField(e.tokens))}.bind(this))}else{this._oSimpleForm[n].addContent(o(this.i18Bundle.getText("noFilterMsg")))}}.bind(this))}else{this._oSimpleForm[n].addContent(o(this.i18Bundle.getText("noFilterLoaded")))}}a.addItem(this._oSimpleForm[n])}.bind(this))},_createSmartFormForCardEdit:function(e){return new Promise(function(t){sap.ui.getCore().loadLibraries(["sap.ui.comp","sap.m"],{async:true}).then(function(){sap.ui.require(["sap/ui/comp/smartmultiinput/SmartMultiInput","sap/ui/comp/smartform/SmartForm","sap/ui/comp/smartform/Group","sap/ui/comp/smartform/GroupElement","sap/ui/comp/smartform/Layout","sap/m/Title","sap/m/Toolbar"],function(l,d,u,g,p,f,m){var v=e.descriptorContent;var y=v["sap.card"].configuration.parameters;var S=v["sap.insights"].filterEntitySet;var C=y&&y._entitySet.value;var b=v["sap.app"].dataSources;o.getOdataModel(b).then(function(o){var b=o&&o.loaded;this._oParentViewModel.setProperty("/oCard",e);var T={layout:new p({labelSpanS:6}),customToolbar:new m({content:[new f({text:this.i18Bundle.getText("filterBy"),titleStyle:"H5"})],style:"Clear"})};var D=new d(T);var _=new u;var E=[],P=[],F=[],I=[],O,V,k=[];if(y){E=y._mandatoryODataParameters.value||[];P=y._mandatoryODataFilters.value||[];F=y._relevantODataParameters.value||[];I=y._relevantODataFilters.value||[];V=y._semanticDateRangeSetting;if(V){O=JSON.parse(V.value);k=Object.keys(O)||[]}}D.attachEditToggled(function(e){var t=e.getParameters().editable;var a=e.getSource().getGroups()&&e.getSource().getGroups().length?e.getSource().getGroups()[0]:null;if(t&&a){a.getGroupElements().forEach(function(e){e.getFields().forEach(function(e){e.attachInnerControlsCreated(function(e){var t=e.getSource(),a=t.getBindingPath("value");if((E.includes(a)||P.includes(a))&&t.getProperty("editable")){t.setMandatory(true)}else if(t.getMandatory()){t.setMandatory(false)}t.checkClientError()})})})}});var A=function(e,t){if(t){var a=new s({key:"date",value:t});e.insertCustomData(a)}};var x=o&&a.getParameterisedEntitySetByEntitySet(o.oData,S);var M=x?a.getPropertyNamesOfEntitySet(o.oData,x):[];if(b){if(F.length){F.forEach(function(e){var t=x;var r=true;if(M.indexOf(e)===-1){t=C;r=false}var i=a.isValueListWithFixedValues(o.oData,t,e);var s=a.isDate(o.oData,t,e);var d=k.includes(e);var u=new g;var p=new l({entitySet:t,value:"{"+e+"}",editable:r,visible:r,singleTokenMode:true,supportRanges:false,innerControlsCreated:this._handleVisibilityChange.bind(this,d,true)});if(i){p.attachInnerControlsCreated(function(e){var t=e.getSource();if(t.getMode()==="edit"){var a=t.getInnerControls();if(Array.isArray(a)&&a.length){var r=t.getAggregation("_initialTokens");if(t.getSingleTokenMode()){var i=a[0],n=Array.isArray(r)&&r.length?r[0]:null;if(i.setForceSelection){i.setForceSelection(false);if(n){i.setSelectedKey(n.getKey())}else{i.setSelectedItem(null)}}}else{var o=a[0];if(Array.isArray(r)&&r.length){o.setSelectedKeys(r.map(function(e){return e.getKey()}))}}if(t.getMandatory()){t.checkClientError()}}}});p.checkClientError=function(){return this._checkClientError(p)}.bind(this);p.attachSelectionChange(this._handleParameterSelectionChange.bind(this))}else{if(d){p.addStyleClass("semanticDateInsight")}p.attachTokenUpdate(this._handleParameterTokenUpdate.bind(this,null,d))}var f=y[e].value;var m=y[e].label;if(f){var v=new n({key:f,text:m?m:f});if(s){if(!k.includes(e)){A(v,h.getInstance(f))}else{if(O&&this.smartFormEditable){var S=this._getOptionsForDynamicDate(O,e);var b=this.byId("hiddenDDR");b.setStandardOptions(S)}f=c.formatSemanticDateTime(f,"Parameter")[0];A(v,f)}}if(i&&p.getInnerControls().length){var T=p.getInnerControls()[0];T.setSelectedKey(v.getKey())}p.addAggregation("_initialTokens",v)}if(f&&p.getVisible()){u.addElement(p);_.addGroupElement(u)}else if(this.bEnableCardEdit&&p.getVisible()){u.addElement(p);_.addGroupElement(u)}this._attachInitialiseToGroupElement(u)}.bind(this))}var w=a.getPropertyNamesOfEntitySet(o.oData,S);I.forEach(function(e){var t=e;if(!(t==="DisplayCurrency"&&F.indexOf("P_DisplayCurrency")>-1)){var n=S;var s=true;if(w.indexOf(t)===-1){var d="P_"+t;if(M.indexOf(d)>-1){n=x;t=d}else{n=C;s=false}}var u=a.isValueListWithFixedValues(o.oData,n,t);var p=a.isDate(o.oData,n,t);var f=k.includes(t);var m=new g;var v;if(t.indexOf("P_")===0){v=true}else{v=a.getPropertyFilterRestrictionByEntitySet(o.oData,n,t)}var b=new l({entitySet:n,value:"{"+t+"}",editable:s,visible:s,supportRanges:!v,singleTokenMode:v,innerControlsCreated:this._handleVisibilityChange.bind(this,f,false)});if(u){b.attachInnerControlsCreated(function(e){var t=e.getSource();if(t.getMode()==="edit"){var a=t.getInnerControls();if(Array.isArray(a)&&a.length){var r=t.getAggregation("_initialTokens");if(t.getSingleTokenMode()){var i=a[0],n=Array.isArray(r)&&r.length?r[0]:null;if(i.setForceSelection){i.setForceSelection(false);if(n){i.setSelectedKey(n.getKey())}else{i.setSelectedItem(null)}}}else{var o=a[0];if(Array.isArray(r)&&r.length){o.setSelectedKeys(r.map(function(e){return e.getKey()}))}}if(t.getMandatory()){t.checkClientError()}}}});b.checkClientError=function(){return this._checkClientError(b)}.bind(this);b.attachSelectionChange(this._handleFilterSelectionChange.bind(this))}else{if(f){b.setSingleTokenMode(true);b.addStyleClass("semanticDateInsight")}b.attachTokenUpdate(this._handleFilterTokenUpdate.bind(this,null,f))}var T=new i(y[e].value);var D=T.getSelectOption(e);if(D&&D.length){var E=[],P=[];E=r.getTokenFromSelectOptions(D,e);E.forEach(function(t,a){if(p){if(!k.includes(e)){A(t,h.getInstance(t.getKey()))}else{if(O&&this.smartFormEditable){var r=this._getOptionsForDynamicDate(O,e);var i=this.byId("hiddenFilterDDR");i.setStandardOptions(r)}P=c.formatSemanticDateTime(null,D[a],"Filter");P=c.formatSemanticDateTime(D[a],"Filter");P.forEach(function(e){A(t,e)})}}if(u&&b.getInnerControls().length){var n=b.getInnerControls()[0];n.setSelectedKey(t.getKey())}b.addAggregation("_initialTokens",t)}.bind(this));m.addElement(b);_.addGroupElement(m)}else if(this.bEnableCardEdit){m.addElement(b);_.addGroupElement(m)}this._attachInitialiseToGroupElement(m)}}.bind(this))}if(_.getAggregation("formElements")&&_.getAggregation("formElements").length){D.addGroup(_)}var N=v["sap.app"].id;if(b){D.setModel(o.oData)}this.oSmartFormMap[N]=D;t(D)}.bind(this))}.bind(this))}.bind(this))}.bind(this))},_handleVisibilityChange:function(e,t,a){var r=a.getSource();var i=this.byId(D);var n=i&&i.getItems()[0];var o=false;if(e&&r.getMode()==="edit"){var s=t?this.byId("hiddenDDR"):this.byId("hiddenFilterDDR");s.setValue(null);var l=r.getBinding("value").sPath;var d=r.getInnerControls();if(d.length){var u=d[0];r.setShowValueHelp(false);r.setShowSuggestion(false);if(!sap.ui.getCore().byId(u.getId()+"-dynamicDateIcon")){u.addEndIcon({id:u.getId()+"-dynamicDateIcon",src:p.getIconURI("check-availability"),press:t?this._handleParameterTokenUpdate.bind(this,r,true):this._handleFilterTokenUpdate.bind(this,r,true)});u.attachLiveChange(function(){this.bValueApplied=true;u.setValue("");s.attachEventOnce("change",null,t?this._onSemanticParameterDateChange.bind(this,l,r):this._onSemanticFilterDateChange.bind(this,l,r),s);s.openBy(r.getDomRef())}.bind(this))}}}setTimeout(function(){if(n){var e=n.getGroups()&&n.getGroups().length?n.getGroups()[0]:null;var t=e&&e.getGroupElements();if(t&&t.length){t.forEach(function(t){var a=t.getFields();a.forEach(function(e){if(!this.smartFormEditable&&e.getId()===r.getId()&&(e.getTokens&&e.getTokens().length===0)){t.removeField(e)}if(t.getVisible()&&e.getVisible()&&e.getTokens&&e.getTokens().length){o=true}}.bind(this));if(!t.getFields().length){e.removeGroupElement(t)}}.bind(this))}}if(!o&&i){i.removeAllItems();this.setFilterTextForNoData(n,true,false);i.addItem(n)}}.bind(this),0)},_handleFilterTokenUpdate:function(e,t,n){var o=e?e:n.getSource();if(o.getMandatory()){o.checkClientError()}var s=o.getBinding("value").sPath;var l=o.getTokens();var u=this._oParentViewModel.getProperty("/oCard");var c=u.descriptorContent["sap.app"].id;var p=o.getModel();var f=a.isDate(p,o.getEntitySet(),s);var m,v="",y,S={value:"",label:"",description:""};y=u.descriptorContent["sap.card"].configuration.parameters;if(t&&(!l.length||e)){m=this.byId("hiddenFilterDDR");m.attachEventOnce("change",null,this._onSemanticFilterDateChange.bind(this,s,o),m);this.bValueApplied=true;m.openBy(o.getDomRef());if(!l.length){S.value=r.getEmptySVStringforProperty(s)}else{v=m._parseValue(l[0].getKey());if(v){m.setValue(v)}else{S.description=m.getValue()?JSON.stringify(m.getValue()):"";if(!m.getValue()&&y[s]&&y[s].description){var C;S.description=y[s].description;S.value=y[s].value;C=JSON.parse(S.description);C.values.forEach(function(e,t){if(g.DATE_OPTIONS.DATE_LIST.includes(C.operator)){var a=h.getInstance(e);if(e.match&&!(e.match(/^(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{3})Z$/gm)&&e.match(/^(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{3})Z$/gm).length)){C.values[t]=d.utcToLocal(a);if(!["DATETIMERANGE","FROMDATETIME","TODATETIME","DATETIME"].includes(C.operator)){C.values[t]=d.normalizeDate(C.values[t],true)}}else{C.values[t]=a}}});m.setValue(C)}else{m.setValue(m.getValue())}}}}else if(l.length){var b=new i;var T=[];var D="";l.forEach(function(e){D="";if(e.data("selectOption")){var t=e.data("selectOption");if(!t.Text){t.Text=e.getText?e.getText():null}T.push(t)}else if(e.data("range")){var a=e.data("range");var i=r.getSelectOptionFromRange(a,e.getText());T.push(i)}else if(f){var n=p.formatValue(e.getKey(),"Edm.DateTime");b.addSelectOption(s,"I","EQ",n,null,n)}else if(o._parseValue){var l=o._parseValue(e.getKey());D=e.getText()?e.getText():e.getKey();b.addSelectOption(s,"I","EQ",l,null,D)}else{D=e.getText()?e.getText():e.getKey();b.addSelectOption(s,"I","EQ",e.getKey(),null,D)}});b.massAddSelectOption(s,T);S.value=b.toJSONString()}else{S.value=r.getEmptySVStringforProperty(s)}this.oDraftCardParams[c][s]=S.value?S:this.oDraftCardParams[c][s]},getLabelForField:function(e,t,a,r){if(e&&t){var i=r==="Parameter"?this.byId("hiddenDDR"):this.byId("hiddenFilterDDR");var n=i.getIdForLabel()||"";n=n.substring(0,n.lastIndexOf("-"));if(n){var o=sap.ui.getCore().byId(n);return o&&o.getValue()}else if(i&&i.getProperty("value")){return i.getProperty("value")}else if(a&&typeof a.getTokens==="function"){var s=a.getTokens()||[],l=s.map(function(e){return e.getText()});return{type:"filters",value:l}}}},_handleFilterSelectionChange:function(e){var t=e.getParameters();var a=e.getSource().getBinding("value").getPath();var o=this._oParentViewModel.getProperty("/oCard");var s=o.descriptorContent["sap.app"].id;var l=e.getSource();var d=new i;var u="",g={value:"",label:"",description:""};if(t.selectedItem){l.setValueState("None");var c=e.getParameter("selectedItem");if(c){u=c.getText()?c.getText():c.getKey();l.removeAllAggregation("_initialTokens");l.addAggregation("_initialTokens",new n({key:c.getKey(),text:u}));d.addSelectOption(a,"I","EQ",c.getKey(),null,u);g.value=d.toJSONString()}else{g.value=r.getEmptySVStringforProperty(a)}}else{var p=e.getSource().getInnerControls()[0].getSelectedItems();if(p.length){l.setValueState("None");l.removeAllAggregation("_initialTokens");p.forEach(function(e){u=e.getText()?e.getText():e.getKey();l.addAggregation("_initialTokens",new n({key:e.getKey(),text:u}));d.addSelectOption(a,"I","EQ",e.getKey(),null,u)});g.value=d.toJSONString()}else{g.value=r.getEmptySVStringforProperty(a)}}this.oDraftCardParams[s][a]=g},_handleParameterSelectionChange:function(e){var t=e.getParameter("selectedItem");var a=e.getSource(),r="";var i={value:"",label:"",description:""};if(t){a.setValueState("None");r=t.getText()?t.getText():t.getKey();i.value=t.getKey();i.label=r}a.removeAllAggregation("_initialTokens");a.addAggregation("_initialTokens",new n({key:i.value,text:i.label}));var o=e.getSource().getBinding("value").getPath();var s=this._oParentViewModel.getProperty("/oCard").descriptorContent["sap.app"].id;this.oDraftCardParams[s][o]=i},_handleParameterTokenUpdate:function(e,t,r){var i=e?e:r.getSource();if(i.getMandatory()){i.checkClientError()}var n=i.getBinding("value").sPath;var o=i.getTokens();var s=this._oParentViewModel.getProperty("/oCard").descriptorContent["sap.app"].id;var l={value:"",label:"",description:""};var d=i.getModel();var u=a.isDate(d,i.getEntitySet(),n);var p,f;if(t&&(!o.length||e)){f=this.byId("hiddenDDR");f.attachChange(this._onSemanticParameterDateChange.bind(this,n,i));f.openBy(i.getDomRef())}if(o.length){l.label=o[0].getText()?o[0].getText():o[0].getKey();if(t&&!f){f=this.byId("hiddenDDR")}if(f&&f._parseValue){p=f._parseValue(o[0].getKey());if(p){f.setValue(p);l.value=c.getDateRangeValue(p,true);l.description=JSON.stringify(p);var m=this.getLabelForField(n,p,e,"Parameter");var v="";var y=p.operator==="DATE";if(m&&typeof m==="string"){v=m.substring(0,m.indexOf("(")-1);if(!v&&y){v=m}}l.label=v?v:p.operator}else{l.value=o[0].getKey();if(Date.parse(l.value)){l.value=h.getInstance(l.value)}l.description=f.getValue()?JSON.stringify(f.getValue()):"";var S=this._oParentViewModel.getProperty("/oCard").descriptorContent["sap.card"].configuration.parameters;if(!f.getValue()&&S[n]&&S[n].description){var C;l.description=S[n].description;C=JSON.parse(l.description);if(g.DATE_OPTIONS.DATE_LIST.includes(C.operator)){C.values[0]=h.getInstance(C.values[0]);l.value=typeof o[0].getKey()==="string"?h.getInstance(o[0].getKey()):o[0].getKey()}f.setValue(C)}else{f.setValue(f.getValue())}}}else{p=i._parseValue&&i._parseValue(o[0].getKey());if(u&&p){p=i.getModel().formatValue(p,i.getDataType());l.value=p}else if(p){l.value=p}else{p=o[0].getKey();l.value=p}}}this.oDraftCardParams[s][n]=l},_mergeDraftParamsIncard:function(e){var t=e.descriptorContent["sap.card"].configuration.parameters;var a=e.descriptorContent["sap.app"].id;var r=this.oDraftCardParams[a];Object.keys(r).forEach(function(e){if(r[e]){if(t[e]){if(t[e].type==="datetime"&&typeof t[e].value==="string"&&t[e].value.includes("operation")){var a=JSON.parse(t[e].value);a.operation=r[e];t[e].value=JSON.stringify(a)}else{t[e].value=r[e].value?r[e].value:r[e];if(r[e].label){t[e].label=r[e].label}t[e].description=r[e].description}}else if(e.indexOf("P_")===0&&t[e.replace("P_","")]){r[e.replace("P_","")]=r[e].replace("P_","");t[e.replace("P_","")].value=r[e].replace("P_","");delete r[e]}}});c.processPrivateParams(e,r);Object.keys(t).forEach(function(e){var a=t[e].value;if(t[e].type==="datetime"&&typeof a==="string"&&a.includes("datetime")){a=a.split("datetime");a=a[a.length-1];a=a.replace(/["']/g,"");t[e].value=a}});return e},_checkClientError:function(e){var t=e.getSingleTokenMode()?!e.getInnerControls()[0].getSelectedKey():!e.getInnerControls()[0].getSelectedKeys().length,a=e.getMandatory()&&t;e.setValueState(a?"Error":"None");return a},_attachInitialiseToGroupElement:function(e){if(e.getFields()&&e.getFields().length){e.getFields()[0].attachInitialise(function(){if(e.getFields().length&&e.getLabelControl()&&!e.getLabelControl().getText()){var t=e.getFields()[0].getBindingPath("value");if(t&&e.getFields()[0].getVisible()){e.getFields()[0].setTextLabel(t)}}})}},_onSemanticParameterDateChange:function(e,t,a){var r=a.getParameter("value");var i=this._oParentViewModel.getProperty("/oCard");var o=i.descriptorContent["sap.app"].id;var s=this.getLabelForField(e,r,t,"Parameter");var l="";var d=r.operator==="DATE";if(s&&typeof s==="string"){l=s.substring(0,s.indexOf("(")-1);if(!l&&d){l=s}}if(!this.oDraftCardParams[o][e]){this.oDraftCardParams[o][e]={}}this.oDraftCardParams[o][e].value=d?r.values[0]:r.operator;this.oDraftCardParams[o][e].label=d?r.values[0]:r.operator;this.oDraftCardParams[o][e].description=JSON.stringify(r);t.getInnerControls()[0].setTokens([]);if(l){this.oDraftCardParams[o][e].label=l}var u=new n({key:this.oDraftCardParams[o][e].value,text:this.oDraftCardParams[o][e].label});t.getInnerControls()[0].setTokens([u]);var g=a.getParameter("valid");t.setValueState(g?"None":"Error")},_onSemanticFilterDateChange:function(e,t,a){if(this.bValueApplied){var n=a.getParameter("value");var o=this.getLabelForField(e,n,t,"Filter");var s=f(n);var l=c.getDateRangeValue(s,false,o);var d=this._oParentViewModel.getProperty("/oCard");var u=d.descriptorContent["sap.app"].id;var g=new i;if(!l.High){l.High=""}if(!this.oDraftCardParams[u][e]){this.oDraftCardParams[u][e]={}}g.addSelectOption(e,"I",l.Option,l.Low,l.High,l.Text);this.oDraftCardParams[u][e].value=g.toJSONString();this.oDraftCardParams[u][e].description=JSON.stringify(s);t.getInnerControls()[0].setTokens([]);var p=r.getTokenFromSelectOptions(g.getSelectOption(e),e);t.getInnerControls()[0].setTokens(p);var h=a.getParameter("valid");t.setValueState(h?"None":"Error");this.bValueApplied=false}},_getOptionsForDynamicDate:function(e,t){var a;if(e[t]["sap:filter-restriction"]==="single-value"){a=g.DATE_OPTIONS.SINGLE_OPTIONS}else if(e[t]["sap:filter-restriction"]==="interval"){a=g.DATE_OPTIONS.RANGE_OPTIONS;a=a.concat(g.DATE_OPTIONS.SINGLE_OPTIONS)}if(e&&e[t].exclude){a=a.filter(function(a){return!e[t].selectedValues.includes(a)})}return a}})});
//# sourceMappingURL=Base.controller.js.map