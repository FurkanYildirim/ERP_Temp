/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/base/Object","sap/base/Log"],function(t,e){"use strict";var r=t.extend("ux.eng.s4producthomes1.utils.BatchHelper",{});var n="/sap/opu/odata4/ui2/insights_srv/srvd/ui2/";var s=n+"insights_cards_repo_srv/0001/";var i=sap.ui.getCore().getLibraryResourceBundle("sap.insights");var a=e.getLogger("sap.insights.CardHelper");var o;function h(t){this.url="INSIGHTS_CARDS('"+t.id+"')";this.mOptions={};this.batchRequests=[];this.payload=t;this.boundary="batch_id_"+Date.now()+"_01";this.mOptions.headers={};this.mOptions.method="PUT";this.mOptions.headers["content-type"]="multipart/mixed;boundary="+this.boundary;this.mOptions.headers["X-CSRF-Token"]=o;return this}function u(){return fetch(s,{method:"HEAD",headers:{"X-CSRF-Token":"Fetch"}}).then(function(t){var e=t.headers.get("X-CSRF-Token");if(t.ok&&e){return e}var r=i.getText("tokenFetchError");a.error(r);throw new Error(r)})}h.prototype.addRequest=function(t){this.batchRequests.push(t)};h.prototype._constructBody=function(){var t="--"+this.boundary;var e="\r\n";var r="Content-Type:application/http"+e+"Content-Transfer-Encoding:binary"+e;var n="changeset_001";var s="--"+n;var i="Content-Type: multipart/mixed; boundary="+n+e;var a=t+e+i;a+=e+s;for(var o=0;o<this.batchRequests.length;o++){var h=this.batchRequests[o];a+=e+r;a+="Content-ID: "+(o+1)+e+e;a+=h.mOptions.method+" "+h.url+" HTTP/1.1 "+e;a+="sap-context-accept: header"+e+"Content-Type:application/json"+e+e;a+=JSON.stringify(this.batchRequests[o].payload)+e+e;a+=s;if(o===this.batchRequests.length-1){a+="--"+e;a+=t+"--"}}return a};function p(t){var e=[];var r=[];var n=[];try{r=t.split("\r\n")}catch(t){throw new Error}r.forEach(function(t){if(t!==""){n.push(t)}});var s="";for(var i=1;i<n.length-1;i++){s=n[i].includes("Content-Type: ")?n[i].split("Content-Type: ")[1]:s;if(n[i+1].includes(n[0])){if(s==="application/json"){n[i]=JSON.parse(n[i]);e.push(n[i])}else{e.push(n[i])}}}return e}r.createMultipartRequest=function(t){return u().then(function(e){this.url="/sap/opu/odata4/ui2/insights_srv/srvd/ui2/insights_cards_repo_srv/001/$batch";this.batchRequests=[];var r;o=e;for(var n=0;n<t.length;n++){var s=t[n];var i=new h(s);if(!r){r=i}r.addRequest(i)}return this.fetchData(r)}.bind(this))};r.fetchData=function(t){t.mOptions.body=t._constructBody();t.mOptions.method="POST";return fetch(this.url,t.mOptions).then(function(t){if(t.ok===false){throw new Error}return t.text()}).then(function(t){return p(t)})};return r});
//# sourceMappingURL=BatchHelper.js.map