/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/model/json/JSONModel","sap/ui/model/resource/ResourceModel","../base/Base.controller","../CardHelper","sap/m/MessageToast","sap/base/Log","sap/ui/Device","../utils/AppConstants","../utils/DeviceType","../utils/Transformations","sap/ui/model/Filter","sap/ui/model/FilterOperator","../base/InMemoryCachingHost","../utils/CardPreviewManager"],function(e,t,i,o,r,s,n,a,l,g,d,u,C,h){"use strict";var f=s.getLogger("sap.insights.configure.ColumnList");return i.extend("sap.insights.configure.ColumnList",{onInit:function(){this._oConfigureViewModel=new e({oOrgCard:{},oConfCard:{},aCards:[],bDialogOpen:false,visibleColumnCount:0});this.getView().setModel(this._oConfigureViewModel,"configureView");var i=sap.ui.getCore().getLibraryResourceBundle("sap.insights");this.getView().setModel(new t({bundle:i}),"i18n");this.i18Bundle=this.getView().getModel("i18n").getResourceBundle();n.resize.attachHandler(this._adjustLayoutStyles.bind(this));this._adjustLayoutStyles();if(this._oConfigureViewModel.getProperty("/bDesktop")===true){this._oConfigureViewModel.setProperty("/bShowCardPreview",true)}var o=this.getView().byId("navCon");var r=this._getHoCView();r.then(function(e){o.addPage(e)});var s=this.createId("transactionalCardHost");this.host=new C(s,{action:function(e){var t=e.getParameter("card")||{};if(this.getView().getModel("configureView")){this.getView().getModel("configureView").setProperty("/oConfCard",t.getManifest())}}.bind(this)})},_getHoCView:function(){return o.getServiceAsync("UIService").then(function(e){return e._getXMLView("sap.insights.houseOfCards.HouseOfCardsDialog","hocViewPage")})},_getConfigureCardPage:function(){return this.getView().byId("insightCardColumnPage")},showColumnListDialog:function(e){try{this.orgCard=e;this._oConfigureViewModel.setProperty("/bTransform",true);this.initConfigureCard(e,false);this._getColumnListDialog().open();this._oConfigureViewModel.setProperty("/bDialogOpen",true)}catch(e){throw new Error(e)}},save:function(){var e=this._oConfigureViewModel.getProperty("/oConfCard");if(e["sap.card"].header.title){e["sap.insights"].visible=true;this._getColumnListDialog().setBusy(true);var t=h.insertActionsManifest(e,this._oConfigureViewModel.getProperty("/oOrgCard"));o.getServiceAsync().then(function(e){e.createCard(t).then(function(e){r.show(this.i18Bundle.getText("Card_Created"));this._getColumnListDialog().setBusy(false);this._getColumnListDialog().close();this.closeDialog()}.bind(this)).catch(function(e){r.show(e.message);this._getColumnListDialog().setBusy(false);this.closeDialog()}.bind(this))}.bind(this))}else{var i=this.getView().byId("titleTextInput");i.focus()}},_getColumnListDialog:function(){return this.getView().byId("insightsColumnListDialog")},_callPreview:function(e){var t,i;i=this._oConfigureViewModel.getProperty("/bDesktop");if(this.getView().byId("navCon")&&this.getView().byId("navCon").getCurrentPage().sId===this.getView().byId("insightCardColumnPage").sId){this._oConfigureViewModel.setProperty("/bShowPreview",true);t=i?"previewCard":"previewColCardSD"}else if(this.getView().byId("navCon")&&this.getView().byId("navCon").getCurrentPage().sId===this.getView().byId("insightCardPreviewPage").sId){this._oConfigureViewModel.setProperty("/bShowCardPreview",true);t=i?"previewCardLS":"previewCardSD"}else if(this.getView().byId("navCon")&&this.getView().byId("navCon").getCurrentPage().sId===this.getView().byId("insightsHoCView").sId){this._oConfigureViewModel.setProperty("/bShowHoCPage",true)}if(this.getView().byId(t)){this.getView().byId(t).refresh()}},_callPreviewPage:function(e){this._oConfigureViewModel.setProperty("/bShowPreview",false);this._oConfigureViewModel.setProperty("/bPreview",true);this._oConfigureViewModel.setProperty("/bShowCardPreview",false);if(this.getView().byId("navCon")){var t=this.getView().byId("insightCardPreviewPage");var i=this._oConfigureViewModel.getProperty("/bDesktop");var o=i?"previewCardLS":"previewCardSD";if(this.getView().byId(o)){this.getView().byId(o).refresh()}var r=this.getView().byId("titleTextInput");if(e){if(e["sap.card"].header.title&&e["sap.card"].header.title.trim()){this.getView().byId("nextButton").setEnabled(true);r.setValueState("None");r.setValueStateText("")}else{this.getView().byId("nextButton").setEnabled(false);r.setValueState("Error");r.setValueStateText(this.i18Bundle.getText("INT_Preview_Title_ValueStateText"))}}this.getView().byId("navCon").to(t)}},_callShowPreview:function(e){this._oConfigureViewModel.setProperty("/bShowPreview",true);this._oConfigureViewModel.setProperty("/bRefresh",false);var t=this._oConfigureViewModel.getProperty("/bDesktop");var i=t?"previewCard":"previewColCardSD";if(this.getView().byId(i)){this.getView().byId(i).refresh()}},_callClosePreview:function(e){if(this.getView().byId("navCon")&&this.getView().byId("navCon").getCurrentPage().sId===this.getView().byId("insightCardColumnPage").sId){this._oConfigureViewModel.setProperty("/bShowPreview",false)}else if(this.getView().byId("navCon")&&this.getView().byId("navCon").getCurrentPage().sId===this.getView().byId("insightCardPreviewPage").sId){this._oConfigureViewModel.setProperty("/bShowCardPreview",false)}},closeDialog:function(){this._getColumnListDialog().close()},afterCloseDialog:function(){o.getServiceAsync("UIService").then(function(e){return e._setPreviewModelProperty("/bConfigureOpen",false).then(function(){this._oConfigureViewModel.setProperty("/bShowPreview",false);this._oConfigureViewModel.setProperty("/bPreview",false);this._oConfigureViewModel.setProperty("/bDialogOpen",false);this._oConfigureViewModel.setProperty("/bShowHoCPage",false);this._oConfigureViewModel.setProperty("/columnPage",false);this._oConfigureViewModel.setProperty("/oConfCard",{});this._oConfigureViewModel.setProperty("/oOrgCard",{});if(this.getView().byId("columnSearch")){this.getView().byId("columnSearch").setValue("");this.onColumnSearch()}}.bind(this)).then(function(){return e._setHoCModelProperty("/oSelected",{})})}.bind(this))},_adjustLayoutStyles:function(){var e=l.getDialogBasedDevice();if(e===a.DEVICE_TYPES.Desktop){this._oConfigureViewModel.setProperty("/bDesktop",true)}else{this._oConfigureViewModel.setProperty("/bDesktop",false)}},handleTitleChange:function(e){var t=e.getSource();var i=t.getValue().trim();var o;if(this._oConfigureViewModel.getProperty("/bDesktop")){o=this.getView().byId("previewCardLS")}else{o=this.getView().byId("previewCardSD")}if(i){this.getView().byId("nextButton").setEnabled(true);t.setValueState("None");t.setValueStateText("");if(o.getCardHeader()){o.getCardHeader().setTitle(i)}}else{t.setValueState("Error");t.setValueStateText(this.i18Bundle.getText("INT_Preview_Title_ValueStateText"));this.getView().byId("nextButton").setEnabled(false)}o.refresh()},handleSubTitleChange:function(e){var t=e.getSource();var i=t.getValue();var o;if(this._oConfigureViewModel.getProperty("/bDesktop")){o=this.getView().byId("previewCardLS")}else{o=this.getView().byId("previewCardSD")}if(o.getCardHeader()){o.getCardHeader().setSubtitle(i)}o.refresh()},initConfigureCard:function(e,t){var i=e,o;var r=sap.ui.getCore().byId("myhomeSettingsView--INSIGHTS_CARDS");this._oConfigureViewModel.setProperty("/oOrgCard",i);o=JSON.parse(JSON.stringify(i));o=h.getCardPreviewManifest(o);this._oConfigureViewModel.setProperty("/oConfCard",o);var s=this._oConfigureViewModel.createBindingContext("/oConfCard");this.getView().byId("insightCardColumnPage").setBindingContext(s,"configureCardView");this._oConfigureViewModel.setProperty("/visibleColumnCount",0);this._oConfigureViewModel.setProperty("/bMainIndicator",false);this._oConfigureViewModel.setProperty("/bShowMainIndicator",false);this._oConfigureViewModel.setProperty("/bRefresh",true);if(o){var n=o["sap.card"];if(n.type==="Table"){var a=this._oConfigureViewModel.getProperty("/bDesktop");var l=a?this.getView().byId("columnSegButton"):this.getView().byId("sdColumnSegButton");l.setSelectedKey("list");this.setColumnAndKPIValue(o,r)}else if(n.type==="Analytical"){this._oConfigureViewModel.setProperty("/bShowHoCPage",true);this._callPreviewPage(o)}}},onColumnSearch:function(e){var t="";if(e){t=e.getSource().getValue()}var i=new d("title",u.Contains,t);var o=[];o.push(i);var r=this.byId("insightsCardsEditColumnsListTable");var s=r.getBinding("items");s.filter(o,"Test")},onSegmentedSelectionChange:function(e){var t=this._oConfigureViewModel.getProperty("/bDesktop");var i=t?this.byId("columnSegButton"):this.byId("sdColumnSegButton"),o=i.getSelectedKey();if(o==="table"){var r=g.createListOptions(this._oConfigureViewModel.getProperty("/oConfCard"));var s=r.filter(function(e){if(e){return e["sap.card"].type==="Table"}});if(s.length){this._oConfigureViewModel.setProperty("/oConfCard",s[0]);var n=s[0]["sap.card"].content.row.columns;this._oConfigureViewModel.setProperty("/cardColumn",n)}}else if(o==="list"){var a=g.createTableOptions(this._oConfigureViewModel.getProperty("/oConfCard"));var l=a.filter(function(e){if(e){return e["sap.card"].type==="List"}});if(l.length){this._oConfigureViewModel.setProperty("/oConfCard",l[0]);var d=l[0]["sap.card"].content.item.attributes;this._oConfigureViewModel.setProperty("/cardColumn",d)}}},setColumnAndKPIValue:function(e){var t=e["sap.card"];if(t.type==="Table"){var i;i=t.content.row.columns;this._oConfigureViewModel.setProperty("/cardColumn",i);var o=i.map(function(e){e["visible"]=e["visible"]?e["visible"]:false;return e}).filter(function(e){return e.visible});this._oConfigureViewModel.setProperty("/visibleColumnCount",o.length);var r=g.createTableOptions(this._oConfigureViewModel.getProperty("/oConfCard"));var s=r.filter(function(e){return e["sap.card"].type==="List"});if(s.length){this._oConfigureViewModel.setProperty("/oConfCard",s[0]);var n=s[0]["sap.card"].content.item.attributes;this._oConfigureViewModel.setProperty("/cardColumn",n)}}this._callPreviewPage(e)},_onColumnDrop:function(e){var t=e.getParameter("dropPosition"),i=e.getParameter("draggedControl"),o=i.getBindingContextPath().split("/"),r=Number(o[2]),s=e.getParameter("droppedControl"),n=s.getBindingContextPath().split("/"),a=Number(n[2]),l=this._oConfigureViewModel.getProperty("/cardColumn");if(t==="Before"&&r===a-1){a--}else if(t==="After"&&r===a+1){a++}if(r!==a){if(t==="Before"&&r<a){a--}else if(t==="After"&&r>a){a++}var g=l.splice(r,1)[0];l.splice(a,0,g);this._oConfigureViewModel.setProperty("/cardColumn",l);if(this._oConfigureViewModel.getProperty("/bDesktop")===true){this._callShowPreview(this._oConfigureViewModel.getProperty("/oConfCard"))}}},_callNextPage:function(e){try{var t=sap.ui.getCore().byId("hocViewPage");if(e){var i=e["sap.card"];if(i.type==="Table"||i.type==="List"){var o=this._oConfigureViewModel.getProperty("/bDesktop");var s=o?this.getView().byId("columnSegButton"):this.getView().byId("sdColumnSegButton");if(!s.getSelectedKey()){s.setSelectedKey("list")}if(!this._oConfigureViewModel.getProperty("/columnPage")){this.getView().byId("columnSearch").setValue("");this.onColumnSearch()}this._oConfigureViewModel.setProperty("/oConfCard",e);var n=this.getView().byId("insightCardColumnPage");if(this._oConfigureViewModel.getProperty("/bDesktop")){this.getView().byId("previewCard").refresh()}else{this.getView().byId("previewColCardSD").refresh()}this._oConfigureViewModel.setProperty("/columnPage",true);this.getView().byId("navCon").to(n)}else if(i.type==="Analytical"){if(t){t.getController().showHouseOfCardsDialog(e);if(!this._oConfigureViewModel.getProperty("/bShowHoCPage")){sap.ui.getCore().byId("chartTypeSearch").setValue("");t.getController().onChartTypeSearch()}this.getView().byId("navCon").to(t)}else{this._getHoCView().then(function(t){t.getController().showHouseOfCardsDialog(e);this.getView().byId("navCon").to(t)}.bind(this))}}else{this._callPreview(e)}}this._oConfigureViewModel.setProperty("/bPreview",false)}catch(e){f.error(e.message);r.show(e.message);throw new Error(e)}},_formatTitle:function(e){var t=e.replace("{","").replace("}","");return t},handleKPIVisibilityToggle:function(e,t){var i=e.getSource();var o=i.getSelected();var r=this._oConfigureViewModel.getProperty("/oConfCard");var s=r["sap.card"];var n=s.header.type;if(o&&n!=="Numeric"){s.header.type="Numeric"}else{s.header.type="Default"}this._oConfigureViewModel.setProperty("/bShowMainIndicator",o)},handleColumnVisibilityToggle:function(e){var t=e.getSource();var i=t.getBindingContext("configureView").getPath();var o=this._oConfigureViewModel.getProperty(i);var r=t.getSelected();o["visible"]=r;var s=this._oConfigureViewModel.getProperty("/visibleColumnCount");this._oConfigureViewModel.setProperty("/visibleColumnCount",r?s+1:s-1);this._oConfigureViewModel.setProperty("/bRefresh",true);if(this._oConfigureViewModel.getProperty("/bDesktop")===true){this._callShowPreview(this._oConfigureViewModel.getProperty("/oConfCard"))}},navigateToCopy:function(e){var t=JSON.parse(JSON.stringify(this._oConfigureViewModel.getProperty("/oOrginalManifest")));t.descriptorContent=JSON.parse(JSON.stringify(e));var i=this.oSelectionController.byId("insightsCopyCardView");this.oNavCon.to(i);i.getController().initCopyCard(t)},onNavBack:function(){var e=this.getView().byId("insightCardPreviewPage").sId;var t=this.getView().byId("navCon").getCurrentPage().getModel("configureView");if(e===this.getView().byId("navCon").getPreviousPage().sId){if(t&&t.getProperty("/oConfCard")){this._callPreviewPage(t.getProperty("/oConfCard"))}else{this._callPreviewPage()}}}})});
//# sourceMappingURL=ColumnList.controller.js.map