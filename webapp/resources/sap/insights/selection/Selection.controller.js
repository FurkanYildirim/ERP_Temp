/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/model/resource/ResourceModel","../CardHelper","sap/m/MessageBox","sap/m/MessageToast","../base/Base.controller","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/base/util/UriParameters","sap/m/FormattedText","sap/m/Link","sap/ui/core/Fragment","../utils/CardRanking","../utils/BatchHelper","../utils/CardPreviewManager","sap/ui/model/json/JSONModel","../base/InMemoryCachingHost"],function(e,t,i,r,n,s,a,o,d,l,g,c,h,p,u,v){return n.extend("sap.insights.selection.Selection",{onInit:function(){var t=sap.ui.getCore().getLibraryResourceBundle("sap.insights");this.getView().setModel(new e({bundle:t}),"i18n");this.i18Bundle=this.getView().getModel("i18n").getResourceBundle();this.oNavCon=this.getView().byId("selectionNavCon");this.oNavCon.setBusy(true);this.bHasRankingProperty=true;this.getView().setModel(new u({selectionDialogOpen:false}),"cardSelectionModel");this.initUserCards();var i=this.createId("ManageCardHost");this.host=new v(i);this.getView().addDependent(this.host)},showSelectionDialog:function(e){this.orgCard=e;this.getView().getModel("cardSelectionModel").setProperty("/selectionDialogOpen",true);this._getSelectionDialog().open()},_getSelectionDialog:function(){return this.getView().byId("insightsSelectionDialog")},_getSelectionFragment:function(){return this.getView().byId("flexContainerCardsContent")},_getCardListPage:function(){return this.getView().byId("insightCardPage")},_getPreviewPage:function(){return this.getView().byId("previewPage")},closeDialog:function(){t.getServiceAsync("UIService").then(function(e){this.oNavCon.to(this._getCardListPage());this.getView().getModel("cardSelectionModel").setProperty("/selectionDialogOpen",false);this._getSelectionDialog().close();e.showCardPreview(this.orgCard,true)}.bind(this))},isConfigureEnabled:function(){var e=o.fromQuery(window.location.search).get("configure-cards")||"";return e.toUpperCase()==="TRUE"?true:false},handleCardListItemPress:function(e,t){var i=this.getView().getModel("view");i.setProperty("/showConfigButton",false);if(e){this.currentCardPreviewPath=e.getSource().getBindingContextPath()}else if(t){this.currentCardPreviewPath=t.getBindingContextPath()}var r=i.getProperty(this.currentCardPreviewPath);var n=r.descriptorContent["sap.card"].header.title;i.setProperty("/selectedCardTitle",n);var s=i.getProperty(this.currentCardPreviewPath).descriptorContent["sap.card"];var a=s.header.mainIndicator;if((s.type==="Table"||a)&&this.isConfigureEnabled()){i.setProperty("/showConfigButton",true)}var o=this.getView().byId("previewPage");this.oNavCon.to(o);var d=i.createBindingContext(this.currentCardPreviewPath);var l=p.getCardPreviewManifest(r.descriptorContent);i.setProperty("/previewDescriptor",l);this.byId("insightsPreviewOverflowLayer").setBindingContext(d,"view");var g=this.byId("smartForm");g.removeAllItems();this._setSmartFormForCardEdit(i.getProperty(this.currentCardPreviewPath));this.oCardHelperServiceInstance.getParentAppDetails(i.getProperty(this.currentCardPreviewPath)).then(function(e){i.setProperty("/parentAppTitle",e.title);i.setProperty("/parentAppUrl",e.semanticURL);i.setProperty("/parentAppsectionVisible",this.getIsNavigationEnabled(e))}.bind(this))},setCopyVisible:function(){var e=this.getView().getModel("view");e.setProperty("/showCopyButton",false);e.setProperty("/showFilterBy",false);var t=e.getProperty("/previewDescriptor");if(t){var i=t["sap.app"].dataSources;var r=i.filterService;var n=r&&r.uri;var s=r&&r.settings;if(n&&s){e.setProperty("/showFilterBy",true)}if(e.getProperty("/showFilterBy")&&t["sap.insights"].isDtCardCopy){e.setProperty("/showCopyButton",true)}}},handleCardVisibilityToggle:function(e){this._getSelectionFragment().setBusy(true);var t=e.getSource();var i=t.getBindingContext("view").getPath();var n=this.getView().getModel("view").getProperty(i);var s=t.getSelected();n.visibility=s;n.descriptorContent["sap.insights"].visible=s;this.setSelectedCards();this.oCardHelperServiceInstance.updateCard(n.descriptorContent,true).then(function(){this._getSelectionFragment().setBusy(false)}.bind(this)).catch(function(e){n.visibility=!s;n.descriptorContent["sap.insights"].visible=!s;this.getView().getModel("view").refresh();this._getSelectionFragment().setBusy(false);r.show(e.message)}.bind(this))},setSelectedCards:function(){var e=this.byId("insightsCardsListTable");if(e){this.getView().getModel("view").setProperty("/visibleCardCount",this.getSelectedCards().length)}},onEditInsightCardsDrop:function(e){if(!this.bHasRankingProperty){r.show(this.i18Bundle.getText("cardDnDUnavailable"));return}var t=e.getParameter("draggedControl"),i=t.getParent().indexOfItem(t),n=e.getParameter("droppedControl"),s=t.getParent().indexOfItem(n);if(i!==s){var a=this._setCardsRanking(i,s);a=a.map(function(e){var t=e.descriptorContent["sap.app"].id;e.descriptorContent["sap.insights"].ranking=e.rank;e.descriptorContent=JSON.stringify(e.descriptorContent);return{id:t,descriptorContent:e.descriptorContent}});try{this._getSelectionFragment().setBusy(true);h.createMultipartRequest(a).then(function(){return this.initUserCards(true)}.bind(this)).finally(function(){this._getSelectionFragment().setBusy(false)}.bind(this))}catch(e){this._getSelectionFragment().setBusy(false)}}},handleCardDeleteConfirm:function(){i.show(this.i18Bundle.getText("deleteCardMsg"),{icon:i.Icon.WARNING,title:this.i18Bundle.getText("delete"),actions:[i.Action.DELETE,i.Action.CANCEL],emphasizedAction:i.Action.DELETE,onClose:function(e){if(e===i.Action.DELETE){this.handleCardDelete(this.currentCardPreviewPath)}}.bind(this)})},handleCardDelete:function(e){var t=this.getView().getModel("view");this._getPreviewPage().setBusy(true);var i=t.getProperty(e);var n=i.descriptorContent["sap.app"].id;var s=i.descriptorContent["sap.card"].header.title;this.oCardHelperServiceInstance.deleteCard(n).then(function(){this._getPreviewPage().setBusy(false);r.show(this.i18Bundle.getText("deleteCardSuccess",s));var e=t.getProperty("/cards").filter(function(e){return e.descriptorContent["sap.app"].id!==n});var i=e.filter(function(e){return e.visibility});t.setProperty("/cards",e);t.setProperty("/cardCount",e.length);t.setProperty("/visibleCardCount",i.length);this.setDTCards();this.oNavCon.back();this.setSelectedCards()}.bind(this)).catch(function(e){this._getPreviewPage().setBusy(false);r.show(e.message)}.bind(this))},getSelectedCards:function(){var e=this.getView().getModel("view").getProperty("/cards");e=e.filter(function(e){return e.visibility});return e},initUserCards:function(e){return t.getServiceAsync().then(function(t){this.oCardHelperServiceInstance=t;return this.oCardHelperServiceInstance.getUserCardModel(e).then(function(e){this.getView().setModel(e,"view");var t=this.getView().getModel("view").getProperty("/cards");var i=0;t.forEach(function(e){if(e.visibility){if(++i>10){e.visibility=false}}if(e.rank===0){e.rank=500}if(!e.descriptorContent["sap.insights"].ranking||e.descriptorContent["sap.insights"].ranking!==e.rank){this.bHasRankingProperty=false}}.bind(this));var r=this.getView().getModel("view");r.setProperty("/cards",t);r.setProperty("/bShowMainIndicator",false);r.setProperty("/bMainIndicator",false);this.oSmartFormMap={};this._createOdataModelsforDialog(t);this.setDTCards();var n=this.isDeleteAllCardsEnabled();r.setProperty("/deleteAllEnabled",n);this.oNavCon.setBusy(false);this.getView().getModel("cardSelectionModel").setProperty("/selectionDialogOpen",false);return Promise.resolve()}.bind(this))}.bind(this))},_setCardsRanking:function(e,t){var i=this.byId("insightsCardsListTable").getItems().map(function(e){return e.getBindingContext("view").getObject()});if(e<t){return c.reorder(i,e,t+1)}return c.reorder(i,e,t)},onNavBack:function(){this.oNavCon.back()},navigateToCopyCard:function(){var e=this.getView().byId("insightsCopyCardView");var t=this.getView().getModel("view").getProperty(this.currentCardPreviewPath);this.oNavCon.to(e);e.getController().initCopyCard(t)},navigateToConfigureCard:function(){var e=this.getView().byId("insightsConfigureCardView");var t=this.getView().getModel("view").getProperty(this.currentCardPreviewPath);e.getController().initConfigureCard(t,true)},onCardSearch:function(e){var t=e.getSource().getValue();var i=new s("descriptorContent/sap.card/header/title",a.Contains,t);var r=[];r.push(i);var n=this.byId("insightsCardsListTable");var o=n.getBinding("items");o.filter(r,"Application")},refreshCardList:function(){var e=this.isDeleteAllCardsEnabled(),t;if(e){t=this.i18Bundle.getText("deleteAllCardsMsg")}else{var r=this.getView().getModel("view").getProperty("/DTCards");var n="<p>"+this.i18Bundle.getText("refreshAllCards")+"</p>";n+="<ul>";r.forEach(function(e){n+='<li class="sapUiTinyMarginBottom">'+e.descriptorContent["sap.card"].header.title+"</li>"});n+="</ul>";t=new d({htmlText:n})}i.show(t,{icon:i.Icon.WARNING,title:this.i18Bundle.getText("refresh"),actions:[i.Action.OK,i.Action.CANCEL],emphasizedAction:i.Action.OK,onClose:function(t){if(t===i.Action.OK){this.oNavCon.setBusy(true);this.oCardHelperServiceInstance._refreshUserCards(e).then(function(){this.initUserCards()}.bind(this))}}.bind(this)})},isDeleteAllCardsEnabled:function(){var e=o.fromQuery(window.location.search).get("delete-all-cards")||"";return e.toUpperCase()==="TRUE"?true:false},navigateToParentApp:function(){var e=this.getView().getModel("view");var t=e.getProperty("/parentAppUrl");sap.ushell.Container.getServiceAsync("CrossApplicationNavigation").then(function(e){e.toExternal({target:{shellHash:t}});this.oNavCon.back()}.bind(this))},showCardPreviewPopover:function(e){var t=this.getView().getModel("view");var i=e.getSource().getParent().getBindingContext("view").getPath();var r=t.getProperty(i);var n=e.getSource();var s=p.getCardPreviewManifest(r.descriptorContent);t.setProperty("/previewDescriptor",s);if(!this._oCardPreviewPopover){g.load({id:"cardPreviewPopover",name:"sap.insights.selection.cardPreviewPopover",controller:this}).then(function(e){this._oCardPreviewPopover=e;this.getView().addDependent(e);e.openBy(n)}.bind(this))}else{this._oCardPreviewPopover.openBy(n)}},navigateToCardPreview:function(e){var t=this.getView().getModel("view");var i=t.getProperty("/cards");var r=i.findIndex(function(t){return t.descriptorContent["sap.app"].id===e});if(r!==-1){var n=this.getView().byId("insightsCardsListTable").getItems();this.handleCardListItemPress(null,n[r])}},getIsNavigationEnabled:function(e){return sap.ushell.Container.getServiceAsync("CrossApplicationNavigation").then(function(t){return t.isNavigationSupported([{target:{semanticObject:e.semanticObject,action:e.action}}])}).then(function(e){return e[0].supported||false})},setDTCards:function(){var e=this.getView().getModel("view");var t=e.getProperty("/cards");var i=t.filter(function(e){return e.descriptorContent["sap.insights"].isDtCardCopy});e.setProperty("/DTCards",i)}})});
//# sourceMappingURL=Selection.controller.js.map