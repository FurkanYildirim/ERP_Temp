/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ui/model/resource/ResourceModel","sap/m/MessageToast","../CardHelper","sap/base/util/UriParameters","../utils/CardPreviewManager","sap/ui/Device","../utils/DeviceType","../utils/AppConstants","sap/base/Log"],function(e,t,r,i,s,a,o,n,d,l,g){var u=g.getLogger("sap.insights.preview.Preview");return e.extend("sap.insights.preview.Preview",{onInit:function(){this._oPreviewModel=new t({descriptor:{},previewDescriptor:{},oConfCard:{},oOrgCard:{}});this.getView().setModel(this._oPreviewModel,"cardPreviewModel");this.I18_BUNDLE=sap.ui.getCore().getLibraryResourceBundle("sap.insights");this.getView().setModel(new r({bundle:this.I18_BUNDLE}),"i18n");n.resize.attachHandler(this._adjustLayoutStyles.bind(this));this._adjustLayoutStyles();if(this._oPreviewModel.getProperty("/bDesktop")===true){this._oPreviewModel.setProperty("/bShowCardPreview",true)}},save:function(){var e=this.getView().getModel("cardPreviewModel").getProperty("/oConfCard");if(e["sap.card"].header.title.trim()){e["sap.insights"].visible=true;this._getPreviewDialog().setBusy(true);var t=o.insertActionsManifest(e,this.getView().getModel("cardPreviewModel").getProperty("/oOrgCard"));s.getServiceAsync().then(function(e){e.createCard(t).then(function(e){i.show(this.I18_BUNDLE.getText("Card_Created"));this._getPreviewDialog().setBusy(false);this.cancel()}.bind(this)).catch(function(e){i.show(e.message);this._getPreviewDialog().setBusy(false)}.bind(this))}.bind(this))}else{var r=this.getView().byId("titleTextInput");r.focus()}},_adjustLayoutStyles:function(){var e=d.getDialogBasedDevice();if(e===l.DEVICE_TYPES.Desktop){this._oPreviewModel.setProperty("/bDesktop",true)}else{this._oPreviewModel.setProperty("/bDesktop",false)}},cancel:function(){this._oPreviewModel.setProperty("/bShowCardPreview",false);this._getPreviewDialog().close()},handleTitleChange:function(e){var t=e.getSource();var r=t.getValue().trim();var i;if(this._oPreviewModel.getProperty("/bDesktop")){i=this.getView().byId("defaultPreviewCardLS")}else{i=this.getView().byId("defaultPreviewCardSD")}if(r){t.setValueState("None");t.setValueStateText("");if(i.getCardHeader()){i.getCardHeader().setTitle(r)}this.getView().byId("addPreviewCard").setEnabled(true)}else{t.setValueState("Error");t.setValueStateText(this.I18_BUNDLE.getText("INT_Preview_Title_ValueStateText"));this.getView().byId("addPreviewCard").setEnabled(false)}i.refresh()},handleSubTitleChange:function(e){var t=e.getSource();var r=t.getValue();var i;if(this._oPreviewModel.getProperty("/bDesktop")){i=this.getView().byId("defaultPreviewCardLS")}else{i=this.getView().byId("defaultPreviewCardSD")}if(i.getCardHeader()){i.getCardHeader().setSubtitle(r)}i.refresh()},handleVisibilityChange:function(e){var t=this.getView().getModel("cardPreviewModel");var r=e.getParameter("state");var i=t.getProperty("/descriptor");i["sap.insights"].visible=r;t.setProperty("/descriptor",i)},showCardSelectionDialog:function(){this._getPreviewDialog().close();var e=this.getView().getModel("cardPreviewModel");var t=e.getProperty("/descriptor");s.getServiceAsync("UIService").then(function(e){e._showCardSelectionDialog(t)})},_getPreviewDialog:function(){return this.getView().byId("previewDialog")},_onCardManifestApplied:function(e){var t=e.getSource();t.attachEvent("_error",this._onCardLoadFailure.bind(this,t));t.attachEvent("stateChanged",this._onCardStateChanged.bind(this,t));t.attachEvent("_contentReady",this._onCardContentReady.bind(this,t))},_onCardLoadFailure:function(e,t){if(t&&t.getParameters()&&t.getParameters().message){}},_onCardStateChanged:function(e){var t=this.getView().getModel("cardPreviewModel");var r=e.getManifest();var i=r["sap.card"].header.title;if(e.isReady()&&!this.bCardError&&i&&i.trim()){t.setProperty("/bAddButton",true)}else{t.setProperty("/bAddButton",false)}},_onCardContentReady:function(e){var t=this.getView().getModel("cardPreviewModel");if(o.hasVizData(e)){t.setProperty("/bCardHasData",true)}else{t.setProperty("/bCardHasData",false)}},_callPreview:function(e){var t,r;r=this._oPreviewModel.getProperty("/bDesktop");this._oPreviewModel.setProperty("/bShowCardPreview",true);t=r?"defaultPreviewCardLS":"defaultPreviewCardSD";if(this.getView().byId(t)){this.getView().byId(t).refresh()}},_callClosePreview:function(e){this._oPreviewModel.setProperty("/bShowCardPreview",false)},showPreview:function(e,t,r){var i=this.getView().getModel("cardPreviewModel");return s.getServiceAsync().then(function(s){return s.getUserCards().then(function(s){var a=s.filter(function(e){return e.visibility});if(a.length>9){e["sap.insights"].visible=false}i.setProperty("/oOrgCard",e);var n=JSON.parse(JSON.stringify(e));i.setProperty("/descriptor",e);n=o.getCardPreviewManifest(e);i.setProperty("/oConfCard",n);if(!r){i.setProperty("/bAddButton",false)}this.bCardError=false;var d=this.getView().byId("titleTextInput");d.setValueState("None");var l=e["sap.card"];if((l.type==="Table"||l.type==="Analytical")&&t&&!i.getProperty("/bConfigureOpen")&&!r){i.setProperty("/bConfigureOpen",true);return this.showCardConfigureDialog(e)}else if(!t){this._formatTitle(d.getValue());this._getPreviewDialog().open();i.setProperty("/bConfigureOpen",false);return Promise.resolve()}}.bind(this))}.bind(this)).catch(function(e){if(i.getProperty("/bConfigureOpen")){i.setProperty("/bConfigureOpen",false)}u.error(e.message);return Promise.reject(e)})},_formatTitle:function(e){var t=this.getView().byId("titleTextInput");if(e&&e.trim()){t.setValueState("None");t.setValueStateText("");this.getView().byId("addPreviewCard").setEnabled(true)}else{t.setValueState("Error");t.setValueStateText(this.I18_BUNDLE.getText("INT_Preview_Title_ValueStateText"));this.getView().byId("addPreviewCard").setEnabled(false)}},showHouseOfCardsDialog:function(e){this.getView().setBusy(true);var t=this.getView().getModel("cardPreviewModel").getProperty("/descriptor");s.getServiceAsync("UIService").then(function(e){e.showHouseOfCardsDialog(t).then(function(){this.getView().setBusy(false);this._getPreviewDialog().close()}.bind(this))}.bind(this)).catch(function(e){i.show(e.message)})},showCardConfigureDialog:function(e){return s.getServiceAsync("UIService").then(function(t){return t._showCardConfigureDialog(e).then(function(){this.getView().setBusy(false);return Promise.resolve()}.bind(this))}.bind(this)).catch(function(e){i.show(e.message);u.error(e.message);return Promise.reject(e)})},isConfigureEnabled:function(){var e=a.fromQuery(window.location.search).get("configure-cards")||"";return e.toUpperCase()==="TRUE"?true:false}})});
//# sourceMappingURL=Preview.controller.js.map