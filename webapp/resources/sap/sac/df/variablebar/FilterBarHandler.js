sap.ui.define("sap/sac/df/variablebar/FilterBarHandler",["sap/ui/mdc/FilterField","sap/ui/base/ManagedObjectObserver","sap/ui/mdc/p13n/StateUtil","sap/sac/df/variablebar/TypeUtil","sap/sac/df/thirdparty/lodash"],function(e,t,i,a,r){"use strict";return{initialise:function(e){this._oFilterBar=e;this._initialiseFilterBar();return this},_initialiseFilterBar:function(){var e={};this._setPathToVariables();r.forEach(this._getVariables(),function(t){t=t.MergedVariable?t.MergedVariable:t;this.addFilterItem(t);if(t.MemberFilter&&t.MemberFilter.length>0){e[t.Name]=this.getFilterConditions(t)}}.bind(this));this.updateAllConditions(e);this.changeEventsHandlerInAdaptFilter()},_setPathToVariables:function(){if(this._oFilterBar.getProperty("mode")==="VariableGroups"){this._pathToVariables="/VariableGroups"}else{this._pathToVariables="/DataProvider/"+this._getDataProviderName()+"/Variables"}},_getPathToVariables:function(){return this._pathToVariables},_getPathToVariable:function(e){return this._oFilterBar.getProperty("mode")==="VariableGroups"?this._getPathToVariables()+"/"+e+"/MergedVariable":this._getPathToVariables()+"/"+e},_getMultiDimModel:function(){var e=this._oFilterBar.getModel();return e?e:this._oFilterBar.getParent().getModel(this._oFilterBar.getMultiDimModelId())},_getDataProviderName:function(){var e=this._getMultiDimModel().getProperty("/DataProvider");return e&&Object.keys(e)[0]},_getDataProvider:function(){return this._getMultiDimModel().getProperty("/DataProvider/"+this._getDataProviderName())},_getVariables:function(){return this._getMultiDimModel().getProperty(this._pathToVariables)},_getVariable:function(e){return this._getMultiDimModel().getProperty(this._getPathToVariable(e))},addFilterItem:function(e){var t=this.createFilterField(e);this._oFilterBar.addFilterItem(t);return t},updateAllConditions:function(e){var t={};t.filter=e;i.applyExternalState(this._oFilterBar,t)},getFilterConditions:function(e){var t=[];e.MemberFilter.forEach(function(i){var a={operator:"EQ",validated:"Validated"};a.values=[i.Low];if(!e.ValueType.includes("Date")&&!e.ValueType.includes("Time")){var r=i.LowText&&i.Low!==i.LowText?i.LowText:"";a.values.push(r)}t.push(a)});return t},changeEventsHandlerInAdaptFilter:function(){var e=this._getObserver();this._oFilterBar.retrieveInbuiltFilter().then(function(t){e.observe(t,{aggregations:["filterItems"]})});e.observe(this._oFilterBar,{aggregations:["dependents"]})},createFilterField:function(t){var i=t.ValueType.includes("Date")||t.ValueType.includes("Time");var r=a.getFormatOptions(t.ValueType);var l={dataType:a.getDataTypeClassName(t.ValueType),dataTypeFormatOptions:r?r:null,delegate:{name:i||!t.SupportsValueHelp?"sap/ui/mdc/field/FieldBaseDelegate":"sap/sac/df/variablebar/FieldBaseDelegate",payload:{valueType:t.ValueType,supportsValueHelp:t.SupportsValueHelp}},label:t.Description,tooltip:t.Description,required:t.Mandatory,display:i||!t.SupportsValueHelp?"Value":"ValueDescription",conditions:"{$filters>/conditions/"+t.Name+"}",maxConditions:i||!t.SupportsMultipleValues?1:-1,operators:t.SupportsValueHelp&&!i?[]:["EQ"]};var n=new e(this.getFilterFieldId(t.Name),l);if(!i){this._getObserver().observe(n,{aggregations:["_content"]})}return n},getFilterFieldId:function(e){return this._oFilterBar.getId()+"::FilterField::"+e.replace(/[^0-9A-Z_.:-]/gi,"")},_getObserver:function(){if(!this._oObserver){this._oObserver=new t(this._observeChanges.bind(this))}return this._oObserver},_observeChanges:function(e){if(e.name==="_content"){this._onFieldChange(e.object,true)}if(e.name==="filterItems"){this._onFieldChange(e.child,false)}if(e.name==="dependents"&&e.mutation==="insert"&&e.child&&e.child.isA("sap.m.p13n.Popup")){this._onCloseAdaptFilterDialog(e.child)}},_onFieldChange:function(e,t){var i=e.getAggregation("_content")&&e.getAggregation("_content")[0];if(i){var a=i.mEventRegistry;while(a.valueHelpRequest&&a.valueHelpRequest.length){var r=a.valueHelpRequest[0];i.detachValueHelpRequest(r.fFunction,r.oListener)}if(i.attachValueHelpRequest){i.attachValueHelpRequest(null,this._onValueHelpRequest,this)}if(t){this._getObserver().unobserve(e,{aggregations:["_content"]})}}},_onCloseAdaptFilterDialog:function(e){this._oVariables={};r.forEach(this._getVariables(),function(e){this._oVariables[e.Name]={Name:e.Name,MemberFilter:[].concat(e.MemberFilter)}}.bind(this));var t=function(e){if(e.getParameters().reason==="Cancel"){var t=this._getDataProvider();r.forEach(this._oVariables,function(e){var i=e.MemberFilter?e.MemberFilter:[];t.setVariableValue(e.Name,i)}.bind(this))}this._oVariables=undefined};e.attachClose(null,t,this)},_onValueHelpRequest:function(e){var t=e.getSource().getParent();var i=t.getParent();var a=t.getFieldPath();var r;if(i.isA("sap.ui.mdc.FilterBar")){r=i;r.fireBeforeFilterChange({beforeValueHelpOpen:true})}else if(i.isA("sap.ui.mdc.filterbar.p13n.AdaptationFilterBar")){r=sap.ui.getCore().byId(i.getAssociation("adaptationControl"));r.fireBeforeFilterChange({beforeValueHelpOpen:true})}this._getDataProvider().openVariableSelector(a).then(function(e){if(e){var t=this._getVariable(a);this.updateConditionsForSingleField(t,i)}else if(r){r.fireCancelFilterChange()}}.bind(this))},updateConditionsForSingleField:function(e,t){var a={filter:{}};a.filter[e.Name]=this.getFilterConditions(e);return i.retrieveExternalState(t).then(function(r){if(r.filter[e.Name]){return i.diffState(t,r.filter[e.Name],a)}return null}).then(function(r){if(r&&r.filter&&r.filter[e.Name]){a.filter[e.Name]=r.filter[e.Name]}return i.applyExternalState(t,a)})}}});
//# sourceMappingURL=FilterBarHandler.js.map