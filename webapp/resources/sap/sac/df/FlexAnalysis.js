/*
 * SAPUI5
    (c) Copyright 2009-2021 SAP SE. All rights reserved
  
 */
sap.ui.define("sap/sac/df/FlexAnalysis",["sap/sac/df/types/SystemType","sap/ui/core/Control","sap/base/Log","sap/ui/model/json/JSONModel","jquery.sap.global","sap/sac/df/olap/MultiDimModel","sap/sac/df/firefly/library","sap/sac/df/fa/FlexAnalysisContextMenuProvider"],function(e,t,i,r,jQuery,a,n,s){"use strict";var o="GalaxyDataStudio";var l="FA.emptyDP";var u="FA.NO_DS";var g="empty";var d=t.extend("sap.sac.df.FlexAnalysis",{metadata:{properties:{title:{type:"string"},showTitle:{type:"boolean",defaultValue:false},autoUpdate:{type:"boolean",defaultValue:true},configurationURI:{type:"string"},configObject:{type:"object"},configId:{type:"string"},width:{type:"sap.ui.core.CSSSize",defaultValue:"100%"},height:{type:"sap.ui.core.CSSSize",defaultValue:"100%"},hideDesignPanel:{type:"boolean",defaultValue:true},hideStylePanel:{type:"boolean",defaultValue:true},hideMenuBar:{type:"boolean",defaultValue:true},hideStatusBar:{type:"boolean",defaultValue:true},hideToolBar:{type:"boolean",defaultValue:true},hideFilterLine:{type:"boolean",defaultValue:false},hideSideNavigation:{type:"boolean",defaultValue:false},hideLandingPage:{type:"boolean",defaultValue:true},environment:{type:"string[]",defaultValue:[]},systemName:{type:"string"},dataSource:{type:"string",defaultValue:"$datasource"},systemType:{type:"sap.sac.df.types.SystemType",defaultValue:e.BW},keepAliveInterval:{type:"int",defaultValue:0},clientIdentifier:{type:"string"},dataProvider:{type:"any",bindable:true},multiDimModelId:{type:"string",defaultValue:"om"},implicitVariableHandling:{type:"boolean",defaultValue:true,bindable:false},styleTemplateName:{type:"string"}},events:{},aggregations:{customPanels:{type:"sap.sac.df.FlexAnalysisPanel",multiple:true}},defaultAggregation:"customPanels"},logActive:false,init:function(){this.programContainerID=this.getId()+"--program";this.programContainer=jQuery('<div id="'+this.programContainerID+'"/>');this.contextMenuProvider=new s(this);this.log("Created")},renderer:{apiVersion:2,render:function(e,t){if(t._error){e.openStart("span",t.getId()+"-error");e.openEnd();e.text(t._error.toString());e.close("span")}else{e.openStart("div",t);e.style("flex","auto");e.style("width",t.getWidth());e.style("height",t.getHeight());e.attr("data-sap-ui-preserve",t.getId());e.openEnd();e.close("div")}}},onAfterRendering:function(){if(t.prototype.onAfterRendering){t.prototype.onAfterRendering.apply(this,arguments)}var e=this.$();this.programContainer.appendTo(e);if(this.closed){e.css("visibility","hidden")}this.log("On after rendering");if(!this.isProgramRunning){this.runProgram()}else if(this._rerender){this._checkAutoUpdate()}e.css("position","relative")},updateProgramSettings:function(){this.log("Update program settings");var e=this.program.getProcess().getApplication();e.setClientInfo(null,this.getClientIdentifier(),null);this.program.setShowToolbar(!this.getHideToolBar());var t=this.program.getActiveDocument();t.setFilterLineVisible(!this.getHideFilterLine());t.setDesignerPanelVisible(!this.getHideDesignPanel());t.setStylePanelVisible(!this.getHideStylePanel());t.setSideNavigationVisible(!this.getHideSideNavigation());this.applyAutoUpdate();this.updateStyleTemplate();this.updateTitle();this._rerender=true},registerCustomPanels:function(){var e=this.getCustomPanels();e.forEach(function(e){this.program.registerCustomPanel(e)}.bind(this))},onUiStateChange:function(e){this.log("UI state changed");var t=e.convertToNative();if(t){var i=t[n.AuGdsQbConstants.QD_UI_STATE_OPEN_PANELS];if(i){var r=n.AuGdsPanelType.DESIGNER.getName();var a=Object.prototype.hasOwnProperty.call(i,r)?i[r]:false;this.setProperty("hideDesignPanel",!a,true);var s=n.AuGdsPanelType.STYLE.getName();var o=Object.prototype.hasOwnProperty.call(i,s)?i[s]:false;this.setProperty("hideStylePanel",!o,true)}if(Object.prototype.hasOwnProperty.call(t,n.AuGdsQbConstants.QD_UI_STATE_AUTO_UPDATE)){this.setProperty("autoUpdate",t[n.AuGdsQbConstants.QD_UI_STATE_AUTO_UPDATE],true)}}},registerUiStateChange:function(){var e=this.program.getActiveDocument();if(e&&e.addUiStateChangeCallback){e.addUiStateChangeCallback(this.onUiStateChange.bind(this))}},updateTitle:function(){if(this.program){var e=this.program.getActiveDocument();if(typeof this.getTitle()=="string"){e.setDocumentTitle(this.getTitle())}e.createQueryDetailsIfNeeded();e.setTableTitleVisible(this.getShowTitle())}},getMultiDimModel:function(){var e=this.getMultiDimModelId();return this.getParent().getModel(e)},runProgram:function(){this.log("Run UI5 program");this.isProgramRunning=true;this._error=undefined;return this._initModel().then(this._initQuery.bind(this)).then(function(){var e=this.getMultiDimModel();this.programInstance=n.ProgramRunner.createRunner(e.getSession(),o);return this._processConfigURI().then(function(){this._setClientArgs();this._setClientEnvironment(this.programInstance);this.programInstance.setNativeAnchorId(this.programContainerID);var e=this.dataProviderInstance&&this.dataProviderInstance.getQueryManager();if(e){this.programInstance.setObjectArgument("queryManager",e)}this.programInstance.runProgram().then(function(e){this.log("GDS created");this.program=e;this.registerCustomPanels();this.registerUiStateChange();this.program.registerDynamicMenuActionsProvider("UI5ContextMenuProvider",this.contextMenuProvider);this.updateTitle();this.updateProgramSettings()}.bind(this)).onCatch(function(e){throw new Error(e)})}.bind(this))}.bind(this)).catch(this._handleInitalisationErrors.bind(this))},exit:function(){if(this.programInstance){this._cleanUpProgram()}},getProgram:function(){return this.program},setPanelVisible:function(e,t){if(this.program){var i=this.program.getActiveDocument();if(i&&i.setPanelVisible){var r=n.AuGdsPanelType.lookup(e);if(r){i.setPanelVisible(r,t)}else{throw new Error("Cannot resolve panel type to adjust visibility!")}}}},setDataProvider:function(e){var t=this;t.closed=false;if(!e){e=l}t.setProperty("dataProvider",e);if(t.program){t._initQuery().then(function(){if(t.dataProviderInstance){var e=t.dataProviderInstance.getQueryManager();{if(e&&!e.isReleased()){t.program.getActiveDocument().setExternalQueryManager(t.dataProviderInstance.getQueryManager())}}}})}return this},addContextMenuAction:function(e,t){this.contextMenuProvider.registerAction(e,t)},setDataSource:function(e){var t=this;t.closed=false;if(e===null){e=u}if(e&&e.startsWith("$")){e=this.getUrlParams("datasource")}var i=this.getProperty("dataSource");if(i===e){return this}if(e===u){if(i){t._removeQuery(i).then(function(){if(t.program){t.program.getActiveDocument().setExternalQueryManager(null);t.closed=true;t.invalidate()}})}}else if(t.program){t._initQuery().then(function(){t.program.getActiveDocument().setExternalQueryManager(t.dataProviderInstance.getQueryManager())})}t.setProperty("dataSource",e,true);t.setProperty("dataProvider",undefined);return this},setHideFilterLine:function(e){this.setProperty("hideFilterLine",e,true);if(this.program){this.program.getActiveDocument().setFilterLineVisible(!e)}return this},setStyleTemplateName:function(e){this.setProperty("styleTemplateName",e,true);this.updateStyleTemplate();return this},setAutoUpdate:function(e){this.setProperty("autoUpdate",e,true);if(this.program){this.program.getActiveDocument().setAutoUpdatesEnabled(e)}return this},setHideToolBar:function(e){this.setProperty("hideToolBar",e,true);if(this.program){this.program.setShowToolbar(!e)}return this},setTitle:function(e){this.setProperty("title",e,true);this.updateTitle();return this},setShowTitle:function(e){this.setProperty("showTitle",e,true);this.updateTitle();return this},setHideSideNavigation:function(e){this.setProperty("hideSideNavigation",e,true);if(this.program){this.program.getActiveDocument().setSideNavigationVisible(!e)}return this},setHideDesignPanel:function(e){this.setProperty("hideDesignPanel",e,true);if(this.program){this.program.getActiveDocument().setDesignerPanelVisible(!e)}return this},setHideStylePanel:function(e){this.setProperty("hideStylePanel",e,true);if(this.program){this.program.getActiveDocument().setStylePanelVisible(!e)}return this},_cleanUpProgram:function(){n.XObjectExt.release(this.programInstance);n.XObjectExt.release(this.program);this.programInstance=null;this.program=null;var e=sap.ui.core.UIArea.registry.get(this.programContainerID);if(e){e.destroy()}this.isProgramRunning=false},_initModel:function(){var e=this;return Promise.resolve().then(function(){e.log("Start init model");var t=e.getMultiDimModel();if(!t){var i={masterSystem:e._getSystemName(),systemType:e.getSystemType(),keepAliveInterval:e.getKeepAliveInterval()||-1};t=new a(i);e.getParent().setModel(t,e.getMultiDimModelId())}t.attachEvent("dataProviderAdded",null,function(i){var r=i.getParameter("dataProviderName");e.log("DP added '"+r+"'");if(r===e.getDataProvider()){this.dataProviderInstance=t.getDataProvider(r);if(this.dataProviderInstance){if(this.program&&this.program.getActiveDocument()){this._rerender=false;this.program.getActiveDocument().getQueryController().initWithExistingQueryManager(this.dataProviderInstance.getQueryManager());setTimeout(10,function(){this.updateProgramSettings();this._rerender=true}.bind(this))}}}},e);t.attachEvent("dataProviderUpdated",null,function(i){var r=i.getParameter("dataProviderName");e.log("DP changed '"+r+"'");if(r===e.getDataProvider()){this.dataProviderInstance=t.getDataProvider(r);if(this.dataProviderInstance){if(this.program&&this.program.getActiveDocument()){this.program.getActiveDocument().notifyQueryManagerStateChange()}}}},e);return t.loaded()})},_parseDataSource:function(t){var i=n.QFactory.createDataSource();var r=t||this.getDataSource();if(r.indexOf(":[")>0){i.setFullQualifiedName(r)}else{i.setObjectName(r);i.setType(this.getSystemType()===e.BW?n.MetaObjectType.QUERY:n.MetaObjectType.DBVIEW)}return i},_initQuery:function(){var e=this.getMultiDimModel();return Promise.resolve().then(function(){this.log("Start init query");if(this.getDataProvider()){var t=this.getDataProvider();if(t===l){this.dataProviderInstance=null;if(this.program){var i=this.programInstance.getCurrentStartConfig().getArguments().getArgumentStructure();this.program.openDocument(n.AuGdsDocumentType.QUERY_BUILDER,null,null,i)}}else{this.log("Update DP instance to '"+t+"'");this.dataProviderInstance=e.getProperty("/DataProvider/"+t)}}else if(this.getDataSource()){var r=this._parseDataSource();var a=r.getObjectName();this.dataProviderInstance=e.getDataProvider(a);if(this.dataProviderInstance){return}return e.addDataProvider(a,a,this._getSystemName(),r.getPackageName(),r.getSchemaName(),r.getType()).then(function(e){this.dataProviderInstance=e;this.setProperty("dataProvider",a,true)}.bind(this))}else{throw new Error("A dataProvider or dataSource must be specified")}}.bind(this))},_removeQuery:function(e){var t=this.getMultiDimModel();return Promise.resolve().then(function(){if(this.getDataSource()===u){var i=this._parseDataSource(e);var r=i.getObjectName();this.dataProviderInstance=t.getDataProvider(r);if(!this.dataProviderInstance){return}return t.removeDataProvider(r).then(function(){this.dataProviderInstance=null;this.setProperty("dataProvider",null,true)}.bind(this))}}.bind(this))},_setClientArgs:function(){this.log("setClientArgs");this.programInstance.setArgument(n.AuGdsConstants.GDF_FILE_DOC_TYPE,this.getDocType());this.programInstance.setArgument(n.AuGdsConstants.PARAM_SYSTEM,this._getSystemName());this.programInstance.setBooleanArgument(n.AuGdsConstants.PARAM_MULTI_DOCUMENTS,false);this.programInstance.setBooleanArgument(n.AuGdsConstants.PARAM_HIDE_STATUS_BAR,this.getHideStatusBar());this.programInstance.setBooleanArgument(n.AuGdsConstants.PARAM_HIDE_MENU_BAR,this.getHideMenuBar());this.programInstance.setBooleanArgument(n.AuGdsConstants.PARAM_HIDE_TOOLBAR,this.getHideToolBar());this.programInstance.setBooleanArgument(n.AuGdsConstants.PARAM_QUERY_BUILDER_MULTI_VIEWS,false);this.programInstance.setBooleanArgument(n.AuGdsConstants.PARAM_QUERY_BUILDER_AUTO_OPEN_DATA_SOURCE_PICKER,false);this.programInstance.setBooleanArgument(n.AuGdsConstants.PARAM_IMPLICIT_VARIABLE_HANDLING,this.getImplicitVariableHandling());this.programInstance.setBooleanArgument(n.AuGdsConstants.PARAM_SUPPRESS_LANDING_PAGE,this.getHideLandingPage());this.programInstance.setArgument(n.AuGdsConstants.PARAM_INTEGRATION,"ui5");this.programInstance.setArgument(n.AuGdsConstants.PARAM_MODE,n.AuGdsConstants.VALUE_MODE_SAP_UI5_GA)},_handleInitalisationErrors:function(e){this._error=e;this.invalidate()},isEqualTo:function(){return false},onQueryExecuted:function(){if(this.getParent().getModel(this.getModelId())){this.getParent().getModel(this.getModelId()).fireRequestCompleted({infoObject:this.getDataProvider()})}this.fireQueryExecuted()},getDocType:function(){return"QueryBuilder"},_getSystemName:function(){var e=this.getSystemName();if(e&&e.startsWith("$")){e=this.getUrlParams("system")}return e?e:"local"+this.getSystemType()},_updateSupportedPanelsConfiguration:function(e,t){var i=this.getCustomPanels();if(i.length){var r=i.map(function(e){return e.getPanelId()}),a="/QueryBuilder/SideNavigation/SupportedPanels",n=e.getProperty(a);if(n){n=n.concat(r)}else{n=r}e.setProperty(a,n);if(t){e.setProperty("/QueryBuilder/PanelSettings/StylePanel/ConditionalFormatting",false)}}},_processConfigURI:function(){var e=this.programInstance;return new Promise(function(e){var t=this.getConfigObject();if(t){e(JSON.stringify(t))}else{var i=this.getConfigurationURI();var a=this.getConfigId();var n=false;if(a){if(a=="reviewbooklet-op"){n=true;a="reviewbooklet"}i=sap.ui.require.toUrl("sap/sac/df/fa/configs/"+a+"-config.json")}if(!i){i=sap.ui.require.toUrl("sap/sac/df/fa/configs/sap-ui5-config.json")}var s=new r(i);s.attachRequestCompleted(function(t){var i=t.getSource();this._updateSupportedPanelsConfiguration(i,n);e(JSON.stringify(i.getData()))}.bind(this))}}.bind(this)).then(function(t){if(t){e.setArgument(n.AuGdsConstants.PARAM_CONFIGURATION,t)}})},getUrlParams:function(e){return(window.location.href.split(e+"=")[1]||"").split("&")[0]},_setClientEnvironment:function(e){var t=this.getEnvironment();t.forEach(function(t){var i=t.split("=");e.setEnvironmentVariable(i[0],i[1])}.bind(this))},log:function(e){if(this.logActive){console.log(this.getId()+": "+e)}},updateStyleTemplate:function(){if(this.program){var e=this.program.getActiveDocument();if(e.getTableView()&&e.getTableView().getTableDefinition()){var t=this.getStyleTemplateName();if(!t){return}var i=e.getTableView().getTableDefinition();if(t===g){if(i.getLinkedDefinition("FA")){i.unlinkDefinition("FA")}}else{var r=this.getMultiDimModel().getStylingProvider().getTemplate(t);if(r.getStyleForDataProvider){r=r.getStyleForDataProvider(this.dataProviderInstance)}var a=n.QFactory.createTableDefinition();a.deserializeFromElementExt(n.QModelFormat.INA_REPOSITORY,new n.NativeJsonProxyElement(r));i.putLinkedDefinition("FA",a)}e.getTableView().reRenderTableStyling()}}},applyAutoUpdate:function(){var e=this.getAutoUpdate();var t=this.program.getActiveDocument();if(!e&&t.getQueryManager()&&t.getQueryManager().getResultSetSyncState()===n.SyncState.IN_SYNC){t.setAutoUpdatesEnabled(true);setTimeout(function(){t.setAutoUpdatesEnabled(false)},35)}else{t.setAutoUpdatesEnabled(e)}},_checkAutoUpdate:function(){if(this.getAutoUpdate()&&this.dataProviderInstance&&!this.dataProviderInstance.isValid()){this.dataProviderInstance.getResultSet()}}});return d});
//# sourceMappingURL=FlexAnalysis.js.map