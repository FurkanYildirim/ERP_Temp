/*
 * SAPUI5
    (c) Copyright 2009-2021 SAP SE. All rights reserved
  
 */
sap.ui.define("sap/sac/df/olap/MultiDimModel",["sap/base/Log","sap/ui/model/Model","sap/ui/model/Context","sap/sac/df/types/ValueType","sap/sac/df/olap/SystemLandscape","sap/sac/df/utils/SyncActionHelper","sap/sac/df/utils/ListHelper","sap/sac/df/DFKernel","sap/sac/df/olap/OlapListBinding","sap/sac/df/olap/OlapListGridBinding","sap/sac/df/olap/OlapPropertyBinding","sap/sac/df/olap/MultiDimDataProvider","sap/sac/df/utils/ResourceBundle","sap/sac/df/fa/AdvancedStylingProvider","sap/sac/df/thirdparty/lodash","sap/sac/df/firefly/library"],function(e,a,r,t,n,i,o,s,c,u,d,l,f,v,p,m){"use strict";var g=new RegExp("/","g");var y=s.extend("sap.sac.df.olap.MultiDimModel",{constructor:function(a){this.stylingProvider=new v;var t=this;var o=a||{};o.systemLandscape=o.systemLandscape||n;o.systemType=o.systemType||"BW";o.masterSystem=o.masterSystem||"local"+o.systemType;s.apply(t,[o]);var y=null;var P={};var h={};var D=t.init(o).then(function(){m.UiLocalizationCenter.setExternalLocalizationProvider(f);m.UiLocalizationCenter.getCenter().setProductive(true)}).then(function(){y={ColLimit:50,RowLimit:150,DataProvider:{},VariableGroups:{},SemanticStyles:{},Messages:[]};t.checkUpdate()});t.setDataAccessLanguage=function(e){var a=t.getApplication().getSystemLandscape();var r=a.getSystemNames();for(var n=0;n<r.size();n++){a.getSystemDescription(r.get(n)).setLanguage(e)}};t.getLimit=function(){return{RowLimit:y.RowLimit,ColLimit:y.ColLimit}};t.addVariableGroup=function(e,a,r){y.VariableGroups[e]={Name:e,Rule:a,MergedVariable:null};Object.assign(y.VariableGroups[e],r);N(e)};t.addDataProvider=function(e,a,r,n,o,s){var c=r||this.masterSystemName;var u=y.DataProvider[e];y.DataProvider[e]=null;return b(c).then(function(){if(!u)return;return u.logoff()}).then(function(){var e=m.QueryServiceConfig.createWithDataSourceName(t.getApplication(),null,a);e.setMode(m.QueryManagerMode.DEFAULT);e.setProviderType(m.ProviderType.ANALYTICS);e.setSupportsDimensionLazyLoad(true);var r=["$[][][MY_DATA_AREA]/",s||"query",":","[",o?o:"","]","[",o||n?n:"","]","[",a,"]"].join("");e.setDataSourceByName(r);e.setSystemName(c);return i.syncActionToPromise(e.processQueryManagerCreation,e,[])}).then(function(a){y.DataProvider[e]=new l(t,t.getApplication(),a,e);y.DataProvider[e].SystemName=c;N();t.fireEvent("queryAdded",{dataProviderName:e});t.fireEvent("dataProviderAdded",{dataProviderName:e});return y.DataProvider[e]}).catch(function(e){t.addMessages(e.getMessages?e.getMessages():[]);return Promise.reject(e)})};t.fireDataProviderUpdated=function(e){t.fireEvent("dataProviderUpdated",e);return t};t.removeDataProvider=function(e){var a=y.DataProvider[e];y.DataProvider[e]=null;if(a){return a.logoff().then(function(){N();t.fireEvent("dataProviderRemoved",{dataProviderName:e})}).catch(function(e){return Promise.resolve(e)})}else{return Promise.resolve()}};t.setVariableGroupValue=function(e,a){var r=y.VariableGroups[e];var n=r.MergedVariable.DataProviderName;return y.DataProvider[n].setVariableValue(r.MergedVariable.Name,a).then(function(){N(e);return t.checkUpdate()})};t.deserialize=function(e){y.DataProvider=y.DataProvider||{};y.SemanticStyles=e.SemanticStyles||[];return D.then(function(){var a=[];p.forEach(e.DataProvider,function(e,r){var n=y.DataProvider[r];if(!n){var o=m.QueryServiceConfig.createByDefinition(t.getApplication(),null,m.XContent.createStringContent(m.QModelFormat.INA_REPOSITORY,e));a.push(i.syncActionToPromise(o.processQueryManagerCreation,o,[]).then(function(e){y.DataProvider[r]=new l(t,t.getApplication(),e,r)}))}else{a.push(n.deserialize(e))}});return Promise.all(a)}).then(function(){N();return t.checkUpdate()})};t.serialize=function(){return{DataProvider:p.reduce(y.DataProvider,function(e,a){e[a.Name]=a.serialize();return e},{}),SemanticStyles:t.getSemanticStyles()}};t.openVariableSelector=function(e){return Promise.resolve(null).then(function(){var a=y.VariableGroups[e];if(!a){throw new Error("Invalid VariableGroup: "+e)}if(!a.MergedVariable){return false}var r=y.DataProvider[a.MergedVariable.DataProviderName];return r.openVariableSelector(a.MergedVariable.Name).then(function(a){if(!a){return false}N(e);t.checkUpdate();return true})})};t.searchVariableValues=function(e,a,r){return Promise.resolve(null).then(function(){var t=y.VariableGroups[e];if(!t){throw new Error("Invalid VariableGroup: "+e)}if(!t.MergedVariable){return false}var n=y.DataProvider[t.MergedVariable.DataProviderName];return n.searchVariableValues(t.MergedVariable.Name,a,r)})};t.logoff=function(){return Promise.all(p.invokeMap(y.DataProvider,"logoff"))};t.synchronize=function(e){var a=e?p.filter(y.DataProvider,function(a){return e.includes(a.Name)}):y.DataProvider;var r=p.invokeMap(a,"getResultSet");return Promise.all(r).then(function(){return t.checkUpdate()})};t.resetModel=function(){var e=[];p.forEach(y.DataProvider,function(a){e.push(a.resetToDefault())});return Promise.all(e).then(function(){N()})};t.getDataProvider=function(e){return y.DataProvider[e]};t.clearMessages=function(e){y.Messages=[];return e?t.checkUpdate():t};t.propagateVariableGroupValues=function(e){var a=[];var r=y.DataProvider[e];p.forEach(y.VariableGroups,function(a){var t=h[a.Name];p.forEach(t,function(t){if(t.DataProviderName===e&&!p.isEqual(a.MergedVariable.MemberFilter,t.MemberFilter)){r.setVariableValueDirect(t.Name,a.MergedVariable.MemberFilter,true)}})});return Promise.all(a)};t.getProperty=function(e,a){return S(e,a)};t.setProperty=function(a,r){var n=false;var i=p.filter(a.split("/"),p.identity);try{var o=i.pop();var s=i.join(".");var c=p.get(y,s);if(o!=="vizProperties"||r){if(c){c[o]=r}else{e.warning("Failed to set "+r+" on: "+a)}}t.checkUpdate();n=true}catch(a){e.error(a)}return n};t.setSemanticStyles=function(e){y.SemanticStyles=p.clone(e)};t.getSemanticStyles=function(){return y.SemanticStyles};t.addMessages=function(e){y.Messages=p.map(p.groupBy(p.concat(y.Messages,e),"Text"),function(e){return e[0]});return t.checkUpdate()};t.bindProperty=function(e,a,r){var n=new d(t,e,a,r);P[n.getId()]=n;return n};t.bindList=function(e,a,r,n,i){if(e.match(/^(\/)?dataProvider\/(.)*\/Grid\/renderGrid/)){return new u(t,e,a,r,n,i)}else{return new c(t,e,a,r,n,i)}};function S(e,a){var t=a instanceof r?S(a.getPath()):y;if(e){var n=e.replace(g,".");if(n.startsWith(".")){n=n.replace(".","")}return p.get(t,n)}else{return t}}t.isList=function(e,a){return Array.isArray(S(t.resolve(e,a)))};t.checkUpdate=function(e){p.forEach(P,function(a,r){if(a){a.checkUpdate(e)}else{delete P[r]}},false);return t};t.checkMessages=function(){p.forEach(P,function(e){return e.checkDataState?e.checkDataState():null})};t.addBinding=function(e){P[e.getId()]=e;return t};t.removeBinding=function(e){delete P[e.getId()]};var M;function b(e,a){return D.then(function(){if(M){return M}if(e){return null}var r=m.QDataSource.create();r.setDataArea(a||"MY_DATA_AREA");var n=m.OlapApiModule.SERVICE_TYPE_PLANNING.createServiceConfig(t.getApplication());n.setDataSource(r);n.setSystemName(e||o.masterSystem);return i.syncActionToPromise(n.processServiceCreation,n,[]).then(function(e){M=e.getData();return M})})}t.getPlanningService=function(){return M};var V=D.then(function(){if(o&&o.SemanticStyles){t.setSemanticStyles(o.SemanticStyles)}var e=[];p.forEach(o.DataProvider||[],function(a,r){var n=t.addDataProvider(r,a.dataSourceName,a.systemName,a.packageName,a.schemaName,a.dataSourceType);e.push(a.synchronize?n.then(function(){return t.getDataProvider(r).synchronize()}):n)});return Promise.all(e)});t.dataLoaded=p.constant(V);t.loaded=t.dataLoaded;t.metadataLoaded=t.dataLoaded;t.annotationsLoaded=t.dataLoaded;t.getMetaModel=p.constant(t);t.attachMetadataFailed=p.constant(null);t.fireMetadataFailed=p.constant(null);t.getODataEntityContainer=p.constant(null);t.getODataEntityType=p.constant(t);t.createBindingContext=p.constant(null);t.getODataEntitySet=p.constant(t);t.attachRequestCompleted(function(e){var a=e.mParameters?e.mParameters.infoObject:undefined;var r=y.DataProvider[a];if(r){r.callUpdateDimensionData();t.checkUpdate()}});function N(e){if(!e){p.forEach(y.VariableGroups,function(e){N(e.Name)})}else{h[e]=[];p.forEach(y.DataProvider,function(r){if(r){p.forEach(r.Variables,function(t){var n=y.VariableGroups[e];if(n){a(n,t,r.Name)}else{console.error("Group "+e+" not found")}})}})}function a(e,a,r){if(e.Rule(a,r)){if(e.MergedVariable&&e.MergedVariable.DataProviderName!==r){if(e.MergedVariable.type!==a.type){throw new Error("Could not add variable '"+a.Name+"' for DataProvider='"+r+"'."+" The type="+a.type+" doesn't match type="+e.MergedVariable.type+" of previously added variables ")}}else{e.MergedVariable=a}y.DataProvider[r].invalidate();h[e.Name].push(a)}}}},getStylingProvider:function(){return this.stylingProvider}});return y});
//# sourceMappingURL=MultiDimModel.js.map