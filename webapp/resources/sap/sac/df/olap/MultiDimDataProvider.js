/*!
 * SAPUI5
    (c) Copyright 2009-2021 SAP SE. All rights reserved
  
 */
sap.ui.define("sap/sac/df/olap/MultiDimDataProvider",["sap/base/Log","sap/ui/core/format/DateFormat","sap/sac/df/types/Axis","sap/sac/df/types/DimensionType","sap/sac/df/types/DisplayType","sap/sac/df/types/ComparisonOperator","sap/sac/df/utils/SyncActionHelper","sap/sac/df/utils/ListHelper","sap/sac/df/utils/TokenHelper","sap/sac/df/utils/ResourceBundle","sap/sac/df/thirdparty/lodash","sap/sac/df/firefly/library","sap/sac/df/olap/Capability"],function(e,t,r,n,i,a,o,s,u,l,g,c,m){"use strict";var f=function(n,a,u,f){this.MEASURE_DIM="MeasureStructure";this.STRUCTURE_DIM="NonMeasureStructure";var d=this;var D;var y=u.getQueryModel();var v;d.OffsetCol=0;d.Messages=[];d.Name=f;d.OffsetRow=0;d.SuppressRepetition=true;d.Variables={};var N={};var S=function(e){if(e&&e.getMessages().length){n.addMessages(F(e))}};y.registerChangedListener({onModelComponentChanged:function(e,t){t.callUpdateDimensionData();n.checkUpdate()},isReleased:function(){return false}},this);u.attachBeforeQueryExecutionListener({onBeforeQueryExecuted:function(){n.propagateVariableGroupValues(d.Name);if(u.isReinitNeeded()&&d.variableChanged){u.setVariableProcessorState(c.VariableProcessorState.PROCESSING_AUTO_SUBMIT);d.variableChanged=false}},isEqualTo:c.XObject.prototype.isEqualTo});u.attachQueryExecutedListener({onQueryExecuted:function(e){d.Grid={};S(e);if(e.hasErrors()){n.checkUpdate();n.fireRequestFailed({})}else{x()}d._processVisualization()},isEqualTo:function(e){return this===e}},"UI5GridViz");d.setOffsetCol=function(e){d.virtualOffsetCol=e;return d};d.setOffsetRow=function(e){d.virtualOffsetRow=e;return d};d.getStructureMembers=function(e){var t=y.getDimensionByName(d.Dimensions[e].TechName);var r=t.getDisplayKeyField();var n=g.reduce(d.getFilterOfDim(e),function(e,t){e[t.Low]=true;return e},{});return g.map(s.arrayFromList(t.getAllStructureMembers()),function(e){var i=I(e,t,r);i.isInFilter=!!n[e.getName()];return i})};x();d.openCellDialog=function(e,t,r,n){var i=d.Dimensions[e];if(!i||!i.IsStructure){throw new Error("Dimension is not a structure:"+e)}var a=y.getDimensionByName(i.TechName).getDisplayKeyField();var o=g.find(s.arrayFromList(u.getQueryModel().getDimensionByName(d.Dimensions[e].TechName).getAllStructureMembers()),function(e){var r=e.getFieldValue(a);var n=r?r.getString():e.getName();return n===t});if(!o){throw new Error("Member "+t+" not found in structure: "+e)}var l;if(r){var m=d.Dimensions[r];if(!m||!m.IsStructure){throw new Error("Dimension is not a structure:"+r)}var f=y.getDimensionByName(d.Dimensions[r].TechName).getDisplayKeyField();l=g.find(s.arrayFromList(u.getQueryModel().getDimensionByName(d.Dimensions[r].TechName).getAllStructureMembers()),function(e){var t=e.getFieldValue(f);var r=t?t.getString():e.getName();return r===n});if(!l){throw new Error("Member "+n+" not found in structure: "+r)}}var p;function D(e){p=e}var v=new Promise(D);var N=c.DataCellDialogDragonflyEntryPoint.createEntryPoint(u);N.openDataCellPropertiesDialog({onDataCellOk:function(){var e=p;p=null;return e(true)},onDataCellClose:function(){if(p){p(false)}N.close()}},u,o.getName(),l?l.getName():null);return v};d.openDimDialog=function(e){return new Promise(function(t){var r=c.ProgramRunner.createRunner(a.getProcess(),c.OuDimensionDialog2.DEFAULT_PROGRAM_NAME);r.setObjectArgument(c.DfOuDialogProgram.PARAM_QUERY_MANAGER,u);r.setArgument(c.OuDimensionDialog2.PARAM_DIMENSION_NAME,d.Dimensions[e].TechName);r.setObjectArgument(c.DfOuDialogProgram.PARAM_OK_PROCEDURE,{execute:function(){t(true)}});r.setObjectArgument(c.DfOuDialogProgram.PARAM_CANCEL_PROCEDURE,{execute:function(){t(false)}});return r.runProgram(null)})};d.setResultVisibility=function(e,t){b(function(){y.getDimensionByName(d.Dimensions[e].TechName).setResultVisibility(c.ResultVisibility[t])});return d};d.setDimensionDisplay=function(e,t){b(function(){var r=y.getDimensionByName(d.Dimensions[e].TechName);var n=r.getDisplayKeyField()||r.getKeyField();var a=r.getTextField();var o=r.getResultSetFields();var u=g.filter(s.arrayFromList(o).map(function(e){return e}),function(e){return e!==r.getKeyField()&&e!==r.getTextField()&&e!==r.getDisplayKeyField()});o.clear();switch(t){case i.Key:o.add(n);break;case i.Text:o.add(a);break;case i.KeyText:o.add(n);o.add(a);break;case i.TextKey:o.add(a);o.add(n);break}g.forEach(u,function(e){o.add(e)})});return d};d.isVariableInputEnabled=function(e){var t=N[e];if(!t){return false}var r=y.getVariable(t);return!!r&&r.isInputEnabled&&r.isInputEnabled()};d.hasVariableValueHelp=function(e){var t=y.getVariable(e);return!!t&&t.supportsValueHelp&&t.supportsValueHelp()};function E(e,t,r){if(t!=null&&r!=null){e.addSupplementValue(t.getName(),r)}}function T(e,t,r){t.queueEventing();var n=e.getKeyField();var i=e.getDisplayKeyField()!==n?e.getDisplayKeyField():null;var a=e.getTextField();t.addSupplementField(i);t.addSupplementField(a);for(var o=0;o<r.size();o++){var s=r.get(o);var u=t.addNewCartesianElement();u.setComparisonOperator(c.ComparisonOperator.EQUAL);u.setField(n);var l=u.getLow();l.setValue(c.XValueUtil.getValueFromString(s.getKey(),n.getValueType()));E(l,i,s.getDisplayKey());E(l,a,s.getText())}t.resumeEventing()}function M(e){var t=N[e];if(!t){return false}return y.getVariable(t)}d.applySelectionToVariable=function(e,t){var r=function(e){if(!e){return}b(function(){if(e.getVariableType().isTypeOf(c.VariableType.DIMENSION_MEMBER_VARIABLE)){var r=e.getDimension();var n=e.getMemberFilter();n.clear();T(r,n,t)}else{if(!t.isEmpty()){e.setValueByStringExt(t.get(0).getKey(),true)}}d.variableChanged=true})};return new Promise(function(t,r){var n=M(e);if(!n||!n.isInputEnabled()){r("Variable="+e+" is not input enabled")}t(n)}).then(r)};d.openVariableSelector=function(e,t){var r=M(e);if(!(r&&r.supportsValueHelp&&r.supportsValueHelp())){throw new Error("No Value help for variable "+e)}var n=u.clone();if(n.isReinitNeeded()){n.reInitVariablesAfterSubmit(c.SyncType.BLOCKING,null,null)}var i;function o(e){i=e}var s=c.ProgramRunner.createRunner(a.getProcess(),c.FilterDialog.DEFAULT_PROGRAM_NAME_VARIABLE);s.setObjectArgument(c.DfOuDialogProgram.PARAM_QUERY_MANAGER,n);s.setArgument(c.FilterDialog.PARAM_TITLE,l.getText("SELECTOR",[r.getText()]));s.setArgument(c.FilterDialog.PARAM_VARIABLE_NAME,r.getName());s.setArgument(c.FilterDialog.PARAM_SELECTION_MODE,r.supportsMultipleValues()?c.UiSelectionMode.MULTI_SELECT.getName():c.UiSelectionMode.SINGLE_SELECT_LEFT.getName());s.setBooleanArgument(c.FilterDialog.PARAM_ALWAYS_SHOW_SELECTION_CONTAINER,true);s.setObjectArgument(c.FilterDialog.PARAM_DEFAULT_SELECTION,c.FilterDialogValueFactory.createSelectionFromVariable(r));s.setObjectArgument(c.FilterDialog.PARAM_LISTENER_CLOSE,{onFilterDialogOk:function(e){i(e)},onFilterDialogCancel:function(){i(null)}});s.runProgram();var g=new Promise(o);return g.then(function(e){if(!e){return false}return e}).then(function(r){if(r&&!t){return d.applySelectionToVariable(e,r).then(function(){R();return r})}return r}).finally(function(){c.XObjectExt.release(n)})};d.openCurrencyTranslationDialog=function(){return new Promise(function(e){var t=c.ProgramRunner.createRunner(a.getProcess(),c.OuCurrencyConversionDialog.DEFAULT_PROGRAM_NAME);t.setObjectArgument(c.DfOuDialogProgram.PARAM_QUERY_MANAGER,u);t.setObjectArgument(c.DfOuDialogProgram.PARAM_OK_PROCEDURE,{execute:function(){e(true)}});t.setObjectArgument(c.DfOuDialogProgram.PARAM_CANCEL_PROCEDURE,{execute:function(){e(false)}});return t.runProgram(null)})};d.getFilterOfDim=function(e){var t=y.getDimensionByName(d.Dimensions[e].TechName);function r(e){var r=t.getKeyField();var n=t.getDisplayKeyField()!==r?t.getDisplayKeyField():null;var i=t.getTextField();var a=e.getLow();var o=null;if(n!=null){o=a.getSupplementValueString(n.getName())}if(!o&&i){o=a.getSupplementValueString(i.getName())}return o}return g.map(s.arrayFromList(y.getFilter().getDynamicFilter().getCartesianListByField(t.getKeyField())),function(e){return{ComparisonOperator:p(e.getComparisonOperator()),Text:r(e),Low:e.getLow().getString(),High:e.getHigh().getString(),IsExcluding:e.getSetSign()===c.SetSign.EXCLUDING}})};d.openSelector=function(e){var t=y.getDimensionByName(d.Dimensions[e].TechName);if(!y.getFilter().getDynamicFilter().isCartesianProduct()){throw new Error("Filter to complex")}var r;function n(e){r=e}return Promise.resolve(null).then(function(){var e=c.ProgramRunner.createRunner(a.getProcess(),c.FilterDialog.DEFAULT_PROGRAM_NAME_DIMENSION);e.setObjectArgument(c.DfOuDialogProgram.PARAM_QUERY_MANAGER,y.getQueryManager());e.setArgument(c.FilterDialog.PARAM_TITLE,l.getText("SELECTOR",[t.getText()]));e.setArgument(c.FilterDialog.PARAM_DIMENSION_NAME,t.getName());e.setArgument(c.FilterDialog.PARAM_SELECTION_MODE,c.UiSelectionMode.MULTI_SELECT.getName());e.setObjectArgument(c.FilterDialog.PARAM_DEFAULT_SELECTION,c.FilterDialogValueFactory.createSelectionFromFilter(t,t.getFilter()));e.setObjectArgument(c.FilterDialog.PARAM_LISTENER_CLOSE,{onFilterDialogOk:function(e){r(e)},onFilterDialogCancel:function(){r(false)}});e.runProgram();var i=new Promise(n);return i.then(function(e){if(!e){return false}b(function(){var r=t.getQueryModel().getFilter().getDynamicFilter();r.stopEventing();var n=t.getFilter();if(n!=null){n.clear()}else{n=r.getCartesianListWithDefault(t)}T(t,n,e);r.resumeEventing()});return true})})};d.setAxesLayout=function(e){b(function(){g.forEach(g.map(d.Dimensions,"Name"),function(e){y.getAxis(c.AxisType.FREE).add(y.getDimensionByName(d.Dimensions[e].TechName))});g.forEach(e.rows,function(e){h(c.AxisType.ROWS,e,false)});g.forEach(e.columns,function(e){h(c.AxisType.COLUMNS,e,false)})});return d};d.removeDrilldown=function(e){b(function(){y.getAxis(c.AxisType.FREE).add(y.getDimensionByName(d.Dimensions[e].TechName))});return d};d.drilldown=function(e,t){b(function(){if(e){var r=y.getDimensionByName(d.Dimensions[e].TechName);var n=y.getAxesManager().getRowsAxis().getDimensionCount()?r.getAxis():y.getAxesManager().getRowsAxis();var i=!n.getDimensionCount()?0:r.getDimension().getAxis().getDimensionIndex(r.getName())+1;n.insert(i,y.getDimensionByName(d.Dimensions[t].TechName))}else{y.getAxesManager().getRowsAxis().insert(y.getAxesManager().getRowsAxis().getDimensionCount(),y.getDimensionByName(d.Dimensions[t].TechName))}});return d};d.moveUp=function(e){b(function(){var t=y.getDimensionByName(d.Dimensions[e].TechName);var r=t.getAxis();var n=r.getDimensionIndex(t.getName())-1;r.insert(n,t)});return d};d.moveDown=function(e){b(function(){var t=y.getDimensionByName(d.Dimensions[e].TechName);var r=t.getAxis();var n=r.getDimensionIndex(t.getName())+1;r.insert(n,t)});return d};d.setDisplayHierarchy=function(e,t,r,n){b(function(){var i=y.getDimensionByName(d.Dimensions[e].TechName);if(r){i.setHierarchyName(r);if(n){i.setHierarchyVersion(n)}}i.setHierarchyActive(t)});return d};d.getScalingFactor=function(e,t){var r=d.Dimensions.MeasureStructure;if(!r){throw new Error("No measure Structure")}var n=t?d.Dimensions.NonMeasureStructure:null;var i=r.TechName;var a=s.arrayFromList(y.getDimensionByName(i).getAllStructureMembers());var o=y.getDimensionByName(i).getDisplayKeyField();var l=function(){var t=g.find(a,function(t){var r=t.getFieldValue(o);var n=r?r.getString():t.getName();return n===e});if(!t){throw new Error("Member "+e+" not found in structure: "+i)}return t}();if(!n){return l.getNumericShift()?-1*l.getNumericShift().getInteger():0}else{var c=n.TechName;var m=s.arrayFromList(y.getDimensionByName(c).getAllStructureMembers());var f=y.getDimensionByName(c).getDisplayKeyField();var p=function(){var r=g.find(m,function(e){var r=e.getFieldValue(f);var n=r?r.getString():e.getName();return n===t});if(!r){throw new Error("Member "+e+" not found in structure: "+i)}return r}();var D=s.arrayFromIter(u.getQueryModel().getQueryDataCells().getIterator());var v=g.find(D,function(e){return e.hasMemberReference(l)&&e.hasMemberReference(p)});if(!v){throw new Error("Invalid Query Cell")}return v.getScalingFactor()}};d.setScalingFactor=function(e,t,r){b(function(){var n=d.Dimensions.MeasureStructure;if(!n){throw new Error("No measure Structure")}var i=r?d.Dimensions.NonMeasureStructure:null;var a=n.TechName;var o=s.arrayFromList(y.getDimensionByName(a).getAllStructureMembers());var l=y.getDimensionByName(a).getDisplayKeyField();var c=function(){var e=g.find(o,function(e){var r=e.getFieldValue(l);var n=r?r.getString():e.getName();return n===t});if(!e){throw new Error("Member "+t+" not found in structure: "+a)}return e}();if(!i){c.setNumericShift(-1*e);return d}else{var m=i.TechName;var f=s.arrayFromList(y.getDimensionByName(m).getAllStructureMembers());l=y.getDimensionByName(m).getDisplayKeyField();var p=function(){var e=g.find(f,function(e){var t=e.getFieldValue(l);var n=t?t.getString():e.getName();return n===r});if(!e){throw new Error("Member "+r+" not found in structure: "+m)}return e}();var D=s.arrayFromIter(u.getQueryModel().getQueryDataCells().getIterator());D=g.filter(D,function(e){return e.hasMemberReference(c)&&e.hasMemberReference(p)});if(!D||D.length<1){throw new Error("Invalid Query Cell")}return g.forEach(D,function(t){t.setScalingFactor(e)})}})};d.setDecimalPlaces=function(e,t,r){b(function(){var n=d.Dimensions.MeasureStructure;if(!n){throw new Error("No measure Structure")}var i=r?d.Dimensions.NonMeasureStructure:null;var a=n.TechName;var o=s.arrayFromList(y.getDimensionByName(a).getAllStructureMembers());var l=y.getDimensionByName(a).getDisplayKeyField();var c=function(){var e=g.find(o,function(e){var r=e.getFieldValue(l);var n=r?r.getString():e.getName();return n===t});if(!e){throw new Error("Member "+t+" not found in structure: "+a)}return e}();if(!i){c.setNumericScale(e);return d}else{var m=i.TechName;var f=s.arrayFromList(y.getDimensionByName(m).getAllStructureMembers());l=y.getDimensionByName(m).getDisplayKeyField();var p=function(){var e=g.find(f,function(e){var t=e.getFieldValue(l);var n=t?t.getString():e.getName();return n===r});if(!e){throw new Error("Member "+r+" not found in structure: "+m)}return e}();var D=s.arrayFromIter(u.getQueryModel().getQueryDataCells().getIterator());D=g.filter(D,function(e){return e.hasMemberReference(c)&&e.hasMemberReference(p)});if(!D||D.length<1){throw new Error("Invalid Query Cell")}return g.forEach(D,function(t){t.setDecimalPlaces(e)})}})};d.getDecimalPlaces=function(e,t){var r=d.Dimensions.MeasureStructure;if(!r){throw new Error("No measure Structure")}var n=t?d.Dimensions.NonMeasureStructure:null;var i=r.TechName;var a=s.arrayFromList(y.getDimensionByName(i).getAllStructureMembers());var o=y.getDimensionByName(i).getDisplayKeyField();var l=function(){var t=g.find(a,function(t){var r=t.getFieldValue(o);var n=r?r.getString():t.getName();return n===e});if(!t){throw new Error("Member "+e+" not found in measureDim: "+i)}return t}();if(!n){return l.getNumericScale()}else{var c=n.TechName;var m=s.arrayFromList(y.getDimensionByName(c).getAllStructureMembers());var f=y.getDimensionByName(c).getDisplayKeyField();var p=function(){var e=g.find(m,function(e){var r=e.getFieldValue(f);var n=r?r.getString():e.getName();return n===t});if(!e){throw new Error("Member "+t+" not found in measureDim: "+c)}return e}();var D=s.arrayFromIter(u.getQueryModel().getQueryDataCells().getIterator());var v=g.find(D,function(e){return e.hasMemberReference(l)&&e.hasMemberReference(p)});if(!v){throw new Error("Invalid Query Cell")}return v.getDecimalPlaces()}};d.setFilter=function(e,t){b(function(){var r=d.Dimensions[e];var n=[];if(typeof t==="string"){n.push(t)}else{n=t}c.QFilterUtil.clearSelectionsInContainerByDimension(d.Dimensions[e].TechName,y.getFilter().getDynamicFilter());var i=d.Dimensions[e].TechName;var a=y.getDimensionByName(i);var o=r.IsStructure?s.arrayFromList(a.getAllStructureMembers()):[];var u=r.IsStructure?a.getDisplayKeyField():null;g.forEach(n,function(e){var t=r.IsStructure?function(){var t=g.find(o,function(t){var r=t.getFieldValue(u);var n=r?r.getString():t.getName();return n===e});if(!t){throw new Error("Member "+e+" not found in structure: "+i)}return t.getName()}():e;y.getFilter().getDynamicFilter().addSingleMemberFilterByName(i,t,c.ComparisonOperator.EQUAL)})});return d};d.removeFilter=function(e){b(function(){c.QFilterUtil.clearSelectionsInContainerByDimension(d.Dimensions[e].TechName,y.getFilter().getDynamicFilter())});return d};d.sort=function(e,t,r,n){b(function(){var i=y.getDimensionByName(d.Dimensions[e].TechName);if(d.Dimensions[e].IsStructure){var a=u.getConvenienceCommands();a.clearSort(null,null);a.sortByMeasure(g.find(d.Dimensions[e].Members,function(e){return e.Name===n}).TechName,c.XSortDirection[t])}else{i.getResultSetSorting().setDirection(c.XSortDirection[t]);if(r){i.getResultSetSorting().setSortType(c.SortType[r])}}});return d};function h(e,t,r){var n=function(e){var t=e.getKeyField();var r=e.getDisplayKeyField()||t;var n=e.getTextField()||r;return{oKeyField:t,oDisplayKeyField:r,oTextField:n}};b(function(){var r=y;var i=d.Dimensions[t].TechName;var a=r.getQueryModel().getDimensionByName(i);r.getAxis(e).add(a);var o=n(a);var s=a.getResultSetFields();var u=o.oTextField;if(u&&!s.contains(u)){s.add(u);u.setObtainability(c.ObtainabilityType.USER_INTERFACE)}var l=o.oDisplayKeyField;if(!s.contains(l)){s.add(l);l.setObtainability(c.ObtainabilityType.USER_INTERFACE)}},r,r)}d.toRows=function(e){h(c.AxisType.ROWS,e);return d};d.toColumns=function(e){h(c.AxisType.COLUMNS,e);return d};d.drill=function(e,t){b(function(){var r=y.getDimensionByName(d.Dimensions[e].TechName);var n=v.getAxis(r.getAxisType()).getTupleAt(t).getTupleElementByDimension(r);n.setNextDrillState(n.getDrillState()!==c.DrillState.COLLAPSED?c.DrillState.COLLAPSED:c.DrillState.EXPANDED)});return d};d.submitVariables=function(){return o.syncActionToPromise(u.submitVariables,u,[]).then(function(e){x();if(e&&e.getMessages().length){n.addMessages(s.arrayFromList(e.getMessages()).map(function(e){var t=e.getSeverity().getName();if(t==="Info"){t="Information"}return{Text:e.getText(),Severity:t,Code:e.getCode(),MessageClass:e.getMessageClass(),LongTextUri:e.getMessageClass()?["/sap/opu/odata/iwbep/message_text;o=LOCAL/T100_longtexts(MSGID='",encodeURIComponent(e.getMessageClass()),"',MSGNO='",encodeURIComponent(e.getCode()),",',MESSAGE_V1='',MESSAGE_V2='',MESSAGE_V3='',MESSAGE_V4='')/$value"].join(""):null}}))}}).catch(function(e){n.addMessages(e.getMessages?e.getMessages():[]);if(!e.getMessages){throw e}d.Grid=null})};d.getResultSet=function(e){if(u.getResultSetSyncState()===c.SyncState.IN_SYNC_WITH_ERROR){u.getResultsetContainer(true)}if(!e){d.setOffsetCol(0);d.setOffsetRow(0)}if(u.hasChangedCells()){u.transferNewValues()}u.setOffsetColumns(d.virtualOffsetCol);u.setOffsetRows(d.virtualOffsetRow);u.setMaxRows(n.getLimit().RowLimit);u.setMaxColumns(n.getLimit().ColLimit);return new Promise(function(e){var t=y.getVisualizationManager().getOrCreateVisualisationDefinition(d.Name,c.ProtocolBindingType.SAC_TABLE_GRID,c.SemanticBindingType.TABLE);var r={onVisualizationObjectFilled:function(){t.detachVisualizationDataProvidedListener(r);e()},isEqualTo:function(e){return e===r}};t.attachVisualizationDataProvidedListener(r);n.fireRequestSent({infoObject:d.Name});u.processQueryExecution(c.SyncType.NON_BLOCKING)}).catch(function(e){if(!e.getMessages){throw e}n.fireRequestFailed({infoObject:d.Name})})};d.getRRITargets=function(e,t){var r=u.getRriTargetManager();if(!r){return Promise.resolve([])}r.setResultSetContext(e,t);var n,i;function a(e,t){n=e;i=t}r.processRriTargetResolution(c.SyncType.NON_BLOCKING,{onRriTargetResolution:function(e){if(e.hasErrors()){i(e.getMessages())}else{var t=sap.ushell?sap.ushell.Container.getService("URLParsing"):{isIntentUrl:g.constant(false)};n(g.filter(e.getData().getListFromImplementation().map(function(e){return e.getParameters().getMapFromImplementation()}),function(e){return t.isIntentUrl(e.URL)||!!e.URL.match(/#/)}).map(function(e){e.URL=e.URL.split("#")[1];return e}))}}});return new Promise(a)};d.synchronize=function(e){n.clearMessages();return d.getResultSet(e)};d.readHierarchy=function(e,t){var r=u.getValueHelpProvider();var n=y.getDimensionByName(d.Dimensions[e].TechName);var i=n.getInitialDrillLevel();n.setSelectorInitialDrillLevel(t);var a=new Promise(function(e,t){r.processValueHelp(n,c.SyncType.NON_BLOCKING,{onValuehelpExecuted:function(r){return r.hasErrors()?t(o.reject(r.getErrors())):e(r.getData())}},null,null)});return a.then(function(e){function t(e){if(!e){return{}}var r=e.getChildren();return{Name:e.getName(),Text:e.getDimensionMember().getText()||e.getDimensionMember(e.getDimension().getHierarchyDisplayKeyField()).getValue().getString(),hierNodes:r?g.map(r.getListFromImplementation(),t):null}}n.setSelectorInitialDrillLevel(i);var r=g.filter(e.getListFromImplementation(),function(e){return!e.getParentNode()});return r.length===1?t(r[0]):{Name:"$Root",Text:l.getText("ARTIFICIAL_ROOT"),hierNodes:g.map(r,t)}})};function C(){if(D){return D}D=new Promise(function(e,t){u.reInitVariablesAfterSubmit(c.SyncType.NON_BLOCKING,{onVariableProcessorExecuted:function(r){return r.hasErrors()?t(o.reject(r.getErrors())):e()}})});return D.then(function(){D=null})}d.setVariableValueDirect=function(e,t,r){var n=M(e);if(!n&&!n.isInputEnabled()){throw new Error("Variable is not input enabled")}y.stopEventing();b(function(){d.variableChanged=true;n.clear();if(t){var e=n.getMemberFilter?n.getMemberFilter():null;g.forEach(t,function(t){if(e){var r=e.addNewCartesianElement();var i=c.XValueAccess.createWithType(n.getValueType());i.parseString(t.Low);r.getLow().setValue(i.getValue());if(t.High){i=c.XValueAccess.createWithType(n.getValueType());i.parseString(t.High);r.getHigh().setValue(i.getValue())}r.setComparisonOperator(c.ComparisonOperator[t.Comparison]);var a=c.SetSign[t.IsExcluding]||c.SetSign[t.IsExcluding?"EXCLUDING":"INCLUDING"];r.setSetSign(a);var o=n.getDimension().getFirstFieldByType(c.PresentationType.KEY_NOT_COMPOUND);o=o||n.getDimension().getKeyField(c.PresentationType.KEY);if(o){r.setField(o)}}else{n.setValueByStringExt(t.Low,true)}},false,true)}y.resumeEventing();d.invalidate();R()},false,r)};d.setVariableValue=function(e,t){return new Promise(function(r){d.setVariableValueDirect(e,t);r()})};function A(e,t,r){var n=e.getDimensionMember();var i={Key:n.getName(),Text:n.getText()};if(t){var a=e.getChildren();if(a&&a.hasElements()){var o=s.arrayFromList(a).map(function(e){return A(e,t,r)}).filter(function(e){return e!==null});if(o.length!==0){i.Children=o}}}if(r&&!i.Children){if(i.Key!==r&&i.Text!==r){return null}}return i}d.searchVariableValues=function(e,t,r,n,i){if(n===undefined){n=true}if(i===undefined){i=true}var a=M(e);if(!a){return Promise.reject(new Error("Variable "+e+" is not known"))}var o=c.XList.create();var s=c.XList.create();var u=a.getDimension();var l=u.getTextField();if(l){s.add(l);if(n){o.add(l)}}if(u.getDisplayKeyField()&&i){o.add(u.getDisplayKeyField())}return C().then(function(){return new Promise(function(e,n){c.OlapUiValueHelpVariable.create(a).processSearch(t,o,s,20,true,c.OlapUiReadMode.BOOKED,{onValuehelpExecuted:function(i){if(i.hasErrors()){n(F(i))}else{var o=a.getVariableType();var s=o!=null&&o.isTypeOf(c.VariableType.HIERARCHY_NODE_VARIABLE)?a.getHierarchyName():null;var u=i.getData().getIterator();var l=[];while(u.hasNext()){var g=u.next();if(!s||g.getDisplayLevel()===0){var m=A(g,s,!r?t:null);if(m){l.push(m)}}}e(l)}}})})})};function F(e){return s.arrayFromList(e.getMessages()).map(function(e){var t=e.getSeverity().getName();if(t==="Info"){t="Information"}return{Text:e.getText(),Severity:t,Code:e.getCode(),MessageClass:e.getMessageClass(),LongTextUri:e.getMessageClass()?["/sap/opu/odata/iwbep/message_text;o=LOCAL/T100_longtexts(MSGID='",encodeURIComponent(e.getMessageClass()),"',MSGNO='",encodeURIComponent(e.getCode()),",',MESSAGE_V1='',MESSAGE_V2='',MESSAGE_V3='',MESSAGE_V4='')/$value"].join(""):null}})}d.getCellContext=function(e,t){var r=c.Ui5GridCellContextProvider.create(u);var i=c.RsCellIndexInfo.create();i.initialize(e,t);return o.syncActionToPromise(r.getCellContext,r,i).then(function(e){var t=e?e.convertToNative():null;return Promise.resolve(t)}).catch(function(e){n.addMessages(e.getMessages?e.getMessages():[]);return Promise.reject(e)})};d.createDocumentId=function(e,t){var r=u.getResultsetContainer().getDocumentIdManager();var i=c.RsCellIndexInfo.create();i.initialize(e,t);return o.syncActionToPromise(r.createCellDocumentId,r,i).then(function(e){S(e);return e.getData().getCellDocumentId()}).catch(function(e){n.addMessages(e.getMessages?e.getMessages():[]);return Promise.reject(e)})};d.getDocumentId=function(e,t){var r=u.getResultsetContainer().getDocumentIdManager();var i=c.RsCellIndexInfo.create();i.initialize(e,t);return o.syncActionToPromise(r.getCellDocumentId,r,i).then(function(e){S(e);return e.getData().getCellDocumentId()}).catch(function(e){n.addMessages(e.getMessages?e.getMessages():[]);return Promise.reject(e)})};d.deleteDocumentId=function(e,t){var r=u.getResultsetContainer().getDocumentIdManager();var i=c.RsCellIndexInfo.create();i.initialize(e,t);return o.syncActionToPromise(r.deleteCellDocumentId,r,i).then(function(e){S(e);return e.getData().isCellDocumentIdDeleted()}).catch(function(e){n.addMessages(e.getMessages?e.getMessages():[]);return Promise.reject(e)})};d._extractProperties=function(e){if(e){var t=e.getContent();var r=e.getTimeStamp();return{version:e.getVersion(),owner:e.getOwner(),timestamp:r?r.toString():null,content:t?t.getStringContentExt():null}}return null};d.createDocument=function(e,t){if(!e){throw new Error("Cannot create document without document ID")}try{return d.updateDocument(e,t)}catch(e){return Promise.reject(e)}};d.retrieveDocument=function(e,t){if(!e){throw new Error("Cannot retrieve document without document ID")}var r=d.getQueryManager().getQueryModel().getDocumentsInfo();if(r){var i=r.getSupportsDocuments();if(i&&i.getName()!=="None"){var a=r.getOrCreateDocumentsStoreService(false);a.addToFetchList(e);return o.syncActionToPromise(a.performRequests,a,[null,null]).then(function(){var r=[];if(!t){var n=a.getDocumentVersionsForFile(e);if(n){n.forEach(function(e){var t=d._extractProperties(e);if(t){r.push(t)}})}}else{var i=a.getDocumentVersionForFileAndVersion(e,t);var o=d._extractProperties(i);if(o){r.push(o)}}return Promise.resolve({documentId:e,versions:r})}).catch(function(e){n.addMessages(e.getMessages?e.getMessages():[]);return Promise.reject(e)})}else{throw new Error("No document support. Unable to retrieve document.")}}};d.retrieveMultipleDocuments=function(e){if(!e){throw new Error("Cannot retrieve documents without document IDs array")}else if(!Array.isArray(e)){e=[e]}var t=d.getQueryManager().getQueryModel().getDocumentsInfo();if(t){var r=t.getSupportsDocuments();if(r&&r.getName()!=="None"){var i=t.getOrCreateDocumentsStoreService(false);e.forEach(function(e){i.addToFetchList(e)});return o.syncActionToPromise(i.performRequests,i,[null,null]).then(function(){var t=[];e.forEach(function(e){var r=[];var n=i.getDocumentVersionsForFile(e);if(n){n.forEach(function(e){var t=d._extractProperties(e);if(t){r.push(t)}})}t.push({documentId:e,versions:r})});return Promise.resolve(t)}).catch(function(e){n.addMessages(e.getMessages?e.getMessages():[]);return Promise.reject(e)})}else{throw new Error("No document support. Unable to retrieve documents.")}}};d.updateDocument=function(e,t){if(!e){throw new Error("Cannot update document without document ID")}var r=d.getQueryManager().getQueryModel().getDocumentsInfo();if(r){var i=r.getSupportsDocuments();if(i&&i.getName()==="ReadWrite"){var a=r.getOrCreateDocumentsStoreService(false);a.addToPutList(e,c.XContent.createStringContent(c.ContentType.TEXT_PLAIN,t));a.addToFetchList(e);return o.syncActionToPromise(a.performRequests,a,[null,null]).then(function(){var r=a.getContentForFile(e);return Promise.resolve(r?r.getStringContentExt()===t:r===t)}).catch(function(e){n.addMessages(e.getMessages?e.getMessages():[]);return Promise.reject(e)})}else{throw new Error("No 'ReadWrite' document support. Unable to update document.")}}};d.deleteDocument=function(e){if(!e){throw new Error("Cannot delete document without document ID")}var t=d.getQueryManager().getQueryModel().getDocumentsInfo();if(t){var r=t.getSupportsDocuments();if(r&&r.getName()==="ReadWrite"){var i=t.getOrCreateDocumentsStoreService(false);i.addToDeleteList(e);return o.syncActionToPromise(i.performRequests,i,[null,null]).then(function(){i.evictAllDocuments();return Promise.resolve(true)}).catch(function(e){n.addMessages(e.getMessages?e.getMessages():[]);return Promise.reject(e)})}else{throw new Error("No 'ReadWrite' document support. Unable to delete document.")}}};d.supportsCapability=function(e){if(e===m.SupportsDocuments){var t=d.getQueryManager().getQueryModel().getDocumentsInfo();return!!t&&t.getSupportsDocuments()!==c.DocumentsSupportType.NONE}throw new Error("Unhandled capability : "+e)};d.getDocumentsSupportType=function(){var e=d.getQueryManager().getModelCapabilities().supportsCellDocumentId();if(e){var t=d.getQueryManager().getQueryModel().getDocumentsInfo();if(t){var r=t.getSupportsDocuments();if(r){return r.getName()}}}return c.DocumentsSupportType.NONE.getName()};d.deserialize=function(e){return Promise.resolve().then(function(){d.variableChanged=true;b(function(){y.deserializeExt(c.QModelFormat.INA_REPOSITORY,e)},true)})};d.serialize=function(){return y.serializeToContentExt(c.QModelFormat.INA_REPOSITORY,null).getString()};d.getResultRequest=function(){return u.getResultsetContainer().getResultSetManager().getDataRequest().convertToNative()};d.getQueryView=function(){return y.serializeToElement(c.QModelFormat.INA_DATA).convertToNative()};d.getQueryManager=function(){return u};d.callUpdateDimensionData=function(){O()};d.addCondition=function(e){return Promise.resolve(null).then(function(){var t=["COND_",Date.now()].join("");var r=y.getConditionManager().addNewCondition(t);r.setDescription(e.Description);r.setText(e.Description);var n=y.getDimensionByName(d.Dimensions[e.Structure1Key].TechName);var i=g.find(d.Dimensions[e.Structure1Key].Members,function(t){return e.measure1===t.Name}).TechName;if(!i){throw new Error("Invalid measure")}r.setDimensionEvaluationType(c.ConditionDimensionEvaluationType.ALL_IN_DRILL_DOWN);var a=r.createThreshold();var o=n.getStructureMember(i);if(!o){throw new Error("Invalid measure")}a.addMeasureCoordinate(o);a.setComparisonOperator(c.ConditionComparisonOperator[e.operator]);a.getLow().setString(e.Value);return d})};d.resetToDefault=function(){return Promise.resolve().then(function(){d.variableChanged=true;b(function(){u.getConvenienceCommands().resetToDefault()},true)})};d.logoff=function(){return new Promise(function(e){u.processShutdown(c.SyncType.NON_BLOCKING,{onQueryManagerRelease:function(t,r){c.XObjectExt.release(r);e()}})})};d.invalidate=function(){u.invalidateState()};d.isValid=function(){var e=u.getResultSetSyncState();return e!==c.SyncState.OUT_OF_SYNC&&e!==c.SyncState.IN_SYNC_WITH_ERROR};d.exportData=function(e){return new Promise(function(t,r){var n=y.getVisualizationManager().getOrCreateVisualisationDefinition(d.Name,c.ProtocolBindingType.SAC_TABLE_GRID,c.SemanticBindingType.TABLE);e.addMissingOverwriteTexts(n.getApplicationSettings());var i=c.DataExportHelper.create(this.getQueryManager(),n,r,t);if(e.getDisplayDialog()){i.showExportDialog(e.getType(),e.getFileName(),t)}else{var a=e.getFireflyConfig();i.exportData(a)}}.bind(this))};function R(){var e=g.map(s.arrayFromList(y.getVariables()),P).filter(function(e){return e.InputEnabled});d.Variables=g.reduce(e,function(e,t){e[t.Name]=t;return e},d.Variables);N=g.reduce(s.arrayFromIter(y.getVariables().getIterator()),function(e,t){e[t.getNameExternal()||t.getName()]=t.getName();return e},N)}function I(e,t,r){return{Key:e.getFieldValue(t.getKeyField()).getValue().getString(),Name:e.getFieldValue(t.getDisplayKeyField())?e.getFieldValue(r).getValue().getString():e.getName(),TechName:e.getName(),Description:e.getText(),SemanticObject:e.getSemanticObject()}}function O(){y.stopEventing();function e(e){var t=y.getSortingManager();if(t.supportsDimensionSorting(e,null)&&e.hasSorting()){return e.getResultSetSorting().getDirection().getName()}else{return null}}function t(e){var t=c.XValueType.STRING;var r=e.getFlatKeyField();if(r&&(r.getValueType().isNumber()||c.QFilterUtil.supportsDateRangeFilter(r))){t=r.getValueType()}return t.getName()}d.Dimensions=g.reduce(s.arrayFromList(y.getDimensions()),function(r,n){var i=n.getAxisType();if(i!=c.AxisType.COLUMNS&&i!=c.AxisType.ROWS&&i!=c.AxisType.FREE){return r}var a=n.getAxis();var o=n.isMeasureStructure();var u=n.isStructure();if(o){n.getExternalName=g.constant(d.MEASURE_DIM)}else if(u&&!o){n.getExternalName=g.constant(d.STRUCTURE_DIM)}if(!n.getExternalName()||n.getExternalName().trim()===""){n.getExternalName=n.getName}var l=!!n.getFilter();var m=l?V(n.getFilter()):[];r[n.getExternalName()]={Name:n.getExternalName(),TechName:n.getName(),Description:n.getText(),Axis:a.getName(),Type:n.getDimensionType().getName(),HierarchyActive:n.isHierarchyActive(),HasFilter:l,MemberFilter:m,SortDirection:e(n),Position:a.getDimensionIndex(n.getName()),LastPosition:a.getDimensionCount()-1,IsStructure:u,IsMeasureStructure:o,ValueType:t(n),SemanticObject:n.getSemanticObject()};if(u){var f=n.getDisplayKeyField();r[n.getExternalName()].Members=g.map(s.arrayFromList(n.getAllStructureMembers()),function(e){return I(e,n,f)})}return r},{});d.FreeAxis={};d.FreeAxis.Dimensions=g.sortBy(g.filter(d.Dimensions,{Axis:r.Free}),"Description");d.ColumnsAxis={};d.ColumnsAxis.Dimensions=g.sortBy(g.filter(d.Dimensions,{Axis:r.Columns}),"Position");d.RowsAxis={};d.RowsAxis.Dimensions=g.sortBy(g.filter(d.Dimensions,{Axis:r.Rows}),"Position");d.UsedDimensions=g.filter(g.concat(d.RowsAxis.Dimensions,d.ColumnsAxis.Dimensions),function(e){return!e.IsMeasureStructure});y.resumeEventing()}d._processVisualization=function(){var t=y.getVisualizationManager().getOrCreateVisualisationDefinition(d.Name,c.ProtocolBindingType.SAC_TABLE_GRID,c.SemanticBindingType.TABLE);var r=t.getActiveTableContainer();if(r!=null){r.processExecution(c.SyncType.NON_BLOCKING,{onVisualizationObjectFilled:function(e,t){if(e.isValid()){i(t)}else{S(e)}}})}else{n.fireRequestCompleted({infoObject:d.Name})}function i(t){var r=t.getVisualizationData();try{var i=c.Ui5GridExport.create(r,t)._export();d.Grid=i.convertToNative();n.checkUpdate()}catch(t){e.error("Grid Update failed",t)}n.fireRequestCompleted({infoObject:d.Name})}};function b(e,t,r){e();if(t){x()}else{O()}if(!r){u.invalidateState();u.getResultsetContainer(true);n.fireDataProviderUpdated({dataProviderName:d.Name})}}function x(){w();R();d.HasVariables=y.getVariableContainer().hasVariables();O();y.stopEventing();var e=y.getMeasureDimension();var t=e?e.getExternalName():null;var r=e?d.Dimensions[t]:null;var n=e&&r.Members||[];d.Measures=n;d.Conditions=g.map(y.getConditionManager()?s.arrayFromList(u.getQueryModel().getConditionManager()):[],function(e){return{Name:e.getName(),Description:e.getText(),StatusText:l.getText(e.isActive()?"ACTIVE":"INACTIVE"),active:e.isActive()}});d.Exceptions=g.map(u.getQueryModel().getExceptionManager()?s.arrayFromList(u.getQueryModel().getExceptionManager()):[],function(e){return{Name:e.getName(),Description:e.getText(),StatusText:l.getText(e.isActive()?"ACTIVE":"INACTIVE"),active:e.isActive()}});y.resumeEventing()}function w(){var e={};d.QueryInfo=e;e.QueryTitle=y.getText()||y.getDataSource().getName();e.QueryName=y.getDataSource().getName();e.QueryType=y.getDataSource().getType().getName();e.SystemName=u.getSystemDescription().getName();if(y.getCubeInfo()){e.CreatedBy=y.getCubeInfo().getCreatedBy();e.CreatedOn=function(){var e=y.getCubeInfo().getCreatedOn();return e?new Date([e.getYear(),e.getMonthOfYear(),e.getDayOfMonth()].join("-")):new Date}();e.CreatedOnText=e.QueryDueDateText=t.getDateInstance({style:"medium"}).format(e.CreatedOn);e.QueryDueDate=function(){var e=y.getCubeInfo().getDueDate();return e?new Date([e.getYear(),e.getMonthOfYear(),e.getDayOfMonth()].join("-")):new Date}();e.QueryDueDateText=t.getDateInstance({style:"medium"}).format(e.QueryDueDate);if(y.getResultAlignment()){e.ResultAlignmentRows=y.getResultAlignment().getName();e.ResultAlignmentColumns=y.getResultAlignment().getName()}e.LastUpdated=function(){var e=y.getCubeInfo().getUpdatedOn();return e?new Date([e.getYear(),e.getMonthOfYear(),e.getDayOfMonth()].join("-")):new Date}();e.LastUpdatedBy=y.getCubeInfo().getUpdatedBy();e.LastUpdatedText=t.getDateInstance({style:"medium"}).format(e.LastUpdated)}}function L(e){var t=e.getDimension();var r=function(e,r){var n;if(e&&t){if(t.getTextField()&&r){n=e.getSupplementValueString(t.getTextField().getName())}if(!n&&t.getDisplayKeyField()){n=e.getSupplementValueString(t.getDisplayKeyField().getName())}if(!n){n=e.getString()}}return n};var n=e.getLow();var i=r(n,true);var a=e.getHigh();var o=r(a,true);var s=o?[i,o].join(" - "):i;var u=e.getSetSign()===c.SetSign.EXCLUDING;if(u){s="!( "+s+")"}var l={};if(e.getHierarchyName()){l.name=e.getHierarchyName();l.version=e.getHierarchyVersion();l.dueDate=e.getHierarchyDueDate();l.levelOffset=e.getLevelOffset();l.depth=e.getDepth()}return{Low:n.getString(),LowDisplayKey:r(n,false),LowText:i,High:a.getString(),HighDisplayKey:r(a,false),HighText:o,ComparisonOperator:e.getComparisonOperator().getName(),Text:s,IsExcluding:u,Hierarchy:l}}function V(e){return g.map(s.arrayFromList(e),L)}function P(e){return{Name:e.getNameExternal()||e.getName(),Dimension:e.getDimension&&e.getDimension()&&(e.getDimension().getExternalName()||e.getDimension().getName()),ValueType:e.getValueType().getName(),VariableType:e.getVariableType().getName(),Description:e.getText(),Mandatory:e.isMandatory(),SupportsMultipleValues:e.supportsMultipleValues(),TechName:e.getName(),InputEnabled:e.isInputEnabled(),Position:e.getVariableOrder(),SupportsValueHelp:e.supportsValueHelp&&e.supportsValueHelp(),DataProviderName:f,MemberFilter:e.getMemberFilter?V(e.getMemberFilter()):function(){var t=e.getValueByString();if(!e.getValue()||!t){return[]}return[{Low:t,ComparisionOperator:"EQUAL",Text:t,IsExcluding:false}]}()}}};function p(e){switch(e){case c.ComparisonOperator.EQUAL:return"EQ";case c.ComparisonOperator.LESS_THAN:return"LT";case c.ComparisonOperator.LESS_EQUAL:return"LE";case c.ComparisonOperator.GREATER_THAN:return"GT";case c.ComparisonOperator.GREATER_EQUAL:return"GE";case c.ComparisonOperator.BETWEEN:return"BT";case c.ComparisonOperator.NOT_EQUAL:return"NE";default:throw new Error("Invalid Operator: "+e.getName())}}f.prototype.hasVariable=function(){};f.prototype.setAxesLayout=function(){};f.prototype.openCellDialog=function(){};f.prototype.openAxisDialog=function(){};f.prototype.openCurrencyTranslationDialog=function(){};f.prototype.openDimDialog=function(){};f.prototype.openSelector=function(){};f.prototype.setFilter=function(){};f.prototype.removeFilter=function(){};f.prototype.sort=function(){};f.prototype.toRows=function(){};f.prototype.toColumns=function(){};f.prototype.drill=function(){};f.prototype.submitVariables=function(){};f.prototype.getResultSet=function(){};f.prototype.getRRITargets=function(){};f.prototype.addCondition=function(){};f.prototype.moveUp=function(){};f.prototype.moveDown=function(){};f.prototype.setDisplayHierarchy=function(){};f.prototype.getFilterOfDim=function(){};f.prototype.synchronize=function(){};f.prototype.getScalingFactor=function(){};f.prototype.setScalingFactor=function(){};f.prototype.getDecimalPlaces=function(){};f.prototype.setDecimalPlaces=function(){};f.prototype.getCellContext=function(){};f.prototype.createDocumentId=function(){};f.prototype.getDocumentId=function(){};f.prototype.deleteDocumentId=function(){};f.prototype.createDocument=function(){};f.prototype.retrieveDocument=function(){};f.prototype.retrieveMultipleDocuments=function(){};f.prototype.updateDocument=function(){};f.prototype.deleteDocument=function(){};f.prototype.supportsCapability=function(){};f.prototype.getDocumentsSupportType=function(){};return f});
//# sourceMappingURL=MultiDimDataProvider.js.map