/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["./TotaraUtils","./Command"],function(t,e){"use strict";function i(t){this.getBatchSize=t;this.globalList=new Set;this.waitingList=new Map;this.requestedList=new Set}i.prototype.push=function(t,e){if(this.globalList.has(t)){return false}this.globalList.add(t);this.waitingList.set(t,e);this.requestedList.add(t);return true};i.prototype.setBatchSizeInfo=function(t){this.batchSizeInfo=t};i.prototype.fetchBatch=function(){var t=this.getBatchSize?this.getBatchSize:1;if(typeof this.getBatchSize==="function"){t=this.getBatchSize()}var e=this.batchSizeInfo;var i=e?e.maxBatchStringLength:Number.MAX_SAFE_INTEGER;var s=e?e.separatorLength:0;var a=[];var n=0;var r=this.requestedList.keys();var h=r.next();for(var o=0;o<t&&!h.done;o++,h=r.next()){var c=h.value;n+=c.toString().length+(o==0?0:s);if(n>i){break}this.requestedList.delete(c);a.push(c)}return a};i.prototype.pop=function(t){this.requestedList.delete(t);return this.waitingList.delete(t)};i.prototype.isReady=function(t){return this.globalList.has(t)&&!this.waitingList.has(t)};i.prototype.clear=function(t){this.globalList.clear();this.waitingList.clear();this.requestedList.clear()};i.prototype.isEmpty=function(){return this.requestedList.size===0};i.prototype.isWaiting=function(){return this.waitingList.size>0};i.prototype.isInitialViewCompleted=function(){var t=this.waitingList;for(var e=t.values(),i=e.next();!i.done;i=e.next()){var s=i.value;if(s&&s.isInitial){return false}}return true};function s(t,e){i.call(this,t);this.getMaxBatchDataSize=e;this.priorityMap=new Map;this.sortedList=null}s.prototype=Object.create(i.prototype);s.prototype.constructor=s;s.prototype.push=function(t,e){if(i.prototype.push.call(this,t,e)){this.priorityMap.set(t,{});this.sortedList=null;return true}return false};s.prototype.pop=function(t){this.priorityMap.delete(t);return i.prototype.pop.call(this,t)};s.prototype.clear=function(){i.prototype.clear.call(this);this.priorityMap.clear();this.sortedList=null};s.prototype.setData=function(t,e){var i=this.priorityMap.get(t);if(i!=null){Object.assign(i,e);this.sortedList=null;return true}return false};s.prototype.fetchBatch=function(){var t=this.priorityMap;var e=this.requestedList;var i=this.sortedList;if(i==null){i=this.sortedList=Array.from(e.keys()).sort(function(e,i){return t.get(e).priority-t.get(i).priority})}var s=this.batchSizeInfo;var a=s?s.maxBatchStringLength:Number.MAX_SAFE_INTEGER;var n=this.getMaxBatchDataSize?this.getMaxBatchDataSize():10*1024*1024;var r=1e3;var h=s?s.separatorLength:0;var o=[];var c=0;var p=this.getBatchSize?this.getBatchSize():1;var u=0;var l=0;for(var m=0;m<p&&i.length>0;m++){var g=i[i.length-1];var d=t.get(g);c+=d.dataSize;l+=d.submeshCount;u+=g.toString().length+(m==0?0:h);if(m>0&&(u>a||c>n||l>r)){break}e.delete(g);t.delete(g);i.pop();o.push(g)}return o};var a=function(e,a){this.context=e;this.sceneId=a;this.token=e.token||t.generateToken();var n=e.loader;this.meshes=new i(n.getMeshesBatchSize.bind(n));this.materials=new i(n.getMaterialsBatchSize.bind(n));this.textures=new i;this.geomMeshes=new s(n.getGeomMeshesBatchSize.bind(n),n.getGeomMeshesMaxBatchDataSize.bind(n));this.annotations=new i(n.getAnnotationsBatchSize.bind(n));this.parametric=new i(n.getParametricsBatchSize.bind(n));this.views=new i;this.thumbnails=new i;this.tracks=new i(n.getTracksBatchSize.bind(n));this.sequences=new i(n.getSequencesBatchSize.bind(n));this.highlights=new i};a.prototype.isEmpty=function(){return this.meshes.isEmpty()&&this.annotations.isEmpty()&&this.parametric.isEmpty()&&this.materials.isEmpty()&&this.textures.isEmpty()&&this.geomMeshes.isEmpty()&&this.views.isEmpty()&&this.thumbnails.isEmpty()&&this.tracks.isEmpty()&&this.sequences.isEmpty()&&this.highlights.isEmpty()};a.prototype.isWaitingForContent=function(){return this.meshes.isWaiting()||this.textures.isWaiting()||this.materials.isWaiting()||this.geomMeshes.isWaiting()||this.annotations.isWaiting()||this.parametric.isWaiting()||this.views.isWaiting()||this.thumbnails.isWaiting()||this.tracks.isWaiting()||this.sequences.isWaiting()||this.highlights.isWaiting()};a.prototype.clearContent=function(){this.meshes.clear();this.annotations.clear();this.parametric.clear();this.materials.clear();this.textures.clear();this.geomMeshes.clear();this.views.clear();this.thumbnails.clear();this.tracks.clear();this.sequences.clear();this.highlights.clear()};a.prototype.createGetContentCommand=function(e,i,s){var a={sceneId:this.sceneId,ids:i.map(function(t){return parseInt(t,10)}),token:this.token};return t.createRequestCommand(e,s?Object.assign(a,s):a)};function n(t){var e=t.keys().next();if(e.done){return null}var i=e.value;t.delete(i);return i}a.prototype.generateRequestCommand=function(){var i;var s;var a;var r=null;if(!this.meshes.isEmpty()){s=this.meshes.fetchBatch();var h=s.map(function(t){return t.id?t.id:t});r=this.createGetContentCommand(e.getMesh,h);r.sceneId=this.sceneId;r.meshIds=h}else if(!this.geomMeshes.isEmpty()){s=this.geomMeshes.fetchBatch();r=this.createGetContentCommand(e.getGeomMesh,s);r.sceneId=this.sceneId;r.meshIds=s}else if(!this.annotations.isEmpty()){s=this.annotations.fetchBatch();r={method:e.getAnnotation,parameters:{sceneId:this.sceneId,annotationIds:s}}}else if(!this.parametric.isEmpty()){s=this.parametric.fetchBatch();throw new Error("Command "+e.getParametric+" is not implemented")}else if(!this.materials.isEmpty()){s=this.materials.fetchBatch();r={method:e.getMaterial,parameters:{sceneId:this.sceneId,materialIds:s}}}else if(!this.textures.isEmpty()){i=n(this.textures.requestedList);a=this.textures.waitingList.get(i);r=this.createGetContentCommand(e.getImage,[i]);r.sceneId=this.sceneId;r=Object.assign(r,a)}else if(!this.sequences.isEmpty()){s=this.sequences.fetchBatch();throw new Error("Command "+e.getSequence+" is not implemented")}else if(!this.tracks.isEmpty()){s=this.tracks.fetchBatch();throw new Error("Command "+e.getTrack+" is not implemented")}else if(!this.views.isEmpty()){i=n(this.views.requestedList);r={method:e.getView,parameters:{sceneId:this.sceneId,viewId:i,query:t.configureSceneViewQuery(this.context)}}}else if(!this.highlights.isEmpty()){i=n(this.highlights.requestedList);throw new Error("Command "+e.getHighlightStyle+" is not implemented")}else if(!this.thumbnails.isEmpty()){i=n(this.thumbnails.requestedList);a=this.thumbnails.waitingList.get(i);r=this.createGetContentCommand(e.getImage,[i]);r.sceneId=this.sceneId;r=Object.assign(r,a)}return r};return a});
//# sourceMappingURL=RequestQueue.js.map