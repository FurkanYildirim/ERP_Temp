/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/base/Log","sap/ui/core/Core","sap/ui/base/ManagedObject","../getResourceBundle","../helpers/WorkerScriptLoader","../DownloadManager"],function(e,r,t,a,n,o){"use strict";var s={FinishedTree:a().getText("SCENE_CONTEXT_FINISHED_TREE"),LoadingGeometries:a().getText("SCENE_CONTEXT_LOADING_GEOMETRIES"),LoadingTextures:a().getText("SCENE_CONTEXT_LOADING_TEXTURES"),LoadingModelViews:a().getText("SCENE_CONTEXT_LOADING_MODEL_VIEWS")};var i=t.extend("sap.ui.vk.matai.MataiLoader",{metadata:{library:"sap.ui.vk",events:{contentChangesProgress:{parameters:{source:"any",phase:"string",percent:"float"}},contentLoadingFinished:{parameters:{source:"any",node:"any"}}}}});var u=i.getMetadata().getName();function c(e,r,t){var a=performance.now();var n=e._progress;var o=a-n.lastUpdateTime>=500||r!==n.phase||t>=n.totalCount;n.phase=r;n.count=t;if(o){var s=40+60*(n.totalCount?n.count/n.totalCount:1);e._loader.fireContentChangesProgress({source:e._contentResource&&e._contentResource.getSource(),phase:r,percentage:Math.min(s,100)});n.lastUpdateTime=a}}var d=1;var g=new Map;var l=function(){var r;return function(){return r||(r=new Promise(function(r,t){var o=n.loadScript("sap/ui/vk/matai/MataiLoaderWorker.js",["sap/ui/vk/ve/matai.js"]);var i=0;var d=-1;var l=-2;var f=-3;var E=-4;var v=-5;var p=-6;var R=-7;var _=-8;function T(e){var r=a();switch(e){case d:return r.getText("LOADER_FILENOTFOUND");case l:return r.getText("LOADER_WRONGFILEFORMAT");case f:return r.getText("LOADER_WRONGPASSWORD");case E:return r.getText("LOADER_ERRORREADINGFILE");case v:return r.getText("LOADER_FILECONTENT");case p:return r.getText("LOADER_NODEFAULTVIEW");case R:return r.getText("LOADER_FILECONTENT");case _:return r.getText("LOADER_ERRORREADINGREFERENCEDFILE");default:return r.getText("LOADER_UNKNOWNERROR")}}function m(r,t,a){var n=T(t);r._reject({status:t,errorText:n});e.error(n,a,u);L(r,t)}function L(r,t){e.info("Matai loading finished");r.loadingFinished({result:t});r._loader.fireContentLoadingFinished({source:r._contentResource,node:r._rootNode});r._loader=null;var a=r._id;o.postMessage({method:"destroyContext",args:{sceneBuilderId:a}});g.delete(a)}o.onmessage=function(t){var n=t.data;if(n.event==="runtimeCreated"){r(this);return}if("event"in n){var d=n.sceneBuilderId;var l=g.get(d);var f=l.sceneBuilder;switch(n.event){case"contextCreated":if(n.result===i){o.postMessage({method:"loadFile",args:{sceneBuilderId:d}})}else{m(f,n.result)}break;case"fileLoaded":if(n.result===i){if(l.waitingCount===0){o.postMessage({method:"buildScene",args:{sceneBuilderId:d}})}}else{m(f,n.result)}break;case"referencedFileLoaded":l.waitingCount-=1;if(n.result!==i){e.error(T(n.result),n.fileName,u)}if(l.waitingCount===0){o.postMessage({method:"buildScene",args:{sceneBuilderId:d}})}break;case"referencedFileRequested":var E=l.dependencyLoader;if(E==null){e.error(a().getText("LOADER_NODEPENDENCYLOADER"),null,u)}else{var v=n.fileName;var p=n.veId;var R=n.veVersion;var _=l.files;var O=_.get(v);if(O==null){O=E.load(v);_.set(v,O)}l.waitingCount+=1;O.then(function(e){var r=e.buffer;e.buffer=null;o.postMessage({method:"loadReferencedFile",args:{sceneBuilderId:d,buffer:r,fileName:v,veId:p,veVersion:R}},r==null?[]:[r])},function(){l.waitingCount-=1;e.error(a().getText("LOADER_ERRORREADINGREFERENCEDFILE"),v,u);if(l.waitingCount===0){o.postMessage({method:"buildScene",args:{sceneBuilderId:d}})}})}break;case"sceneBuilt":L(f,n.result);break;default:break}}else{n.forEach(function(r){var t=r.sceneBuilderId;var a=g.get(t);var n=a.sceneBuilder;try{n[r.method].apply(n,r.args)}catch(t){e.error("SceneBuilder."+r.method+"()",t)}switch(r.method){case"setScene":var o=r.args[0];n._progress.totalCount=o.meshCount+o.imageCount+o.modelViewCount;c(n,s.FinishedTree,0);break;case"setGeometry":c(n,s.LoadingGeometries,n._progress.count+1);break;case"createImage":c(n,s.LoadingTextures,n._progress.count+1);break;case"createThumbnail":c(n,s.LoadingModelViews,n._progress.count+1);break;default:break}})}};o.onerror=function(e){t(e)};var O=n.absoluteUri("sap/ui/vk/ve/").toString();o.postMessage({method:"createRuntime",args:{scriptDirectory:O}})}))}}();function f(t,n,o,s,i,u,c){var f=i.getDependencyLoader();sap.ui.require([s.isObject3D?"sap/ui/vk/threejs/SceneBuilder":"sap/ui/vk/svg/SceneBuilder"],function(E){l().then(function(l){l.onerror=function(r){e.error("Error in WebWorker",r);c(a().getText("LOADER_ERRORREADINGFILE"))};var v=new E(s,i,u,c);v._loader=t;v._progress={lastUpdateTime:performance.now()};v._id=d++;g.set(v._id,{sceneBuilder:v,dependencyLoader:f,files:new Map,waitingCount:0});l.postMessage({method:"createContext",args:{sceneBuilderId:v._id,buffer:n,fileName:o,locale:r.getConfiguration().getLanguageTag()}},[n])},function(e){c(e)})})}i.prototype.load=function(e,r,t,n){var s=this;return new Promise(function(i,u){if(typeof r.getSource()==="string"){var c=r.getSource();new o([c],undefined,t,n).attachItemSucceeded(function(t){var a=t.getParameter("source");var n=t.getParameter("response");f(s,n,a,e,r,i,u)},this).attachItemFailed(function(e){var r=e.getParameter("statusText");if(r===""){r=a().getText("VIEWER_SOURCE_FAILED_TO_DOWNLOAD_CAUSE")}u(r)},this).start()}else if(r.getSource()instanceof File){var d=new FileReader;d.onload=function(t){f(s,t.target.result,r.getSource().name,e,r,i,u)};d.onerror=function(e){u(e)};d.readAsArrayBuffer(r.getSource())}})};return i});
//# sourceMappingURL=MataiLoader.js.map