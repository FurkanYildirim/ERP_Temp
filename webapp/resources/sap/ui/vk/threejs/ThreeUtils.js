/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../thirdparty/three","sap/base/Log","./MarchingCubes","../ObjectType"],function(e,r,a,t){"use strict";var n=new Float32Array(1);var i={};i.createWebGLImageRenderer=function(r,a,t){var n=new e.WebGLRenderer({canvas:r,preserveDrawingBuffer:true,antialias:true,alpha:true});n.setSize(a,t);n.outputColorSpace=e.LinearSRGBColorSpace;return n};i.createWebGLRenderer=function(r,a){var t=new e.WebGLRenderer({antialias:true,alpha:true});t.setPixelRatio(r);t.setSize(1,1);if(a){t.shadowMap.enabled=true}t.outputColorSpace=e.LinearSRGBColorSpace;return t};i._disposeMaterial=function(e){if(e.map){e.map.dispose()}if(e.lightMap){e.lightMap.dispose()}if(e.bumpMap){e.bumpMap.dispose()}if(e.normalMap){e.normalMap.dispose()}if(e.specularMap){e.specularMap.dispose()}if(e.envMap){e.envMap.dispose()}if(e.alphaMap){e.alphaMap.dispose()}if(e.emissiveMap){e.emissiveMap.dispose()}if(e.aoMap){e.aoMap.dispose()}e.dispose()};i.disposeMaterial=function(e){if(e){i._disposeMaterial(e)}};i.disposeObject=function(r){if(r instanceof e.Mesh||r instanceof e.Line||r instanceof e.Box3Helper){if(r.geometry){r.geometry.dispose()}if(r.material){i._disposeMaterial(r.material)}}};i.disposeGeometry=function(r){if(r instanceof e.Mesh||r instanceof e.Line||r instanceof e.Box3Helper){if(r.geometry){r.geometry.dispose()}}};i.getAllTHREENodes=function(a,t,n){if(!a){return}if(!t||!n){r.error("getAllTHREENodes input parameters - all3DNodes and/or allGroupNodes are undefined.");return}a.forEach(function(r){if(r instanceof e.Mesh){t.push(r)}else if(r instanceof e.Light){t.push(r)}else if(r instanceof e.Camera){t.push(r)}else if(r instanceof e.Box3Helper){t.push(r)}else if(r instanceof e.Group){n.push(r)}if(r.children&&r.children.length>0){i.getAllTHREENodes(r.children,t,n)}})};var o=new e.Vector3;var f=function(e,r){r.makeEmpty();e.updateMatrixWorld(true);e.traverse(function(e){if(e.userData.objectType===t.Hotspot||e.userData.objectType===t.PMI){return}var a;var n;var i=e.geometry;if(i!=null){if(i.isGeometry){var f=i.vertices;for(a=0,n=f.length;a<n;a++){o.copy(f[a]);o.applyMatrix4(e.matrixWorld);r.expandByPoint(o)}}else if(i.isBufferGeometry){var s=i.attributes.position;if(s!=null){var u=e.userData.renderGroup;for(a=u?u.firstVertex:0,n=u?u.lastVertex:s.count;a<n;a++){o.fromBufferAttribute(s,a).applyMatrix4(e.matrixWorld);r.expandByPoint(o)}}}}});return r};i.computeObjectOrientedBoundingBox=function(e,r){var a=e.parent;var t=e.matrix.clone();var n=e.matrixAutoUpdate;e.parent=null;e.matrix.identity();e.matrixAutoUpdate=false;f(e,r);e.matrixAutoUpdate=n;e.matrix.copy(t);e.parent=a;e.updateMatrixWorld(true);return r};i.computeClusterBoundingBoxes=function(r,a,t,n){var i=new Uint8Array(a.buffer);var o,f,s,u,l,d,p,c,v,h,m,b,x;var g;var y=new e.Matrix4;var M=y.elements;var w=new e.Vector3;for(var I=0,A=r.length;I<A;++I){if(n[3+I]===0){continue}var C=new e.Box3;var k=new e.Vector3;g=0;m=r[I].additionalRenderables;o=r[I].geometry;s=o.userData.renderInstanceCount||1;f=o.instanceIndices;for(h=0;h<2;++h){for(u=0,l=f.length;u<l;++u){d=f[u];for(p=0;p<s;++p){c=d*20;d++;if((i[c*4+3]&3)>0){M[0]=a[c+8];M[4]=a[c+9];M[8]=a[c+10];M[12]=a[c+11];M[1]=a[c+12];M[5]=a[c+13];M[9]=a[c+14];M[13]=a[c+15];M[2]=a[c+16];M[6]=a[c+17];M[10]=a[c+18];M[14]=a[c+19];for(v=0;v<8;++v){w.x=a[c+((v&1)>0?3:2)];w.y=a[c+((v&2)>0?5:4)];w.z=a[c+((v&4)>0?7:6)];w.applyMatrix4(y);if(h>0){g=Math.max(g,k.distanceToSquared(w))}else{C.expandByPoint(w)}}}}}for(u=0,l=m.length;u<l;++u){b=m[u];x=b.userData.renderGroup;if(x.instanceIndex===null){for(v=0;v<8;++v){w.x=x.boundingBox[c+((v&1)>0?3:0)];w.y=x.boundingBox[c+((v&2)>0?4:1)];w.z=x.boundingBox[c+((v&4)>0?5:2)];w.applyMatrix4(b.matrixWorld);if(h>0){g=Math.max(g,k.distanceToSquared(w))}else{C.expandByPoint(w)}}}}if(h===0){if(C.isEmpty()){o.boundingBox=null;o.boundingSphere=null;break}C.getCenter(k)}else{o.boundingBox=C;o.boundingSphere=new e.Sphere(k,Math.sqrt(g))}}}};i.initClustersBeforeProcessingHierarchy=function(e){for(var r=0,a=e.length;r<a;++r){e[r].additionalRenderables=[]}};i.processUpdatedDataTexture=function(e,r,a){var t=e.userData.textureUpdateParams;if(t){r=Math.min(r,t.updatedFrom);a=Math.max(a,t.updatedTo)}var n=4;var i=n*e.image.width;var o=Math.floor(r/i);var f=Math.ceil(a/i);var s=f-o;var u=0;var l=e.image.width;var d=o*i;if(s===1){u=Math.floor((r-i*o)/n);d+=u*n;l=Math.ceil((a-d)/n)}e.userData.textureUpdateParams={xOffset:u,yOffset:o,width:l,height:s,dataOffset:d,updatedFrom:r,updatedTo:a};e.needsUpdate=true};i.prepareTextureUpdateResults=function(e,r){var a=3+e;if(!r){var t=new Uint32Array(a);t[0]=4294967295;return t}if(r.length>=a){return r}var n=new Uint32Array(a);n.set(r);return n};function s(e,r,a,t,n){for(var i=0,o=a.instanceIndex*20;i<n;++i,++o){if(e[o]!=t[i]){e[o]=t[i];r[3+a.clusterIndex]=1;if(o<r[0]){r[0]=o}if(o>r[1]){r[1]=o}}}}function u(e,r,a,t){var n=e.userData.renderGroup;if(n){s(a,t,n,r,1)}var i=e.children;for(var o=0,f=i.length;o<f;o++){u(i[o],r,a,t)}}i.removeNodeFromClusterRenderingRecursive=function(e,r,a){u(e,n,r,a)};i.updateNodeClusterRenderingInfo=function(e,r,a,t,n){var i=e.userData;var o=i.renderGroup;if(o){if(o.instanceIndex===null){r[o.clusterIndex].additionalRenderables.push(e)}else if(t){var f=new Uint8Array(a.buffer);f[0]=0;f[1]=0;f[2]=0;if(i.initialMaterialId!==i.materialId||i.highlightingColor||i.defaultMaterial||e.material.transparent===true){f[3]=2;r[o.clusterIndex].additionalRenderables.push(e)}else if(i.highlightColor||i.tintColor){var u=e.material.emissive;var l=e.material.specular;if(u.r===.0235&&u.g===.0235&&u.b===.0235&&l.r===.0602&&l.g===.0602&&l.b===.0602){u=e.material.color;f[0]=255*u.r;f[1]=255*u.g;f[2]=255*u.b;f[3]=3}else{f[3]=2;r[o.clusterIndex].additionalRenderables.push(e)}}else{f[3]=1}a[1]=0;var d=o.boundingBox;a[2]=d[0];a[3]=d[3];a[4]=d[1];a[5]=d[4];a[6]=d[2];a[7]=d[5];var p=e.matrixWorld.elements;a[8]=p[0];a[9]=p[4];a[10]=p[8];a[11]=p[12];a[12]=p[1];a[13]=p[5];a[14]=p[9];a[15]=p[13];a[16]=p[2];a[17]=p[6];a[18]=p[10];a[19]=p[14];s(t,n,o,a,20)}}else if(e.isMesh||e.isLine){n[2]=1}};function l(e,r,a,t,n,i,o,f,s){if(i===o){r[n*s*s+t*s+a]=1}if(i<o){var u=e[f[0]];f[0]++;a*=2;t*=2;n*=2;var d,p,c;for(c=0;c<2;++c){for(p=0;p<2;++p){for(d=0;d<2;++d){if((u&1<<c*4+p*2+d)!==0){l(e,r,a+d,t+p,n+c,i+1,o,f,s)}}}}}}function d(e,r){var a,t,n,i;var o=r*r;var f=true;var s;while(f){f=false;s=0;for(n=0;n<r;++n){for(t=0;t<r;++t){for(a=0;a<r;++a){if(e[n*o+t*r+a]>0){a++;for(i=r-1;i>a;--i){if(e[n*o+t*r+i]>0){for(;a<i;++a){if(e[n*o+t*r+a]===0){e[n*o+t*r+a]=1;f=true}}break}}s++;break}}}}for(n=0;n<r;++n){for(a=0;a<r;++a){for(t=0;t<r;++t){if(e[n*o+t*r+a]>0){t++;for(i=r-1;i>t;--i){if(e[n*o+i*r+a]>0){for(;t<i;++t){if(e[n*o+t*r+a]===0){e[n*o+t*r+a]=1;f=true}}break}}s++;break}}}}for(t=0;t<r;++t){for(a=0;a<r;++a){for(n=0;n<r;++n){if(e[n*o+t*r+a]>0){n++;for(i=r-1;i>n;--i){if(e[i*o+t*r+a]>0){for(;n<i;++n){if(e[n*o+t*r+a]===0){e[n*o+t*r+a]=1;f=true}}break}}s++;break}}}}}return s*2}function p(e,r,a,t){var n=r*4;var i,o,f,s;switch(e){case 0:i=[a[0],a[1],a[5],a[3],a[1],a[5],a[0],a[4],a[5],a[3],a[4],a[5]];o=0;f=0;s=1;break;case 1:i=[a[0],a[1],a[2],a[0],a[4],a[2],a[3],a[1],a[2],a[3],a[4],a[2]];o=0;f=0;s=-1;break;case 2:i=[a[0],a[4],a[5],a[3],a[4],a[5],a[0],a[4],a[2],a[3],a[4],a[2]];o=0;f=1;s=0;break;case 3:i=[a[0],a[1],a[5],a[0],a[1],a[2],a[3],a[1],a[5],a[3],a[1],a[2]];o=0;f=-1;s=0;break;case 4:i=[a[3],a[1],a[5],a[3],a[1],a[2],a[3],a[4],a[5],a[3],a[4],a[2]];o=1;f=0;s=0;break;default:i=[a[0],a[1],a[5],a[0],a[4],a[5],a[0],a[1],a[2],a[0],a[4],a[2]];o=-1;f=0;s=0;break}t.points.set(i,n*3);if(t.normals!==undefined){t.normals.set([o,f,s,o,f,s,o,f,s,o,f,s],n*3)}t.indices.set([n+0,n+1,n+2,n+2,n+1,n+3],r*6)}function c(e,r,a,t,n,i){e[0]=n[0]+r*i[0];e[1]=n[1]+a*i[1];e[2]=n[2]+t*i[2];e[3]=e[0]+i[0];e[4]=e[1]+i[1];e[5]=e[2]+i[2]}function v(e,r,a,t,n,i){var o,f,s,u;var l=r*a;var d=0;var v=[(n[3]-n[0])/r,(n[4]-n[1])/a,(n[5]-n[2])/t];var h=[0,0,0,0,0,0];for(s=0;s<t;++s){for(f=0;f<a;++f){for(o=0;o<r;++o){if(e[s*l+f*r+o]>0){c(h,o,f,s,n,v);p(5,d,h,i);d++;for(u=r-1;u>=o;--u){if(e[s*l+f*r+u]>0){c(h,u,f,s,n,v);p(4,d,h,i);d++;break}}break}}}}for(s=0;s<t;++s){for(o=0;o<r;++o){for(f=0;f<a;++f){if(e[s*l+f*r+o]>0){c(h,o,f,s,n,v);p(3,d,h,i);d++;for(u=a-1;u>=f;--u){if(e[s*l+u*r+o]>0){c(h,o,u,s,n,v);p(2,d,h,i);d++;break}}break}}}}for(f=0;f<a;++f){for(o=0;o<r;++o){for(s=0;s<t;++s){if(e[s*l+f*r+o]>0){c(h,o,f,s,n,v);p(1,d,h,i);d++;for(u=t-1;u>=s;--u){if(e[u*l+f*r+o]>0){c(h,o,f,u,n,v);p(0,d,h,i);d++;break}}break}}}}return d*4}function h(e,r,a,t,n,i){var o;if(i>0){o=false}else if(i<0){o=true}else{o=r>t||a>n}var f=o?r:t;var s=o?a:n;e.points=new Float32Array(f*3);e.indices=new Uint16Array(s*3);if(e.normals!==undefined){e.normals=new Float32Array(f*3)}if(e.uvs!==undefined){e.uvs=new Float32Array(f*2)}}function m(e,r,a,t){var n=a[0]<=2?Infinity:(t[3]-t[0])/a[0];var i=a[1]<=2?Infinity:(t[4]-t[1])/a[1];var o=a[2]<=2?Infinity:(t[5]-t[2])/a[2];var f=-1;if(n<=i&&n<=o){if(n!==Infinity){f=0}}else if(i<=n&&i<=o){if(i!==Infinity){f=1}}else if(o<=n&&o<=i){if(o!==Infinity){f=2}}if(f<0){return 0}n=a[0];i=a[1];o=a[2];var s=n*i;var u=n,l=i,d=o;var p=u*l;var c,v,h;if(f===0){a[0]=a[0]>>1;u=a[0];p=u*l;for(h=0;h<o;++h){for(v=0;v<i;++v){for(c=0;c<n;++c){r[h*p+v*u+c]=e[h*s+v*n+c*2]|e[h*s+v*n+c*2+1]}}}}if(f===1){a[1]=a[1]>>1;l=a[1];p=u*l;for(h=0;h<o;++h){for(v=0;v<i;++v){for(c=0;c<n;++c){r[h*p+v*u+c]=e[h*s+v*2*n+c]|e[h*s+(v*2+1)*n+c]}}}}if(f===2){a[2]=a[2]>>1;d=a[2];p=u*l;for(h=0;h<o;++h){for(v=0;v<i;++v){for(c=0;c<n;++c){r[h*p+v*u+c]=e[h*2*s+v*n+c]|e[(h*2+1)*s+v*n+c]}}}}var m=0;for(h=0;h<d;++h){for(v=0;v<l;++v){for(c=0;c<u;++c){if(r[h*p+v*u+c]>0){m++;break}}}}for(h=0;h<d;++h){for(c=0;c<u;++c){for(v=0;v<l;++v){if(r[h*p+v*u+c]>0){m++;break}}}}for(v=0;v<l;++v){for(c=0;c<u;++c){for(h=0;h<d;++h){if(r[h*p+v*u+c]>0){m++;break}}}}return m*2}i.buildEmptyMesh=function(e,r,a,t){var n={normals:(r&3)>0?new Float32Array(a*3):undefined,uvs:(r&4)>0?new Float32Array(a*2):undefined,indices:new Uint16Array(t*(3-(r&1)))};var i=new Float32Array(a*3);i[0]=e[0];i[1]=e[1];i[2]=e[2];for(var o=1;o<a;++o){i[o*3]=e[3];i[o*3+1]=e[4];i[o*3+2]=e[5]}n.points=i;return n};i.buildTemporaryMesh=function(e,r,t,n,i,o,f){var s=f<=0;var u={points:null,normals:(r&3)>0?null:undefined,uvs:(r&4)>0?null:undefined,indices:null};var c=0;var b=0;var x=!i||o?0:i[0];if(!s&&(t<384||n<192)){x=0}var g=null;var y=0;if(x>0){g=new Uint8Array(Math.pow(Math.pow(2,x),3));y=Math.pow(2,x);var M=new Uint32Array(2);M[0]=1;l(i,g,0,0,0,0,x,M,y);var w=3*a.count(g,y);var I=Math.min(t,n);if(!s&&w>I){b=d(g,y);w=3*a.count(g,y)}if(s||w<=I){h(u,w,w,t,n,f);a.march(g,y,e,u.points,u.normals,u.indices);c=w}}if(c===0&&y>=2){var A=Math.floor(Math.min(t/4,n/2));if(s){A=b}var C=new Uint8Array(y*y*y/2);var k=[y,y,y];var B=false;var R=0;for(;;){if(b<=A){h(u,b*4,b*2,t,n,f);c=v(B?C:g,k[0],k[1],k[2],e,u);break}b=R===4?0:m(B?C:g,B?g:C,k,e);if(!b){break}B=!B;R++}}if(c===0){h(u,24,12,t,n,f);for(;c<6;++c){p(c,c,e,u)}c=24}var U=u.points;for(var G=c,S=U.length/3;G<S;++G){U[G*3]=U[0];U[G*3+1]=U[1];U[G*3+2]=U[2]}return u};i.updateClusterAttrib=function(e,r,a,t){var n=e.getAttribute(r);n.array.set(t,a);var i=n.updateRange;if(i.count<0){i.offset=a;i.count=t.length}else{i.count+=i.offset;i.offset=Math.min(i.offset,a);i.count=Math.max(i.count,a+t.length)-i.offset}n.needsUpdate=true};i.updateClusterIndices=function(e,r,a,t,n){var i=e.getIndex();var o=i.updateRange;if(o.count<0){o.offset=t;o.count=n}else{o.count+=o.offset;o.offset=Math.min(o.offset,t);o.count=Math.max(o.count,t+n)-o.offset}i.needsUpdate=true;var f=i.array;for(var s=0;s<n;++s){f[t+s]=a+r[s]}};i.updateClusterGeometry=function(e,r,a,t,n){if(r.length!==e.vertexCount*3||n.length!==e.indexCount){return false}var o=e.geometry;var f=e.vertexStart;i.updateClusterAttrib(o,"position",f*3,r);if(a&&a.length){i.updateClusterAttrib(o,"normal",f*3,a)}if(t&&t.length){i.updateClusterAttrib(o,"uv",f*2,t)}i.updateClusterIndices(o,n,f,e.indexStart,e.indexCount);return true};i.increaseCurrentInstance=function(e){if(e.currentInstanceIndex<e.maxInstanceIndex){e.currentInstanceIndex++}else{r.error("Maximum number of instances in a texture reached!")}};i.partitionCluster=function(e,r,a){var t;var n=null;var i=r.length-1;for(var o=0,f=e.length;o<f;++o){t=e[o];if(!n||n.verts+t.verts>65536){n={verts:0,elems:0};r.push(n);i++}a.set(t.submesh,i);n.verts+=t.verts;n.elems+=t.elems}};return i});
//# sourceMappingURL=ThreeUtils.js.map