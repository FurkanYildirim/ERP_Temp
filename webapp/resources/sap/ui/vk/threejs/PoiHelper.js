/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../ContentConnector","../ContentResource","./ContentDeliveryService","../NodeContentType","../TransformationMatrix","../thirdparty/three","sap/base/assert","sap/base/util/uid"],function(e,t,r,n,o,a,i,s){"use strict";var c=new a.Vector3(1,1,1);function d(e){e.userData={skipIt:true};e.children.forEach(d)}var m=function(){this._symbolSceneCache=[]};m.prototype.createPOI=function(e,t,r,m,u,l,f){m=m._implementation||m;if(!("sid"in l)){l.sid=s()}if(!("transform"in l)){i(f!=null,"If nodeInfo.transform is not defined then getNearestEntityOrVisibleElementNodes must be defined.");var v=m.getDomRef().getBoundingClientRect();var y=u.x-v.left;var p=u.y-v.top;var h=m.hitTest(y,p,{ignoreOverlay:true});if(h==null){return Promise.reject("Cannot locate an object for the marker.")}var x=(new a.Matrix4).compose(h.point,m._getNativeCamera().quaternion,c);l.transform=o.convertTo4x3(x.elements);var g=f(h.object);l.referenceNode=(g.length>0?g[0]:h.object).userData.nodeId}l.transformType="BILLBOARD_VIEW";var w=t.getDefaultNodeHierarchy();var I=w.createNode(null,l.name,null,n.Symbol,l);var N=m.getCurrentView()||t.getViews()[0];return this.loadSymbolScene(e,r).then(function(e){var t=e.userData.entityId;I.add.apply(I,e.children);I.children.forEach(d);I.userData.treeNode.entityId=t;N.updateNodeInfos([{target:I,visible:true,transform:l.transform}]);m.setShouldRenderFrame();return{transform:l.transform.slice(),veId:l.sid,entityId:t,name:l.name,transformType:"BILLBOARD_VIEW",contentType:"SYMBOL",referenceNode:l.referenceNode,symbolNode:I}})};m.prototype.updatePOI=function(e,t,r,n,o,a){var i=t.persistentIdToNodeRef(n);if("name"in a){i.name=a.name}if("transform"in a){i.position.set(a.transform[9],a.transform[10],a.transform[11])}if(o){var s=t.getDefaultNodeHierarchy();s.removeNode(i.children);return this.loadSymbolScene(e,o).then(function(e){var t=e.userData.entityId;i.add.apply(i,e.children);i.children.forEach(d);i.userData._symbolCenterFixed=false;i.userData.treeNode.entityId=t;r.setShouldRenderFrame();return t})}else{r.setShouldRenderFrame();return Promise.resolve(i.userData.treeNode.entityId)}};m.prototype.removePOI=function(e,t){var r=e.getDefaultNodeHierarchy();var n=e.getViewStateManager();n.setVisibilityState(t,false,true);r.removeNode(t)};m.prototype.getPoiRect=function(e,t){var r=e._getNativeCamera();var n=new a.Box3;n.setFromObject(t);var o=[new a.Vector3(n.min.x,n.min.y,n.min.z),new a.Vector3(n.max.x,n.max.y,n.max.z),new a.Vector3(n.min.x,n.min.y,n.max.z),new a.Vector3(n.min.x,n.max.y,n.max.z),new a.Vector3(n.max.x,n.min.y,n.max.z),new a.Vector3(n.max.x,n.max.y,n.min.z),new a.Vector3(n.min.x,n.max.y,n.min.z),new a.Vector3(n.max.x,n.min.y,n.min.z)];var i=new a.Frustum;i.setFromProjectionMatrix((new a.Matrix4).multiplyMatrices(r.projectionMatrix,r.matrixWorldInverse));if(!i.intersectsBox(n)){return false}var s=new a.Vector3(1,1,1);var c=new a.Vector3(-1,-1,-1);var d=new a.Vector3;for(var m=0;m<o.length;++m){if(!i.containsPoint(o[m])){return false}var u=d.copy(o[m]);var l=u.project(r);s.min(l);c.max(l)}var f=new a.Box2(s,c);var v=e.getDomRef().getBoundingClientRect();var y=new a.Vector2(v.width/2,v.height/2);var p=f.min.clone().multiply(y);var h=f.max.clone().multiply(y);var x=h.x-p.x;var g=h.y-p.y;return{width:x,height:g}};m.prototype.adjustPoi=function(e,t){if(e.getBackgroundProjection()!=="planar"){var r=t.getWorldPosition(new a.Vector3).project(e._getNativeCamera());var n=e.hitTest((r.x*.5+.5)*e._width,(r.y*-.5+.5)*e._height,{ignoreOverlay:true});if(n){t.position.copy(n.point)}t.quaternion.copy(e._getNativeCamera().quaternion);t.updateMatrix();t.updateMatrixWorld();t.userData.direction=(new a.Vector3).setFromMatrixColumn(t.matrixWorld,2).normalize()}t.userData.transform=o.convertTo4x3(t.matrixWorld.elements)};m.prototype.updateNodeId=function(e,t,r){var n=e.persistentIdToNodeRef(t);if(n!=null){e.setNodePersistentId(n,r)}return n};m.prototype.findSymbolSceneInCache=function(e,t){return this._symbolSceneCache.find(function(r){return r.url===e&&r.sceneId===t})};m.prototype.loadSymbolScene=function(n,o){var a=this.findSymbolSceneInCache(n,o);if(a!=null){return Promise.resolve(a.rootNodeRef.clone())}return new Promise(function(a,i){var c="marker-"+s();var d=new t({sourceType:c,source:n,veid:o,sourceId:"abc"});var m=new e;var u=new r;var l=function(){e.removeContentManagerResolver(c);setTimeout(function(){m.destroy();u.destroy()},0)};u.attachEventOnce("sceneCompleted",function(){var e=d.getNodeProxy().getNodeRef();if(this.findSymbolSceneInCache(n,o)==null){this._symbolSceneCache.push({url:n,sceneId:o,rootNodeRef:e.clone()})}a(e.clone());l()},this);u.attachEventOnce("errorReported",function(e){i(e.getParameter("error"));l()});e.addContentManagerResolver({pattern:c,dimension:3,contentManagerClassName:"sap.ui.vk.threejs.ContentManager",settings:{loader:u}});m.addContentResource(d)}.bind(this))};return m});
//# sourceMappingURL=PoiHelper.js.map