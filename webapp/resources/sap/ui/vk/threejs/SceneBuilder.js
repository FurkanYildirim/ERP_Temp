/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../thirdparty/three","sap/base/Log","./UsageCounter","../totara/TotaraUtils","./OrthographicCamera","./PerspectiveCamera","./DetailView","./AnimationHelper","./Thrustline","./Billboard","./Callout","../BillboardCoordinateSpace","../BillboardTextEncoding","../BillboardStyle","../BillboardBorderLineStyle","../BillboardHorizontalAlignment","../LeaderLineMarkStyle","../DetailViewType","../DetailViewShape","../AnimationPlayback","../AnimationRotateType","../RenderMode","./Material","./MaterialType","./SphericalMapMaterial","../ObjectType","./ParametricGenerators","../NodeContentType","../NavigationMode","sap/base/util/uid","./ThreeUtils","sap/base/assert","../colorToCSSColor","../TransformationMatrix"],function(e,t,r,a,i,n,s,o,d,u,l,c,h,p,f,m,v,g,y,_,I,b,S,w,D,T,M,x,C,A,k,N,R,V){"use strict";var O=function(e,t,r,a){this._rootNode=e;this._contentResource=t;this._resolve=r;this._reject=a;this._callouts=new Map;this._cameras=new Map;this._images=new Map;this._imageIdsAndTileWidths=new Map;this._imageTextures=new Map;this._geometries=new Map;this._meshNodes=new Map;this._meshSubmeshes=new Map;this._geometryProxies=new Map;this._geometrySubmeshIndices=new Map;this._materialMeshes=new Map;this._materialClones=new Map;this._joints=[];this._imageAddedToMaterialHandlers=[];this._isSmallScene=null;this._preprocessedClusterDefinitions=null;this._preprocessedSubmeshToClusterMap=null;if(e){this._nodes=new Map;this._tracks=new Map;this._trackIdSequenceNodeMap=new Map;this._viewGroups=new Map;this._views=new Map}else{this._nodes=null;this._tracks=null;this._trackIdSequenceNodeMap=null;this._viewGroups=null;this._views=null}this._currentSceneId=null;this._sceneIdTreeNodesMap=new Map;this._sceneIdRootNodeMap=new Map;this._animationHelper=new o(this);if(t){var i=t.getNodeProxy();var n=i.getNodeHierarchy();this._vkScene=n.getScene();var s=t.getSource();if(s&&s.name){this._sceneIdTreeNodesMap.set(s.name,this._nodes);this._sceneIdRootNodeMap.set(s.name,e);this._currentSceneId=s.name}}this._viewThumbnails=new Map;this._thrustlines=new Map;this._animations=new Map;this._animationTracks=new Map;this._jointNodesMap=new Map;this._jointParentsMap=new Map;this._upAxis=2;this._voxelThreshold=0};O.prototype.getVoxelThreshold=function(){return this._voxelThreshold};O.prototype.setVoxelThreshold=function(e){this._voxelThreshold=e;return this};var P=[b.Default,b.Default,b.Default,b.LineIllustration,b.SolidOutline,b.ShadedIllustration];O.prototype.setScene=function(e){this._vkScene.setSceneBuilder(this);var t=this._cameras.get(e.cameraId);this._upAxis=e.upAxis;this._resolve({node:this._rootNode,camera:t,backgroundTopColor:e.backgroundTopColor,backgroundBottomColor:e.backgroundBottomColor,upAxis:e.upAxis,contentResource:this._contentResource,builder:this})};O.prototype.setRootNode=function(e,t,r,a){this._rootNode=e;this._nodes=new Map;this._nodes.set(t,e);this._tracks=new Map;this._trackIdSequenceNodeMap=new Map;this._sequenceIdToPlaybacks=new Map;this._viewGroups=new Map;this._views=new Map;if(r){this._sceneIdTreeNodesMap.set(r,this._nodes);this._sceneIdRootNodeMap.set(r,e);this._currentSceneId=r}if(a){this._vkScene=a}return this};O.prototype._resetCurrentScene=function(e){if(e&&e!==this._currentSceneId){var t=this._sceneIdTreeNodesMap.get(e);if(t){this._nodes=t}else{this._nodes=null}var r=this._sceneIdRootNodeMap.get(e);if(r){this._rootNode=r}else{this._rootNode=null}this._currentSceneId=e}};O.prototype.getNode=function(e,t){if(t){this._resetCurrentScene(t);if(this._nodes){return this._nodes.get(e)}}else{var r=this._sceneIdTreeNodesMap.values();var a=r.next();while(!a.done){var i=a.value.get(e);if(i){return i}a=r.next()}}return null};O.prototype.hasMesh=function(e){return this._meshSubmeshes.has(e)};O.prototype.hasImage=function(e){return this._images.has(e)};O.prototype.hasAnnotation=function(e){return this._vkScene._hasAnnotation(e)};O.prototype.setNodePersistentId=function(e,t,r){var a=e.userData;var i=a.treeNode;if(i==null){i=a.treeNode={}}var n=i.sid;this._resetCurrentScene(r);a.nodeId=i.sid=t;if(this._nodes){if(n){this._nodes.delete(n)}this._nodes.set(t,e);return true}return false};var E=function(t){var r=new e.Matrix4;if(t.length===3){r.setPosition((new e.Vector3).fromArray(t))}else if(t.length===12){r.fromArray(V.convertTo4x4(t))}else if(t.length===16){r.fromArray(t)}else{throw"Invalid matrix format"}return r};var B={r:.0235,g:.0235,b:.0235};var L={r:.0602,g:.0602,b:.0602};O.prototype._createTemporaryMaterial=function(t,r){var a=new S(r||w.MeshPhongMaterial);var i=a.getMaterialRef();i.userData.defaultHighlightingEmissive=B;i.userData.defaultHighlightingSpecular=L;i.userData.materialUsed=0;i.userData.materialId=t;i.userData.toBeUpdated=true;if(this._vkScene.getDoubleSided()){i.side=e.DoubleSide;i.userData.originalMaterialSide=e.FrontSide}this._vkScene.setMaterial(t,a);var n=this._materialMeshes.get(t);if(n){n.forEach(function(e){this._updateMeshSubmeshesMaterial(e,t,i)},this)}var s=this._vkScene.getSceneRef().userData;if(!s.instanceDataTexture){var o=2048;var d=2048;s.maxInstanceIndex=Math.floor(2048*2048*4/20)-1;s.instanceDataTexture=new e.DataTexture(new Float32Array(o*d*4),o,d,e.RGBAFormat,e.FloatType);s.instanceDataTexture.version=1;s.instanceDataTexture.image.needsUpdate=true;s.instanceDataTexture.onUpdate=function(e){e.userData.textureUpdateParams=null};s.textureUpdateResults=null}i.specularMap=s.instanceDataTexture;return i};O.prototype._getMaterialRef=function(e){var t=this._vkScene.getMaterial(e);return t?t.getMaterialRef():null};O.prototype.checkMaterialExists=function(e,t){if(this._getMaterialRef(e)===null){if(t){this._createTemporaryMaterial(e)}return false}return true};O.prototype.materialNeeded=function(e){return true};O.prototype.attachImageAddedToMaterial=function(e,t){this._imageAddedToMaterialHandlers.push({func:e,listener:t});return this};O.prototype.detachImageAddedToMaterial=function(e,t){for(var r=0;r<this._imageAddedToMaterialHandlers.length;r++){var a=this._imageAddedToMaterialHandlers[r];if(a.func===e&&a.listener===t){this._imageAddedToMaterialHandlers.splice(r,1);return this}}return this};O.prototype.fireImageAddedToMaterial=function(e){var t=this._imageAddedToMaterialHandlers.slice();t.forEach(function(t){t.func.call(t.listener,e)});return this};O.prototype._attachMaterialClone=function(e,t){a.pushElementIntoMapArray(this._materialClones,e,t)};O.prototype._addDynamicObject=function(e,t,r){var a=this._rootNode.userData;if(!a._vkDynamicObjects){a._vkDynamicObjects=[]}if(a._vkDynamicObjects.indexOf(e)<0){a._vkDynamicObjects.push(e)}e._vkUpdate=t;if(r){e.userData.is2D=true}};O.prototype.createNode=function(t,r){this._resetCurrentScene(r);var a=new e.Group;this._nodes.set(t.sid,a);var i;var n=this._jointNodesMap.get(t.sid);if(n&&n.length){for(i=0;i<n.length;i++){n[i].node=a}}var s=this._jointParentsMap.get(t.sid);if(s&&s.length){for(i=0;i<s.length;i++){s[i].parent=a}}var o=this._nodes.get(t.parentId);(o||this._rootNode).add(a);var d=a.userData;d.treeNode=t;if(t.closed){d.closed=true}if(t.selectable===false){d.selectable=false}if(t.visualisable===false&&t.contentType!=="SYMBOL"){d.skipIt=true}if(t.metadata){d.metadata=t.metadata}if(t.veids){d.veids=t.veids}if(t.usageIds){d.usageIds=t.usageIds}if(t.sid){d.nodeId=t.sid}if(t.name){a.name=t.name}if(t.visible!==undefined){a.visible=!!t.visible}if(o){var l;if(d.skipIt||o.name&&a.name===o.name+" offset geometry"){d.skipIt=true}else{l=o;while(l){if(l.userData.closed){d.skipIt=true;d.skipItClosed=true}l=l.parent}}if(o.userData.symbolContent){d.skipIt=true;if(d.skipItClosed===true){d.skipItClosed=false}d.symbolContent=true}if(a.visible&&!d.skipIt&&this._contentResource){l=o;while(l){l.visible=true;l=l.parent}}}if(t.renderOrder){a.renderOrder=t.renderOrder}if(t.renderMethod){d.renderMethod=t.renderMethod}if(t.renderStage){if(typeof t.renderStage==="string"){t.renderStage={UNDERLAY_2D:-1,OVERLAY_2D:1}[t.renderStage]||0}d.renderStage=t.renderStage}d.opacity=t.opacity;if(t.transform){a.applyMatrix4(E(t.transform));if(!isFinite(a.quaternion.x)||!isFinite(a.quaternion.y)||!isFinite(a.quaternion.z)||!isFinite(a.quaternion.w)){a.quaternion.set(0,0,0,1)}}a.updateMatrixWorld(true);if(t.transformType){d.transformType=t.transformType;switch(t.transformType){case"ORTHO2D":d.originalTransform={p:a.position.clone(),q:a.quaternion.clone(),s:a.scale.clone()};this._addDynamicObject(a,u.prototype._ortho2DUpdate,true);break;case"BILLBOARD_VIEW":this._addDynamicObject(a,u.prototype._billboardViewUpdate,false);break;case"LOCK_TOVIEWPORT":this._addDynamicObject(a,u.prototype._lockToViewportUpdate,true);break;default:break}}if(t.materialId){d.materialId=t.materialId}if(t.geometryType){d.geometryType=t.geometryType}if(t.meshId){this.setMeshNode(t.sid,t.meshId)}if(t.parametricId){this.setParametricNode(t.sid,t.parametricId,t.visible)}if(a.parent.userData.objectType===T.Hotspot){d.objectType=T.Hotspot}else if(a.parent.userData.objectType===T.PMI){d.objectType=T.PMI}else if(t.contentType==="HOTSPOT"){d.objectType=T.Hotspot}else if(t.contentType==="PMI"){d.objectType=T.PMI}if(t.contentType==="REFERENCE"){a._vkSetNodeContentType(x.Reference)}else if(t.contentType==="ANNOTATION"){a._vkSetNodeContentType(x.Annotation)}else if(t.contentType==="BACKGROUND"){a._vkSetNodeContentType(x.Background)}else if(t.contentType==="SYMBOL"){a._vkSetNodeContentType(x.Symbol);d.symbolContent=true}return a};O.prototype.removeNode=function(e){this._nodes.delete(e._vkPersistentId());this._vkScene._removeAnnotationsForNode(e);var t=false;if(!this._forbiddenTextureUpdate){this._forbiddenTextureUpdate=true;t=true;var r=this._vkScene.getSceneRef().userData;if(r.instanceDataTexture){var a=r.geometryClusters;var i=k.prepareTextureUpdateResults(a?a.length:0,r.textureUpdateResults);k.removeNodeFromClusterRenderingRecursive(e,r.instanceDataTexture.image.data,i);r.textureUpdateResults=i}}e.children.forEach(this.removeNode,this);if(t){delete this._forbiddenTextureUpdate}};O.prototype.hasNode=function(e){return this._nodes.has(e._vkPersistentId())};function G(t){if(t&&t.type===w.LineBasicMaterial){return t}var r=new e.LineBasicMaterial({color:16711680,linewidth:1});if(t){r.color.copy(t.color);r.specularMap=t.specularMap;r.userData.materialId=t.userData.materialId}return r}O.prototype.getChildNodeIds=function(e,t,r){this._resetCurrentScene(t);var a=this._nodes.get(e);var i=[];if(!a){return i}if(a&&a.children){for(var n=0;n<a.children.length;n++){var s=a.children[n];if(s.userData.treeNode&&s.userData.treeNode.sid){i.push(s.userData.treeNode.sid)}else if(r&&s.userData.submeshInfo&&s.userData.submeshInfo.id){i.push(s.userData.submeshInfo.id)}}}return i};function U(e){for(var t=0;t<e.length;t++){if(e[t].type==="box"&&e[t].data){return e[t]}}return null}function q(e){if(Array.isArray(e)){for(var t=0;t<e.length;t++){if(e[t].type===undefined||e[t].type==="mesh"||e[t].type==="line"){return e[t]}}}return null}O.prototype._addGeometryToCluster=function(t,r,a,i,n,s,o,d,u){var l=this._vkScene.getSceneRef().userData;var c=65536;var h=3*c;var p=r.length/3;var f=n.length;var m=!s&&(i&&i.length===p*2);var v=o+":"+(s?"l":"t")+(m?"u":"n")+u;if(!l.currentClusters){l.currentClusters=new Map}var g=this._preprocessedSubmeshToClusterMap?this._preprocessedSubmeshToClusterMap.get(d):-1;var y=g>=0?this._preprocessedClusterDefinitions[g]:null;if(y){v="pre"+g;c=y.verts;h=y.elems*(s?2:3)}var _=y?y.cluster:l.currentClusters.get(v);if(!_||_.freeVertices<p||_.freeIndices<f){_=new e.BufferGeometry;if(y){y.cluster=_}else{l.currentClusters.set(v,_)}if(u>1){_.userData.renderInstanceCount=u}_.freeVertices=c;_.freeIndices=h;_.instanceIndices=[];_.userData.geometryUsed=0;_.setIndex(new e.BufferAttribute(new Uint16Array(h),1));_.setAttribute("position",new e.BufferAttribute(new Float32Array(c*3),3));_.setAttribute("clusterInstance",new e.BufferAttribute(new Float32Array(c),1));if(s){_.userData.isPolyline=true}else{_.setAttribute("normal",new e.BufferAttribute(new Float32Array(c*3),3))}if(m){_.setAttribute("uv",new e.BufferAttribute(new Float32Array(c*2),2))}var I=this._getMaterialRef(o);var b=s?new e.LineSegments(_,G(I)):new e.Mesh(_,I);if(l.geometryClusters){l.geometryClusters.push(b)}else{l.geometryClusters=[b];l.currentInstanceIndex=0}b.userData.isGeometryCluster=true;_.userData.clusterIndex=l.geometryClusters.length-1}var S=c-_.freeVertices;k.updateClusterAttrib(_,"position",S*3,r);var w=_.getAttribute("clusterInstance");w.array.fill(l.currentInstanceIndex,S,S+p);if(w.updateRange.count<0){w.updateRange.offset=S;w.updateRange.count=p}else{w.updateRange.count+=p}w.needsUpdate=true;if(!s){if(!a||a.length!==r.length){a=W(r,n)}k.updateClusterAttrib(_,"normal",S*3,a)}if(m){k.updateClusterAttrib(_,"uv",S*2,i)}var D=h-_.freeIndices;k.updateClusterIndices(_,n,S,D,f);_.freeVertices-=p;_.freeIndices-=f;_.drawRange.count=D+f;_.instanceIndices.push(l.currentInstanceIndex);if(t){_.boundingBox=e.Box3.newFromPackedArray(t)}else{_.computeBoundingBox(S,S+p)}_.computeBoundingSphere(S,S+p,true);var T={geometry:_,vertexStart:S,vertexCount:p,indexStart:D,indexCount:f,boundingBox:_.boundingBox,boundingSphere:_.boundingSphere};_.boundingBox=null;_.boundingSphere=null;return T};function F(e,t){var r=e.boundingBox.min;var a=e.boundingBox.max;var i=e.boundingSphere;return{firstVertex:e.vertexStart,lastVertex:e.vertexStart+e.vertexCount,start:e.indexStart,count:e.indexCount,instanceIndex:t,clusterIndex:e.geometry.userData.clusterIndex,boundingBox:[r.x,r.y,r.z,a.x,a.y,a.z],boundingSphere:[i.center.x,i.center.y,i.center.z,i.radius]}}O.prototype._cloneSubmesh=function(t,r){var i=t instanceof e.Mesh?t._vkClone():t.clone();if(r.userData.transformType==="ORTHO2D"){i.position.setScalar(0);i.scale.setScalar(1)}i.userData.skipIt=true;i.renderOrder=r.renderOrder;if(r.userData.materialId){k.disposeMaterial(i.material);i.material=this._getMaterialRef(r.userData.materialId)||t.material;i.userData.materialId=r.userData.materialId;a.pushElementIntoMapArray(this._materialMeshes,r.userData.materialId,t.userData.meshId)}return i};O.prototype.preprocessMeshes=function(e){if(this._preprocessedSubmeshToClusterMap){return}this._preprocessedClusterDefinitions=[];this._preprocessedSubmeshToClusterMap=new Map;var r=performance.now();var i=new Set;var n=new Map;var s=0,o=0,d=0;var u=0,l=0;var c=0,h=0,p=0;var f,m,v,g,y,_,I,b,S;var w,D,T;var M,x;var C,A;for(var N=0,R=e.length;N<R;++N){f=e[N];m=f.id;if(i.has(m)){continue}i.add(m);C=this._meshNodes.get(m);A=C?C.length:0;d+=A;if(A===0){o++;continue}s++;v=f.submeshes;for(g=0,y=v.length;g<y;++g){_=v[g];I=_.materialId;b=q(_.lods);S=!b?null:b.id;if(S==null){continue}w=b.pointCount;D=b.elementCount;T=b.flags;if(w>0&&D>0&&T!=null){M=(T&1)>0;x=(T&4)>0;u++;c+=w;if(M){p+=D}else{h+=D}a.pushElementIntoMapArray(n,I+":"+(M?"l":"t")+(x?"u":"n")+A,{submesh:_.id,verts:w,elems:D})}else{l++}}}n.forEach(function(e){k.partitionCluster(e,this._preprocessedClusterDefinitions,this._preprocessedSubmeshToClusterMap)},this);this._isSmallScene=u<2e3&&c<1e6;t.info(n.size+" unique cluster types detected in "+(performance.now()-r).toFixed(1)+"ms.  "+"Scene classification: "+(this._isSmallScene?"small.  ":"large.  ")+s+" meshes ("+o+" undefined).  "+d+" mesh instances.  "+(d/s).toFixed(1)+"X instancing.  "+u+" geometries ("+l+" undefined).  "+c.toLocaleString()+" vertices.  "+h.toLocaleString()+" triangles.  "+p.toLocaleString()+" lines.")};O.prototype.setSubmeshes=function(e){this.preprocessMeshes(e);var t,r,a,i,n;for(var s=0,o=e.length;s<o;++s){t=e[s];r=t.submeshes;for(i=0,n=r.length;i<n;++i){a=r[i];this.insertSubmesh(a)}}};O.prototype.insertSubmesh=function(t,r){var i=this._getMaterialRef(t.materialId)||this._createTemporaryMaterial(t.materialId);var n=t.id;var s=q(t.lods);if(!s){return false}var o=s.pointCount;var d=s.elementCount;var u=o>0&&d>0;var l=s.id;var c=s.flags;var h=s.boundingBox;var p=this._meshNodes.get(t.meshId);var f=null;var m;var v=p?p.length:0;if(!h){var g=new e.BufferGeometry;var y=new e.BufferAttribute(new Uint16Array(0),1);var _=new e.BufferAttribute(new Float32Array(0),3);g.setIndex(y);g.setAttribute("position",_);m=new e.Mesh(g,i)}else if(c!=null&&(c&1)>0&&u){var I=k.buildEmptyMesh(h,c,o,d);f=this._addGeometryToCluster(h,I.points,undefined,undefined,I.indices,true,t.materialId,n,v);m=new e.LineSegments(f.geometry,i)}else{var b=U(t.lods);var S=b?a.base64ToUint8Array(b.data):null;if(this._isSmallScene==null){this._isSmallScene=this._meshNodes.size<2e3&&this._nodes.size<5e3}var w=!S;var D=!u||v<1;var T=u&&(o<24||d<12);if(T&&this._isSmallScene){D=true;T=false}var M=1;if(D){M=-1}else if(this._isSmallScene||w){M=0}if(c==null){c=2}var x=T?k.buildEmptyMesh(h,c,o,d):k.buildTemporaryMesh(h,c,o,d,S,w,M);if(D||x.points.length>o*3||x.indices.length>d*3){var C=new e.BufferGeometry;var A=new e.BufferAttribute(x.indices,1);var N=new e.BufferAttribute(x.points,3);var R=new e.BufferAttribute(x.normals,3);C.setIndex(A);C.setAttribute("position",N);C.setAttribute("normal",R);C.boundingBox=e.Box3.newFromPackedArray(h);m=new e.Mesh(C,i)}else{f=this._addGeometryToCluster(h,x.points,x.normals,x.uvs,x.indices,false,t.materialId,n,v);m=new e.Mesh(f.geometry,i)}}m.userData.geometryId=l;m.userData.lodInfo=s;if(t.transform){m.applyMatrix4(E(t.transform))}m.updateMatrixWorld(true);m.userData.submeshId=n;m.userData.initialMaterialId=t.materialId;m.userData.meshId=t.meshId;m.userData.materialId=t.materialId;m.userData.submeshInfo=t;a.pushElementIntoMapArray(this._materialMeshes,t.materialId,t.meshId);var V=a.pushElementIntoMapArray(this._meshSubmeshes,t.meshId,m)-1;if(f){a.pushElementIntoMapArray(this._geometries,s.id,f)}else{a.pushElementIntoMapArray(this._geometryProxies,s.id,{meshId:t.meshId,submeshId:n,submeshIndex:V,materialId:t.materialId})}if(p){var O=this._vkScene.getSceneRef().userData;p.forEach(function(t){var r=this._cloneSubmesh(m,t);if(r.material&&t.userData&&t.userData.geometryType&&(t.userData.geometryType==="PLANE"||t.userData.geometryType==="SURFACE")){r.material.side=e.DoubleSide;if(this._vkScene.getDoubleSided()){if(!r.material.userData){r.material.userData={}}r.material.userData.originalMaterialSide=e.DoubleSide}}if(f){r.userData.renderGroup=F(f,O.currentInstanceIndex);k.increaseCurrentInstance(O)}this._geometrySubmeshIndices.set(t.userData.nodeId+":"+l,t.children.length);t.add(r);r.updateMatrixWorld(true);z(r,this._materialClones)},this)}return true};function H(a,i,n,s,o,d){var u=s.geometry;var l=a[i];if(!l||l.userData.geometryId!==n){t.error("Invalid submesh index in replaceSubmeshGeometry");return}if(l.geometry!==u){var c=F(s,o.currentInstanceIndex);if(d){k.increaseCurrentInstance(o)}if(l.isMesh&&!u.userData.isPolyline){if(l.geometry){k.disposeGeometry(l)}l.geometry=u;l.userData.renderGroup=c;l.updateMatrixWorld(true);r.increaseGeometryUsed(u)}else{var h=new e.LineSegments(u,l.material);r.increaseGeometryUsed(u);h.position.copy(l.position);h.quaternion.copy(l.quaternion);h.scale.copy(l.scale);h.matrix.copy(l.matrix);h.updateMatrixWorld(true);h.userData=l.userData;h.userData.renderGroup=c;h.renderOrder=l.renderOrder;h.parent=l.parent;a[i]=h;l.parent=null}}}O.prototype._setSubmeshMaterial=function(e,t,i){r.increaseMaterialUsed(t);e.material=t;e.userData.materialId=i;delete e.userData.originalMaterial;e._vkUpdateMaterialOpacity();if(e.material!==t){a.pushElementIntoMapArray(this._materialClones,i,e.material)}};O.prototype._updateMaterial=function(e,t,r){e.children.forEach(function(e){if(e.material&&e.userData.materialId===t){this._setSubmeshMaterial(e,r,t)}},this)};O.prototype._updateMeshSubmeshesMaterial=function(e,t,r){var a=this._meshSubmeshes.get(e);if(a){a.forEach(function(e){if(e.material&&e.material.userData.materialId===t){e.material=r}})}};function z(e,t){if(e.material){var r=e.material;e._vkUpdateMaterialOpacity();if(e.material!==r){a.pushElementIntoMapArray(t,e.material.userData.materialId,e.material)}}}function W(t,r){var a=new Float32Array(t.length);var i=new e.Vector3;var n=new e.Vector3;var s=new e.Vector3;var o=new e.Vector3;var d,u;for(d=0,u=r.length;d<u;d+=3){var l=[r[d]*3,r[d+1]*3,r[d+2]*3];i.fromArray(t,l[0]);n.fromArray(t,l[1]).sub(i);s.fromArray(t,l[2]).sub(i);o.crossVectors(n,s).normalize();for(var c=0;c<3;c++){var h=l[c];a[h]+=o.x;a[h+1]+=o.y;a[h+2]+=o.z}}for(d=0,u=a.length;d<u;d+=3){o.fromArray(a,d).normalize().toArray(a,d)}return a}O.prototype.setGeometry=function(e){var r=e.id;var i=e.data;var n=this._geometries.get(r);if(n){n.forEach(function(e){if(!k.updateClusterGeometry(e,i.points,i.normals,i.uvs,i.indices)){t.error("Invalid geometry in setGeometry")}})}var s=this._geometryProxies.get(r);if(s){var o=0;s.forEach(function(e){var t=this._meshNodes.get(e.meshId);if(t){o+=t.length}},this);if(o<1){o=1}var d=this._vkScene.getSceneRef().userData;s.forEach(function(t){var n=this._addGeometryToCluster(null,i.points,i.normals,i.uvs,i.indices,e.isPolyline,t.materialId,o);a.pushElementIntoMapArray(this._geometries,r,n);var s=t.meshId;var u=this._meshNodes.get(s);if(u){for(var l=0;l<u.length;l++){H(u[l].children,this._geometrySubmeshIndices.get(u[l].userData.nodeId+":"+r),r,n,d,true)}}var c=this._meshSubmeshes.get(s);if(c){H(c,t.submeshIndex,r,n,d,false)}},this);this._geometryProxies.delete(r)}if(this._fireSceneUpdated){this._fireSceneUpdated()}return this};O.prototype.setMeshNode=function(e,t){var r=this._nodes.get(e);if(r){a.pushElementIntoMapArray(this._meshNodes,t,r);var i=this._meshSubmeshes.get(t);if(i){i.forEach(function(e){var t=this._cloneSubmesh(e,r);var a=this._geometries.get(e.userData.geometryId);if(a){t.userData.renderGroup=F(a[0],null)}this._geometrySubmeshIndices.set(r.userData.nodeId+":"+e.userData.geometryId,r.children.length);r.add(t);z(t,this._materialClones)},this)}}};O.prototype.setParametricNode=function(e,t,r){var a=this._nodes.get(e);if(a){a.userData.parametricVisible=r!==undefined?r:true}};O.prototype.progress=function(e){t.log("reading progress:",e)};O.prototype.loadingFinished=function(e){if(this._fireLoadingFinished){this._fireLoadingFinished(e)}};O.prototype.getGeometry=function(e){var t=this._geometries.get(e);return t?t[0].geometry:null};var j={rect:p.RectangularShape,circle:p.CircularShape,none:p.None,textGlow:p.TextGlow};var K={none:f.None,solid:f.Solid,dash:f.Dash,dot:f.Dot,dashdot:f.DashDot,dashdotdot:f.DashDotDot};var Y={left:m.Left,center:m.Center,right:m.Right};var J={none:v.None,point:v.Point,arrow:v.Arrow};var X=new e.Color;function Z(t){var r=new e.Matrix4;var a=new e.Matrix4;var i=t;while(i&&i.userData.originalTransform){N(i.userData.transformType==="ORTHO2D");var n=i.userData.originalTransform;r.compose(n.p,n.q,n.s);a.premultiply(r);i=i.parent}a.decompose(t.position,t.quaternion,t.scale)}O.prototype.createAnnotation=function(r,a){this._resetCurrentScene(a);var i=this._nodes.get(r.nodeId);if(!i){t.warning("Annotation node not found",r);return}if(i.userData.originalTransform){Z(i)}var n=r.type;if(n===undefined){this.createLegacyAnnotation(r,i);return}i.userData.annotationType=n;if(n==="html"){r.id=r.id||A();var s=[];if(r.leaderLines){r.leaderLines.forEach(function(e){if(e.start&&e.start.sid){s.push(this._nodes.get(e.start.sid))}},this)}this._vkScene._addAnnotation(r.id,{annotation:r,node:i,attachment:r.attachment&&r.attachment.sid?this._nodes.get(r.attachment.sid):null,targetNodes:s});return}var o=r.label||{};var d=r.text||{};var c=o.colour||[1,1,1,1];var m=o.borderColour||[0,0,0,1];var v={node:i,renderOrder:i.renderOrder||0,style:j[o.shape]||p.RectangularShape,width:o.width||64,height:o.height||64,backgroundColor:X.fromArray(c).getStyle(),backgroundOpacity:c[3],borderColor:X.fromArray(m).getStyle(),borderOpacity:m[3],borderWidth:o.borderColour?o.borderWidth||0:0,borderLineStyle:K[o.borderLineStyle]||f.Solid,horizontalAlignment:Y[d.align]};if(d.html){v.encoding=h.HtmlText;v.text=d.html}else{v.encoding=h.PlainText;v.text=d.text;v.font=d.fontFace||"Arial";v.fontSize=Math.abs(d.fontSize)||16;v.fontWeight=Math.min(d.fontWeight,900);v.fontItalic=d.fontItalic;v.textColor=X.fromArray(d.colour||[0,0,0]).getStyle()}if(n==="text"){var g=i.position;v.position=new e.Vector3(g.x*2,g.y*2,g.z);var y=new u(v);y.setText(v.text);this._addDynamicObject(i,y._update.bind(y),true)}else if(n==="note"){var _=r.attachment||{};v.position=(new e.Vector3).fromArray(_.position||[0,0,0]);v.anchorNode=this._nodes.get(_.sid)||this._rootNode;v.depthTest=false;var I=new l(v);I.setText(v.text);this._callouts.set(r.id,I);this._addDynamicObject(i,I._update.bind(I),false)}else{t.warning("Unsupported annotation type",r)}};var Q=[p.RectangularShape,p.CircularShape,p.None,p.TextGlow];var $=[c.Viewport,c.Screen,c.World];var ee=[f.None,f.Solid,f.Dash,f.Dot,f.DashDot,f.DashDotDot];var te=[v.None,v.Point,v.Arrow];var re=[m.Left,m.Center,m.Right];function ae(e){var t=e.toString(16);if(e.length>=3){t=(e[0]*255<<16|e[1]*255<<8|e[2]*255).toString(16)}return"#"+"000000".substring(t.length)+t}function ie(e){if(!e){return false}for(var t=0,r=e.length;t<r;t++){if(!isFinite(e[t])){return false}}return true}O.prototype.createLegacyAnnotation=function(r,a){var i=r.position;if(!ie(i)){t.warning("Incorrect annotation position",r);return}r.coordinateSpace|=0;var n=r.backgroundOpacity;if(!n){n=r.backgroundColour?r.backgroundColour[3]:0}var s=r.borderOpacity;if(!s){s=r.borderColour?r.borderColour[3]:0}var o={node:a,coordinateSpace:$[r.coordinateSpace],style:Q[r.shape||0],width:r.width,height:r.height,backgroundColor:r.backgroundColour?ae(r.backgroundColour):"#fff",backgroundOpacity:n,borderColor:r.borderColour?ae(r.borderColour):"#000",borderOpacity:s,borderWidth:r.borderWidth,borderLineStyle:ee[r.borderLineStyle]};if(r.encoding!==undefined){o.encoding=r.encoding?h.HtmlText:h.PlainText;o.font=r.font;o.fontSize=r.fontSize;o.fontWeight=Math.min(r.fontWeight,900);o.fontItalic=r.fontItalic;o.textColor=ae(r.textColour);o.link=r.link;o.horizontalAlignment=re[r.textHorizontalAlignment];o.position=(new e.Vector3).fromArray(i)}else if(r.fontFace){o.encoding=h.PlainText;o.font=r.fontFace;o.fontSize=Math.abs(r.fontSize);o.fontWeight=Math.min(r.fontWeight,900);o.textColor=ae(r.textColour)}else{o.encoding=h.HtmlText}if(r.coordinateSpace<2){if(!o.positions){o.position=new e.Vector3(i[0]*2-1,i[1]*-2+1,i[2])}o.renderOrder=(r.order|0)+1e3;var d=new u(o);d.setText(r.text);this._addDynamicObject(a,d._update.bind(d),true)}else{o.anchorNode=this._nodes.get(r.sid)||this._rootNode;if(!o.position){o.position=(new e.Vector3).fromArray(i)}o.depthTest=false;o.renderOrder=r.order|0;if(r.alwaysOnTop){o.renderOrder=1}var c=new l(o);c.setText(r.text);this._callouts.set(r.id,c);this._addDynamicObject(a,c._update.bind(c),false)}};function ne(e){while(e){if(e.userData.transformType){return e.userData.transformType}e=e.parent}}O.prototype.createImageNote=function(r,a){this._resetCurrentScene(a);var i=this._nodes.get(r.nodeId);if(!i){t.warning("Image annotation node not found",r);return}if(i.userData.originalTransform){Z(i)}if(r.type==="image"){var n=r.label||{};var s=n.materialId;var o=this._getMaterialRef(s);if(!o){t.warning("Image annotation material not found",r);return}if(n.projection==="spherical"){i.position.setScalar(0);i.scale.setScalar(1);n.width=-1;n.height=-1;i.userData.transformType="LOCK_TOVIEWPORT";i.userData.renderStage=-1;var d=o;o=new D({upAxis:this._upAxis,map:d.map,color:d.color});o.userData=d.userData;this._vkScene.getMaterial(s)._nativeMaterial=o}o.depthTest=false;o.depthWrite=false;o.blending=e.CustomBlending;o.side=e.DoubleSide;if(i.userData.renderStage===undefined){if(r.order){i.userData.renderStage=Math.sign(r.order)}else if(r.order===undefined&&ne(i)!==undefined){i.userData.renderStage=1}}switch(i.userData.transformType){case"ORTHO2D":case"LOCK_TOVIEWPORT":var l=new u({node:i,renderOrder:i.renderOrder||0,coordinateSpace:c.Screen,position:new e.Vector3(i.position.x,i.position.y,0),width:(n.width||200)*i.scale.x*.5,height:(n.height||200)*i.scale.y*.5});l.setMaterial(o);i.position.setScalar(0);i.scale.setScalar(1);this._addDynamicObject(i,l._update.bind(l),true);break;case"BILLBOARD_VIEW":default:var h=new e.Mesh(u.prototype._planeGeometry,o);h.scale.set(n.width,n.height,1);h.updateMatrix();i.add(h);break}}else{this.createLegacyImageNote(r,i)}};O.prototype.createLegacyImageNote=function(t,r){var a=(new e.Vector3).fromArray(t.position);var i=t.width;var n=t.height;if(!t.properlyAligned){a.x+=t.width*.5;a.y+=t.height*.5;a.applyMatrix4(r.matrix);i=t.width*.5*r.matrix.elements[0];n=t.height*.5*r.matrix.elements[5]}var s=this._getMaterialRef(t.labelMaterialId);s.depthTest=false;s.depthWrite=false;s.blending=e.CustomBlending;if(ne(r)==="LOCK_TOVIEWPORT"){var o=new u({node:r,coordinateSpace:c.Screen,renderOrder:(t.order|0)+1e3,position:a,width:i,height:n});o.setMaterial(s);this._addDynamicObject(r,o._update.bind(o),true)}else{var d=new e.Mesh(u.prototype._planeGeometry,s);d.renderOrder=(t.order|0)+1e3;d.position.copy(a);d.scale.set(i*2,n*2,1);d.updateMatrix();r.add(d);r.scale.setScalar(1);r.updateMatrix()}};O.prototype.insertLeaderLine=function(r,a){this._resetCurrentScene(a);var i=this._callouts.get(r.annotationId);if(i){var n=this._getMaterialRef(r.materialId);if(!n){t.warning("Leader line material not found",r);return}var s=[];var o=r.points;for(var d=0,u=o.length;d<u;d++){s.push((new e.Vector3).fromArray(o[d]))}var l;if(r.start){var c=r.start||{};var h=r.end||{};var p=r.extension||{};l=this._nodes.get(r.start.sid)||this._rootNode;i.addLeaderLine(s,l,n,J[c.style]||v.None,J[h.style]||v.None,c.size,p.length||0)}else{l=this._nodes.get(r.startPointSid)||this._rootNode;i.addLeaderLine(s,l,n,te[r.startPointHeadStyle],te[r.endPointHeadStyle],r.pointHeadConstant,r.extensionLength)}}};O.prototype._findDetailViewNodes=function(e){var r=[];if(e){e.forEach(function(e){var a=this._nodes.get(e);if(a){r.push(a)}else{t.warning("Unknown detailView node reference",e)}},this)}return r};O.prototype.createDetailView=function(r,a){this._resetCurrentScene(a);var i=this._nodes.get(r.nodeId);if(!i){t.warning("Detail view node not found",r);return}var n=r.label;if(!n){this.createLegacyDetailView(r,i);return}var o=r.attachment;var d={name:r.name,camera:n.camera?this.createCamera(n.camera):null,type:r.cutaway?g.Cutaway:g.DetailView,borderWidth:n.borderWidth||0,backgroundColor:X.fromArray(n.colour||[1,1,1]).getStyle(),borderColor:X.fromArray(n.borderColour||[1,1,1]).getStyle(),origin:new e.Vector2(i.position.x*2-1+i.scale.x,i.position.y*-2+1-i.scale.x),size:new e.Vector2(i.scale.x,i.scale.y),attachmentPoint:(new e.Vector3).fromArray(o.position||[0,0,0]),veId:r.veid,visibleNodes:this._findDetailViewNodes(r.visibleNodes),targetNodes:this._findDetailViewNodes(r.targetNodes)};if(n.shape==="rect"){d.shape=!n.leaderStyle||n.leaderStyle==="none"?y.Box:y.BoxLine}else{d.shape={none:y.Circle,line:y.CircleLine,pointer:y.CirclePointer,arrow:y.CircleArrow,bubbles:y.CircleBubbles}[n.leaderStyle]||y.Circle}var u=new s(d);if(!this._rootNode.userData._vkDetailViews){this._rootNode.userData._vkDetailViews=[]}this._rootNode.userData._vkDetailViews.push({detailView:u,node:i,renderOrder:r.renderOrder||i.renderOrder||0})};O.prototype.createLegacyDetailView=function(t,r){if(!t.properlyAligned){if(!t.shape){t.shape=t.leaderStyle?y.BoxLine:y.Box}else{t.shape=[y.Circle,y.CircleLine,y.CirclePointer,y.CircleArrow,y.CircleBubbles][t.leaderStyle||0]}t.type=t.cutaway?g.Cutaway:g.DetailView;t.camera=t.camera?this.createCamera(t.camera):null;t.origin=new e.Vector2(r.position.x*2-1+r.scale.x,r.position.y*-2+1-r.scale.x);t.size=new e.Vector2(r.scale.x,r.scale.y);t.renderOrder=r.renderOrder}else{t.type=[g.DetailView,g.Cutaway][t.type];t.shape=[y.Box,y.Circle,y.CircleLine,y.CirclePointer,y.CircleArrow,y.CircleBubbles,y.BoxLine,y.BoxNoOutline,y.SolidPointer,y.SolidArrow][t.shape];t.camera=this._cameras.get(t.cameraId);t.origin=(new e.Vector2).fromArray(t.origin);t.size=(new e.Vector2).fromArray(t.size)}var a=new s({name:t.name,camera:t.camera,type:t.type,shape:t.shape,borderWidth:t.borderWidth||0,backgroundColor:t.backgroundColour?ae(t.backgroundColour):"#fff",borderColor:t.borderColour?ae(t.borderColour):"#000",origin:t.origin,size:t.size,attachmentPoint:(new e.Vector3).fromArray(t.attachment),metadata:t.metadata,veId:t.veid,visibleNodes:this._findDetailViewNodes(t.visibleNodes),targetNodes:this._findDetailViewNodes(t.targetNodes)});if(!this._rootNode.userData._vkDetailViews){this._rootNode.userData._vkDetailViews=[]}this._rootNode.userData._vkDetailViews.push({detailView:a,node:r,renderOrder:t.renderOrder||0})};O.prototype.insertThrustline=function(t){var r=this._nodes.get(t.thrustlineId);if(r&&!this._thrustlines.get(t.thrustlineId)){var a=new d({node:r,principleAxis:(new e.Vector3).fromArray(t.principleAxis),material:this._getMaterialRef(t.materialId)});var i=[];var n=0;var s=0;var o=0;for(var u=0;u<t.itemCount;u++){var l={};l.target=this._nodes.get(t.targets[u]);l.majorAxisIndex=t.itemMajorAxisesIndices[u];var c;l.basisAxises=[];o=n+t.itemBasisAxisesCounts[u];for(c=n;c<o;c++){var h={};h.x=t.itemBasisAxisesCoordinates[c*3];h.y=t.itemBasisAxisesCoordinates[c*3+1];h.z=t.itemBasisAxisesCoordinates[c*3+2];l.basisAxises.push(h)}n=o;l.dimension={};l.dimension.x=t.itemDimensionsCoordinates[u*3];l.dimension.y=t.itemDimensionsCoordinates[u*3+1];l.dimension.z=t.itemDimensionsCoordinates[u*3+2];l.center={};l.center.x=t.itemCentersCoordinates[u*3];l.center.y=t.itemCentersCoordinates[u*3+1];l.center.z=t.itemCentersCoordinates[u*3+2];l.boundPoints=[];o=s+t.itemBoundPointsCounts[u];for(c=s;c<o;c++){var p={};p.x=t.itemBoundPointsCoordinates[c*3];p.y=t.itemBoundPointsCoordinates[c*3+1];p.z=t.itemBoundPointsCoordinates[c*3+2];l.boundPoints.push(p)}s=o;i.push(l)}a.setItems(i);var f=0;var m=[];for(var v=0;v<t.segmentCount;v++){var g={};g.startItemIndex=t.segmentsStartItemIndices[v];g.endItemIndex=t.segmentsEndItemIndices[v];g.startBoundIndex=t.segmentsStartBoundIndices[v];g.endBoundIndex=t.segmentsEndBoundIndices[v];g.ratios=[];o=f+t.segmentRatioCounts[v];for(var y=0;y<o;y++){var _={};_.x=t.segmentRatiosCoordinates[y*2];_.y=t.segmentRatiosCoordinates[y*2+1];g.ratios.push(_)}f=o;m.push(g)}a.setSegments(m);this._thrustlines.set(t.thrustlineId,a);this._addDynamicObject(r,a._update.bind(a),false)}};O.prototype.updateViewsForReplacedNodes=function(e){var t=new Map;e.forEach(function(e){var r=this._nodes.get(e.sid);if(r){t.set(e.sid,r)}},this);function r(e,t){var r=e.getNodeInfos();r.forEach(function(e){var r=e.target;if(r&&r.userData&&r.userData.treeNode&&r.userData.treeNode.sid){var a=t.get(r.userData.treeNode.sid);if(a){e.target=a;a.updateMatrixWorld()}}})}function a(t,r){var a;var i=t.getPlaybacks();for(var n=0;n<i.length;n++){var s=i[n];var o=s.getSequence();if(o){var d=false;var u=o.getNodeAnimation();for(var l=0;l<u.length;l++){var c=u[l];var h=c.nodeRef;if(h&&h.userData&&h.userData.treeNode&&h.userData.treeNode.sid){a=r.get(h.userData.treeNode.sid);if(a){o.removeNodeAnimation(h,null,true);for(var p in c){if(p==="nodeRef"){continue}o.setNodeAnimation(a,p,c[p],true)}d=true}}}var f=o.getJoint();for(var m=0;f&&m<f.length;m++){var v=f[m];if(v.parentSid){a=r.get(v.parentSid);if(a){v.parent=a;d=true}}if(v.nodeSid){a=r.get(v.nodeSid);if(a){v.node=a;d=true}}}if(d){o._fireSequenceChanged()}}}e.forEach(function(e){var t=e.target;if(t&&t.userData&&t.userData.treeNode&&t.userData.treeNode.sid){var a=r.get(t.userData.treeNode.sid);if(a){e.target=a;a.updateMatrixWorld()}}})}this._views.forEach(function(e,i){r(e,t);a(e,t)})};O.prototype._decrementResourceCounters=function(e){e.traverse(function(e){if(e.isMesh){r.decreaseMaterialUsed(e.material);r.decreaseGeometryUsed(e.geometry)}})};O.prototype.decrementResourceCountersForDeletedTreeNode=function(e,t){this._resetCurrentScene(t);var r=this;e=[].concat(e);e.forEach(function(e){var t=r._nodes.get(e);if(t){r._decrementResourceCounters(t);r._nodes.delete(e)}});return this};O.prototype.remove=function(e,t){this._resetCurrentScene(t);var r=this;e=[].concat(e);e.forEach(function(e){var a=r._nodes.get(e);if(a){r._decrementResourceCounters(a);if(a.parent){a.parent.remove(a)}r._nodes.delete(e);var i=false;if(!r._forbiddenTextureUpdate){r._forbiddenTextureUpdate=true;i=true;var n=r._vkScene.getSceneRef().userData;if(n.instanceDataTexture){var s=n.geometryClusters;var o=k.prepareTextureUpdateResults(s?s.length:0,n.textureUpdateResults);k.removeNodeFromClusterRenderingRecursive(a,n.instanceDataTexture.image.data,o);n.textureUpdateResults=o}}for(var d=0;d<a.children.length;d++){var u=a.children[d];if(u.userData&&u.userData.treeNode&&u.userData.treeNode.sid){r.remove(u.userData.treeNode.sid,t)}}if(i){delete r._forbiddenTextureUpdate}}});return this};O.prototype.resourcesCleanUp=function(){var e=this._geometries;e.forEach(function(e){e.forEach(function(e){var t=e.geometry.userData.geometryUsed;if(t<=0){e.dispose()}})});return this};O.prototype.createCamera=function(t,r){this._resetCurrentScene(r);var a=t.near||1;var s=t.far||2e5;if(t.origin.length===3&&t.origin[0]===0&&t.origin[1]===0&&t.origin[2]===0){t.ortho=false;t.rotate=true}var o;if(t.ortho){o=new e.OrthographicCamera(-1,1,1,-1,a,s);o.zoom=t.zoom||-1}else{o=new e.PerspectiveCamera(e.MathUtils.radToDeg(t.fov),1,a,s)}if(t.origin){o.position.fromArray(t.origin)}if(t.up){o.up.fromArray(t.up);if(t.notUseDirectionVector){o.up.sub(o.position)}o.up.normalize()}if(t.rotate){o.userData.rotate=t.rotate;o.up.set(0,1,0)}if(t.target){var d=(new e.Vector3).fromArray(t.target);if(!t.notUseDirectionVector){d.add(o.position)}o.lookAt(d)}this._rootNode.userData.camera=o;var u=null;if(o.isOrthographicCamera){u=new i}else if(o.isPerspectiveCamera){u=new n}u.setCameraRef(o);u.setUsingDefaultClipPlanes(true);var l=t.id;if(l){this._cameras.set(l,u)}this._rootNode.userData.camera=u;return u};O.prototype.insertCamera=function(e,t,r){this._resetCurrentScene(r);var a=this._nodes.get(e);var i=this._cameras.get(t);var n=i&&i.getCameraRef();if(a&&n){(a||this._rootNode).add(n.parent?n.clone():n)}return this};O.prototype.getCamera=function(e){return this._cameras.get(e)};O.prototype.updateMaterialForGeometryWithoutNormal=function(t){var r=this._getMaterialRef(t);if(r&&r.emissive){r.emissive.copy(r.color);r.side=e.DoubleSide;if(this._vkScene.getDoubleSided()){if(!r.userData){r.userData={}}r.userData.originalMaterialSide=e.DoubleSide}}return this};O.prototype.createMaterial=function(t){var r=[];var i=t.id;var n=this._getMaterialRef(i);var s;if(t.lineWidth>0){if(!n||!n.isLineBasicMaterial){s=new S(w.LineBasicMaterial);n=s.getMaterialRef();this._vkScene.setMaterial(i,s)}n.color=new e.Color(t.lineColour[0],t.lineColour[1],t.lineColour[2]);n.linewidth=t.lineWidth;n.userData.lineStyle={width:t.lineWidth,haloWidth:t.lineHaloWidth||0,endCapStyle:t.lineEndRound?1:0,dashPattern:t.lineDashPattern||[],dashPatternScale:t.lineDashPatternScale,widthCoordinateSpace:t.lineWidthCoordinateSpace};n.userData.materialInfo=t;n.userData.materialId=i;return r}var o=null;if(t.textureEmissive){if(!n||!n.isMeshBasicMaterial){o=n;n=this._createTemporaryMaterial(i,w.MeshBasicMaterial)}}if(!n){n=this._createTemporaryMaterial(i)}delete n.userData.toBeUpdated;n.userData.materialInfo=t;if(t.diffuseColour){n.color.fromArray(t.diffuseColour)}if(t.specularColour&&n.specular){n.specular.fromArray(t.specularColour);if(t.specularLevel){n.specular.multiplyScalar(t.specularLevel)}}var d=true;if(t.emissiveColour){if(n.emissive){n.emissive.fromArray(t.emissiveColour);if(n.emissive.r!==0||n.emissive.g!==0||n.emissive.b!==0){d=false;n.depthFunc=e.LessDepth}}else{n.color.fromArray(t.emissiveColour)}}if(d&&t.ambientColour&&n.emissive){n.emissive.fromArray(t.ambientColour);n.emissive.multiplyScalar(.2)}if(t.opacity!==undefined){n.opacity=t.opacity;n.transparent=t.opacity<.99;if(n.transparent){n.side=e.DoubleSide}}var u=t.glossiness?t.glossiness:0;var l=Math.pow(2,u*10)*2;if(l<0){l=0}if(l>128){l=128}n.shininess=l;n.userData.defaultHighlightingEmissive=B;n.userData.defaultHighlightingSpecular=L;n.userData.imageIdsToAddAsTexture=new Set;var c,h;if(t.textureDiffuse){h=t.textureDiffuse;c=h[0]||h;n.userData.imageIdsToAddAsTexture.add(c.imageId)}else if(t.textureDecal){h=t.textureDecal;c=h[0]||h;n.userData.imageIdsToAddAsTexture.add(c.imageId)}if(t.textureBump){h=t.textureBump;c=h[0]||h;n.userData.imageIdsToAddAsTexture.add(c.imageId)}if(t.textureEmissive){h=t.textureEmissive;c=h[0]||h;n.userData.imageIdsToAddAsTexture.add(c.imageId)}if(t.textureAmbientOcclusion){h=t.textureAmbientOcclusion;c=h[0]||h;n.userData.imageIdsToAddAsTexture.add(c.imageId)}if(t.textureReflection){h=t.textureReflection;c=h[0]||h;n.userData.imageIdsToAddAsTexture.add(c.imageId)}if(n.userData.imageIdsToAddAsTexture.size===0){delete n.userData.imageIdsToAddAsTexture}r=this.updateTextureMaps(i);if(r.length>0){n.userData.imageIdsToLoad=new Set;for(var p=0;p<r.length;p++){var f=r[p];a.pushElementIntoMapArray(this._imageTextures,f.imageId,{textureType:f.textureType,materialId:i});n.userData.imageIdsToLoad.add(f.imageId)}}var m=this._materialMeshes.get(i);if(m){for(var v=0;v<m.length;v++){var g=m[v];var y=this._meshNodes.get(g);if(y){for(var _=0;_<y.length;_++){this._updateMaterial(y[_],i,n)}}if(o){this._updateMeshSubmeshesMaterial(g,i,n)}}}if(o){k.disposeMaterial(o)}return r};O.prototype.getMaterial=function(e){return this._getMaterialRef(e)};var se=function(e){var t="";try{var r=32768;var a=0;var i=e.length;var n;while(a<i){n=e.slice(a,Math.min(a+r,i));t+=String.fromCharCode.apply(null,n);a+=r}}catch(e){t=""}return t};O.prototype.createImage=function(e){if(e.binaryData.length<32){t.warning("SceneBuilder.createImage()","Can't create image from empty data");return this}var r=new DataView(e.binaryData.buffer);var a=true;if(r.getUint8(0,true)===parseInt("0xFF",16)&&r.getUint8(1,true)===parseInt("0xD8",16)){a=false}var i=se(e.binaryData);var n="data:image/"+(a?"png":"jpeg")+";base64,"+btoa(i);this._images.set(e.id,n);var s=this._imageTextures.get(e.id);if(s){this._imageTextures.delete(e.id);for(var o=0;o<s.length;o++){var d=s[o];this.updateTextureMap(d.materialId,d.textureType)}}return this};var oe=new e.TextureLoader;var de={Diffuse:0,Bump:1,Opacity:2,Reflection:3,Refraction:4,Specular:5,Ambient:6,Emissive:7,SpecularLevel:8,Glossiness:9,AmbientOcclusion:10,Decal:11};O.prototype.updateTextureMaps=function(e){var t=[];var r=this._getMaterialRef(e);if(!r){return t}var a=r.userData.materialInfo;if(!a){return t}if(a.textureDiffuse){var i=this.updateTextureMap(e,de.Diffuse);if(i.imageId){t.push(i)}}else if(a.textureDecal){var n=this.updateTextureMap(e,de.Decal);if(n.imageId){t.push(n)}}if(a.textureBump){var s=this.updateTextureMap(e,de.Bump);if(s.imageId){t.push(s)}}if(a.textureEmissive){var o=this.updateTextureMap(e,de.Emissive);if(o.imageId){r[r.emissive?"emissive":"color"].setRGB(1,1,1);t.push(o)}}if(a.textureAmbientOcclusion){var d=this.updateTextureMap(e,de.AmbientOcclusion);if(d.imageId){t.push(d)}}if(a.textureReflection){var u=this.updateTextureMap(e,de.Reflection);if(u.imageId){t.push(u)}}return t};O.prototype.updateTextureMap=function(t,r){var a={textureType:r,imageId:null};var i=this._getMaterialRef(t);if(!i){return a}var n=i.userData.materialInfo;if(!n){return a}var s=null;switch(r){case de.Diffuse:s=n.textureDiffuse;break;case de.Decal:s=n.textureDecal;break;case de.Bump:s=n.textureBump;break;case de.Reflection:s=n.textureReflection;break;case de.Emissive:s=n.textureEmissive;break;case de.AmbientOcclusion:s=n.textureAmbientOcclusion;break;default:break}if(!s){return a}var o=s[0]||s;var d=this._images.get(o.imageId);if(!d){a.imageId=o.imageId;return a}if(i.userData.imageIdsToLoad){i.userData.imageIdsToLoad.delete(o.imageId);if(i.userData.imageIdsToLoad.size===0){delete i.userData.imageIdsToLoad}}if(i.userData.parametricType==="sphere"){o.uvHorizontalScale=-1}var u=o.influence!==undefined?o.influence:0;function l(t,a){switch(r){case de.Diffuse:case de.Decal:t.map=a;if(d.startsWith("data:image/png")){t.transparent=true}break;case de.Bump:t.bumpMap=a;t.bumpScale=u;break;case de.Opacity:t.alphaMap=a;break;case de.Reflection:a.mapping=e.EquirectangularReflectionMapping;t.envMap=a;t.combine=e.AddOperation;t.reflectivity=u;break;case de.Emissive:t[t.emissiveMap!==undefined?"emissiveMap":"map"]=a;if(t.isSphericalMapMaterial){a.minFilter=e.LinearFilter}break;case de.AmbientOcclusion:t.aoMap=a;break;default:}t.needsUpdate=true}oe.load(d,function(r){r.wrapS=o.uvHorizontalTilingEnabled?e.RepeatWrapping:e.ClampToEdgeWrapping;r.wrapT=o.uvVerticalTilingEnabled?e.RepeatWrapping:e.ClampToEdgeWrapping;r.magFilter=o.filterMode===1?e.NearestFilter:e.LinearFilter;r.minFilter=o.filterMode===1?e.NearestFilter:e.LinearMipMapLinearFilter;r.anisotropy=4;var a=o.uvHorizontalOffset||0;var n=o.uvVerticalOffset||0;r.repeat.set(o.uvHorizontalScale||1,o.uvVerticalScale||1);r.center.set(-a,-n);r.offset.set(a,n);r.rotation=-o.uvRotationAngle;if(i.isMeshBasicMaterial){r.generateMipmaps=false;r.minFilter=o.filterMode===1?e.NearestFilter:e.LinearFilter}l(i,r);if(i.userData.imageIdsToAddAsTexture&&o.imageId){i.userData.imageIdsToAddAsTexture.delete(o.imageId);if(i.userData.imageIdsToAddAsTexture.size===0){delete i.userData.imageIdsToAddAsTexture}}var s=this._materialClones.get(t);if(s){s.forEach(function(e){l(e,r)})}this.fireImageAddedToMaterial({materialId:t});if(this._fireSceneUpdated){this._fireSceneUpdated()}}.bind(this));return a};O.prototype.insertPlayback=function(e,t,r){this._resetCurrentScene(r);var i=this._vkScene.findSequence(e.sequenceId);var n=new _(e.id,{sequence:i,timeScale:e.speed?1/e.speed:1,preDelay:e.preDelay?e.preDelay:0,postDelay:e.postDelay?e.postDelay:0,repeats:e.repeat?Math.abs(e.repeat):0,reversed:e.reversed?true:false,startTime:e.start?e.start:0});var s=this._views.get(t);if(s){s.addPlayback(n)}if(!i){a.pushElementIntoMapArray(this._sequenceIdToPlaybacks,e.sequenceId,n)}return this};O.prototype.insertSequence=function(e,t){var r=this._vkScene.findSequence(e.id);if(r){this._vkScene.removeSequence(r)}var i;if(e.endTime){if(e.startTime){i=e.endTime-e.startTime}else{i=e.endTime}}else{i=1}r=this._vkScene.createSequence(e.id,{name:e.name,duration:i});if(Array.isArray(e.joints)){e.joints.forEach(function(e){var t=this._joints[e];if(t){r.setJoint(t,true)}},this)}if(e.nodes&&e.nodes.length>0){for(var n=0;n<e.nodes.length;n++){var s=e.nodes[n];if(s.empty){s.type=s.binding;var o=this._nodes.get(s.sid);this._animationHelper.insertEmptyTrack(s,r,o,this._vkScene);continue}a.pushElementIntoMapArray(this._trackIdSequenceNodeMap,s.trackId,{sequenceId:e.id,targetId:s.sid,type:s.binding,pivot:s.pivot,isAbsoluteValue:s.isAbsoluteValue})}}var d=this._sequenceIdToPlaybacks.get(e.id);if(d){d.forEach(function(e){e.setSequence(r)})}return this};O.prototype.insertTracks=function(e){this._animationHelper.insertTracks(e,this._trackIdSequenceNodeMap,this._nodes,this._vkScene);return this};O.prototype.insertJoints=function(e,t){this._resetCurrentScene(t);this._joints=[];e.forEach(function(e){var t=this._nodes.get(e.childSid);var r=this._nodes.get(e.parentSid);var a={id:e.id,node:t,parent:r,translation:new Float32Array(e.t?e.t:[0,0,0]),quaternion:new Float32Array(e.q?e.q:[0,0,0,1]),scale:new Float32Array(e.s?e.s:[1,1,1])};if(!t){var i=this._jointNodesMap.get(e.childSid);if(!i){i=[]}i.push(a);this._jointNodesMap.set(e.childSid,i)}if(!r){var n=this._jointParentsMap.get(e.parentSid);if(!n){n=[]}n.push(a);this._jointParentsMap.set(e.parentSid,n)}this._joints.push(a)},this);return this};O.prototype.finalizeAnimation=function(){var e=this._rootNode;if(e){while(e.parent){e=e.parent}e.userData.tracks=this._tracks}return this};O.prototype.finalizePlaybacks=function(){var e=this._rootNode;if(e){while(e.parent){e=e.parent}}else{return this}if(!e.userData.animationNodeOriginalData){e.userData.animationNodeOriginalData=new Map}var t;var r=this._viewGroups.entries();var a=r.next();while(!a.done){t=a.value[1];a=r.next();var i=[];for(var n=0;n<t.getViews().length;n++){if(t.getViews()[n].id){var s=this._views.get(t.getViews()[n].id);if(s){i.push(s)}}}}return this};O.prototype.finalizeViewGroups=function(e){this._resetCurrentScene(e);var t=this._viewGroups.entries();var r=t.next();while(!r.done){var a=r.value[1];var i=r.value[0];if(!a||!a.views||!a.views.length){r=t.next();continue}a.removeViews();for(var n=0;n<a.views.length;n++){var s=a.views[n].id;var o=this._views.get(s);if(o&&o.userData.viewInfo.thumbnailId&&!o.thumbnailData){var d=this._images.get(o.userData.viewInfo.thumbnailId);if(d){o.thumbnailData=d}}if(o){o.viewGroupId=i;a.addView(o)}}r=t.next()}return this};O.prototype.insertViewGroup=function(e,t){this._resetCurrentScene(t);var r=this._viewGroups.get(e.id);if(!r){r=this._vkScene.createViewGroup({viewGroupId:e.id,name:e.name,description:e.description});this._viewGroups.set(e.id,r)}else{r.setViewGroupId(e.id);r.setName(e.name);r.setDescription(e.description)}r.type=e.type;r.metadata=e.metadata;r.veids=e.veids;r.views=e.views;r.sceneId=e.sceneId;return this};O.prototype.getViewGroup=function(e,t){this._resetCurrentScene(t);var r=this._viewGroups.get(e);var a=[];if(r&&r.views){for(var i=0;i<r.views.length;i++){var n=r.views[i].id;var s=this._views.get(n);if(s){a.push(s)}}}return a};var ue={turntable:C.Turntable,orbit:C.Orbit,pan:C.Pan,zoom:C.Zoom};O.prototype.insertView=function(e,t){this._resetCurrentScene(t);var r=e.description;if(r){var a=new RegExp("^<[^>]*?>");if(a.test(r)){var i=new RegExp("(^(<[^>]*?>s*)+)|((<[^>]*?>s*)+$)","g");var n=r.replace(i,"");if(!n){r=n}}r='<pre class="sapThemeVizKitViewGalleryStepDescriptionPre">'+r+"</pre>"}var s=this._views.get(e.viewId);if(s==null){s=this._vkScene.createView({viewId:e.viewId,name:e.name,description:r,aspectRatio:e.safeAreaAspectRatio,autoPlayAnimation:e.autoPlayAnimation,navigationMode:ue[e.navigationMode]||C.NoChange,dimension:e.dimension||3});this._views.set(e.viewId,s)}else{s.removePlaybacks(true);s.setName(e.name);s.setDescription(r);s.setAspectRatio(e.safeAreaAspectRatio);s.setAutoPlayAnimation(e.autoPlayAnimation);s.setNavigationMode(ue[e.navigationMode]||C.NoChange);s.setDimension(e.dimension||3)}s.userData={};s.userData.viewInfo=e;if(e.thumbnailId){var o=this._images.get(e.thumbnailId);if(o){s.thumbnailData=o}else{this._viewThumbnails.set(e.thumbnailId,s)}}if(e.animatedThumbnailId){var d=this._images.get(e.animatedThumbnailId);if(d){s.animatedThumbnailData=d;s.tileWidth=this._imageIdsAndTileWidths.get(e.animatedThumbnailId)}}if(e.cameraId){s.setCamera(this._cameras.get(e.cameraId))}s.type=e.type;s.flyToTime=e.flyToTime;s.preDelay=e.preDelay;s.postDelay=e.postDelay;s.navigationMode=e.navigationMode;var u=this._getSavedColor(e.topColour,localStorage.getItem("color.backgroundTop"));if(u!=null){s.setTopColor(u)}var l=this._getSavedColor(e.bottomColour,localStorage.getItem("color.backgroundBottom"));if(l!=null){s.setBottomColor(l)}s.renderMode=P[e.renderMethod];s.dimension=e.dimension;s.query=e.query;s.metadata=e.metadata;s.veids=e.veids;s.viewGroupId=e.viewGroupId;s.id=e.viewId;if(s.viewGroupId){var c=this._viewGroups.get(s.viewGroupId);if(c){var h=c.indexOfView(s);if(h<0){c.addView(s)}}}return this};O.prototype.setModelViewVisibilitySet=function(e){var r=this._views.get(e.viewId);var a=new Set;var i=[];e.visibleNodes.forEach(function(e){var r=this._nodes.get(e);if(r){a.add(r);i.push({target:r,visible:true})}else{t.warning("Unknown modelView visible node reference",e)}},this);Array.from(a).forEach(function(e){e=e.parent;while(e&&!a.has(e)){a.add(e);i.push({target:e,visible:true});e=e.parent}});if(r){r.updateNodeInfos(i)}};O.prototype.recordHighlightedNodeInView=function(e,t,r,a){this._resetCurrentScene(a);var i=this._views.get(r);if(!i){return this}var n=this._nodes.get(t);if(!n){return this}i.addHighlightedNodes(e,n);return this};O.prototype.insertHighlightStyle=function(e){var t=this._vkScene.getHighlight(e.id);if(t){return this}if(e.duration>0){if(e.colours&&e.colours.length===1&&(!e.opacities||e.opacities.length===1)){var r=e.colours[0];e.colours.push([r[0],r[1],r[2],0])}else if(!e.colours&&e.opacities&&e.opacities.length===1){e.opacities.push(0)}}this._vkScene.createHighlight(e.id,e);return this};O.prototype.insertModelViewHighlight=function(t){var r=this._views.get(t.viewId);if(r){var a=[];t.highlightNodes.forEach(function(e){var t=this._nodes.get(e);if(t){a.push(t)}else{}},this);var i={duration:t.duration,cycles:t.cycles};if(!t.id){t.id=e.MathUtils.generateUUID().toLowerCase()}var n=new e.Color(t.color1).toArray();var s=new e.Color(t.color2).toArray();n[3]=(t.color1>>>24&255)/255;s[3]=(t.color2>>>24&255)/255;i.colours=[n,s];i.opacities=[t.opacity1,t.opacity2];this._vkScene.createHighlight(t.id,i);r.addHighlightedNodes(t.id,a)}};O.prototype.createThumbnail=function(e){var t=this._viewThumbnails.get(e.imageId);if(t){t.thumbnailData="data:image/"+"jpeg"+";base64,"+window.btoa(String.fromCharCode.apply(null,e.data));if(this._fireThumbnailLoaded){this._fireThumbnailLoaded({modelView:t})}}};O.prototype.highlightStyleExists=function(e){var t=this._vkScene.getHighlight(e);return t!==undefined};O.prototype.getView=function(e,t){this._resetCurrentScene(t);return this._views.get(e)};O.prototype.getSequence=function(e){return this._vkScene.findSequence(e)};O.prototype.setViewCamera=function(e,t,r){this._resetCurrentScene(r);var a=this._cameras.get(e);var i=this._views.get(t);if(a&&i){i.setCamera(a)}return this};O.prototype.setViewNodeInfos=function(e,t,r){this._resetCurrentScene(r);var a=this._views.get(t);a.setNodeInfos(e);return this};O.prototype.setViewThumbnail=function(e,t,r,a){this._resetCurrentScene(r);var i=this._views.get(t);var n=this._images.get(e);if(a){this._imageIdsAndTileWidths.set(e,a)}if(i&&n){if(i.userData!==undefined){if(i.userData.viewInfo.thumbnailId===e){i.thumbnailData=n}else if(i.userData.viewInfo.animatedThumbnailId===e){i.animatedThumbnailData=n;i.tileWidth=a}}}return this};O.prototype.cleanup=function(){this._rootNode=null;this._currentSceneId=null;this._contentResource=null;this._resolve=null;this._reject=null;if(this._vkScene){this._vkScene.clearMaterials()}this._callouts.forEach(function(e){e.destroy()});this._callouts.clear();this._cameras.forEach(function(t){if(!t instanceof e.Camera){t.destroy()}});this._cameras.clear();this._images.clear();this._imageIdsAndTileWidths.clear();this._imageTextures.clear();this._geometries.clear();this._meshNodes.clear();this._meshSubmeshes.clear();this._geometryProxies.clear();this._geometrySubmeshIndices.clear();this._materialMeshes.clear();this._materialClones.clear();this._joints=[];this._imageAddedToMaterialHandlers=[];this._isSmallScene=null;this._preprocessedClusterDefinitions=null;this._preprocessedSubmeshToClusterMap=null;if(this._nodes){this._nodes.clear()}if(this._tracks){this._tracks.clear()}if(this._trackIdSequenceNodeMap){this._trackIdSequenceNodeMap.clear()}if(this._viewGroups){this._viewGroups.clear()}if(this._views){this._views.clear()}this._sceneIdTreeNodesMap.clear();this._sceneIdRootNodeMap.clear();this._viewThumbnails.clear();this._thrustlines.clear();this._animations.clear();this._animationTracks.clear();this._jointNodesMap.clear();this._jointParentsMap.clear()};O.prototype.insertAnimationGroup=function(e){var t=this._vkScene.findSequence(e.animationGroupRef.toString());if(!t){var r;if(e.endTime){r=e.endTime-e.startTime;if(!e.startTime){e.startTime=0}}t=this._vkScene.createSequence(e.animationGroupRef.toString(),{name:e.name,duration:r});if(!t.userData){t.userData={}}t.userData.animations=[]}if(e.modelViewRef){var a=this._views.get(e.modelViewRef);if(a){var i=this._vkScene.findSequence(e.animationGroupRef.toString());var n=new _({sequence:i,timeScale:e.playbackSpeed?1/e.playbackSpeed:1,preDelay:e.playbackPreDelay?e.playbackPreDelay:0,postDelay:e.playbackPostDelay?e.playbackPostDelay:0,repeat:e.playbackRepeat?Math.abs(e.playbackRepeat):0,reversed:e.playbackReversed?true:false,startTime:0});a.addPlayback(n)}}};O.prototype.insertAnimation=function(e){var t=this._animations.get(e.animationRef);if(!t){t={};t.type=e.animationType;t.targetRefs=[];t.targetPivots=[];t.sequenceId=e.animationGroupRef.toString();t.trackIds=new Set;t.tracks=[];this._animations.set(e.animationRef,t)}if(e.animationGroupRef){var r=this._vkScene.findSequence(e.animationGroupRef.toString());if(!r.userData.animations.includes(e.animationRef)){r.userData.animations.push(e.animationRef)}}};O.prototype.insertAnimationTarget=function(e){var t=this._animations.get(e.animationRef);if(t){if(!t.targetRefs.includes(e.targetRef)){t.targetRefs.push(e.targetRef);t.targetPivots.push({x:e.targetPivotX,y:e.targetPivotY,z:e.targetPivotZ})}}};O.prototype.insertAnimationTrack=function(e){var t=this._animationTracks.get(e.animationTrackRef);var r=e.animationRef;if(!t){delete e.animationRef;t=e;this._animationTracks.set(e.animationTrackRef,t)}if(!r){return}var i=this._animations.get(r);if(!i||!i.sequenceId){return}if(i.trackIds.has(t.animationTrackRef)){return}i.trackIds.add(t.animationTrackRef);for(var n=0;i.targetRefs&&n<i.targetRefs.length;n++){var s=i.targetRefs[n];var o=i.targetPivots[n];var d=this._nodes.get(s);if(!d){continue}var u;if(o.x!==0||o.y!==0||o.z!==0){u=[o.x,o.y,o.z]}var l=["OPACITY","COLOUR","TRANSLATE","SCALE","ROTATE"][t.type]||"";a.pushElementIntoMapArray(this._trackIdSequenceNodeMap,e.animationTrackRef,{sequenceId:i.sequenceId,targetId:s,type:l,pivot:u,isAbsoluteValue:true});var c={};c.times=Array.prototype.slice.call(t.times);c.values=Array.prototype.slice.call(t.values);c.id=e.animationTrackRef;c.cyclicInfo={};c.cyclicInfo.cyclicStart=t.cyclicStart;c.cyclicInfo.cyclicEnd=t.cyclicEnd;var h;if(i.type===0){if(t.dataType===0){if(t.values.length!==t.keyCount||t.times.length!==t.keyCount){continue}if(t.type===3){c.values=[];for(h=0;h<t.keyCount;h++){c.values.push(t.values[h]);c.values.push(t.values[h]);c.values.push(t.values[h])}}}else if(t.dataType===1||t.dataType===3){if(t.values.length!==3*t.keyCount||t.times.length!==t.keyCount){continue}}else if(t.dataType===4||t.dataType===5||t.dataType===6){if(t.values.length!==4*t.keyCount||t.times.length!==t.keyCount){continue}if(t.dataType===4){c.rotateType=I.AngleAxis}else if(t.dataType===6){c.rotateType=I.Euler}else{c.rotateType=I.Quaternion;for(var p=3;p<c.values.length;p=p+4){c.values[p]=-c.values[p]}}}}i.tracks.push(c)}};O.prototype.setAnimationTracks=function(e){var t=this._animations.get(e);if(t){this._animationHelper.insertTracks(t.tracks,this._trackIdSequenceNodeMap,this._nodes,this._vkScene)}};O.prototype.setAnimationPlaybacks=function(e){var t=this._viewGroups.get(e.viewGroupId);this._animationHelper.setInitialNodePositionsFromSubsequentViews(t.getViews(),this._vkScene);this._animationHelper.setInitialNodePositionsFromPreviousViews(t.getViews(),this._vkScene);this._animationHelper.setInitialNodePositionsFromCurrenetViews(t.getViews(),this._vkScene);this._animationHelper.setPlaybackStartTimes(t.getViews(),this._vkScene);this._animationHelper.buildViewsInitialState(t.getViews(),this._vkScene)};O.prototype.getSphere=function(e,t,r){var a=M.generateSphere(t,r);if(e.userData&&e.userData.nodeContentType){a.userData.nodeContentType=e.userData.nodeContentType}a.userData.skipIt=true;a.renderOrder=e.renderOrder;e.add(a)};O.prototype.getPlane=function(e,t,r){var a=M.generatePlane(t,r);if(e.userData&&e.userData.nodeContentType){a.userData.nodeContentType=e.userData.nodeContentType}a.userData.skipIt=true;a.renderOrder=e.renderOrder;e.add(a)};O.prototype.preferMeshes=function(){return true};O.prototype.setParametricContent=function(e,r,a){this._resetCurrentScene(a);var i={sphere:this.getSphere.bind(this),plane:this.getPlane.bind(this)};if(r.type in i===false){t.warning("Attempt to load unknown parametric type: "+r.type);return}var n=r.type;var s=this.getNode(e,this.sceneId);var o=r.materialID;var d=null;if(o){d=this._getMaterialRef(o)||this._createTemporaryMaterial(o);if(s.userData.parametricVisible){d.userData.parametricType=n}}i[n](s,r,d)};O.prototype.insertFillStyle=function(e){};O.prototype.insertLineStyle=function(e){};O.prototype.insertTextStyle=function(e){};O.prototype._getSavedColor=function(e,t){if(e&&e.length>2){return R({red:Math.floor(e[0]*255),green:Math.floor(e[1]*255),blue:Math.floor(e[2]*255),alpha:e.length>3?e[3]:1})}else if(t){return t}return undefined};var le=[];O.prototype.computeMeshPriority=function(e,t){le[0]=le[1]=le[2]=Infinity;le[3]=le[4]=le[5]=-Infinity;for(var r=0,a=t.length;r<a;++r){var i=t[r];le[0]=Math.min(le[0],i[0]);le[1]=Math.min(le[1],i[1]);le[2]=Math.min(le[2],i[2]);le[3]=Math.max(le[3],i[3]);le[4]=Math.max(le[4],i[4]);le[5]=Math.max(le[5],i[5])}var n=this._meshNodes.get(e);var s=n[0];var o=s.matrixWorld.getMaxScaleOnAxis();var d=0;var u=0;var l=0;if(le[3]>=le[0]&&le[4]>=le[1]&&le[5]>=le[2]){d=le[3]-le[0];u=le[4]-le[1];l=le[5]-le[2]}var c=d*(u+l)+u*l;return c*o*n.length};return O});
//# sourceMappingURL=SceneBuilder.js.map