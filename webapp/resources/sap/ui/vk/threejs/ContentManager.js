/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.script","sap/base/Log","../thirdparty/three","../ContentManager","./Scene","../TransformationMatrix","./PerspectiveCamera","./OrthographicCamera","../Messages","../getResourceBundle","./ContentDeliveryService","./ThreeUtils","./Viewport","./ViewStateManager"],function(jQuery,e,r,t,a,o,n,i,s,d,l,u){"use strict";var c=function(e){Object.defineProperties(this,{source:{value:e.getSource()},sourceType:{value:e.getSourceType()},sourceId:{value:null,writable:true},name:{value:null,writable:true},localMatrix:{value:null,writable:true},children:{value:[]},nodeProxy:{value:null,writable:true},loader:{value:null,writable:true},builder:{value:null,writable:true}});e._shadowContentResource=this};var f=t.extend("sap.ui.vk.threejs.ContentManager",{metadata:{library:"sap.ui.vk"}});var h=f.getMetadata().getParent().getClass().prototype;f.prototype.init=function(){if(h.init){h.init.call(this)}this._shadowContentResources=[]};f.prototype.exit=function(){if(this.defaultCdsLoader){this.defaultCdsLoader.destroy();this.defaultCdsLoader=null}if(this.defaultMataiLoader){this.defaultMataiLoader.destroy();this.defaultMataiLoader=null}if(h.exit){h.exit.call(this)}this._shadowContentResources=null};f.prototype._handleContentChangesProgress=function(e){this.fireContentChangesProgress({phase:e.getParameter("phase"),source:e.getParameter("source"),percentage:e.getParameter("percentage")})};f.prototype._handleContentLoadingFinished=function(e){this.fireContentLoadingFinished({source:e.getParameter("source"),node:e.getParameter("node")})};function g(e){if(e&&e.isMesh){e.castShadow=true;e.receiveShadow=false}if(e&&e.children){for(var r=0;r<e.children.length;r++){g(e.children[r])}}}function p(e,t){if(e){var a=new r.Group;e.add(a);a.name="DefaultLights";a.private=true;var o=(new r.Box3).setFromObject(e);var n=o.getSize(new r.Vector3);var i=o.getCenter(new r.Vector3);var s=n.length();var d=new r.PointLight;d.color.setRGB(.72,.72,.81);d.visible=true;d.private=true;a.add(d);var l=[new r.Color(.2,.2,.2),new r.Color(.32,.32,.36),new r.Color(.36,.36,.36)];var u=[new r.Vector3(2,-.5,-1.5),new r.Vector3(-2,-2.5,1.1),new r.Vector3(-.04,2,.01)];for(var c=0,f=l.length;c<f;c++){var h=new r.DirectionalLight;h.color.copy(l[c]);h.position.copy(u[c]);h.private=true;h.updateWorldMatrix(false,false);a.add(h)}if(t){g(e);var p=new r.DirectionalLight;p.color.setRGB(.5,.5,.5);p.position.set(0,1,0);p.castShadow=true;p.shadow.mapSize.width=512;p.shadow.mapSize.height=512;var v=2e3;p.shadow.camera.left=-v;p.shadow.camera.right=v;p.shadow.camera.top=v;p.shadow.camera.bottom=-v;p.shadow.camera.far=3500;p.shadow.bias=-1e-4;p.private=true;a.add(p);var C=new r.PlaneGeometry(n.x,n.z);var m=new r.ShadowMaterial;m.opacity=.2;var y=new r.Mesh(C,m);y.rotation.x=-Math.PI/2;y.position.x=i.x;y.position.y=o.min.y-s*.1;y.position.z=i.z;e.add(y);y.receiveShadow=true}}}f.prototype.loadContent=function(t,o){this.fireContentChangesStarted();var n=t||new a(new r.Scene);var i=this;this._loadContentResources(n,o).then(function(r){e.info("Content loading resolved");if(r){for(var a=0;a<r.length;++a){if(!n.getInitialView()&&r[a].initialView){n.setInitialView(r[a].initialView)}n.camera=n.camera||r[a].camera;var o=r[a].contentResource?r[a].contentResource._shadowContentResource:null;if(r[a].loader){if(o){o.loader=r[a].loader}n.loaders=n.loaders||[];n.loaders.push(r[a].loader)}if(r[a].builder){if(o){o.builder=r[a].builder}n.builders=n.builders||[];n.builders.push(r[a].builder)}}if(r.length>0){var s=r[0];n.backgroundTopColor=s.backgroundTopColor;n.backgroundBottomColor=s.backgroundBottomColor;n.renderMode=s.renderMode;n.upAxis=s.upAxis}}n.getSceneRef().updateMatrixWorld();if(!t){p(n.getSceneRef(),false)}if(n.loaders){i._initSceneWithCDSLoaderIfExists(n,n.loaders)}i.fireContentChangesFinished({content:n})},function(r){e.info("Content loading rejected:",r);var t;if(typeof r==="string"){t=r}else if(r.errorText){t=r.errorText}else if(r.message){t=r.message}t=t||d().getText(s.VIT37.summary);e.error(d().getText("CONTENTMANAGER_MSG_CONTENTRESOURCESFAILEDTOLOAD"),t);i.fireContentChangesFinished({content:null,failureReason:[{error:r,errorMessage:t}]})});return this};f.prototype._findLoader=function(e){if(e._contentManagerResolver&&e._contentManagerResolver.settings&&e._contentManagerResolver.settings.loader){return Promise.resolve(e._contentManagerResolver.settings.loader)}if(e.getSource()){var r=e.getSourceType().toLowerCase();var t=this;switch(r){case"stream":{if(this.defaultCdsLoader==null){return new Promise(function(e){var r="sap/ui/vk/threejs/ContentDeliveryService";sap.ui.require([r],function(r){e(t.defaultCdsLoader=new r({authorizationHandler:t._authorizationHandler,consumptionScenario:t._consumptionScenario}))})})}return Promise.resolve(this.defaultCdsLoader)}case"vds4":{if(this.defaultMataiLoader==null){return new Promise(function(e){var r="sap/ui/vk/matai/MataiLoader";sap.ui.require([r],function(r){e(t.defaultMataiLoader=new r)})})}return Promise.resolve(this.defaultMataiLoader)}default:break}}return Promise.resolve(null)};f.prototype._loadContentResources=function(e,t){function a(e,r){if(typeof r==="string"){return(e||"")+r}return null}function n(e,r){if(!e&&!r){return true}else if(!!e^!!r){return false}else{return e.source===r.getSource()&&e.sourceType===r.getSourceType()}}function i(e,r){r._shadowContentResource=e;var t=e.nodeProxy.getNodeRef();e.name=r.getName();t.name=e.name;e.sourceId=r.getSourceId();t.sourceId=e.sourceId;function a(e,r){if(!e&&!r){return true}var t=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];var a=e||t,o=r||t;for(var n=0;n<t.length;++n){if(a[n]!==o[n]){return false}}return true}if(!a(e.localMatrix,r.getLocalMatrix())){e.localMatrix=r.getLocalMatrix();t.matrix.fromArray(o.convertTo4x4(e.localMatrix));t.matrix.decompose(t.position,t.quaternion,t.scale);t.matrixWorldNeedsUpdate=true}}var s=[];var d=new Map;function l(e){var r=a(e.sourceType,e.source);var t=d.get(r);if(!t){t=[];d.set(r,t)}t.push(e);var o=e.nodeProxy.getNodeRef();o.parent.remove(o);e.children.forEach(function(e){l(e)});e.children.length=0}function f(t,a){var o=new c(t);var n=new r.Group;a.add(n);n.matrixWorldNeedsUpdate=true;o.nodeProxy=e.getDefaultNodeHierarchy().createNodeProxy(n);i(o,t);s.push(t);return o}(function e(r,t,a){var o=0;var s=jQuery.sap.arrayDiff(r,t,n,true);s.forEach(function(n){for(;o<n.index;++o){i(r[o],t[o]);e(r[o].children,t[o].getContentResources(),r[o].nodeProxy.getNodeRef())}if(n.type==="delete"){l(r[n.index]);r.splice(n.index,1)}else if(n.type==="insert"){var s=f(t[n.index],a);r.splice(n.index,0,s);e(s.children,t[n.index].getContentResources(),s.nodeProxy.getNodeRef())}++o});for(;o<r.length;++o){i(r[o],t[o]);e(r[o].children,t[o].getContentResources(),r[o].nodeProxy.getNodeRef())}})(this._shadowContentResources,t,e.getSceneRef());var h=[];s.forEach(function(r){var t=r._shadowContentResource.nodeProxy.getNodeRef();var o=a(r.getSourceType(),r.getSource());var n=d.get(o);if(o&&n&&n.length>0){var i=n.pop();var s=i.nodeProxy.getNodeRef();for(var l=0;l<s.children.length;++l){t.add(s.children[l])}if(i.loader){r._shadowContentResource.loader=i.loader}if(i.builder){r._shadowContentResource.builder=i.builder}e.getDefaultNodeHierarchy().destroyNodeProxy(i.nodeProxy);i.nodeProxy=null}else{var u=this;h.push(this._findLoader(r).then(function(e){if(e){if(e.attachContentChangesProgress){e.attachContentChangesProgress(u._handleContentChangesProgress,u)}if(e.attachContentLoadingFinished){e.attachContentLoadingFinished(u._handleContentLoadingFinished,u)}}if(typeof e==="function"){return e(t,r,u._authorizationHandler,u._retryCount)}else if(e&&e.load){return e.load(t,r,u._authorizationHandler,u._retryCount)}else{return Promise.resolve({node:t,contentResource:r})}}))}},this);function g(e){var t=[];var a=[];u.getAllTHREENodes([e],t,a);var o=new Map;var n=new Map;t.forEach(function(e){if(e instanceof r.Mesh){if(!n.has(e.geometry.uuid)){u.disposeGeometry(e);n.set(e.geometry.uuid,true)}if(e.material){if(!o.has(e.material.uuid)){u.disposeMaterial(e.material);o.set(e.material.uuid,true)}}if(e.userData&&e.userData.originalMaterial&&e.userData.originalMaterial.uuid!==e.material.uuid&&!o.has(e.userData.originalMaterial.uuid)){u.disposeMaterial(e.userData.originalMaterial);o.set(e.userData.originalMaterial.uuid,true)}}if(e.parent){e.parent.remove(e)}});a.forEach(function(e){if(e.parent){e.parent.remove(e)}});o.clear();n.clear()}d.forEach(function(e,r){for(var t=0;t<e.length;++t){var a=e[t];g(a.nodeProxy.getNodeRef());if(a.builder){a.builder.cleanup()}if(a.loader){if(a.loader._loader&&a.loader._loader.sceneBuilder){a.loader._loader.removeContext(a.loader._loader.currentSceneInfo.id);a.loader._loader.sceneBuilder.cleanup()}if(a.loader.detachContentChangesProgress){a.loader.detachContentChangesProgress(this._handleContentChangesProgress,this)}if(a.loader.detachContentLoadingFinished){a.loader.detachContentLoadingFinished(this._handleContentLoadingFinished,this)}}}},this);if(t.length===1&&t[0].getName()==null&&t[0].getLocalMatrix()==null){t[0]._shadowContentResource.nodeProxy.getNodeRef().userData.skipIt=true}else{t.forEach(function(e){e._shadowContentResource.nodeProxy.getNodeRef().userData.skipIt=false})}return Promise.all(h)};f.prototype._initSceneWithCDSLoaderIfExists=function(e,r){if(r){var t;for(var a=0;a<r.length;a++){if(r[a]instanceof l){t=r[a].getSceneBuilder();break}}if(t){e.setSceneBuilder(t);e.getDefaultNodeHierarchy().attachNodeRemoving(function(e){var r=e.getParameter("nodeRef");if(r.userData.treeNode&&r.userData.treeNode.sid){t.decrementResourceCountersForDeletedTreeNode(r.userData.treeNode.sid)}});return true}}return false};f.prototype.destroyContent=function(e){if(e){e.destroy();this._shadowContentResources=[];if(e.loaders&&Array.isArray(e.loaders)&&e.loaders.length>0){if(e.loaders[0]._loader&&e.loaders[0]._loader.sceneBuilder){e.loaders[0]._loader.removeContext(e.loaders[0]._loader.currentSceneInfo.id);e.loaders[0]._loader.sceneBuilder.cleanup()}if(e.loaders[0].detachContentChangesProgress){e.loaders[0].detachContentChangesProgress(this._handleContentChangesProgress,this)}if(e.loaders[0].detachContentLoadingFinished){e.loaders[0].detachContentLoadingFinished(this._handleContentLoadingFinished,this)}}else if(e.builders&&Array.isArray(e.builders)){e.builders.forEach(function(e){if(e){e.cleanup()}})}}return this};f.prototype.createOrthographicCamera=function(){return new i};f.prototype.createPerspectiveCamera=function(){return new n};return f});
//# sourceMappingURL=ContentManager.js.map