/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/mdc/valuehelp/base/FilterableListContent","sap/ui/mdc/util/loadModules","sap/ui/mdc/enums/ValueHelpSelectionType","sap/m/library","sap/ui/table/library","sap/base/util/restricted/_throttle","sap/ui/mdc/util/Common","sap/base/Log","sap/ui/core/Element","sap/ui/mdc/enums/TableSelectionMode","sap/ui/mdc/enums/TableType"],function(e,t,i,n,l,s,o,a,r,h,c){"use strict";var d=n.ListMode;var u=n.Sticky;var g=l.VisibleRowCountMode;var p=l.SelectionMode;var b=l.SelectionBehavior;var f=function(e){var t,i=t=e&&e.getType();if(!i){t=c.Table}else if(typeof i==="object"){if(i.isA("sap.ui.mdc.table.ResponsiveTableType")){t=c.ResponsiveTable}else{t=c.Table}}return t};var _=function(){var e=this._getTable();var t=e&&e._oTable;var n=e.getRowBinding();var l=function(){return this._oUITableSelectionPlugin||t}.bind(this);var s=function(e,t){var n=t?i.Add:i.Remove;this._fireSelect({type:n,conditions:e})};var o={};o[c.ResponsiveTable]={getListBindingInfo:function(){return t&&t.getBindingInfo("items")},getItems:function(){return t.getItems()},getSelectedItems:function(){return t.getSelectedItems()},modifySelection:function(e,t){if(e.getSelected()!==t){e.setSelected(t)}},handleItemPress:function(e){var t=e.getParameter("listItem");if(!this.isTypeahead()||!this.isSingleSelect()){t.setSelected(!t.getSelected())}var i=this._getListItemBindingContext(t);var n=this.getItemFromContext(i);var l=n&&this.createCondition(n.key,n.description,n.payload);s.call(this,[l],t.getSelected())},handleSelectionChange:function(e){if(!this.isTypeahead()||!this.isSingleSelect()){var t=e.getParameters();var i=t.listItems||t.listItem&&[t.listItem];var n=i.map(function(e){var t=this._getListItemBindingContext(e);var i=this.getItemFromContext(t);return i&&this.createCondition(i.key,i.description,i.payload)}.bind(this));s.call(this,n,t.selected)}},adjustTable:function(){var e=t.getSticky();if(!e||e.length===0){t.setSticky([u.ColumnHeaders])}if(this.isSingleSelect()){t.setMode(d.SingleSelectLeft)}else{t.setMode(d.MultiSelect)}},handleScrolling:function(e){var i=this.getScrollDelegate();if(i){t.scrollToIndex(e).catch(function(e){});return true}},handleListBinding:function(){}};o[c.Table]={getListBindingInfo:function(){return t&&t.getBindingInfo("rows")},getItems:function(){return t.getRows().filter(function(e){var t=this._getListItemBindingContext(e);return t&&t.getObject()}.bind(this))}.bind(this),getSelectedItems:function(){var e=l().getSelectedIndices();var i=e.reduce(function(e,i){var n=t.getContextByIndex(i);return n?e.concat(n):e},[]);return o[c.Table].getItems().filter(function(e){return i.indexOf(this._getListItemBindingContext(e))>=0}.bind(this))}.bind(this),modifySelection:function(e,t){var i=this._getListItemBindingContext(e);var n=o[c.Table].getContexts().indexOf(i);var s=l().getSelectedIndices().indexOf(n)>=0;if(t&&!s){return this.isSingleSelect()?l().setSelectedIndex(n):l().addSelectionInterval(n,n)}else if(!t&&s){return l().removeSelectionInterval(n,n)}},handleItemPress:function(e){},handleSelectionChange:function(e){var i=e.getSource().isA("sap.ui.table.plugins.MultiSelectionPlugin");var n=e.getParameters();if(i?n._internalTrigger:!n.userInteraction){return}var l=e.getParameter("rowIndices");var a=l.map(function(e){return t.getContextByIndex(e)});var r=o[c.Table].getItems().filter(function(e,t){return a.indexOf(this._getListItemBindingContext(e))>=0}.bind(this));var h=[],d=[];var u=o[c.Table].getSelectedItems();var g=this.getConditions();r.forEach(function(e,t){var i=this._isItemSelected(e,g);var n=u.indexOf(e)!==-1;if(i!==n){var l=u.indexOf(e)!==-1?h:d;var s=this._getListItemBindingContext(e);var o=this.getItemFromContext(s);var a=o&&this.createCondition(o.key,o.description,o.payload);l.push(a)}}.bind(this));var p=this.isSingleSelect();if(h.length){s.call(this,h,true);if(p){return}}if(d.length){s.call(this,d,false)}},adjustTable:function(){var i=t.getRowMode();if(!i){t.setVisibleRowCountMode(g.Auto);t.setMinAutoRowCount(3)}else if(i.isA("sap.ui.table.rowmodes.AutoRowMode")){i.setMinRowCount(3)}var n=e.getSelectionMode();var s=this.isSingleSelect()?p.Single:p.MultiToggle;if(n!==h.SingleMaster){t.setSelectionBehavior(b.Row)}l().setSelectionMode(s)},handleScrolling:function(e){var i=t.getFirstVisibleRow();if(typeof e==="undefined"||e<0){e=i-1}if(e>=0&&e!=i){t.setFirstVisibleRow(e);return Promise.resolve()}return false},getContexts:function(){return n&&n.getAllCurrentContexts()},handleListBinding:function(){n.attachEvent("change",this._handleUpdateFinished.bind(this))}};return o[this._sTableType]};function v(){if(this._oTableHelper&&!this._bSelectionIsUpdating){this._bSelectionIsUpdating=true;var e=this._oTableHelper.getItems();var t=this.getSelectableConditions();var i=[];for(var n in e){var l=e[n];var s=this._isItemSelected(l,t);i.push(this._oTableHelper.modifySelection.call(this,l,s))}Promise.all(i).then(function(){this._bSelectionIsUpdating=false}.bind(this))}}var T=s(v,100,{leading:true});var S=e.extend("sap.ui.mdc.valuehelp.content.MDCTable",{metadata:{library:"sap.ui.mdc",interfaces:["sap.ui.mdc.valuehelp.IDialogContent"],properties:{forceBind:{type:"boolean",defaultValue:false}},aggregations:{table:{type:"sap.ui.mdc.Table",multiple:false}},events:{},defaultAggregation:"table"}});S.prototype.init=function(){e.prototype.init.apply(this,arguments);this._oObserver.observe(this,{aggregations:["table"]});this._addPromise("listBinding");this._bRebindTable=false};var m=function(){var e=this._getTable().getRowBinding();if(e){this._oTableHelper=_.call(this);this._oTableHelper.handleListBinding.call(this);B.call(this);this._resolvePromise("listBinding",e)}};var y=function(){if(this._oTable&&!this._oTable.getHeader()){this._oTable.setHeader(this._oResourceBundle.getText("valuehelp.TABLETITLENONUMBER"))}};S.prototype.handleConditionsUpdate=function(){T.call(this)};S.prototype._handleUpdateFinished=function(e){T.call(this)};S.prototype._handleFirstVisibleRowChanged=function(e){T.call(this)};var C=function(e,t){if(!e){return}if(t==="remove"){if(this._sTableType===c.Table){e.detachEvent("cellClick",this._handleItemPress,this);e.detachEvent("rowSelectionChange",this._handleSelectionChange,this);e.detachEvent("rowsUpdated",this._handleUpdateFinished,this);e.detachEvent("firstVisibleRowChanged",this._handleFirstVisibleRowChanged,this);if(this._oUITableSelectionPlugin){this._oUITableSelectionPlugin.detachEvent("selectionChange",this._handleSelectionChange,this)}this._oUITableSelectionPlugin=undefined}else if(this._sTableType===c.ResponsiveTable){e.detachEvent("itemPress",this._handleItemPress,this);e.detachEvent("selectionChange",this._handleSelectionChange,this);e.detachEvent("updateFinished",this._handleUpdateFinished,this)}this._oObserver.unobserve(e)}else{if(this._sTableType===c.Table){this._oObserver.observe(e,{bindings:["rows"],aggregations:["plugins"]});e.attachEvent("cellClick",this._handleItemPress,this);e.attachEvent("rowSelectionChange",this._handleSelectionChange,this);e.attachEvent("rowsUpdated",this._handleUpdateFinished,this);e.attachEvent("firstVisibleRowChanged",this._handleFirstVisibleRowChanged,this);this._oUITableSelectionPlugin=e.getPlugins().find(function(e){return e.isA("sap.ui.table.plugins.SelectionPlugin")});if(this._oUITableSelectionPlugin){this._oUITableSelectionPlugin.attachEvent("selectionChange",this._handleSelectionChange,this)}}else if(this._sTableType===c.ResponsiveTable){this._oObserver.observe(e,{bindings:["items"]});e.attachEvent("itemPress",this._handleItemPress,this);e.attachEvent("selectionChange",this._handleSelectionChange,this);e.attachEvent("updateFinished",this._handleUpdateFinished,this)}}};S.prototype.observeChanges=function(t){if(["_defaultFilterBar","filterBar"].indexOf(t.name)!==-1){I.call(this)}if(t.name==="table"){var i=t.child;if(t.mutation==="remove"){this._oObserver.unobserve(i);this._oTable=null;this._oTableHelper=null;this._addPromise("listBinding")}else{this._oTable=i;i._enableV4LegacySelection();if(this._oTable.getAutoBindOnInit()){a.warning("Usage of autobound tables may lead to unnecessary requests.")}else if(this.getForceBind()){this._bRebindTable=true}this._oObserver.observe(i,{aggregations:["_content"]});this._sTableType=f(i);i.addDelegate({onmouseover:function(e){var t=r.closestTo(e.target);if(t&&t.isA("sap.m.ColumnListItem")){t.setType("Active")}}});C.call(this,this._oTable._oTable,"insert");m.call(this);y.call(this);I.call(this)}return}if(t.name==="_content"){C.call(this,t.child,t.mutation);return}if(["rows","items"].indexOf(t.name)!==-1&&t.mutation==="ready"){m.call(this);return}if(t.name==="config"){B.call(this)}if(t.name==="plugins"){this._oUITableSelectionPlugin=t.mutation==="remove"||!t.child.isA("sap.ui.table.plugins.SelectionPlugin")?undefined:t.child;if(this._oUITableSelectionPlugin){this._oUITableSelectionPlugin.attachEvent("selectionChange",this._handleSelectionChange,this)}}e.prototype.observeChanges.apply(this,arguments)};S.prototype._getTable=function(){return this._oTable};function I(){var e=this._getPriorityFilterBar();if(this._oTable&&e&&this._oTable.getFilter()!==e.getId()){this._oTable.setFilter(e)}}function B(){if(this._oTableHelper){this._oTableHelper.adjustTable.call(this)}}S.prototype.getContent=function(){return this._retrievePromise("wrappedContent",function(){return t(["sap/ui/layout/FixFlex","sap/m/VBox","sap/m/ScrollContainer"]).then(function(e){var t=e[0];var i=e[1];var n=e[2];if(!this._oContentLayout){this._oFilterBarVBox=new i(this.getId()+"-FilterBarBox",{visible:"{$this>/_filterBarVisible}"});this._oFilterBarVBox.addStyleClass("sapMdcValueHelpPanelFilterbar");this._oFilterBarVBox._oWrapper=this;this._oFilterBarVBox.getItems=function(){var e=this._oWrapper._getPriorityFilterBar.call(this._oWrapper);var t=e?[e]:[];return t};this._oTableBox=new i(this.getId()+"-TB",{height:"100%"});this._oTableBox.addStyleClass("sapMdcValueHelpPanelTableBox");this._oTableBox._oWrapper=this;this._oTableBox.getItems=function(){var e=this._oWrapper._sTableType===c.ResponsiveTable?this._oWrapper._oScrollContainer:this._oWrapper._oTable;var t=e?[e]:[];return t};this._oContentLayout=new t(this.getId()+"-FF",{minFlexSize:200,fixContent:this._oFilterBarVBox,flexContent:this._oTableBox});this._oScrollContainer=new n(this.getId()+"-SC",{height:"calc(100% - 0.5rem)",width:"100%",vertical:true});this._oScrollContainer._oWrapper=this;this._oScrollContainer.getContent=function(){var e=[];var t=this._oWrapper&&this._oWrapper._oTable;if(t){e.push(t)}return e}}this.setAggregation("displayContent",this._oContentLayout);if(!this._getPriorityFilterBar()){return this._createDefaultFilterBar().then(function(){this._oFilterBarVBox.invalidate();return this._oContentLayout}.bind(this))}return this._oContentLayout}.bind(this))}.bind(this))};S.prototype.getListBinding=function(){var e=this.getTable();return e&&e.getRowBinding()};S.prototype.getListBindingInfo=function(){return this._oTableHelper&&this._oTableHelper.getListBindingInfo()};S.prototype.onBeforeShow=function(t){return Promise.resolve(e.prototype.onBeforeShow.apply(this,arguments)).then(function(){var e=this.getTable();if(e){var i=e.isTableBound();var n=i&&e._oTable.getShowOverlay();if(this._bRebindTable||n){e.rebind();this._bRebindTable=false}else if(t){if(this._sTableType===c.ResponsiveTable){this._oScrollContainer.scrollTo(0,0)}else if(i){return e.scrollToIndex(0)}}}}.bind(this))};S.prototype.onShow=function(t){if(this._oTable){B.call(this);var i=e.prototype.isSingleSelect.apply(this)?h.SingleMaster:h.Multi;if(this._oTable.getSelectionMode()===h.None){this._oTable.setSelectionMode(i)}if(this._oTable.getSelectionMode()!==i){throw new Error("Table selectionMode needs to be "+i)}}e.prototype.onShow.apply(this,arguments)};S.prototype._handleScrolling=function(e){return this._oTableHelper&&this._oTableHelper.handleScrolling.call(this,e)};S.prototype.getScrollDelegate=function(){if(!this.isTypeahead()&&this._oScrollContainer){return this._oScrollContainer.getScrollDelegate()}return e.prototype.getScrollDelegate.apply(this,arguments)};S.prototype._handleItemPress=function(e){this._oTableHelper.handleItemPress.call(this,e)};S.prototype._handleSelectionChange=function(e){if(!this._bSelectionIsUpdating){this._oTableHelper.handleSelectionChange.call(this,e)}};S.prototype.isQuickSelectSupported=function(){return true};S.prototype.setParent=function(t){e.prototype.setParent.apply(this,arguments);B.call(this)};S.prototype.isSingleSelect=function(){if(this._oTable){if(this._oTable.getSelectionMode()===h.Multi){return false}else{return true}}else{return e.prototype.isSingleSelect.apply(this,arguments)}};S.prototype.exit=function t(i){o.cleanup(this,["_oContentLayout","_oFilterBarVBox","_oTableBox","_oResourceBundle","_oScrollContainer","_oTableHelper","_bSelectionIsUpdating","_sTableType","_oUITableSelectionPlugin","_oTable","_bRebindTable"]);e.prototype.exit.apply(this,arguments)};return S});
//# sourceMappingURL=MDCTable.js.map