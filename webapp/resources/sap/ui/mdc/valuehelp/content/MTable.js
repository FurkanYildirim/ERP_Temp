/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/mdc/valuehelp/base/FilterableListContent","sap/ui/mdc/condition/Condition","sap/ui/mdc/condition/FilterConverter","sap/ui/mdc/enums/ConditionValidated","sap/ui/mdc/util/loadModules","sap/m/library","sap/ui/model/FilterType","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/FilterProcessor","sap/ui/mdc/util/Common","sap/base/strings/formatMessage","sap/base/util/merge","sap/ui/mdc/enums/ValueHelpSelectionType","sap/base/Log","sap/ui/core/Element"],function(e,t,i,a,n,s,r,o,l,h,d,u,p,c,g,v){"use strict";var f=s.ListMode;var m=s.Sticky;var _=e.extend("sap.ui.mdc.valuehelp.content.MTable",{metadata:{library:"sap.ui.mdc",interfaces:["sap.ui.mdc.valuehelp.ITypeaheadContent","sap.ui.mdc.valuehelp.IDialogContent"],properties:{},aggregations:{table:{type:"sap.m.Table",multiple:false}},events:{contentUpdated:{}},defaultAggregation:"table"}});_.prototype.init=function(){e.prototype.init.apply(this,arguments);this._oObserver.observe(this,{aggregations:["table"]});this._addPromise("listBinding");this._oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");this._oMResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.m");this._iNavigateIndex=-1};_.prototype.getValueHelpIcon=function(){if(this.getUseAsValueHelp()){return"sap-icon://slim-arrow-down"}else{return null}};function y(){if(this._oTable){var t=this._oTable.getItems();var i=this.getSelectableConditions();var a=this.isSingleSelect()&&!e.prototype.isSingleSelect.apply(this);t.forEach(function(e){var t=a?false:this._isItemSelected(e,i);e.setSelected(t);if(this._oTable.indexOfItem(e)===this._iNavigateIndex){e.addStyleClass("sapMLIBFocused").addStyleClass("sapMListFocus")}else{e.removeStyleClass("sapMLIBFocused").removeStyleClass("sapMListFocus")}}.bind(this))}}_.prototype.applyFilters=function(){if(this._iNavigateIndex>=0){this.setProperty("conditions",[],true);this._iNavigateIndex=-1}var e=function(){if(!this.isDestroyed()){return this.applyFilters()}}.bind(this);var t=this.getListBinding();var i=this.isValueHelpDelegateInitialized();var a;if(!t||!i){a=Promise.all([this._retrievePromise("listBinding"),this.awaitValueHelpDelegate()]).then(e)}if(!i||!this.isTypeahead()&&!this.isContainerOpen()&&t.isSuspended()){return undefined}if(!a){var n=this.getValueHelpDelegate();var s=this.getValueHelpInstance();var r=this.getListBindingInfo();var o=r&&r.length;n.updateBindingInfo(s,this,r);n.updateBinding(s,t,r,this);a=Promise.resolve(n.checkListBindingPending(s,t,o))}this._addPromise("applyFilters",a);return a.catch(function(e){if(e.canceled){g.error("sap.ui.mdc.ValueHelp - Error during applyFilters:",e.message);return}throw e}).finally(function(){var e=this._retrievePromise("applyFilters");return e&&e.getInternalPromise()}.bind(this))};_.prototype._handleSelectionChange=function(e){var t=this.isTypeahead();if(!t||!this.isSingleSelect()){var i=e.getParameters();var a=i.listItems||i.listItem&&[i.listItem];var n=a.map(function(e){var t=this._getListItemBindingContext(e);var i=this.getItemFromContext(t);return i&&this.createCondition(i.key,i.description,i.payload)}.bind(this));this._fireSelect({type:i.selected?c.Add:c.Remove,conditions:n});if(t){this.fireConfirm()}}};_.prototype._handleItemPress=function(e){var t=e.getParameter("listItem");var i=this._getListItemBindingContext(t);var a=this.getItemFromContext(i);var n=this._getTable();var s=n.getMode()===f.SingleSelectMaster;var r=s?t.getSelected():!t.getSelected();t.setSelected(r);var o=r?c.Add:c.Remove;var l=this.createCondition(a.key,a.description,a.payload);this._fireSelect({type:o,conditions:[l]});if(this.isTypeahead()){this.fireConfirm({close:true})}};_.prototype._handleUpdateFinished=function(){y.apply(this);if(this._bScrollToSelectedItem){var e=this._getTable();if(e&&this.isTypeahead()&&this.isSingleSelect()){var t=this._iNavigateIndex>=0?e.getItems()[this._iNavigateIndex]:e.getSelectedItem();if(t){this._handleScrolling(t)}}this._bScrollToSelectedItem=false}this.fireContentUpdated()};_.prototype._getTable=function(){return this._oTable};_.prototype.onShow=function(t){var i=this._getTable();if(i){if(!i.hasStyleClass("sapMComboBoxList")){i.addStyleClass("sapMComboBoxList")}var a=this.isTypeahead()?f.SingleSelectMaster:f.SingleSelectLeft;if(!e.prototype.isSingleSelect.apply(this)&&i.getMode()!==a){a=f.MultiSelect}if(i.getMode()===f.None){i.setMode(a)}if(i.getMode()!==a){throw new Error("Table selection mode needs to be "+a)}}e.prototype.onShow.apply(this,arguments);if(i&&this.isTypeahead()&&this.isSingleSelect()){var n=this._iNavigateIndex>=0?i.getItems()[this._iNavigateIndex]:i.getSelectedItem();if(n){this._handleScrolling(n)}else{this._bScrollToSelectedItem=true}}};_.prototype.onHide=function(){e.prototype.onHide.apply(this,arguments);var t=this.getTable();if(t){this.removeFocus();if(t.hasStyleClass("sapMComboBoxList")){t.removeStyleClass("sapMComboBoxList")}}this._iNavigateIndex=-1;this._bScrollToSelectedItem=false};_.prototype.handleConditionsUpdate=function(e){y.call(this)};_.prototype.getContent=function(){if(!this.isTypeahead()){return this._retrievePromise("wrappedContent",function(){return n(["sap/ui/layout/FixFlex","sap/m/VBox","sap/m/Panel","sap/m/ScrollContainer","sap/ui/model/resource/ResourceModel"]).then(function(e){var t=e[0];var i=e[1];var a=e[2];var n=e[3];var s=e[4];if(!this._oContentLayout){this._oFilterBarVBox=new i(this.getId()+"-FilterBarBox");this._oFilterBarVBox.addStyleClass("sapMdcValueHelpPanelFilterbar");this._oFilterBarVBox._oWrapper=this;this._oFilterBarVBox.getItems=function(){return[this._oWrapper._getPriorityFilterBar.call(this._oWrapper)]};this.setModel(new s({bundleName:"sap/ui/mdc/messagebundle",async:false}),"$i18n");var r=function(e){var t=0;if(t===0){e=this.getModel("$i18n").getResourceBundle().getText("valuehelp.TABLETITLENONUMBER")}return u(e,t)};this._oTablePanel=new a(this.getId()+"-TablePanel",{expanded:true,height:"100%",headerText:{parts:["$i18n>valuehelp.TABLETITLE"],formatter:r}});this._oTablePanel.addStyleClass("sapMdcTablePanel");this._oContentLayout=new t(this.getId()+"-FF",{minFlexSize:200,fixContent:this._oFilterBarVBox,flexContent:this._oTablePanel});this._oScrollContainer=new n(this.getId()+"-SC",{height:"100%",width:"100%",vertical:true});this._oScrollContainer._oWrapper=this;this._oScrollContainer.getContent=function(){var e=[];var t=this._oWrapper&&this._oWrapper._oTable;if(t){e.push(t)}return e};this._oTablePanel.addContent(this._oScrollContainer)}this.setAggregation("displayContent",this._oContentLayout);var o=this._getPriorityFilterBar();if(!o){return this._createDefaultFilterBar().then(function(){return this._oContentLayout}.bind(this))}return this._oContentLayout}.bind(this))}.bind(this))}return this._oTable};_.prototype.getItemForValue=function(e){if(!e.checkKey&&e.parsedValue&&!e.checkDescription){return null}if(e.checkKey&&!this.getKeyPath()){throw new Error("MTable: KeyPath missing! "+this.getId())}if(e.checkDescription&&!this.getDescriptionPath()){throw new Error("MTable: DescriptionPath missing! "+this.getId())}e.caseSensitive=e.caseSensitive||this.getCaseSensitive();var t=I.call(this);var i=this.getValueHelpDelegate();var a=this.getValueHelpInstance();var n=i&&i.getFilterConditions(a,this,e);return Promise.all([t,n]).then(function(t){var i=t[0];var a=t[1];var n;if(!i){var s=this.getTable();n=b.call(this,e,s.getItems(),a)}if(!n){n=this._loadItemForValue(e,a)}return n}.bind(this))};function b(e,t,i){if(t.length===0){return}var a=function(e,t){var i=e.isA("sap.ui.model.Context")?e:this._getListItemBindingContext(e);return i.getProperty(t)}.bind(this);var n;var s;var r=S.call(this,e,i);var o=h.apply(t,r,a);if(o.length===1){var l=this._getListItemBindingContext(o[0]);var d=this.getItemFromContext(l,{inParameters:n,outParameters:s});return{key:d.key,description:d.description,payload:d.payload}}else if(o.length>1){if(!e.caseSensitive){var u=p({},e);u.caseSensitive=true;return b.call(this,u,t,i)}throw T.call(this,e.exception,true,e.parsedValue||e.value)}}function S(e,t){var a=e.caseSensitive;var n=this.getKeyPath();var s=this.getDescriptionPath();var r=[];if(e.checkKey&&e.hasOwnProperty("parsedValue")){r.push(new o({path:n,operator:l.EQ,value1:e.parsedValue,caseSensitive:a}))}if(e.checkDescription&&e.value){r.push(new o({path:s,operator:l.EQ,value1:e.value,caseSensitive:a}))}var h=r.length>1?new o({filters:r,and:false}):r[0];if(t){var d=this._getTypesForConditions(t);var u=i.createFilters(t,d,undefined,this.getCaseSensitive());if(u){h=new o({filters:[h,u],and:true})}}return h}function I(){return this._retrievePromise("listBinding").then(function(e){var t=this.getValueHelpDelegate();var i=this.getValueHelpInstance();var a=this.getListBindingInfo();var n=a&&a.length;if(e&&t){return t.checkListBindingPending(i,e,n)}else{return true}}.bind(this))}_.prototype.getListBinding=function(){var e=this._getTable();return e&&e.getBinding("items")};_.prototype.getListBindingInfo=function(){var e=this._getTable();return e&&e.getBindingInfo("items")};_.prototype._loadItemForValue=function(e,t){if(!e.checkKey&&e.parsedValue&&!e.checkDescription){return null}var i=this.getKeyPath();var a=this.getDescriptionPath();var n=this.getUseFirstMatch();var s=this._getTable();var r=s&&s.getBinding("items");var o=r&&r.getPath();var l=this.getValueHelpDelegate();var h=this.getValueHelpInstance();var d="loadItemForValue:"+JSON.stringify([o,i,e.parsedValue||e.value,e.context,e.bindingContext&&e.bindingContext.getPath(),t]);return this._retrievePromise(d,function(){var s=S.call(this,e,t);var d=r.getModel().bindList(o,r.getContext(),undefined,s);d.initialize();return l.executeFilter(h,d,2).then(function(t){var s=t.getContexts();setTimeout(function(){d.destroy()},0);if(s.length&&(s.length<2||n)){return this.getItemFromContext(s[0],{keyPath:i,descriptionPath:a,inParameters:undefined})}else if(e.checkKey&&e.parsedValue===""&&s.length===0){return null}else{var r=T.call(this,e.exception,s.length>1,e.value);throw r}}.bind(this))}.bind(this))};function T(e,t,i){var a;if(t){a=this._oResourceBundle.getText("valuehelp.VALUE_NOT_UNIQUE",[i])}else{a=this._oResourceBundle.getText("valuehelp.VALUE_NOT_EXIST",[i])}var n=new e(a);n._bNotUnique=t;return n}_.prototype.isValidationSupported=function(e){return true};_.prototype.navigate=function(e){var t=this.getParent().isOpen();if(!t&&this._iNavigateIndex<0){this.onShow(true)}var i=this.getListBinding();if(!i||!i.getLength()){return I.call(this).then(function(t){if(!t&&i.getLength()!==0){return this.navigate(e)}return false}.bind(this))}var a=this._getTable();var n=a.getItems();var s=this._iNavigateIndex>=0?n[this._iNavigateIndex]:a.getSelectedItem();var r=n.length;var o=0;var l=false;if(s){o=n.indexOf(s);o=o+e}else if(e>=0){o=e-1}else{o=r+e}if(e===9999){o=r-1}if(e===-9999){o=0}if(this.getMaxConditions()!==1){if(this.getParent().isOpen()&&a.getMode()===f.MultiSelect){a.focus();return}}a.addStyleClass("sapMListFocus");var h;if(o<0){o=0;h=true;l=true}else if(o>=r-1){o=r-1;h=false}else{h=e>=0}var d=function(){while(n[o]&&n[o].isA("sap.m.GroupHeaderListItem")){if(h){o++}else{o--}}};if(!t){d();if(o<0||o>r-1){h=!h;l=o<0;o=o<0?0:r-1;d()}}var u=n[o];if(u){var p;if(u!==s){this._iNavigateIndex=o;u.setSelected(true);if(t){this._handleScrolling(u);u.$().trigger("focusin")}if(u.isA("sap.m.GroupHeaderListItem")){this.setProperty("conditions",[],true);this.fireNavigated({condition:undefined,itemId:u.getId(),leaveFocus:false})}else{var c=this._getListItemBindingContext(u);var g=this.getItemFromContext(c);p=g&&this.createCondition(g.key,g.description,g.payload);this.setProperty("conditions",[p],true);this.fireNavigated({condition:p,itemId:u.getId(),leaveFocus:false})}}else if(l){this.fireNavigated({condition:undefined,itemId:undefined,leaveFocus:l})}}};_.prototype.isNavigationEnabled=function(e){if(e===1||e===-1){return true}else{return false}};_.prototype._handleScrolling=function(e){var t=this.getScrollDelegate();if(t){var i=this._getTable();var a=!isNaN(e)?e:i.indexOfItem(e);i.scrollToIndex(a).catch(function(e){});return true}return false};_.prototype.getScrollDelegate=function(){if(this._oScrollContainer){return this._oScrollContainer.getScrollDelegate()}return e.prototype.getScrollDelegate.apply(this,arguments)};_.prototype.removeFocus=function(){var e=this.getTable();if(e){e.removeStyleClass("sapMListFocus")}};_.prototype.getAriaAttributes=function(e){var t=this.getTable();var i=this.isTypeahead();var a=this.getUseAsValueHelp();var n=null;if(e!==1&&(i&&a||!i)){var s=C.apply(this);n=s.getText("MULTICOMBOBOX_ARIA_ROLE_DESCRIPTION")}return{contentId:t&&t.getId(),ariaHasPopup:"listbox",roleDescription:n}};function C(){if(!this._oResourceBundleM){this._oResourceBundleM=sap.ui.getCore().getLibraryResourceBundle("sap.m")}return this._oResourceBundleM}_.prototype.getContainerConfig=function(){return{"sap.ui.mdc.valuehelp.Popover":{getContentHeight:function(){var e=this._getTable();var t=e&&e.getDomRef();return t&&Math.round(t.getBoundingClientRect().height)}.bind(this),getFooter:function(){return this._retrievePromise("footer",function(){return this._retrievePromise("listBinding").then(function(e){var t=this.getListBindingInfo();var i=this.getParent().hasDialog();if(i&&t&&t.length){return n(["sap/m/Button","sap/m/Toolbar","sap/m/ToolbarSpacer"]).then(function(e){var t=e[0];var i=e[1];var a=e[2];var n=new t(this.getId()+"-showAllItems",{text:this._oMResourceBundle.getText("INPUT_SUGGESTIONS_SHOW_ALL"),press:function(){this.fireRequestSwitchToDialog()}.bind(this)});var s=[new a(this.getId()+"-Spacer")].concat(n);var r=new i(this.getId()+"-TB",{content:s});return r}.bind(this))}}.bind(this))}.bind(this))}.bind(this)}}};function B(){if(this._oTable&&this.getParent()){var e=this._oTable.getSticky();if(!e||e.length===0){this._oTable.setSticky([m.ColumnHeaders])}}}_.prototype.setParent=function(t){e.prototype.setParent.apply(this,arguments);B.call(this)};_.prototype.observeChanges=function(t){if(t.name==="config"){B.call(this)}if(t.name==="items"&&t.mutation==="ready"){this._resolvePromise("listBinding",t.bindingInfo.binding)}if(t.name==="table"){var i=t.child;if(t.mutation==="remove"){this._oObserver.unobserve(i);i.removeDelegate(this._oTableDelegate);this._oTable.detachItemPress(this._handleItemPress,this);this._oTable.detachSelectionChange(this._handleSelectionChange,this);this._oTable.detachUpdateFinished(this._handleUpdateFinished,this);this._oTable=null;this._removePromise("footer");this._addPromise("listBinding")}else{this._oTable=i;B.call(this);this._oTable.attachItemPress(this._handleItemPress,this);this._oTable.attachSelectionChange(this._handleSelectionChange,this);this._oTable.attachUpdateFinished(this._handleUpdateFinished,this);this._oTableDelegate=this._oTableDelegate||{onsapprevious:this._handleTableEvent,onsapnext:this._handleTableEvent,cellClick:this._handleTableEvent};i.addDelegate(this._oTableDelegate,true,this);var a=i.getBinding("items");if(a){this._resolvePromise("listBinding",a)}else{this._oObserver.observe(t.child,{bindings:["items"]})}}}e.prototype.observeChanges.apply(this,arguments)};_.prototype._handleTableEvent=function(e){if(!this.isTypeahead()){return}var t=this._getTable();var i=v.closestTo(e.target);switch(e.type){case"sapprevious":if(i.isA("sap.m.ListItemBase")){if(t.indexOfItem(i)===0){this.fireNavigated({condition:undefined,itemId:undefined,leaveFocus:true});e.preventDefault();e.stopPropagation();e.stopImmediatePropagation(true)}}break;default:break}};_.prototype.isQuickSelectSupported=function(){return true};_.prototype.isSingleSelect=function(){var t=this._getTable();if(t&&t.getMode()!==f.None){if(t.getMode()===f.MultiSelect){return false}else{return true}}else{return e.prototype.isSingleSelect.apply(this,arguments)}};_.prototype.onConnectionChange=function(){this._iNavigateIndex=-1};_.prototype.exit=function(){d.cleanup(this,["_sTableWidth","_oTable","_oScrollContainer","_oContentLayout","_oTablePanel","_oFilterBarVBox","_oMResourceBundle","_oResourceBundle","_oTableDelegate"]);e.prototype.exit.apply(this,arguments)};return _});
//# sourceMappingURL=MTable.js.map