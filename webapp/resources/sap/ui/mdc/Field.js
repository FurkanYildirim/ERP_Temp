/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/mdc/field/FieldBase","sap/ui/mdc/field/FieldBaseRenderer","sap/ui/mdc/enums/FieldDisplay","sap/ui/mdc/enums/BaseType","sap/base/util/deepEqual","sap/base/util/merge","sap/ui/model/BindingMode","sap/ui/model/Context","sap/ui/mdc/condition/Condition"],function(t,e,i,n,a,o,s,r,l){"use strict";var p=t.extend("sap.ui.mdc.Field",{metadata:{library:"sap.ui.mdc",designtime:"sap/ui/mdc/designtime/field/Field.designtime",properties:{value:{type:"any",defaultValue:null,bindable:"bindable"},additionalValue:{type:"any",defaultValue:null,bindable:"bindable"}},events:{change:{parameters:{value:{type:"string"},valid:{type:"boolean"},promise:{type:"Promise"}}}},defaultProperty:"value"},renderer:e});p.prototype.init=function(){this._vValue=null;this._vAdditionalValue=null;t.prototype.init.apply(this,arguments);this.setMaxConditions(1);this.setProperty("_operators",["EQ"],true);this._oObserver.observe(this,{properties:["value","additionalValue"]})};p.prototype.exit=function(){t.prototype.exit.apply(this,arguments);if(this._iConditionUpdateTimer){clearTimeout(this._iConditionUpdateTimer);delete this._iConditionUpdateTimer;delete this._bPendingConditionUpdate}this._oBindingContext=undefined};p.prototype.bindProperty=function(e,i){if(e==="value"&&!i.formatter){i.targetType="raw";var n=this.getContentFactory().getDataType();if(i.type&&(!n||n.getMetadata().getName()!==i.type.getMetadata().getName()||!a(n.getFormatOptions(),i.type.getFormatOptions())||!a(n.getConstraints(),i.type.getConstraints())||n._bCreatedByOperator!==i.type._bCreatedByOperator)){this.getContentFactory().setDataType(i.type);this.getContentFactory().setDateOriginalType(undefined);this.getContentFactory().setUnitOriginalType(undefined);this.getContentFactory().setIsMeasure(false);if(i.type.isA("sap.ui.model.CompositeType")&&i.parts){var o=[];for(var s=0;s<i.parts.length;s++){o.push(i.parts[s].type)}this.getContentFactory().setCompositeTypes(o)}this.getContentFactory().updateConditionType();this.invalidate()}}t.prototype.bindProperty.apply(this,arguments)};p.prototype.handleModelContextChange=function(e){t.prototype.handleModelContextChange.apply(this,arguments);var i=this.getBinding("value");if(i){var n=i.isA("sap.ui.model.CompositeBinding")?i.getBindings()[0].getContext():i.getContext();if(r.hasChanged(this._oBindingContext,n)){this._oBindingContext=n;this.getContentFactory().updateConditionType();if(this.isInvalidInput()||this._getValueHelp()){if(this._oManagedObjectModel){this._oManagedObjectModel.checkUpdate(true,true)}this.resetInvalidInput()}}if(!this.getContentFactory().getDataType()){this.getContentFactory().setDataType(i.getType());this.invalidate()}}};p.prototype.initDataType=function(){t.prototype.initDataType.apply(this,arguments);var e=this.getBinding("value");if(e){this.getContentFactory().setDataType(e.getType())}};p.prototype.setProperty=function(e,i,n){if(e==="value"&&this.isInvalidInput()&&a(this.getValue(),this.validateProperty(e,i))){if(this._oManagedObjectModel){this._oManagedObjectModel.checkUpdate(true,true)}this.resetInvalidInput()}return t.prototype.setProperty.apply(this,arguments)};p.prototype.setMaxConditions=function(t){if(t!==1){throw new Error("Only one condition allowed for Field "+this)}return this.setProperty("maxConditions",t,true)};p.prototype.observeChanges=function(e){t.prototype.observeChanges.apply(this,arguments);if(e.name==="value"){var i=y.call(this,e.current,e.old);if(this._vAdditionalValue!==null&&v.call(this)&&!f.call(this,i,this._vValue,true)){this._vAdditionalValue=this.getAdditionalValue()}this._vValue=i;c.call(this,e.current);u.call(this)}if(e.name==="additionalValue"){this._vAdditionalValue=e.current;u.call(this)}if(e.name==="conditions"){if(this.getCurrentContent().length<=1){C.call(this,e.current)}}};function d(){return this._vValue}function h(){return this._vAdditionalValue}function u(){if(!this.bDelegateInitialized){this.awaitControlDelegate().then(function(){if(!this.isFieldDestroyed()){u.call(this)}}.bind(this));return}if(this.getDisplay()===i.Value){g.call(this,d.call(this),h.call(this))}else if(!this._iConditionUpdateTimer){this._iConditionUpdateTimer=setTimeout(function(){g.call(this,d.call(this),h.call(this));this._iConditionUpdateTimer=undefined;this._bPendingConditionUpdate=false}.bind(this),0);this._bPendingConditionUpdate=true}}function g(t,e){var i=this.getConditions();if(this.checkValueInitial(t)&&!e){if(i.length>0){this.setConditions([])}}else{var n=i[0];var a=n&&n.values[0];var o=n&&n.values[1]?n.values[1]:null;if(!n||n.operator!=="EQ"||!f.call(this,a,t)||o!==e){var s=this.getControlDelegate();var r=s.createCondition(this,this,[t,e],n);if(!l.compareConditions(n,r)){this.setConditions(r?[r]:[])}}}}function y(t,e){var i=this.getContentFactory().getDataType()?this.getContentFactory().getDataType().getMetadata().getName():this.getDataType();if(t&&e&&(i==="sap.ui.model.odata.type.Unit"||i==="sap.ui.model.odata.type.Currency")&&!t[2]&&e[2]!==undefined){t=o([],t);t[2]=e[2];if(this._bPendingChange){var n=this.getConditions()[0];if(n){if(t[0]===e[0]&&t[0]!==n.values[0][0]){t[0]=n.values[0][0]}if(t[1]===e[1]&&t[1]!==n.values[0][1]){t[1]=n.values[0][1]}}}}return t}function f(t,e,i){var o=t===e;var s=this.getContentFactory().getDataType()?this.getContentFactory().getDataType().getMetadata().getName():this.getDataType();if(!o&&this.getTypeMap().getBaseType(s)===n.Unit&&Array.isArray(t)&&Array.isArray(e)){var r=t[0];var l=t[1];var p=t.length>=3?t[2]:null;var d=e[0];var h=e[1];var u=e.length>=3?e[2]:null;if(r===d&&l===h&&((this._bUnitSet||i)&&(!p||!u)||a(p,u))){o=true}if((p||u)&&!i){this._bUnitSet=true}}return o}function c(t){if(!this._oTypeInitialization){if(!this.bDelegateInitialized){this.awaitControlDelegate().then(function(){if(!this.isFieldDestroyed()){c.call(this,t)}}.bind(this));return}var e=this.getBinding("value");var i=e?e.getType():this.getContentFactory().getDataType();if(i){this._oTypeInitialization=this.getTypeMap().initializeTypeFromValue(i,t);if(this._oTypeInitialization&&this.getContentFactory().getUnitOriginalType()){this.getTypeMap().initializeInternalType(this.getContentFactory().getDataType(),this._oTypeInitialization);this.getTypeMap().initializeInternalType(this.getContentFactory().getUnitType(),this._oTypeInitialization)}}}}p.prototype.fireChangeEvent=function(t,e,i,n){var a;if(t){if(e){a=this.getResultForChangePromise(t)}else{a=i}}if(this.getCurrentContent().length>1){if(t){C.call(this,this.getConditions())}else if(n){n=n.then(function(t){C.call(this,this.getConditions());return t}.bind(this))}}this.fireChange({value:a,valid:e,promise:n})};p.prototype.getResultForChangePromise=function(t){var e;if(t.length===0&&this.getContentFactory().getDataType()){e=this.getContentFactory().getDataType().parseValue("","string",[])}else if(t.length===1){e=t[0].values[0]}return e};function C(t){if(!this.bDelegateInitialized){this.awaitControlDelegate().then(function(){if(!this.isFieldDestroyed()){C.call(this,t)}}.bind(this));return}var e=null;var i=null;var n=this.getValue();var a=this.getAdditionalValue();if(t.length===0&&n===null&&a===null){return}e=this.getResultForChangePromise(t);if(t.length===0&&!a){i=a}else if(t.length===1&&t[0].values.length>1){i=t[0].values[1]}this._vValue=e;this._vAdditionalValue=i;if(!f.call(this,e,n,true)){this.setProperty("value",e,true)}if(i!==a&&!v.call(this)){this.setProperty("additionalValue",i,true)}}p.prototype.getSupportedOperators=function(){return this.getProperty("_operators",[])};function v(){var t=this.getBinding("additionalValue");if(t&&t.getBindingMode()===s.OneWay){return true}return false}p.prototype.checkCreateInternalContent=function(){if(!this.isFieldDestroyed()&&this.getContentFactory().getDataType()&&!this.isFieldPropertyInitial("editMode")&&!this.isFieldPropertyInitial("multipleLines")){t.prototype.checkCreateInternalContent.apply(this,arguments)}};p.prototype.getOverflowToolbarConfig=function(){var e=t.prototype.getOverflowToolbarConfig.apply(this,arguments);e.propsUnrelatedToSize.push("value");e.propsUnrelatedToSize.push("additionalValue");return e};p.prototype.isSearchField=function(){return false};return p});
//# sourceMappingURL=Field.js.map