/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/ui/fl/changeHandler/condenser/Classification","sap/ui/fl/Utils"],function(e,t,r){"use strict";var n={};n.SOURCE_ALIAS="source";n.TARGET_ALIAS="target";n.MOVED_ELEMENTS_ALIAS="movedElements";function o(e,t,r,n){if(!e){return Promise.reject(new Error("No change instance"))}var o=e.getContent();if(!o||!o.movedElements||o.movedElements.length===0){return Promise.reject(new Error("Change format invalid"))}if(!o.source||!o.source.selector){return Promise.reject(new Error("No source supplied for move"))}if(!o.target||!o.target.selector){return Promise.reject(new Error("No target supplied for move"))}if(!t.bySelector(o.source.selector,n,r)){return Promise.reject(new Error("Move source parent not found"))}if(!t.bySelector(o.target.selector,n,r)){return Promise.reject(new Error("Move target parent not found"))}if(!o.source.selector.aggregation){return Promise.reject(new Error("No source aggregation supplied for move"))}if(!o.target.selector.aggregation){return Promise.reject(new Error("No target aggregation supplied for move"))}return Promise.resolve()}function a(e,t,r,n){if(!e.selector&&!e.id){return Promise.reject(new Error("Change format invalid - moveElements element has no id attribute"))}if(typeof e.targetIndex!=="number"){return Promise.reject(new Error("Missing targetIndex for element with id '"+e.selector.id+"' in movedElements supplied"))}return Promise.resolve().then(t.bySelector.bind(t,e.selector||e.id,r,n)).then(function(t){if(!t){return Promise.reject(new Error("Control to move was not found. Id: '"+e.selector.id+"'"))}return t})}function i(e){if(!e.movedElements){return Promise.reject(new Error("mSpecificChangeInfo.movedElements attribute required"))}if(e.movedElements.length===0){return Promise.reject(new Error("MovedElements array is empty"))}e.movedElements.forEach(function(e){if(!e.id){throw new Error("MovedControls element has no id attribute")}if(typeof e.sourceIndex!=="number"){throw new Error("SourceIndex attribute at MovedElements element is no number")}if(typeof e.targetIndex!=="number"){throw new Error("TargetIndex attribute at MovedElements element is no number")}});return Promise.resolve()}function s(e,t,r){delete t.source.publicAggregation;delete t.target.publicAggregation;var n;var o;return Promise.resolve().then(function(){return t.source.parent||e.bySelector(t.source.id,r)}).then(function(o){n=o;return t.target.parent||e.bySelector(t.target.id,r)}).then(function(a){o=a;var i=t.source.aggregation;var s=t.target.aggregation;var g={aggregation:t.source.aggregation,type:e.getControlType(n)};var u={aggregation:t.target.aggregation,type:e.getControlType(o)};var c={source:{id:n.getId(),aggregation:i,type:g.type,selector:e.getSelector(t.source.id,r,g)},target:{id:o.getId(),aggregation:s,type:u.type,selector:e.getSelector(t.target.id,r,u)},movedElements:t.movedElements};return c})}n.applyChange=function(e,t,n){var i=n.modifier;var s=n.view;var g=n.appComponent;var u;var c;var l;var d;var v;var m;var f;var h=false;var E=e.getContent();var p=[];var C=[];return o(e,i,s,g).then(function(){E.movedElements.forEach(function(e){var t=function(){return Promise.resolve().then(a.bind(null,e,i,g,s)).then(function(e){u=e;c=i.getParent(u);return n.sourceAggregation||i.getParentAggregationName(u,c)}).then(function(e){d=e;return i.bySelector(E.target.selector,g,s)}).then(function(e){l=e;v=n.targetAggregation||E.target.selector.aggregation;return i.findIndexInParentAggregation(u)}).then(function(t){m=t;f=e.targetIndex;if(m>-1){if(m===f&&d===v&&i.getParent(u)===l){m=e.sourceIndex;d=n.sourceAggregation||E.source.selector.aggregation;h=true;return i.bySelector(E.source.selector,g,s)}}return Promise.resolve()}).then(function(e){if(e){c=e}if(m>-1){p.unshift({index:m,aggregation:d,sourceParent:i.getSelector(c,g)})}if(!h){return Promise.resolve().then(i.removeAggregation.bind(i,c,d,u)).then(i.insertAggregation.bind(i,l,v,u,f,s))}return Promise.resolve()})};C.push(t)},this);return r.execPromiseQueueSequentially(C,true,true)}.bind(this)).then(function(){e.setRevertData(p)})};n.revertChange=function(t,n,i){var s=i.modifier;var g=i.view;var u=i.appComponent;var c=t.getContent();var l;var d;var v;var m;var f;var h;return o(t,s,g,u).then(s.bySelector.bind(s,c.source.selector,u,g)).then(function(e){l=e;v=c.source.selector.aggregation;m=c.target.selector.aggregation;return s.bySelector(c.target.selector,u,g)}).then(function(n){d=n;var o=t.getRevertData();c.movedElements.reverse();var i=[];c.movedElements.forEach(function(t,r){var n=function(){return Promise.resolve().then(a.bind(this,t,s,u,g)).then(function(n){f=n;if(!f){e.warning("Element to move not found");return Promise.reject()}h=t.sourceIndex;if(o){var a=o[r];v=a.aggregation;h=a.index;return s.bySelector(a.sourceParent,u,g)}return Promise.resolve()}).then(function(e){if(e){l=e}return s.removeAggregation(d,m,f)}).then(function(){return s.insertAggregation(l,v,f,h,g)})}.bind(this);i.push(n)},this);return r.execPromiseQueueSequentially(i,true,true)}.bind(this)).then(function(){t.resetRevertData()})};n.completeChangeContent=function(e,t,r){var o=r.modifier;var a=r.appComponent;return i(t).then(s.bind(this,o,t,a)).then(function(t){var i={movedElements:[],source:{selector:t.source.selector},target:{selector:t.target.selector}};var s=[];t.movedElements.forEach(function(g){var u=Promise.resolve().then(function(){return g.element||o.bySelector(g.id,a)}).then(function(s){i.movedElements.push({selector:o.getSelector(s,a),sourceIndex:g.sourceIndex,targetIndex:g.targetIndex});e.addDependentControl(t.source.id,n.SOURCE_ALIAS,r);e.addDependentControl(t.target.id,n.TARGET_ALIAS,r);e.addDependentControl(t.movedElements.map(function(e){return e.id}),n.MOVED_ELEMENTS_ALIAS,r)});s.push(u)});return Promise.all(s).then(function(){e.setContent(i)})})};n.getCondenserInfo=function(e){var r=e.getContent();var n=e.getRevertData()[0];return{affectedControl:r.movedElements[0].selector,classification:t.Move,sourceContainer:n.sourceParent,targetContainer:r.target.selector,sourceIndex:n.index,sourceAggregation:n.aggregation,targetAggregation:r.target.selector.aggregation,setTargetIndex:function(e,t){var r=e.getContent();r.movedElements[0].targetIndex=t;e.setContent(r)},getTargetIndex:function(e){return e.getContent().movedElements[0].targetIndex},setIndexInRevertData:function(e,t){var r=e.getRevertData();r[0].index=t;e.setRevertData(r)}}};n.getChangeVisualizationInfo=function(e){var t=e.getContent();var r=e.getRevertData()[0];return{affectedControls:[t.movedElements[0].selector],dependentControls:[t.source.selector],descriptionPayload:{sourceContainer:r.sourceParent,targetContainer:t.target.selector}}};return n},true);
//# sourceMappingURL=MoveControls.js.map