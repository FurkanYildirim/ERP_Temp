/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/initial/_internal/changeHandlers/ChangeHandlerStorage","sap/ui/fl/Utils","sap/ui/fl/Layer","sap/ui/fl/ChangePersistenceFactory","sap/ui/fl/write/_internal/Versions","sap/ui/fl/apply/_internal/changes/Applier","sap/ui/fl/apply/_internal/changes/Reverter","sap/ui/fl/apply/_internal/controlVariants/URLHandler","sap/ui/fl/apply/_internal/flexObjects/FlexObjectFactory","sap/ui/fl/apply/_internal/flexObjects/States","sap/ui/fl/apply/api/ControlVariantApplyAPI","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/util/reflection/XmlTreeModifier","sap/ui/core/Component","sap/base/Log"],function(e,t,n,r,o,i,a,s,p,h,c,l,u,f,g){"use strict";function C(e,t,n){return Promise.resolve().then(function(){if(n.length!==0){n.reverse();return a.revertMultipleChanges(n,{appComponent:e,modifier:l,flexController:this})}}.bind(this)).then(function(){if(e){var r=e.getModel(c.getVariantModelName());if(r){if(!t){s.update({parameters:[],updateURL:true,updateHashEntry:true,model:r})}}}return n})}var d=function(e){this._oChangePersistence=undefined;this._sComponentName=e||"";if(this._sComponentName){this._oChangePersistence=r.getChangePersistenceForComponent(this.getComponentName())}};d.prototype.getComponentName=function(){return this._sComponentName};d.prototype.setVariantSwitchPromise=function(e){this._oVariantSwitchPromise=e};d.prototype.waitForVariantSwitch=function(){if(!this._oVariantSwitchPromise){this._oVariantSwitchPromise=Promise.resolve()}return this._oVariantSwitchPromise};d.prototype.createBaseChange=function(e,t){if(!t){throw new Error("No application component found. To offer flexibility a valid relation to its owning component must be present.")}e.reference=this.getComponentName();e.packageName="$TMP";var n=p.createUIChange(e);if(e.variantReference){n.setVariantReference(e.variantReference)}return n};d.prototype._createChange=function(n,r,o){var i=o&&(o.controlType||t.getControlType(o));var a=this.createBaseChange(n,r);return e.getChangeHandler(a.getChangeType(),i,o,l,a.getLayer()).then(function(e){if(e){return e.completeChangeContent(a,n,{modifier:l,appComponent:r,view:t.getViewForControl(o)})}throw new Error("Change handler could not be retrieved for change "+JSON.stringify(n)+".")}).then(function(){a.setState(h.LifecycleState.NEW);return a}).catch(function(e){return Promise.reject(e)})};d.prototype.createChangeWithExtensionPointSelector=function(e,n){return Promise.resolve().then(function(){if(!n){throw new Error("A flexibility change on extension point cannot be created without a valid extension point reference.")}var r=n.view;var o=t.getAppComponentForControl(r);e.selector={name:n.name,viewSelector:l.getSelector(r.getId(),o)};return o}).then(function(t){return this._createChange(e,t)}.bind(this))};d.prototype.createChangeWithControlSelector=function(e,n){var r;return(new t.FakePromise).then(function(){if(!n){throw new Error("A flexibility change cannot be created without a targeted control.")}var o=n.id||n.getId();if(!e.selector){e.selector={}}r=n.appComponent||t.getAppComponentForControl(n);if(!r){throw new Error("No application component found. To offer flexibility, the control with the ID '"+o+"' has to have a valid relation to its owning application component.")}Object.assign(e.selector,l.getSelector(o,r));return r}).then(function(t){return this._createChange(e,t,n)}.bind(this))};d.prototype.addChange=function(e,n){return this.createChangeWithControlSelector(e,n).then(function(e){var r=t.getAppComponentForControl(n);e._ignoreOnce=true;this.addPreparedChange(e,r);e.setQueuedForApply();return e}.bind(this))};d.prototype.addPreparedChange=function(e,t){this._oChangePersistence.addChange(e,t);return e};d.prototype.deleteChange=function(e){this._oChangePersistence.deleteChange(e)};d.prototype.applyChange=function(e,n){var r={modifier:l,appComponent:t.getAppComponentForControl(n),view:t.getViewForControl(n)};return i.applyChangeOnControl(e,n,r).then(function(t){if(!t.success){var n=t.error||new Error("The change could not be applied.");this._oChangePersistence.deleteChange(e,true);throw n}return e}.bind(this))};function m(e,n,r,o,i){var a=y(e,o);if(!a){return[]}i.push(e);var s=e.getId();var p=n[s]&&n[s].dependencies||[];for(var h=0,c=p.length;h<c;h++){var l=t.getChangeFromChangesMap(r,p[h]);a=m(l,n,r,o,i);if(a.length===0){i=[];break}delete n[s]}return i}function y(e,t){var n=e.getDependentControlSelectorList();n.push(e.getSelector());return!n.some(function(e){return!l.bySelector(e,t)})}d.prototype.waitForChangesToBeApplied=function(e){var t=e.map(function(e){return this._waitForChangesToBeApplied(e)}.bind(this));return Promise.all(t).then(function(){return undefined})};d.prototype._waitForChangesToBeApplied=function(e){function n(t){return!t.isCurrentProcessFinished()&&(e.changeTypes.length===0||e.changeTypes.includes(t.getChangeType()))}e.changeTypes=e.changeTypes||[];var r=e.selector.id&&sap.ui.getCore().byId(e.selector.id)||e.selector;var o=this._oChangePersistence.getChangesMapForComponent();var i=[];var a=Object.assign({},o.mDependencies);var s=o.mChanges;var p=s[r.getId()]||[];var h=p.filter(n);var c=e.selector.appComponent||t.getAppComponentForControl(r);var l=[];h.forEach(function(e){var t=m(e,a,o.mChanges,c,[]);t.forEach(function(e){if(l.indexOf(e)===-1){l.push(e)}})});l.forEach(function(e){i=i.concat(e.addChangeProcessingPromises())},this);i.push(this.waitForVariantSwitch());return Promise.all(i)};d.prototype._removeOtherLayerChanges=function(e,t,r){if(r&&t){var o=Object.values(n).filter(function(e){return e!==t});return this.removeDirtyChanges(o,e,undefined,undefined,undefined,true)}return Promise.resolve()};d.prototype.saveAll=function(e,t,r,i,a,s){var p;var h;if(r){var c=o.getVersionsModel({reference:this._sComponentName,layer:n.CUSTOMER});p=c.getProperty("/persistedVersion");h=c.getProperty("/draftFilenames")}return this._removeOtherLayerChanges(e,i,a).then(this._oChangePersistence.saveDirtyChanges.bind(this._oChangePersistence,e,t,undefined,p,h,s,i)).then(function(e){if(r&&e&&e.response){var t=e.response;var n=[];if(Array.isArray(t)){t.forEach(function(e){n.push(e.fileName)});t=t[0]}o.onAllChangesSaved({reference:t.reference,layer:t.layer,draftFilenames:n})}return e})};d.prototype.processXmlView=function(e,n){var r=f.get(n.componentId);var o=t.getAppComponentForControl(r);n.appComponent=o;n.modifier=u;n.view=e;return this._oChangePersistence.getChangesForView(n).then(i.applyAllChangesForXMLView.bind(i,n)).catch(v.bind(this,n.view))};function v(e,t){g.error("Error processing view "+t+".");return e}d.prototype.getComponentChanges=function(e,t){return this._oChangePersistence.getChangesForComponent(e,t)};d.prototype.getOpenDependentChangesForControl=function(e,t){return this._oChangePersistence.getOpenDependentChangesForControl(e,t)};d.prototype.resetChanges=function(e,t,n,r,o){return this._oChangePersistence.resetChanges(e,t,r,o).then(C.bind(this,n,undefined))};d.prototype.removeDirtyChanges=function(e,t,n,r,o,i){return this._oChangePersistence.removeDirtyChanges(e,t,n,r,o).then(C.bind(this,t,i))};d.prototype.applyVariantChanges=function(e,n){var r;return e.reduce(function(e,t){return e.then(function(){var e={modifier:l,appComponent:n};this._oChangePersistence._addRunTimeCreatedChangeAndUpdateDependencies(n,t);r=e.modifier.bySelector(t.getSelector(),n);if(r){return i.applyChangeOnControl(t,r,e)}g.error("A flexibility change tries to change a nonexistent control.")}.bind(this))}.bind(this),new t.FakePromise)};d.prototype.saveSequenceOfDirtyChanges=function(e,t){return this._oChangePersistence.saveDirtyChanges(t,false,e)};return d});
//# sourceMappingURL=FlexController.js.map