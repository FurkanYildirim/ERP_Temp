/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/base/util/each","sap/base/util/merge","sap/base/util/ObjectPath","sap/base/Log","sap/ui/core/Component","sap/ui/fl/apply/_internal/flexObjects/FlexObjectFactory","sap/ui/fl/apply/_internal/flexState/appDescriptorChanges/prepareAppDescriptorMap","sap/ui/fl/apply/_internal/flexState/changes/prepareChangesMap","sap/ui/fl/apply/_internal/flexState/compVariants/prepareCompVariantsMap","sap/ui/fl/apply/_internal/flexState/DataSelector","sap/ui/fl/apply/_internal/flexState/InitialPrepareFunctions","sap/ui/fl/apply/_internal/flexState/Loader","sap/ui/fl/apply/_internal/flexState/ManifestUtils","sap/ui/fl/write/_internal/FlexInfoSession","sap/ui/fl/LayerUtils","sap/ui/fl/requireAsync","sap/ui/fl/Utils"],function(e,n,t,r,a,i,o,c,s,f,l,p,u,g,d,m,h,v){"use strict";var x={};var F={};var S={};var b={};var R;var O;var D;var C={appDescriptorChanges:{prepareFunction:c,pathInResponse:[]},changes:{initialPreparationFunctionName:"uiChanges",prepareFunction:s,pathInResponse:["changes"]},variants:{initialPreparationFunctionName:"variants",pathInResponse:["variants","variantChanges","variantDependentControlChanges","variantManagementChanges"]},compVariants:{prepareFunction:f,pathInResponse:["comp.variants","comp.standardVariants","comp.defaultVariants","comp.changes"]}};var j={compVariants:{},flexObjects:{}};function y(e){var n=i.get(e.componentId);e.componentData=e.componentData||n.getComponentData()||{};e.manifest=e.manifest||e.rawManifest||n.getManifestObject();e.reference=e.reference||g.getFlexReference(e)}function I(e){var t=[];n(e.changes,function(e,r){if(Array.isArray(r)){r.forEach(function(e){t.push(o.createFromFileContent(e,null,true))})}else if(e==="comp"){n(r,function(e,n){n.forEach(function(e){t.push(o.createFromFileContent(e,null,true))})})}});return t}function P(e,n){var t=C[e].initialPreparationFunctionName;var r=p[t];if(r){return r(n)}return undefined}function V(e,n,t){var r=P(e,n);if(r){N(t,r)}}var U=new l({id:"flexObjects",parameterKey:"reference",executeFunction:function(e,n){if(!F[n]){return[]}var t=F[n].runtimePersistence;return t.flexObjects.concat(t.runtimeOnlyData.flexObjects||[],j.flexObjects[n][F[n].componentId]||[])}});function M(e,n){if(!F[e]){throw new Error("State is not yet initialized")}if(!F[e].preparedMaps[n]){var t={unfilteredStorageResponse:F[e].unfilteredStorageResponse,storageResponse:F[e].storageResponse,componentId:F[e].componentId,componentData:F[e].componentData,reference:e,runtimePersistence:F[e].runtimePersistence};F[e].preparedMaps[n]=x.callPrepareFunction(n,t);V(n,t,e)}return F[e].preparedMaps[n]}function N(e,n){F[e]=t(F[e],n);U.checkUpdate({reference:e})}function z(e){return M(e,"appDescriptorChanges")}function L(e){return M(e,"changes")}function _(e){return M(e,"compVariants")}function k(e,n){var r={flexObjects:I(e),runtimeOnlyData:{flexObjects:[]}};Object.keys(C).forEach(function(a){var i=P(a,{storageResponse:e,externalData:n});if(i){r=t(r,i)}});return r}function E(e){var n=e.reference;var t=false;if(!F[n].componentData){var a=i.get(e.componentId);F[n].componentData=a?a.getComponentData():e.componentData;t=true}if(!F[n].storageResponse){F[n].storageResponse=w(F[n].unfilteredStorageResponse);delete F[n].runtimePersistence;t=true}if(!r.get(["flexObjects",n,e.componentId],j)){r.set(["flexObjects",n,e.componentId],[],j)}if(!F[n].runtimePersistence){F[n].runtimePersistence=k(F[n].storageResponse,j.flexObjects[n][e.componentId]||[]);t=true}if(t){U.checkUpdate({reference:n})}}function w(e){var a=t({},e);var i=a.changes;var o=Q("URLParsing");if(m.isLayerFilteringRequired(o)){n(C,function(e,n){n.pathInResponse.forEach(function(e){r.set(e,m.filterChangeDefinitionsByMaxLayer(r.get(e,i),o),i)})})}return a}function A(e){b[e.reference]=u.loadFlexData(e).then(function(n){F[e.reference]=t({},{unfilteredStorageResponse:n,preparedMaps:{},componentId:e.componentId,componentData:e.componentData,partialFlexState:e.partialFlexState});T(e.reference);B(e.reference,n);Object.freeze(F[e.reference].storageResponse);Object.freeze(F[e.reference].unfilteredStorageResponse);return n});return b[e.reference]}function B(e,n){var t=n&&n.changes||{};var r=d.getByReference(e);if(r===null){r={}}if(t.info!==undefined){r=Object.assign(r,t.info)}d.setByReference(r,e)}function T(e){var n=Q("ShellNavigation");if(n&&!S[e]){S[e]=K.bind(null,e);n.registerNavigationFilter(S[e])}}function q(e){var n=Q("ShellNavigation");if(n){if(S[e]){n.unregisterNavigationFilter(S[e]);delete S[e]}}}function K(e,n,t){var r=Q("ShellNavigation");if(r){try{var i=m.getMaxLayerTechnicalParameter(n,Q("URLParsing"));var o=m.getMaxLayerTechnicalParameter(t,Q("URLParsing"));if(i!==o){x.rebuildFilteredResponse(e)}}catch(e){a.error(e.message)}return r.NavigationFilterStatus.Continue}return undefined}function G(e){var n=F[e.reference];if(n.partialFlexState===true&&e.partialFlexState!==true){n.partialFlexState=false;e.partialFlexData=t({},n.unfilteredStorageResponse.changes);e.reInitialize=true}return e}function H(e){var n=F[e.reference].componentId;if(!e.reInitialize&&n!==e.componentId){e.reInitialize=true}return e}function J(){return Promise.all([v.getUShellService("ShellNavigation"),v.getUShellService("URLParsing")]).then(function(e){R=e[0];O=e[1]}).catch(function(e){a.error("Error getting service from Unified Shell: "+e.message)})}function Q(e){if(v.getUshellContainer()){if(e==="ShellNavigation"){return R}else if(e==="URLParsing"){return O}}return undefined}function W(){return h("sap/ui/fl/ChangePersistenceFactory").then(function(e){D=e}).catch(function(e){a.error("Error loading modules: "+e.message)})}x.initialize=function(e){return Promise.all([J(),W()]).then(function(){y(e);var n=e.reference;if(b[n]){return b[n].then(G.bind(null,e)).then(H).then(function(e){return e.reInitialize?A(e):F[n].unfilteredStorageResponse})}return A(e)}).then(function(e){E(e)}.bind(null,e))};x.isInitialized=function(e){var n=e.reference?e.reference:g.getFlexReferenceForControl(e.control);return!!F[n]};x.clearAndInitialize=function(e){y(e);x.clearState(e.reference);return x.initialize(e)};x.clearState=function(e){if(e){q(e);delete F[e];delete b[e];U.clearCachedResult({reference:e});if(D&&(D._instanceCache||{}).hasOwnProperty(e)){D._instanceCache[e].removeDirtyChanges()}}else{Object.keys(F).forEach(function(e){q(e)});F={};b={};U.clearCachedResult()}};x.setInitialNonFlCompVariantData=function(e,n,t,r,a){j.compVariants[e]=j.compVariants[e]||{};j.compVariants[e][n]={};j.compVariants[e][n].standardVariant=t;j.compVariants[e][n].variants=r;j.compVariants[e][n].controlId=a};x.getInitialNonFlCompVariantData=function(e){return j.compVariants[e]};x.resetInitialNonFlCompVariantData=function(e){delete j.compVariants[e]};x.addFakeStandardVariantToExternalData=function(e,n,t){if(!j.flexObjects[e]){j.flexObjects[e]={}}if(!j.flexObjects[e][n]){j.flexObjects[e][n]=[]}j.flexObjects[e][n].push(t);U.checkUpdate({reference:e})};x.resetFakeStandardVariants=function(e,n){if(j.flexObjects[e]){delete j.flexObjects[e][n];U.clearCachedResult({reference:e})}};x.rebuildFilteredResponse=function(e){if(F[e]){F[e].preparedMaps={};F[e].storageResponse=w(F[e].unfilteredStorageResponse);F[e].runtimePersistence=k(F[e].storageResponse,j.flexObjects[e][F[e].componentId]||[]);U.checkUpdate({reference:e})}};x.addDirtyFlexObject=function(e,n){if(F[e]){F[e].runtimePersistence.flexObjects.push(n);U.checkUpdate({reference:e})}};x.removeDirtyFlexObject=function(e,n){if(F[e]){var t=F[e].runtimePersistence.flexObjects;var r=t.indexOf(n);t.splice(r,1);U.checkUpdate({reference:e})}};x.getFlexObjectsDataSelector=function(){return U};x.getUIChanges=function(e){return L(e).changes};x.getAppDescriptorChanges=function(e){return z(e).appDescriptorChanges};x.getUI2Personalization=function(e){return F[e].unfilteredStorageResponse.changes.ui2personalization};x.getCompVariantsMap=function(e){return _(e)};x.callPrepareFunction=function(e,n){return C[e].prepareFunction(n)};x.getStorageResponse=function(e){if(b[e]){return b[e].then(function(){return F[e].unfilteredStorageResponse})}return Promise.resolve()};x.getFlexObjectsFromStorageResponse=function(e){return F[e]&&F[e].unfilteredStorageResponse.changes};x.getComponentData=function(e){return F[e]&&F[e].componentData};return x});
//# sourceMappingURL=FlexState.js.map