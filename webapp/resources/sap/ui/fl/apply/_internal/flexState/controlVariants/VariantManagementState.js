/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/base/util/restricted/_pick","sap/base/util/ObjectPath","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/fl/apply/_internal/controlVariants/Utils","sap/ui/fl/apply/_internal/flexState/DataSelector","sap/ui/fl/apply/_internal/flexObjects/States","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/LayerUtils","sap/ui/fl/Utils"],function(e,t,n,r,a,i,c,f,u,o){"use strict";var s={};var l={};function g(e,t,r){var i=f.getComponentData(e);var c=n.get(["technicalParameters",a.VARIANT_TECHNICAL_PARAMETER],i)||[];var u=r.map(function(e){return e.getId()});var o=u.find(function(e){return c.includes(e)});if(o){return o}return t.reverse().map(function(e){return e.getContent().defaultVariant}).find(function(e){return u.includes(e)})}function v(e,t,r,a){var i=(l[r]||{})[a];var c=t.filter(function(e){return a===e.getVariantManagementReference()});if(!i||!c.find(function(e){return e.getId()===i})){var f=e.filter(function(e){return e.getFileType()==="ctrl_variant_management_change"&&a===e.getSelector().id});i=g(r,f,c)||a;n.set([r,a],i,l)}return{defaultVariant:a,currentVariant:i,variants:[],variantManagementChanges:e.filter(function(e){return e.getFileType()==="ctrl_variant_management_change"&&e.getSelector().id===a})}}function d(e,t){return{instance:t,variantChanges:e.filter(function(e){return e.getFileType()==="ctrl_variant_change"&&e.getSelector().id===t.getId()}),controlChanges:e.filter(function(e){var n=e.isA("sap.ui.fl.apply._internal.flexObjects.UIChange");if(!n){return false}var r=e.getVariantReference()===t.getId();var a=e.getVariantReference()===t.getVariantReference();var i=u.compareAgainstCurrentLayer(e.getLayer(),t.getLayer())===-1;return r||a&&i}),key:t.getId(),title:t.getName(),layer:t.getLayer(),favorite:t.getFavorite(),executeOnSelect:t.getExecuteOnSelection(),visible:t.getVisible(),author:t.getSupportInformation().user,contexts:t.getContexts(),isStandardVariant:t.getStandardVariant()}}function p(e,t,n,r){switch(t.getChangeType()){case"setTitle":e.title=t.getText("title");break;case"setFavorite":e.favorite=t.getContent().favorite;break;case"setExecuteOnSelect":e.executeOnSelect=t.getContent().executeOnSelect;break;case"setVisible":e.visible=t.getContent().visible;var a=e.instance.getVariantManagementReference();if(l[n][a]===e.key&&!e.visible){l[n][a]=a;r[a].currentVariant=a}break;case"setContexts":e.contexts=t.getContent().contexts;break;default:throw Error("Unknown ctrl_variant_change type")}}function m(e,t){var n=t.getContent().defaultVariant;if(e.variants.some(function(e){return e.key===n})){e.defaultVariant=n}}function V(e,t){var n=e.filter(function(e){return e.getFileType()==="ctrl_variant"});var r={};n.forEach(function(a){var i=a.getVariantManagementReference();if(!r[i]){r[i]=v(e,n,t,i)}r[i].variants.push(d(e,a))});e.filter(function(e){return e.getFileType()==="ctrl_variant_change"}).forEach(function(e){var n=C(r,e);p(n,e,t,r)});e.filter(function(e){return e.getFileType()==="ctrl_variant_management_change"}).forEach(function(e){var t=r[e.getSelector().id];if(t){m(t,e)}});Object.values(r).forEach(function(e){e.variants.sort(function(e,t){if(e.isStandardVariant){return-1}if(t.isStandardVariant){return 1}return e.title.toLowerCase()<t.title.toLowerCase()?-1:1});var t=e.variants.find(function(t){return t.key===e.currentVariant}).controlChanges;e.modified=t.some(function(e){return!e.isPersisted()&&!e.getSavedToVariant()})});return r}function C(e,t){var n;Object.values(e).some(function(e){return e.variants.some(function(e){if(t.getSelector().id===e.key){n=e;return true}return false})});return n}var h=new i({id:"variantManagementMap",parameterKey:"reference",parentDataSelector:f.getFlexObjectsDataSelector(),executeFunction:V});var S=new i({id:"variantManagements",parameterKey:"variantManagementReference",parentDataSelector:h,executeFunction:function(e,t){return e[t]}});var y=new i({id:"variants",parameterKey:"variantReference",parentDataSelector:S,executeFunction:function(e,t){return e.variants.find(function(e){return e.instance.getId()===t})}});s.resetCurrentVariantReferences=function(){l={}};s.getVariantManagementMap=function(){return h};s.addFakeStandardVariant=function(e,t,n,r){var a=this.getVariantManagementMap().get({reference:e});if(!a[n]){f.addFakeStandardVariantToExternalData(e,t,r)}};s.clearFakeStandardVariants=function(e,t){f.resetFakeStandardVariants(e,t)};s.getControlChangesForVariant=function(e){var t=[];var n=s.getVariant(e);if(n){t=n.controlChanges.filter(function(t){return e.includeDirtyChanges!==false||t.getState()===c.LifecycleState.PERSISTED})}return t};s.getVariantChangesForVariant=function(e){var t=s.getVariant(e);return t&&t.variantChanges||{}};s.getVariant=function(e){var t=e.vReference||S.get({variantManagementReference:e.vmReference,reference:e.reference}).defaultVariant;return y.get({variantManagementReference:e.vmReference,variantReference:t,reference:e.reference})};s.getCurrentVariantReference=function(e){var t=S.get({variantManagementReference:e.vmReference,reference:e.reference});return t.currentVariant};s.getVariantManagementReferences=function(e){var t=h.get({reference:e});return Object.keys(t)};s.getInitialChanges=function(e){var t=h.get({reference:e.reference});return Object.keys(t).reduce(function(n,r){if(e.vmReference&&e.vmReference===r||!e.vmReference){var a=Object.assign({},e,{vmReference:r,vReference:t[r].currentVariant,includeDirtyChanges:false});return n.concat(s.getControlChangesForVariant(a))}return n},[])};s.setCurrentVariant=function(e){n.set([e.reference,e.vmReference],e.newVReference,l);h.checkUpdate({reference:e.reference})};s.waitForInitialVariantChanges=function(e){var t=s.getInitialChanges({vmReference:e.vmReference,reference:e.reference});var n=t.reduce(function(t,n){var a=n.getSelector();var i=r.bySelector(a,e.appComponent);if(i&&o.indexOfObject(t,{selector:i})===-1){t.push({selector:i})}return t},[]);return n.length?e.flexController.waitForChangesToBeApplied(n):Promise.resolve()};return s});
//# sourceMappingURL=VariantManagementState.js.map