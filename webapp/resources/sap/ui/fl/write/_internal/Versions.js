/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/registry/Settings","sap/ui/fl/ChangePersistenceFactory","sap/ui/fl/write/_internal/Storage","sap/ui/fl/write/api/Version","sap/ui/model/json/JSONModel","sap/ui/model/BindingMode"],function(e,r,t,n,i,s){"use strict";var a={};var o=9;var f=o+1;function d(e,r){var t=l(e,r);t.setDefaultBindingMode(s.OneWay);t.setSizeLimit(o);t.setDirtyChanges=function(e){t.setProperty("/dirtyChanges",e);t.updateDraftVersion();t.updateBindings(true)};t.updateDraftVersion=function(){var e=t.getProperty("/versions");var r=t.getProperty("/versioningEnabled");var i=t.getProperty("/dirtyChanges");var s=t.getProperty("/backendDraft");var a=r&&(i||s);t.setProperty("/draftAvailable",a);if(i){t.setProperty("/displayedVersion",n.Number.Draft)}if(!v(e)&&a){e.splice(0,0,{version:n.Number.Draft,type:n.Type.Draft,filenames:[],isPublished:false})}if(v(e)&&!a){e.shift();t.setProperty("/displayedVersion",t.getProperty("/persistedVersion"))}var o=t.getProperty("/displayedVersion")!==t.getProperty("/activeVersion");t.setProperty("/activateEnabled",o)};return t}function l(e,r,t){var s;var a=false;var o=n.Number.Original;var f=v(r);var d=[];if(r.length>0){s=r[0].version}else{s=n.Number.Original}r.forEach(function(e){if(e.version===n.Number.Draft){e.type=n.Type.Draft;e.isPublished=false;d=e.filenames}else{if(o===n.Number.Original){e.type=n.Type.Active;o=e.version}else{e.type=n.Type.Inactive}if(e.version===s&&e.isPublished===false){a=true}}});if(t){t.setProperty("/publishVersionEnabled",a);t.setProperty("/versioningEnabled",e);t.setProperty("/versions",r);t.setProperty("/backendDraft",f);t.setProperty("/dirtyChanges",false);t.setProperty("/draftAvailable",f);t.setProperty("/activateEnabled",f);t.setProperty("/activeVersion",o);t.setProperty("/persistedVersion",s);t.setProperty("/displayedVersion",s);t.setProperty("/draftFilenames",d);t.updateBindings(true)}else{t=new i({publishVersionEnabled:a,versioningEnabled:e,versions:r,backendDraft:f,dirtyChanges:false,draftAvailable:f,activateEnabled:f,activeVersion:o,persistedVersion:s,displayedVersion:s,draftFilenames:d})}return t}function u(e,r){var t=[];var n=r.changePersistences;n.forEach(function(e){t=e.getDirtyChanges().concat();t.forEach(function(r){e.deleteChange(r,true)})});return t.length>0}function c(e){var t={dirtyChangesExist:false,changePersistences:[]};if(e.reference){var n=r.getChangePersistenceForComponent(e.reference);if(n.getDirtyChanges().length>0){t.dirtyChangesExist=true;t.changePersistences.push(n)}}if(e.nonNormalizedReference){var i=r.getChangePersistenceForComponent(e.nonNormalizedReference);if(i.getDirtyChanges().length>0){t.dirtyChangesExist=true;t.changePersistences.push(i)}}return t}function v(e){return e.some(function(e){return e.version===n.Number.Draft})}function p(e,r){e.setProperty("/backendDraft",false);e.setProperty("/dirtyChanges",false);e.setProperty("/draftAvailable",false);e.setProperty("/activateEnabled",false);e.setProperty("/displayedVersion",r);e.setProperty("/persistedVersion",r);e.updateBindings(true)}var y={};y.initialize=function(r){var n=r.reference;var i=r.layer;r.limit=f;return e.getInstance().then(function(e){var s=e.isVersioningEnabled(i);if(a&&a[n]&&a[n][i]){return a[n][i]}var o=s?t.versions.load(r):Promise.resolve([]);return o.then(function(e){return d(s,e)}).then(function(e){a[n]=a[n]||{};a[n][i]=a[n][i]||{};a[n][i]=e;return a[n][i]})})};y.getVersionsModel=function(e){var r=e.reference;var t=e.layer;if(!y.hasVersionsModel(e)){throw Error("Versions Model for reference '"+r+"' and layer '"+t+"' were not initialized.")}var n=c(e);if(n.dirtyChangesExist){a[r][t].updateDraftVersion(e)}return a[r][t]};y.hasVersionsModel=function(e){var r=e.reference;var t=e.layer;return a[r]&&a[r][t]};y.clearInstances=function(){a={}};y.updateModelFromBackend=function(e){if(y.hasVersionsModel(e)){e.limit=f;return t.versions.load(e).then(function(r){var t=y.getVersionsModel(e);return l(t.getProperty("/versioningEnabled"),r,t)})}};y.onAllChangesSaved=function(e){var r=y.getVersionsModel(e);var t=r.getProperty("/versioningEnabled");var i=r.getProperty("/dirtyChanges");var s=r.getProperty("/draftFilenames");r.setProperty("/draftFilenames",s.concat(e.draftFilenames));r.setProperty("/dirtyChanges",true);r.setProperty("/backendDraft",t&&i||!!e.contextBasedAdaptation);r.updateDraftVersion();r.setProperty("/persistedVersion",n.Number.Draft);r.updateBindings(true)};y.activate=function(e){var r=y.getVersionsModel(e);var i=r.getProperty("/versions");var s=v(i);var a=r.getProperty("/activeVersion");if(e.displayedVersion===a){return Promise.reject("Version is already active")}e.version=e.displayedVersion;var o=c(e);var f=o.changePersistences;var d=f.some(function(e){return e.getDirtyChanges().length>0});if(d){return Promise.reject("unsaved changes exists")}return t.versions.activate(e).then(function(e){i.forEach(function(e){e.type=n.Type.Inactive});e.type=n.Type.Active;e.isPublished=false;if(s){i.shift()}i.splice(0,0,e);r.setProperty("/activeVersion",e.version);r.setProperty("/publishVersionEnabled",true);r.setProperty("/draftFilenames",[]);p(r,e.version)})};y.discardDraft=function(e){var r=y.getVersionsModel(e);var n=c(e);var i=r.getProperty("/backendDraft");var s=i?t.versions.discardDraft(e):Promise.resolve();return s.then(function(){var t=r.getProperty("/versions");t.shift();p(r,r.getProperty("/activeVersion"));var s=u(e,n);return{backendChangesDiscarded:i,dirtyChangesDiscarded:s}})};y.publish=function(e){var r=y.getVersionsModel({reference:e.reference,layer:e.layer});return t.versions.publish(e).then(function(t){if(t!=="Error"&&t!=="Cancel"){r.setProperty("/publishVersionEnabled",false);var n=r.getProperty("/versions");var i=false;n.forEach(function(r){if(r.isPublished){return}if(r.version===e.version){i=true}if(i&&!r.isPublished){r.isPublished=true}})}return t})};return y});
//# sourceMappingURL=Versions.js.map