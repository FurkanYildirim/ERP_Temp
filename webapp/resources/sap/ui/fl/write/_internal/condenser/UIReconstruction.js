/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_isEqual","sap/base/util/each","sap/base/util/ObjectPath","sap/ui/fl/changeHandler/condenser/Classification","sap/ui/fl/write/_internal/condenser/classifications/Create","sap/ui/fl/write/_internal/condenser/classifications/Destroy","sap/ui/fl/write/_internal/condenser/classifications/Move","sap/ui/fl/write/_internal/condenser/Utils"],function(n,e,t,r,i,a,c,f){"use strict";var o={};var s={create:i,destroy:a,move:c};function u(n,t){e(n,function(n,r){e(r,function(e,i){t(r,n,i,e)})})}function l(n,e,t){n.splice(t,0,n.splice(e,1)[0])}function h(n,e){var t={};u(n,function(n,r,i,a){var c=i[f.TARGET_UI];var o=i[f.INITIAL_UI];e.forEach(function(n){var e=c.indexOf(n.affectedControl)>-1||o.indexOf(n.affectedControl)>-1;if(a===n.targetAggregation&&e){if(!t[r]){t[r]={}}var i=t[r];if(!i[a]){i[a]=[]}var f=i[a];f.push(n)}})});return t}function d(n){return!n.some(function(n){return n.classification!==r.Create})}function v(n){return!n.some(function(n){return f.isUnknown(n)})}function g(n){return n.getTargetIndex(n.change)}function I(n){n.sort(function(n,e){var t=g(n);var r=g(e);return t-r})}function E(n){return!n.some(function(n){return!f.isUnknown(n)})}function T(e,t){var r;if(e.length<t.length){r=t.slice(e.length);if(!E(r)){return false}t=t.slice(0,e.length)}else if(e.length>t.length){r=e.slice(t.length,e.length);if(!E(r)){return false}e=e.slice(0,t.length)}return n(e,t)}function p(n,e,t,r,i){var a={};i.forEach(function(n){var r=n.targetContainer;if(!a[r]){a[r]={}}var i=a[r];if(!i[e]){i[e]=f.initializeArrayWithPlaceholders(0,t.length-1)}s[n.classification].simulate(i[e],n,t)});var c=a[n][e];if(T(r,c)){i.forEach(function(n){if(n.sameIndex){n.change.condenserState="delete"}});return true}return false}function _(n,e){function t(n,e){if(g(e)!==n){var t=e.change.getState();e.setTargetIndex(e.change,n);e.change.setState(t);if(e.change.isPersisted()){e.change.condenserState="update"}}}function i(e,i,a){a[f.TARGET_UI].forEach(function(e,i){if(!f.isUnknown(e)){var a=n[e];var c=a[f.INDEX_RELEVANT];u(c,function(n,e,a,c){if(c!==r.Destroy){a.forEach(t.bind(this,i))}})}})}u(e,i)}function A(n,e){u(e,function(e,t,r,i){var a=r[f.INITIAL_UI];var c=r[f.TARGET_UI];if(T(a,c)){c.forEach(function(e){var t=n[e];if(t!==undefined){u(t[f.INDEX_RELEVANT],function(n,e,t){t.forEach(function(n){n.change.condenserState="delete"})});delete t[f.INDEX_RELEVANT]}});delete e[i]}})}function U(n,e){u(e,function(e,r,i,a){var c=i[f.INITIAL_UI];var o=i[f.TARGET_UI];c.forEach(function(e,r){var i=n[e];if(!i||!t.get([f.INDEX_RELEVANT,a],i)){var c=f.PLACEHOLDER+r;var s=o.indexOf(e);if(s>=0){o[s]=c}}})})}o.swapChanges=function(n,e){var t=n.map(function(n){return e.indexOf(n)}).sort();n.forEach(function(n){e[t.shift()]=n})};o.sortIndexRelatedChanges=function(n,e){var t=[];var r=h(n,e);u(r,function(e,r,i,a){var c=n[r][a][f.TARGET_UI];var o=n[r][a][f.INITIAL_UI];var s=true;if(v(c)||d(i)){I(i);s=p(r,a,o,c,i)}else if(!p(r,a,o,c,i)){s=false;var u=i.length;while(u!==0&&!s){var h=0;var g=1;while(g<i.length&&!s){l(i,h,g);s=p(r,a,o,c,i);h++;g++}u--}}if(!s){throw Error("no correct sorting found for the container: "+r)}i=i.filter(function(n){return n.change.condenserState!=="delete"});t.push(i.map(function(n){if(n.revertIndex>-1){n.setIndexInRevertData(n.change,n.revertIndex);n.sourceIndex=n.revertIndex}return n.change}))});return t};o.addChange=function(n,e){return s[e.classification].addToReconstructionMap(n,e)};o.compareAndUpdate=function(n,e){A(n,e);U(n,e);_(n,e)};return o});
//# sourceMappingURL=UIReconstruction.js.map