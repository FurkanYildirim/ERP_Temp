/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/write/api/Adaptations","sap/ui/fl/write/api/FeaturesAPI","sap/ui/fl/apply/_internal/flexObjects/FlexObjectFactory","sap/ui/fl/apply/_internal/flexState/ManifestUtils","sap/ui/fl/write/_internal/flexState/FlexObjectState","sap/ui/fl/Layer","sap/ui/fl/LayerUtils","sap/ui/fl/Utils","sap/ui/fl/write/_internal/FlexInfoSession","sap/ui/fl/write/_internal/Storage","sap/ui/fl/write/_internal/Versions","sap/ui/model/json/JSONModel"],function(e,t,a,r,n,i,o,d,p,l,s,c){"use strict";var u={};var f={};function y(e){var t=r.getFlexReferenceForControl(e);if(!t){throw Error("The application ID could not be determined")}return t}function v(e,t,a,r){if(r){return s.updateModelFromBackend({reference:a.appId,layer:a.layer}).then(function(){return e})}s.onAllChangesSaved({reference:a.appId,layer:a.layer,contextBasedAdaptation:true});return Promise.resolve(e)}f.initialize=function(e){if(!e.layer){return Promise.reject("No layer was provided")}if(!e.control){return Promise.reject("No control was provided")}var a=y(e.control);e.reference=a;var r=e.layer;if(u&&u[a]&&u[a][r]){return Promise.resolve(u[a][r])}var n;return t.isContextBasedAdaptationAvailable(r).then(function(t){n=t;var a=n?f.load(e):Promise.resolve({adaptations:[]});return a}).then(function(t){var a=p.get(e.control)||{};var r=t.adaptations[0];if(a.adaptationId){r=t.adaptations.find(function(e){return e.id===a.adaptationId})||r}return f.createModel(t.adaptations,r,n)}).then(function(e){u[a]=u[a]||{};u[a][r]=u[a][r]||{};u[a][r]=e;return u[a][r]})};f.createModel=function(t,a,r){if(!Array.isArray(t)){throw Error("Adaptations model can only be initialized with an array of adaptations")}if(r&&!a){throw Error("Invalid call, must pass displayed adaptation")}if(!r&&t.length){throw Error("Invalid call, must not pass adaptations if feature is disabled")}var n=new c({allAdaptations:[],adaptations:[],count:0,displayedAdaptation:{},contextBasedAdaptationsEnabled:r});n.updateAdaptations=function(t){var a=t.filter(function(t,a){t.rank=a+1;return t.type!==e.Type.Default});n.setProperty("/adaptations",a);n.setProperty("/allAdaptations",t);n.setProperty("/count",a.length);n.updateBindings(true)};n.insertAdaptation=function(e){var t=n.getProperty("/allAdaptations");t.splice(e.priority,0,e);delete e.priority;n.updateAdaptations(t)};n.deleteAdaptation=function(){var e=n.getProperty("/displayedAdaptation").rank-1;var t=n.getProperty("/adaptations");var a=n.getProperty("/count");var r;if(a>1){r=t[e+(e===a-1?-1:1)].id}t.splice(e,1);var i=n.getProperty("/allAdaptations").pop();t.push(i);n.updateAdaptations(t);return r};n.switchDisplayedAdaptation=function(e){var t=n.getIndexByAdaptationId(e);var a=t?n.getProperty("/allAdaptations")[t]:n.getProperty("/allAdaptations")[0];n.setProperty("/displayedAdaptation",a);n.updateBindings(true)};n.updateAdaptationContent=function(e){var t=n.getProperty("/allAdaptations");var a=n.getProperty("/displayedAdaptation").rank-1;t[a].title=e.title;t[a].contexts=e.contexts;if(a!==e.priority){var r=t.splice(a,1);t.splice(e.priority,0,r[0])}n.updateAdaptations(t)};n.getIndexByAdaptationId=function(e){var t=n.getProperty("/allAdaptations");var a=t.findIndex(function(t){return t.id===e});return a>-1?a:undefined};if(t.length>0){n.updateAdaptations(t);n.setProperty("/displayedAdaptation",a)}return n};f.getAdaptationsModel=function(e){if(!e.layer){throw Error("No layer was provided")}if(!e.control){throw Error("No control was provided")}e.reference=y(e.control);var t=e.reference;var a=e.layer;if(!f.hasAdaptationsModel(e)){throw Error("Adaptations model for reference '"+t+"' and layer '"+a+"' were not initialized.")}return u[t][a]};f.getDisplayedAdaptationId=function(t){var a=this.getAdaptationsModel(t).getProperty("/displayedAdaptation/id");return a!==e.Type.Default?a:undefined};f.hasAdaptationsModel=function(e){var t=e.reference;var a=e.layer;return u[t]&&u[t][a]};f.adaptationExists=function(e){var t=e.reference;var a=e.layer;return this.hasAdaptationsModel({reference:t,layer:a})&&u[t][a].getProperty("/count")>0};f.clearInstances=function(){u={}};f.refreshAdaptationModel=function(e){this.clearInstances();return this.initialize(e).then(function(e){return e.getProperty("/displayedAdaptation/id")})};function A(e,t){return e.get(t)||t}function g(e,t,r,n){e.forEach(function(e){var i=a.createFromFileContent(e.cloneFileContentWithNewId());var o=i.getId();i.setAdaptationId(n);t.push(i);r.set(e.getId(),o)})}function h(e,t,r,n){e.forEach(function(e){var i=d.createDefaultFileName(e.getId().split("_").pop());var o=a.createFromFileContent(e.cloneFileContentWithNewId(i));if(e.getFileType()==="change"){if(e.getSelector().variantId){o.getSelector().variantId=A(r,o.getSelector().variantId)}else if(e.getContent().defaultVariantName){o.getContent().defaultVariantName=A(r,o.getContent().defaultVariantName)}if(e.getVariantReference()){o.setVariantReference(A(r,o.getVariantReference()))}}else if(e.getFileType()==="ctrl_variant_change"&&e.getSelector().id){o.getSelector().id=A(r,o.getSelector().id)}else if(e.getFileType()==="ctrl_variant_management_change"&&e.getContent().defaultVariant){o.getContent().defaultVariant=A(r,o.getContent().defaultVariant)}o.setAdaptationId(n);t.push(o)})}function I(e,t){var a=[];var r=[];var n=[];var i=new Map;e.forEach(function(e){if(e.isA("sap.ui.fl.apply._internal.flexObjects.Variant")){r.push(e)}else{n.push(e)}});g(r,a,i,t);h(n,a,i,t);return a.map(function(e){return e.convertToFileContent()})}function m(e){return s.getVersionsModel({layer:e.layer,reference:e.appId}).getProperty("/persistedVersion")}f.create=function(e){if(!e.layer){return Promise.reject("No layer was provided")}if(!e.control){return Promise.reject("No control was provided")}if(!e.contextBasedAdaptation){return Promise.reject("No contextBasedAdaptation was provided")}e.contextBasedAdaptation.id=d.createDefaultFileName();e.appId=y(e.control);return l.contextBasedAdaptation.create({layer:e.layer,flexObject:e.contextBasedAdaptation,appId:e.appId,parentVersion:m(e)}).then(function(t){var a=this.getAdaptationsModel(e);a.insertAdaptation(e.contextBasedAdaptation);return v(t,201,e)}.bind(this)).then(function(){return n.getFlexObjects({selector:e.control,invalidateCache:false,includeCtrlVariants:true,includeDirtyChanges:true,currentLayer:i.CUSTOMER})}).then(function(t){var a=o.filterChangeOrChangeDefinitionsByCurrentLayer(t,i.CUSTOMER);var r=I(a,e.contextBasedAdaptation.id);return l.contextBasedAdaptation.writeChange({layer:e.layer,flexObjects:r,transport:"",isLegacyVariant:false,parentVersion:m(e)})})};f.update=function(e){if(!e.layer){return Promise.reject("No layer was provided")}if(!e.control){return Promise.reject("No control was provided")}if(!e.contextBasedAdaptation){return Promise.reject("No contextBasedAdaptation was provided")}if(!e.adaptationId){return Promise.reject("No adaptationId was provided")}e.appId=y(e.control);return l.contextBasedAdaptation.update({layer:e.layer,flexObject:e.contextBasedAdaptation,appId:e.appId,adaptationId:e.adaptationId,parentVersion:m(e)}).then(function(t){return v(t,200,e)})};f.reorder=function(e){if(!e.layer){return Promise.reject("No layer was provided")}if(!e.control){return Promise.reject("No control was provided")}if(!e.parameters||!e.parameters.priorities){return Promise.reject("No valid priority list was provided")}e.appId=y(e.control);return l.contextBasedAdaptation.reorder({layer:e.layer,flexObjects:e.parameters,appId:e.appId,parentVersion:m(e)}).then(function(t){return v(t,204,e)})};f.load=function(e){if(!e.layer){return Promise.reject("No layer was provided")}if(!e.control){return Promise.reject("No control was provided")}e.appId=y(e.control);return l.contextBasedAdaptation.load({layer:e.layer,appId:e.appId,version:m(e)}).then(function(e){if(!e){e={adaptations:[]}}return e})};f.remove=function(e){if(!e.layer){return Promise.reject("No layer was provided")}if(!e.control){return Promise.reject("No control was provided")}if(!e.adaptationId){return Promise.reject("No adaptationId was provided")}e.appId=y(e.control);return l.contextBasedAdaptation.remove({layer:e.layer,appId:e.appId,adaptationId:e.adaptationId,parentVersion:m(e)}).then(function(t){return v(t,204,e,true)})};return f});
//# sourceMappingURL=ContextBasedAdaptationsAPI.js.map