/*
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./SelectionPlugin","../library","../utils/TableUtils","sap/ui/core/Icon","sap/ui/core/IconPool"],function(e,t,i,o,n){"use strict";var r=t.plugins.SelectionMode;var a=t.SelectionMode;var l=e.extend("sap.ui.table.plugins.ODataV4Selection",{metadata:{library:"sap.ui.table",properties:{selectionMode:{type:"sap.ui.table.plugins.SelectionMode",group:"Behavior",defaultValue:r.MultiToggle},limit:{type:"int",group:"Behavior",defaultValue:200},enableNotification:{type:"boolean",group:"Behavior",defaultValue:false},hideHeaderSelector:{type:"boolean",group:"Appearance",defaultValue:false}},events:{selectionChange:{}}}});l.prototype.init=function(){e.prototype.init.apply(this,arguments);var t=new o({src:n.getIconURI(i.ThemeParameters.clearSelectionIcon),useIconTooltip:false});t.addStyleClass("sapUiTableSelectClear");this._bLimitReached=false;this.oDeselectAllIcon=t;this._oNotificationPopover=null;this._oRangeSelectionStartContext=null};l.prototype.exit=function(){e.prototype.exit.apply(this,arguments);if(this.oDeselectAllIcon){this.oDeselectAllIcon.destroy();this.oDeselectAllIcon=null}if(this._oNotificationPopover){this._oNotificationPopover.destroy();this._oNotificationPopover=null}};l.prototype.onActivate=function(t){e.prototype.onActivate.apply(this,arguments);t.setProperty("selectionMode",this.getSelectionMode())};l.prototype.onDeactivate=function(t){e.prototype.onDeactivate.apply(this,arguments);t.detachFirstVisibleRowChanged(this.onFirstVisibleRowChange,this);t.setProperty("selectionMode",a.None);this.clearSelection();if(this._oNotificationPopover){this._oNotificationPopover.close()}};l.prototype.setSelected=function(e,t,i){var o=e.getRowBindingContext();if(!o||!h(o)){return}if(i&&i.range){s(this,e);return}if(this.getSelectionMode()===r.Single){this.clearSelection()}o.setSelected(t);this._oRangeSelectionStartContext=t&&this.getSelectionMode()===r.MultiToggle?o:null;this.fireSelectionChange()};function s(e,t){if(!e._oRangeSelectionStartContext){return}var i=e._oRangeSelectionStartContext.getIndex();var o=t.getRowBindingContext();var n=o?o.getIndex():-1;if(i!==n){i+=n>i?1:-1}p(e,i,n)}l.prototype.isSelected=function(e){var t=e.getRowBindingContext();return t?t.isSelected():false};l.prototype.getSelectedCount=function(){return this.getSelectedContexts().length};l.prototype.getRenderConfig=function(){if(!this.isActive()){return e.prototype.getRenderConfig.apply(this,arguments)}return{headerSelector:{type:this._isLimitDisabled()?"toggle":"clear",icon:this.oDeselectAllIcon,visible:this.getSelectionMode()===r.MultiToggle&&!this.getHideHeaderSelector(),enabled:this._isLimitDisabled()||this.getSelectedCount()>0,selected:d(this)}}};function c(e){if(d(e)){e.clearSelection()}else if(e._isLimitDisabled()){var t=e.getTableBinding();p(e,0,t?t.getLength()-1:-1)}}function d(e){var t=e.getTableBinding();if(!t||!t.isLengthFinal()){return false}var i=t.getAllCurrentContexts().filter(function(e){return h(e)}).length;var o=e.getSelectedContexts().filter(function(e){return h(e)}).length;return i>0&&i===o}l.prototype.onHeaderSelectorPress=function(){var e=this.getRenderConfig();if(!e.headerSelector.visible||!e.headerSelector.enabled){return}if(e.headerSelector.type==="toggle"){c(this)}else if(e.headerSelector.type==="clear"){this.clearSelection()}};l.prototype.onKeyboardShortcut=function(e){if(e==="toggle"){if(this._isLimitDisabled()){c(this)}}else if(e==="clear"){this.clearSelection()}};l.prototype.setSelectionMode=function(e){var t=this.getTable();this.setProperty("selectionMode",e,true);this._oRangeSelectionStartContext=null;this.clearSelection();if(t){t.setProperty("selectionMode",this.getSelectionMode())}return this};l.prototype.onTableRowsBound=function(e){if(!e.getModel().isA("sap.ui.model.odata.v4.ODataModel")){this.deactivate()}};l.prototype._isLimitDisabled=function(){return this.getLimit()===0};function u(e,t,i){var o=e.getLimit();var n=i<t;var r=n?i:t;var a=Math.abs(i-t)+1;if(!e._isLimitDisabled()){e._bLimitReached=a>o;if(e._bLimitReached){if(n){i=t-o+1;r=i}else{i=t+o-1}a=o+1}}return f(e.getTableBinding(),r,a).then(function(e){return{indexFrom:t,indexTo:i,contexts:e}})}function f(e,t,i){var o=e.getContexts(t,i,0,true);var n=o.length===i&&!o.includes(undefined);if(n){return Promise.resolve(o)}return new Promise(function(o){e.attachEventOnce("dataReceived",function(){o(f(e,t,i))})})}function p(e,t,i){if(t<0||i<0){return}u(e,t,i).then(function(t){t.contexts.forEach(function(e){if(h(e)){e.setSelected(true)}});return e._scrollTableToIndex(t.indexTo,t.indexFrom>t.indexTo)}).then(function(){e.fireSelectionChange()})}function h(e){var t="hierarchyQualifier"in(e.getBinding().getAggregation()||{});return(t||e.getProperty("@$ui5.node.isExpanded")===undefined)&&!e.getProperty("@$ui5.node.isTotal")}l.prototype.clearSelection=function(){var e=false;this.getSelectedContexts().forEach(function(t){if(!e&&t.isSelected()){e=true}t.setSelected(false)});if(e){this.fireSelectionChange()}};l.prototype.getSelectedContexts=function(){var e=this.getTableBinding();return e?e.getAllCurrentContexts().filter(function(e){return e.isSelected()}):[]};l.prototype._scrollTableToIndex=function(e,t){var i=this.getParent();if(!i||!this._bLimitReached){return Promise.resolve()}var o=i.getFirstVisibleRow();var n=i._getRowCounts();var r=o+n.scrollable-1;var a=false;if(e<o||e>r){var l=t?e-n.fixedTop-1:e-n.scrollable-n.fixedTop+2;a=i._setFirstVisibleRowIndex(Math.max(0,l))}this._showNotificationPopoverAtIndex(e);return new Promise(function(e){if(a){i.attachEventOnce("rowsUpdated",e)}else{e()}})};l.prototype._showNotificationPopoverAtIndex=function(e){var t=this;var n=this._oNotificationPopover;var r=this.getParent();var a=r.getRows()[e-r._getFirstRenderedRowIndex()];var l=i.getResourceText("TBL_SELECT_LIMIT_TITLE");var s=i.getResourceText("TBL_SELECT_LIMIT",[this.getLimit()]);if(!this.getEnableNotification()){return Promise.resolve()}return new Promise(function(e){sap.ui.require(["sap/m/Popover","sap/m/Bar","sap/m/Title","sap/m/Text","sap/m/HBox","sap/ui/core/library","sap/m/library"],function(i,c,d,u,f,p,h){if(!n){n=new i(t.getId()+"-notificationPopover",{customHeader:[new c({contentMiddle:[new f({items:[new o({src:"sap-icon://message-warning",color:p.IconColor.Critical}).addStyleClass("sapUiTinyMarginEnd"),new d({text:l,level:p.TitleLevel.H2})],renderType:h.FlexRendertype.Bare,justifyContent:h.FlexJustifyContent.Center,alignItems:h.FlexAlignItems.Center})]})],content:new u({text:s})});n.addStyleClass("sapUiContentPadding");t._oNotificationPopover=n}else{n.getContent()[0].setText(s)}r.detachFirstVisibleRowChanged(t.onFirstVisibleRowChange,t);r.attachFirstVisibleRowChanged(t.onFirstVisibleRowChange,t);var g=a.getDomRefs().rowSelector;if(g){n.attachEventOnce("afterOpen",e);n.openBy(g)}else{e()}})})};l.prototype.onFirstVisibleRowChange=function(){if(!this._oNotificationPopover){return}var e=this.getParent();if(e){e.detachFirstVisibleRowChanged(this.onFirstVisibleRowChange,this)}this._oNotificationPopover.close()};l.prototype.onThemeChanged=function(){this.oDeselectAllIcon.setSrc(n.getIconURI(i.ThemeParameters.clearSelectionIcon))};return l});
//# sourceMappingURL=ODataV4Selection.js.map