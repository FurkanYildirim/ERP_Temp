/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/base/util/restricted/_isEqual","sap/ui/base/ManagedObject","sap/ui/core/Fragment","sap/ui/fl/write/api/ContextBasedAdaptationsAPI","sap/m/ColumnListItem","sap/ui/rta/Utils","sap/ui/rta/toolbar/contextBased/SaveAsAdaptation","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/json/JSONModel","sap/ui/core/date/UI5Date"],function(t,e,a,o,n,i,r,s,l,d,c,u){"use strict";var p={Initial:0,Default:1024,Before:function(t){return t+1024},Between:function(t,e){return(t+e)/2},After:function(t){return t+.5}};var h=a.extend("sap.ui.rta.toolbar.contextBased.ManageAdaptations",{metadata:{properties:{toolbar:{type:"any"}}},constructor:function(){a.prototype.constructor.apply(this,arguments);this.oTextResources=this.getToolbar().getTextResources()}});h.prototype.openManageAdaptationDialog=function(){if(!this._oManageAdaptationDialogPromise){this._oManageAdaptationDialogPromise=o.load({name:"sap.ui.rta.toolbar.contextBased.ManageAdaptationsDialog",id:this.getToolbar().getId()+"_fragment--sapUiRta_manageAdaptationDialog",controller:{formatContextColumnCell:g.bind(this),formatContextColumnTooltip:f.bind(this),formatCreatedChangedOnColumnCell:A.bind(this),onLiveSearch:C.bind(this),moveUp:b.bind(this),moveDown:M.bind(this),onDropSelectedAdaptation:y.bind(this),onSaveReorderedAdaptations:k.bind(this),isAdaptationsSelected:w.bind(this),getIndexOfSelectedAdaptation:N.bind(this),onClose:U.bind(this)}}).then(function(t){this._oManageAdaptationDialog=t;t.addStyleClass(r.getRtaStyleClassName());this.getToolbar().addDependent(this._oManageAdaptationDialog)}.bind(this))}else{v.call(this);L.call(this,true);S.call(this,false)}return this._oManageAdaptationDialogPromise.then(function(){this._oRtaInformation=this.getToolbar().getRtaInformation();return n.load({control:this._oRtaInformation.rootControl,layer:this._oRtaInformation.flexSettings.layer})}.bind(this)).then(function(t){this.oAdaptationsModel=n.getAdaptationsModel({control:this._oRtaInformation.rootControl,layer:this._oRtaInformation.flexSettings.layer});this.oAdaptationsModel.updateAdaptations(t.adaptations);this.oReferenceAdaptationsData=JSON.parse(JSON.stringify(this.oAdaptationsModel.getProperty("/adaptations")));this._oControlConfigurationModel=new c({isTableItemSelected:false});this._oManageAdaptationDialog.setModel(this.oAdaptationsModel,"contextBased");this._oManageAdaptationDialog.setModel(this._oControlConfigurationModel,"controlConfiguration");B.call(this).attachSelectionChange(m.bind(this));return this._oManageAdaptationDialog.open()}.bind(this)).catch(function(e){t.error(e.stack);var a="MSG_LREP_TRANSFER_ERROR";var o={titleKey:"BTN_MANAGE_APP_CTX"};o.details=e.userMessage;r.showMessageBox("error",a,o)})};function g(t){return t.length+" "+(t.length>1?this.oTextResources.getText("TXT_TABLE_CONTEXT_CELL_ROLES"):this.oTextResources.getText("TXT_TABLE_CONTEXT_CELL_ROLE"))}function f(t){return t.join("\n")}function A(t,e){var a=u.getInstance(e);var o={year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"numeric"};var n=sap.ui.getCore().getConfiguration().getLanguage();return t+"\n"+a.toLocaleTimeString(n,o)}function m(t){if(t.getParameter("selected")===true){this._oControlConfigurationModel.setProperty("/isTableItemSelected",true);v.call(this)}}function v(){var t=R.call(this,"moveUpButton");var e=R.call(this,"moveDownButton");if(O.call(this)){if(w.call(this)){t.setEnabled(N.call(this)>0);e.setEnabled(N.call(this)<this.oAdaptationsModel.getProperty("/count")-1)}else{t.setEnabled(false);e.setEnabled(false)}}else{t.setEnabled(false);e.setEnabled(false)}}function C(t){var e;var a=t.getSource().getValue();var o=B.call(this);var n=D.call(this);var i=E.call(this);if(a&&a.length>0){v.call(this);L.call(this,false);var r=new l("title",d.Contains,a);var s=new l({path:"contexts/role",test:function(t){return t.some(function(t){return t.includes(a.toUpperCase())})}});var c=new l("createdBy",d.Contains,a);var u=new l("changedBy",d.Contains,a);e=new l([r,s,c,u]);if(i.toUpperCase().includes(a.toUpperCase())){n.setVisible(true)}else{n.setVisible(false)}}else{L.call(this,true);if(this._oControlConfigurationModel.getProperty("/isTableItemSelected")){v.call(this)}n.setVisible(true)}var p=o.getBinding("items");p.filter(e,"Application")}function b(t){T.call(this,"Up");t.getSource().focus()}function M(t){T.call(this,"Down");t.getSource().focus()}function _(t,e){return t.rank-e.rank}function P(t){var e=t.getProperty("/adaptations")||[];e.sort(_);t.setProperty("/adaptations",e);t.refresh(true)}function T(t){var e=B.call(this);var a=e.getSelectedItem(0);var o=a.getBindingContext("contextBased");var n=e.indexOfItem(a)+(t==="Up"?-1:1);var i=e.getItems()[n];var r=i?i.getBindingContext("contextBased"):undefined;if(!r){return}var s=r.getProperty("rank");var l=o.getProperty("rank");this.oAdaptationsModel.setProperty("rank",s,o);this.oAdaptationsModel.setProperty("rank",l,r);P(this.oAdaptationsModel);e.getItems()[n].setSelected(true).focus();S.call(this,x.call(this));v.call(this)}function y(t){var e=t.getParameter("draggedControl");var a=e.getBindingContext("contextBased");if(!a){return}var o=p.Default;var n=t.getParameter("droppedControl");if(n instanceof i){var r=t.getParameter("dropPosition");var s=n.getBindingContext("contextBased");var l=s.getProperty("rank");var d=n.getParent();var c=d.indexOfItem(n);if(s===a){return}var u=c+(r==="After"?1:-1);var h=d.getItems()[u];if(!h||u===-1){o=u===-1?.5:p[r](l)}else{var g=h.getBindingContext("contextBased");o=p.Between(l,g.getProperty("rank"))}}this.oAdaptationsModel.setProperty("rank",o,a);P(this.oAdaptationsModel);var f=Object.assign(this.oAdaptationsModel.getProperty("/allAdaptations"),this.oAdaptationsModel.getProperty("/adaptations"));this.oAdaptationsModel.updateAdaptations(f);S.call(this,x.call(this))}function x(){return!e(this.oAdaptationsModel.getProperty("/adaptations").map(function(t){return t.id}),this.oReferenceAdaptationsData.map(function(t){return t.id}))}function S(t){var e=R.call(this,"manageAdaptations-saveButton");e.setTooltip(t?"":this.oTextResources.getText("TOOLTIP_APP_CTX_DIALOG_SAVE"));e.setEnabled(t)}function B(){return R.call(this,"manageAdaptationsTable")}function R(t){return this.getToolbar().getControl("manageAdaptationDialog--"+t)}function D(){return R.call(this,"defaultContext")}function E(){return R.call(this,"defaultApplicationTitle").getProperty("text")}function I(){return R.call(this,"searchField")}function O(){return I.call(this).getValue().length===0}function L(t){B.call(this).getDragDropConfig()[0].setEnabled(t)}function w(){var t=B.call(this);return t.getSelectedContextPaths().length>0}function N(){var t=B.call(this);if(t.getSelectedContextPaths().length>0){var e=t.getSelectedContextPaths()[0].split("/");var a=Number(e[e.length-1]);return a}return-1}function k(){r.checkDraftOverwrite(this.getModel("versions")).then(function(){var t=this.getToolbar().getRtaInformation();var e=this.oAdaptationsModel.getProperty("/adaptations").map(function(t){return t.id});return n.reorder({control:t.rootControl,layer:t.flexSettings.layer,parameters:{priorities:e}})}.bind(this)).then(function(){var t=Object.assign(this.oAdaptationsModel.getProperty("/allAdaptations"),this.oAdaptationsModel.getProperty("/adaptations"));this.oAdaptationsModel.updateAdaptations(t);U.call(this)}.bind(this)).catch(function(e){if(e!=="cancel"){r.showMessageBox("error","MSG_LREP_TRANSFER_ERROR",{titleKey:"BTN_MANAGE_APP_CTX",error:e});t.error("sap.ui.rta: "+e.stack||e.message||e)}})}function U(){this._oControlConfigurationModel.setProperty("/isTableItemSelected",false);I.call(this).setValue("");var t=B.call(this);t.getBinding("items").filter([]);t.removeSelections();D.call(this).setVisible(true);this._oManageAdaptationDialog.close()}return h});
//# sourceMappingURL=ManageAdaptations.js.map