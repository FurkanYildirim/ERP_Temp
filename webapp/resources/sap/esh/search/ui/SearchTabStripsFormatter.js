/*! 
 * SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	 
 */
(function(){sap.ui.define(["./error/ErrorHandler","./sinaNexTS/sina/DataSourceResultSet","./sinaNexTS/sina/UserCategoryDataSource","sap/esh/search/ui/error/errors"],function(e,t,r,a){function o(e){return e&&e.__esModule&&typeof e.default!=="undefined"?e.default:e}function i(e,t){var r=typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=n(e))||t&&e&&typeof e.length==="number"){if(r)e=r;var a=0;var o=function(){};return{s:o,n:function(){if(a>=e.length)return{done:true};return{done:false,value:e[a++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i=true,u=false,s;return{s:function(){r=r.call(e)},n:function(){var e=r.next();i=e.done;return e},e:function(e){u=true;s=e},f:function(){try{if(!i&&r.return!=null)r.return()}finally{if(u)throw s}}}}function n(e,t){if(!e)return;if(typeof e==="string")return u(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);if(r==="Object"&&e.constructor)r=e.constructor.name;if(r==="Map"||r==="Set")return Array.from(e);if(r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return u(e,t)}function u(e,t){if(t==null||t>e.length)t=e.length;for(var r=0,a=new Array(t);r<t;r++)a[r]=e[r];return a}function s(e,t){if(!(e instanceof t)){throw new TypeError("Cannot call a class as a function")}}function l(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||false;a.configurable=true;if("value"in a)a.writable=true;Object.defineProperty(e,a.key,a)}}function d(e,t,r){if(t)l(e.prototype,t);if(r)l(e,r);Object.defineProperty(e,"prototype",{writable:false});return e}var c=o(e);var h=t["DataSourceResultSet"];var f=r["UserCategoryDataSource"];var p=function(){function e(t,r,a){s(this,e);this.dataSource=t;this.count=r;this.children=[];this.parent=null;this.tree=a}d(e,[{key:"equals",value:function e(t){return this===t}},{key:"setCount",value:function e(t){this.count=t}},{key:"getAncestors",value:function e(){var t=[];var r=this;while(r.parent){t.push(r.parent);r=r.parent}return t}},{key:"getChildren",value:function e(){var t=[];for(var r=0;r<this.children.length;++r){var a=this.children[r];if(a.unsureWhetherNodeisBelowRoot){continue}t.push(a)}return t}},{key:"getChildrenSortedByCount",value:function e(){var t=this.getChildren();t.sort(function(e,t){return t.count-e.count});return t}},{key:"clearChildren",value:function e(){for(var t=0;t<this.children.length;++t){var r=this.children[t];r.parent=null}this.children=[]}},{key:"appendNode",value:function e(t){t.parent=this;this.children.push(t)}},{key:"appendNodeAtIndex",value:function e(t,r){t.parent=this;this.children.splice(r,0,t)}},{key:"insertNode",value:function e(t){if(this.children.length===0){this.appendNode(t);return}if(t.dataSource===this.tree.model.appDataSource){this.appendNodeAtIndex(t,0);return}if(t.dataSource===this.tree.model.favDataSource){if(this.children[0].dataSource===this.tree.model.appDataSource){this.appendNodeAtIndex(t,1)}else{this.appendNodeAtIndex(t,0)}return}var r=-1;var a=true;var o=i(this.children),n;try{for(o.s();!(n=o.n()).done;){var u=n.value;r++;if(u.dataSource===this.tree.model.appDataSource||u.dataSource===this.tree.model.favDataSource||u.children.length>0){continue}if(u.dataSource.labelPlural&&t.dataSource.labelPlural&&u.dataSource.labelPlural>t.dataSource.labelPlural){a=false;break}}}catch(e){o.e(e)}finally{o.f()}if(a){this.appendNode(t)}else{this.appendNodeAtIndex(t,r)}}},{key:"removeChildNode",value:function e(t){var r=this.children.indexOf(t);if(r<0){return}this.children.splice(r,1);t.parent=null}},{key:"hasChild",value:function e(t){return this.children.indexOf(t)>-1}},{key:"hasSibling",value:function e(t){if(this.equals(t)){return false}var r=this.parent;if(!r){return false}if(r.hasChild(t)){return true}return false}},{key:"_findNode",value:function e(t,r){if(this.dataSource===t){r.push(this);return}for(var a=0;a<this.children.length;++a){var o=this.children[a];o._findNode(t,r);if(r.length>0){return}}}}]);return e}();var v=function(){function e(t,r){s(this,e);this.model=r;this.rootNode=new p(t,null,this)}d(e,[{key:"reset",value:function e(){this.rootNode=null}},{key:"invalidate",value:function e(t){var r=this.findNode(t);if(!r){this.rootNode.children=[];this.rootNode.count=0;return}var a=null;while(r){r.children=a?[a]:[];r.count=null;if(a){a.count=null}a=r;r=r.parent}}},{key:"findNode",value:function e(t){if(!this.rootNode){return null}var r=[];this.rootNode._findNode(t,r);return r.length>0?r[0]:null}},{key:"hasChild",value:function e(t,r){if(r===this.rootNode.dataSource){return false}var a=this.findNode(t);if(!a){return false}var o=this.findNode(r);if(!o){return false}return a.hasChild(o)}},{key:"hasSibling",value:function e(t,r){if(r===this.rootNode.dataSource){return false}var a=this.findNode(t);if(!a){return false}var o=this.findNode(r);if(!o){return false}return a.hasSibling(o)}},{key:"removeObsoleteTreeNodes",value:function e(t,r){for(var a=t.children.length-1;a>=0;a--){var o=t.children[a];if(o.children.length>0){this.removeObsoleteTreeNodes(o,r)}if(r.map(function(e){return e.dataSource}).indexOf(o.dataSource)===-1){t.removeChildNode(o)}}}},{key:"updateFromPerspective",value:function e(t,r){var a=0;var o;if(r){a=r.totalCount}var i=this.findNode(t);if(i){o=this.collectDataSourcesFromResult(i,r);this.removeObsoleteTreeNodes(i,o)}else{i=new p(t,a,this);o=this.collectDataSourcesFromResult(i,r);this.removeObsoleteTreeNodes(this.rootNode,o);if(i.dataSource===this.model.favDataSource){i.unsureWhetherNodeisBelowRoot=false}else{i.unsureWhetherNodeisBelowRoot=true}if(this.isIncludedInMyFavorites(t)){var n=this.findNode(this.model.favDataSource);if(!n){n=new p(this.model.favDataSource,0,this);n.unsureWhetherNodeisBelowRoot=false;this.rootNode.insertNode(n)}n.insertNode(i)}else{this.rootNode.insertNode(i)}}i.setCount(a);if(t===this.model.allDataSource||this.model.isUserCategory()){i.setCount(i.count+this.model.getProperty("/appCount"))}else if(t===this.model.appDataSource){i.setCount(this.model.getProperty("/appCount"))}this.updateTreeFromPerspective(i,o);this.updateCountMyFavorites(i,o)}},{key:"updateMyFavTreeNode",value:function e(t,r){if(this.model.userCategoryManager&&this.model.userCategoryManager.isFavActive()){if(t.dataSource===this.model.allDataSource){var a=this.findNode(this.model.favDataSource);if(!a){a=new p(this.model.favDataSource,r.filter(function(e){return e.isFavDataSource}).reduce(function(e,t){return e+t.measureValue},0),this);t.unsureWhetherNodeisBelowRoot=false;t.insertNode(a)}}}}},{key:"updateCountMyFavorites",value:function e(t,r){var a=this.findNode(this.model.favDataSource);if(a&&t.dataSource===this.model.allDataSource){a.setCount(r.filter(function(e){return e.isFavDataSource}).reduce(function(e,t){return e+t.measureValue},0));if(this.isIncludedInMyFavorites(this.model.appDataSource)&&r.map(function(e){return e.dataSource}).indexOf(this.model.appDataSource)===-1){a.setCount(a.count+this.model.getProperty("/appCount"))}}}},{key:"getFacets",value:function e(t,r){function a(e){return e instanceof h}var o=[];if(!r||t.dataSource===this.model.appDataSource){return o}if(r.facets.length===0&&r.items.length>0&&t.dataSource instanceof f){var i=[];i.push(this.model.sinaNext._createDataSourceResultSetItem({dataSource:t.dataSource.subDataSources[0],dimensionValueFormatted:t.dataSource.subDataSources[0].labelPlural,measureValue:r.totalCount,measureValueFormatted:r.totalCount.toString()}));var n=this.model.sinaNext._createDataSourceResultSet({title:this.model.query.filter.dataSource.label,items:i,query:this.model.query});o.push(n);return o}else if(r.facets.length===0){return o}if(!a(r.facets[0])){return o}if(r.facets[0].type!==this.model.sinaNext.FacetType.DataSource){return o}return r.facets}},{key:"isIncludedInMyFavorites",value:function e(t){if(this.model.userCategoryManager&&this.model.userCategoryManager.isFavActive()&&(this.model.favDataSource.subDataSources.indexOf(t)>-1||t===this.model.appDataSource&&this.model.favDataSource.includeApps)){return true}else{return false}}},{key:"collectDataSourcesFromResult",value:function e(t,r){var a=this;function o(e){return e instanceof h}var i=[];var n={};if((t.dataSource===this.model.allDataSource||t.dataSource===this.model.favDataSource)&&this.model.getProperty("/appCount")>0){n.dataSource=this.model.appDataSource;n.isAppDataSource=true;n.isFavDataSource=this.model.userCategoryManager?this.model.userCategoryManager.isFavActive()?this.model.favDataSource.includeApps:false:false;n.measureValue=this.model.getProperty("/appCount");n.measureValueFormatted=n.measureValue.toString();n.dimensionValueFormatted=this.model.appDataSource.labelPlural;if(t.dataSource===this.model.favDataSource&&n.isFavDataSource||t.dataSource===this.model.allDataSource&&!n.isFavDataSource){i.push(n)}}if(t.dataSource.type===this.model.sinaNext.DataSourceType.BusinessObject){n.dataSource=t.dataSource;n.isAppDataSource=false;n.isFavDataSource=this.isIncludedInMyFavorites(t.dataSource);n.measureValue=t.count?t.count:0;n.measureValueFormatted=n.measureValue.toString();n.dimensionValueFormatted=t.dataSource.labelPlural?t.dataSource.labelPlural:t.dataSource.label;i.push(n);return i}var u=this.getFacets(t,r);if(!u||u.length===0||!o(u[0])){return i}u[0].items.forEach(function(e){return i.push({dataSource:e.dataSource,isAppDataSource:false,isFavDataSource:a.isIncludedInMyFavorites(e.dataSource),measureValue:e.measureValue,measureValueFormatted:e.measureValueFormatted,dimensionValueFormatted:e.dimensionValueFormatted})});return i}},{key:"updateTreeFromPerspective",value:function e(t,r){if(t.dataSource===this.model.appDataSource||!r){return}this.updateMyFavTreeNode(t,r);var a=this.findNode(this.model.favDataSource);var o=i(r),n;try{for(o.s();!(n=o.n()).done;){var u=n.value;var s=this.findNode(u.dataSource);if(s){if(s.unsureWhetherNodeisBelowRoot){s.unsureWhetherNodeisBelowRoot=false}if(t!==s.parent&&(t.dataSource.type===this.model.sinaNext.DataSourceType.Category||t.dataSource.type===this.model.sinaNext.DataSourceType.UserCategory)){s.parent.removeChildNode(s);t.insertNode(s)}}else{var l=new p(u.dataSource,u.measureValue,this);l.unsureWhetherNodeisBelowRoot=false;if(a&&u.isFavDataSource){a.insertNode(l)}else{t.insertNode(l)}}}}catch(e){o.e(e)}finally{o.f()}}}]);return e}();var S=function(){function e(t,r){s(this,e);this.errorHandler=new c({model:r});this.tree=new v(t,r)}d(e,[{key:"format",value:function e(t,r,a){this.tree.updateFromPerspective(t,r);var o=this.generateTabStrips(t,a);return o}},{key:"invalidate",value:function e(t){if(this.tree){this.tree.invalidate(t)}}},{key:"generateTabStrips",value:function e(t,r){var o=this.doGenerateTabStrips(t,r);var i;try{i=r.config.tabStripsFormatter(o.strips);if(i.indexOf(o.selected)<0){i.splice(0,0,o.selected)}o.strips=i}catch(e){var n=new a.ConfigurationExitError("tabStripsFormatter",r.config.applicationComponent,e);this.errorHandler.onError(n);o=this.doGenerateTabStrips(t,r)}return o}},{key:"doGenerateTabStrips",value:function e(t,r){var a=9999;var o,i,n;var u={strips:[],selected:null};var s=this.tree.findNode(t);if(!s){if(t!==r.allDataSource){u.strips.push(r.allDataSource)}u.strips.push(t);u.selected=t;return u}if(s.dataSource===r.allDataSource){u.strips.push(r.allDataSource);n=s.getChildrenSortedByCount();for(o=0;o<n.length&&u.strips.length<a;++o){i=n[o];u.strips.push(i.dataSource)}u.selected=r.allDataSource;return u}if(s.parent===this.tree.rootNode&&!s.unsureWhetherNodeisBelowRoot){u.strips.push(r.allDataSource);var l=false;n=this.tree.rootNode.getChildrenSortedByCount();for(o=0;o<n.length;++o){i=n[o];if(l){if(u.strips.length>=a){break}u.strips.push(i.dataSource)}else{if(u.strips.length<a-1||s===i){u.strips.push(i.dataSource);if(s===i){l=true}}}}if(n.length===0){u.strips.push(s.dataSource)}u.selected=s.dataSource;return u}u.strips.push(r.allDataSource);u.strips.push(s.dataSource);u.selected=s.dataSource;return u}}]);return e}();var m={__esModule:true};m.Tree=v;m.Formatter=S;return m})})();
//# sourceMappingURL=SearchTabStripsFormatter.js.map