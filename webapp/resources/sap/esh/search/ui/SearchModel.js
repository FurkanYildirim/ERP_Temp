/*! 
 * SAPUI5

		(c) Copyright 2009-2021 SAP SE. All rights reserved
	 
 */
(function(){function e(e,t,r){if(r){return t?t(e):e}if(!e||!e.then){e=Promise.resolve(e)}return t?e.then(t):e}function t(){}function r(e,r){if(!r){return e&&e.then?e.then(t):Promise.resolve()}}function i(e,t){try{var r=e()}catch(e){return t(e)}if(r&&r.then){return r.then(void 0,t)}return r}function s(e){var r=e();if(r&&r.then){return r.then(t)}}function a(e,t){return e&&e.then?e.then(t):t(e)}function o(e,t){var r=e();if(r&&r.then){return r.then(t)}return t(r)}sap.ui.define(["./i18n","sap/base/Log","./error/ErrorHandler","sap/esh/search/ui/SearchHelper","sap/ui/model/json/JSONModel","sap/esh/search/ui/SearchResultFormatter","sap/esh/search/ui/SearchTabStripsFormatter","sap/esh/search/ui/SearchResultTableFormatter","sap/esh/search/ui/SearchFacetsFormatter","sap/esh/search/ui/BreadcrumbsFormatter","sap/esh/search/ui/suggestions/SuggestionHandler","sap/esh/search/ui/SearchConfiguration","sap/esh/search/ui/personalization/PersonalizationStorage","sap/esh/search/ui/personalization/keyValueStoreFactory","sap/esh/search/ui/sinaNexTS/providers/abap_odata/UserEventLogger","sap/esh/search/ui/eventlogging/EventLogger","sap/esh/search/ui/SearchUrlParser","sap/esh/search/ui/cFLPUtil","sap/esh/search/ui/usercategories/UserCategoryManager","sap/esh/search/ui/error/errors","sap/esh/search/ui/RecentlyUsedStorage","./sinaNexTS/sina/SinaConfiguration","./sinaNexTS/sina/sinaFactory","./sinaNexTS/core/Log","./SearchResultItemMemory","./FolderModeUtils","sap/ui/core/library","./sinaNexTS/sina/HierarchyDisplayType","./UIEvents","./SearchShellHelperHorizonTheme","./SearchConfigurationSettings","./BusyIndicator"],function(t,n,l,u,c,h,f,p,y,g,d,S,v,P,b,m,C,F,T,D,R,w,A,_,M,E,x,I,V,B,L,O){function N(e){return e&&e.__esModule&&typeof e.default!=="undefined"?e.default:e}function U(e){return j(e)||H(e)||k(e)||q()}function q(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function H(e){if(typeof Symbol!=="undefined"&&e[Symbol.iterator]!=null||e["@@iterator"]!=null)return Array.from(e)}function j(e){if(Array.isArray(e))return Q(e)}function z(e,t){var r=typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=k(e))||t&&e&&typeof e.length==="number"){if(r)e=r;var i=0;var s=function(){};return{s:s,n:function(){if(i>=e.length)return{done:true};return{done:false,value:e[i++]}},e:function(e){throw e},f:s}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a=true,o=false,n;return{s:function(){r=r.call(e)},n:function(){var e=r.next();a=e.done;return e},e:function(e){o=true;n=e},f:function(){try{if(!a&&r.return!=null)r.return()}finally{if(o)throw n}}}}function k(e,t){if(!e)return;if(typeof e==="string")return Q(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);if(r==="Object"&&e.constructor)r=e.constructor.name;if(r==="Map"||r==="Set")return Array.from(e);if(r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return Q(e,t)}function Q(e,t){if(t==null||t>e.length)t=e.length;for(var r=0,i=new Array(t);r<t;r++){i[r]=e[r]}return i}var G=N(t);var W=n["Level"];var $=N(l);var J=f["Formatter"];var K=b["UserEventType"];var Y=w["AvailableProviders"];var X=_["Severity"];var Z=N(M);var ee=E["FolderModeResultViewTypeCalculator"];var te=x["MessageType"];var re=I["HierarchyDisplayType"];var ie=N(V);var se=N(B);var ae=L["sinaParameters"];var oe=O["BusyIndicator"];var ne=c.extend("sap.esh.search.ui.SearchModel",{constructor:function e(t){var r;c.prototype.constructor.call(this,[]);this.searchTermHandlers=[];this.logger=n.getLogger("sap.esh.search.ui.SearchModel");var i=t||{};this.config=new S(i===null||i===void 0?void 0:i.configuration);this.searchResultSetItemMemory=new Z;this.setSizeLimit(1e3);this._suggestionHandler=new d({model:this});this.folderModeResultViewTypeCalculator=new ee(this);this._performanceLoggerSearchMethods=[];this._errorHandler=new $({model:this});this._searchApplicationsRefuseOutdatedReq=u.refuseOutdatedRequests(this.searchApplications.bind(this),"search");this.pageSize=this.config.pageSize||10;this.appTopDefault=20;this.boTopDefault=this.pageSize;this.filterChanged=false;this.busyIndicator=new oe(this);this.setProperty("/isQueryInvalidated",true);this.setProperty("/busyDelay",0);this.setProperty("/tableColumns",[]);this.setProperty("/sortableAttributes",[]);this.setProperty("/tableRows",[]);this.setProperty("/results",[]);this.setProperty("/appResults",[]);this.setProperty("/boResults",[]);this.setProperty("/breadcrumbsHierarchyNodePaths",[]);this.setProperty("/breadcrumbsHierarchyAttribute","");this.setProperty("/hierarchyNodePaths",[]);this.setProperty("/origBoResults",[]);this.setProperty("/count",0);this.setProperty("/countText","");this.setProperty("/boCount",0);this.setProperty("/appCount",0);this.setProperty("/facets",[]);this.setProperty("/dataSources",[this.allDataSource,this.appDataSource]);this.setProperty("/appSearchDataSource",null);this.setProperty("/currentPersoServiceProvider",null);this.setProperty("/businessObjSearchEnabled",true);this.setProperty("/initializingObjSearch",false);this.setProperty("/suggestions",[]);this.setProperty("/resultViewTypes",[]);this.setProperty("/resultViewType","");this.setProperty("/resultViewSwitchVisibility",false);this.setProperty("/documentTitle","Search");this.setProperty("/top",this.boTopDefault);this.setProperty("/orderBy",{});this.setProperty("/facetVisibility",false);this.setProperty("/focusIndex",0);this.setProperty("/errors",[]);this.setProperty("/isErrorPopovered",false);this.setProperty("/nlqSuccess",false);this.setProperty("/nlqDescription","");this.setProperty("/firstSearchWasExecuted",false);this.setProperty("/multiSelectionAvailable",false);this.setProperty("/multiSelectionEnabled",false);this.setProperty("/multiSelection/actions",[]);this.setProperty("/multiSelectionSelected",false);this.setProperty("/multiSelectionObjects",[]);this.setProperty("/singleSelectionSelected",false);this.setProperty("/inputHelpSelectedItems",null);this.setProperty("/inputHelp",null);this.setProperty("/config",this.config);this.setProperty("/searchInLabel","");this.setProperty("/searchInIcon","sap-icon://none");this.setProperty("/searchButtonStatus","Search");this._subscribers=[];this.searchUrlParser=new C({model:this});this._userCategoryManagerPromise=null;this._tempDataSources=[];if(i!==null&&i!==void 0&&(r=i.searchModel)!==null&&r!==void 0&&r.initAsyncPromise){this.initAsyncPromise=i.searchModel.initAsyncPromise;this.oFacetFormatter=new y(this)}this.initAsyncPromise=this.initAsync()},initAsync:function t(){try{let t=false;const l=this;if(l.initAsyncPromise){return e(l.initAsyncPromise)}l.setProperty("/initializingObjSearch",true);l.busyIndicator.setBusy(true);var n={label:G.getText("genericLoading"),labelPlural:G.getText("genericLoading"),enabled:false,id:"$$Loading$$"};l.setProperty("/dataSource",n);l.setProperty("/dataSources",[n]);return e(a(i(function(){var t,n;return e(P.create(l.config.personalizationStorage,l.config.isUshell,l.config.id),function(u){l._personalizationStorage=new v(u,l);if(l.config.bRecentSearches){l.recentlyUsedStorage=new R({personalizationStorage:l._personalizationStorage,searchModel:l})}l.initFacetVisibility();return e(l.createSina(),function(u){l.sinaNext=u;l.sinaNext.createSearchNavigationTarget=l.createSearchNavigationTarget.bind(l);l.createAllAndAppDataSource();return o(function(){if(l.isMyFavoritesAvailable()){return e(T.create({sina:l.sinaNext,personalizationStorage:l._personalizationStorage}),function(e){l.userCategoryManager=e})}},function(){var o={sinaNext:l.sinaNext};if(typeof l.config.usageCollectionService!=="undefined"){o["usageCollectionService"]=l.config.usageCollectionService}l.eventLogger=new m(o);Object.assign(l.eventLogger,b.UserEventType);var u={type:l.eventLogger["SESSION_START"]};l.eventLogger.logEvent(u);l.setProperty("/defaultDataSource",l.calculateDefaultDataSource());if(l.sinaNext.provider.id==="dummy"){l.setProperty("/defaultDataSource",l.appDataSource);l.setProperty("/businessObjSearchEnabled",false);l.config.searchBusinessObjects=false;l.setFacetVisibility(false,false)}if(l.sinaNext.provider.id==="inav2"&&l.config.isUshell){sap.ui.require(["sap/ushell/System"],function(e){sap.ushell.Container.addRemoteSystem(new e({alias:"ENTERPRISE_SEARCH",platform:"abap",baseUrl:"/ENTERPRISE_SEARCH"}))})}l.setProperty("/uiFilter",l.sinaNext.createFilter());l.loadDataSources();l.resetDataSource(false);l.resetAllFilterConditions(false);l.query=l.sinaNext.createSearchQuery();l.query.setMultiSelectFacets(true);l.oFacetFormatter=new y(l);l._tabStripFormatter=new J(l.allDataSource,l);l._breadcrumbsFormatter=new g.Formatter(l);l.dataSourceTree=l._tabStripFormatter.tree;l.setSearchBoxTerm(l.config.searchTerm,false);if(l.config.dataSource){l.setDataSourceById(l.config.dataSource,false,false)}if(l.config.filterRootCondition){l.setFilterRootCondition(l.config.filterRootCondition)}l.setProperty("/initializingObjSearch",false);l.busyIndicator.setBusy(false);return a(i(function(){return r(l.config.initAsync(l))},function(e){l.logger.warning("initAsync() which was passed to SearchConfiguration threw an error: "+e)}),function(){return s(function(){if((t=sap)!==null&&t!==void 0&&(n=t.ushell)!==null&&n!==void 0&&n.Container){return e(sap.ushell.Container.getServiceAsync("VisualizationInstantiation"),function(e){l.uShellVisualizationInstantiationService=e})}})})})})})},function(e){l._errorHandler.onError(e);const r=Promise.reject(e);t=true;return r}),function(e){return t?e:Promise.resolve()}))}catch(e){return Promise.reject(e)}},createSina:function t(){try{const t=this;if(!t.config.searchBusinessObjects){return e(A.createAsync("dummy"))}var r=[];if(window.location.href.indexOf("demo/FioriLaunchpad.")!==-1){r=[Y.SAMPLE]}else{r=[Y.ABAP_ODATA,Y.INAV2,Y.DUMMY]}return e(F.readCFlpConfiguration(r),function(e){r=e;if(t.config.sinaConfiguration){r=[t.config.sinaConfiguration]}r=t.mixinSearchConfigurationIntoSinaConfiguration(r);return A.createByTrialAsync(r)})}catch(e){return Promise.reject(e)}},mixinSearchConfigurationIntoSinaConfiguration:function e(t){var r=[];for(var i=0;i<t.length;++i){var s=t[i];if(typeof s==="string"){s={provider:s,url:""}}var a=z(ae),o;try{for(a.s();!(o=a.n()).done;){var l=o.value;if(!s[l]){s[l]=this.config[l]}}}catch(e){a.e(e)}finally{a.f()}var u=n.getLogger("sap.esh.search.ui.eshclient");s.logTarget={debug:u.debug,info:u.info,warn:u.warning,error:u.error};var c=X.ERROR;switch(u.getLevel()){case W.ALL:case W.TRACE:case W.DEBUG:c=X.DEBUG;break;case W.INFO:c=X.INFO;break;case W.WARNING:c=X.WARN;break}s.logLevel=c;r.push(s)}return r},initBusinessObjSearch:function t(){try{const t=this;return e(t.initAsync())}catch(e){return Promise.reject(e)}},calculateDefaultDataSource:function e(){var t=this.allDataSource;if(this.config.defaultSearchScopeApps){t=this.appDataSource}if(this.config.defaultDataSource){t=this.sinaNext.getDataSource(this.config.defaultDataSource)}if(this.userCategoryManager&&this.userCategoryManager.isFavActive()){t=this.userCategoryManager.getCategory("MyFavorites")}return t},initFacetVisibility:function e(){if(this.config.optimizeForValueHelp){this.setFacetVisibility(false,false);return}else if(typeof this.config.facetVisibility!=="undefined"){this.setFacetVisibility(this.config.facetVisibility,false);return}var t=false;try{t=this._personalizationStorage.getItem("search-facet-panel-button-state")}catch(e){}this.setFacetVisibility(t,false)},isBusinessObjSearchConfigured:function e(){try{var t=window["sap-ushell-config"].renderers.fiori2.componentData.config;return t.searchBusinessObjects!=="hidden"}catch(e){return true}},isBusinessObjSearchEnabled:function e(){return this.getProperty("/businessObjSearchEnabled")},setProperty:function e(t,r,i,s){try{var a=c.prototype.setProperty.call(this,t,r,i,s);switch(t){case"/boResults":case"/appResults":this.calculateResultList();break;case"/appCount":case"/boCount":a=this.setProperty("/count",this.getProperty("/appCount")+this.getProperty("/boCount"));break;case"/count":a=this.setProperty("/countText",this._calculateCountText());break;case"expanded":if(i&&i.getPath().startsWith("/results/")){var o=i.getObject();if(o.key&&typeof r==="boolean"){var n=o;this.searchResultSetItemMemory.setExpanded(n.key,r)}}break;default:break}return a}catch(e){this._errorHandler.onError(e)}},_calculateCountText:function e(){var t=this.getProperty("/count");if(this.getProperty("/nlqSuccess")){return this.getProperty("/nlqDescription")}if(typeof t!=="number"){return""}var r=u.formatInteger(t);if(this.getProperty("/searchInLabel")){return(this.getProperty("/searchInLabel")||G.getText("results"))+" ("+r+")"}return G.getText("results")+" ("+r+")";return""},getSearchCompositeControlInstanceByChildControl:function e(t){if(typeof(t===null||t===void 0?void 0:t.hasStyleClass)==="function"&&t.hasStyleClass("sapUshellSearchInputHelpPage")){return t}else if(typeof(t===null||t===void 0?void 0:t.getParent)==="function"){return this.getSearchCompositeControlInstanceByChildControl(t.getParent())}return undefined},getPersonalizationStorageInstance:function e(){return this._personalizationStorage},getSearchBoxTerm:function e(){return this.getProperty("/uiFilter/searchTerm")||""},setSearchBoxTerm:function e(t,r){t=t||"";var i=t.replace(/^\s+/,"");this.setProperty("/uiFilter/searchTerm",i);this.calculateSearchButtonStatus();if(r||typeof r==="undefined"){this._firePerspectiveQuery()}},getLastSearchTerm:function e(){return this.query.getSearchTerm()},setFacetVisibility:function e(t,r){if(sap.ui.Device.system.phone){t=false}this.setProperty("/facetVisibility",t);try{this._personalizationStorage.setItem("search-facet-panel-button-state",t)}catch(e){}if(r||typeof r==="undefined"){this._firePerspectiveQuery({preserveFormerResults:true})}},getFacetVisibility:function e(){return this.getProperty("/facetVisibility")},getTop:function e(){return this.getProperty("/top")},setTop:function e(t,r){this.setProperty("/top",t);if(r||typeof r==="undefined"){this._firePerspectiveQuery({preserveFormerResults:true})}},resetTop:function e(){this.setProperty("/focusIndex",0);if(this.isAppCategory()||this.isUserCategory()&&this.userCategoryManager&&this.userCategoryManager.getCategory("MyFavorites").subDataSources.length===0){this.setTop(this.appTopDefault,false)}else{this.setTop(this.boTopDefault,false)}},getOrderBy:function e(){return this.getProperty("/orderBy")},setOrderBy:function e(t,r){this.setProperty("/orderBy",t);this.updateSortableAttributesSelection(t.orderBy);if(r||typeof r==="undefined"){this._firePerspectiveQuery({preserveFormerResults:true})}},resetOrderBy:function e(t){this.setProperty("/orderBy",{});this.updateSortableAttributesSelection();if(t||typeof t==="undefined"){this._firePerspectiveQuery({preserveFormerResults:true})}},updateSortableAttributesSelection:function e(t){var r=this.getProperty("/sortableAttributes");if(r.length===0){return}for(var i=0;i<r.length;i++){r[i].selected=false}var s=t===undefined?"DEFAULT_SORT_ATTRIBUTE":t;for(var a=0;a<r.length;a++){if(r[a].attributeId===s){r[a].selected=true}}this.setProperty("/sortableAttributes",r)},isEqualOrderBy:function e(t,r){if(!t.orderBy){return r.length===0}if(r.length!==1){return false}var i=r[0];if(i.id!==t.orderBy){return false}if(t.sortOrder==="ASC"){return i.order===this.sinaNext.SortOrder.Ascending}return i.order===this.sinaNext.SortOrder.Descending},isMyFavoritesAvailable:function e(){var t=false;if(this.sinaNext.provider.id==="abap_odata"){t=true}if(this.sinaNext.provider.id==="multi"&&this.config.userDefinedDatasourcesMulti){t=true}return t},getDocumentTitle:function e(){var t=this.getSearchBoxTerm();var r=this.getDataSource().labelPlural||this.getDataSource().label;var i;if(this.getDataSource()===this.allDataSource){i=G.getText("searchTileTitleProposalAll",[t])}else{i=G.getText("searchTileTitleProposal",[t,r])}return i},resetQuery:function e(){if(this.getProperty("/initializingObjSearch")){return}u.hasher.reset();this.resetTop();this.setSearchBoxTerm("",false);this.resetDataSource(false);this.resetAllFilterConditions(false);this.query.resetConditions();this.query.setSearchTerm("random-jgfhfdskjghrtekjhg");this.setProperty("/facets",[]);this.setProperty("/results",[]);this.setProperty("/appResults",[]);this.setProperty("/boResults",[]);this.setProperty("/breadcrumbsHierarchyNodePaths",[]);this.setProperty("/breadcrumbsHierarchyAttribute","");this.setProperty("/hierarchyNodePaths",[]);this.setProperty("/origBoResults",[]);this.setProperty("/count",0);this.setProperty("/boCount",0);this.setProperty("/appCount",0)},resetSearchResultItemMemory:function e(){this.searchResultSetItemMemory.reset()},createAllAndAppDataSource:function e(){this.allDataSource=this.sinaNext.getAllDataSource();this.allDataSource.label=G.getText("label_all");this.allDataSource.labelPlural=G.getText("label_all");this.appDataSource=this.sinaNext._createDataSource({id:"$$APPS$$",label:G.getText("label_apps"),labelPlural:G.getText("label_apps"),type:this.sinaNext.DataSourceType.Category});this.setProperty("/appSearchDataSource",this.appDataSource)},getUserCategoryManager:function t(){try{const t=this;var r=t;if(t._userCategoryManagerPromise){return e(t._userCategoryManagerPromise)}t._userCategoryManagerPromise=t.initAsync().then(function(){return r.userCategoryManager});return e(t._userCategoryManagerPromise)}catch(e){return Promise.reject(e)}},loadDataSources:function e(){var t=this.sinaNext.getBusinessObjectDataSources();t=t.slice();var r=[];t.forEach(function(e){if(!e.usage.appSearch){r.push(e)}});if(this.userCategoryManager&&this.userCategoryManager.isFavActive()){r.splice(0,0,this.userCategoryManager.getCategory("MyFavorites"));this.favDataSource=this.userCategoryManager.getCategory("MyFavorites")}if(this.config.isUshell){r.splice(0,0,this.appDataSource)}if(!this.config.searchScopeWithoutAll){r.splice(0,0,this.allDataSource)}else{if(!this.config.defaultDataSource&&(!this.userCategoryManager||this.userCategoryManager&&!this.userCategoryManager.isFavActive())){this.setProperty("/defaultDataSource",r[0])}}r=this.config.filterDataSources(r);this.setProperty("/dataSources",r);this.setProperty("/searchTermPlaceholder",this.calculatePlaceholder())},resetDataSource:function e(t){this.setDataSource(this.getDefaultDataSource(),t)},isAllCategory:function e(){var t=this.getProperty("/uiFilter/dataSource");return t===this.allDataSource},isOtherCategory:function e(){var t=this.getProperty("/uiFilter/dataSource");return(t.type===this.sinaNext.DataSourceType.Category||t.type===this.sinaNext.DataSourceType.UserCategory)&&!this.isAllCategory()},isAppCategory:function e(){var t=this.getProperty("/uiFilter/dataSource");return t===this.appDataSource},isUserCategory:function e(){var t=this.getProperty("/uiFilter/dataSource");return t.type===this.sinaNext.DataSourceType.UserCategory},isBusinessObject:function e(){return this.getProperty("/uiFilter/dataSource").type===this.sinaNext.DataSourceType.BusinessObject},isUserCategoryAppSearchOnlyWithoutBOs:function e(){return this.isUserCategory()&&this.userCategoryManager&&this.userCategoryManager.getCategory("MyFavorites").subDataSources.length===0},getDataSource:function e(){return this.getProperty("/uiFilter/dataSource")},getDefaultDataSource:function e(){return this.getProperty("/defaultDataSource")},setDataSourceById:function e(t,r,i){var s=this.sinaNext.getDataSource(t);if(s&&s.id&&s.id===t){this.setDataSource(s,r,i);return}throw"Could not set data source with id "+t+" because it was not in the list of loaded data sources"},setDataSource:function e(t,r,i){if(this.getDataSource()!==t){var s={type:this.eventLogger["DATASOURCE_CHANGE"],dataSourceId:t.id};this.eventLogger.logEvent(s)}this.updateDataSourceList(t);this.getProperty("/uiFilter").setDataSource(t);if(i||i===undefined){this.resetTop()}this.setProperty("/searchTermPlaceholder",this.calculatePlaceholder());this.calculateSearchButtonStatus();if(r||r===undefined){this._firePerspectiveQuery()}},notifyFilterChanged:function e(){jQuery.each(this["aBindings"],function(e,t){if(t.sPath==="/uiFilter/rootCondition"){t.checkUpdate(true)}})},getFilterRootCondition:function e(){var t;if(this.getProperty("/uiFilter")){t=this.getProperty("/uiFilter").rootCondition}return t},setFilterRootCondition:function e(t,r){if(t.type!=="Complex"){throw new Error("filter root condition must be of type ComplexCondition")}for(var i=0;i<t.conditions.length;i++){var s=t.conditions[i];if(s.type!=="Complex"){throw new Error("filters of root condition must be of type ComplexCondition")}for(var a=0;a<s.conditions.length;a++){var o=s.conditions[a];if(o.type!=="Simple"){throw new Error("filters of the lowest level must be of type SimpleCondition")}}}this.getProperty("/uiFilter").setRootCondition(t);if(r||typeof r==="undefined"){this._firePerspectiveQuery({preserveFormerResults:false})}this.notifyFilterChanged()},addFilterCondition:function e(t,r){try{var i=this.getProperty("/uiFilter");if(typeof this.config.cleanUpSpaceFilters==="function"){this.config.cleanUpSpaceFilters(this,t)}if(t.attribute||t.conditions){i.autoInsertCondition(t)}else{this.setDataSource(t,false)}if(r||typeof r==="undefined"){this._firePerspectiveQuery({preserveFormerResults:false})}this.notifyFilterChanged()}catch(e){this._errorHandler.onError(e)}},removeFilterCondition:function e(t,r){if(t.attribute||t.conditions){this.getProperty("/uiFilter").autoRemoveCondition(t)}else{this.setDataSource(t,false)}if(r||typeof r==="undefined"){this._firePerspectiveQuery({preserveFormerResults:true})}this.notifyFilterChanged()},resetAllFilterConditions:function e(t){this.getProperty("/uiFilter").resetConditions();if(t||typeof t==="undefined"){this._firePerspectiveQuery()}this.notifyFilterChanged()},resetFilterByFilterConditions:function e(t){var r=this.getNonFilterByFilterConditions();var i=[];var s=this.config.searchInAttibuteFacetPostion;if(s){for(var a in s){var o=this.getProperty("/uiFilter").rootCondition.getAttributeConditions(a);for(var n=0;n<o.length;n++){i.push(o[n])}}}this.getProperty("/uiFilter").resetConditions();if(r.length>0){var l=z(r),u;try{for(l.s();!(u=l.n()).done;){var c=u.value;this.getProperty("/uiFilter").autoInsertCondition(c)}}catch(e){l.e(e)}finally{l.f()}}if(i.length>0){for(var h=0;h<i.length;h++){var f=i[h];this.getProperty("/uiFilter").autoInsertCondition(f)}}if(t||typeof t==="undefined"){this._firePerspectiveQuery()}this.notifyFilterChanged()},setFilter:function e(t){this.setDataSource(t.dataSource,false);this.setSearchBoxTerm(t.searchTerm,false);var r=this.getProperty("/uiFilter");r.setRootCondition(t.rootCondition);this._firePerspectiveQuery()},filterWithoutFilterByConditions:function e(){var t=this.getNonFilterByFilterConditions();return t.length>0&&t.length===this.getProperty("/uiFilter").rootCondition.conditions.length},getNonFilterByFilterConditions:function e(){var t=[];var r=z(this.getProperty("/uiFilter").rootCondition.getAttributes()),i;try{for(r.s();!(i=r.n()).done;){var s=i.value;var a=this.getProperty("/uiFilter").dataSource.attributeMetadataMap[s];if(a&&a.isHierarchy===true&&a.hierarchyDisplayType===re.StaticHierarchyFacet){var o=z(this.getProperty("/uiFilter").rootCondition.getAttributeConditions(s)),n;try{for(o.s();!(n=o.n()).done;){var l=n.value;t.push(l)}}catch(e){o.e(e)}finally{o.f()}}}}catch(e){r.e(e)}finally{r.f()}return t},doSuggestion:function e(){this._suggestionHandler.doSuggestion(this.getProperty("/uiFilter").clone())},abortSuggestions:function e(){this._suggestionHandler.abortSuggestions()},_firePerspectiveQuery:function t(r,i){try{const t=this;return e(t.initAsync(),function(){return t._doFirePerspectiveQuery(r,i)})}catch(e){return Promise.reject(e)}},_doFirePerspectiveQuery:function e(t,r){var i=this;var s,a;if(jQuery.isPlainObject(t)){s=t.deserialization;a=t.preserveFormerResults}else{s=t||undefined;a=r||undefined}var o=this.getProperty("/uiFilter");if(o.equals(this.query.filter)&&this.getTop()===this.query.top&&this.isEqualOrderBy(this.getOrderBy(),this.query.sortOrder)&&this.getCalculateFacetsFlag()===this.query.calculateFacets&&!this.getProperty("/isQueryInvalidated")){return Promise.resolve()}if(u.getUrlParameter("nlq")==="true"){this.query.setNlq(true)}if(!s&&(this.query.filter.dataSource&&o.dataSource!==this.query.filter.dataSource||this.query.filter.searchTerm&&o.searchTerm!==this.query.filter.searchTerm)){this.resetOrderBy(false)}if(this.query.filter.dataSource&&o.dataSource!==this.query.filter.dataSource){this.oFacetFormatter.handleDataSourceChanged()}if(!s&&!a){if(!o.equals(this.query.filter)){this.resetTop()}}if(o.searchTerm!==this.query.filter.searchTerm||!o.rootCondition.equals(this.query.filter.rootCondition)){this._tabStripFormatter.invalidate(this.getDataSource())}if(this.getProperty("/isQueryInvalidated")===true){this.query.resetResultSet();this.setProperty("/isQueryInvalidated",false)}this.query.setFilter(this.getProperty("/uiFilter").clone());this.query.setTop(this.getTop());this.query.setSortOrder(this.assembleSortOrder());this.query.setCalculateFacets(this.getCalculateFacetsFlag());this.setProperty("/queryFilter",this.query.filter);this.notifySubscribers(ie.ESHSearchStarted);sap.ui.getCore().getEventBus().publish(ie.ESHSearchStarted);if(s||!this.config.isUshell){this.setProperty("/busyDelay",0)}else{this.setProperty("/busyDelay",600)}this.busyIndicator.setBusy(true);if(this.getProperty("/appCount")>0||this.getProperty("/boCount")>0){this.resetUIMessages()}this.abortSuggestions();this.updateSearchURLSilently(s);if(!s){this.resetSearchResultItemMemory()}var n={type:this.eventLogger[K.SEARCH_REQUEST],searchTerm:this.getProperty("/uiFilter/searchTerm"),dataSourceKey:this.getProperty("/uiFilter/dataSource").id};this.eventLogger.logEvent(n);var l="Search for '".concat(this.getSearchBoxTerm(),"' (logId:").concat(this.config.performanceLogger.getUniqueId(),")");this._performanceLoggerSearchMethods.push(l);this.config.performanceLogger.enterMethod({name:l},{isSearch:true,comments:"Top: ".concat(this.getTop(),", searchbox term: ").concat(this.getSearchBoxTerm())});return Promise.all([this.normalSearch(a),this.appSearch()]).then(function(){var e;i.calculateResultViewSwitchVisibility();i.setProperty("/tabStrips",i._tabStripFormatter.format(i.getDataSource(),i._perspective,i));i.setProperty("/breadcrumbsHierarchyNodePaths",i._breadcrumbsFormatter.formatNodePaths(i._perspective));i.setProperty("/breadcrumbsHierarchyAttribute",i._breadcrumbsFormatter.formatHierarchyAttribute(i._perspective));i.setProperty("/hierarchyNodePaths",(e=i._perspective)===null||e===void 0?void 0:e.hierarchyNodePaths);if(i.config.bRecentSearches&&i.recentlyUsedStorage){i.recentlyUsedStorage.addItem()}return i.oFacetFormatter.getFacets(i.getDataSource(),i._perspective,i)["catch"](function(e){var t=z(i._performanceLoggerSearchMethods),r;try{for(t.s();!(r=t.n()).done;){var s=r.value;i.config.performanceLogger.leaveMethod({name:s})}}catch(e){t.e(e)}finally{t.f()}i._performanceLoggerSearchMethods=[];return i._errorHandler.onErrorDeferred(e)}).then(function(e){if((e===null||e===void 0?void 0:e.length)>0){e[0].change=jQuery["sap"].now();i.setProperty("/facets",e);e.forEach(function(e){return e.handleModelUpdate&&e.handleModelUpdate()})}})})["catch"](function(e){var t=z(i._performanceLoggerSearchMethods),r;try{for(t.s();!(r=t.n()).done;){var s=r.value;i.config.performanceLogger.leaveMethod({name:s})}}catch(e){t.e(e)}finally{t.f()}i._performanceLoggerSearchMethods=[];return i._errorHandler.onErrorDeferred(e)})["finally"](function(){try{if(i.config&&i.config.overwriteBrowserTitle===true){document.title=i.getDocumentTitle()}var e=z(i._performanceLoggerSearchMethods),t;try{for(e.s();!(t=e.n()).done;){var r=t.value;i.config.performanceLogger.leaveMethod({name:r})}}catch(t){e.e(t)}finally{e.f()}i._performanceLoggerSearchMethods=[];i.notifySubscribers(ie.ESHSearchFinished);sap.ui.getCore().getEventBus().publish(ie.ESHSearchFinished);i.busyIndicator.setBusy(false);i.setProperty("/firstSearchWasExecuted",true);i.notifyFilterChanged();i.updateMultiSelectionSelected()}catch(e){i._errorHandler.onError(e)}})},assembleSortOrder:function e(){var t=this.getOrderBy();if(!t.orderBy){return[]}var r=this.sinaNext.SortOrder.Ascending;if(t.sortOrder==="DESC"){r=this.sinaNext.SortOrder.Descending}return[{id:t.orderBy,order:r}]},getCalculateFacetsFlag:function e(){if(this.getDataSource().type===this.sinaNext.DataSourceType.Category||this.getFacetVisibility()){return true}return false},appSearch:function e(){var t=this;if(!this.config.isUshell){return Promise.resolve(true)}this.setProperty("/appResults",[]);this.setProperty("/appCount",0);if(this.isBusinessObject()||this.isOtherCategory()&&!this.isAppCategory()&&!this.isUserCategory()||this.isUserCategory()&&this.userCategoryManager&&!this.userCategoryManager.getCategory("MyFavorites").includeApps){return Promise.resolve(true)}var r=this.query.filter.dataSource===this.allDataSource?this.appTopDefault:this.query.top;return this._searchApplicationsRefuseOutdatedReq(this.query.filter.searchTerm,r,0).then(function(e){t.setProperty("/appCount",e.totalResults);t.setProperty("/appResults",e.getElements())},function(e){return t._errorHandler.onErrorDeferred(e)})},searchApplications:function e(t,r,i){if(this.config.isUshell){return sap.ushell.Container.getServiceAsync("Search").then(function(e){return e.queryApplications({searchTerm:t,top:r,skip:i})})}else{return Promise.resolve({totalResults:0,searchTerm:t,getElements:function e(){return[]}})}},normalSearch:function e(t){var r=this;if(!t){this.resetAndDisableMultiSelection()}if(!this.isBusinessObjSearchEnabled()||this.isAppCategory()||this.isUserCategory()&&this.userCategoryManager&&this.userCategoryManager.getCategory("MyFavorites").subDataSources.length===0){this.setProperty("/boResults",[]);this.setProperty("/breadcrumbsHierarchyNodePaths",[]);this.setProperty("/breadcrumbsHierarchyAttribute","");this.setProperty("/hierarchyNodePaths",[]);this.setProperty("/origBoResults",[]);this.setProperty("/boCount",0);this.setProperty("/nlqSuccess",false);this.setProperty("/nlqDescription","");this._perspective=null;return Promise.resolve(true)}var i=function e(t){r._perspective=t;r.setProperty("/nlqSuccess",false);if(t.nlqSuccess){r.setProperty("/nlqSuccess",true);r.setProperty("/nlqDescription",t.title)}return r._afterSearchPrepareResultList(r._perspective)};this.setDataSource(this.getDataSource(),false,false);this.query.setCalculateFacets(this.getCalculateFacetsFlag());return this.query.getResultSetAsync().then(function(e){var t=e;return i(t)},function(e){return r._errorHandler.onErrorDeferred(e)})},_afterSearchPrepareResultList:function e(t){var r=this;this.setProperty("/boResults",[]);this.setProperty("/breadcrumbsHierarchyNodePaths",[]);this.setProperty("/breadcrumbsHierarchyAttribute","");this.setProperty("/hierarchyNodePaths",[]);this.setProperty("/origBoResults",t.items);this.setProperty("/boCount",0);var i=new h(this);var s=i.format(t,this.query.filter.searchTerm);this.setProperty("/sortableAttributes",i.formatSortAttributes());if(this.isHomogenousResult()){if(t.totalCount===0){this.setProperty("/tableColumns",[]);this.setProperty("/tableRows",[])}else{var a=new p(this);this.setProperty("/tableColumns",a.formatColumns(s));var o=a.formatRows(s);for(var n=0;n<o.length;n++){s[n].cells=o[n].cells}this.setProperty("/tableRows",s)}}this.restoreResultSetItemExpansion(s);var l;var u=[];var c=[];for(var f=0;f<s.length;f++){l=s[f];u.push(l.dataSource);c.push({isDocumentConnector:l.isDocumentConnector})}var y=this.config.loadCustomModulesForDataSourcesAsync(u,c);var g=Promise.all([Promise.resolve(t),y]).then(function(e){var t=e[0];if(r.config&&typeof r.config.setSearchInLabelIconBindings==="function"){try{r.config.setSearchInLabelIconBindings(r,t.facets)}catch(e){var i=new D.ConfigurationExitError("setSearchInLabelIconBindings",r.config.applicationComponent,e);throw i}}r.setProperty("/boCount",t.totalCount);r.setProperty("/boResults",s);r.enableOrDisableMultiSelection();return Promise.resolve()});return g},restoreResultSetItemExpansion:function e(t){var r=z(t),i;try{for(r.s();!(i=r.n()).done;){var s=i.value;var a=this.searchResultSetItemMemory.getExpanded(s.key);if(typeof a!=="undefined"){s.expanded=a}}}catch(e){r.e(e)}finally{r.f()}},resetAndDisableMultiSelection:function e(){this.setProperty("/multiSelectionAvailable",false);this.setProperty("/multiSelectionEnabled",false);this.setProperty("/multiSelectionSelected",false);this.setProperty("/singleSelectionSelected",false)},enableOrDisableMultiSelection:function e(){if(this.config.enableMultiSelectionResultItems){this.setProperty("/multiSelectionAvailable",true);this.setProperty("/multiSelectionEnabled",true);return}var t=this.getDataSource();var r=this.config.getDataSourceConfig(t);var i=new r.searchResultListSelectionHandlerControl;if(i){this.setProperty("/multiSelectionAvailable",i.isMultiSelectionAvailable())}else{this.setProperty("/multiSelectionAvailable",false)}},updateMultiSelectionSelected:function e(){var t;if(this.getResultViewType()==="searchResultTable"){t=this.getProperty("/tableRows")}else{t=this.getProperty("/results")}var r=0;var i=[];for(var s=0;s<t.length;s++){if(t[s].selected){r++;i.push(t[s])}}if(r>0){this.setProperty("/multiSelectionSelected",true);this.setProperty("/multiSelectionObjects",i)}else{this.setProperty("/multiSelectionSelected",false);this.setProperty("/multiSelectionObjects",[])}if(r===1){this.setProperty("/singleSelectionSelected",true)}else{this.setProperty("/singleSelectionSelected",false)}this.config.selectionChange(this)},_endWith:function e(t,r){return t.indexOf(r,t.length-r.length)!==-1},calculatePlaceholder:function e(){var t=this.getDataSource().labelPlural;if(this.config.FF_bOptimizedQuickSelectDataSourceLabels===true){var r;if(typeof this.config.getFirstSpaceCondition==="function"){var i=this.config.getFirstSpaceCondition(this.getProperty("/uiFilter"));if(i&&i.attributeLabel){r=true;t=i.valueLabel||i.value}}if(!r&&this.getDataSource().id==="SEARCH_DESIGN"&&typeof this.config.getPlaceholderLabelForDatasourceAll==="function"){t=this.callbackGetPlaceholderLabelForDatasourceAll()}}else if(this.isAllCategory()||this.config.bPlaceHolderFixedValue===true){return G.getText("search")}else if(this.getDataSource().id==="SEARCH_DESIGN"&&typeof this.config.getPlaceholderLabelForDatasourceAll==="function"){t=this.callbackGetPlaceholderLabelForDatasourceAll()}return G.getText("searchInPlaceholder",[t])},callbackGetPlaceholderLabelForDatasourceAll:function e(){var t=G.getText("search");try{t=this.config.getPlaceholderLabelForDatasourceAll()}catch(e){var r=new D.ConfigurationExitError("getPlaceholderLabelForDatasourceAll",this.config.applicationComponent,e);this._errorHandler.onError(r)}return t},updateDataSourceList:function e(t){var r=this.getProperty("/dataSources");this.removeTempDataSources();if(r.indexOf(t)>=0){return}r.unshift(t);this._tempDataSources.push(t);this.setProperty("/dataSources",r)},removeTempDataSources:function e(){var t=this.getProperty("/dataSources");this._tempDataSources.forEach(function(e,r,i){var s=t.indexOf(e);if(s<0){var a=new Error("could not find temp DataSource in DataSources");throw new D.ProgramError(a)}t.splice(s,1);i.splice(r,1)})},invalidateQuery:function e(){u.hasher.reset();this.setProperty("/isQueryInvalidated",true)},autoStartApp:function e(){var t=this.getProperty("/uiFilter/searchTerm");if(this.getProperty("/appCount")===1&&this.getProperty("/count")===1){var r=this.getProperty("/appResults");if(r&&r.length>0&&r[0]&&r[0].url&&t&&r[0].tooltip&&t.toLowerCase().trim()===r[0].tooltip.toLowerCase().trim()){if(r[0].url[0]==="#"){window.location.href=r[0].url}else{window.open(r[0].url,"_blank","noopener,noreferrer")}return}}},isHomogenousResult:function e(){if(this.isAllCategory()){return false}if(this.isOtherCategory()){return false}if(this.isAppCategory()){return false}return true},getResultViewTypes:function e(){return this.getProperty("/resultViewTypes")},setResultViewTypes:function e(t){this.setProperty("/resultViewTypes",t)},getResultViewType:function e(){return this.getProperty("/resultViewType")},setResultViewType:function e(t){this.setProperty("/resultViewType",t);if(this.isAppCategory()){return}else if(this.isAllCategory()||this.isOtherCategory()){try{this._personalizationStorage.setItem("resultViewTypeForAllAndCategorySearch",t)}catch(e){}}else{try{this._personalizationStorage.setItem("resultViewTypeForBusinessObjectSearch",t)}catch(e){}}},calculateResultViewSwitchVisibility:function e(t){this.validateResultViewSettings(t);if(t!==undefined){this.setResultViewTypes(t.resultViewTypes);this.setResultViewType(t.resultViewType);this.setProperty("/resultViewSwitchVisibility",t.resultViewTypes.length>1);return}var r;var i;if(this.isAppCategory()||this.isUserCategory()&&this.userCategoryManager&&this.userCategoryManager.getCategory("MyFavorites").subDataSources.length===0){r=["appSearchResult"];i="appSearchResult";this.setResultViewTypes(r);this.setResultViewType(i);this.setProperty("/resultViewSwitchVisibility",r.length>1);return}if(this.isAllCategory()||this.isOtherCategory()){if(this.config.isUshell){r=["searchResultList"];i="searchResultList"}else{r=["searchResultList","searchResultGrid"];try{i=this._personalizationStorage.getItem("resultViewTypeForAllAndCategorySearch")}catch(e){}if(i===undefined||i===null||i.length===0||!r.includes(i)){i="searchResultList"}}this.setResultViewTypes(r);this.setResultViewType(i);this.setProperty("/resultViewSwitchVisibility",r.length>1);return}r=this.config.resultViewTypes;try{if(this._personalizationStorage instanceof v)i=this._personalizationStorage.getItem("resultViewTypeForBusinessObjectSearch")}catch(e){}if(i===undefined||i===null||i.length===0||!r.includes(i)){i=this.config.fallbackResultViewType}i=this.folderModeResultViewTypeCalculator.calculate(r,i,this.getProperty("/uiFilter"));this.setResultViewTypes(r);this.setResultViewType(i);this.setProperty("/resultViewSwitchVisibility",r.length>1)},validateResultViewSettings:function e(t){var r;var i;var s;var a;var o;var n;if(typeof t==="undefined"){r=true}else{r=false}if(r){i=["searchResultList","searchResultTable","searchResultGrid"];s=this.config.resultViewTypes;a=this.config.fallbackResultViewType;o="\nERROR: Search Result View Settings of SearchConfiguration:\n\n";n=". \n Please check the validation and compatibility of resultViewTypes of SearchConfiguration!"}else{if(this.isAppCategory()){i=["appSearchResult"]}else if(this.isAllCategory()||this.isOtherCategory()){i=["searchResultList","searchResultGrid"]}else{i=["searchResultList","searchResultTable","searchResultGrid"]}s=t.resultViewTypes;a=t.resultViewType;o="\nERROR: Search Result View Settings of SearchCompositeControl\n\n";n=". \n Please check the validation and compatibility of resultViewTypes, resultViewType of SearchCompositeControl!"}if(!Array.isArray(s)||s.length===0){throw Error(o+"resultViewTypes should be non-empty array"+n)}var l=s;l=l.filter(function(e,t){return l.indexOf(e)===t});if(l.length!==s.length){throw Error(o+"resultViewTypes ("+s.toString()+") should not have duplicated value"+n)}if(!u.isSubsetOf(s,i)){throw Error(o+"resultViewTypes ("+s.toString()+") contains invalid value. Possible values are ("+i.toString()+")"+n)}if(typeof a==="undefined"&&r){a=s[0];this.config.fallbackResultViewType=s[0]}if(typeof a!=="string"){throw Error(o+"resultViewType should be of string"+n)}if(!s.includes(a)){throw Error(o+"resultViewTypes ("+s.toString()+") doesn't contain resultViewType ("+a+")"+n)}},calculateSearchButtonStatus:function e(){if(!this.config.isUshell){this.setProperty("/searchButtonStatus","Search");return}if(this.getDataSource()===this.getProperty("/defaultDataSource")&&this.getSearchBoxTerm().length===0){if(se.isSearchFieldExpandedByDefault()){this.setProperty("/searchButtonStatus","Focus")}else{this.setProperty("/searchButtonStatus","Close")}}else{this.setProperty("/searchButtonStatus","Search")}},calculateResultList:function e(){var t=[];var r=this.getProperty("/boResults");if(r&&r.length){var i;(i=t).push.apply(i,U(r))}var s=this.getProperty("/appResults");if(s&&s.length>0){var a={type:"appcontainer",tiles:s};if(t.length>0){if(t.length>3){t.splice(3,0,a)}else{t.push(a)}}else{t=[a]}}this.setProperty("/results",t)},pushUIMessage:function e(t){t.title=t.title==="[object Object]"?G.getText("searchError"):t.title;t.type=t.type!==undefined?t.type:te.Error;var r=this.getProperty("/errors");r.push(t);var i=this.removeAdjacentDuplicateMessages(r);this.setProperty("/errors",i)},resetUIMessages:function e(){this.setProperty("/errors",[])},removeAdjacentDuplicateMessages:function e(t){var r=[];var i;var s=z(t),a;try{for(s.s();!(a=s.n()).done;){var o=a.value;if(typeof i==="undefined"){r.push(o)}else if(i.title!==o.title||i.description!==o.description||i.type!==o.type){r.push(o)}i=o}}catch(e){s.e(e)}finally{s.f()}return r},updateSearchURLSilently:function e(t){if(t){u.hasher.init()}else{var r=this.renderSearchURL();if(this.config.updateUrl){u.hasher.setHash(r)}}},renderSearchURL:function e(){return this.searchUrlParser.render()},parseURL:function e(){this.searchUrlParser.parse()},subscribe:function e(t,r,i){this._subscribers.push({eventId:t||"",callback:r,listener:i||this})},unsubscribe:function e(t,r,i){t=t||"";i=i||this;for(var s=0;s<this._subscribers.length;s++){var a=this._subscribers[s];if(a.eventId===t&&a.callback===r&&a.listener===i){this._subscribers.splice(s,1)}}},notifySubscribers:function e(t){var r=z(this._subscribers),i;try{for(r.s();!(i=r.n()).done;){var s=i.value;if(s.eventId===t){s.callback.apply(s.listener,[t])}}}catch(e){r.e(e)}finally{r.f()}},createSearchNavigationTarget:function e(t,r){var i=this;var s;if(this.config.updateUrl===true){var a=this.config.pageSize||10;var o=this.searchUrlParser.renderFromParameters(a,t,true);s=this.sinaNext._createNavigationTarget({targetUrl:o,label:r,target:"_self"});return s}else{var n=function e(){i.setFilter(t)};s=this.sinaNext._createNavigationTarget({targetFunction:n,label:r})}return s}});ne._searchModels={};ne.getModelSingleton=function e(t,r){var i=r||"default";if(!ne._searchModels[i]){t.isUshell=i==="flp"?true:false;ne._searchModels[i]=new ne({configuration:t})}return ne._searchModels[i]};sap.esh.search.ui.getModelSingleton=ne.getModelSingleton;return ne})})();
//# sourceMappingURL=SearchModel.js.map